---
knit: "bookdown::render_book"
title: "The Epidemiologist R Handbook"  
description: "The Epi R Handbook is a R reference manual for applied epidemiology and public health."
author: "the handbook team"
date: "`r Sys.Date()`"
#url: 'https://github.com/nsbatra/Epi_R_handbook'
#twitter-handle: 
#cover-image: images/R_Handbook_Logo.png
site: bookdown::bookdown_site
# output: bookdown::gitbook:
#      config:
#           sharing:
#                twitter: yes
#                facebook: yes
#                whatsapp: yes
#                github: yes
documentclass: book
---

# output: bookdown::gitbook:

Placeholder


## R for applied epidemiology and public health {-}  
## How to use this handbook {-} 
## Acknowledgements {-}  
### Contributors {-}  
### Funding and support {-}  
### Inspiration {-}  
## Terms of Use and Contribution {-}  
### License {.unnumbered} 
### Citation {.unnumbered}
### Contribution {.unnumbered}  

<!--chapter:end:index.Rmd-->

# (PART) About this book {.unnumbered}
```{r include=FALSE, cache=FALSE}

# clear workspace
rm(list = ls(all = TRUE))

# clear all packages except base
#lapply(names(sessionInfo()$loadedOnly), require, character.only = TRUE)
#invisible(lapply(paste0('package:', names(sessionInfo()$otherPkgs)), detach, character.only=TRUE, unload=TRUE, force=TRUE))

# to ensure that tidyverse packages prevail
filter <- dplyr::filter
select <- dplyr::select
summarise <- dplyr::summarise
summary <- base::summary
incidence <- incidence2::incidence

#load core packages
pacman::p_load(
     rio,
     here,
     DT,
     stringr,
     lubridate,
     tidyverse
)

# import the cleaned ebola linelist
linelist <- rio::import(here::here("data", "case_linelists", "linelist_cleaned.rds"))

# import the count data - facility level
#count_data <- rio::import(here::here("data", "facility_count_data.rds"))

# Settings

options(scipen=1, digits=7)

# print only text (not code)
#library(knitr)
#opts_chunk$set(list(echo = FALSE, eval = FALSE))
```

<!--chapter:end:new_pages/cat_about_book.Rmd-->


# Editorial and technical notes { }

Placeholder


## Approach and style
### R packages {.unnumbered}
### Code style {.unnumbered}
### Nomenclature {.unnumbered}  
### Notes {.unnumbered} 
## Editorial decisions  
## Major revisions  
## Session info (R, RStudio, packages)  

<!--chapter:end:new_pages/editorial_style.Rmd-->


# Download handbook and data  

Placeholder


## Download offline handbook  
### Use download link {.unnumbered}  
### Use our R package {.unnumbered}  
## Download data to follow along  
### Use our R package {.unnumbered}  
### Download one-by-one {.unnumbered}  
#### Case linelist {.unnumbered}
#### Malaria count data {#data_malaria .unnumbered}  
#### Likert-scale data {.unnumbered}  
#### Flexdashboard {.unnumbered}  
#### Contact Tracing {.unnumbered} 
#### GIS {.unnumbered}  
#### Phylogenetic trees {.unnumbered}  
#### Standardization {.unnumbered}  
#### Time series and outbreak detection {#data_outbreak .unnumbered}  
#### Survey analysis {#data_survey .unnumbered}  
#### Shiny {#data_shiny .unnumbered}  

<!--chapter:end:new_pages/data_used.Rmd-->

# (PART) Basics {.unnumbered}
```{r include=FALSE, cache=FALSE}

# clear workspace
rm(list = ls(all = TRUE))

# clear all packages except base
#lapply(names(sessionInfo()$loadedOnly), require, character.only = TRUE)
#invisible(lapply(paste0('package:', names(sessionInfo()$otherPkgs)), detach, character.only=TRUE, unload=TRUE, force=TRUE))

# to ensure that tidyverse packages prevail
filter <- dplyr::filter
select <- dplyr::select
summarise <- dplyr::summarise
summary <- base::summary
incidence <- incidence2::incidence

#load core packages
pacman::p_load(
     rio,
     here,
     DT,
     stringr,
     lubridate,
     tidyverse
)

# import the cleaned ebola linelist
linelist <- rio::import(here::here("data", "case_linelists", "linelist_cleaned.rds"))

# import the count data - facility level
#count_data <- rio::import(here::here("data", "facility_count_data.rds"))

# Settings

options(scipen=1, digits=7)

# print only text (not code)
#library(knitr)
#opts_chunk$set(list(echo = FALSE, eval = FALSE))
```

<!--chapter:end:new_pages/cat_basics.Rmd-->


# R Basics {}

Placeholder


## Why use R?
## Key terms  
## Resources for learning {#learning}  
### Resources within RStudio {.unnumbered}  
### Cheatsheets {.unnumbered}
### Twitter {.unnumbered}  
### Free online resources {.unnumbered}  
### Languages other than English {.unnumbered}  
## Installation  
### R and RStudio {.unnumbered}  
### Other software you *may* need to install {.unnumbered} 
#### TinyTex {.unnumbered}  
#### Pandoc {.unnumbered}
#### RTools {.unnumbered}  
#### phantomjs {.unnumbered}  
## RStudio {#rstudio}
### RStudio orientation {.unnumbered}  
### RStudio settings {.unnumbered}  
### Keyboard shortcuts {.unnumbered}  
## Functions {#functions}  
### Simple functions {.unnumbered}  
### Functions with multiple arguments {.unnumbered}  
### Writing Functions {.unnumbered}  
## Packages {#packages}  
### Install and load {.unnumbered}  
#### Your library {.unnumbered}  
#### Install from CRAN {.unnumbered}  
#### How to install and load {.unnumbered}  
### Code syntax {.unnumbered}  
### Function help {.unnumbered}  
### Update packages {.unnumbered}  
### Delete packages {.unnumbered}
### Dependencies {.unnumbered}  
### Masked functions {.unnumbered}  
### Detach / unload {.unnumbered}  
### Install older version {.unnumbered}  
### Suggested packages {.unnumbered}  
## Scripts {#scripts}
### Commenting {.unnumbered}  
### Style {.unnumbered}  
### Example Script {.unnumbered}  
### R markdown {.unnumbered}
### R notebooks {.unnumbered}
### Shiny {.unnumbered}
### Code folding {.unnumbered}  
## Working directory  
### Recommended approach {.unnumbered}  
### Set by command {.unnumbered}
### Set manually {.unnumbered}  
### Within an R project {.unnumbered}
### Working directory in an R markdown {.unnumbered}
### Providing file paths {.unnumbered}  
## Objects {#objects}
### Everything is an object {.unnumbered} 
### Defining objects (`<-`) {.unnumbered}
### Object structure {.unnumbered}  
### Object classes  {.unnumbered}
### Columns/Variables (`$`) {.unnumbered}  
### Access/index with brackets (`[ ]`) {.unnumbered}  
### Remove objects {.unnumbered} 
## Piping (`%>%`)  
### **Pipes** {.unnumbered}
### Define intermediate objects {.unnumbered}
## Key operators and functions {#operators}
### Assignment operators {.unnumbered}  
### Relational and logical operators {.unnumbered}  
### Missing values {.unnumbered}
### Mathematics and statistics {.unnumbered}  
#### Mathematical operators {.unnumbered} 
#### Mathematical functions {.unnumbered}
#### Scientific notation {.unnumbered}
#### Rounding {.unnumbered}  
#### Statistical functions {.unnumbered}  
#### Other useful functions {.unnumbered}  
### `%in%` {.unnumbered}  
## Errors & warnings  
### Error versus Warning {.unnumbered}
### General syntax tips {.unnumbered}
### Code assists {.unnumbered}  

<!--chapter:end:new_pages/basics.Rmd-->


# Transition to R { }  

Placeholder


## From Excel  
### Benefits {.unnumbered}  
### Tidy data {.unnumbered}  
### Functions {.unnumbered}  
### Scripts {.unnumbered}  
### Excel-to-R resources {.unnumbered}
### R-Excel interaction {.unnumbered}  
## From Stata  
## From SAS  
## Data interoperability  

<!--chapter:end:new_pages/transition_to_R.Rmd-->


# Suggested packages

Placeholder


## Packages from CRAN  
## Packages from Github  

<!--chapter:end:new_pages/packages_suggested.Rmd-->


# R projects {}  

Placeholder


## Suggested use  
## Creating an R project {}
### Switch projects {.unnumbered}
### Settings {.unnumbered}  
### Organization {.unnumbered}  
### Version control {.unnumbered}  
## Examples  
## Resources {}

<!--chapter:end:new_pages/r_projects.Rmd-->


# Import and export {}

Placeholder


## Overview
## The **rio** package {}  
## The **here** package {#here}
## File paths  
### "Relative" file paths {.unnumbered}
### "Absolute" file paths {.unnumbered}  
### Select file manually {.unnumbered}
## Import data  
### Specific Excel sheets {.unnumbered}
### Missing values {#import_missing .unnumbered} 
### Skip rows {.unnumbered} 
### Manage a second header row {.unnumbered}  
#### Remove the second header row {.unnumbered}  
#### Make a data dictionary {.unnumbered}  
#### Combine the two header rows {.unnumbered}  
### Google sheets {.unnumbered}
## Multiple files - import, export, split, combine  
## Import from Github {#import_github}
### CSV files {.unnumbered}  
### XLSX files {.unnumbered}  
### Shapefiles {.unnumbered} 
## Manual data entry {}
### Entry by rows {.unnumbered}  
### Entry by columns {.unnumbered}  
### Pasting from clipboard {.unnumbered}  
## Import most recent file  
### Dates in file name {.unnumbered}  
### Use the file info {.unnumbered}  
## APIs {#import_api}
### HTTP request {.unnumbered}  
### Packages {.unnumbered}  
### Publicly-available data {.unnumbered}  
### Authentication required {.unnumbered}  
## Export {}  
### With **rio** package {.unnumbered}
### To clipboard {.unnumbered}
## RDS files {#import_rds}
## Rdata files and lists {#import_rdata}
## Saving plots {} 
## Resources {} 

<!--chapter:end:new_pages/importing.Rmd-->

# (PART) Data Management {.unnumbered}
```{r include=FALSE, cache=FALSE}

# clear workspace
rm(list = ls(all = TRUE))

# clear all packages except base
#lapply(names(sessionInfo()$loadedOnly), require, character.only = TRUE)
#invisible(lapply(paste0('package:', names(sessionInfo()$otherPkgs)), detach, character.only=TRUE, unload=TRUE, force=TRUE))

# to ensure that tidyverse packages prevail
filter <- dplyr::filter
select <- dplyr::select
summarise <- dplyr::summarise
summary <- base::summary
incidence <- incidence2::incidence

#load core packages
pacman::p_load(
     rio,
     here,
     DT,
     stringr,
     lubridate,
     tidyverse
)

# import the cleaned ebola linelist
linelist <- rio::import(here::here("data", "case_linelists", "linelist_cleaned.rds"))

# import the count data - facility level
#count_data <- rio::import(here::here("data", "facility_count_data.rds"))

# Settings

options(scipen=1, digits=7)

# print only text (not code)
#library(knitr)
#opts_chunk$set(list(echo = FALSE, eval = FALSE))
```

<!--chapter:end:new_pages/cat_data_management.Rmd-->


# Cleaning data and core functions {}

Placeholder


### Core functions {.unnumbered}  
### Nomenclature {.unnumbered}  
## Cleaning pipeline
## Load packages  
## Import data  
### Import {.unnumbered}  
### Review {.unnumbered}  
## Column names {} 
### Labels {.unnumbered}  
### Automatic cleaning {.unnumbered}  
### Manual name cleaning {.unnumbered}  
#### Rename by column position {.unnumbered} 
#### Rename via `select()` and `summarise()` {.unnumbered}  
### Other challenges {.unnumbered}  
#### Empty Excel column names {.unnumbered} 
#### Merged Excel column names and cells {.unnumbered}  
## Select or re-order columns {} 
### Keep columns {.unnumbered}  
### "tidyselect" helper functions {#clean_tidyselect .unnumbered}  
### Remove columns {.unnumbered} 
### Standalone {.unnumbered}
#### Add to the pipe chain {.unnumbered}  
## Deduplication
## Column creation and transformation { }
### New columns {.unnumbered}
### Convert column class {.unnumbered}
### Grouped data {.unnumbered}  
### Transform multiple columns {#clean_across .unnumbered}
#### `across()` column selection {.unnumbered}  
#### `across()` functions {.unnumbered}
### `coalesce()` {.unnumbered}  
### Cumulative math {.unnumbered}
### Using **base** R {.unnumbered}  
### Add to pipe chain {.unnumbered}  
## Re-code values
### Specific values {.unnumbered}  
### By logic {.unnumbered}
### Simple logic {.unnumbered}  
#### `replace()` {.unnumbered}  
#### `ifelse()` and `if_else()` {.unnumbered}  
### Complex logic {#clean_case_when .unnumbered}  
### Missing values {.unnumbered} 
### Cleaning dictionary {.unnumbered}
#### Add to pipe chain {.unnumbered}  
## Numeric categories {#num_cats}
### Review distribution {.unnumbered}
### `age_categories()` {.unnumbered}
### `cut()` {.unnumbered}
### Quantile breaks {.unnumbered}  
### Evenly-sized groups {.unnumbered}  
### `case_when()` { .unnumbered}
### Add to pipe chain {.unnumbered}  
## Add rows  
### One-by-one {.unnumbered}  
### Bind rows {.unnumbered}  
## Filter rows {  }
### Simple filter {.unnumbered} 
### Filter out missing values {.unnumbered}  
### Filter by row number {.unnumbered}  
### Complex filter {.unnumbered} 
#### Examine the data  {.unnumbered}  
#### How filters handle missing numeric and date values {.unnumbered}  
#### Design the filter {.unnumbered}  
### Standalone {.unnumbered}  
### Quickly review records {.unnumbered} 
#### Add to pipe chain {.unnumbered}  
## Row-wise calculations  
## Arrange and sort  

<!--chapter:end:new_pages/cleaning.Rmd-->


# Working with dates {}

Placeholder


## Preparation
### Load packages {.unnumbered}  
### Import data {.unnumbered}  
## Current date  
## Convert to Date  
### **base** R {.unnumbered}  
### **lubridate** {.unnumbered}  
### Combine columns {.unnumbered}  
## Excel dates
## Messy dates  
## Working with date-time class  
### Convert dates with times {.unnumbered}  
### Convert times alone {.unnumbered}  
### Extract time {.unnumbered}  
## Working with dates   
### Extract date components {.unnumbered}  
### Date math {.unnumbered}  
### Date intervals {.unnumbered}  
## Date display  
### `format()` {.unnumbered}  
### Month-Year {.unnumbered}  
## Epidemiological weeks {#dates_epi_wks}
### **lubridate** {.unnumbered}  
### Weekly counts {.unnumbered}  
### Epiweek alternatives {.unnumbered}  
## Converting dates/time zones
## Lagging and leading calculations  
## Resources  

<!--chapter:end:new_pages/dates.Rmd-->


# Characters and strings { }  

Placeholder


## Preparation { }
### Load packages {.unnumbered}  
### Import data  {.unnumbered}  
## Unite, split, and arrange { }
### Combine strings {.unnumbered}
### Dynamic strings {.unnumbered}
### Unite columns  {#str_unite .unnumbered}
### Split {.unnumbered}  
### Split columns {.unnumbered}  
### Arrange alphabetically {.unnumbered} 
### base R functions {.unnumbered}
## Clean and standardise  
### Change case {.unnumbered}
### Pad length  {#str_pad .unnumbered}
### Truncate {.unnumbered} 
### Standardize length {.unnumbered}
### Remove leading/trailing whitespace {.unnumbered}  
### Remove repeated whitespace within {.unnumbered}  
### Wrap into paragraphs {.unnumbered}  
## Handle by position { }
### Extract by character position {.unnumbered}  
### Extract by word position {.unnumbered} 
### Replace by character position {.unnumbered} 
### Evaluate length  {.unnumbered}
## Patterns { }
### Detect a pattern {.unnumbered}
#### Convert commas to periods {.unnumbered}  
### Replace all {.unnumbered}  
### Detect within logic {.unnumbered}
### Locate pattern position {.unnumbered}  
### Extract a match {.unnumbered}  
### Subset and count {.unnumbered}  
### Regex groups {.unnumbered}
## Special characters  
## Regular expressions (regex) 
## Regex and special characters { } 
## Resources { }

<!--chapter:end:new_pages/characters_strings.Rmd-->


# Factors {}

Placeholder


## Preparation  
### Load packages {.unnumbered}  
### Import data {.unnumbered}  
### New categorical variable {#fct_newcat .unnumbered}  
#### Create column {.unnumbered}  
#### Default value order {.unnumbered}  
## Convert to factor  
## Add or drop levels  
### Add {#fct_add .unnumbered}
### Drop {.unnumbered}  
## Adjust level order {#fct_adjust} 
### Manually {.unnumbered} 
### Within a plot {.unnumbered}  
### Reverse {.unnumbered}  
### By frequency {.unnumbered}  
### By appearance {.unnumbered}  
### By summary statistic of another column {.unnumbered}  
### By "end" value {.unnumbered}  
## Missing values {#fct_missing}  
## Combine levels  
### Manually {.unnumbered}  
### Reduce into "Other" {.unnumbered}  
### Reduce by frequency {.unnumbered}
## Show all levels  
### In plots {.unnumbered}  
### In tables {.unnumbered}  
## Epiweeks  
### Epiweeks in a plot {.unnumbered}  
### Epiweeks in the data {.unnumbered}  
## Resources {} 

<!--chapter:end:new_pages/factors.Rmd-->

<!-- ======================================================= -->

<!-- ======================================================= -->

<!-- ======================================================= -->

# 12 データの縦横変換 {#pivoting}

```{r, warning=F, message=F, out.height = c('50%'), fig.align="center", fig.show='hold', echo=F}
knitr::include_graphics(here::here("images", "pivoting", "Pivoting_500x500.png"))

#knitr::include_graphics(here::here("images", "pivoting", "pivot_longer_new.png"))
#knitr::include_graphics(here::here("images", "pivoting", "pivot_bar.png"))
#knitr::include_graphics(here::here("images", "pivoting", "pivot_wider_new.png"))
```

データを管理する上で、[ピボットする]{.ul}とは次の2つの工程のどちらかを指しています。

1.  [ピボットテーブル]{.ul}（より大きなテーブルデータを要約した統計表）を作成すること。
2.  表を**ロング**形式から**ワイド**形式へ、またはその逆へ変換すること。

**このページでは、後者の定義に焦点をあてます。**前者はデータ解析の重要なステップであり、[データのグループ化](#grouping)および[記述統計表の作り方](#tables-descriptive)のページで別に取り上げています。

このページでは、データの形式について説明します。各変数がそれぞれ列を持ち、各観測値がそれぞれ行を持ち、各値がそれぞれセルを持つという「整頓されたデータ」の考え方を知っておくと役に立ちます。このトピックについて詳しくは、[R for Data Scienceの章](https://r4ds.had.co.nz/tidy-data.html)を参照してください。

## 12.1 準備

### パッケージの読み込み {.unnumbered}

This code chunk shows the loading of packages required for the analyses. In this handbook we emphasize `p_load()` from **pacman**, which installs the package if necessary *and* loads it for use. You can also load installed packages with `library()` from **base** R. See the page on [R basics] for more information on R packages.

このコードチャンクは、解析に必要なパッケージの読み込みを示しています。このハンドブックでは **pacman** の `p_load()` を強調し、必要ならパッケージをインストールのうえ使用するためにロードします。インストールされたパッケージは **base** R から `library()` でロードすることもできます。R のパッケージについて詳しくは [R の基礎](#basics) のページを参照してください。

```{r}
pacman::p_load(
  rio,          # File import ファイルのインポートする
  here,         # File locator　ファイルの場所を指定する
  tidyverse)    # data management + ggplot2 graphics
```

### データのインポート {.unnumbered}

### マラリア発生数のデータ {.unnumbered}

In this page, we will use a fictional dataset of daily malaria cases, by facility and age group. If you want to follow along, <a href='https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/malaria_facility_count_data.rds' class='download-button'>click here to download (as .rds file)<span></a>. Import data with the `import()` function from the **rio** package (it handles many file types like .xlsx, .csv, .rds - see the [Import and export] page for details).

このページでは、毎日のマラリア症例について、施設別、年齢層別の架空のデータセットを使用します。続いて、

<a href='https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/malaria_facility_count_data.rds' class='download-button'>ここをクリックしてダウンロードしてください（rdsファイルです）<span></a>。**rio** パッケージの `import()` 関数でデータをインポートします (これは .xlsx, .csv, .rds など多くの種類のファイルを扱えます - 詳しくは [Import and export] ページを参照してください)。

```{r, echo=F}
count_data <- rio::import(here::here("data", "malaria_facility_count_data.rds")) %>% 
  as_tibble()
```

```{r, eval=F}
# Import data
count_data <- import("malaria_facility_count_data.rds")
```

The first 50 rows are displayed below.

最初の50行が以下に表示されます。

```{r, message=FALSE, echo=F}
# display the linelist data as a table
DT::datatable(head(count_data, 50), rownames = FALSE, options = list(pageLength = 5, scrollX=T), class = 'white-space: nowrap' )
```

### Linelist case data {.unnumbered}

### ラインリスト症例データ

In the later part of this page, we will also use the dataset of cases from a simulated Ebola epidemic. If you want to follow along, <a href='https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/case_linelists/linelist_cleaned.rds' class='download-button'>click to download the "clean" linelist</a> (as .rds file). Import your data with the `import()` function from the **rio** package (it accepts many file types like .xlsx, .rds, .csv - see the [Import and export] page for details).

このページの後半では、エボラ出血熱の流行をシミュレーションした症例のデータセットも使用する予定です。もし、これに従いたいなら、<a href='https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/case_linelists/linelist_cleaned.rds' class='download-button'>クリックして「きれいな」ラインリストをダウンロードする（rds ファイルです）。**rio** パッケージの `import()` 関数でデータをインポートする (これは .xlsx, .rds, .csv など多くのファイル形式を受け付ける - 詳しくは [データのインポートとエクスポート] ページを参照)。

```{r, echo=F}
# import the linelist into R
linelist <- rio::import(here::here("data", "case_linelists", "linelist_cleaned.rds"))
```

```{r, eval=F}
# import your dataset
linelist <- import("linelist_cleaned.xlsx")
```

<!-- ======================================================= -->

## Wide-to-long

## ワイドからロングへ

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "pivoting", "pivot_longer_new.png"))
```

<!-- ======================================================= -->

### "Wide" format {.unnumbered}

### ワイドのフォーマット

Data are often entered and stored in a "wide" format - where a subject's characteristics or responses are stored in a single row. While this may be useful for presentation, it is not ideal for some types of analysis.

Let us take the `count_data` dataset imported in the Preparation section above as an example. You can see that each row represents a "facility-day". The actual case counts (the right-most columns) are stored in a "wide" format such that the information for every age group on a given facility-day is stored in a single row.

データはしばしば「ワイド」フォーマットで入力・保存されます。つまり、被験者の特性や回答が1つの行に保存されるのです。これはプレゼンテーションには便利かもしれませんが、ある種の分析には理想的ではありません。

上記の準備の章でインポートした `count_data` データセットを例にとってみましょう。各行が「施設日」を表していることがわかります。実際の症例数（一番右の列）は「ワイド」形式で格納されており、ある施設日のすべての年齢層の情報が一行に格納されています。

```{r, echo=F}
DT::datatable(count_data, rownames = FALSE, options = list(pageLength = 5, scrollX=T) )
```

Each observation in this dataset refers to the malaria counts at one of 65 facilities on a given date, ranging from `count_data$data_date %>% min()` to `count_data$data_date %>% max()`. These facilities are located in one `Province` (North) and four `District`s (Spring, Bolo, Dingo, and Barnard). The dataset provides the overall counts of malaria, as well as age-specific counts in each of three age groups - \<4 years, 5-14 years, and 15 years and older.

"Wide" data like this are not adhering to "tidy data" standards, because the column headers do not actually represent "variables" - they represent *values* of a hypothetical "age group" variable.

This format can be useful for presenting the information in a table, or for entering data (e.g. in Excel) from case report forms. However, in the analysis stage, these data typically should be transformed to a "longer" format more aligned with "tidy data" standards. The plotting R package **ggplot2** in particular works best when data are in a "long" format.

Visualising the *total* malaria counts over time poses no difficulty with the data in it's current format:

このデータセットの各オブザベーションは、与えられた日付の、`count_data$data_date %>% min()` から `count_data$data_date %>% max()` までの65施設の一つにおけるマラリアカウントを指しています。これらの施設は、1つの`Province`（North）と4つの`District`（Spring、Bolo、Dingo、Barnard）に位置している。このデータセットでは、マラリア全体のカウントと、3つの年齢グループ（4歳未満、5～14歳、15歳以上）のそれぞれにおける年齢別のカウントが提供されています。\\

このような「ワイド」データは、列見出しが実際には「変数」を表しておらず、仮想的な「年齢層」変数の値を表しているため、「整頓されたデータ」の基準に従っているとは言えません。\\

このフォーマットは、情報を表で表示したり、症例報告書からデータを入力（Excelなど）する際に便利である。しかし、解析段階では、これらのデータは通常、「整頓されたデータ」基準に沿った「長い」形式に変換した方が良いです。特にRパッケージのggplot2は、データが "long "フォーマットである場合に最適に機能します。

マラリアの総計を時系列で視覚化することは、現在のデータ形式では困難ではありません。

```{r, warning=F, message=F}
ggplot(count_data) +
  geom_col(aes(x = data_date, y = malaria_tot), width = 1)
```

However, what if we wanted to display the relative contributions of each age group to this total count? In this case, we need to ensure that the variable of interest (age group), appears in the dataset in a single column that can be passed to `{ggplot2}`'s "mapping aesthetics" `aes()` argument.

しかし、この総数に対する各年齢層の相対的な寄与を表示したいとしたらどうだろうか。この場合、`{ggplot2}`の「マッピングの美学」`aes()`引数に渡すことができる単一の列で、関心のある変数（年齢層）がデータセットに表示されていることを確認する必要があります。

<!-- ======================================================= -->

### `pivot_longer()` {.unnumbered}

The **tidyr** function `pivot_longer()` makes data "longer". **tidyr** is part of the **tidyverse** of R packages.

It accepts a range of columns to transform (specified to `cols =`). Therefore, it can operate on only a part of a dataset. This is useful for the malaria data, as we only want to pivot the case count columns.

In this process, you will end up with two "new" columns - one with the categories (the former column names), and one with the corresponding values (e.g. case counts). You can accept the default names for these new columns, or you can specify your own to `names_to =` and `values_to =` respectively.

Let's see `pivot_longer()` in action...

**tidyr**の関数`pivot_longer()`は、データを「より長く」します。**tidyr**は、Rパッケージの**tidyverse**の一部です。

それは、変換する列の範囲（`= cols`に指定）を受け取ります。したがって、それはデータセットの一部だけで操作することができます。これは、ケースカウント列だけをピボット化したいので、マラリアデータには便利です。

この処理では、2 つの「新しい」列が作成されます。1 つはカテゴリ (以前の列名) で、もう 1 つは対応する値 (例: 症例数) で構成されます。これらの新しい列の名前は、デフォルトのままでも構いませんが、`names_to =`および`values_to =`にそれぞれ独自の名前を指定することもできます。

それでは、`pivot_longer()` を実際に動かしてみましょう...。

### Standard pivoting {.unnumbered}

標準的な変換

We want to use **tidyr**'s `pivot_longer()` function to convert the "wide" data to a "long" format. Specifically, to convert the four numeric columns with data on malaria counts to two new columns: one which holds the *age groups* and one which holds the corresponding *values*.

**tidyr** の `pivot_longer()` 関数を使用して、「ワイド」データを 「ロング」 形式に変換したいと思います。具体的には、マラリアの症例のデータを持つ4つの数値列を、年齢グループを保持する列と対応する値を保持する列の2つの新しい列に変換します。

```{r, eval=F}
df_long <- count_data %>% 
  pivot_longer(
    cols = c(`malaria_rdt_0-4`, `malaria_rdt_5-14`, `malaria_rdt_15`, `malaria_tot`)
  )

df_long
```

Notice that the newly created data frame (`df_long`) has more rows (12,152 vs 3,038); it has become *longer*. In fact, it is precisely four times as long, because each row in the original dataset now represents four rows in df_long, one for each of the malaria count observations (\<4y, 5-14y, 15y+, and total).

In addition to becoming longer, the new dataset has fewer columns (8 vs 10), as the data previously stored in four columns (those beginning with the prefix `malaria_`) is now stored in two.

Since the names of these four columns all begin with the prefix `malaria_`, we could have made use of the handy "tidyselect" function `starts_with()` to achieve the same result (see the page [Cleaning data and core functions] for more of these helper functions).

新しく作成されたデータフレーム（`df_long`）は行数が増え（12,152 vs 3,038）、[より長く]{.ul}なっていることに注意してください。実際、それは正確に4倍の長さです。なぜなら、オリジナルのデータセットの各行が、df_longの4行を表し、マラリア・カウントのオブザベーション（\<4y, 5-14y, 15y+, and total）のそれぞれについて1行ずつだからです。\\

長くなっただけでなく、新しいデータセットでは列数が8から10に減っています。以前は4つの列（接頭辞`malaria_`で始まる列）に格納されていたデータが、現在は2つの列に格納されているからです。\\

これらの4つの列の名前はすべて接頭辞`malaria_`で始まるので、便利な「tidyselect」関数`starts_with()`を使って同じ結果を得ることができました（これらのヘルパー関数については、[データクリーニングと主要関数]のページを参照してください）。

```{r}
# provide column with a tidyselect helper function
count_data %>% 
  pivot_longer(
    cols = starts_with("malaria_")
  )
```

or by position:

または位置によって

```{r, eval=F}
# provide columns by position
count_data %>% 
  pivot_longer(
    cols = 6:9
  )
```

or by named range:

または名前の範囲によって

```{r, eval=F}
# provide range of consecutive columns
count_data %>% 
  pivot_longer(
    cols = `malaria_rdt_0-4`:malaria_tot
  )
```

These two new columns are given the default names of `name` and `value`, but we can override these defaults to provide more meaningful names, which can help remember what is stored within, using the `names_to` and `values_to` arguments. Let's use the names `age_group` and `counts`:

この2つの新しいカラムには`name`と`value`というデフォルトの名前が与えられていますが、`names_to`と`values_to`という引数を使えば、これらのデフォルトを上書きして、より意味のある名前を付けることができますし、中に何が格納されているかを覚えるのに役立ちます。`age_group`と`counts`という名前を使ってみましょう。

```{r}
df_long <- 
  count_data %>% 
  pivot_longer(
    cols = starts_with("malaria_"),
    names_to = "age_group",
    values_to = "counts"
  )

df_long
```

We can now pass this new dataset to `{ggplot2}`, and map the new column `count` to the y-axis and new column `age_group` to the `fill =` argument (the column internal color). This will display the malaria counts in a stacked bar chart, by age group:

この新しいデータセットを`{ggplot2}`に渡して、新しい列`count`をY軸に、新しい列`age_group`を`fill =`引数（列の内部の色）に対応させることができます。これは、年齢グループごとに積み上げられた棒グラフでマラリア患者数を表示します。

```{r, warning=F, message=F}
ggplot(data = df_long) +
  geom_col(
    mapping = aes(x = data_date, y = counts, fill = age_group),
    width = 1
  )
```

Examine this new plot, and compare it with the plot we created earlier - *what has gone wrong?*

We have encountered a common problem when wrangling surveillance data - we have also included the total counts from the `malaria_tot` column, so the magnitude of each bar in the plot is twice as high as it should be.

We can handle this in a number of ways. We could simply filter these totals from the dataset before we pass it to `ggplot()`:

この新しいプロットを調べて、先ほど作ったプロットと比較してみてください。[何が悪い？]{.ul}

監視データを扱うときによくある問題に遭遇しました - `malaria_tot`列からの総カウントも含まれているので、プロットの各棒の大きさは、あるべき大きさの2倍になっています。

この問題はいくつかの方法で対処することができます。`ggplot()`に渡す前に、データセットからこれらの合計を単純にフィルタリングすることができます。

```{r, warning=F, message=F}
df_long %>% 
  filter(age_group != "malaria_tot") %>% 
  ggplot() +
  geom_col(
    aes(x = data_date, y = counts, fill = age_group),
    width = 1
  )
```

Alternatively, we could have excluded this variable when we ran `pivot_longer()`, thereby maintaining it in the dataset as a separate variable. See how its values "expand" to fill the new rows.

また、`pivot_longer()`を実行する際にこの変数を除外することで、別の変数としてデータセットに保持することも可能です。新しい行を埋めるために、この変数の値がどのように「拡張」されるかを見てみましょう。

```{r, warning=F, message=F}
count_data %>% 
  pivot_longer(
    cols = `malaria_rdt_0-4`:malaria_rdt_15,   # does not include the totals column
    names_to = "age_group",
    values_to = "counts"
  )
```

### Pivoting data of multiple classes {.unnumbered}

### 複数クラスのデータのピボット

The above example works well in situations in which all the columns you want to "pivot longer" are of the same class (character, numeric, logical...).

However, there will be many cases when, as a field epidemiologist, you will be working with data that was prepared by non-specialists and which follow their own non-standard logic - as Hadley Wickham noted (referencing Tolstoy) in his [seminal article](https://vita.had.co.nz/papers/tidy-data.pdf) on **Tidy Data** principles: "Like families, tidy datasets are all alike but every messy dataset is messy in its own way."

One particularly common problem you will encounter will be the need to pivot columns that contain different classes of data. This pivot will result in storing these different data types in a single column, which is not a good situation. There are various approaches one can take to separate out the mess this creates, but there is an important step you can take using `pivot_longer()` to avoid creating such a situation yourself.

Take a situation in which there have been a series of observations at different time steps for each of three items A, B and C. Examples of such items could be individuals (e.g. contacts of an Ebola case being traced each day for 21 days) or remote village health posts being monitored once per year to ensure they are still functional. Let's use the contact tracing example. Imagine that the data are stored as follows:

上記の例は、「長くピボットする」列がすべて同じクラス（文字列、数値、論理など）である場合にうまく機能します。\\

しかし、フィールドの疫学者として、非専門家によって作成され、独自の非標準的な論理に従ったデータを扱う場合が多くあります。Hadley Wickhamは、**Tidy Data**の原則に関する彼の[重要な論文]で（トルストイを参照）次のように指摘しています。「家族のように、整頓されたデータセットはすべて似ているが、乱雑なデータセットはそれなりに乱雑である。」\\

特によくある問題は、異なるクラスのデータを含む列をピボットする必要があることです。このピボットでは、これらの異なるデータ型を 1 つの列に格納することになりますが、これは良い状況ではありません。このような混乱を回避するために、さまざまなアプローチがありますが、`pivot_longer()` を使用して、自分でこのような状況を作らないようにするための重要なステップがあります。\\

3つの項目A, B, Cのそれぞれについて、異なる時間ステップで一連の観測が行われた状況を考えてみましょう。例えば、個人（例えば、エボラ出血熱患者の接触者を21日間毎日追跡する）や、遠隔地の村のヘルスポストがまだ機能しているかどうか年に1回モニターすることなどが挙げられます。接触者追跡の例を使ってみましょう。データが以下のように保存されていると想像してください。

```{r, message=FALSE, echo=F}

df <- 
  tibble::tribble(
     ~id,   ~obs1_date, ~obs1_status,   ~obs2_date, ~obs2_status,   ~obs3_date, ~obs3_status,
     "A", "2021-04-23",    "Healthy", "2021-04-24",    "Healthy", "2021-04-25",     "Unwell",
     "B", "2021-04-23",    "Healthy", "2021-04-24",    "Healthy", "2021-04-25",    "Healthy",
     "C", "2021-04-23",    "Missing", "2021-04-24",    "Healthy", "2021-04-25",    "Healthy"
     ) 

DT::datatable(df, rownames = FALSE)

```

As can be seen, the data are a bit complicated. Each row stores information about one item, but with the time series running further and further away to the right as time progresses. Moreover, the column classes alternate between date and character values.

One particularly bad example of this encountered by this author involved cholera surveillance data, in which 8 new columns of observations were added *each day* over the course of **4 years**. Simply opening the Excel file in which these data were stored took \>10 minuntes on my laptop!

In order to work with these data, we need to transform the data frame to long format, but keeping the separation between a `date` column and a `character` (status) column, for each observation for each item. If we don't, we might end up with a mixture of variable types in a single column (a very big "no-no" when it comes to data management and tidy data):

見ての通り、ちょっと複雑なデータになっています。各行には1つの項目に関する情報が格納されていますが、時間が進むにつれて時系列がどんどん右に流れています。さらに、列のクラスは日付と文字列の値が交互に並んでいます。\\

筆者が遭遇した特にひどい例は、コレラの監視データで、**4年間**[毎日]{.ul}8列の新しい観測値が追加されたものであった。これらのデータが保存されているExcelファイルを開くだけで、筆者のノートパソコンでは10分以上かかった。\\

これらのデータを扱うには、データフレームをロング形式に変換する必要がありますが、各項目の観測ごとに、`data`列と`character`（ステータス）列の分離を維持する必要があります。そうしないと、1つの列の中に変数の種類が混在してしまうかもしれません（データ管理や整頓されたデータに関しては、非常に大きな「やってはいけないこと」です）。

```{r}
df %>% 
  pivot_longer(
    cols = -id,
    names_to = c("observation")
  )

```

Above, our pivot has merged *dates* and *characters* into a single `value` column. R will react by converting the entire column to class character, and the utility of the dates is lost.

To prevent this situation, we can take advantage of the syntax structure of the original column names. There is a common naming structure, with the observation number, an underscore, and then either "status" or "date". We can leverage this syntax to keep these two data types in separate columns after the pivot.

We do this by:

-   Providing a character vector to the `names_to =` argument, with the second item being (`".value"` ). This special term indicates that the pivoted columns will be split based on a character in their name...\
-   You must also provide the "splitting" character to the `names_sep =` argument. In this case, it is the underscore "\_".

Thus, the naming and split of new columns is based around the underscore in the existing variable names.

上記では、ピボットによって日付と文字が1つの列の`value`に統合されています。R は列全体をクラス文字に変換することで対応し、日付の実用性が失われます。

このような事態を防ぐには、元の列名の構文構造を利用します。観察番号、アンダースコア、そして "status "または "date "のいずれかを含む共通の命名構造が存在します。この構文を利用して、ピボット後にこれら 2 つのデータ型を別の列に保持することができます。

これを行うには、以下のようにします。

-   `names_to =` 引数に文字ベクトルを指定し、2番目の項目に (`".value"`) を指定する。この特別な用語は、回転した列がその名前に含まれる文字に基づいて分割されることを示します...

-   また、`names_sep =` の引数には、「分割」する文字を指定する必要があります。この場合、アンダースコア"\_"である。

このように、新しい列の命名と分割は、既存の変数名のアンダースコア"\_"を中心に行われる。

```{r}

df_long <- 
  df %>% 
  pivot_longer(
    cols = -id,
    names_to = c("observation", ".value"),
    names_sep = "_"
  )

df_long

```

**Finishing touches**:

**仕上げに**

Note that the `date` column is currently in *character* class - we can easily convert this into it's proper date class using the `mutate()` and `as_date()` functions described in the [Working with dates] page.

We may also want to convert the `observation` column to a `numeric` format by dropping the "obs" prefix and converting to numeric. We cando this with `str_remove_all()` from the **stringr** package (see the [Characters and strings] page).

`date`列は現在文字クラスであることに注意してください。日付の操作のページで説明した `mutate()` と `as_date()` 関数を使用すれば、これを適切な日付クラスに簡単に変換できます。

"obs" というプレフィックスを削除して数値形式に変換することで、 `observation`列も`numeric`形式に変換できます。これは**stringr**パッケージの`str_remove_all()`を使って行うことができます([文字列型データ]のページを参照してください)。

```{r}

df_long <- 
  df_long %>% 
  mutate(
    date = date %>% lubridate::as_date(),
    observation = 
      observation %>% 
      str_remove_all("obs") %>% 
      as.numeric()
  )

df_long

```

And now, we can start to work with the data in this format, e.g. by plotting a descriptive heat tile:

そして、この形式のデータを使って、例えば、記述的なヒートタイルをプロットするなどの作業を開始することができます。

```{r}
ggplot(data = df_long, mapping = aes(x = date, y = id, fill = status)) +
  geom_tile(colour = "black") +
  scale_fill_manual(
    values = 
      c("Healthy" = "lightgreen", 
        "Unwell" = "red", 
        "Missing" = "orange")
  )

```

<!-- ======================================================= -->

## Long-to-wide

## ロングからワイドへ

```{r, warning=F, message=F, echo=F}
knitr::include_graphics(here::here("images", "pivoting", "pivot_wider_new.png"))
```

In some instances, we may wish to convert a dataset to a wider format. For this, we can use the `pivot_wider()` function.

A typical use-case is when we want to transform the results of an analysis into a format which is more digestible for the reader (such as a [Table for presentation][Tables for presentation]). Usually, this involves transforming a dataset in which information for one subject is are spread over multiple rows into a format in which that information is stored in a single row.

場合によっては、データセットをより広いフォーマットに変換したいことがあります。このような場合は、`pivot_wider()`関数を使用します。

典型的な使用例としては、分析結果を読み手にとって理解しやすい形式（[プレゼンテーション用の表]など）に変換する場合です。通常は、1 つの主題に関する情報が複数の行にまたがっているデータセットを、その情報が 1 つの行に格納される形式に変換することが必要です。

### Data {.unnumbered}

### データ {.unnumbered}

For this section of the page, we will use the case linelist (see the [Preparation](#pivot_prep) section), which contains one row per case.

Here are the first 50 rows:

この章では、1つの症例につき1行が含まれる症例ラインリスト（[準備](#pivot_prep)の章を参照）を使用することにします。

ここでは、最初の50行を示します。

```{r, message=FALSE, echo=F}
# display the linelist data as a table
DT::datatable(head(linelist, 50), rownames = FALSE, options = list(pageLength = 5, scrollX=T), class = 'white-space: nowrap' )
```

Suppose that we want to know the counts of individuals in the different age groups, by gender: 例えば、男女別の年齢層別の個体数を知りたいとします。

```{r}
df_wide <- 
  linelist %>% 
  count(age_cat, gender)

df_wide
```

This gives us a long dataset that is great for producing visualisations in **ggplot2**, but not ideal for presentation in a table: これは長いデータセットで、**ggplot2**での視覚化には最適ですが、表での表示には適していません。

```{r}
ggplot(df_wide) +
  geom_col(aes(x = age_cat, y = n, fill = gender))
```

### Pivot wider {.unnumbered}

Therefore, we can use `pivot_wider()` to transform the data into a better format for inclusion as tables in our reports.

The argument `names_from` specifies the column *from* which to generate the new column *names*, while the argument `values_from` specifies the column *from* which to take the *values* to populate the cells. The argument `id_cols =` is optional, but can be provided a vector of column names that should not be pivoted, and will thus identify each row.

したがって、`pivot_wider()` を使用して、データを報告書の表として含めるためのより良い形式に変換することができます。\
引数 `names_from` は、新しい*列名*を生成する*ための*列を指定し、引数 `values_from` は、セルに入力する*値*を取得する*ための*列を指定します。`id_cols =` はオプションですが、ピボット化されるべきでない列名のベクトルを提供することができ、それによって各行を識別することができます。

```{r}
table_wide <- 
  df_wide %>% 
  pivot_wider(
    id_cols = age_cat,
    names_from = gender,
    values_from = n
  )

table_wide
```

This table is much more reader-friendly, and therefore better for inclusion in our reports. You can convert into a pretty table with several packages including **flextable** and **knitr**. This process is elaborated in the page [Tables for presentation]. この表は、より読みやすいので、報告書に掲載するのに適しています。**flextable**や**knitr**を含むいくつかのパッケージできれいな表に変換することができます。この作業は、[見やすい表の作り方]のページで詳しく説明されています。

```{r}
table_wide %>% 
  janitor::adorn_totals(c("row", "col")) %>% # adds row and column totals
  knitr::kable() %>% 
  kableExtra::row_spec(row = 10, bold = TRUE) %>% 
  kableExtra::column_spec(column = 5, bold = TRUE) 
```

------------------------------------------------------------------------

<!-- ======================================================= -->

## Fill

In some situations after a `pivot`, and more commonly after a `bind`, we are left with gaps in some cells that we would like to fill. `pivot`の後、そしてより一般的には`bind`の後、いくつかのセルに隙間ができてしまい、それを埋めたいと思うことがあります。 <!-- ======================================================= -->

### Data {.unnumbered}

### データ {.unnumbered}

For example, take two datasets, each with observations for the measurement number, the name of the facility, and the case count at that time. However, the second dataset also has a variable `Year`. 例えば、2つのデータセットがあり、それぞれ測定番号、施設名、その時点の症例数の観測値があるとします。しかし、2番目のデータセットには変数`Year`もあります。

```{r}
df1 <- 
  tibble::tribble(
       ~Measurement, ~Facility, ~Cases,
                  1,  "Hosp 1",     66,
                  2,  "Hosp 1",     26,
                  3,  "Hosp 1",      8,
                  1,  "Hosp 2",     71,
                  2,  "Hosp 2",     62,
                  3,  "Hosp 2",     70,
                  1,  "Hosp 3",     47,
                  2,  "Hosp 3",     70,
                  3,  "Hosp 3",     38,
       )

df1 

df2 <- 
  tibble::tribble(
    ~Year, ~Measurement, ~Facility, ~Cases,
     2000,            1,  "Hosp 4",     82,
     2001,            2,  "Hosp 4",     87,
     2002,            3,  "Hosp 4",     46
  )

df2
```

When we perform a `bind_rows()` to join the two datasets together, the `Year` variable is filled with `NA` for those rows where there was no prior information (i.e. the first dataset): `bind_rows()`で2つのデータセットを結合すると、事前情報がない行（つまり最初のデータセット）については、`Year`変数が`NA`で埋められる。

```{r}
df_combined <- 
  bind_rows(df1, df2) %>% 
  arrange(Measurement, Facility)

df_combined

```

<!-- ======================================================= -->

### `fill()` {.unnumbered}

In this case, `Year` is a useful variable to include, particularly if we want to explore trends over time. Therefore, we use `fill()` to *fill* in those empty cells, by specifying the column to fill and the direction (in this case **up**): この場合、`Year`は特に時間的な傾向を調べるのに有効な変数である。したがって、塗りつぶす列と方向 (この場合は**上**) を指定して、空のセルを*塗りつぶす*ために `fill()` を使用します。

```{r}
df_combined %>% 
  fill(Year, .direction = "up")
```

Alternatively, we can rearrange the data so that we would need to fill in a downward direction: あるいは、下方向に塗りつぶす必要があるように、データを並べ替えることもできる。

```{r}
df_combined <- 
  df_combined %>% 
  arrange(Measurement, desc(Facility))

df_combined

df_combined <- 
  df_combined %>% 
  fill(Year, .direction = "down")

df_combined
```

We now have a useful dataset for plotting: これで、プロットするのに便利なデータセットができました。

```{r}
ggplot(df_combined) +
  aes(Year, Cases, fill = Facility) +
  geom_col()
```

But less useful for presenting in a table, so let's practice converting this long, untidy dataframe into a wider, tidy dataframe: そこで、この長くて整頓されていないデータフレームを、より広くて整頓されたデータフレームに変換する練習をしてみましょう。

```{r}
df_combined %>% 
  pivot_wider(
    id_cols = c(Facility, Year, Cases),
    names_from = "Year",
    values_from = "Cases"
  ) %>% 
  arrange(Facility) %>% 
  janitor::adorn_totals(c("row", "col")) %>% 
  knitr::kable() %>% 
  kableExtra::row_spec(row = 5, bold = TRUE) %>% 
  kableExtra::column_spec(column = 5, bold = TRUE) 
```

N.B. In this case, we had to specify to only include the three variables `Facility`, `Year`, and `Cases` as the additional variable `Measurement` would interfere with the creation of the table: 注）この場合、変数`Measurement`を追加すると表の作成に支障が出るため、`Facility`、`Year`、`Cases`の3つの変数のみを含めるように指定する必要がありました。

```{r}
df_combined %>% 
  pivot_wider(
    names_from = "Year",
    values_from = "Cases"
  ) %>% 
  knitr::kable()
```

## Resources

Here is a helpful [tutorial](https://datacarpentry.org/r-socialsci/03-dplyr-tidyr/index.html) 役に立つ[チュートリアル](https://datacarpentry.org/r-socialsci/03-dplyr-tidyr/index.html)はこちら
```{r include=FALSE, cache=FALSE}

# clear workspace
rm(list = ls(all = TRUE))

# clear all packages except base
#lapply(names(sessionInfo()$loadedOnly), require, character.only = TRUE)
#invisible(lapply(paste0('package:', names(sessionInfo()$otherPkgs)), detach, character.only=TRUE, unload=TRUE, force=TRUE))

# to ensure that tidyverse packages prevail
filter <- dplyr::filter
select <- dplyr::select
summarise <- dplyr::summarise
summary <- base::summary
incidence <- incidence2::incidence

#load core packages
pacman::p_load(
     rio,
     here,
     DT,
     stringr,
     lubridate,
     tidyverse
)

# import the cleaned ebola linelist
linelist <- rio::import(here::here("data", "case_linelists", "linelist_cleaned.rds"))

# import the count data - facility level
#count_data <- rio::import(here::here("data", "facility_count_data.rds"))

# Settings

options(scipen=1, digits=7)

# print only text (not code)
#library(knitr)
#opts_chunk$set(list(echo = FALSE, eval = FALSE))
```

<!--chapter:end:new_pages/pivoting.Rmd-->


# Grouping data { }  

Placeholder


## Preparation {  }
### Load packages {.unnumbered}  
### Import data {.unnumbered}
## Grouping {  }
### Unique groups {.unnumbered}  
### New columns {.unnumbered} 
### Add/drop grouping columns {.unnumbered}  
## Un-group  
## Summarise {#group_summarise} 
## Counts and tallies  
### `tally()` {.unnumbered}  
### `count()`  {.unnumbered}  
### Add counts {.unnumbered}  
### Add totals {.unnumbered} 
## Grouping by date  
### Linelist cases into days  {.unnumbered}  
### Linelist cases into weeks {.unnumbered}  
### Linelist cases into months {.unnumbered}
### Daily counts into weeks {.unnumbered}
#### Daily counts into months {.unnumbered}
## Arranging grouped data
## Filter on grouped data
### `filter()` {.unnumbered}
### Slice rows per group {.unnumbered} 
### Filter on group size {#group_filter_grp_size .unnumbered} 
## Mutate on grouped data  
## Select on grouped data  
## Resources {  }

<!--chapter:end:new_pages/grouping.Rmd-->


# Joining data { }  

Placeholder


## Preparation { }
### Load packages {.unnumbered}
### Import data {.unnumbered}
### Example datasets {.unnumbered}
#### "Miniature" case linelist {#joins_llmini .unnumbered}  
#### Hospital information data frame {#joins_hosp_info .unnumbered}  
### Pre-cleaning {.unnumbered}
## **dplyr** joins { }
### General syntax {.unnumbered}
### Left and right joins {.unnumbered}  
#### "Should I use a right join, or a left join?" {.unnumbered}  
### Full join {.unnumbered} 
### Inner join {.unnumbered} 
### Semi join {.unnumbered} 
### Anti join {.unnumbered} 
#### Simple `anti_join()` example {.unnumbered}  
#### Complex `anti_join()` example {.unnumbered}  
## Probabalistic matching { }
### Probabilistic matching {.unnumbered}  
### Probabilistic deduplication {.unnumbered}  
## Binding and aligning  
### Bind rows {.unnumbered}
### Bind columns {.unnumbered}
#### Use `match()` to align ordering {.unnumbered}  
## Resources { }

<!--chapter:end:new_pages/joining_matching.Rmd-->


# De-duplication {}  

Placeholder


## Preparation { }
### Load packages {.unnumbered}
### Import data {.unnumbered}
#### Here is the data frame {#dedup_data .unnumbered}  
## Deduplication { }
### Examine duplicate rows {.unnumbered}  
### Keep only unique rows  {.unnumbered}
### Deduplicate elements in a vector {.unnumbered}  
### Using **base** R {.unnumbered}
## Slicing { }
### Slice with groups  {.unnumbered}
### Keep all but mark them  {.unnumbered}
### Calculate row completeness {.unnumbered} 
## Roll-up values {#str_rollup}
### Roll-up values into one row {.unnumbered}  
### Overwrite values/hierarchy {.unnumbered} 
## Probabilistic de-duplication  
## Resources { }

<!--chapter:end:new_pages/deduplication.Rmd-->


# Iteration, loops, and lists { }  

Placeholder


## Preparation {  }
### Load packages {.unnumbered}  
### Import data {.unnumbered}  
## *for loops* {  }
### *for loops* in R {#iter_loops .unnumbered}  
### Core components {.unnumbered}   
### Sequence {.unnumbered}  
### Operations  {.unnumbered}  
### Container {.unnumbered}
### Printing {.unnumbered}  
### Testing your for loop {.unnumbered}
### Looping plots {.unnumbered}
### Tracking progress of a loop {.unnumbered} 
## **purrr** and lists {#iter_purrr}
### Load packages {.unnumbered}  
### `map()` {.unnumbered}  
#### Example - import and combine Excel sheets {#iter_combined .unnumbered}  
### Split dataset and export {.unnumbered}  
#### Split dataset {.unnumbered}  
##### More than one `group_split()` column {.unnumbered}  
#### Export as Excel sheets {.unnumbered}  
#### Export as CSV files {.unnumbered}  
### Custom functions {.unnumbered}  
### Mapping a function across columns {.unnumbered}  
### Extract from lists {.unnumbered}  
#### Names of elements {.unnumbered}  
#### Elements by name or position {.unnumbered}  
#### `pluck()` {.unnumbered}  
### Convert list to data frame {.unnumbered}  
### Discard, keep, and compact lists {.unnumbered}  
### `pmap()` {.unnumbered}
## Apply functions  
## Resources { }

<!--chapter:end:new_pages/iteration.Rmd-->

# (PART) Analysis {.unnumbered}

```{r include=FALSE, cache=FALSE}

# clear workspace
rm(list = ls(all = TRUE))

# clear all packages except base
#lapply(names(sessionInfo()$loadedOnly), require, character.only = TRUE)
#invisible(lapply(paste0('package:', names(sessionInfo()$otherPkgs)), detach, character.only=TRUE, unload=TRUE, force=TRUE))

# to ensure that tidyverse packages prevail
filter <- dplyr::filter
select <- dplyr::select
summarise <- dplyr::summarise
summary <- base::summary
incidence <- incidence2::incidence

#load core packages
pacman::p_load(
     rio,
     here,
     DT,
     stringr,
     lubridate,
     tidyverse
)

# import the cleaned ebola linelist
linelist <- rio::import(here::here("data", "case_linelists", "linelist_cleaned.rds"))

# import the count data - facility level
#count_data <- rio::import(here::here("data", "facility_count_data.rds"))

# Settings

options(scipen=1, digits=7)

# print only text (not code)
#library(knitr)
#opts_chunk$set(list(echo = FALSE, eval = FALSE))
```

<!--chapter:end:new_pages/cat_analysis.Rmd-->


# Descriptive tables { }

Placeholder


## Preparation {  }
### Load packages {.unnumbered}
### Import data {.unnumbered}
## Browse data {  }
### **skimr** package {.unnumbered}
### Summary statistics {.unnumbered} 
## **janitor** package {#tbl_janitor}  
### Simple tabyl {.unnumbered}  
### Cross-tabulation {.unnumbered}  
### "Adorning" the tabyl {#tbl_adorn .unnumbered}  
### Printing the tabyl {.unnumbered}
### Use on other tables {.unnumbered}  
### Saving the tabyl {.unnumbered}  
### Statistics {#janitor_age_out_stats .unnumbered}  
### Other tips {.unnumbered}  
## **dplyr** package   
### Get counts {.unnumbered}  
### Show all levels {.unnumbered}  
### Proportions {#tbl_dplyr_prop .unnumbered}  
### Plotting {.unnumbered}  
### Summary statistics {.unnumbered}  
### Conditional statistics {.unnumbered}  
### Glueing together {.unnumbered}  
#### Percentiles {.unnumbered}  
### Summarise aggregated data {.unnumbered}  
### `across()` multiple columns {.unnumbered}  
### Pivot wider {#tbls_pivot_wider .unnumbered}
### Total rows {#tbl_dplyr_totals .unnumbered}  
#### **janitor**'s `adorn_totals()` {.unnumbered}  
#### `summarise()` on "total" data and then `bind_rows()` {.unnumbered}  
## **gtsummary** package {#tbl_gt}   
### Summary table {.unnumbered}
### Adjustments {.unnumbered}  
### Multi-line stats for continuous variables {.unnumbered}  
## **base** R   
### Proportions {.unnumbered}  
### Totals {.unnumbered}  
### Convert to data frame {.unnumbered}  
## Resources {  }

<!--chapter:end:new_pages/tables_descriptive.Rmd-->


# Simple statistical tests { }

Placeholder


## Preparation {  }
### Load packages {.unnumbered}
### Import data {.unnumbered}
## **base** R {}
### T-tests {.unnumbered} 
### Shapiro-Wilk test {.unnumbered}  
### Wilcoxon rank sum test {.unnumbered}
### Kruskal-Wallis test {.unnumbered}
### Chi-squared test {.unnumbered} 
## **rstatix** package {}
### Summary statistics {.unnumbered}  
### T-test {.unnumbered}  
### Shapiro-Wilk test {.unnumbered}  
### Wilcoxon rank sum test {.unnumbered}  
### Kruskal-Wallis test {.unnumbered}  
### Chi-squared test {.unnumbered}  
## `gtsummary` package {#stats_gt}
### Chi-squared test {.unnumbered}
### T-tests {.unnumbered} 
### Wilcoxon rank sum test{.unnumbered}
### Kruskal-wallis test {.unnumbered}
## Correlations 
## Resources {  }

<!--chapter:end:new_pages/stat_tests.Rmd-->


# Univariate and multivariable regression { }

Placeholder


## Preparation {  }
### Load packages {.unnumbered}
### Import data {.unnumbered}
### Clean data {.unnumbered}
#### Store explanatory variables {.unnumbered}  
#### Convert to 1's and 0's  {.unnumbered}   
#### Drop rows with missing values {.unnumbered}  
## Univariate {  }
### **base** R {.unnumbered}
#### Linear regression {.unnumbered}  
#### Logistic regression {.unnumbered}  
#### Univariate `glm()` {.unnumbered}
#### Printing results {.unnumbered}
#### Looping multiple univariate models {.unnumbered}  
### **gtsummary** package {#reg_gt_uni .unnumbered}
## Stratified {  }
## Multivariable  
### Conduct multivariable {.unnumbered}  
#### Building the model {.unnumbered}  
### Combine univariate and multivariable {.unnumbered}
#### Combine with **gtsummary**  {.unnumbered}  
#### Combine with **dplyr** {.unnumbered}  
## Forest plot {  }
### **ggplot2** package {.unnumbered}
### **easystats** packages {.unnumbered}
## Resources {  }

<!--chapter:end:new_pages/regression.Rmd-->


# Missing data { }

Placeholder


## Preparation { }
### Load packages {.unnumbered}  
### Import data {.unnumbered}
### Convert missing on import {.unnumbered}  
## Missing values in R { }
### `NA` {.unnumbered}  
### Versions of `NA` {.unnumbered}  
### `NULL` {.unnumbered}  
### `NaN` {.unnumbered}  
### `Inf` {.unnumbered}  
### Examples {.unnumbered}  
## Useful functions { }
### `is.na()` and `!is.na()` {.unnumbered}  
### `na.omit()` {.unnumbered}  
### `drop_na()` {.unnumbered}  
### `na.rm = TRUE` {.unnumbered}  
## Assess missingness in a data frame { }
### Quantifying missingness {.unnumbered}
### Visualizing missingness {.unnumbered}  
### Explore and visualize missingness relationships {.unnumbered} 
### "Shadow" columns {.unnumbered}
## Using data with missing values  
### Filter out rows with missing values {.unnumbered}
### Handling `NA` in `ggplot()` {.unnumbered}
### `NA` in factors {.unnumbered}
## Imputation { }
### Types of missing data {.unnumbered}
### Useful packages {.unnumbered}
### Mean Imputation {.unnumbered}
### Regression imputation {.unnumbered}
### LOCF and BOCF {.unnumbered}
### Multiple Imputation {.unnumbered}
## Resources { }

<!--chapter:end:new_pages/missing_data.Rmd-->


# Standardised rates { }  

Placeholder


## Overview  
## Preparation {  }
### Load packages {.unnumbered}
### Load population data {.unnumbered}  
### Load death counts {.unnumbered}  
### Clean populations and deaths {.unnumbered}  
### Load reference population {.unnumbered}  
### Clean reference population {.unnumbered}
### Create dataset with standard population {#standard_all .unnumbered}  
## **dsr** package {  }
### Standardized rates {.unnumbered}
### Standardized rate ratios {.unnumbered}
### Standardized rate difference {.unnumbered}
## **PHEindicatormethods** package {#standard_phe  }
### Directly standardized rates {.unnumbered}
### Indirectly standardized rates {#standard_indirect .unnumbered}
## Resources {  }

<!--chapter:end:new_pages/standardization.Rmd-->


# Moving averages { }  

Placeholder


## Preparation {  }
### Load packages {.unnumbered}
### Import data {.unnumbered}
## Calculate with **slider** {  }
### Rolling by date  {#roll_index .unnumbered}  
### Indexed data {.unnumbered}  
### Rolling by group {#roll_slider_group .unnumbered}  
## Calculate with **tidyquant** within `ggplot()` {  }
## Resources {  }

<!--chapter:end:new_pages/moving_average.Rmd-->


# Time series and outbreak detection { }  

Placeholder


## Overview {  }
## Preparation {  }
### Packages {.unnumbered}
### Load data {.unnumbered}
### Clean data {.unnumbered}
### Download climate data {.unnumbered} 
### Load climate data {.unnumbered}
## Time series data {  }
### Duplicates {.unnumbered}
### Missings {.unnumbered}
## Descriptive analysis {  }
### Moving averages {#timeseries_moving .unnumbered}
### Periodicity {.unnumbered}
### Decomposition {.unnumbered}
### Autocorrelation {.unnumbered}
## Fitting regressions {  }
### Fourier terms {.unnumbered}
### Negative binomial {.unnumbered}
### Residuals {.unnumbered}
## Relation of two time series {  }
### Merging datasets {.unnumbered}
### Descriptive analysis {.unnumbered}
### Lags and cross-correlation {.unnumbered}
### Negative binomial with two variables {.unnumbered}
#### Residuals {.unnumbered}
## Outbreak detection {  }
### **trending** package {.unnumbered}
#### Cut-off date { -}
#### Add rows {.unnumbered}
#### Fourier terms {.unnumbered}
#### Split data and fit regression {.unnumbered}
#### Prediction validation {.unnumbered}
### **surveillance** package {.unnumbered}
#### Farrington method {.unnumbered}
#### GLRNB method {.unnumbered}
## Interrupted timeseries {  }
## Resources {  }

<!--chapter:end:new_pages/time_series.Rmd-->


# Epidemic modeling { }  

Placeholder


## Overview {  }
## Preparation {  }
## Estimating R<sub>t</sub> {  }
### EpiNow2 vs. EpiEstim {.unnumbered}
### EpiNow2 {.unnumbered}
#### Estimating delay distributions {.unnumbered}
#### Running **EpiNow2** {.unnumbered}
#### Analysing outputs {.unnumbered}
### EpiEstim {.unnumbered}
#### Using serial interval estimates from the literature {.unnumbered}
#### Using serial interval estimates from the data {.unnumbered}
#### Specifying estimation time windows {.unnumbered}
#### Analysing outputs {.unnumbered}
## Projecting incidence {  }
### EpiNow2 {.unnumbered}
### projections {.unnumbered}
#### Using serial interval estimates from the literature {.unnumbered}
#### Using serial interval estimates from the data {.unnumbered}
#### Projecting incidence {.unnumbered}
## Resources {  }

<!--chapter:end:new_pages/epidemic_models.Rmd-->


# Contact tracing { }

Placeholder


## Preparation
### Load packages {.unnumbered}  
### Import data {.unnumbered}
#### Case data {.unnumbered}  
#### Contacts data {.unnumbered}  
#### Follow-up data {.unnumbered}  
#### Relationships data {.unnumbered}  
## Descriptive analyses  
### Demographics {.unnumbered}  
#### Age and Gender of contacts {.unnumbered}  
### Contacts per case {.unnumbered}  
## Contact Follow Up  
### Data cleaning {.unnumbered}  
### Plot over time {.unnumbered}  
### Daily individual tracking  {.unnumbered}  
### Analyse by group {.unnumbered}  
## KPI Tables  
## Transmission Matrices  
## Resources  

<!--chapter:end:new_pages/contact_tracing.Rmd-->


# Survey analysis { }  

Placeholder


## Overview {  }
## Preparation {  }
### Packages {.unnumbered}
### Load data {.unnumbered}
### Clean data {.unnumbered}
## Survey data {  }
## Observation time {  }
## Weighting {  }
## Survey design objects {  }
### **Survey** package  
### **Srvyr** package  
## Descriptive analysis {  }
### Sampling bias 
### Demographic pyramids 
### Alluvial/sankey diagram
## Weighted proportions {  }
### **Survey** package 
### **Srvyr** package 
### **Sitrep** package 
### **Gtsummary** package
## Weighted ratios {  }
### **Survey** package 
### **Srvyr** package 
## Resources {  }

<!--chapter:end:new_pages/survey_analysis.Rmd-->


# Survival analysis { }  

Placeholder


## Overview {}
## Preparation {  }
### Load packages {.unnumbered}  
### Import dataset {.unnumbered}  
### Data management and transformation {.unnumbered}
## Basics of survival analysis {}
### Building a surv-type object {.unnumbered}
### Running initial analyses {.unnumbered}
### Cumulative hazard {.unnumbered}  
### Plotting Kaplan-Meir curves  {.unnumbered}
## Comparison of survival curves 
### Log rank test {.unnumbered}
## Cox regression analysis {}
### Fitting a Cox model {.unnumbered}
### Forest plots {.unnumbered}
## Time-dependent covariates in survival models {}
### Time-dependent covariate setup {.unnumbered} 
#### Add unique patient identifier {.unnumbered}  
#### Expand patient rows {.unnumbered}  
### Cox regression with time-dependent covariates {.unnumbered} 
## Resources {  }

<!--chapter:end:new_pages/survival_analysis.Rmd-->


# GIS basics { }  

Placeholder


## Overview {  }
## Key terms {}  
### GIS software {.unnumbered}
### Spatial data {.unnumbered}
### Visualizing spatial data {.unnumbered}
## Getting started with GIS  
### Types of maps for visualizing your data {.unnumbered}
## Preparation {  }
### Load packages {.unnumbered}  
### Sample case data {.unnumbered}
### Admin boundary shapefiles {.unnumbered}  
### Population data {.unnumbered}  
### Health Facilities {.unnumbered}
## Plotting coordinates {  }
## Spatial joins {}
### Points in polygon {.unnumbered}
### Nearest neighbor {.unnumbered}
### Buffers {.unnumbered} 
### Other spatial joins {.unnumbered}  
## Choropleth maps {}  
## Mapping with ggplot2
## Basemaps { }
### OpenStreetMap {.unnumbered} 
## Contoured density heatmaps {}
### Time series heatmap {.unnumbered}
## Spatial statistics
### Spatial relationships {.unnumbered}  
### Spatial autocorrelation {.unnumbered}  
### Spatial regression {.unnumbered}  
## Resources {  }

<!--chapter:end:new_pages/gis.Rmd-->

# (PART) Data Visualization {.unnumbered}
```{r include=FALSE, cache=FALSE}

# clear workspace
rm(list = ls(all = TRUE))

# clear all packages except base
#lapply(names(sessionInfo()$loadedOnly), require, character.only = TRUE)
#invisible(lapply(paste0('package:', names(sessionInfo()$otherPkgs)), detach, character.only=TRUE, unload=TRUE, force=TRUE))

# to ensure that tidyverse packages prevail
filter <- dplyr::filter
select <- dplyr::select
summarise <- dplyr::summarise
summary <- base::summary
incidence <- incidence2::incidence

#load core packages
pacman::p_load(
     rio,
     here,
     DT,
     stringr,
     lubridate,
     tidyverse
)

# import the cleaned ebola linelist
linelist <- rio::import(here::here("data", "case_linelists", "linelist_cleaned.rds"))

# import the count data - facility level
#count_data <- rio::import(here::here("data", "facility_count_data.rds"))

# Settings

options(scipen=1, digits=7)

# print only text (not code)
#library(knitr)
#opts_chunk$set(list(echo = FALSE, eval = FALSE))
```

<!--chapter:end:new_pages/cat_data_viz.Rmd-->


# Tables for presentation { }  

Placeholder


## Preparation {  }
### Load packages {.unnumbered} 
### Import data {.unnumbered}  
### Prepare table {.unnumbered}  
## Basic flextable {  }
### Create a flextable {.unnumbered}  
### Column width {.unnumbered}
### Column headers {.unnumbered}
### Borders and background {.unnumbered}  
### Font and alignment {.unnumbered}
### Merge cells {.unnumbered}  
### Background color {.unnumbered}
## Conditional formatting {  }
## All code together {#tbl_pres_all}  
## Saving your table {  }
### Save single table {.unnumbered}
### Print table in R markdown {.unnumbered}  
## Resources {  }

<!--chapter:end:new_pages/tables_presentation.Rmd-->


# ggplot basics {}

Placeholder


## Preparation {}
### Load packages {.unnumbered}
### Import data {.unnumbered}  
### General cleaning {.unnumbered}
### Pivoting longer {.unnumbered}
## Basics of ggplot {}
## `ggplot()`  
## Geoms  
## Mapping data to the plot {#ggplot_basics_mapping}  
### Plot aesthetics {.unnumbered}  
### Set to a static value {.unnumbered}  
### Scaled to column values {.unnumbered}  
### Where to make mapping assignments {#ggplot_basics_map_loc .unnumbered}
### Groups {#ggplotgroups .unnumbered}  
## Facets / Small-multiples {#ggplot_basics_facet}  
### `facet_wrap()` {.unnumbered}
### `facet_grid()` {.unnumbered}  
### Free or fixed axes {.unnumbered}  
### Factor level order in facets {.unnumbered}  
## Storing plots  
### Saving plots {.unnumbered}
### Modifying saved plots {.unnumbered}  
### Exporting plots {.unnumbered}   
## Labels 
## Themes {#ggplot_basics_themes} 
### Complete themes {.unnumbered}  
### Modify theme {.unnumbered}  
## Colors  
## Piping into **ggplot2**   
## Plot continuous data
### Histograms {.unnumbered}
### Box plots {.unnumbered}
### Violin, jitter, and sina plots {.unnumbered}
### Two continuous variables  {.unnumbered}
### Three continuous variables {.unnumbered}  
## Plot categorical data  
### Preparation  {.unnumbered}
#### Data structure {.unnumbered}  
#### Column class and value ordering {.unnumbered}  
### `geom_bar()` {#ggplot_basics_bars .unnumbered}  
### `geom_col()` {.unnumbered}  
### `geom_histogram()` {.unnumbered}  
## Resources  

<!--chapter:end:new_pages/ggplot_basics.Rmd-->


# ggplot tips {}

Placeholder


## Preparation {}
### Load packages {.unnumbered}
### Import data {.unnumbered}  
## Scales for color, fill, axes, etc. {#ggplot_tips_colors}
### Color schemes
### Scales {#ggplot_tips_scales .unnumbered}  
### Scale arguments {.unnumbered}  
### Manual adjustments {.unnumbered}  
### Continuous axes scales {.unnumbered}  
#### Display percents {.unnumbered}  
#### Log scale {.unnumbered}  
### Gradient scales {.unnumbered}  
### Palettes {.unnumbered}  
#### Colorbrewer and Viridis {.unnumbered}
## Change order of discrete variables {}  
#### **ggthemr** {.unnnumbered}  
## Contour lines  
## Marginal distributions  
## Smart Labeling {}  
## Time axes {}
## Highlighting {}
## Plotting multiple datasets  
## Combine plots {}
### `plot_grid()` {.unnumbered}
### Combine legends {.unnumbered}  
### Inset plots {.unnumbered} 
## Dual axes {}
## Packages to help you  
### Point-and-click **ggplot2** with **equisse**  {.unnumbered}
## Miscellaneous  
### Numeric display {.unnumbered}  
## Resources

<!--chapter:end:new_pages/ggplot_tips.Rmd-->


# Epidemic curves { }  

Placeholder


## Preparation
### Packages {.unnumbered}  
### Import data {.unnumbered}
### Set parameters {.unnumbered}
### Verify dates {.unnumbered}
## Epicurves with **incidence2** package { }
### Simple example {.unnumbered}
### Change time interval of case aggregation {.unnumbered}  
### Groups {.unnumbered}
### Filtered data {.unnumbered}
### Aggregated counts {.unnumbered}
### Facets/small multiples {.unnumbered}  
### Modifications with `plot()` {.unnumbered} 
### Modifications with ggplot2 {.unnumbered}
### Change colors  {.unnumbered}  
#### Specify a palette {.unnumbered}  
#### Specify manually {.unnumbered}  
### Adjust level order {.unnumbered}  
### Vertical gridlines {.unnumbered}  
### Cumulative incidence {.unnumbered}  
### Rolling average  {.unnumbered}
## Epicurves with ggplot2 { }
### Specify case bins {.unnumbered}  
### Weekly epicurve example {.unnumbered}  
#### Sunday weeks {.unnumbered}  
### Group/color by value {.unnumbered}
### Adjust colors {.unnumbered}  
### Adjust level order {.unnumbered}  
### Adjust legend {.unnumbered}
### Bars side-by-side {.unnumbered}  
### Axis limits {.unnumbered}  
### Date-axis labels/gridlines {.unnumbered} 
#### Demonstrations {.unnumbered}
### Aggregated data {.unnumbered} 
#### Plotting daily counts {.unnumbered}  
#### Plotting weekly counts {.unnumbered}
### Moving averages {.unnumbered}
### Faceting/small-multiples {.unnumbered}
#### Total epidemic in facet background {.unnumbered}
#### One facet with data {.unnumbered}  
## Tentative data  
### Using `annotate()` {.unnumbered}
### Bars color {.unnumbered}  
## Multi-level date labels  
## Dual-axis { }  
## Cumulative Incidence {}
## Resources { }

<!--chapter:end:new_pages/epicurves.Rmd-->


# Demographic pyramids and Likert-scales {}  

Placeholder


## Preparation {}
### Load packages {.unnumbered}
### Import data {.unnumbered}  
### Cleaning {.unnumbered}  
## **apyramid** package {}
### Linelist data {.unnumbered}  
#### Missing values {.unnumbered}  
#### Proportions, colors, & aesthetics {.unnumbered}  
### Aggregated data {.unnumbered}  
## `ggplot()` {#demo_pyr_gg}
### Preparation {.unnumbered}
### Constructing the plot {.unnumbered} 
### Compare to baseline  {.unnumbered} 
## Likert scale {}
## Resources {}

<!--chapter:end:new_pages/age_pyramid.Rmd-->


# Heat plots { }  

Placeholder


## Preparation { }
### Load packages {.unnumbered}  
## Transmission matrix  
### Data preparation {.unnumbered}  
#### Make cases data frame {.unnumbered} 
#### Make infectors data frame {.unnumbered}  
### Create heat plot {.unnumbered}  
## Reporting metrics over time { }
### Data preparation {.unnumbered}
#### Aggregate and summarize {.unnumbered}
### Create heat plot {.unnumbered}
### Basic {.unnumbered}  
### Cleaned plot {.unnumbered}
### Ordered y-axis {.unnumbered}  
### Display values {.unnumbered}  
## Resources { }

<!--chapter:end:new_pages/heatmaps.Rmd-->


# Diagrams and charts { }  

Placeholder


## Preparation { }
### Load packages {.unnumbered}  
### Import data {.unnumbered}  
## Flow diagrams { }
### Simple examples {.unnumbered} 
### Syntax  {.unnumbered}
### Complex examples  {.unnumbered}
### Outputs  {.unnumbered}
### Parameterized figures {.unnumbered} 
## Alluvial/Sankey Diagrams { }
### Load packages {.unnumbered}  
### Plotting from dataset {.unnumbered} 
## Event timelines { }
## DAGs { }
## Resources { }

<!--chapter:end:new_pages/diagrams.Rmd-->


# Combinations analysis { }  

Placeholder


## Preparation {  }
### Load packages {.unnumbered}
### Import data {.unnumbered}  
### Re-format values {.unnumbered}  
## **ggupset** {  }
## `UpSetR` {  }
## Resources {  }

<!--chapter:end:new_pages/combination_analysis.Rmd-->


# Transmission chains { }

Placeholder


## Overview {  }
## Preparation {  }
### Load packages {.unnumbered}  
### Import data {.unnumbered}
### Creating an epicontacts object {.unnumbered}
## Handling {  }
### Subsetting {.unnumbered}
### Accessing IDs {.unnumbered}
## Visualization {  }
### Basic plotting {.unnumbered}
#### Visualising node attributes {.unnumbered}
#### Visualising edge attributes {.unnumbered}
### Temporal axis {.unnumbered}
#### Specifying transmission tree shape {.unnumbered}
#### Saving plots and figures {.unnumbered}
### Timelines {.unnumbered}
## Analysis {  }
### Summarising {.unnumbered}
### Pairwise characteristics {.unnumbered}
### Identifying clusters {.unnumbered}
### Calculating degrees {.unnumbered}
## Resources {  }

<!--chapter:end:new_pages/transmission_chains.Rmd-->


# Phylogenetic trees {}  

Placeholder


## Overview {}
## Preparation {}
### Load packages {.unnumbered}  
### Import data {.unnumbered}  
### Clean and inspect {.unnumbered}  
## Simple tree visualization {}
### Different tree layouts {.unnumbered}  
### Simple tree plus sample data {.unnumbered}  
## Tree manipulation {}
### Zoom in {.unnumbered}  
### Collapsing branches {.unnumbered} 
### Subsetting a tree {.unnumbered} 
### Rotating nodes in a tree {.unnumbered} 
### Example subtree with sample data annotation {.unnumbered} 
## More complex trees: adding heatmaps of sample data {.unnumbered}
## Resources {}

<!--chapter:end:new_pages/phylogenetic_trees.Rmd-->


# Interactive plots { }  

Placeholder


## Preparation {  }
### Load packages {.unnumbered}  
### Start with a `ggplot()` {.unnumbered}  
### Import data {.unnumbered}
## Plot with `ggplotly()` {  }
## Modifications {  }
### File size {.unnumbered}  
### Buttons {.unnumbered}  
## Heat tiles {  }
## Resources {  }

<!--chapter:end:new_pages/interactive_plots.Rmd-->

# (PART) Reports and dashboards {.unnumbered}
```{r include=FALSE, cache=FALSE}

# clear workspace
rm(list = ls(all = TRUE))

# clear all packages except base
#lapply(names(sessionInfo()$loadedOnly), require, character.only = TRUE)
#invisible(lapply(paste0('package:', names(sessionInfo()$otherPkgs)), detach, character.only=TRUE, unload=TRUE, force=TRUE))

# to ensure that tidyverse packages prevail
filter <- dplyr::filter
select <- dplyr::select
summarise <- dplyr::summarise
summary <- base::summary
incidence <- incidence2::incidence

#load core packages
pacman::p_load(
     rio,
     here,
     DT,
     stringr,
     lubridate,
     tidyverse
)

# import the cleaned ebola linelist
linelist <- rio::import(here::here("data", "case_linelists", "linelist_cleaned.rds"))

# import the count data - facility level
#count_data <- rio::import(here::here("data", "facility_count_data.rds"))

# Settings

options(scipen=1, digits=7)

# print only text (not code)
#library(knitr)
#opts_chunk$set(list(echo = FALSE, eval = FALSE))
```

<!--chapter:end:new_pages/cat_reports_dashboards.Rmd-->


# Reports with R Markdown { }  

Placeholder


## Preparation {  }
## Getting started {  }
### Install rmarkdown R package {.unnumbered}
### Starting a new Rmd file {.unnumbered}
### Important to know {.unnumbered}
## R Markdown components {  }
### YAML metadata {.unnumbered}
### Text {.unnumbered}
#### New lines {.unnumbered}  
#### Case {.unnumbered}  
#### Color {.unnumbered}  
#### Titles and headings {.unnumbered}  
#### Bullets and numbering {.unnumbered}  
#### Comment out text {.unnumbered}
### Code chunks {.unnumbered}
#### In-text R code {.unnumbered}  
### Images {.unnumbered}  
### Tables {.unnumbered}  
### Tabbed sections {.unnumbered}  
## File structure {}
### Self-contained Rmd {.unnumbered}  
#### Source other files {.unnumbered}
### Runfile {.unnumbered}  
### Folder strucutre {.unnumbered}  
## Producing the document  
### Option 1: "Knit" button {.unnumbered}  
### Option 2: `render()` command {.unnumbered}
###  Options 3: **reportfactory**  package {.unnumbered}  
## Parameterised reports {  }
### Setting parameters {.unnumbered}
#### Option 1: Set parameters within YAML {.unnumbered}
#### Option 2: Set parameters within `render()` {.unnumbered}  
#### Option 3: Set parameters using a Graphical User Interface {.unnumbered}  
### Parameterized example {.unnumbered} 
### Parameterisation without `params` {.unnumbered}
## Looping reports  {  }
## Templates  
### Word documents {.unnumbered}
### Powerpoint documents {.unnumbered}
### Integrating templates into the YAML {.unnumbered}
### Formatting HTML files {.unnumbered}
## Dynamic content  
### Tables {.unnumbered}  
### HTML widgets {.unnumbered}
## Resources {  }

<!--chapter:end:new_pages/rmarkdown.Rmd-->


# Organizing routine reports {  }  

Placeholder


## Preparation
### Load packages {.unnumbered}  
## New factory  
## Create a report  
## Compile  
### Compile by name {.unnumbered}  
### Compile by number {.unnumbered}
### Compile all {.unnumbered}
### Compile from sub-folder {.unnumbered}  
### Parameterization {.unnumbered}
### Using a "run-file" {.unnumbered}  
## Outputs  
## Miscellaneous  
### Knit {.unnumbered} 
### Scripts {.unnumbered}  
### Extras {.unnumbered} 
## Resources {  }

<!--chapter:end:new_pages/reportfactory.Rmd-->


# Dashboards with R Markdown { }

Placeholder


## Preparation
### Load packages {.unnumbered}  
### Import data {.unnumbered}  
## Create new R Markdown  
## The script  
### YAML {.unnumbered}  
### Code chunks {.unnumbered}  
### Narrative text {.unnumbered}  
### Headings {.unnumbered}  
## Section attributes  
## Layout {#layout}  
### Pages {.unnumbered}  
### Orientation {.unnumbered}  
### Tabs {.unnumbered} 
## Adding content  
### Text {.unnumbered}  
### Tables {.unnumbered}  
### Plots {.unnumbered}  
### Interactive plots {.unnumbered}  
### HTML widgets {.unnumbered}
## Code organization
## Shiny  
### Settings {.unnumbered}  
### Worked example {.unnumbered}  
### Other examples {.unnumbered}  
## Sharing  
## Resources  

<!--chapter:end:new_pages/flexdashboard.Rmd-->


# Dashboards with Shiny { }  

Placeholder


## Preparation  
### Load packages {.unnumbered}  
### Import data {.unnumbered}  
## The structure of a shiny app {  }
### Basic file structures {.unnumbered}  
### The server and the ui {.unnumbered}
### Before you start to build an app {.unnumbered}
## Building a UI 
## Loading data into our app
## Developing an app server
## Adding more functionality
### Adding static text {.unnumbered}  
### Adding a link {.unnumbered}
### Adding a download button {.unnumbered}
### Adding a facility selector {.unnumbered}  
### Adding another tab with a table {.unnumbered}
## Sharing shiny apps
## Further reading
## Recommended extension packages
## Recommended resources

<!--chapter:end:new_pages/shiny_basics.Rmd-->

# (PART) Miscellaneous {.unnumbered}
```{r include=FALSE, cache=FALSE}

# clear workspace
rm(list = ls(all = TRUE))

# clear all packages except base
#lapply(names(sessionInfo()$loadedOnly), require, character.only = TRUE)
#invisible(lapply(paste0('package:', names(sessionInfo()$otherPkgs)), detach, character.only=TRUE, unload=TRUE, force=TRUE))

# to ensure that tidyverse packages prevail
filter <- dplyr::filter
select <- dplyr::select
summarise <- dplyr::summarise
summary <- base::summary
incidence <- incidence2::incidence

#load core packages
pacman::p_load(
     rio,
     here,
     DT,
     stringr,
     lubridate,
     tidyverse
)

# import the cleaned ebola linelist
linelist <- rio::import(here::here("data", "case_linelists", "linelist_cleaned.rds"))

# import the count data - facility level
#count_data <- rio::import(here::here("data", "facility_count_data.rds"))

# Settings

options(scipen=1, digits=7)

# print only text (not code)
#library(knitr)
#opts_chunk$set(list(echo = FALSE, eval = FALSE))
```

<!--chapter:end:new_pages/cat_misc.Rmd-->


# Writing functions  

Placeholder


## Preparation {  }
### Load packages {-}
### Import data {-}
## Functions  
## Why would you use a function? 
## How does R  build functions?
## Basic syntax and structure
## Examples  
### Return proportion tables for several columns {.unnumbered}  
## Using **purrr**: writing functions that can be iteratively applied
### Modify class of multiple columns in a dataset {.unnumbered}  
### Iteratively produce graphs for different levels of a variable {.unnumbered}
### Iteratively produce tables for different levels of a variable {.unnumbered}
## Tips and best Practices for well functioning functions
### Naming and syntax {.unnumbered}
### Column names and tidy evaluation {.unnumbered}  
### Testing and Error handling {.unnumbered}
## Resources

<!--chapter:end:new_pages/writing_functions.Rmd-->


# Directory interactions { }  

Placeholder


## Preparation  
### **fs** package {.unnumbered}  
### Print directory as a dendrogram tree {.unnumbered}  
## List files in a directory  
## File information  
## Check if exists  
### R objects {.unnumbered}  
### Directories {.unnumbered}  
### Files {.unnumbered}  
## Create  
### Directories {.unnumbered}  
### Files {.unnumbered}  
### Create if does not exists {.unnumbered}  
## Delete
### R objects {.unnumbered}  
### Directories {.unnumbered}  
### Files {.unnumbered}  
## Running other files  
### `source()` {.unnumbered}  
### `render()` {.unnumbered}  
### Run files in a directory {.unnumbered}
### Import files in a directory  {.unnumbered}
## **base** R  
## Resources {  }

<!--chapter:end:new_pages/directories.Rmd-->


# Version control and collaboration with Git and Github

Placeholder


## What is Git?
## Why use the combo Git and Github?
### This sounds complicated, I am not a programmer {-}
## Setup
### Install Git {.unnumbered}
### Install an interface (optional but recommended) {.unnumbered}
### Github account {.unnumbered}
## Vocabulary, concepts and basic functions
### Repository {.unnumbered}
### Commits {.unnumbered}
### Branches {.unnumbered}
### Local and remote repositories {.unnumbered}
## Get started: create a new repository
### Start-up files {.unnumbered}
### Create a new repository in Github {.unnumbered}
### Clone from a Github repository {.unnumbered}
#### In Rstudio {.unnumbered}
#### In Github Desktop {.unnumbered}
### New Github repo from existing R project {.unnumbered}
### What does it look like now? {.unnumbered}
#### In RStudio {-}
#### In Github Desktop {-}
## Git + Github workflow
### Process overview {.unnumbered}
## Create a new branch
### In Rstudio Git pane {.unnumbered}
### In Github Desktop {.unnumbered}
### In console {.unnumbered}
## Commit changes
### In Rstudio {.unnumbered}
### In Github Desktop {.unnumbered}
### In console {.unnumbered}
### Amend a previous commit {.unnumbered}
## Pull and push changes up to Github
#### In Rstudio {.unnumbered}
#### In Github Desktop {.unnumbered}
#### Console {.unnumbered}
### I want to pull but I have local work {.unnumbered}
## Merge branch into Main 
### Locally in Github Desktop {.unnumbered}
### In console {.unnumbered}
### In Github: submitting pull requests {.unnumbered}
### Resolving conflicts {.unnumbered}
### Delete your branch {.unnumbered}
#### Github + Rstudio
#### In Github Desktop
### Forking {.unnumbered}
## What we learned
## Git commands {#git}
### Recommended learning {.unnumbered}
### Where to enter commands {.unnumbered}
### Sample commands {.unnumbered}
## Resources

<!--chapter:end:new_pages/collaboration.Rmd-->


# Common errors  

Placeholder


## Interpreting error messages  
## Common errors  
### Typo errors {.unnumbered}  
### Package errors {.unnumbered}  
### Object errors {.unnumbered}  
### Function syntax errors {.unnumbered}
### Logic errors {.unnumbered}  
### Factor errors {.unnumbered}  
### Plotting errors {.unnumbered}  
### R Markdown errors {.unnumbered}  
### Miscellaneous {.unnumbered}  
## Resources { }

<!--chapter:end:new_pages/errors.Rmd-->


# Getting help  

Placeholder


## Github issues  
## Reproducible example  
### The **reprex** package {.unnumbered}  
### Minimal data {.unnumbered}  
## Posting to a forum  
## Resources { }

<!--chapter:end:new_pages/help.Rmd-->


# R on network drives { }  

Placeholder


## Overview {  }
## RStudio as administrator  
## Useful commands 
## Troubleshooting common errors {  }

<!--chapter:end:new_pages/network_drives.Rmd-->


# Data Table { }  

Placeholder


## Intro to data tables {  }
## Load packages and import data { }
### Load packages {.unnumbered}  
### Import data {.unnumbered}
## The i argument: selecting and filtering rows{ }
### Using helper functions for filtering {.unnumbered}  
## The j argument: selecting and computing on columns{ }
### Selecting columns {.unnumbered} 
### Computing on columns {.unnumbered} 
## The by argument: computing by groups{ }
## Adding and updating to data tables { }
## Resources {  }

<!--chapter:end:new_pages/data_table.Rmd-->

