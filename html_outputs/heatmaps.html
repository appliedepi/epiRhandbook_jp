<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>34 ヒートマップ | 疫学のための R ハンドブック</title>
<meta name="author" content="the handbook team">
<meta name="description" content="「ヒートプロット」や「ヒートタイル」とも呼ばれるヒートマップは、3 つの変数（x 軸、y 軸、色）を表示しようとする際に便利なデータ可視化の手法です。本章では、2 つの例を紹介します。 年齢別の感染イベント（「誰から誰への感染か」）の可視化 施設ごとの報告率を時系列で追跡して可視化   34.1 準備  パッケージの読み込み...">
<meta name="generator" content="bookdown 0.29 with bs4_book()">
<meta property="og:title" content="34 ヒートマップ | 疫学のための R ハンドブック">
<meta property="og:type" content="book">
<meta property="og:description" content="「ヒートプロット」や「ヒートタイル」とも呼ばれるヒートマップは、3 つの変数（x 軸、y 軸、色）を表示しようとする際に便利なデータ可視化の手法です。本章では、2 つの例を紹介します。 年齢別の感染イベント（「誰から誰への感染か」）の可視化 施設ごとの報告率を時系列で追跡して可視化   34.1 準備  パッケージの読み込み...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="34 ヒートマップ | 疫学のための R ハンドブック">
<meta name="twitter:description" content="「ヒートプロット」や「ヒートタイル」とも呼ばれるヒートマップは、3 つの変数（x 軸、y 軸、色）を表示しようとする際に便利なデータ可視化の手法です。本章では、2 つの例を紹介します。 年齢別の感染イベント（「誰から誰への感染か」）の可視化 施設ごとの報告率を時系列で追跡して可視化   34.1 準備  パッケージの読み込み...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.0/transition.js"></script><script src="libs/bs3compat-0.4.0/tabs.js"></script><script src="libs/bs3compat-0.4.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.25/datatables.js"></script><link href="libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/tabwid-1.1.0/tabwid.css" rel="stylesheet">
<link href="libs/tabwid-1.1.0/scrool.css" rel="stylesheet">
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.9/grViz.js"></script><script src="libs/d3-4.5.0/d3.min.js"></script><script src="libs/sankey-1/sankey.js"></script><script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script><script src="libs/plotly-binding-4.10.0/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-2.5.1/plotly-latest.min.js"></script><link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="libs/vis-9.1.0/vis-network.min.js"></script><script src="libs/visNetwork-binding-2.1.0/visNetwork.js"></script><link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="libs/plotly-basic-2.5.1/plotly-basic-2.5.1.min.js"></script><script src="libs/plotly-cartesian-2.5.1/plotly-cartesian-2.5.1.min.js"></script><script src="libs/proj4js-2.3.15/proj4.js"></script><link href="libs/highcharts-9.3.1/css/motion.css" rel="stylesheet">
<script src="libs/highcharts-9.3.1/highcharts.js"></script><script src="libs/highcharts-9.3.1/highcharts-3d.js"></script><script src="libs/highcharts-9.3.1/highcharts-more.js"></script><script src="libs/highcharts-9.3.1/modules/stock.js"></script><script src="libs/highcharts-9.3.1/modules/map.js"></script><script src="libs/highcharts-9.3.1/modules/data.js"></script><script src="libs/highcharts-9.3.1/modules/exporting.js"></script><script src="libs/highcharts-9.3.1/modules/offline-exporting.js"></script><script src="libs/highcharts-9.3.1/modules/drilldown.js"></script><script src="libs/highcharts-9.3.1/modules/item-series.js"></script><script src="libs/highcharts-9.3.1/modules/overlapping-datalabels.js"></script><script src="libs/highcharts-9.3.1/modules/annotations.js"></script><script src="libs/highcharts-9.3.1/modules/export-data.js"></script><script src="libs/highcharts-9.3.1/modules/funnel.js"></script><script src="libs/highcharts-9.3.1/modules/heatmap.js"></script><script src="libs/highcharts-9.3.1/modules/treemap.js"></script><script src="libs/highcharts-9.3.1/modules/sankey.js"></script><script src="libs/highcharts-9.3.1/modules/dependency-wheel.js"></script><script src="libs/highcharts-9.3.1/modules/organization.js"></script><script src="libs/highcharts-9.3.1/modules/solid-gauge.js"></script><script src="libs/highcharts-9.3.1/modules/streamgraph.js"></script><script src="libs/highcharts-9.3.1/modules/sunburst.js"></script><script src="libs/highcharts-9.3.1/modules/vector.js"></script><script src="libs/highcharts-9.3.1/modules/wordcloud.js"></script><script src="libs/highcharts-9.3.1/modules/xrange.js"></script><script src="libs/highcharts-9.3.1/modules/tilemap.js"></script><script src="libs/highcharts-9.3.1/modules/venn.js"></script><script src="libs/highcharts-9.3.1/modules/gantt.js"></script><script src="libs/highcharts-9.3.1/modules/timeline.js"></script><script src="libs/highcharts-9.3.1/modules/parallel-coordinates.js"></script><script src="libs/highcharts-9.3.1/modules/bullet.js"></script><script src="libs/highcharts-9.3.1/modules/coloraxis.js"></script><script src="libs/highcharts-9.3.1/modules/dumbbell.js"></script><script src="libs/highcharts-9.3.1/modules/lollipop.js"></script><script src="libs/highcharts-9.3.1/modules/series-label.js"></script><script src="libs/highcharts-9.3.1/plugins/motion.js"></script><script src="libs/highcharts-9.3.1/custom/reset.js"></script><script src="libs/highcharts-9.3.1/modules/boost.js"></script><script src="libs/highchart-binding-0.9.4/highchart.js"></script><script type="text/javascript">
        // window.addEventListener("load", function() {
        //     document.getElementById('toc').firstChild.innerHTML = "章目次"; 
        // });
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementsByClassName("d-flex align-items-start justify-content-between")[0].children[0].children[0].innerHTML = "疫学のための R</br>ハンドブック";
            document.getElementById('toc').firstChild.innerHTML = "章目次"; 
            document.getElementById('main-nav').children[1].firstChild.innerHTML = "総目次";
            document.getElementById('search').setAttribute("placeholder", "検索");
        });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style_bs4.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">疫学のための R ハンドブック</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"></a></li>
<li class="book-part">本書について</li>
<li><a class="" href="editorial-style.html"><span class="header-section-number">1</span> 編集前記・技術注記</a></li>
<li><a class="" href="data-used.html"><span class="header-section-number">2</span> ハンドブックとデータのダウンロード</a></li>
<li class="book-part">基本編</li>
<li><a class="" href="basics.html"><span class="header-section-number">3</span> R の基礎</a></li>
<li><a class="" href="transition-to-R.html"><span class="header-section-number">4</span> Excel・Stata・SASとの比較</a></li>
<li><a class="" href="packages-suggested.html"><span class="header-section-number">5</span> 推奨パッケージ</a></li>
<li><a class="" href="r-projects.html"><span class="header-section-number">6</span> R プロジェクト</a></li>
<li><a class="" href="importing.html"><span class="header-section-number">7</span> データのインポート・エクスポート</a></li>
<li class="book-part">データマネジメント</li>
<li><a class="" href="cleaning.html"><span class="header-section-number">8</span> データクリーニングと主要関数</a></li>
<li><a class="" href="dates.html"><span class="header-section-number">9</span> 日付型データ</a></li>
<li><a class="" href="characters-strings.html"><span class="header-section-number">10</span> 文字型・文字列型データ</a></li>
<li><a class="" href="factors.html"><span class="header-section-number">11</span> 因子（ファクタ）型データ</a></li>
<li><a class="" href="pivoting.html"><span class="header-section-number">12</span> データの縦横変換</a></li>
<li><a class="" href="grouping.html"><span class="header-section-number">13</span> データのグループ化</a></li>
<li><a class="" href="joining-matching.html"><span class="header-section-number">14</span> データの結合</a></li>
<li><a class="" href="deduplication.html"><span class="header-section-number">15</span> 重複データの排除</a></li>
<li><a class="" href="iteration.html"><span class="header-section-number">16</span> ループと反復処理・リストの操作</a></li>
<li class="book-part">データ分析</li>
<li><a class="" href="tables-descriptive.html"><span class="header-section-number">17</span> 記述統計表の作り方</a></li>
<li><a class="" href="stat-tests.html"><span class="header-section-number">18</span> 基本的な統計的検定</a></li>
<li><a class="" href="regression.html"><span class="header-section-number">19</span> 単変量と多変量回帰</a></li>
<li><a class="" href="missing-data.html"><span class="header-section-number">20</span> データの欠損</a></li>
<li><a class="" href="standardization.html"><span class="header-section-number">21</span> 標準化率</a></li>
<li><a class="" href="moving-average.html"><span class="header-section-number">22</span> 移動平均</a></li>
<li><a class="" href="time-series.html"><span class="header-section-number">23</span> 時系列分析とアウトブレイクの検出</a></li>
<li><a class="" href="epidemic-models.html"><span class="header-section-number">24</span> エピデミックモデリング</a></li>
<li><a class="" href="contact-tracing.html"><span class="header-section-number">25</span> 接触者の追跡</a></li>
<li><a class="" href="survey-analysis.html"><span class="header-section-number">26</span> 標本調査データ分析</a></li>
<li><a class="" href="survival-analysis.html"><span class="header-section-number">27</span> 生存時間解析</a></li>
<li><a class="" href="gis.html"><span class="header-section-number">28</span> GIS の基本</a></li>
<li class="book-part">データの可視化</li>
<li><a class="" href="tables-presentation.html"><span class="header-section-number">29</span> 見やすい表の作り方</a></li>
<li><a class="" href="ggplot-basics.html"><span class="header-section-number">30</span> ggplot の基本</a></li>
<li><a class="" href="ggplot-tips.html"><span class="header-section-number">31</span> ggplotのヒント</a></li>
<li><a class="" href="epicurves.html"><span class="header-section-number">32</span> 流行曲線（エピカーブ）</a></li>
<li><a class="" href="age-pyramid.html"><span class="header-section-number">33</span> 人口ピラミッドとリッカート尺度</a></li>
<li><a class="active" href="heatmaps.html"><span class="header-section-number">34</span> ヒートマップ</a></li>
<li><a class="" href="diagrams.html"><span class="header-section-number">35</span> フローチャート・サンキー図・タイムライン</a></li>
<li><a class="" href="combination-analysis.html"><span class="header-section-number">36</span> 複数回答データの分析</a></li>
<li><a class="" href="transmission-chains.html"><span class="header-section-number">37</span> 感染連鎖</a></li>
<li><a class="" href="phylogenetic-trees.html"><span class="header-section-number">38</span> 系統樹</a></li>
<li><a class="" href="interactive-plots.html"><span class="header-section-number">39</span> 動的な図の作成</a></li>
<li class="book-part">レポートとダッシュボード</li>
<li><a class="" href="rmarkdown.html"><span class="header-section-number">40</span> R Markdown で作るレポート</a></li>
<li><a class="" href="reportfactory.html"><span class="header-section-number">41</span> ルーチンで作成するレポートの整理</a></li>
<li><a class="" href="flexdashboard.html"><span class="header-section-number">42</span> R Markdownで作るダッシュボード</a></li>
<li><a class="" href="shiny-basics.html"><span class="header-section-number">43</span> Shiny で作るダッシュボード</a></li>
<li class="book-part">その他</li>
<li><a class="" href="writing-functions.html"><span class="header-section-number">44</span> 関数の作成</a></li>
<li><a class="" href="directories.html"><span class="header-section-number">45</span> ディレクトリの操作</a></li>
<li><a class="" href="collaboration.html"><span class="header-section-number">46</span> Git と Github を使ったバージョン管理と共同作業</a></li>
<li><a class="" href="errors.html"><span class="header-section-number">47</span> よくあるエラー</a></li>
<li><a class="" href="help.html"><span class="header-section-number">48</span> ヘルプ</a></li>
<li><a class="" href="network-drives.html"><span class="header-section-number">49</span> ネットワークドライブで R を使用する場合</a></li>
<li><a class="" href="data-table.html"><span class="header-section-number">50</span> data.table パッケージを使用したデータ処理</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="heatmaps" class="section level1" number="34">
<h1>
<span class="header-section-number">34</span> ヒートマップ<a class="anchor" aria-label="anchor" href="#heatmaps"><i class="fas fa-link"></i></a>
</h1>
<p>「ヒートプロット」や「ヒートタイル」とも呼ばれるヒートマップは、3 つの変数（x 軸、y 軸、色）を表示しようとする際に便利なデータ可視化の手法です。本章では、2 つの例を紹介します。</p>
<ul>
<li>年齢別の感染イベント（「誰から誰への感染か」）の可視化<br>
</li>
<li>施設ごとの報告率を時系列で追跡して可視化</li>
</ul>
<p><img src="images/transmission_matrix.png" width="50%"><img src="images/heat_tile.png" width="50%"></p>
<!-- ======================================================= -->
<div id="準備-26" class="section level2" number="34.1">
<h2>
<span class="header-section-number">34.1</span> 準備<a class="anchor" aria-label="anchor" href="#%E6%BA%96%E5%82%99-26"><i class="fas fa-link"></i></a>
</h2>
<div id="パッケージの読み込み-18" class="section level3 unnumbered">
<h3>パッケージの読み込み<a class="anchor" aria-label="anchor" href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF-18"><i class="fas fa-link"></i></a>
</h3>
<p>以下のコードを実行すると、解析に必要なパッケージが読み込まれます。このハンドブックでは、パッケージを読み込むために、<strong>pacman</strong> パッケージの p_load() を主に使用しています。p_load() は、必要に応じてパッケージをインストールし、現在の R セッションで使用するためにパッケージを読み込む関数です。また、すでにインストールされたパッケージは、R の基本パッケージである <strong>base</strong> の library() を使用して読み込むこともできます。R のパッケージについては、<a href="basics.html#basics">R の基礎</a> の章を参照してください。</p>
<div class="sourceCode" id="cb1624"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">tidyverse</span>,       <span class="co"># データ操作と可視化</span></span>
<span>  <span class="va">rio</span>,             <span class="co"># データのインポート</span></span>
<span>  <span class="va">lubridate</span>        <span class="co"># 日付処理</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><strong>データセット</strong></p>
<p>感染伝播マトリックスのセクションでは、流行をシュミレートした症例ラインリストを使用し、報告率の時系列のセクションでは、日別のマラリア患者数のデータセットを使用しています。これらのデータの読み込みとクリーニングは、それぞれのセクションで行います。</p>
</div>
</div>
<div id="感染伝播マトリックス" class="section level2" number="34.2">
<h2>
<span class="header-section-number">34.2</span> 感染伝播マトリックス<a class="anchor" aria-label="anchor" href="#%E6%84%9F%E6%9F%93%E4%BC%9D%E6%92%AD%E3%83%9E%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%82%B9"><i class="fas fa-link"></i></a>
</h2>
<p>ヒートマップは、マトリックスを視覚化するのに便利です。マトリックス視覚化の一つの例として、アウトブレイクにおける「誰から誰に感染がうつったか」を図示することができます。これは、感染イベントに関するデータがあることが前提となっています。</p>
<p>なお、<a href="contact-tracing.html#contact-tracing">接触者の追跡</a> の章には、別の（より単純な）データセットを用いて、ヒートマップによる接触マトリックスを作成する例が掲載されています。また、<a href="ggplot-basics.html#ggplot-basics">ggplot の基礎</a> の章では、この単純なデータを使用した密度マップの作成について説明しています。本章で扱う例は、症例のラインリストから始まるので、プロット可能なデータフレームになる前にかなりのデータ操作が必要ですが、その結果として多くのシナリオから選ぶことが可能になっています。</p>
<p>まずは、エボラ出血熱の流行をシミュレーションした症例ラインリストを使います。<a href="https://github.com/appliedepi/epirhandbook_eng/raw/master/data/case_linelists/linelist_cleaned.rds">こちら</a> から「前処理済みの」ラインリスト（.rdsファイル）をダウンロードすることができ、<strong>rio</strong> パッケージの <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> を使用してデータをインポートすることができます（.xlsx、.rds、.csv など多様なファイル形式のインポートに対応しています。詳しくは、<a href="importing.html#importing">データのインポート・エクスポート</a> の章を参照してください）。</p>
<p>ラインリストの最初の 50 行を以下に表示します。</p>
<div class="sourceCode" id="cb1625"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"linelist_cleaned.rds"</span><span class="op">)</span></span></code></pre></div>
<p>このラインリストでは、</p>
<ul>
<li>1 症例ごとに 1 行となっており、それぞれの症例に <code>case_id</code> が振られています。</li>
<li>
<code>infector</code> 列には、感染者の <code>case_id</code> が含まれており、その感染者も症例としてラインリストに含まれています。</li>
</ul>
<div id="htmlwidget-42cedfd959c490ee7165" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-42cedfd959c490ee7165">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],[4,4,2,3,3,3,4,4,4,4,4,4,6,5,6,9,10,8,7,6,7,6,8,6,10,8,6,12,5,8,7,9,11,5,8,5,6,11,7,9,7,8,9,12,13,9,8,10,8,7],["2014-05-08",null,null,"2014-05-04","2014-05-18","2014-05-03","2014-05-22","2014-05-28",null,null,"2014-05-30","2014-05-28","2014-06-14","2014-06-07","2014-06-09",null,null,null,"2014-06-23","2014-06-18","2014-06-24",null,null,"2014-07-03",null,"2014-07-10","2014-06-14",null,"2014-06-18","2014-06-29","2014-07-02","2014-07-12","2014-07-12","2014-06-13","2014-07-15","2014-06-20",null,null,"2014-07-20",null,"2014-07-12","2014-07-19","2014-07-18","2014-07-18","2014-07-27",null,"2014-07-19","2014-07-26","2014-07-24",null],["2014-05-13","2014-05-13","2014-05-16","2014-05-18","2014-05-21","2014-05-22","2014-05-27","2014-06-02","2014-06-05","2014-06-05","2014-06-06","2014-06-13","2014-06-16","2014-06-17","2014-06-18","2014-06-19","2014-06-22","2014-06-23","2014-06-25","2014-06-26","2014-06-28","2014-07-02","2014-07-08","2014-07-09","2014-07-09","2014-07-10","2014-07-12","2014-07-12","2014-07-13","2014-07-13","2014-07-14","2014-07-15","2014-07-16","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-22","2014-07-22","2014-07-24","2014-07-24","2014-07-25","2014-07-25","2014-07-27","2014-07-29","2014-07-30",null,"2014-08-01","2014-08-02","2014-08-03"],["2014-05-15","2014-05-14","2014-05-18","2014-05-20","2014-05-22","2014-05-23","2014-05-29","2014-06-03","2014-06-06","2014-06-07","2014-06-08","2014-06-15","2014-06-17","2014-06-17","2014-06-20","2014-06-19","2014-06-23","2014-06-24","2014-06-27","2014-06-28","2014-06-29","2014-07-03","2014-07-09","2014-07-09","2014-07-11","2014-07-11","2014-07-13","2014-07-14","2014-07-14","2014-07-13","2014-07-14","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-20","2014-07-20","2014-07-22","2014-07-24","2014-07-26","2014-07-24","2014-07-27","2014-07-25","2014-07-27","2014-07-31","2014-08-01","2014-08-03","2014-08-02","2014-08-02","2014-08-04"],[null,"2014-05-18","2014-05-30",null,"2014-05-29","2014-05-24","2014-06-01","2014-06-07","2014-06-18","2014-06-09","2014-06-15",null,"2014-07-09",null,"2014-06-30","2014-07-11","2014-07-01","2014-06-25","2014-07-06","2014-07-02","2014-07-09","2014-07-07","2014-07-20",null,"2014-07-22","2014-07-16","2014-07-14","2014-07-20","2014-07-16","2014-07-19","2014-07-27","2014-07-19",null,"2014-07-26","2014-08-14","2014-08-01","2014-07-23","2014-08-28","2014-07-28","2014-07-19",null,"2014-08-03",null,null,null,"2014-08-06","2014-08-21","2014-09-13","2014-08-04",null],[null,"Recover","Recover",null,"Recover","Recover","Recover","Death","Recover","Death","Death","Death","Recover","Recover",null,"Recover",null,null,"Death","Death","Recover",null,null,null,"Death",null,"Death","Death",null,"Death","Recover","Death","Recover","Death","Recover",null,"Death","Recover","Recover","Death",null,null,"Death","Death","Death","Death","Recover",null,"Death","Death"],["m","f","m","f","m","f","f","f","m","f","m","m","m","f","f","m","f","f","f","f","m","m","f","m","f","m","m","f","m","f","f","f","m","m","f","m","f","f","f","m","f","m","f","m","m","f","m","f","m","m"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["0-4","0-4","50-69","15-19","0-4","15-19","15-19","0-4","50-69","20-29","10-14","30-49","15-19","5-9","5-9","10-14","30-49","15-19","10-14","10-14","15-19","50-69","10-14","20-29","5-9","0-4","30-49","5-9","50-69","10-14","10-14","20-29","20-29","30-49","0-4","10-14","0-4","15-19","20-29","30-49","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-29","20-29","10-14"],["0-4","0-4","55-59","15-19","0-4","15-19","15-19","0-4","60-64","25-29","10-14","40-44","15-19","5-9","5-9","10-14","35-39","15-19","10-14","10-14","15-19","50-54","10-14","25-29","5-9","0-4","30-34","5-9","65-69","10-14","10-14","20-24","20-24","45-49","0-4","10-14","0-4","15-19","20-24","35-39","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-24","25-29","10-14"],["Other","Missing","St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Port Hospital","Missing","Missing","Missing","Missing","Port Hospital","Military Hospital","Missing","Missing","Other","Port Hospital","Port Hospital","Port Hospital","Missing","Other","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)","Missing","Other","Missing","St. Mark's Maternity Hospital (SMMH)","Military Hospital","Port Hospital","Central Hospital","Military Hospital","Central Hospital","Missing","Military Hospital","Other","Missing","Missing","Port Hospital","Port Hospital","Port Hospital","Missing","Central Hospital","Military Hospital","Other","Other","Other","Missing","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","Missing"],[-13.2157351064963,-13.2152339775486,-13.212910703914,-13.2363711169728,-13.2228638912441,-13.222625321098,-13.2331547837254,-13.2320975453153,-13.2225511595637,-13.2572163655863,-13.2206286746001,-13.253989309478,-13.2385127873491,-13.209391925612,-13.2157278814899,-13.2243437095992,-13.2336087079551,-13.21422143145,-13.2339681355349,-13.2535640411465,-13.2250089377786,-13.2160657166043,-13.2680671272333,-13.2266742923612,-13.2160179088168,-13.2482584611565,-13.2156319199566,-13.2142410663192,-13.2614879104088,-13.2452992638476,-13.2630592726116,-13.2343341712241,-13.2199077448676,-13.2227293309912,-13.2343062806506,-13.218781651651,-13.2483677722899,-13.2097478342339,-13.2680867723786,-13.2587535457526,-13.262635786914,-13.2697246824573,-13.2209026809759,-13.2330734719715,-13.2680923666905,-13.2547212675054,-13.2573683214693,-13.2137356012883,-13.2175973322257,-13.2486407324245],[8.46897295100924,8.45171855856465,8.46481700596819,8.4754761613651,8.46082377490923,8.46183062600728,8.46272931462646,8.46144367534271,8.46191259217774,8.47292327643506,8.48401630165138,8.45837125340844,8.47761705512509,8.47570184950483,8.47779946878972,8.47145134147474,8.47804840685363,8.48528034195779,8.46957530395867,8.45957352078114,8.47404889511544,8.48802917129884,8.473437335922,8.48408263734462,8.46242233645879,8.47026822126572,8.46398447480533,8.4641347894342,8.45623094629607,8.48334624336805,8.47493999153642,8.47832062438022,8.4693933891765,8.48480589906514,8.47121232619015,8.48438437371817,8.48466158574339,8.47714159984428,8.46238127010609,8.45568597813113,8.4632880274758,8.47940722413856,8.46353857052336,8.46178968158864,8.47508713872833,8.45825808128071,8.4532568143863,8.4732571907655,8.47911586641933,8.48480340615605],["f547d6",null,null,"f90f5f","11f8ea","aec8ec","893f25","133ee7",null,null,"996f3a","133ee7","37a6f6","9f6884","4802b1",null,null,null,"a75c7f","8e104d","ab634e",null,null,"b799eb",null,"5d9e4d","a15e13",null,"ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277",null,null,"d6584f",null,"312ecf","52ea64","cfd79c","d145b7","174288",null,"53608c","3b096b","f5c142",null],["other",null,null,"other","other","other","other","other",null,null,"other","other","other","other","other",null,null,null,"other","other","other",null,null,"other",null,"other","other",null,"other","funeral","other","funeral","other","other","other","funeral",null,null,"other",null,"other","other","other","other","other",null,"funeral","other","other",null],[27,25,91,41,36,56,47,0,86,69,67,84,68,44,34,66,78,47,53,47,71,86,53,69,38,46,68,37,100,56,50,57,65,72,29,69,37,48,54,71,47,61,47,35,53,16,13,59,69,67],[48,59,238,135,71,116,87,11,226,174,112,186,174,90,91,152,214,137,117,131,150,241,131,161,80,69,188,66,233,142,110,182,164,214,26,157,39,154,133,168,100,125,123,67,134,31,36,125,183,169],[22,22,21,23,23,21,21,22,22,22,22,22,22,21,23,22,23,21,22,23,21,23,21,24,23,22,24,23,20,24,24,20,24,21,22,21,23,22,23,23,23,22,23,22,22,22,23,22,22,22],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","no","no","no","no","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","yes","no",null,"no","no","no","yes","no",null,"no","no","yes",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","yes","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","yes","yes","yes","yes","yes","yes","yes","yes","yes",null,"yes","yes","yes","yes","yes",null,"yes","yes","yes",null,null,"yes","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","yes","yes","yes","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","yes","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"yes","yes",null,"no","no",null,"no","no","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","no","yes","no","no","no","yes","no","no","no",null,"no","yes","no","no","no",null,"no","no","no",null,null,"no","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","no","yes","yes","yes",null],[36.8,36.9,36.9,36.8,36.9,37.6,37.3,37,36.4,35.9,36.5,36.9,36.5,37.1,36.5,37.3,37,38,38,36,37,36.7,36.9,36.5,37,36.5,37.6,36.6,36.6,36.2,36.4,37.1,37.5,37.5,37.4,36.9,36.4,37.3,37,37.8,36.5,37.5,36.7,37,37.3,36.6,36.5,36.6,37.6,36.8],[null,"09:36","16:48","11:22","12:60","14:13","14:33","09:25","11:16","10:55","16:03","11:14","12:42","11:06","09:10","08:45",null,"15:41","13:34","18:58","12:43","16:33","14:29","07:18","08:11","16:32","16:17","07:32","17:45",null,"13:24","14:43","02:33","11:36","17:28","16:27",null,"20:49",null,"11:38","14:25","13:42","21:22","13:33","19:06","17:14","20:09",null,"10:23","09:09"],[117.1875,71.8184429761563,16.0652496292635,22.4965706447188,71.4144019043841,41.6171224732461,62.0953890870657,0,16.8376536925366,22.7903289734443,53.4119897959184,24.2802636142907,22.4600343506408,54.320987654321,41.0578432556455,28.5664819944598,17.0320552013276,25.0412914912888,38.7172182043977,27.3876813705495,31.5555555555556,14.8069075945662,30.8839811199813,26.6193433895297,59.375,96.6183574879227,19.2394748755093,84.9403122130395,18.4199377406104,27.7722674072605,41.3223140495868,17.2080666586161,24.1671624033314,15.7218971089178,428.994082840237,27.9930220292912,243.261012491782,20.2395007589813,30.527446435638,25.15589569161,47,39.04,31.0661643201798,77.9683671196257,29.5165961238583,166.493236212279,100.308641975309,37.76,20.6037803457852,23.458562375267],[2,1,2,2,1,1,2,1,1,2,2,2,1,0,2,0,1,1,2,2,1,1,1,0,2,1,1,2,1,0,0,2,1,1,2,2,1,0,2,2,0,2,0,0,2,2,null,1,0,1]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>generation<\/th>\n      <th>date_infection<\/th>\n      <th>date_onset<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>date_outcome<\/th>\n      <th>outcome<\/th>\n      <th>gender<\/th>\n      <th>age<\/th>\n      <th>age_unit<\/th>\n      <th>age_years<\/th>\n      <th>age_cat<\/th>\n      <th>age_cat5<\/th>\n      <th>hospital<\/th>\n      <th>lon<\/th>\n      <th>lat<\/th>\n      <th>infector<\/th>\n      <th>source<\/th>\n      <th>wt_kg<\/th>\n      <th>ht_cm<\/th>\n      <th>ct_blood<\/th>\n      <th>fever<\/th>\n      <th>chills<\/th>\n      <th>cough<\/th>\n      <th>aches<\/th>\n      <th>vomit<\/th>\n      <th>temp<\/th>\n      <th>time_admission<\/th>\n      <th>bmi<\/th>\n      <th>days_onset_hosp<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,8,10,14,15,18,19,20,26,28,29]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><div id="データ準備-1" class="section level3 unnumbered">
<h3>データ準備<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E6%BA%96%E5%82%99-1"><i class="fas fa-link"></i></a>
</h3>
<p><strong>目的：</strong>感染者と接触者を年代別にグループ分けし、感染者と接触者の年代別のグループを組み合わせた感染ペアを行として、その各感染ペアが全体に占める割合を数字型の列とする縦型のデータフレームを作成する必要があります。</p>
<p>これを実現するには、いくつかのデータ操作を行う必要があります。</p>
<div id="感染先のデータフレームの作成" class="section level4 unnumbered">
<h4>感染先のデータフレームの作成<a class="anchor" aria-label="anchor" href="#%E6%84%9F%E6%9F%93%E5%85%88%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fas fa-link"></i></a>
</h4>
<p>まず症例 ID、年代、感染源の ID を含むデータフレームを作成し、<code>case_ages</code> という変数名をつけます。最初の 50 行は以下のように表示されます。</p>
<div class="sourceCode" id="cb1626"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">case_ages</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">case_id</span>, <span class="va">infector</span>, <span class="va">age_cat</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"case_age_cat"</span> <span class="op">=</span> <span class="st">"age_cat"</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-f22f3a788d5bfc1d60af" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f22f3a788d5bfc1d60af">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],["f547d6",null,null,"f90f5f","11f8ea","aec8ec","893f25","133ee7",null,null,"996f3a","133ee7","37a6f6","9f6884","4802b1",null,null,null,"a75c7f","8e104d","ab634e",null,null,"b799eb",null,"5d9e4d","a15e13",null,"ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277",null,null,"d6584f",null,"312ecf","52ea64","cfd79c","d145b7","174288",null,"53608c","3b096b","f5c142",null],["0-4","0-4","50-69","15-19","0-4","15-19","15-19","0-4","50-69","20-29","10-14","30-49","15-19","5-9","5-9","10-14","30-49","15-19","10-14","10-14","15-19","50-69","10-14","20-29","5-9","0-4","30-49","5-9","50-69","10-14","10-14","20-29","20-29","30-49","0-4","10-14","0-4","15-19","20-29","30-49","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-29","20-29","10-14"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>infector<\/th>\n      <th>case_age_cat<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="感染源のデータフレームの作成" class="section level4 unnumbered">
<h4>感染源のデータフレームの作成<a class="anchor" aria-label="anchor" href="#%E6%84%9F%E6%9F%93%E6%BA%90%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fas fa-link"></i></a>
</h4>
<p>次に、感染源のデータフレームを作成します。まず、感染源 ID のみの 1 列から構成されているデータフレームを作成し、欠損値を削除します（全ての症例の感染源が判明している訳ではない）。最初の 50 行は以下のように表示されます。</p>
<div class="sourceCode" id="cb1627"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">infectors</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">infector</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">infector</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-7a17c924ac550b849dcd" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7a17c924ac550b849dcd">{"x":{"filter":"none","vertical":false,"data":[["f547d6","f90f5f","11f8ea","aec8ec","893f25","133ee7","996f3a","133ee7","37a6f6","9f6884","4802b1","a75c7f","8e104d","ab634e","b799eb","5d9e4d","a15e13","ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277","d6584f","312ecf","52ea64","cfd79c","d145b7","174288","53608c","3b096b","f5c142","d05405","700448","a2e5cc","7fd086","4e08f2","3789ee","c2595d","b7641e","ce4ec6","09f7ab","4b501e","006775","1f8797","2b36fa","068c6a","535760"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>infector<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>次に、感染源の年代を取得します。ラインリストには、感染源の症例の年代が直接は記載されていないため、簡単には取得できず、ラインリストと感染源 ID を結合する必要があります。感染源のデータフレームから始めて、左側に「ベースライン」のデータフレームの <code>infector</code> 列（感染者 ID 列）を書き、右側にラインリストの <code>case_id</code> 列を書いて両者を紐づけ、ラインリストを感染源のデータフレームに <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code> （左結合）します。</p>
<p>結合すると、ラインリスト内の感染源の症例のデータ（年代）が、感染源の行に追加されました。最初の 50 行を以下に表示します。</p>
<div class="sourceCode" id="cb1628"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">infector_ages</span> <span class="op">&lt;-</span> <span class="va">infectors</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>             <span class="co"># 感染源のデータフレームから始める</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>                               <span class="co"># それぞれの感染源の行にラインリストデータを追加する</span></span>
<span>    <span class="va">linelist</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"infector"</span> <span class="op">=</span> <span class="st">"case_id"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>    <span class="co"># infector列とcase id 列で紐付ける</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">infector</span>, <span class="va">age_cat</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>            <span class="co"># 必要な列のみを抽出する</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="st">"infector_age_cat"</span> <span class="op">=</span> <span class="st">"age_cat"</span><span class="op">)</span>   <span class="co"># 分かりやすいように列名を変更</span></span></code></pre></div>
<div id="htmlwidget-8f1ac9ee77672a6cc272" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-8f1ac9ee77672a6cc272">{"x":{"filter":"none","vertical":false,"data":[["f547d6","f90f5f","11f8ea","aec8ec","893f25","133ee7","996f3a","133ee7","37a6f6","9f6884","4802b1","a75c7f","8e104d","ab634e","b799eb","5d9e4d","a15e13","ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277","d6584f","312ecf","52ea64","cfd79c","d145b7","174288","53608c","3b096b","f5c142","d05405","700448","a2e5cc","7fd086","4e08f2","3789ee","c2595d","b7641e","ce4ec6","09f7ab","4b501e","006775","1f8797","2b36fa","068c6a","535760"],["15-19",null,"50-69",null,"0-4","20-29",null,"20-29",null,"15-19",null,null,"10-14",null,"10-14",null,null,null,null,"50-69",null,null,null,null,null,"5-9",null,"10-14","10-14","0-4","20-29",null,null,"20-29",null,"5-9",null,"10-14",null,"20-29","10-14","5-9","0-4",null,null,null,"5-9","15-19",null,null]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>infector<\/th>\n      <th>infector_age_cat<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>次に、感染先症例とその年代を、感染源症例とその年代に結合します。これらのデータフレームはそれぞれ <code>infector</code> という列を持っているので、この列で紐付けます。最初の行は以下のように表示されます。</p>
<div class="sourceCode" id="cb1629"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ages_complete</span> <span class="op">&lt;-</span> <span class="va">case_ages</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">infector_ages</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"infector"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>        <span class="co"># infector 列で紐付け</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span>                     <span class="co"># 欠損値のある行を削除</span></span></code></pre></div>
<div id="htmlwidget-8b53faf86961a3ac68be" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-8b53faf86961a3ac68be">{"x":{"filter":"none","vertical":false,"data":[["5fe599","5fe599","5fe599","893f25","893f25","893f25","893f25","893f25","07e3e8","369449","369449","57a565","57a565","2eaa9a","ddddee","bc2adf","bc2adf","8ebf6e","f5c142","062638","c76676","c76676","c76676","baacc1","497372","c71dcd","c71dcd","422831","2b36fa","2b36fa","2b36fa","4ade58","9f0c37","f97626","7d99f2","7d99f2","babc2d","d5f3c0","d5f3c0","8b4b24","bd5a25","564652","564652","890de4","890de4","890de4","890de4","cc71ea","cc71ea","3c0ca7"],["f547d6","f547d6","f547d6","11f8ea","11f8ea","11f8ea","11f8ea","11f8ea","893f25","133ee7","133ee7","133ee7","133ee7","9f6884","8e104d","b799eb","b799eb","567136","d6584f","52ea64","cfd79c","cfd79c","cfd79c","d145b7","174288","f5c142","f5c142","700448","7fd086","7fd086","7fd086","3789ee","c2595d","b7641e","ce4ec6","ce4ec6","1f8797","2b36fa","2b36fa","108b95","5b2dd9","92e129","92e129","9a9a84","9a9a84","9a9a84","9a9a84","68623f","68623f","088b66"],["0-4","0-4","0-4","0-4","0-4","0-4","0-4","0-4","15-19","0-4","0-4","30-49","30-49","5-9","10-14","20-29","20-29","10-14","20-29","10-14","10-14","10-14","10-14","0-4","10-14","20-29","20-29","10-14","15-19","15-19","15-19","30-49","10-14","5-9","5-9","5-9","20-29","5-9","5-9","15-19","20-29","15-19","15-19","30-49","30-49","30-49","30-49","30-49","30-49","5-9"],["15-19","15-19","15-19","50-69","50-69","50-69","50-69","50-69","0-4","20-29","20-29","20-29","20-29","15-19","10-14","10-14","10-14","50-69","5-9","10-14","10-14","10-14","10-14","0-4","20-29","20-29","20-29","5-9","10-14","10-14","10-14","20-29","10-14","5-9","0-4","0-4","5-9","15-19","15-19","15-19","30-49","10-14","10-14","70+","70+","70+","70+","30-49","30-49","30-49"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>infector<\/th>\n      <th>case_age_cat<\/th>\n      <th>infector_age_cat<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>以下は、感染先症例と感染源症例の年代階級別の症例数を単純にクロス集計したものです。分かりやすくするためにラベルをつけています。</p>
<div class="sourceCode" id="cb1630"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>cases <span class="op">=</span> <span class="va">ages_complete</span><span class="op">$</span><span class="va">case_age_cat</span>,</span>
<span>      infectors <span class="op">=</span> <span class="va">ages_complete</span><span class="op">$</span><span class="va">infector_age_cat</span><span class="op">)</span></span></code></pre></div>
<pre><code>##        infectors
## cases   0-4 5-9 10-14 15-19 20-29 30-49 50-69 70+
##   0-4   105 156   105   114   143   117    13   0
##   5-9   102 132   110   102   117    96    12   5
##   10-14 104 109    91    79   120    80    12   4
##   15-19  85 105    82    39    75    69     7   5
##   20-29 101 127   109    80   143   107    22   4
##   30-49  72  97    56    54    98    61     4   5
##   50-69   5   6    15     9     7     5     2   0
##   70+     1   0     2     0     0     0     0   0</code></pre>
<p>この表をデータフレームに変換するには、<strong>base</strong> R の <code><a href="https://rdrr.io/r/base/data.frame.html">data.frame()</a></code> を使います。これにより自動で縦型のデータフレームとなり、<code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> に適した形となります。最初の行は以下のようになります。</p>
<div class="sourceCode" id="cb1632"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">long_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span></span>
<span>    cases     <span class="op">=</span> <span class="va">ages_complete</span><span class="op">$</span><span class="va">case_age_cat</span>,</span>
<span>    infectors <span class="op">=</span> <span class="va">ages_complete</span><span class="op">$</span><span class="va">infector_age_cat</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-05d4c85b89e008bbfec8" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-05d4c85b89e008bbfec8">{"x":{"filter":"none","vertical":false,"data":[["0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9"],["0-4","0-4","0-4","0-4","0-4","0-4","0-4","0-4","5-9","5-9","5-9","5-9","5-9","5-9","5-9","5-9","10-14","10-14","10-14","10-14","10-14","10-14","10-14","10-14","15-19","15-19","15-19","15-19","15-19","15-19","15-19","15-19","20-29","20-29","20-29","20-29","20-29","20-29","20-29","20-29","30-49","30-49","30-49","30-49","30-49","30-49","30-49","30-49","50-69","50-69"],[105,102,104,85,101,72,5,1,156,132,109,105,127,97,6,0,105,110,91,82,109,56,15,2,114,102,79,39,80,54,9,0,143,117,120,75,143,98,7,0,117,96,80,69,107,61,5,0,13,12]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>cases<\/th>\n      <th>infectors<\/th>\n      <th>Freq<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>さらに、<strong>base</strong> R の <code><a href="https://rdrr.io/r/base/proportions.html">prop.table()</a></code> をテーブルに適用して、数の代わりに全体の割合を出します。最初の 50 行は以下のようになります。</p>
<div class="sourceCode" id="cb1633"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">long_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/proportions.html">prop.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span></span>
<span>    cases <span class="op">=</span> <span class="va">ages_complete</span><span class="op">$</span><span class="va">case_age_cat</span>,</span>
<span>    infectors <span class="op">=</span> <span class="va">ages_complete</span><span class="op">$</span><span class="va">infector_age_cat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-80d0284f07bdd16954e7" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-80d0284f07bdd16954e7">{"x":{"filter":"none","vertical":false,"data":[["0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9","10-14","15-19","20-29","30-49","50-69","70+","0-4","5-9"],["0-4","0-4","0-4","0-4","0-4","0-4","0-4","0-4","5-9","5-9","5-9","5-9","5-9","5-9","5-9","5-9","10-14","10-14","10-14","10-14","10-14","10-14","10-14","10-14","15-19","15-19","15-19","15-19","15-19","15-19","15-19","15-19","20-29","20-29","20-29","20-29","20-29","20-29","20-29","20-29","30-49","30-49","30-49","30-49","30-49","30-49","30-49","30-49","50-69","50-69"],[0.0284784377542718,0.0276647681041497,0.0282072145375644,0.0230539734201248,0.0273935448874424,0.0195280716029292,0.00135611608353675,0.00027122321670735,0.0423108218063466,0.0358014646053702,0.0295633306211012,0.0284784377542718,0.0344453485218335,0.026308652020613,0.0016273393002441,0,0.0284784377542718,0.0298345538378085,0.0246813127203689,0.0222403037700027,0.0295633306211012,0.0151885001356116,0.00406834825061025,0.0005424464334147,0.0309194467046379,0.0276647681041497,0.0214266341198807,0.0105777054515867,0.021697857336588,0.0146460537021969,0.00244100895036615,0,0.0387849199891511,0.03173311635476,0.032546786004882,0.0203417412530513,0.0387849199891511,0.0265798752373203,0.00189856251695145,0,0.03173311635476,0.0260374288039056,0.021697857336588,0.0187144019528072,0.0290208841876865,0.0165446162191484,0.00135611608353675,0,0.00352590181719555,0.0032546786004882]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>cases<\/th>\n      <th>infectors<\/th>\n      <th>Freq<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="ヒートマップの作成" class="section level3 unnumbered">
<h3>ヒートマップの作成<a class="anchor" aria-label="anchor" href="#%E3%83%92%E3%83%BC%E3%83%88%E3%83%9E%E3%83%83%E3%83%97%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fas fa-link"></i></a>
</h3>
<p>さて、いよいよ <strong>ggplot2</strong> パッケージで <code><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile()</a></code> 関数を用いてヒートマップを作成します。色・塗りつぶしのスケール、特に <code><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient()</a></code> 関数についてより広範囲に学びたい方は、<a href="ggplot-basics.html#ggplot-basics">ggplot の基礎</a> の章を参照してください。</p>
<ul>
<li><p><code><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile()</a></code> の <code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code> で、x に case age、y に infector age を指定します。<br></p></li>
<li><p>また、<code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code> では、引数 <code>fill =</code> を <code>Freq</code> 列に指定します。これはタイルの色に変換される値です。<br></p></li>
<li>
<p><code><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient()</a></code> でスケールカラーを設定します。高い値の色と、低い値の色を何色にするのかそれぞれ指定することができます。</p>
<ul>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_color_gradient()</a></code> とは異なることに注意してください！今回は塗りつぶしが必要です。</li>
</ul>
</li>
<li><p>色は 「fill」を介して作られるので、 <code><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs()</a></code> の <code>fill =</code> 引数を使って、凡例のタイトルを変更することができます。</p></li>
</ul>
<div class="sourceCode" id="cb1634"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">long_prop</span><span class="op">)</span><span class="op">+</span>       <span class="co"># 割合が Freq 列に格納された縦型データを使用</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span><span class="op">(</span>                    <span class="co"># タイルで可視化</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">cases</span>,         <span class="co"># x軸は感染先の年代</span></span>
<span>      y <span class="op">=</span> <span class="va">infectors</span>,     <span class="co"># y軸は感染源の年代</span></span>
<span>      fill <span class="op">=</span> <span class="va">Freq</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>            <span class="co"># タイルの色分けを Freq 列で決定する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>          <span class="co"># タイルの色を調整する</span></span>
<span>    low <span class="op">=</span> <span class="st">"blue"</span>,</span>
<span>    high <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>                         <span class="co"># ラベル</span></span>
<span>    x <span class="op">=</span> <span class="st">"Case age"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Infector age"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Who infected whom"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Frequency matrix of transmission events"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Proportion of all\ntranmsission events"</span>     <span class="co"># 凡例タイトル</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1242-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
<div id="報告率の時系列" class="section level2" number="34.3">
<h2>
<span class="header-section-number">34.3</span> 報告率の時系列<a class="anchor" aria-label="anchor" href="#%E5%A0%B1%E5%91%8A%E7%8E%87%E3%81%AE%E6%99%82%E7%B3%BB%E5%88%97"><i class="fas fa-link"></i></a>
</h2>
<p>公衆衛生では、施設や管轄区域などにおける経時的な傾向を評価することが目的の一つであることがよくあります。このような経時的な傾向を可視化する方法の一つが、横軸を時間、縦軸を各施設としたヒートマップです。</p>
<div id="データ準備-2" class="section level3 unnumbered">
<h3>データ準備<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E6%BA%96%E5%82%99-2"><i class="fas fa-link"></i></a>
</h3>
<p>まず、各施設におけるマラリアに関する日々の報告のデータセットをインポートします。データには、日付、州、地区、マラリアの症例数が含まれています。これらのデータをダウンロードする方法については、<a href="data-used.html#data-used">ハンドブックとデータのダウンロード</a> の章を参照してください。以下は、データセットの最初の 30 行です。</p>
<div class="sourceCode" id="cb1635"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">facility_count_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"malaria_facility_count_data.rds"</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-fa63a7e801cdfd562dd2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-fa63a7e801cdfd562dd2">{"x":{"filter":"none","vertical":false,"data":[["Facility 1","Facility 2","Facility 3","Facility 4","Facility 5","Facility 6","Facility 6","Facility 5","Facility 5","Facility 5","Facility 7","Facility 8","Facility 9","Facility 10","Facility 11","Facility 12","Facility 13","Facility 14","Facility 15","Facility 16","Facility 17","Facility 18","Facility 19","Facility 19","Facility 20","Facility 21","Facility 19","Facility 22","Facility 23","Facility 23"],["2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-10","2020-08-10","2020-08-09","2020-08-08","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-11","2020-08-10","2020-08-11","2020-08-11","2020-08-09","2020-08-11","2020-08-11","2020-08-12"],["Spring","Bolo","Dingo","Bolo","Bolo","Dingo","Dingo","Bolo","Bolo","Bolo","Spring","Bolo","Spring","Bolo","Spring","Dingo","Bolo","Dingo","Barnard","Barnard","Barnard","Bolo","Bolo","Bolo","Barnard","Bolo","Bolo","Bolo","Dingo","Dingo"],[46,26,18,49,17,8,7,42,35,49,32,28,53,34,60,134,0,16,11,34,9,13,32,52,37,51,32,28,31,31]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>location_name<\/th>\n      <th>data_date<\/th>\n      <th>District<\/th>\n      <th>malaria_tot<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":3}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><div id="集計とサマリー" class="section level4 unnumbered">
<h4>集計とサマリー<a class="anchor" aria-label="anchor" href="#%E9%9B%86%E8%A8%88%E3%81%A8%E3%82%B5%E3%83%9E%E3%83%AA%E3%83%BC"><i class="fas fa-link"></i></a>
</h4>
<p><strong>このセクションの目的</strong>は、日別の施設ごとのマラリア患者数（前のタブで表示されています）を、週単位の施設ごとの報告率（この場合は、施設が何らかのデータを報告した日数の割合）に変換することです。以下の例では、<strong>Spring 地区</strong>のデータのみを表示します。</p>
<p>以下のステップを実行します。</p>
<ol style="list-style-type: decimal">
<li><p>データを適切にフィルタリング（場所、日付ごと）します。</p></li>
<li>
<p><strong>lubridate</strong> パッケージの <code>floor_date()</code> を使って week 列を作成します。</p>
<ul>
<li>この関数は、指定した日付の週の開始日を、指定した曜日（例：“Mondays”）で返します。</li>
</ul>
</li>
<li><p>データは「場所」と「週」の列でグループ化され、「施設 - 週」の分析単位が作成されます。<br></p></li>
<li>
<p><code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> 関数を使って、「施設 - 週」グループごとの統計サマリーを反映する新しい列を作成します。</p>
<ul>
<li>1 週間の日数 (固定値7)<br>
</li>
<li>施設 - 週からの報告回数（7 件以上の可能性もあります！）<br>
</li>
<li>施設 - 週で報告されたマラリア患者数の合計（興味がある場合）<br>
</li>
<li>データが報告された施設 - 週における日数<br>
</li>
<li><strong>施設 - 週の7日間のうち、データが報告された日数の割合</strong></li>
</ul>
</li>
<li><p>このデータフレームを <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join()</a></code> （右結合）で、全ての「施設 - 週」の組み合わせを包括的なリストとして結合し、データセットを完成させます。全ての組み合わせの行列は、データフレーム（. で表されます）の 2 列に対して <code><a href="https://tidyr.tidyverse.org/reference/expand.html">expand()</a></code> 関数を適用することで作成されます。<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join()</a></code> が使用されているので、<code><a href="https://tidyr.tidyverse.org/reference/expand.html">expand()</a></code> されたデータフレームのすべての行は保持され、必要であれば <code>agg_weeks</code> に追加されます。これらの新しい行は、<code>NA</code>（欠損値）の要約された値で表示されます。</p></li>
</ol>
<p>以下に順を追って説明します。</p>
<div class="sourceCode" id="cb1636"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 週別の集計を作成する</span></span>
<span><span class="va">agg_weeks</span> <span class="op">&lt;-</span> <span class="va">facility_count_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>  <span class="co"># データのフィルタリング</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">District</span> <span class="op">==</span> <span class="st">"Spring"</span>,</span>
<span>    <span class="va">data_date</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2020-08-01"</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<p>これでデータセットの行数が 3038 行から 608 行になりました。</p>
<p>次に、各行の週の開始日を示す <code>week</code> 列を作成します。これは、<strong>lubridate</strong> パッケージと <code>floor_date()</code> 関数を使って行います。この関数は「週」に設定され、週の始まりが月曜日（週の1日目、日曜日は 7 日目）になるように設定されています。</p>
<div class="sourceCode" id="cb1637"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">agg_weeks</span> <span class="op">&lt;-</span> <span class="va">agg_weeks</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># data_date 列から week 列を作成</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    week <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span>                     <span class="co"># week 列を新たに作成</span></span>
<span>      <span class="va">data_date</span>,                                      <span class="co"># 日付列</span></span>
<span>      unit <span class="op">=</span> <span class="st">"week"</span>,                                  <span class="co"># 週の開始を指定</span></span>
<span>      week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>                                <span class="co"># 月曜スタートに指定 </span></span></code></pre></div>
<p>新しい <code>week</code> 列は、データフレームの一番右に表示されます。</p>
<div id="htmlwidget-56e7bc4cf442f679cc3b" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-56e7bc4cf442f679cc3b">{"x":{"filter":"none","vertical":false,"data":[["Facility 9","Facility 9","Facility 9","Facility 9","Facility 9","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 51","Facility 51","Facility 51","Facility 56","Facility 7","Facility 7","Facility 7","Facility 11","Facility 35","Facility 35","Facility 28","Facility 28","Facility 28","Facility 28"],["2020-07-31","2020-07-30","2020-07-29","2020-07-28","2020-07-27","2020-07-31","2020-07-30","2020-07-29","2020-07-28","2020-07-27","2020-07-26","2020-07-25","2020-07-24","2020-07-23","2020-07-22","2020-07-21","2020-07-30","2020-07-29","2020-07-28","2020-06-25","2020-07-31","2020-07-30","2020-07-29","2020-07-31","2020-07-30","2020-07-29","2020-07-30","2020-07-29","2020-07-28","2020-07-27"],["Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring","Spring"],[13,14,74,75,91,80,39,44,44,43,28,41,61,40,33,66,32,32,32,200,0,0,21,21,43,179,1,35,31,45],["2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-20","2020-07-20","2020-07-20","2020-07-20","2020-07-20","2020-07-20","2020-07-27","2020-07-27","2020-07-27","2020-06-22","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27","2020-07-27"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>location_name<\/th>\n      <th>data_date<\/th>\n      <th>District<\/th>\n      <th>malaria_tot<\/th>\n      <th>week<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":3}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>ここで、データを「施設 - 週」にグループ分けし、「施設 - 週」ごとの統計データを作成するために集計を行います。詳細は、<a href="tables-descriptive.html#tables-descriptive">記述統計表の作り方</a> の章を参照してください。グループ化自体はデータフレームを変更しませんが、その後の要約統計の計算に影響します。</p>
<p>最初の 30 行を以下に示します。目的の要約統計量を反映するために、列が完全に変更されたことに注意してください。各行は、1 つの「施設 - 週」を反映しています。</p>
<div class="sourceCode" id="cb1638"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">agg_weeks</span> <span class="op">&lt;-</span> <span class="va">agg_weeks</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>   </span>
<span></span>
<span>  <span class="co"># 「施設 - 週」でグループ化</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">location_name</span>, <span class="va">week</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># グループ化されたデータに対して要約統計量の列を作成</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    n_days          <span class="op">=</span> <span class="fl">7</span>,                                          <span class="co"># 1週間の日数（7日）</span></span>
<span>    n_reports       <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,                                 <span class="co"># 「施設 - 週」 からの報告回数（7件以上の可能性あり）</span></span>
<span>    malaria_tot     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">malaria_tot</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,                <span class="co"># 「施設 - 週」 で報告されたマラリア患者数の合計</span></span>
<span>    n_days_reported <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">data_date</span><span class="op">)</span><span class="op">)</span>,                  <span class="co"># データが報告された「施設 - 週」における日数</span></span>
<span>    p_days_reported <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="op">(</span><span class="va">n_days_reported</span> <span class="op">/</span> <span class="va">n_days</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>      <span class="co"># 「施設 - 週」 の7日間のうち、データが報告された日数の割合</span></span></code></pre></div>
<div id="htmlwidget-c59714abf603e670dde3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-c59714abf603e670dde3">{"x":{"filter":"none","vertical":false,"data":[["Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28"],["2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-05-11","2020-05-18","2020-05-25","2020-06-01","2020-06-08","2020-06-15","2020-06-22","2020-06-29"],[7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],[2,7,7,7,7,7,7,4,2,8,6,2,3,1,5,2,7,6,5,7,6,5,2,7,7,7,7,7,9,7],[0,0,0,101,402,570,378,131,354,853,502,317,245,0,0,0,17,147,136,118,88,86,26,216,155,120,319,256,475,352],[2,7,7,7,7,7,7,4,2,7,6,2,3,1,5,2,5,6,5,7,6,5,2,7,7,7,7,7,7,7],[29,100,100,100,100,100,100,57,29,100,86,29,43,14,71,29,71,86,71,100,86,71,29,100,100,100,100,100,100,100]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>location_name<\/th>\n      <th>week<\/th>\n      <th>n_days<\/th>\n      <th>n_reports<\/th>\n      <th>malaria_tot<\/th>\n      <th>n_days_reported<\/th>\n      <th>p_days_reported<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>最後に、以下のコマンドを実行して、報告のなかった週も含めて、可能性のある全ての「施設 - 週」の組み合わせがデータ中に存在することを確認します。</p>
<p>確認するために、 <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join()</a></code> を使用して <code>week</code> 列と <code>location_name</code> の列の全ての組み合わせを含むようにデータセットを拡張します（データセットは「. 」で表されます）。詳細は、<a href="pivoting.html#pivoting">データの縦横変換</a> の章にある <code><a href="https://tidyr.tidyverse.org/reference/expand.html">expand()</a></code> 関数のドキュメントを参照してください。このコードを実行する前の段階ではデータセットには 107 行が含まれています。</p>
<div class="sourceCode" id="cb1639"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 可能な全ての施設-週の組み合わせを作成</span></span>
<span><span class="va">expanded_weeks</span> <span class="op">&lt;-</span> <span class="va">agg_weeks</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>         <span class="co"># week 列をfactor型に変換</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html">expand</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">week</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="co"># 可能な全ての施設-週の組み合わせを含むようにデータを拡張</span></span>
<span>                                             <span class="co"># 注意: 「.」は%&gt;%内のデータセットを意味します</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span><span class="op">)</span>               <span class="co"># week 列をDate型に変換</span></span></code></pre></div>
<p><code>expanded_weeks</code> は以下のようなデータになっています。</p>
<div id="htmlwidget-585869298b99552fafc9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-585869298b99552fafc9">{"x":{"filter":"none","vertical":false,"data":[["Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 1","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 11","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 27","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 28","Facility 32","Facility 32","Facility 32","Facility 32","Facility 32","Facility 32","Facility 32","Facility 32","Facility 32","Facility 32","Facility 32","Facility 32","Facility 35","Facility 35","Facility 35","Facility 35","Facility 35","Facility 35","Facility 35","Facility 35","Facility 35","Facility 35","Facility 35","Facility 35","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 39","Facility 50","Facility 50","Facility 50","Facility 50","Facility 50","Facility 50","Facility 50","Facility 50","Facility 50","Facility 50","Facility 50","Facility 50","Facility 51","Facility 51","Facility 51","Facility 51","Facility 51","Facility 51","Facility 51","Facility 51","Facility 51","Facility 51","Facility 51","Facility 51","Facility 56","Facility 56","Facility 56","Facility 56","Facility 56","Facility 56","Facility 56","Facility 56","Facility 56","Facility 56","Facility 56","Facility 56","Facility 58","Facility 58","Facility 58","Facility 58","Facility 58","Facility 58","Facility 58","Facility 58","Facility 58","Facility 58","Facility 58","Facility 58","Facility 59","Facility 59","Facility 59","Facility 59","Facility 59","Facility 59","Facility 59","Facility 59","Facility 59","Facility 59","Facility 59","Facility 59","Facility 65","Facility 65","Facility 65","Facility 65","Facility 65","Facility 65","Facility 65","Facility 65","Facility 65","Facility 65","Facility 65","Facility 65","Facility 7","Facility 7","Facility 7","Facility 7","Facility 7","Facility 7","Facility 7","Facility 7","Facility 7","Facility 7","Facility 7","Facility 7","Facility 9","Facility 9","Facility 9","Facility 9","Facility 9","Facility 9","Facility 9","Facility 9","Facility 9","Facility 9","Facility 9","Facility 9"],["2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-01","2020-05-11","2020-05-18","2020-05-25","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-01","2020-05-11","2020-05-18","2020-05-25","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-01","2020-05-11","2020-05-18","2020-05-25","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-01","2020-05-11","2020-05-18","2020-05-25","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-01","2020-05-11","2020-05-18","2020-05-25","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-01","2020-05-11","2020-05-18","2020-05-25","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-01","2020-05-11","2020-05-18","2020-05-25","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-01","2020-05-11","2020-05-18","2020-05-25","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-01","2020-05-11","2020-05-18","2020-05-25","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-01","2020-05-11","2020-05-18","2020-05-25","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-01","2020-05-11","2020-05-18","2020-05-25","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-01","2020-05-11","2020-05-18","2020-05-25","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-01","2020-05-11","2020-05-18","2020-05-25","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-01","2020-05-11","2020-05-18","2020-05-25","2020-06-08","2020-06-15","2020-06-22","2020-06-29","2020-07-06","2020-07-13","2020-07-20","2020-07-27","2020-06-01","2020-05-11","2020-05-18","2020-05-25"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>location_name<\/th>\n      <th>week<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>以下のコードを実行する前の段階では、<code>agg_weeks</code> は 107 行でした。</p>
<div class="sourceCode" id="cb1640"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 拡張された施設週間リストと right-join して、データの欠損を補填</span></span>
<span><span class="va">agg_weeks</span> <span class="op">&lt;-</span> <span class="va">agg_weeks</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>      </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span><span class="va">expanded_weeks</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                            <span class="co"># 可能な全ての施設-週の組み合わせが含まれるようにする</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>p_days_reported <span class="op">=</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span><span class="op">(</span><span class="va">p_days_reported</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>  <span class="co"># 欠損値を0に変換</span></span></code></pre></div>
<pre><code>## Joining, by = c("location_name", "week")</code></pre>
<p>コードを実行した後、<code>agg_weeks</code> は 180 行に変わっています。</p>
<!-- ======================================================= -->
</div>
</div>
<div id="ヒートマップの作成-1" class="section level3 unnumbered">
<h3>ヒートマップの作成<a class="anchor" aria-label="anchor" href="#%E3%83%92%E3%83%BC%E3%83%88%E3%83%9E%E3%83%83%E3%83%97%E3%81%AE%E4%BD%9C%E6%88%90-1"><i class="fas fa-link"></i></a>
</h3>
<p><strong>ggplot2</strong> パッケージの <code><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile()</a></code> を用いて ggplot グラフを作成します。</p>
<ul>
<li>x 軸の週は日付型（Date）に変換されているので、<code><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date()</a></code> が使用できます。<br>
</li>
<li>y 軸の <code>location_name</code> は全ての施設名を表示します。<br>
</li>
<li>塗りつぶしは <code>p_days_reported</code> に対して行われ、その「施設 - 週」の報告率を示します。<br>
</li>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient()</a></code> は数値の塗りつぶしに使用され、高い値の色（high）、低い値の色（low）、<code>NA</code> の色を指定します。<br>
</li>
<li>x 軸に <code><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date()</a></code> を使用し、2 週間ごとのラベルとその形式を指定します。<br>
</li>
<li>テーマやラベルを必要に応じて調整することができます。</li>
</ul>
<!-- ======================================================= -->
</div>
<div id="基本プロット" class="section level3 unnumbered">
<h3>基本プロット<a class="anchor" aria-label="anchor" href="#%E5%9F%BA%E6%9C%AC%E3%83%97%E3%83%AD%E3%83%83%E3%83%88"><i class="fas fa-link"></i></a>
</h3>
<p>基本的なヒートマップは、デフォルトの色やスケールなどを使用して、以下のように作成できます。上で説明したように、<code><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile()</a></code> の <code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code> 内では、x 軸、y 軸、および <code>fill =</code> の列を指定する必要があります。<code>fill</code> は色として表示される数値です。</p>
<div class="sourceCode" id="cb1642"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">agg_weeks</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>,</span>
<span>        y <span class="op">=</span> <span class="va">location_name</span>,</span>
<span>        fill <span class="op">=</span> <span class="va">p_days_reported</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1254-1.png" width="672"></div>
</div>
<div id="応用プロット" class="section level3 unnumbered">
<h3>応用プロット<a class="anchor" aria-label="anchor" href="#%E5%BF%9C%E7%94%A8%E3%83%97%E3%83%AD%E3%83%83%E3%83%88"><i class="fas fa-link"></i></a>
</h3>
<p>以下のように、<strong>ggplot2</strong> の関数を追加することで、このプロットをより美しくできます。詳細は、<a href="ggplot-basics.html#ggplot-basics">ggplot の基礎</a> の章を参照して下さい。</p>
<div class="sourceCode" id="cb1643"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">agg_weeks</span><span class="op">)</span><span class="op">+</span> </span>
<span>  </span>
<span>  <span class="co"># データをタイルで表示</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>,</span>
<span>        y <span class="op">=</span> <span class="va">location_name</span>,</span>
<span>        fill <span class="op">=</span> <span class="va">p_days_reported</span><span class="op">)</span>,      </span>
<span>    color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span><span class="op">+</span>                 <span class="co"># 罫線を白に指定</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span></span>
<span>    low <span class="op">=</span> <span class="st">"orange"</span>,</span>
<span>    high <span class="op">=</span> <span class="st">"darkgreen"</span>,</span>
<span>    na.value <span class="op">=</span> <span class="st">"grey80"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># 日付軸</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,             <span class="co"># 両端の余分なスペースを削除</span></span>
<span>    date_breaks <span class="op">=</span> <span class="st">"2 weeks"</span>,     <span class="co"># 2週間ごとの日付ラベルを指定</span></span>
<span>    date_labels <span class="op">=</span> <span class="st">"%d\n%b"</span><span class="op">)</span><span class="op">+</span>     <span class="co"># 月の上に日付を表示 (\n は改行を示す)</span></span>
<span>  </span>
<span>  <span class="co"># テーマ</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                                  <span class="co"># 背景を簡潔にする</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    legend.text  <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    legend.key.height <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>,<span class="st">"cm"</span><span class="op">)</span>,           <span class="co"># 凡例の高さの指定</span></span>
<span>    legend.key.width  <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.6</span>,<span class="st">"cm"</span><span class="op">)</span>,         <span class="co"># 凡例の幅の指定</span></span>
<span>    </span>
<span>    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span><span class="op">)</span>,              <span class="co"># 軸のテキストサイズの指定</span></span>
<span>    axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>vjust<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span>,            <span class="co"># 軸のテキストの場所の調整</span></span>
<span>    axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_line</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span>,               </span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,  <span class="co"># 軸のタイトルのサイズの指定と太字フォントの指定</span></span>
<span>    </span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0</span>,size<span class="op">=</span><span class="fl">14</span>,face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,  <span class="co"># タイトルを右揃えにして、サイズを大きく、太字にする</span></span>
<span>    plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0</span>, face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span>  <span class="co"># 脚注を右揃えにしてイタリック体にする</span></span>
<span>    <span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># 凡例</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Week"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Facility name"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Reporting\nperformance (%)"</span>,           <span class="co"># 凡例のタイトルを指定</span></span>
<span>       title <span class="op">=</span> <span class="st">"Percent of days per week that facility reported data"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"District health facilities, May-July 2020"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"7-day weeks beginning on Mondays."</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1255-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="y軸の順番の調整" class="section level3 unnumbered">
<h3>y軸の順番の調整<a class="anchor" aria-label="anchor" href="#y%E8%BB%B8%E3%81%AE%E9%A0%86%E7%95%AA%E3%81%AE%E8%AA%BF%E6%95%B4"><i class="fas fa-link"></i></a>
</h3>
<p>現在、各施設は下から上へ「アルファベット順」に並んでいます。y 軸の施設の順番を調整したい場合は、対象の列を因子型に変換して順番を指定してください。詳細は、<a href="factors.html#factors">因子（ファクタ）型データ</a> の章を参照して下さい。</p>
<p>施設数が多く、全てを書き出すのは大変なので、別の方法として、データフレームに施設を並べ、その結果得られる名前の列を因子レベルの順序とすることを試みます。以下では、<code>location_name</code> 列を因子に変換し、そのレベルの順序を、全期間における施設ごとの報告日の合計数に基づいて設定します。</p>
<p>そのために、まず施設ごとの総報告数を昇順に並べたデータフレームを作成します。このベクトルを使って、プロットにおける因子レベルの順序を決めることができます。</p>
<div class="sourceCode" id="cb1644"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">facility_order</span> <span class="op">&lt;-</span> <span class="va">agg_weeks</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">location_name</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>tot_reports <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n_days_reported</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">tot_reports</span><span class="op">)</span> <span class="co"># 昇順</span></span></code></pre></div>
<p>データフレームは以下のようになります。</p>
<div id="htmlwidget-9f5dfe9c95c6af5850c9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-9f5dfe9c95c6af5850c9">{"x":{"filter":"none","vertical":false,"data":[["Facility 56","Facility 65","Facility 11","Facility 39","Facility 59","Facility 27","Facility 51","Facility 32","Facility 7","Facility 1","Facility 9","Facility 35","Facility 50","Facility 58","Facility 28"],[1,6,20,33,35,42,42,43,44,48,50,52,53,55,77]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>location_name<\/th>\n      <th>tot_reports<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":1}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>ここで、上で扱ったデータフレームの列（<code>facility_order$location_name</code>）を使用して、データフレーム <code>agg_weeks</code> における <code>location_name</code> の因子レベルの順序を調整します。</p>
<div class="sourceCode" id="cb1645"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># パッケージの読み込み</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">forcats</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 因子を作成して、レベルを決める</span></span>
<span><span class="va">agg_weeks</span> <span class="op">&lt;-</span> <span class="va">agg_weeks</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>location_name <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_relevel.html">fct_relevel</a></span><span class="op">(</span></span>
<span>    <span class="va">location_name</span>, <span class="va">facility_order</span><span class="op">$</span><span class="va">location_name</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>そして、次は <code>location_name</code> が順序付きの因子となるように、データを再プロットします。</p>
<div class="sourceCode" id="cb1646"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">agg_weeks</span><span class="op">)</span><span class="op">+</span> </span>
<span>  </span>
<span>  <span class="co"># データをタイルで表示</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>,</span>
<span>        y <span class="op">=</span> <span class="va">location_name</span>,</span>
<span>        fill <span class="op">=</span> <span class="va">p_days_reported</span><span class="op">)</span>,      </span>
<span>    color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span><span class="op">+</span>                 <span class="co"># 罫線を白に指定</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span></span>
<span>    low <span class="op">=</span> <span class="st">"orange"</span>,</span>
<span>    high <span class="op">=</span> <span class="st">"darkgreen"</span>,</span>
<span>    na.value <span class="op">=</span> <span class="st">"grey80"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># 日付軸</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,             <span class="co"># 両端の余分なスペースを削除</span></span>
<span>    date_breaks <span class="op">=</span> <span class="st">"2 weeks"</span>,     <span class="co"># 2週間ごとの日付ラベルを指定</span></span>
<span>    date_labels <span class="op">=</span> <span class="st">"%d\n%b"</span><span class="op">)</span><span class="op">+</span>     <span class="co"># 月の上に日付を表示 (\n は改行を示す)</span></span>
<span>  </span>
<span>  <span class="co"># テーマ</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                                  <span class="co"># 背景を簡潔にする</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    legend.text  <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    legend.key.height <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>,<span class="st">"cm"</span><span class="op">)</span>,           <span class="co"># 凡例の高さの指定</span></span>
<span>    legend.key.width  <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.6</span>,<span class="st">"cm"</span><span class="op">)</span>,         <span class="co"># 凡例の幅の指定</span></span>
<span>    </span>
<span>    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span><span class="op">)</span>,              <span class="co"># 軸のテキストサイズの指定</span></span>
<span>    axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>vjust<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span>,            <span class="co"># 軸のテキストの場所の調整</span></span>
<span>    axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_line</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span>,               </span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,  <span class="co"># 軸のタイトルのサイズの指定と太字フォントの指定</span></span>
<span>    </span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0</span>,size<span class="op">=</span><span class="fl">14</span>,face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,  <span class="co"># タイトルを右揃えにして、サイズを大きく、太字にする</span></span>
<span>    plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0</span>, face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span>  <span class="co"># 脚注を右揃えにしてイタリック体にする</span></span>
<span>    <span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># 凡例</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Week"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Facility name"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Reporting\nperformance (%)"</span>,           <span class="co"># 凡例のタイトルを指定</span></span>
<span>       title <span class="op">=</span> <span class="st">"Percent of days per week that facility reported data"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"District health facilities, May-July 2020"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"7-day weeks beginning on Mondays."</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1259-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="値の表示" class="section level3 unnumbered">
<h3>値の表示<a class="anchor" aria-label="anchor" href="#%E5%80%A4%E3%81%AE%E8%A1%A8%E7%A4%BA"><i class="fas fa-link"></i></a>
</h3>
<p>タイルの上に <code><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text()</a></code>レイヤーを追加して、各タイルの数値を表示することができます。小さなタイルがたくさんある場合、小さくてはっきり見えないかも知れないので注意して下さい！</p>
<p>次のコードを追加します： <code>geom_text(aes(label = p_days_reported))</code> これは、各タイルにテキストで数値を追加するコードです。表示される数字は、引数 <code>label =</code> に割り当てられた値で、以下の例では色のグラデーションを作成するためにも使用されているのと同じ数値列 <code>p_days_reported</code> を指定しています。</p>
<div class="sourceCode" id="cb1647"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">agg_weeks</span><span class="op">)</span><span class="op">+</span> </span>
<span>  </span>
<span>  <span class="co"># データをタイルで表示</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>,</span>
<span>        y <span class="op">=</span> <span class="va">location_name</span>,</span>
<span>        fill <span class="op">=</span> <span class="va">p_days_reported</span><span class="op">)</span>,      </span>
<span>    color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span><span class="op">+</span>                 <span class="co"># 罫線を白に指定</span></span>
<span>  </span>
<span>  <span class="co"># テキスト</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">week</span>,</span>
<span>      y <span class="op">=</span> <span class="va">location_name</span>,</span>
<span>      label <span class="op">=</span> <span class="va">p_days_reported</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>      <span class="co"># タイルの上に数値を表示</span></span>
<span>  </span>
<span>  <span class="co"># タイルの塗りつぶし</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span></span>
<span>    low <span class="op">=</span> <span class="st">"orange"</span>,</span>
<span>    high <span class="op">=</span> <span class="st">"darkgreen"</span>,</span>
<span>    na.value <span class="op">=</span> <span class="st">"grey80"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># 日付軸</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,             <span class="co"># 両端の余分なスペースを削除</span></span>
<span>    date_breaks <span class="op">=</span> <span class="st">"2 weeks"</span>,     <span class="co"># 2週間ごとの日付ラベルを指定</span></span>
<span>    date_labels <span class="op">=</span> <span class="st">"%d\n%b"</span><span class="op">)</span><span class="op">+</span>     <span class="co"># 月の上に日付を表示 (\n は改行を示す)</span></span>
<span>  </span>
<span>  <span class="co"># テーマ</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                                    <span class="co"># 背景を簡潔にする</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    legend.text  <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    legend.key.height <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>,<span class="st">"cm"</span><span class="op">)</span>,           <span class="co"># 凡例の高さの指定</span></span>
<span>    legend.key.width  <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0.6</span>,<span class="st">"cm"</span><span class="op">)</span>,         <span class="co"># 凡例の幅の指定</span></span>
<span>    </span>
<span>    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span><span class="op">)</span>,              <span class="co"># 軸のテキストサイズの指定</span></span>
<span>    axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>vjust<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span>,            <span class="co"># 軸のテキストの場所の調整</span></span>
<span>    axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_line</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span>,               </span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,  <span class="co"># 軸のタイトルのサイズの指定と太字フォントの指定</span></span>
<span>    </span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0</span>,size<span class="op">=</span><span class="fl">14</span>,face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,  <span class="co"># タイトルを右揃えにして</span></span>
<span>    plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0</span>, face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span>  <span class="co"># 脚注を右揃えにしてイタリック体にする</span></span>
<span>    <span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># 凡例</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Week"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Facility name"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Reporting\nperformance (%)"</span>,           <span class="co"># 凡例のタイトルを指定</span></span>
<span>       title <span class="op">=</span> <span class="st">"Percent of days per week that facility reported data"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"District health facilities, May-July 2020"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"7-day weeks beginning on Mondays."</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1260-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
<div id="参考資料-25" class="section level2" number="34.4">
<h2>
<span class="header-section-number">34.4</span> 参考資料<a class="anchor" aria-label="anchor" href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99-25"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient()</a></p>
<p><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">R graph gallery - heatmap</a></p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="age-pyramid.html"><span class="header-section-number">33</span> 人口ピラミッドとリッカート尺度</a></div>
<div class="next"><a href="diagrams.html"><span class="header-section-number">35</span> フローチャート・サンキー図・タイムライン</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#heatmaps"><span class="header-section-number">34</span> ヒートマップ</a></li>
<li>
<a class="nav-link" href="#%E6%BA%96%E5%82%99-26"><span class="header-section-number">34.1</span> 準備</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF-18">パッケージの読み込み</a></li></ul>
</li>
<li>
<a class="nav-link" href="#%E6%84%9F%E6%9F%93%E4%BC%9D%E6%92%AD%E3%83%9E%E3%83%88%E3%83%AA%E3%83%83%E3%82%AF%E3%82%B9"><span class="header-section-number">34.2</span> 感染伝播マトリックス</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E3%83%87%E3%83%BC%E3%82%BF%E6%BA%96%E5%82%99-1">データ準備</a></li>
<li><a class="nav-link" href="#%E3%83%92%E3%83%BC%E3%83%88%E3%83%9E%E3%83%83%E3%83%97%E3%81%AE%E4%BD%9C%E6%88%90">ヒートマップの作成</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E5%A0%B1%E5%91%8A%E7%8E%87%E3%81%AE%E6%99%82%E7%B3%BB%E5%88%97"><span class="header-section-number">34.3</span> 報告率の時系列</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E3%83%87%E3%83%BC%E3%82%BF%E6%BA%96%E5%82%99-2">データ準備</a></li>
<li><a class="nav-link" href="#%E3%83%92%E3%83%BC%E3%83%88%E3%83%9E%E3%83%83%E3%83%97%E3%81%AE%E4%BD%9C%E6%88%90-1">ヒートマップの作成</a></li>
<li><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E3%83%97%E3%83%AD%E3%83%83%E3%83%88">基本プロット</a></li>
<li><a class="nav-link" href="#%E5%BF%9C%E7%94%A8%E3%83%97%E3%83%AD%E3%83%83%E3%83%88">応用プロット</a></li>
<li><a class="nav-link" href="#y%E8%BB%B8%E3%81%AE%E9%A0%86%E7%95%AA%E3%81%AE%E8%AA%BF%E6%95%B4">y軸の順番の調整</a></li>
<li><a class="nav-link" href="#%E5%80%A4%E3%81%AE%E8%A1%A8%E7%A4%BA">値の表示</a></li>
</ul>
</li>
<li><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99-25"><span class="header-section-number">34.4</span> 参考資料</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>疫学のための R ハンドブック</strong>" was written by the handbook team. It was last built on 2022-10-04.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
