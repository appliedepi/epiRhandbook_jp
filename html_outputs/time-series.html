<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>23 時系列分析とアウトブレイクの検出 | 疫学のための R ハンドブック</title>
<meta name="author" content="the handbook team">
<meta name="description" content="23.1 概観 このタブでは、時系列分析のためのいくつかのパッケージの使用方法を示します。主に tidyverts ファミリーのパッケージを使用していますが、感染症疫学に適したモデルをフィットさせるために、RECON trending パッケージも使用しています。...">
<meta name="generator" content="bookdown 0.29 with bs4_book()">
<meta property="og:title" content="23 時系列分析とアウトブレイクの検出 | 疫学のための R ハンドブック">
<meta property="og:type" content="book">
<meta property="og:description" content="23.1 概観 このタブでは、時系列分析のためのいくつかのパッケージの使用方法を示します。主に tidyverts ファミリーのパッケージを使用していますが、感染症疫学に適したモデルをフィットさせるために、RECON trending パッケージも使用しています。...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="23 時系列分析とアウトブレイクの検出 | 疫学のための R ハンドブック">
<meta name="twitter:description" content="23.1 概観 このタブでは、時系列分析のためのいくつかのパッケージの使用方法を示します。主に tidyverts ファミリーのパッケージを使用していますが、感染症疫学に適したモデルをフィットさせるために、RECON trending パッケージも使用しています。...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.0/transition.js"></script><script src="libs/bs3compat-0.4.0/tabs.js"></script><script src="libs/bs3compat-0.4.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.25/datatables.js"></script><link href="libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/tabwid-1.1.0/tabwid.css" rel="stylesheet">
<link href="libs/tabwid-1.1.0/scrool.css" rel="stylesheet">
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.9/grViz.js"></script><script src="libs/d3-4.5.0/d3.min.js"></script><script src="libs/sankey-1/sankey.js"></script><script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script><script src="libs/plotly-binding-4.10.0/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-2.5.1/plotly-latest.min.js"></script><link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="libs/vis-9.1.0/vis-network.min.js"></script><script src="libs/visNetwork-binding-2.1.0/visNetwork.js"></script><link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="libs/plotly-basic-2.5.1/plotly-basic-2.5.1.min.js"></script><script src="libs/plotly-cartesian-2.5.1/plotly-cartesian-2.5.1.min.js"></script><script src="libs/proj4js-2.3.15/proj4.js"></script><link href="libs/highcharts-9.3.1/css/motion.css" rel="stylesheet">
<script src="libs/highcharts-9.3.1/highcharts.js"></script><script src="libs/highcharts-9.3.1/highcharts-3d.js"></script><script src="libs/highcharts-9.3.1/highcharts-more.js"></script><script src="libs/highcharts-9.3.1/modules/stock.js"></script><script src="libs/highcharts-9.3.1/modules/map.js"></script><script src="libs/highcharts-9.3.1/modules/data.js"></script><script src="libs/highcharts-9.3.1/modules/exporting.js"></script><script src="libs/highcharts-9.3.1/modules/offline-exporting.js"></script><script src="libs/highcharts-9.3.1/modules/drilldown.js"></script><script src="libs/highcharts-9.3.1/modules/item-series.js"></script><script src="libs/highcharts-9.3.1/modules/overlapping-datalabels.js"></script><script src="libs/highcharts-9.3.1/modules/annotations.js"></script><script src="libs/highcharts-9.3.1/modules/export-data.js"></script><script src="libs/highcharts-9.3.1/modules/funnel.js"></script><script src="libs/highcharts-9.3.1/modules/heatmap.js"></script><script src="libs/highcharts-9.3.1/modules/treemap.js"></script><script src="libs/highcharts-9.3.1/modules/sankey.js"></script><script src="libs/highcharts-9.3.1/modules/dependency-wheel.js"></script><script src="libs/highcharts-9.3.1/modules/organization.js"></script><script src="libs/highcharts-9.3.1/modules/solid-gauge.js"></script><script src="libs/highcharts-9.3.1/modules/streamgraph.js"></script><script src="libs/highcharts-9.3.1/modules/sunburst.js"></script><script src="libs/highcharts-9.3.1/modules/vector.js"></script><script src="libs/highcharts-9.3.1/modules/wordcloud.js"></script><script src="libs/highcharts-9.3.1/modules/xrange.js"></script><script src="libs/highcharts-9.3.1/modules/tilemap.js"></script><script src="libs/highcharts-9.3.1/modules/venn.js"></script><script src="libs/highcharts-9.3.1/modules/gantt.js"></script><script src="libs/highcharts-9.3.1/modules/timeline.js"></script><script src="libs/highcharts-9.3.1/modules/parallel-coordinates.js"></script><script src="libs/highcharts-9.3.1/modules/bullet.js"></script><script src="libs/highcharts-9.3.1/modules/coloraxis.js"></script><script src="libs/highcharts-9.3.1/modules/dumbbell.js"></script><script src="libs/highcharts-9.3.1/modules/lollipop.js"></script><script src="libs/highcharts-9.3.1/modules/series-label.js"></script><script src="libs/highcharts-9.3.1/plugins/motion.js"></script><script src="libs/highcharts-9.3.1/custom/reset.js"></script><script src="libs/highcharts-9.3.1/modules/boost.js"></script><script src="libs/highchart-binding-0.9.4/highchart.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QXDW878QLX');
    </script><script type="text/javascript">
        // window.addEventListener("load", function() {
        //     document.getElementById('toc').firstChild.innerHTML = "章目次"; 
        // });
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementsByClassName("d-flex align-items-start justify-content-between")[0].children[0].children[0].innerHTML = "疫学のための R</br>ハンドブック";
            document.getElementById('toc').firstChild.innerHTML = "章目次"; 
            document.getElementById('main-nav').children[1].firstChild.innerHTML = "総目次";
            document.getElementById('search').setAttribute("placeholder", "検索");
        });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style_bs4.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">疫学のための R ハンドブック</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"></a></li>
<li class="book-part">本書について</li>
<li><a class="" href="editorial-style.html"><span class="header-section-number">1</span> 編集前記・技術注記</a></li>
<li><a class="" href="data-used.html"><span class="header-section-number">2</span> ハンドブックとデータのダウンロード</a></li>
<li class="book-part">基本編</li>
<li><a class="" href="basics.html"><span class="header-section-number">3</span> R の基礎</a></li>
<li><a class="" href="transition-to-R.html"><span class="header-section-number">4</span> Excel・Stata・SASとの比較</a></li>
<li><a class="" href="packages-suggested.html"><span class="header-section-number">5</span> 推奨パッケージ</a></li>
<li><a class="" href="r-projects.html"><span class="header-section-number">6</span> R プロジェクト</a></li>
<li><a class="" href="importing.html"><span class="header-section-number">7</span> データのインポート・エクスポート</a></li>
<li class="book-part">データマネジメント</li>
<li><a class="" href="cleaning.html"><span class="header-section-number">8</span> データクリーニングと主要関数</a></li>
<li><a class="" href="dates.html"><span class="header-section-number">9</span> 日付型データ</a></li>
<li><a class="" href="characters-strings.html"><span class="header-section-number">10</span> 文字型・文字列型データ</a></li>
<li><a class="" href="factors.html"><span class="header-section-number">11</span> 因子（ファクタ）型データ</a></li>
<li><a class="" href="pivoting.html"><span class="header-section-number">12</span> データの縦横変換</a></li>
<li><a class="" href="grouping.html"><span class="header-section-number">13</span> データのグループ化</a></li>
<li><a class="" href="joining-matching.html"><span class="header-section-number">14</span> データの結合</a></li>
<li><a class="" href="deduplication.html"><span class="header-section-number">15</span> 重複データの排除</a></li>
<li><a class="" href="iteration.html"><span class="header-section-number">16</span> ループと反復処理・リストの操作</a></li>
<li class="book-part">データ分析</li>
<li><a class="" href="tables-descriptive.html"><span class="header-section-number">17</span> 記述統計表の作り方</a></li>
<li><a class="" href="stat-tests.html"><span class="header-section-number">18</span> 基本的な統計的検定</a></li>
<li><a class="" href="regression.html"><span class="header-section-number">19</span> 単変量と多変量回帰</a></li>
<li><a class="" href="missing-data.html"><span class="header-section-number">20</span> データの欠損</a></li>
<li><a class="" href="standardization.html"><span class="header-section-number">21</span> 標準化率</a></li>
<li><a class="" href="moving-average.html"><span class="header-section-number">22</span> 移動平均</a></li>
<li><a class="active" href="time-series.html"><span class="header-section-number">23</span> 時系列分析とアウトブレイクの検出</a></li>
<li><a class="" href="epidemic-models.html"><span class="header-section-number">24</span> エピデミックモデリング</a></li>
<li><a class="" href="contact-tracing.html"><span class="header-section-number">25</span> 接触者の追跡</a></li>
<li><a class="" href="survey-analysis.html"><span class="header-section-number">26</span> 標本調査データ分析</a></li>
<li><a class="" href="survival-analysis.html"><span class="header-section-number">27</span> 生存時間解析</a></li>
<li><a class="" href="gis.html"><span class="header-section-number">28</span> GIS の基本</a></li>
<li class="book-part">データの可視化</li>
<li><a class="" href="tables-presentation.html"><span class="header-section-number">29</span> 見やすい表の作り方</a></li>
<li><a class="" href="ggplot-basics.html"><span class="header-section-number">30</span> ggplot の基本</a></li>
<li><a class="" href="ggplot-tips.html"><span class="header-section-number">31</span> ggplotのヒント</a></li>
<li><a class="" href="epicurves.html"><span class="header-section-number">32</span> 流行曲線（エピカーブ）</a></li>
<li><a class="" href="age-pyramid.html"><span class="header-section-number">33</span> 人口ピラミッドとリッカート尺度</a></li>
<li><a class="" href="heatmaps.html"><span class="header-section-number">34</span> ヒートマップ</a></li>
<li><a class="" href="diagrams.html"><span class="header-section-number">35</span> フローチャート・サンキー図・タイムライン</a></li>
<li><a class="" href="combination-analysis.html"><span class="header-section-number">36</span> 複数回答データの分析</a></li>
<li><a class="" href="transmission-chains.html"><span class="header-section-number">37</span> 感染連鎖</a></li>
<li><a class="" href="phylogenetic-trees.html"><span class="header-section-number">38</span> 系統樹</a></li>
<li><a class="" href="interactive-plots.html"><span class="header-section-number">39</span> 動的な図の作成</a></li>
<li class="book-part">レポートとダッシュボード</li>
<li><a class="" href="rmarkdown.html"><span class="header-section-number">40</span> R Markdown で作るレポート</a></li>
<li><a class="" href="reportfactory.html"><span class="header-section-number">41</span> ルーチンで作成するレポートの整理</a></li>
<li><a class="" href="flexdashboard.html"><span class="header-section-number">42</span> R Markdownで作るダッシュボード</a></li>
<li><a class="" href="shiny-basics.html"><span class="header-section-number">43</span> Shiny で作るダッシュボード</a></li>
<li class="book-part">その他</li>
<li><a class="" href="writing-functions.html"><span class="header-section-number">44</span> 関数の作成</a></li>
<li><a class="" href="directories.html"><span class="header-section-number">45</span> ディレクトリの操作</a></li>
<li><a class="" href="collaboration.html"><span class="header-section-number">46</span> Git と Github を使ったバージョン管理と共同作業</a></li>
<li><a class="" href="errors.html"><span class="header-section-number">47</span> よくあるエラー</a></li>
<li><a class="" href="help.html"><span class="header-section-number">48</span> ヘルプ</a></li>
<li><a class="" href="network-drives.html"><span class="header-section-number">49</span> ネットワークドライブで R を使用する場合</a></li>
<li><a class="" href="data-table.html"><span class="header-section-number">50</span> data.table パッケージを使用したデータ処理</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="time-series" class="section level1" number="23">
<h1>
<span class="header-section-number">23</span> 時系列分析とアウトブレイクの検出<a class="anchor" aria-label="anchor" href="#time-series"><i class="fas fa-link"></i></a>
</h1>
<!-- ======================================================= -->
<div id="概観" class="section level2" number="23.1">
<h2>
<span class="header-section-number">23.1</span> 概観<a class="anchor" aria-label="anchor" href="#%E6%A6%82%E8%A6%B3"><i class="fas fa-link"></i></a>
</h2>
<p>このタブでは、時系列分析のためのいくつかのパッケージの使用方法を示します。主に <a href="https://tidyverts.org/"><strong>tidyverts</strong></a> ファミリーのパッケージを使用していますが、感染症疫学に適したモデルをフィットさせるために、RECON <a href="https://github.com/reconhub/trending"><strong>trending</strong></a> パッケージも使用しています。</p>
<p>以下の例では、ドイツのカンピロバクターに関する<strong>surveillance</strong>パッケージのデータセットを使用していることに注意してください（詳細はハンドブックの<a href="data-used.html#data-used">ハンドブックとデータのダウンロード</a>を参照してください）。しかし、同じコードを複数の国や他の層を持つデータセットで実行したい場合は、<a href="https://github.com/R4EPI/epitsa">r4epis github repo</a> にコードテンプレートの例がありますので、そちらを参照してください。</p>
<p>扱うトピックは以下の通りです。</p>
<ol style="list-style-type: decimal">
<li>時系列データ<br>
</li>
<li>記述統計<br>
</li>
<li>回帰式のあてはめ<br>
</li>
<li>2つの時系列の関係<br>
</li>
<li>アウトブレイクの検出<br>
</li>
<li>遮断された時系列</li>
</ol>
<!-- ======================================================= -->
</div>
<div id="準備-14" class="section level2" number="23.2">
<h2>
<span class="header-section-number">23.2</span> 準備<a class="anchor" aria-label="anchor" href="#%E6%BA%96%E5%82%99-14"><i class="fas fa-link"></i></a>
</h2>
<div id="パッケージ-1" class="section level3 unnumbered">
<h3>パッケージ<a class="anchor" aria-label="anchor" href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8-1"><i class="fas fa-link"></i></a>
</h3>
<p>以下のコードを実行すると、分析に必要なパッケージが読み込まれます。このハンドブックでは、パッケージを読み込むために、<strong>pacman</strong> パッケージの <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load()</a></code> を主に使用しています。<code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load()</a></code> は、必要に応じてパッケージをインストールし、現在の R セッションで使用するためにパッケージを読み込む関数です。また、すでにインストールされたパッケージは、R の基本パッケージである <strong>base</strong> （以下、<strong>base</strong> R）の <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> を使用して読み込むこともできます。R のパッケージに関する詳細は <a href="basics.html#basics">R の基礎</a> の章をご覧ください。</p>
<div class="sourceCode" id="cb1103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">rio</span>,          <span class="co"># ファイルのインポート</span></span>
<span>               <span class="va">here</span>,         <span class="co"># ファイルのロケーター</span></span>
<span>               <span class="va">tidyverse</span>,    <span class="co"># データマネジメント + ggplot2の描画</span></span>
<span>               <span class="va">tsibble</span>,      <span class="co"># 時系列データセットの操作</span></span>
<span>               <span class="va">slider</span>,       <span class="co"># 移動平均の計算のため</span></span>
<span>               <span class="va">imputeTS</span>,     <span class="co"># 欠損値のフィルタリングのため</span></span>
<span>               <span class="va">feasts</span>,       <span class="co"># 時系列分解と自己相関のため</span></span>
<span>               <span class="va">forecast</span>,     <span class="co"># sinとcosの項をデータに当てはめる（注：feastsの後に読み込む必要がある）</span></span>
<span>               <span class="va">trending</span>,     <span class="co"># モデルの当てはめと査定</span></span>
<span>               <span class="va">tmaptools</span>,    <span class="co"># 地名から地理座標（lon/lat）を取得する関数</span></span>
<span>               <span class="va">ecmwfr</span>,       <span class="co"># copernicus sateliate CDS APIとのインタラクションのため</span></span>
<span>               <span class="va">stars</span>,        <span class="co"># .nc（天候データ）ファイルの読み込みのため</span></span>
<span>               <span class="va">units</span>,        <span class="co"># 測定ユニット（天候データ）の定義のため</span></span>
<span>               <span class="va">yardstick</span>,    <span class="co"># 適切なモデルを探すため</span></span>
<span>               <span class="va">surveillance</span>  <span class="co"># 異常検知のため</span></span>
<span>               <span class="op">)</span></span></code></pre></div>
</div>
<div id="データのロード" class="section level3 unnumbered">
<h3>データのロード<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89"><i class="fas fa-link"></i></a>
</h3>
<p>本ハンドブックで使用しているすべてのデータは、<a href="data-used.html#data-used">ハンドブックとデータのダウンロード</a>の章の手順でダウンロードできます。</p>
<p>ここでは、2001年から2011年にドイツで報告されたカンピロバクター症例の週次カウントをデータセットとして例示しています。<a href="https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/time_series/campylobacter_germany.xlsx" class="download-button">
ここをクリックすると、<span>このデータファイル（.xlsx）</span> </a> をダウンロードすることができます。</p>
<p>このデータセットは、<a href="https://cran.r-project.org/web/packages/surveillance/"><strong>surveillance</strong></a> パッケージで利用できるデータセットの縮小版です。
(詳細は surbeillance package パッケージを読み込み、 <code>?campyDE</code> を参照してください)</p>
<p>これらのデータを <strong>rio</strong> （.xlsx, .csv, .rds など多くのファイルタイプを扱うことができます）パッケージの <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> を使ってインポートします。</p>
<div class="sourceCode" id="cb1104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Rにcountsをインポート</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"campylobacter_germany.xlsx"</span><span class="op">)</span></span></code></pre></div>
<p>最初の10行のカウントが以下に表示されます。</p>
<div id="htmlwidget-ed4d8bd1f4e7c07be250" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-ed4d8bd1f4e7c07be250">{"x":{"filter":"none","vertical":false,"data":[["2001-12-31T00:00:00Z","2002-01-07T00:00:00Z","2002-01-14T00:00:00Z","2002-01-21T00:00:00Z","2002-01-28T00:00:00Z","2002-02-04T00:00:00Z","2002-02-11T00:00:00Z","2002-02-18T00:00:00Z","2002-02-25T00:00:00Z","2002-03-04T00:00:00Z"],[514,913,1023,887,815,792,803,807,692,705]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>date<\/th>\n      <th>case<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":1}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="データをきれいにする" class="section level3 unnumbered">
<h3>データをきれいにする<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%81%8D%E3%82%8C%E3%81%84%E3%81%AB%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p>以下のコードで、日付カラムが適切なフォーマットであることを確認します。このタブでは <strong>tsibble</strong> パッケージを使用し、 <code>yearweek()</code> が暦週変数を作成するために使用されています。他にもいくつかの方法がありますが（詳細は <a href="dates.html#dates">日付型データ</a> の章を参照してください）、時系列の場合は1つのフレームワーク（<strong>tsibble</strong>）に収めるのがベストです。</p>
<div class="sourceCode" id="cb1105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 日付カラムが適切なフォーマットであることを確認する</span></span>
<span><span class="va">counts</span><span class="op">$</span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 歴週変数を作成する</span></span>
<span><span class="co">## ISOの定義に準拠した月曜日から始まる週の定義にフィットさせる</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>epiweek <span class="op">=</span> <span class="fu">yearweek</span><span class="op">(</span><span class="va">date</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="天候データのダウンロード" class="section level3 unnumbered">
<h3>天候データのダウンロード<a class="anchor" aria-label="anchor" href="#%E5%A4%A9%E5%80%99%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89"><i class="fas fa-link"></i></a>
</h3>
<p>この章の <u>2つの時系列の関連</u> では、カンピロバクターの症例数と気候データを比較します。</p>
<p>世界各地の気候データは、EUのコペルニクス衛星からダウンロードできます。これらは正確な測定値ではなくモデルに基づいていますが（補間に似ています）、全世界を1時間ごとにカバーし、予測もできるという利点があります。</p>
<p>これらの各気候データファイルは、<a href="data-used.html#data-used">ハンドブックとデータのダウンロード</a>の章からダウンロードできます。</p>
<p>ここではデモンストレーションとして、 <strong>ecmwfr</strong> パッケージを使用して Copernicus 気候データストアからこれらのデータを取得するための R コードを紹介します。この機能を利用するには無料のアカウントの作成が必要です。パッケージのウェブサイトには、この方法に関する便利な<a href="https://github.com/bluegreen-labs/ecmwfr#use-copernicus-climate-data-store-cds">ウォークスルー</a>があります。以下は、適切な API キーを取得した上で、これを実行する方法のサンプルコードです。下記の X をお客様のアカウントIDに置き換えていただく必要があります。一度に1年分のデータをダウンロードしないと、サーバーがタイムアウトしてしまうので注意が必要です。</p>
<p>データをダウンロードしたい場所の座標がわからない場合は、<strong>tmaptools</strong> パッケージを使って、オープンストリートマップから座標を引き出すことができます。別の選択肢として、<a href="https://github.com/rCarto/photon"><strong>photon</strong></a> パッケージがありますが、これはまだ CRAN にはリリースされていません。<strong>photon</strong> パッケージの良い点は、検索に複数のマッチがあった場合に、より多くの文脈的なデータを提供することです。</p>
<div class="sourceCode" id="cb1106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 位置情報の取得</span></span>
<span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu">geocode_OSM</span><span class="op">(</span><span class="st">"Germany"</span>, geometry <span class="op">=</span> <span class="st">"point"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## ERA-5のクエリに対応したフォーマットでlong/latsをまとめる(bounding box) </span></span>
<span><span class="co">## (1つの点が欲しいだけなので、座標を繰り返すことはできない)</span></span>
<span><span class="va">request_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue_data</a></span><span class="op">(</span><span class="va">coords</span><span class="op">$</span><span class="va">coords</span>, <span class="st">"{y}/{x}/{y}/{x}"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## copernicus satellite (ERA-5 reanalysis)からモデル化したデータを引っ張ってくる。</span></span>
<span><span class="co">## https://cds.climate.copernicus.eu/cdsapp#!/software/app-era5-explorer?tab=app</span></span>
<span><span class="co">## https://github.com/bluegreen-labs/ecmwfr</span></span>
<span></span>
<span><span class="co">## 天気データ用のキーを設定</span></span>
<span><span class="fu">wf_set_key</span><span class="op">(</span>user <span class="op">=</span> <span class="st">"XXXXX"</span>,</span>
<span>           key <span class="op">=</span> <span class="st">"XXXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX"</span>,</span>
<span>           service <span class="op">=</span> <span class="st">"cds"</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">## 対象となる年ごとに実行（そうしないとサーバーがタイムアウトする）</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2002</span><span class="op">:</span><span class="fl">2011</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">## クエリを作成する</span></span>
<span>  <span class="co">## 方法はこちらを参照：https://bluegreen-labs.github.io/ecmwfr/articles/cds_vignette.html#the-request-syntax</span></span>
<span>  <span class="co">## 上記の Addins ボタンを使って request を list に変更（Python で list 化)</span></span>
<span>  <span class="co">## Target は出力ファイルの名前です！！</span></span>
<span>  <span class="va">request</span> <span class="op">&lt;-</span> <span class="va">request</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    product_type <span class="op">=</span> <span class="st">"reanalysis"</span>,</span>
<span>    format <span class="op">=</span> <span class="st">"netcdf"</span>,</span>
<span>    variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2m_temperature"</span>, <span class="st">"total_precipitation"</span><span class="op">)</span>,</span>
<span>    year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>,</span>
<span>    month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"01"</span>, <span class="st">"02"</span>, <span class="st">"03"</span>, <span class="st">"04"</span>, <span class="st">"05"</span>, <span class="st">"06"</span>, <span class="st">"07"</span>, <span class="st">"08"</span>, <span class="st">"09"</span>, <span class="st">"10"</span>, <span class="st">"11"</span>, <span class="st">"12"</span><span class="op">)</span>,</span>
<span>    day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"01"</span>, <span class="st">"02"</span>, <span class="st">"03"</span>, <span class="st">"04"</span>, <span class="st">"05"</span>, <span class="st">"06"</span>, <span class="st">"07"</span>, <span class="st">"08"</span>, <span class="st">"09"</span>, <span class="st">"10"</span>, <span class="st">"11"</span>, <span class="st">"12"</span>,</span>
<span>            <span class="st">"13"</span>, <span class="st">"14"</span>, <span class="st">"15"</span>, <span class="st">"16"</span>, <span class="st">"17"</span>, <span class="st">"18"</span>, <span class="st">"19"</span>, <span class="st">"20"</span>, <span class="st">"21"</span>, <span class="st">"22"</span>, <span class="st">"23"</span>, <span class="st">"24"</span>,</span>
<span>            <span class="st">"25"</span>, <span class="st">"26"</span>, <span class="st">"27"</span>, <span class="st">"28"</span>, <span class="st">"29"</span>, <span class="st">"30"</span>, <span class="st">"31"</span><span class="op">)</span>,</span>
<span>    time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"00:00"</span>, <span class="st">"01:00"</span>, <span class="st">"02:00"</span>, <span class="st">"03:00"</span>, <span class="st">"04:00"</span>, <span class="st">"05:00"</span>, <span class="st">"06:00"</span>, <span class="st">"07:00"</span>,</span>
<span>             <span class="st">"08:00"</span>, <span class="st">"09:00"</span>, <span class="st">"10:00"</span>, <span class="st">"11:00"</span>, <span class="st">"12:00"</span>, <span class="st">"13:00"</span>, <span class="st">"14:00"</span>, <span class="st">"15:00"</span>,</span>
<span>             <span class="st">"16:00"</span>, <span class="st">"17:00"</span>, <span class="st">"18:00"</span>, <span class="st">"19:00"</span>, <span class="st">"20:00"</span>, <span class="st">"21:00"</span>, <span class="st">"22:00"</span>, <span class="st">"23:00"</span><span class="op">)</span>,</span>
<span>    area <span class="op">=</span> <span class="va">request_coords</span>,</span>
<span>    dataset_short_name <span class="op">=</span> <span class="st">"reanalysis-era5-single-levels"</span>,</span>
<span>    target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"germany_weather"</span>, <span class="va">i</span>, <span class="st">".nc"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## ファイルをダウンロードして、現在の作業ディレクトリに保存</span></span>
<span>  <span class="va">file</span> <span class="op">&lt;-</span> <span class="fu">wf_request</span><span class="op">(</span>user     <span class="op">=</span> <span class="st">"XXXXX"</span>,  <span class="co"># ユーザーID（認証用）</span></span>
<span>                     request  <span class="op">=</span> <span class="va">request</span>,  <span class="co"># request</span></span>
<span>                     transfer <span class="op">=</span> <span class="cn">TRUE</span>,     <span class="co"># ファイルのダウンロード</span></span>
<span>                     path     <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"Weather"</span><span class="op">)</span><span class="op">)</span> <span class="co">## 保存データへのパス</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
</div>
<div id="天候データの読み込み" class="section level3 unnumbered">
<h3>天候データの読み込み<a class="anchor" aria-label="anchor" href="#%E5%A4%A9%E5%80%99%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF"><i class="fas fa-link"></i></a>
</h3>
<p>気候データをハンドブックからダウンロードした場合も、上記のコードを使用した場合も、コンピュータの同じフォルダに10年分の “.nc” 気候データファイルが保存されているはずです。</p>
<p>以下のコードを使用して、これらのファイルを <strong>stars</strong> パッケージで R にインポートします。</p>
<div class="sourceCode" id="cb1107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 天気フォルダへのパスの定義</span></span>
<span><span class="va">file_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span></span>
<span>  <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"time_series"</span>, <span class="st">"weather"</span><span class="op">)</span>, <span class="co"># あなた自身のファイルパスとの置き換え</span></span>
<span>  full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 現在の興味ある名前のものだけを残す </span></span>
<span><span class="va">file_paths</span> <span class="op">&lt;-</span> <span class="va">file_paths</span><span class="op">[</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">file_paths</span>, <span class="st">"germany"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## 全てのファイルをstartsオブジェクトとして読み込み</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">file_paths</span><span class="op">)</span></span></code></pre></div>
<pre><code>## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp,</code></pre>
<p>これらのファイルがオブジェクト <code>data</code> としてインポートされたら、データフレームに変換します。</p>
<div class="sourceCode" id="cb1109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## データフレームへの変更</span></span>
<span><span class="va">temp_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 変数の追加と単位の修正</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## 歴週変数の作成</span></span>
<span>    epiweek <span class="op">=</span> <span class="fu">tsibble</span><span class="fu">::</span><span class="fu"><a href="https://tsibble.tidyverts.org/reference/year-week.html">yearweek</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>, </span>
<span>    <span class="co">## 日付変数の作成（カレンダーの週の始まり）</span></span>
<span>    date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">epiweek</span><span class="op">)</span>,</span>
<span>    <span class="co">## 気温をケルビンから摂氏へ変更</span></span>
<span>    t2m <span class="op">=</span> <span class="fu">set_units</span><span class="op">(</span><span class="va">t2m</span>, <span class="va">celsius</span><span class="op">)</span>, </span>
<span>    <span class="co">## 降水量をメートル単位からミリ単位へ変更</span></span>
<span>    tp  <span class="op">=</span> <span class="fu">set_units</span><span class="op">(</span><span class="va">tp</span>, <span class="va">mm</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 週でグループ化（日付も残す）</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 週平均を取得</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>t2m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">t2m</span><span class="op">)</span><span class="op">)</span>, </span>
<span>            tp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">tp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## `summarise()` has grouped output by 'epiweek'. You can override using the
## `.groups` argument.</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="時系列データ" class="section level2" number="23.3">
<h2>
<span class="header-section-number">23.3</span> 時系列データ<a class="anchor" aria-label="anchor" href="#%E6%99%82%E7%B3%BB%E5%88%97%E3%83%87%E3%83%BC%E3%82%BF"><i class="fas fa-link"></i></a>
</h2>
<p>時系列データを構造化して扱うためのさまざまなパッケージがあります。前述の通り、ここでは <strong>tidyverts</strong> ファミリーのパッケージに焦点を当て、時系列オブジェクトを定義するために <strong>tsibble</strong> パッケージを使用します。データセットが時系列オブジェクトとして定義されていると、分析の構造化が非常に容易になります。</p>
<p>これには、 <code>tsibble()</code> を使用して「インデックス」、つまり、対象となる時間単位を指定する変数を指定します。ここでは、 <code>epiweek</code> という変数を使っています。</p>
<p>例えば、県別の週間カウントのデータセットがあったとすると、<code>key =</code> という引数でグループ化変数を指定することもできます。 これにより、グループごとの分析が可能となります。</p>
<div class="sourceCode" id="cb1111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 時系列オブジェクトの定義</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu">tsibble</span><span class="op">(</span><span class="va">counts</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span></span></code></pre></div>
<p><code>class(counts)</code> を見ると、 tidy なデータフレーム(“tbl_df”, “tbl”, “data.frame”)であることに加えて、時系列データフレーム(“tbl_ts”)の追加特性を持っていることがわかります。</p>
<p>データは <strong>ggplot2</strong> パッケージを使って簡単に見ることができます。このプロットから、明確な季節パターンがあり、欠落がないことがわかります。しかし、毎年年明けの報告には問題があるようで、年末の最終週は件数が減り、翌年の第1週は件数が増えます。</p>
<div class="sourceCode" id="cb1112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 週ごとのケースを折れ線グラフにする</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">case</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/basic_plot-1.png" width="672"></div>
<p><span style="color: red;"><strong><em>警告：</em></strong> ほとんどのデータセットはこの例のようにきれいではありません。 重複や欠落を以下のようにチェックする必要があります。</span>。</p>
<!-- ======================================================= -->
<div id="重複" class="section level3 unnumbered">
<h3>重複<a class="anchor" aria-label="anchor" href="#%E9%87%8D%E8%A4%87"><i class="fas fa-link"></i></a>
</h3>
<p><strong>tsibble</strong> では観測値の重複を認めていません。そのため、各行が一意、またはグループ内で一意である必要があります（<code>key</code> 変数）。
このパッケージには、重複しているかどうかのTRUE/FALSEベクトルを与える <code>are_duplicated()</code> や，重複している行のデータフレームを与える <code>duplicates()</code> など、重複を識別するのに役立つ関数がいくつかあります。</p>
<p>必要な行の選択方法の詳細については<a href="deduplication.html#deduplication">重複データの排除</a>の章を参照してください。</p>
<div class="sourceCode" id="cb1113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 行が重複しているかどうかのTRUE/FALSEのベクトルを得る</span></span>
<span><span class="fu">are_duplicated</span><span class="op">(</span><span class="va">counts</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">## 重複している行のデータフレームを取得する</span></span>
<span><span class="fu">duplicates</span><span class="op">(</span><span class="va">counts</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> </span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="欠損値-2" class="section level3 unnumbered">
<h3>欠損値<a class="anchor" aria-label="anchor" href="#%E6%AC%A0%E6%90%8D%E5%80%A4-2"><i class="fas fa-link"></i></a>
</h3>
<p>上記の簡単な検査では見逃しがないことを確認しましたが、新年頃に報告が遅れる問題があるようにも見えました。この問題に対処する1つの方法は、これらの値を欠損に設定して値を入力することです。時系列データに対する代入の最も簡単な方法は、最後の欠損していない値と次の欠損していない値の間を直線で結ぶことです。これを行うために、 <strong>imputeTS</strong> パッケージの<code>na_interpolation()</code> を使用します．</p>
<p>代入の他のオプションについては、<a href="missing-data.html#missing-data">欠損データの処理</a>の章を参照してください。</p>
<p>別の方法として、移動平均を計算して用いることでこれらの明らかな報告の問題をスムーズにすることができます（次のセクション、および<a href="moving-average.html#moving-average">移動平均</a>の章を参照してください）。</p>
<div class="sourceCode" id="cb1114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 報告書の課題で週数ではなく欠勤数で変数を作成</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>case_miss <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span></span>
<span>          <span class="co">## epiweekが52、53、1 または 2を含む場合</span></span>
<span>          <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="st">"W51|W52|W53|W01|W02"</span><span class="op">)</span>, </span>
<span>          <span class="co">## 欠損値をセット</span></span>
<span>          <span class="cn">NA_real_</span>, </span>
<span>          <span class="co">## そうでない場合、case に値を保持</span></span>
<span>          <span class="va">case</span></span>
<span>     <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 直線的な傾向で欠損値を補う方法</span></span>
<span><span class="co">## 隣接する2点の間</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>case_int <span class="op">=</span> <span class="fu">imputeTS</span><span class="fu">::</span><span class="fu"><a href="https://SteffenMoritz.github.io/imputeTS/reference/na_interpolation.html">na_interpolation</a></span><span class="op">(</span><span class="va">case_miss</span><span class="op">)</span></span>
<span>         <span class="op">)</span></span>
<span></span>
<span><span class="co">## 元の値と比較してどのような値が代入されたかを確認する</span></span>
<span><span class="fu">ggplot_na_imputations</span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_miss</span>, <span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 伝統的なプロット（軸が黒で背景が白）を作成</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/missings-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
<div id="記述統計" class="section level2" number="23.4">
<h2>
<span class="header-section-number">23.4</span> 記述統計<a class="anchor" aria-label="anchor" href="#%E8%A8%98%E8%BF%B0%E7%B5%B1%E8%A8%88"><i class="fas fa-link"></i></a>
</h2>
<!-- ======================================================= -->
<div id="timeseries_moving" class="section level3 unnumbered">
<h3>移動平均<a class="anchor" aria-label="anchor" href="#timeseries_moving"><i class="fas fa-link"></i></a>
</h3>
<p>値が上下に短期間で大きく変動するようなデータの場合は、移動平均を計算することが有効です。以下の例では、各週で、前の4週間の平均件数を計算します。これは、データをスムーズにして解釈しやすくするためのものです。私たちの場合、これにはあまり意味がないため、さらなる解析のために補間されたデータにこだわります。
詳細は、<a href="moving-average.html#moving-average">移動平均</a>の章を参照してください。</p>
<div class="sourceCode" id="cb1115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 移動平均変数の作成（欠損値の処理）</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="co">## ma_4W 変数の作成</span></span>
<span>     <span class="co">## ケース変数の各行をスライドさせる</span></span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ma_4wk <span class="op">=</span> <span class="fu">slider</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/slider/man/slide.html">slide_dbl</a></span><span class="op">(</span><span class="va">case</span>, </span>
<span>                               <span class="co">## すべての行について name を計算する</span></span>
<span>                               <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                               <span class="co">## 4週前を使う</span></span>
<span>                               .before <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 違いを一目で分かるように作成</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">ma_4wk</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/moving_averages-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="周期性" class="section level3 unnumbered">
<h3>周期性<a class="anchor" aria-label="anchor" href="#%E5%91%A8%E6%9C%9F%E6%80%A7"><i class="fas fa-link"></i></a>
</h3>
<p>以下では、周期表を作成するためのカスタム関数を定義します。R での関数の書き方は<a href="writing-functions.html#writing-functions">関数の作成</a>の章を参照してください。</p>
<p>まず，関数を定義します．この関数の引数には、<code>counts</code>列を持つデータセット、データセットの最初の週を表す<code>start_week =</code>、1年に何回の期間があるかを示す数字（例：52, 12）、そして最後に出力スタイルが含まれます（詳細は以下のコードを参照してください）。</p>
<div class="sourceCode" id="cb1116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 関数の引数</span></span>
<span><span class="co">#####################</span></span>
<span><span class="co">## xはデータセット</span></span>
<span><span class="co">## countsはx内のカウントデータまたはレートの変数</span></span>
<span><span class="co">## start_weekはデータセットの最初の週</span></span>
<span><span class="co">## periodは1年での単位数</span></span>
<span><span class="co">## outputは スペクトルの周期表を返すか、ピークの週数を返すかの指定</span></span>
<span>  <span class="co">## ”periodogram" or "weeks"</span></span>
<span></span>
<span><span class="co"># 関数の定義</span></span>
<span><span class="va">periodogram</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, </span>
<span>                        <span class="va">counts</span>, </span>
<span>                        <span class="va">start_week</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2002</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                        <span class="va">period</span> <span class="op">=</span> <span class="fl">52</span>, </span>
<span>                        <span class="va">output</span> <span class="op">=</span> <span class="st">"weeks"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span></span>
<span>    <span class="co">## tsibble でないことを確認し、プロジェクトにフィルターをかけ、関心のある列だけ残す</span></span>
<span>    <span class="va">prepare_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># prepare_data &lt;- prepare_data[prepare_data[[strata]] == j, ]</span></span>
<span>    <span class="va">prepare_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">prepare_data</span>, <span class="op">{</span><span class="op">{</span><span class="va">counts</span><span class="op">}</span><span class="op">}</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## spec.pgram で使用できるように、中間的な "zoo" 時系列を作成する</span></span>
<span>    <span class="va">zoo_cases</span> <span class="op">&lt;-</span> <span class="fu">zoo</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/zoo/man/zooreg.html">zooreg</a></span><span class="op">(</span><span class="va">prepare_data</span>, </span>
<span>                             start <span class="op">=</span> <span class="va">start_week</span>, frequency <span class="op">=</span> <span class="va">period</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## 高速フーリエ変換を使わずにスペクトル・ピリオドグラムを得ることができる</span></span>
<span>    <span class="va">periodo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/spec.pgram.html">spec.pgram</a></span><span class="op">(</span><span class="va">zoo_cases</span>, fast <span class="op">=</span> <span class="cn">FALSE</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## ピークの週を返す</span></span>
<span>    <span class="va">periodo_weeks</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">periodo</span><span class="op">$</span><span class="va">freq</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">periodo</span><span class="op">$</span><span class="va">spec</span><span class="op">)</span><span class="op">]</span> <span class="op">*</span> <span class="va">period</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">output</span> <span class="op">==</span> <span class="st">"weeks"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">periodo_weeks</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">periodo</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## 最も多い頻度を持つ週を抽出するためのスペクトル・ピリオドグラムを取得する</span></span>
<span><span class="co">## （季節性の確認）</span></span>
<span><span class="va">periodo</span> <span class="op">&lt;-</span> <span class="fu">periodogram</span><span class="op">(</span><span class="va">counts</span>, </span>
<span>                       <span class="va">case_int</span>, </span>
<span>                       start_week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2002</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                       output <span class="op">=</span> <span class="st">"periodogram"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## スペクトルと周期をデータフレームに取り込み、プロットする</span></span>
<span><span class="va">periodo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">periodo</span><span class="op">$</span><span class="va">freq</span>, <span class="va">periodo</span><span class="op">$</span><span class="va">spec</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 最も頻繁に発生する周期性を示す周期表を作成する</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">periodo</span>, </span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">periodo.freq</span><span class="op">/</span><span class="fl">52</span><span class="op">)</span>,  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">periodo.spec</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Period (Weeks)"</span>, y <span class="op">=</span> <span class="st">"Log(density)"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/periodogram-1.png" width="672"></div>
<div class="sourceCode" id="cb1117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 昇順で週のベクトルを取得する</span></span>
<span><span class="va">peak_weeks</span> <span class="op">&lt;-</span> <span class="fu">periodogram</span><span class="op">(</span><span class="va">counts</span>, </span>
<span>                          <span class="va">case_int</span>, </span>
<span>                          start_week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2002</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                          output <span class="op">=</span> <span class="st">"weeks"</span><span class="op">)</span></span></code></pre></div>
<p><span style="color: black;"><strong><em>注釈：</em></strong> 上の週を使って sin と cos の項に追加することも可能ですが、ここではこれらの項を生成する関数を使用します（下記の回帰の項を参照）</span></p>
<!-- ======================================================= -->
</div>
<div id="分解" class="section level3 unnumbered">
<h3>分解<a class="anchor" aria-label="anchor" href="#%E5%88%86%E8%A7%A3"><i class="fas fa-link"></i></a>
</h3>
<p>古典的分解は、時系列をいくつかの部分に分割するために使用され、それらの部分を組み合わせることで、目に見えるパターンを構成します。これらの異なる部分とは</p>
<ul>
<li>トレンド・サイクル（データの長期的な方向性）<br>
</li>
<li>季節性（繰り返されるパターン<br>
</li>
<li>ランダム（トレンドと季節を取り除いた後に残るもの）</li>
</ul>
<div class="sourceCode" id="cb1118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## counts データセットの分解</span></span>
<span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># 追加的な分解モデルを使用する</span></span>
<span>  <span class="fu">model</span><span class="op">(</span><span class="fu">classical_decomposition</span><span class="op">(</span><span class="va">case_int</span>, type <span class="op">=</span> <span class="st">"additive"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## モデルから重要な情報を抽出する</span></span>
<span>  <span class="fu">components</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## プロットを生成する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/decomposition-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="自己相関" class="section level3 unnumbered">
<h3>自己相関<a class="anchor" aria-label="anchor" href="#%E8%87%AA%E5%B7%B1%E7%9B%B8%E9%96%A2"><i class="fas fa-link"></i></a>
</h3>
<p>自己相関は、各週のカウント値とその前の週（ラグと呼ばれる）との関係を示します。</p>
<p><code>ACF()</code> を使って，異なるラグでの関係を示す複数の線を示すプロットを作成することができます。ラグが 0 (x = 0) の場合、この線は観測値とそれ自体の関係を示すため、常に1になります（ここでは示していません）。ここで示されている最初の線（x = 1）は、各観測値とその前の観測値との関係（ラグ 1 ）を示し、2番目の線は、各観測値と直前の観測値との関係（ラグ 2 ）を示し、さらに 1 年後（ 52 週前）の観測値との関係を示すラグ 52 まで続きます。</p>
<p><code>PACF()</code>（部分自己相関）を使うと同じような関係が見られますが、他のすべての週の間で調整されています。これは、周期性を決定するための情報としては不十分です。</p>
<div class="sourceCode" id="cb1119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## counts データセットを使用</span></span>
<span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 1年分のラグを使用して自己相関を計算する</span></span>
<span>  <span class="fu">ACF</span><span class="op">(</span><span class="va">case_int</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## プロットを表示する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/autocorrelation-1.png" width="672"></div>
<div class="sourceCode" id="cb1120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## counts データセットを使用する</span></span>
<span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 1年分のラグを使用して部分自己相関を計算する</span></span>
<span>  <span class="fu">PACF</span><span class="op">(</span><span class="va">case_int</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## プロットを表示</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/autocorrelation-2.png" width="672"></div>
<p>Ljung-Box 検定（ <strong>stats</strong> パッケージ）を使用して、時系列の独立性の帰無仮説を正式に検定することができます（つまり、自己相関がない）。
有意な p 値は、データに自己相関があることを示唆します。</p>
<div class="sourceCode" id="cb1121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 独立性を検定する</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/box.test.html">Box.test</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span>, type <span class="op">=</span> <span class="st">"Ljung-Box"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  counts$case_int
## X-squared = 462.65, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="回帰式の当てはめ" class="section level2" number="23.5">
<h2>
<span class="header-section-number">23.5</span> 回帰式の当てはめ<a class="anchor" aria-label="anchor" href="#%E5%9B%9E%E5%B8%B0%E5%BC%8F%E3%81%AE%E5%BD%93%E3%81%A6%E3%81%AF%E3%82%81"><i class="fas fa-link"></i></a>
</h2>
<p>時系列には多くの異なる回帰をフィットさせることができますが、ここでは、負の二項回帰を当てはめる方法を示します。 これは、感染症のカウントデータに最も適しているからです。</p>
<!-- ======================================================= -->
<div id="フーリエ列" class="section level3 unnumbered">
<h3>フーリエ列<a class="anchor" aria-label="anchor" href="#%E3%83%95%E3%83%BC%E3%83%AA%E3%82%A8%E5%88%97"><i class="fas fa-link"></i></a>
</h3>
<p>フーリエ列は、sin と cosin の曲線に相当します。違いは、データを説明するのに最も適した曲線の組み合わせを見つけてフィットさせることです。</p>
<p>1つのフーリエ列をフィッティングするだけなら、周期表で最も頻繁に発生するラグ（ここでは 52 週）に対して、sinとcosinをフィッティングするのと同義になります。ここでは <strong>forecast</strong> パッケージの <code>fourier()</code> を使用しています。</p>
<p>以下のコードでは、 <code>$</code> を使って代入しています。これは、 <code>fourier()</code> が2つの列（sin と cosin）を返すので、これらを “fourier” と呼ばれるリストとしてデータセットに追加しているためです。このリストは回帰分析において通常の変数と同様に利用できます。</p>
<div class="sourceCode" id="cb1123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## epiweek と case_int の変数を使ってフーリエ列を追加する</span></span>
<span><span class="va">counts</span><span class="op">$</span><span class="va">fourier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">counts</span>, <span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">fourier</span><span class="op">(</span>K <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="負の二項回帰" class="section level3 unnumbered">
<h3>負の二項回帰<a class="anchor" aria-label="anchor" href="#%E8%B2%A0%E3%81%AE%E4%BA%8C%E9%A0%85%E5%9B%9E%E5%B8%B0"><i class="fas fa-link"></i></a>
</h3>
<p>ベースとなる <strong>stats</strong> パッケージや <strong>MASS</strong> パッケージの関数（例： <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>, <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code>, <code>glm.nb()</code>）を用いて回帰の当てはめを行えます。しかしここでは <strong>trending</strong> パッケージの関数を使用します。これは適切な信頼区間と予測区間を計算できるからです（これは他の方法では利用できません）。構文は同じで、アウトカム変数を指定した後、チルダ（~）を入力し、プラス（+）で区切って関心のある様々な暴露変数を追加します。</p>
<p>もう一つの違いは、まずモデルを定義してそれをデータに <code>fit()</code> することです。これは、同じ構文で複数の異なるモデルを比較できるという点で便利です。</p>
<p><span style="color: darkgreen;"><strong><em>ヒント：</em></strong> もし、数ではなく率を使いたい場合は、 <code>offset(log(population)</code> を追加することで、対数オフセット項として population 変数を含めることができます。レートを生成するには、 <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> を使う前に population を 1 に設定する必要があります。</span></p>
<p><span style="color: darkgreen;"><strong><em>ヒント：</em></strong> ARIMA や prophet などのより複雑なモデルの当てはめについては、<a href="https://fable.tidyverts.org/index.html"><strong>fable</strong></a> パッケージをご参照ください。</span>。</p>
<div class="sourceCode" id="cb1124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 当てはめたいモデル（負の二項回帰）の定義</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>  <span class="co">## 関心のあるアウトカムとしてケースの番号をセットする</span></span>
<span>  <span class="va">case_int</span> <span class="op">~</span></span>
<span>    <span class="co">## トレンドを説明するため epiweek を使用する</span></span>
<span>    <span class="va">epiweek</span> <span class="op">+</span></span>
<span>    <span class="co">## 季節性を説明するためフーリエ列を使用する</span></span>
<span>    <span class="va">fourier</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## counts データセットを使用してモデルを当てはめる</span></span>
<span><span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 信頼区間と予測区間を計算する</span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted_model</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 回帰式をプロットする</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">observed</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## モデル推定値の線を追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,</span>
<span>            col <span class="op">=</span> <span class="st">"Red"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 予測区間のバンドを追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, </span>
<span>                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 観察されたケースの数を現す線を追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, </span>
<span>            col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 伝統的なプロット（軸が黒で背景が白）を作成する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/nb_reg-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="残差" class="section level3 unnumbered">
<h3>残差<a class="anchor" aria-label="anchor" href="#%E6%AE%8B%E5%B7%AE"><i class="fas fa-link"></i></a>
</h3>
<p>我々のモデルが観測されたデータにどれだけフィットしているかを理解するには、残差を見る必要があります。 残差は、観測されたカウントとモデルから推定されたカウントとの差です。これは、単純に <code>case_int - estimate</code> を使って計算することもできますが、 <code><a href="https://rdrr.io/r/stats/residuals.html">residuals()</a></code> は，回帰から直接残差を抽出してくれます。</p>
<p>下の図からわかることは、モデルで説明できる変動のすべてを説明できていないということです。もっとフーリエ列をフィットさせて、振れ幅に対処すべきかもしれません。しかし、この例では、このままにしておきます。このプロットは、我々のモデルがピークとトラフ（カウントが最高と最低の時）で悪く、観測されたカウントをより過小評価する可能性があることを示しています。</p>
<div class="sourceCode" id="cb1125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 残差を計算する</span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="va">observed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>resid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">fitted_model</span><span class="op">$</span><span class="va">fitted_model</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 残差は時間経過で概ね一定か？（そうでない場合： アウトブレイク？治療の変化？）</span></span>
<span><span class="va">observed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"epiweek"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-852-1.png" width="672"></div>
<div class="sourceCode" id="cb1126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 残差に自己相関があるか（誤差にパターンがあるか？）</span></span>
<span><span class="va">observed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ACF</span><span class="op">(</span><span class="va">resid</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-852-2.png" width="672"></div>
<div class="sourceCode" id="cb1127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 残差が正規分布しているか（過小または過大推定か？）</span></span>
<span><span class="va">observed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_rug.html">geom_rug</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-852-3.png" width="672"></div>
<div class="sourceCode" id="cb1128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 観測されたカウントとその残差を比較する</span></span>
<span>  <span class="co">## パターンがないべき </span></span>
<span><span class="va">observed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Fitted"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-852-4.png" width="672"></div>
<div class="sourceCode" id="cb1129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 残差の自己相関を正式に検定する</span></span>
<span><span class="co">## H0 は残差がホワイトノイズ系列（つまりランダム）であるとする</span></span>
<span><span class="co">## 独立性を検定する</span></span>
<span><span class="co">## p 値が有意であればランダムではありません。</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/box.test.html">Box.test</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">resid</span>, type <span class="op">=</span> <span class="st">"Ljung-Box"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  observed$resid
## X-squared = 346.64, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="つの時系列の関係性" class="section level2" number="23.6">
<h2>
<span class="header-section-number">23.6</span> 2つの時系列の関係性<a class="anchor" aria-label="anchor" href="#%E3%81%A4%E3%81%AE%E6%99%82%E7%B3%BB%E5%88%97%E3%81%AE%E9%96%A2%E4%BF%82%E6%80%A7"><i class="fas fa-link"></i></a>
</h2>
<p>ここでは、気象データ（特に気温）を用いてカンピロバクターの症例数を説明する方法を見てみます。</p>
<!-- ======================================================= -->
<div id="データセットのマージ" class="section level3 unnumbered">
<h3>データセットのマージ<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88%E3%81%AE%E3%83%9E%E3%83%BC%E3%82%B8"><i class="fas fa-link"></i></a>
</h3>
<p>week の変数を使ってデータセットを結合することができます。結合の詳細については、ハンドブックの<a href="joining-matching.html#joining-matching">データの結合</a>のセクションを参照してください。</p>
<div class="sourceCode" id="cb1131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 左結合で、counts にすでに存在する行だけを保持する</span></span>
<span><span class="co">## temp_data から、date 変数を除外する（そうしないと重複する）</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">counts</span>, </span>
<span>                    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">temp_data</span>, <span class="op">-</span><span class="va">date</span><span class="op">)</span>,</span>
<span>                    by <span class="op">=</span> <span class="st">"epiweek"</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="記述統計-1" class="section level3 unnumbered">
<h3>記述統計<a class="anchor" aria-label="anchor" href="#%E8%A8%98%E8%BF%B0%E7%B5%B1%E8%A8%88-1"><i class="fas fa-link"></i></a>
</h3>
<p>まず、データをプロットして、明らかな関係があるかどうかを確認します。
下のプロットは、2つの変数の季節性に明確な関係があることを示しています。温度がケース番号の数週間前にピークに達することがあります。
データピボットについての詳細は、ハンドブックの<a href="pivoting.html#pivoting">データの縦横変換</a>のセクションを参照してください。</p>
<div class="sourceCode" id="cb1132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 関心のある変数を保持する</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">case_int</span>, <span class="va">t2m</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 縦型のフォーマットにデータを変更する</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>    <span class="co">## epiweekをキーとして使用する</span></span>
<span>    <span class="op">!</span><span class="va">epiweek</span>,</span>
<span>    <span class="co">## 列名を新たな "measure" 列に移動させる</span></span>
<span>    names_to <span class="op">=</span> <span class="st">"measure"</span>, </span>
<span>    <span class="co">## セルの値を新たな "values" 列に移動させる</span></span>
<span>    values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 上記のデータセットでプロットを作成する</span></span>
<span>  <span class="co">## epiweekをX軸、値（カウント/摂氏）をY軸にプロット</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="co">## 気温とケースの数について分離したプロットを作成</span></span>
<span>    <span class="co">## それらを書くY軸に配置する</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">measure</span> <span class="op">~</span> <span class="va">.</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co">## 両方を線にしてプロットする</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/basic_plot_bivar-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="ラグと相互相関" class="section level3 unnumbered">
<h3>ラグと相互相関<a class="anchor" aria-label="anchor" href="#%E3%83%A9%E3%82%B0%E3%81%A8%E7%9B%B8%E4%BA%92%E7%9B%B8%E9%96%A2"><i class="fas fa-link"></i></a>
</h3>
<p>ケースと温度の間にどの週が最も高い関係にあるかを正式に検証するために<br>
これには <strong>feasts</strong> パッケージの相互相関関数 (<code>CCF()</code>) が使用可能です。
また（ <code>arrange</code> ではなく） <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot()</a></code> を使って視覚化することもできます。</p>
<div class="sourceCode" id="cb1133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 補完された和と気温の間の相互相関を計算する</span></span>
<span>  <span class="fu">CCF</span><span class="op">(</span><span class="va">case_int</span>, <span class="va">t2m</span>,</span>
<span>      <span class="co">## 最大のラグを52週としてセットする</span></span>
<span>      lag_max <span class="op">=</span> <span class="fl">52</span>, </span>
<span>      <span class="co">## 相関係数を返す</span></span>
<span>      type <span class="op">=</span> <span class="st">"correlation"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 相関係数を降順に並び替える</span></span>
<span>  <span class="co">## 最も関連するラグを表示する</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">ccf</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 上位10のみ表示する</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tsibble: 10 x 2 [1W]
##      lag   ccf
##    &lt;lag&gt; &lt;dbl&gt;
##  1   -4W 0.749
##  2   -5W 0.745
##  3   -3W 0.735
##  4   -6W 0.729
##  5   -2W 0.727
##  6   -7W 0.704
##  7   -1W 0.695
##  8   -8W 0.671
##  9    0W 0.649
## 10   47W 0.638</code></pre>
<p>このことから、4週間のラグが最も相関性が高いことがわかりますので、ラグ付きの温度変数を作って回帰に含めます。</p>
<p><span style="color: red;"><strong><u>警告：</u></strong> 遅延した温度変数のデータの最初の4週間が欠けている（<code>NA</code>）ことに注意してください - データを取得するための4週間前のデータがないからです。このデータセットを <strong>トレンド</strong> の <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> で使用するためには、 <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> の中の <code>simulate_pi = FALSE</code> 引数をさらに下の方で使用する必要があります。simulate オプションを使用したい場合は、以下のコードチャンクに <code>drop_na(t2m_lag4)</code> を追加することで、これらのミスを削除し、新しいデータセットとして保存しなければなりません。</span></p>
<div class="sourceCode" id="cb1135"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 4週でラグされた気温の変数を作成する</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>t2m_lag4 <span class="op">=</span> <span class="fu">lag</span><span class="op">(</span><span class="va">t2m</span>, n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="変数における負の二項分布" class="section level3 unnumbered">
<h3>2変数における負の二項分布<a class="anchor" aria-label="anchor" href="#%E5%A4%89%E6%95%B0%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E8%B2%A0%E3%81%AE%E4%BA%8C%E9%A0%85%E5%88%86%E5%B8%83"><i class="fas fa-link"></i></a>
</h3>
<p>前述のように負の二項回帰を当てはめます。今回は、4週間遅れの温度変数を加えます。</p>
<p><span style="color: orange;"><strong><em>注意：</em></strong> <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> の引数の中で <code>simulate_pi = FALSE</code> を使用していることに注意してください。これは、 <strong>trending</strong> のデフォルトの動作として、 <strong>ciTools</strong> パッケージを使用して予測区間を推定するためです。これは、 <code>NA</code> が含まれている場合には機能せず、また、より荒い間隔を生成します。詳細は <code><a href="https://rdrr.io/pkg/trending/man/trending_model_fit-prediction.html">?trending::predict.trending_model_fit</a></code> を参照してください。</span></p>
<div class="sourceCode" id="cb1136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 当てはめたいモデル（負の二項分布）を定義する</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>  <span class="co">## 関心のあるアウトカムとしてケースの数をセットする</span></span>
<span>  <span class="va">case_int</span> <span class="op">~</span></span>
<span>    <span class="co">## トレンドの説明のために epiweek を使用する</span></span>
<span>    <span class="va">epiweek</span> <span class="op">+</span></span>
<span>    <span class="co">## 季節性の説明のためにフーリエ列を使用する</span></span>
<span>    <span class="va">fourier</span> <span class="op">+</span> </span>
<span>    <span class="co">## 4週間ラグされた気温を使用する</span></span>
<span>    <span class="va">t2m_lag4</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co">## counts データセットを使用してモデルの当てはめを行う</span></span>
<span><span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 信頼区間と予測区間を計算する</span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted_model</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>個々の項を調べるために <code>get_model()</code> を使用して <strong>trending</strong> フォーマットから元の負の二項回帰を取り出し、指数化された推定値とそれに関連する信頼区間を取得するために、これを <strong>broom</strong> パッケージの <code>tidy()</code> に渡します。</p>
<p>このことからわかるのは、トレンドと季節性を調整した後のラグ付き気温は症例数（推定値～ 1 ）と似通っており、有意に関連していることがわかります。
これは、ラグ付き気温が将来の症例数を予測するのに適した変数であることを示唆しています（気候予測は容易に入手可能です）。</p>
<div class="sourceCode" id="cb1137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 元の負の二項回帰を抽出する</span></span>
<span>  <span class="fu">get_model</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 結果についての tidy なデータフレームを取得する</span></span>
<span>  <span class="fu">tidy</span><span class="op">(</span>exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>       conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 5 × 7
##   term         estimate  std.error statistic  p.value conf.low conf.high
##   &lt;chr&gt;           &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1 (Intercept)   339.    0.108          53.8  0         274.      419.   
## 2 epiweek         1.00  0.00000774     10.9  8.13e-28    1.00      1.00 
## 3 fourierS1-52    0.752 0.0214        -13.3  1.84e-40    0.721     0.784
## 4 fourierC1-52    0.823 0.0200         -9.78 1.35e-22    0.791     0.855
## 5 t2m_lag4        1.01  0.00269         2.48 1.30e- 2    1.00      1.01</code></pre>
<p>このモデルを可視化すると、観測された症例数のより正確な推定が可能かもしれないことがわかります。</p>
<div class="sourceCode" id="cb1139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 回帰式をプロットする</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">observed</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## モデルの推定値の線を追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,</span>
<span>            col <span class="op">=</span> <span class="st">"Red"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 予測区間のバンドを追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, </span>
<span>                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 観測されたケースの数の線を追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, </span>
<span>            col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 伝統的なプロット（軸が黒で背景が白）を作成する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/plot_nb_reg_bivar-1.png" width="672"></div>
<div id="残差-1" class="section level4 unnumbered">
<h4>残差<a class="anchor" aria-label="anchor" href="#%E6%AE%8B%E5%B7%AE-1"><i class="fas fa-link"></i></a>
</h4>
<p>私たちのモデルが観測されたデータにどれだけフィットしているかを見るために、再び残差を調査します。
ここでの結果と解釈は前回の回帰のものと似ており、温度なしのよりシンプルなモデルにこだわる方が実現性が高いかもしれません。</p>
<div class="sourceCode" id="cb1140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 残差を計算する</span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="va">observed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>resid <span class="op">=</span> <span class="va">case_int</span> <span class="op">-</span> <span class="va">estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 残差は時間経過で概ね一定か？（そうでない場合： アウトブレイク？治療の変化？）</span></span>
<span><span class="va">observed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"epiweek"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: Removed 4 row(s) containing missing values (geom_path).</code></pre>
<pre><code>## Warning: Removed 4 rows containing missing values (geom_point).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-853-1.png" width="672"></div>
<div class="sourceCode" id="cb1143"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 残差に自己相関があるか（誤差にパターンがあるか？）</span></span>
<span><span class="va">observed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ACF</span><span class="op">(</span><span class="va">resid</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-853-2.png" width="672"></div>
<div class="sourceCode" id="cb1144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 残差が正規分布しているか（過小または過大推定か？） </span></span>
<span><span class="va">observed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_rug.html">geom_rug</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span> </span></code></pre></div>
<pre><code>## Warning: Removed 4 rows containing non-finite values (stat_bin).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-853-3.png" width="672"></div>
<div class="sourceCode" id="cb1146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 観測されたカウントとその残差を比較する</span></span>
<span>  <span class="co">## パターンがないべき </span></span>
<span><span class="va">observed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Fitted"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: Removed 4 rows containing missing values (geom_point).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-853-4.png" width="672"></div>
<div class="sourceCode" id="cb1148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 残差の自己相関を正式に検定する</span></span>
<span><span class="co">## H0 は残差がホワイトノイズ系列（つまりランダム）であるとする</span></span>
<span><span class="co">## 独立性を検定する</span></span>
<span><span class="co">## p 値が有意であればランダムではない</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/box.test.html">Box.test</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">resid</span>, type <span class="op">=</span> <span class="st">"Ljung-Box"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  observed$resid
## X-squared = 339.52, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="アウトブレイク" class="section level2" number="23.7">
<h2>
<span class="header-section-number">23.7</span> アウトブレイク<a class="anchor" aria-label="anchor" href="#%E3%82%A2%E3%82%A6%E3%83%88%E3%83%96%E3%83%AC%E3%82%A4%E3%82%AF"><i class="fas fa-link"></i></a>
</h2>
<p>ここでは、集団発生を検知する2つの（類似した）方法を紹介します。<br>
1つ目は、上記のセクションを基にしています。<br>
過去の年に回帰を当てはめるために <strong>trending</strong> パッケージを使用し、次の年以降に何が起こるかを予測します。観察された数が予測を上回っていれば、アウトブレイクが発生していることを示唆しています。
2つ目の方法は、同様の原理に基づいていますが、 <strong>surveillance</strong> パッケージを使用します。このパッケージには、異常を検出するためのさまざまなアルゴリズムが含まれています。</p>
<p><span style="color: orange;"><strong><em>注意：</em></strong> 通常は現在の年（現在の週までのカウントしかわからない場合）におけるアウトブレイクの発生に関心があります。この例では、2011年の第39週にいると仮定しています。</span></p>
<!-- ======================================================= -->
<div id="trending-パッケージ" class="section level3 unnumbered">
<h3>
<strong>trending</strong> パッケージ<a class="anchor" aria-label="anchor" href="#trending-%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8"><i class="fas fa-link"></i></a>
</h3>
<p>この方法ではベースライン（通常は約5年分のデータ）を定義します。<br>
ベースラインのデータに回帰分析を行い、それをもとに次年度の推定値を予測します。</p>
<!-- ======================================================= -->
<div id="日付のカットオフ" class="section level4 unnumbered">
<h4>日付のカットオフ<a class="anchor" aria-label="anchor" href="#%E6%97%A5%E4%BB%98%E3%81%AE%E3%82%AB%E3%83%83%E3%83%88%E3%82%AA%E3%83%95"><i class="fas fa-link"></i></a>
</h4>
<p>日付を一箇所で定義し、それを残りのコードで使用するのが簡単です。</p>
<p>ここでは、開始日（観測を開始した日）とカットオフ日（ベースライン期間の終了日であり、予測したい期間の開始日）を定義します。 また、対象となる年(これから予測するもの)が何週目であるかも定義します。</p>
<p><span style="color: black;"><strong><em>ヒント：</em></strong> この例では、現在、2011年9月末（ “2011W39” ）にいることにしています。</span></p>
<div class="sourceCode" id="cb1150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 開始日（いつ観測を開始したか）を定義する</span></span>
<span><span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## カットオフ週（ベースラインの最終、予測期間の開始）を定義する</span></span>
<span><span class="va">cut_off</span> <span class="op">&lt;-</span> <span class="fu">yearweek</span><span class="op">(</span><span class="st">"2010-12-31"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 関心のある最終日を定義する（例：予測の最後）</span></span>
<span><span class="va">end_date</span> <span class="op">&lt;-</span> <span class="fu">yearweek</span><span class="op">(</span><span class="st">"2011-12-31"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 関心のある期間（年）における週数を取得</span></span>
<span><span class="va">num_weeks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">end_date</span> <span class="op">-</span> <span class="va">cut_off</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="行の追加-1" class="section level4 unnumbered">
<h4>行の追加<a class="anchor" aria-label="anchor" href="#%E8%A1%8C%E3%81%AE%E8%BF%BD%E5%8A%A0-1"><i class="fas fa-link"></i></a>
</h4>
<p>Tidyverse 形式で予測するためには、データセットに適切な数の行が必要です。すなわち、上で定義した <code>end_date</code> まで、各週に1行ずつです。
以下のコードでは、グループ化変数によってこれらの行を追加することができます。例えば、1つのデータセットに複数の国がある場合、各国をグループとし、それぞれの国に適切な行を追加することができます。
<strong>tsibble</strong> パッケージの <code>group_by_key()</code> でこのグループ化を行い、グループ化されたデータを <strong>dplyr</strong> パッケージの <code><a href="https://dplyr.tidyverse.org/reference/group_map.html">group_modify()</a></code> および <code><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row()</a></code> に渡すことができます。次に、現在データにある最大の週の1つ後から最終週までの週の順序を指定します。</p>
<div class="sourceCode" id="cb1151"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 年末までの欠損週を追加する</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## 地域でグループ化する</span></span>
<span>  <span class="fu">group_by_key</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## 各グループに対して最も高いepiweekから年末までの行を追加する</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_map.html">group_modify</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row</a></span><span class="op">(</span><span class="va">.</span>,</span>
<span>                        epiweek <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, </span>
<span>                                      <span class="va">end_date</span>,</span>
<span>                                      by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="フーリエ列-1" class="section level4 unnumbered">
<h4>フーリエ列<a class="anchor" aria-label="anchor" href="#%E3%83%95%E3%83%BC%E3%83%AA%E3%82%A8%E5%88%97-1"><i class="fas fa-link"></i></a>
</h4>
<p>フーリエ列を再定義する必要があります。これは、基準日にのみフーリエ列をフィットさせ、翌年のフーリエ列を予測（外挿）したいからです。
そのためには、 <code>fourier()</code> からの2つのリストの出力を組み合わせる必要があります。1つ目はベースラインデータに対するもので、2つ目は（<code>h</code>引数を定義することで）対象となる年の予測です。</p>
<p><u>備考：</u> 行を結合するためには tidyverse の <code>bind_rows</code> ではなく、 <code><a href="https://rdrr.io/r/base/cbind.html">rbind()</a></code> を用いなければなりません。これは、フーリエ列がリスト（個別に名前がついていない）であるためです。</p>
<div class="sourceCode" id="cb1152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## フーリエ列（sincos）を定義する</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## 2010年のカットオフ日前後の週のフーリエ列を組み合わせる</span></span>
<span>    <span class="co">## （nb. フーリエ列は予測される）</span></span>
<span>    fourier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span></span>
<span>      <span class="co">## 過去の年のフーリエ列を取得する</span></span>
<span>      <span class="fu">fourier</span><span class="op">(</span></span>
<span>        <span class="co">## 2011年以前の行のみ保持する</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">counts</span>, </span>
<span>               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cut_off</span><span class="op">)</span>, </span>
<span>        <span class="co">## サイン、コサインの項を1つのセットとして含める</span></span>
<span>        K <span class="op">=</span> <span class="fl">1</span></span>
<span>        <span class="op">)</span>, </span>
<span>      <span class="co">## 2011年におけるフーリエ列を予測する（ベースラインデータを用いる）</span></span>
<span>      <span class="fu">fourier</span><span class="op">(</span></span>
<span>        <span class="co">## 2011年以前の行のみ保持する</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">counts</span>, </span>
<span>               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cut_off</span><span class="op">)</span>,</span>
<span>        <span class="co">## サイン、コサインの項を1つのセットとして含める</span></span>
<span>        K <span class="op">=</span> <span class="fl">1</span>, </span>
<span>        <span class="co">## 52週後を予測する</span></span>
<span>        h <span class="op">=</span> <span class="va">num_weeks</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="データの分割と回帰式の当てはめ" class="section level4 unnumbered">
<h4>データの分割と回帰式の当てはめ<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%88%86%E5%89%B2%E3%81%A8%E5%9B%9E%E5%B8%B0%E5%BC%8F%E3%81%AE%E5%BD%93%E3%81%A6%E3%81%AF%E3%82%81"><i class="fas fa-link"></i></a>
</h4>
<p>次に、データセットをベースライン期間と予測期間に分割する必要があります。これは、 <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> の後に <strong>dplyr</strong> パッケージの <code><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split()</a></code> を使って行い、カットオフ前とカットオフ後の2つのデータフレームを持つリストを作成します。</p>
<p>次に，<strong>purrr</strong> パッケージの <code><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck()</a></code> を使ってリストからデータセットを取り出し（角括弧を使った場合と同じです，例：<code>dat[[1]]</code>），ベースラインデータにモデルを当てはめ、カットオフ後の関心のあるデータに対して <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> を使います．</p>
<p><strong>purrr</strong> パッケージについては<a href="iteration.html#iteration">ループと反復処理・リストの操作</a>の章を参照してください。</p>
<p><span style="color: orange;"><strong><u>注意：</u></strong> <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> の引数で <code>simulate_pi = FALSE</code> を使用していることに注意してください。これは、 <strong>trending</strong> パッケージのデフォルトの動作として、 <strong>ciTools</strong> パッケージを使用して予測区間を推定するためです。これは、<code>NA</code>カウントがある場合には機能せず、また、より詳細な間隔を生成します。 詳細は <code><a href="https://rdrr.io/pkg/trending/man/trending_model_fit-prediction.html">?trending::predict.trending_model_fit</a></code> を参照してください。</span></p>
<div class="sourceCode" id="cb1153"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 当てはめと予測のためにデータを分割する</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cut_off</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 当てはめたいモデル（負の二項回帰）を定義する</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>  <span class="co">## 関心のあるアウトカムとしてケースの数をセットする</span></span>
<span>  <span class="va">case_int</span> <span class="op">~</span></span>
<span>    <span class="co">## トレンドの説明のために epiweek を使用する</span></span>
<span>    <span class="va">epiweek</span> <span class="op">+</span></span>
<span>    <span class="co">## 季節性の説明のためにフーリエ列を使用する</span></span>
<span>    <span class="va">fourier</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># どのデータをあてはめに使用し、どのデータを予測に使用するかを定義する</span></span>
<span><span class="va">fitting_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">pred_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">case_int</span>, <span class="va">epiweek</span>, <span class="va">fourier</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># モデルの当てはめを行う</span></span>
<span><span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">fitting_data</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 当てはめたデータのconfintと推定値を得る</span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span>simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 予測したいデータで予測する</span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">pred_data</span><span class="op">)</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## ベースラインと予測されたデータセットを結合する</span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">observed</span>, <span class="va">forecasts</span><span class="op">)</span></span></code></pre></div>
<p>前述のように、モデルを <strong>ggplot</strong> で可視化することができます。95% 予測区間を超えて観測された数のアラートを赤いドットで強調しています。今回は、予測開始時刻を示す縦線も加えています。</p>
<div class="sourceCode" id="cb1154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 回帰式をプロットする</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">observed</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## モデル推定値についての線を追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,</span>
<span>            col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 予測区間のバンドを追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, </span>
<span>                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 観測されたケースの数についての線を追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, </span>
<span>            col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 期待値以上の観測値観測されたケースについての点をプロットする</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">observed</span>, <span class="va">case_int</span> <span class="op">&gt;</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, </span>
<span>    colour <span class="op">=</span> <span class="st">"red"</span>, </span>
<span>    size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 予測開始の箇所を表示するために水平線とラベルを追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span></span>
<span>           xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">cut_off</span><span class="op">)</span>, </span>
<span>           linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"text"</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"Forecast"</span>, </span>
<span>           x <span class="op">=</span> <span class="va">cut_off</span>, </span>
<span>           y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">upper_pi</span><span class="op">)</span> <span class="op">-</span> <span class="fl">250</span>, </span>
<span>           angle <span class="op">=</span> <span class="fl">90</span>, </span>
<span>           vjust <span class="op">=</span> <span class="fl">1</span></span>
<span>           <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 伝統的なプロット（軸が黒で背景が白）を作成する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: Removed 13 row(s) containing missing values (geom_path).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/forecast_plot-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="予測と妥当性検証" class="section level4 unnumbered">
<h4>予測と妥当性検証<a class="anchor" aria-label="anchor" href="#%E4%BA%88%E6%B8%AC%E3%81%A8%E5%A6%A5%E5%BD%93%E6%80%A7%E6%A4%9C%E8%A8%BC"><i class="fas fa-link"></i></a>
</h4>
<p>残差を調べるだけでなく、モデルが将来のケースをどの程度予測できるかを調べることも重要です。これによりあなたの設定した閾値による警告の信頼性を知ることができます。</p>
<p>伝統的な検証方法としては、一つ前の年をどの程度予測できるかを確認していました（なぜなら、「今の年」の症例数がまだわからないからです）。例えば今回のデータセットでは、2002年から2009年までのデータを使って2010年を予測し、その予測の正確さを確認します。その後、2010年のデータを含むようにモデルを修正し、それを使って2011年の数を予測します。</p>
<p>下の図は <u>Hyndman et al</u> による <a href="https://otexts.com/fpp3/">“Forecasting principles and practice”</a> に掲載されています。</p>
<p><img src="https://otexts.com/fpp3/fpp_files/figure-html/traintest-1.png"><u>図は著者の許可を得て転載しています。</u></p>
<p>この場合のデメリットは、使用可能なすべてのデータを使用していないことと、予測に使用する最終モデルではないことです。</p>
<p>もう一つの方法は、交差妥当性と呼ばれる方法です。このシナリオでは、利用可能なすべてのデータをロールオーバーさせ、1年先を予測するための複数のモデルに適合させます。 以下の同じ [<u>Hyndman et al</u> text]((<a href="https://otexts.com/fpp3/" class="uri">https://otexts.com/fpp3/</a>) の図のように、それぞれのモデルにはより多くのデータを使用します。 例えば、1つ目のモデルは2002年を使って2003年を予測し、2つ目は2002年と2003年を使って2004年を予測する、といった具合です。<img src="https://otexts.com/fpp2/fpp_files/figure-html/cv1-1.png"><u>図は著者の許可を得て転載しています。</u></p>
<p>以下では、 <strong>purrr</strong> パッケージの <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> を使用して各データセットをループさせます。次に、推定値を1つのデータセットにまとめ、元の症例数とマージし、 <strong>yardstick</strong> パッケージを使用して精度の測定値を計算します。以下の4つの指標を計算しました。平均平方根誤差（RMSE: root mean square error）、平均絶対誤差（MAE: mean absolute error）、平均絶対尺度誤差（MASE: mean absolute scaled error）、平均絶対パーセント誤差（MAPE: mean absolute percent error）です。</p>
<p><span style="color: orange;"><strong><u>注意：</u></strong> <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> の引数で <code>simulate_pi = FALSE</code> を使用していることに注意してください。これは <strong>trending</strong> のデフォルトの動作が <strong>ciTools</strong> パッケージを使用して予測区間を推定することだからです。これは これは<code>NA</code>カウントがある場合には機能せず、また、より荒い間隔を生成します。 詳細は <code><a href="https://rdrr.io/pkg/trending/man/trending_model_fit-prediction.html">?trending::predict.trending_model_fit</a></code> を参照してください。</span></p>
<div class="sourceCode" id="cb1156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 交差確認法： スライディングウィンドウに基づいて1週間先を予測する</span></span>
<span></span>
<span><span class="co">## データを52週分（前+後）に分割して表示する</span></span>
<span><span class="co">## 52週先を予測する</span></span>
<span><span class="co">## (観察の連鎖がどんどん長くなり、古いデータが残る）</span></span>
<span></span>
<span><span class="co">## ロールオーバーさせたい窓を定義する</span></span>
<span><span class="va">roll_window</span> <span class="op">&lt;-</span> <span class="fl">52</span></span>
<span></span>
<span><span class="co">## 何週間先を予測したいかを定義する</span></span>
<span><span class="va">weeks_ahead</span> <span class="op">&lt;-</span> <span class="fl">52</span></span>
<span></span>
<span><span class="co">## 繰り返しの、長いデータセットを作成する</span></span>
<span><span class="co">## 各データセットに一意のIDを付与する</span></span>
<span><span class="co">## 関心のある年（例： 2011年）の前のケースのみを使用する</span></span>
<span><span class="va">case_roll</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&lt;</span> <span class="va">cut_off</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 週とケースの数の変数のみを保持する</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## 最新の x 観測値を除外する</span></span>
<span>    <span class="co">## 何週間先まで予測するかによって</span></span>
<span>    <span class="co">##（そうでない場合は""unknownへの実際の予測となる） </span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">weeks_ahead</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## グループ化された ID を作成するために、 x の後のウィンドウで各週をロールオーバーする</span></span>
<span>    <span class="co">## ローリングウィンドウの指定に応じて</span></span>
<span>    <span class="fu">stretch_tsibble</span><span class="op">(</span>.init <span class="op">=</span> <span class="va">roll_window</span>, .step <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 「以前」のケースがないため - 最初の組み合わせを削除する</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">.id</span> <span class="op">&gt;</span> <span class="va">roll_window</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## それぞれのデータセットに対して、以下のコードを実行する</span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">case_roll</span><span class="op">$</span><span class="va">.id</span><span class="op">)</span>, </span>
<span>                        <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">## 現在の折り返しをフィットさせるのみ</span></span>
<span>  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">case_roll</span>, <span class="va">.id</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## 予測するための空のデータセットを作成する</span></span>
<span>  <span class="va">forecast_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    epiweek <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">mini_data</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">mini_data</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span> <span class="op">+</span> <span class="va">weeks_ahead</span>,</span>
<span>                  by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    case_int <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep.int</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">weeks_ahead</span><span class="op">)</span>,</span>
<span>    .id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep.int</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">weeks_ahead</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## 予測データを元のデータに追加する</span></span>
<span>  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">mini_data</span>, <span class="va">forecast_data</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## 最新の非欠損カウントデータに基づいてカットオフを定義する</span></span>
<span>  <span class="va">cv_cut_off</span> <span class="op">&lt;-</span> <span class="va">mini_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## 欠損していない行のみを保持する</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">case_int</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## 最新の週を取得する</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## 抽出したものはデータフレームには含まれない</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## mini_data を tsibble に戻す</span></span>
<span>  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="fu">tsibble</span><span class="op">(</span><span class="va">mini_data</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## フーリエ列（sincos）を定義する</span></span>
<span>  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="va">mini_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## カットオフ日の前後の週のフーリエ列を組み合わせる</span></span>
<span>    fourier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span></span>
<span>      <span class="co">## 以前の年のフーリエ列を取得する</span></span>
<span>      <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/fourier.html">fourier</a></span><span class="op">(</span></span>
<span>        <span class="co">## カットオフ以前の行のみを保持する</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">mini_data</span>, </span>
<span>               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cv_cut_off</span><span class="op">)</span>, </span>
<span>        <span class="co">## サイン・コサイン項のセットを1つ含める</span></span>
<span>        K <span class="op">=</span> <span class="fl">1</span></span>
<span>        <span class="op">)</span>, </span>
<span>      <span class="co">## 後の年についてのフーリエ列を予測する（ベースラインデータを用いて）</span></span>
<span>      <span class="fu">fourier</span><span class="op">(</span></span>
<span>        <span class="co">## カットオフ以前の行のみを保持する</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">mini_data</span>, </span>
<span>               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cv_cut_off</span><span class="op">)</span>,</span>
<span>        <span class="co">## サイン・コサインの項を1つ含める</span></span>
<span>        K <span class="op">=</span> <span class="fl">1</span>, </span>
<span>        <span class="co">## 52週先を予測する</span></span>
<span>        h <span class="op">=</span> <span class="va">weeks_ahead</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co">## 当てはめと予測のためにデータを分割する</span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">mini_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cv_cut_off</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## 当てはめたいモデルを定義する（負の二項回帰）</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>    <span class="co">## 関心のあるアウトカムとしてケースの数をセットする</span></span>
<span>    <span class="va">case_int</span> <span class="op">~</span></span>
<span>      <span class="co">## 傾向を説明するために epiweek を使います。</span></span>
<span>      <span class="va">epiweek</span> <span class="op">+</span></span>
<span>      <span class="co">## 季節性を説明するためにフーリエ列を使用する</span></span>
<span>      <span class="va">fourier</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># どのデータを当てはめと予測に使用するかを定義する</span></span>
<span>  <span class="va">fitting_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">pred_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># モデルの当てはめを行う</span></span>
<span>  <span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">fitting_data</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># 予測したいデータを予想する</span></span>
<span>  <span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">pred_data</span><span class="op">)</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## 週と予想する推定値のみを保持する</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">estimate</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## リストを全ての予測を含むデータフレームにする</span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">forecasts</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 予測値と観測値を結合する</span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">forecasts</span>, </span>
<span>                       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">counts</span>, <span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span>,</span>
<span>                       by <span class="op">=</span> <span class="st">"epiweek"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## {yardstick} を用いて指標を計算する</span></span>
<span>  <span class="co">## RMSE： Root mean squared error（平均二乗偏差）</span></span>
<span>  <span class="co">## MAE：  Mean absolute error  （平均絶対誤差）</span></span>
<span>  <span class="co">## MASE： Mean absolute scaled error（平均絶対スケール誤差）</span></span>
<span>  <span class="co">## MAPE： Mean absolute percent error（平均絶対パーセント誤差）</span></span>
<span><span class="va">model_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="co">## 予測されたデータセット内の観測値と推定値を比較</span></span>
<span>  <span class="fu">rmse</span><span class="op">(</span><span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>, </span>
<span>  <span class="fu">mae</span><span class="op">(</span> <span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>,</span>
<span>  <span class="fu">mase</span><span class="op">(</span><span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>,</span>
<span>  <span class="fu">mape</span><span class="op">(</span><span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 指標タイプと結果のみを保持する</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>Metric  <span class="op">=</span> <span class="va">.metric</span>, </span>
<span>         Measure <span class="op">=</span> <span class="va">.estimate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 後で行を結合できるようにワイドフォーマットで作成する</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">Metric</span>, values_from <span class="op">=</span> <span class="va">Measure</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## モデルの指標を返す</span></span>
<span><span class="va">model_metrics</span></span></code></pre></div>
<pre><code>## # A tibble: 1 × 4
##    rmse   mae  mase  mape
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  252.  199.  1.96  17.3</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="surveillance-パッケージ" class="section level3 unnumbered">
<h3>
<strong>surveillance</strong> パッケージ<a class="anchor" aria-label="anchor" href="#surveillance-%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8"><i class="fas fa-link"></i></a>
</h3>
<p>このセクションでは、アウトブレイク検出アルゴリズムに基づいて警告の閾値を作成するために <strong>surveillance</strong> パッケージを使用します。このパッケージにはいくつかの異なる手法がありますが、ここでは2つのオプションに焦点を当てます。詳細については、使用したアルゴリズムの <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/monitoringCounts.pdf">application</a> と <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/glrnb.pdf">theory</a> に関するこれらの論文を参照してください。</p>
<p>最初のオプションでは、改良型の Farrington 法を使用します。これは負の二項一般化線形モデル（トレンドを含む）に適合し、過去の発生（外れ値）をダウンウェイトして、閾値を作成します。</p>
<p>2つ目のオプションでは glrnb メソッドを使用します。これも負の二項一般化線形モデルに当てはめますが、トレンドとフーリエ列を含んでいます（そのため、ここはメリットです）。この回帰は「統制平均」（～適合値）を計算するために使用されます。そして、各週の平均にシフトがあるかどうかを評価するために、計算された一般化された尤度比統計を使用します。各週のしきい値は、前の週を考慮していることに注意してください。各週の閾値は過去の週を考慮しているため、持続的なシフトがある場合はアラームが作動します。 （また、各アラームの後、アルゴリズムはリセットされることにも注意してください）。</p>
<p><strong>surveillance</strong> パッケージを使用するためには、まず、フレームワークに適合する “surveillance time series” オブジェクトを定義する必要があります（<code>sts()</code> を使用）。</p>
<div class="sourceCode" id="cb1158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## surveillance time series オブジェクトを定義する</span></span>
<span><span class="co">## 備考: 母集団オブジェクトに分母を含められる（?stsを参照ください）。</span></span>
<span><span class="va">counts_sts</span> <span class="op">&lt;-</span> <span class="fu">sts</span><span class="op">(</span>observed <span class="op">=</span> <span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                  start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>                    <span class="co">## start_date から年のみを保持するサブセット</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                    <span class="co">## start_date から週のみを保持するサブセット</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="fl">7</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                  <span class="co">## データの種類を定義する（このケースでは週次）</span></span>
<span>                  freq <span class="op">=</span> <span class="fl">52</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 含めたい週の範囲を定義する（例：予測期間）</span></span>
<span><span class="co">## 備考： sts オブジェクトは、週を指定せずにオブザベーションをカウントするだけ</span></span>
<span><span class="co">## sts オブジェクトは、週や年の識別子を割り当てずに観測値をカウントしているだけなので、我々のデータを使って適切な観測値を定義する</span></span>
<span><span class="va">weekrange</span> <span class="op">&lt;-</span> <span class="va">cut_off</span> <span class="op">-</span> <span class="va">start_date</span></span></code></pre></div>
<!-- ======================================================= -->
<div id="farrington-法" class="section level4 unnumbered">
<h4>Farrington 法<a class="anchor" aria-label="anchor" href="#farrington-%E6%B3%95"><i class="fas fa-link"></i></a>
</h4>
<p>次に、 Farrington メソッドの各パラメータを <code>list</code> で定義します。そして、 <code>farringtonFlexible()</code> を使用してアルゴリズムを実行し、 <code>farringtonmethod@upperbound</code> を使用してアラートの閾値を抽出し、データセットに含めることができます。また、 <code>farringtonmethod@alarm</code> を使用して各週にアラートが発生した(閾値を超えた)場合のTRUE/FALSEを抽出することも可能です。</p>
<div class="sourceCode" id="cb1159"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## コントロール群を定義する</span></span>
<span><span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="co">## 閾値が必要な期間を定義する（例： 2011年）</span></span>
<span>  range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts_sts</span><span class="op">@</span><span class="va">epoch</span> <span class="op">&gt;</span> <span class="va">weekrange</span><span class="op">)</span>,</span>
<span>  b <span class="op">=</span> <span class="fl">9</span>, <span class="co">## ベースラインを何年前にするか</span></span>
<span>  w <span class="op">=</span> <span class="fl">2</span>, <span class="co">## 移動窓のサイズ</span></span>
<span>  weightsThreshold <span class="op">=</span> <span class="fl">2.58</span>, <span class="co">## 過去の発生事例への再重みづけ（改良型の Noufaily 法 - オリジナルの提案1）</span></span>
<span>  <span class="co">## pastWeeksNotIncluded = 3, ## 利用可能なすべての週を使う (Noufaily は 26 を落とすことを提案)</span></span>
<span>  trend <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  pThresholdTrend <span class="op">=</span> <span class="fl">1</span>, <span class="co">## 通常は 0.05 だが、改良された方法では 1 が推奨される（つまり、常に保持される）</span></span>
<span>  thresholdMethod <span class="op">=</span> <span class="st">"nbPlugin"</span>,</span>
<span>  populationOffset <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## farrington の柔軟な方法を適用する</span></span>
<span><span class="va">farringtonmethod</span> <span class="op">&lt;-</span> <span class="fu">farringtonFlexible</span><span class="op">(</span><span class="va">counts_sts</span>, <span class="va">ctrl</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## オリジナルのデータセットに閾値という新たな変数を作成する</span></span>
<span><span class="co">## farrington からの上界を含む</span></span>
<span><span class="co">## 備考： これは2011年の週のみを対象とする（そのため、行をサブセット化する必要がある）</span></span>
<span><span class="va">counts</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">epiweek</span> <span class="op">&gt;=</span> <span class="va">cut_off</span> <span class="op">&amp;</span> </span>
<span>               <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              <span class="st">"threshold"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">farringtonmethod</span><span class="op">@</span><span class="va">upperbound</span></span></code></pre></div>
<p>前に実施したように、結果を ggplot によって可視化できます。</p>
<div class="sourceCode" id="cb1160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 観測されたケースを線として追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span>, colour <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 収差アルゴリズムの上界を追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">threshold</span>, colour <span class="op">=</span> <span class="st">"Alert threshold"</span><span class="op">)</span>, </span>
<span>            linetype <span class="op">=</span> <span class="st">"dashed"</span>, </span>
<span>            size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## 色を定義する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>                                 <span class="st">"Alert threshold"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 伝統的なプロット（軸が黒で背景が白）を作成する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## legend のタイトルを除外する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/plot_farrington-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="glrnb-法" class="section level4 unnumbered">
<h4>GLRNB 法<a class="anchor" aria-label="anchor" href="#glrnb-%E6%B3%95"><i class="fas fa-link"></i></a>
</h4>
<p>GLRNB 法の場合も同様に各パラメータを「リスト」で定義します。そしてアルゴリズムを当てはめ、上界を抽出します。</p>
<p><span style="color: orange;"><strong><u>注意：</u></strong> この方法は、閾値の計算に「ブルートフォース」（ブートストラップ法に似た方法）を使用するため、長い時間がかかることがあります！</span></p>
<p>詳細は <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/glrnb.pdf">GLRNB ドキュメント（vignette）</a> を参照してください。</p>
<div class="sourceCode" id="cb1161"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 統制するオプションを定義する</span></span>
<span><span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="co">## 閾値が必要な期間を定義する (例：2011年)</span></span>
<span>  range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts_sts</span><span class="op">@</span><span class="va">epoch</span> <span class="op">&gt;</span> <span class="va">weekrange</span><span class="op">)</span>,</span>
<span>  mu0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fl">1</span>,    <span class="co">## 含めるフーリエ列（ハーモニクス）の数</span></span>
<span>  trend <span class="op">=</span> <span class="cn">TRUE</span>,   <span class="co">## トレンドを含めるかどうか</span></span>
<span>  refit <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="co">## それぞれの警告の後、モデルを再度当てはめるかどうか</span></span>
<span>  <span class="co">## cARL = GLR 統計の閾値（任意）</span></span>
<span>     <span class="co">## 3 ~ 偽陽性を最小限に抑えるための中間地点</span></span>
<span>     <span class="co">## 1 glm.nbの99%PIにフィット - ピーク後の変化あり（警告のために閾値を下げる）</span></span>
<span>   c.ARL <span class="op">=</span> <span class="fl">2</span>,</span>
<span>   <span class="co"># theta = log(1.5), ## アウトブレイクにおける症例数の50%増加に等しい</span></span>
<span>   ret <span class="op">=</span> <span class="st">"cases"</span>     <span class="co">## ケースの数として閾値の上界を返す</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## glrnb 法の適用</span></span>
<span><span class="va">glrnbmethod</span> <span class="op">&lt;-</span> <span class="fu">glrnb</span><span class="op">(</span><span class="va">counts_sts</span>, control <span class="op">=</span> <span class="va">ctrl</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 元のデータセットに閾値と名付けた新たな変数をセットする</span></span>
<span><span class="co">## glrnb の上界を含む</span></span>
<span><span class="co">## 備考: これは2011年の週のみを対象としている（そのため、行をサブセット化する必要がある）</span></span>
<span><span class="va">counts</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">epiweek</span> <span class="op">&gt;=</span> <span class="va">cut_off</span> <span class="op">&amp;</span> </span>
<span>               <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              <span class="st">"threshold_glrnb"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">glrnbmethod</span><span class="op">@</span><span class="va">upperbound</span></span></code></pre></div>
<p>前述と同様にアウトプットを可視化します。</p>
<div class="sourceCode" id="cb1162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 観測されたケースの数を線として追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span>, colour <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## aberration アルゴリズムの上界を追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">threshold_glrnb</span>, colour <span class="op">=</span> <span class="st">"Alert threshold"</span><span class="op">)</span>, </span>
<span>            linetype <span class="op">=</span> <span class="st">"dashed"</span>, </span>
<span>            size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## 色を定義する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>                                 <span class="st">"Alert threshold"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 伝統的なプロット（軸が黒で背景が白）を作成する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## タイトルのレジェンドを除外する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/plot_glrnb-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="中断された時系列" class="section level2" number="23.8">
<h2>
<span class="header-section-number">23.8</span> 中断された時系列<a class="anchor" aria-label="anchor" href="#%E4%B8%AD%E6%96%AD%E3%81%95%E3%82%8C%E3%81%9F%E6%99%82%E7%B3%BB%E5%88%97"><i class="fas fa-link"></i></a>
</h2>
<p>中断された時系列（セグメント回帰や介入分析とも呼ばれる）は、病気の発生率に対するワクチンの影響を評価する際によく使用されます。しかし、これは広義の介入や導入の影響を評価するのに使用可能です。例えば、病院の手順の変更や、集団への新しい病気の導入などです。
今回の例では、2008 年末にドイツでカンピロバクターの新しい株が出現したと仮定し、それが患者数に影響を与えるかを調査します。今回も負の二項回帰を使用します。今回の回帰では、介入前（または新菌株の出現）と介入後（前後の期間）の2つの部分に分割します。これにより、2つの期間を比較した罹患率比を算出することができます。式を説明するとわかりやすいかもしれません（そうでなければ無視してください！）。</p>
<p>負の2項回帰は次の通り定義できます。</p>
<p><span class="math display">\[\log(Y_t)= β_0 + β_1 \times t+ β_2 \times δ(t-t_0) + β_3\times(t-t_0 )^+ + log(pop_t) + e_t\]</span></p>
<p>ここで<br><span class="math inline">\(Y_t\)</span> は <span class="math inline">\(t\)</span> 時点で観測された症例数<br><span class="math inline">\(pop_t\)</span> は、 <span class="math inline">\(t\)</span> 時点での10万人単位の人口規模（ここでは使用しません）。<br><span class="math inline">\(t_0\)</span> は前期間の最後の年（移行期間がある場合はその期間も含みます）。<br><span class="math inline">\(δ(x)\)</span> は指標関数（x≤0なら0、x&gt;0なら1）。<br><span class="math inline">\((x)^+\)</span> はカットオフ演算子（x&gt;0ならx、それ以外は0）。<br><span class="math inline">\(e_t\)</span> は残差を表します。<br>
必要に応じてトレンドや季節などの項を追加することができます。</p>
<p><span class="math inline">\(β_2 \times δ(t-t_0) + β_3 \times(t-t_0 )^+\)</span> は、後の期間の一般化された線形部分であり、前期はゼロです。
これは、 <span class="math inline">\(β_2\)</span> と <span class="math inline">\(β_3\)</span> の推定値は介入の効果であることを意味します。</p>
<p>ここでは利用可能なすべてのデータを使用するため、予測を行わずにフーリエ列を再計算する必要があります（つまり、過去にさかのぼって計算することになります）。さらに、回帰に必要な追加の項を計算する必要があります。</p>
<div class="sourceCode" id="cb1163"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## epiweek と case_int variabless を使用してフーリエ列を追加する</span></span>
<span><span class="va">counts</span><span class="op">$</span><span class="va">fourier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">counts</span>, <span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">fourier</span><span class="op">(</span>K <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 介入の週を定義する</span></span>
<span><span class="va">intervention_week</span> <span class="op">&lt;-</span> <span class="fu">yearweek</span><span class="op">(</span><span class="st">"2008-12-31"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 回帰分析のための変数を定義する</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## 公式における t に対応させる</span></span>
<span>      <span class="co">## 週数 (epiweeks をそのまま使うこともできるだろう)</span></span>
<span>    <span class="co"># 線形 = 行の数（epiweek）</span></span>
<span>    <span class="co">## 公式におけるデルタ（t-t0）に対応させる</span></span>
<span>      <span class="co">## 前と後の介入期間</span></span>
<span>    intervention <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&gt;=</span> <span class="va">intervention_week</span><span class="op">)</span>, </span>
<span>    <span class="co">## 公式に置ける（(t-t0)^+ に対応させる</span></span>
<span>      <span class="co">## 介入後の週の数</span></span>
<span>      <span class="co">## ## (0から計算で出てくる数字のうち、大きい方を選ぶ)</span></span>
<span>    time_post <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">epiweek</span> <span class="op">-</span> <span class="va">intervention_week</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>次に、これらの項を使って負の二項回帰をあてはめ、変化率の表を作成します。この例では、有意な変化はありませんでした。</p>
<p><span style="color: orange;"><strong><em>注意：</em></strong> <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> の引数で <code>simulate_pi = FALSE</code> を使用していることに注意してください。これは <strong>trending</strong> のデフォルトの動作が <strong>ciTools</strong> パッケージを使用して予測区間を推定することだからです。
これは<code>NA</code>カウントがある場合には機能せず、また、より細かい間隔を生成します。詳細は <code><a href="https://rdrr.io/pkg/trending/man/trending_model_fit-prediction.html">?trending::predict.trending_model_fit</a></code> を参照してください。</span></p>
<div class="sourceCode" id="cb1164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 当てはめたいモデル（負の二項回帰）を定義する</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>  <span class="co">## 関心のあるアウトカムとしてのケースの数をセットする</span></span>
<span>  <span class="va">case_int</span> <span class="op">~</span></span>
<span>    <span class="co">## トレンドの説明のために epiweek を使用する</span></span>
<span>    <span class="va">epiweek</span> <span class="op">+</span></span>
<span>    <span class="co">## 季節性の説明のためにフーリエ列を使用する</span></span>
<span>    <span class="va">fourier</span> <span class="op">+</span> </span>
<span>    <span class="co">## 前あるいは後ろの期間であるかを追加する</span></span>
<span>    <span class="va">intervention</span> <span class="op">+</span> </span>
<span>    <span class="co">## 介入後の期間を追加する</span></span>
<span>    <span class="va">time_post</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co">## countsデータセットを使用して、モデルを当てはめる</span></span>
<span><span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 信頼区間と予測区間を算出する</span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted_model</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co">## 推定値と変化率をテーブル内に表示する</span></span>
<span><span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 元の負の二項回帰を抽出する</span></span>
<span>  <span class="fu">get_model</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 結果についての tidy なデータフレームを取得する</span></span>
<span>  <span class="fu">tidy</span><span class="op">(</span>exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>       conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 介入の値のみを保持する</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"intervention"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 推定値と CIs について、 IRR を変化率に変換する</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## 関心のあるそれぞれの列に対して新しい列を作成する</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"estimate"</span>, <span class="st">"conf.low"</span>, <span class="st">"conf.high"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>      <span class="co">## 変化率を算出する公式を適用する</span></span>
<span>            .f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fl">100</span> <span class="op">*</span> <span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>      <span class="co">## "_perc" という名前の接尾語を新たな列に追加する</span></span>
<span>      .names <span class="op">=</span> <span class="st">"{.col}_perc"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## 特定の列のみを保持する（そして列名を変更）。</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"IRR"</span> <span class="op">=</span> <span class="va">estimate</span>, </span>
<span>         <span class="st">"95%CI low"</span> <span class="op">=</span> <span class="va">conf.low</span>, </span>
<span>         <span class="st">"95%CI high"</span> <span class="op">=</span> <span class="va">conf.high</span>,</span>
<span>         <span class="st">"Percentage change"</span> <span class="op">=</span> <span class="va">estimate_perc</span>, </span>
<span>         <span class="st">"95%CI low (perc)"</span> <span class="op">=</span> <span class="va">conf.low_perc</span>, </span>
<span>         <span class="st">"95%CI high (perc)"</span> <span class="op">=</span> <span class="va">conf.high_perc</span>,</span>
<span>         <span class="st">"p-value"</span> <span class="op">=</span> <span class="va">p.value</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 1 × 7
##     IRR `95%CI low` `95%CI high` `Percentage change` 95%CI low…¹ 95%CI…² p-val…³
##   &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;               &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
## 1 0.936       0.874         1.00               -6.40       -12.6   0.306  0.0645
## # … with abbreviated variable names ¹​`95%CI low (perc)`, ²​`95%CI high (perc)`,
## #   ³​`p-value`</code></pre>
<p>前述のように、回帰の出力を視覚化できます。</p>
<div class="sourceCode" id="cb1166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">observed</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 観測されたケースの数を追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span>, colour <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## モデル推定値についての線を追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span>, col <span class="op">=</span> <span class="st">"Estimate"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 予測区間のバンドを追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, </span>
<span>                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 予測開始の場所を示すため、垂直線とラベルを追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span></span>
<span>           xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">intervention_week</span><span class="op">)</span>, </span>
<span>           linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"text"</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"Intervention"</span>, </span>
<span>           x <span class="op">=</span> <span class="va">intervention_week</span>, </span>
<span>           y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>           angle <span class="op">=</span> <span class="fl">90</span>, </span>
<span>           vjust <span class="op">=</span> <span class="fl">1</span></span>
<span>           <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 色を定義する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>                                 <span class="st">"Estimate"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## 伝統的なプロット（軸が黒で背景が白）を作成する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: Removed 13 row(s) containing missing values (geom_path).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/plot_interrupted-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="参考資料-16" class="section level2" number="23.9">
<h2>
<span class="header-section-number">23.9</span> 参考資料<a class="anchor" aria-label="anchor" href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99-16"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://otexts.com/fpp3/">forecasting: principles and practice textbook</a><br><a href="https://github.com/EPIET/TimeSeriesAnalysis">EPIET timeseries analysis case studies</a><br><a href="https://online.stat.psu.edu/stat510/lesson/1">Penn State course</a>
<a href="https://www.jstatsoft.org/article/view/v070i10">Surveillance package manuscript</a></p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="moving-average.html"><span class="header-section-number">22</span> 移動平均</a></div>
<div class="next"><a href="epidemic-models.html"><span class="header-section-number">24</span> エピデミックモデリング</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#time-series"><span class="header-section-number">23</span> 時系列分析とアウトブレイクの検出</a></li>
<li><a class="nav-link" href="#%E6%A6%82%E8%A6%B3"><span class="header-section-number">23.1</span> 概観</a></li>
<li>
<a class="nav-link" href="#%E6%BA%96%E5%82%99-14"><span class="header-section-number">23.2</span> 準備</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8-1">パッケージ</a></li>
<li><a class="nav-link" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%89">データのロード</a></li>
<li><a class="nav-link" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%81%8D%E3%82%8C%E3%81%84%E3%81%AB%E3%81%99%E3%82%8B">データをきれいにする</a></li>
<li><a class="nav-link" href="#%E5%A4%A9%E5%80%99%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89">天候データのダウンロード</a></li>
<li><a class="nav-link" href="#%E5%A4%A9%E5%80%99%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF">天候データの読み込み</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E6%99%82%E7%B3%BB%E5%88%97%E3%83%87%E3%83%BC%E3%82%BF"><span class="header-section-number">23.3</span> 時系列データ</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E9%87%8D%E8%A4%87">重複</a></li>
<li><a class="nav-link" href="#%E6%AC%A0%E6%90%8D%E5%80%A4-2">欠損値</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E8%A8%98%E8%BF%B0%E7%B5%B1%E8%A8%88"><span class="header-section-number">23.4</span> 記述統計</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#timeseries_moving">移動平均</a></li>
<li><a class="nav-link" href="#%E5%91%A8%E6%9C%9F%E6%80%A7">周期性</a></li>
<li><a class="nav-link" href="#%E5%88%86%E8%A7%A3">分解</a></li>
<li><a class="nav-link" href="#%E8%87%AA%E5%B7%B1%E7%9B%B8%E9%96%A2">自己相関</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E5%9B%9E%E5%B8%B0%E5%BC%8F%E3%81%AE%E5%BD%93%E3%81%A6%E3%81%AF%E3%82%81"><span class="header-section-number">23.5</span> 回帰式の当てはめ</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E3%83%95%E3%83%BC%E3%83%AA%E3%82%A8%E5%88%97">フーリエ列</a></li>
<li><a class="nav-link" href="#%E8%B2%A0%E3%81%AE%E4%BA%8C%E9%A0%85%E5%9B%9E%E5%B8%B0">負の二項回帰</a></li>
<li><a class="nav-link" href="#%E6%AE%8B%E5%B7%AE">残差</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E3%81%A4%E3%81%AE%E6%99%82%E7%B3%BB%E5%88%97%E3%81%AE%E9%96%A2%E4%BF%82%E6%80%A7"><span class="header-section-number">23.6</span> 2つの時系列の関係性</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88%E3%81%AE%E3%83%9E%E3%83%BC%E3%82%B8">データセットのマージ</a></li>
<li><a class="nav-link" href="#%E8%A8%98%E8%BF%B0%E7%B5%B1%E8%A8%88-1">記述統計</a></li>
<li><a class="nav-link" href="#%E3%83%A9%E3%82%B0%E3%81%A8%E7%9B%B8%E4%BA%92%E7%9B%B8%E9%96%A2">ラグと相互相関</a></li>
<li><a class="nav-link" href="#%E5%A4%89%E6%95%B0%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E8%B2%A0%E3%81%AE%E4%BA%8C%E9%A0%85%E5%88%86%E5%B8%83">2変数における負の二項分布</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E3%82%A2%E3%82%A6%E3%83%88%E3%83%96%E3%83%AC%E3%82%A4%E3%82%AF"><span class="header-section-number">23.7</span> アウトブレイク</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#trending-%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8">trending パッケージ</a></li>
<li><a class="nav-link" href="#surveillance-%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8">surveillance パッケージ</a></li>
</ul>
</li>
<li><a class="nav-link" href="#%E4%B8%AD%E6%96%AD%E3%81%95%E3%82%8C%E3%81%9F%E6%99%82%E7%B3%BB%E5%88%97"><span class="header-section-number">23.8</span> 中断された時系列</a></li>
<li><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99-16"><span class="header-section-number">23.9</span> 参考資料</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>疫学のための R ハンドブック</strong>" was written by the handbook team. It was last built on 2022-10-11.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
