<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>14 データの結合 | 疫学のための R ハンドブック</title>
<meta name="author" content="the handbook team">
<meta name="description" content="上の図は、左結合（left join） のアニメーション例（画像提供元） この章では、データフレームを “join”、“match”、“link”、“bind” する方法やその他の方法で結合する方法について説明します。 疫学分析またはワークフローには、複数のデータソースと複数のデータセットのリンクが含まれるのが一般的です。患者の検査結果と臨床所見や、Google...">
<meta name="generator" content="bookdown 0.29 with bs4_book()">
<meta property="og:title" content="14 データの結合 | 疫学のための R ハンドブック">
<meta property="og:type" content="book">
<meta property="og:description" content="上の図は、左結合（left join） のアニメーション例（画像提供元） この章では、データフレームを “join”、“match”、“link”、“bind” する方法やその他の方法で結合する方法について説明します。 疫学分析またはワークフローには、複数のデータソースと複数のデータセットのリンクが含まれるのが一般的です。患者の検査結果と臨床所見や、Google...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="14 データの結合 | 疫学のための R ハンドブック">
<meta name="twitter:description" content="上の図は、左結合（left join） のアニメーション例（画像提供元） この章では、データフレームを “join”、“match”、“link”、“bind” する方法やその他の方法で結合する方法について説明します。 疫学分析またはワークフローには、複数のデータソースと複数のデータセットのリンクが含まれるのが一般的です。患者の検査結果と臨床所見や、Google...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.0/transition.js"></script><script src="libs/bs3compat-0.4.0/tabs.js"></script><script src="libs/bs3compat-0.4.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.25/datatables.js"></script><link href="libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/tabwid-1.1.0/tabwid.css" rel="stylesheet">
<link href="libs/tabwid-1.1.0/scrool.css" rel="stylesheet">
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.9/grViz.js"></script><script src="libs/d3-4.5.0/d3.min.js"></script><script src="libs/sankey-1/sankey.js"></script><script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script><script src="libs/plotly-binding-4.10.0/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-2.5.1/plotly-latest.min.js"></script><link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="libs/vis-9.1.0/vis-network.min.js"></script><script src="libs/visNetwork-binding-2.1.0/visNetwork.js"></script><link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="libs/plotly-basic-2.5.1/plotly-basic-2.5.1.min.js"></script><script src="libs/plotly-cartesian-2.5.1/plotly-cartesian-2.5.1.min.js"></script><script src="libs/proj4js-2.3.15/proj4.js"></script><link href="libs/highcharts-9.3.1/css/motion.css" rel="stylesheet">
<script src="libs/highcharts-9.3.1/highcharts.js"></script><script src="libs/highcharts-9.3.1/highcharts-3d.js"></script><script src="libs/highcharts-9.3.1/highcharts-more.js"></script><script src="libs/highcharts-9.3.1/modules/stock.js"></script><script src="libs/highcharts-9.3.1/modules/map.js"></script><script src="libs/highcharts-9.3.1/modules/data.js"></script><script src="libs/highcharts-9.3.1/modules/exporting.js"></script><script src="libs/highcharts-9.3.1/modules/offline-exporting.js"></script><script src="libs/highcharts-9.3.1/modules/drilldown.js"></script><script src="libs/highcharts-9.3.1/modules/item-series.js"></script><script src="libs/highcharts-9.3.1/modules/overlapping-datalabels.js"></script><script src="libs/highcharts-9.3.1/modules/annotations.js"></script><script src="libs/highcharts-9.3.1/modules/export-data.js"></script><script src="libs/highcharts-9.3.1/modules/funnel.js"></script><script src="libs/highcharts-9.3.1/modules/heatmap.js"></script><script src="libs/highcharts-9.3.1/modules/treemap.js"></script><script src="libs/highcharts-9.3.1/modules/sankey.js"></script><script src="libs/highcharts-9.3.1/modules/dependency-wheel.js"></script><script src="libs/highcharts-9.3.1/modules/organization.js"></script><script src="libs/highcharts-9.3.1/modules/solid-gauge.js"></script><script src="libs/highcharts-9.3.1/modules/streamgraph.js"></script><script src="libs/highcharts-9.3.1/modules/sunburst.js"></script><script src="libs/highcharts-9.3.1/modules/vector.js"></script><script src="libs/highcharts-9.3.1/modules/wordcloud.js"></script><script src="libs/highcharts-9.3.1/modules/xrange.js"></script><script src="libs/highcharts-9.3.1/modules/tilemap.js"></script><script src="libs/highcharts-9.3.1/modules/venn.js"></script><script src="libs/highcharts-9.3.1/modules/gantt.js"></script><script src="libs/highcharts-9.3.1/modules/timeline.js"></script><script src="libs/highcharts-9.3.1/modules/parallel-coordinates.js"></script><script src="libs/highcharts-9.3.1/modules/bullet.js"></script><script src="libs/highcharts-9.3.1/modules/coloraxis.js"></script><script src="libs/highcharts-9.3.1/modules/dumbbell.js"></script><script src="libs/highcharts-9.3.1/modules/lollipop.js"></script><script src="libs/highcharts-9.3.1/modules/series-label.js"></script><script src="libs/highcharts-9.3.1/plugins/motion.js"></script><script src="libs/highcharts-9.3.1/custom/reset.js"></script><script src="libs/highcharts-9.3.1/modules/boost.js"></script><script src="libs/highchart-binding-0.9.4/highchart.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QXDW878QLX');
    </script><script type="text/javascript">
        // window.addEventListener("load", function() {
        //     document.getElementById('toc').firstChild.innerHTML = "章目次"; 
        // });
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementsByClassName("d-flex align-items-start justify-content-between")[0].children[0].children[0].innerHTML = "疫学のための R</br>ハンドブック";
            document.getElementById('toc').firstChild.innerHTML = "章目次"; 
            document.getElementById('main-nav').children[1].firstChild.innerHTML = "総目次";
            document.getElementById('search').setAttribute("placeholder", "検索");
        });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style_bs4.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">疫学のための R ハンドブック</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"></a></li>
<li class="book-part">本書について</li>
<li><a class="" href="editorial-style.html"><span class="header-section-number">1</span> 編集前記・技術注記</a></li>
<li><a class="" href="data-used.html"><span class="header-section-number">2</span> ハンドブックとデータのダウンロード</a></li>
<li class="book-part">基本編</li>
<li><a class="" href="basics.html"><span class="header-section-number">3</span> R の基礎</a></li>
<li><a class="" href="transition-to-R.html"><span class="header-section-number">4</span> Excel・Stata・SASとの比較</a></li>
<li><a class="" href="packages-suggested.html"><span class="header-section-number">5</span> 推奨パッケージ</a></li>
<li><a class="" href="r-projects.html"><span class="header-section-number">6</span> R プロジェクト</a></li>
<li><a class="" href="importing.html"><span class="header-section-number">7</span> データのインポート・エクスポート</a></li>
<li class="book-part">データマネジメント</li>
<li><a class="" href="cleaning.html"><span class="header-section-number">8</span> データクリーニングと主要関数</a></li>
<li><a class="" href="dates.html"><span class="header-section-number">9</span> 日付型データ</a></li>
<li><a class="" href="characters-strings.html"><span class="header-section-number">10</span> 文字型・文字列型データ</a></li>
<li><a class="" href="factors.html"><span class="header-section-number">11</span> 因子（ファクタ）型データ</a></li>
<li><a class="" href="pivoting.html"><span class="header-section-number">12</span> データの縦横変換</a></li>
<li><a class="" href="grouping.html"><span class="header-section-number">13</span> データのグループ化</a></li>
<li><a class="active" href="joining-matching.html"><span class="header-section-number">14</span> データの結合</a></li>
<li><a class="" href="deduplication.html"><span class="header-section-number">15</span> 重複データの排除</a></li>
<li><a class="" href="iteration.html"><span class="header-section-number">16</span> ループと反復処理・リストの操作</a></li>
<li class="book-part">データ分析</li>
<li><a class="" href="tables-descriptive.html"><span class="header-section-number">17</span> 記述統計表の作り方</a></li>
<li><a class="" href="stat-tests.html"><span class="header-section-number">18</span> 基本的な統計的検定</a></li>
<li><a class="" href="regression.html"><span class="header-section-number">19</span> 単変量と多変量回帰</a></li>
<li><a class="" href="missing-data.html"><span class="header-section-number">20</span> データの欠損</a></li>
<li><a class="" href="standardization.html"><span class="header-section-number">21</span> 標準化率</a></li>
<li><a class="" href="moving-average.html"><span class="header-section-number">22</span> 移動平均</a></li>
<li><a class="" href="time-series.html"><span class="header-section-number">23</span> 時系列分析とアウトブレイクの検出</a></li>
<li><a class="" href="epidemic-models.html"><span class="header-section-number">24</span> エピデミックモデリング</a></li>
<li><a class="" href="contact-tracing.html"><span class="header-section-number">25</span> 接触者の追跡</a></li>
<li><a class="" href="survey-analysis.html"><span class="header-section-number">26</span> 標本調査データ分析</a></li>
<li><a class="" href="survival-analysis.html"><span class="header-section-number">27</span> 生存時間解析</a></li>
<li><a class="" href="gis.html"><span class="header-section-number">28</span> GIS の基本</a></li>
<li class="book-part">データの可視化</li>
<li><a class="" href="tables-presentation.html"><span class="header-section-number">29</span> 見やすい表の作り方</a></li>
<li><a class="" href="ggplot-basics.html"><span class="header-section-number">30</span> ggplot の基本</a></li>
<li><a class="" href="ggplot-tips.html"><span class="header-section-number">31</span> ggplotのヒント</a></li>
<li><a class="" href="epicurves.html"><span class="header-section-number">32</span> 流行曲線（エピカーブ）</a></li>
<li><a class="" href="age-pyramid.html"><span class="header-section-number">33</span> 人口ピラミッドとリッカート尺度</a></li>
<li><a class="" href="heatmaps.html"><span class="header-section-number">34</span> ヒートマップ</a></li>
<li><a class="" href="diagrams.html"><span class="header-section-number">35</span> フローチャート・サンキー図・タイムライン</a></li>
<li><a class="" href="combination-analysis.html"><span class="header-section-number">36</span> 複数回答データの分析</a></li>
<li><a class="" href="transmission-chains.html"><span class="header-section-number">37</span> 感染連鎖</a></li>
<li><a class="" href="phylogenetic-trees.html"><span class="header-section-number">38</span> 系統樹</a></li>
<li><a class="" href="interactive-plots.html"><span class="header-section-number">39</span> 動的な図の作成</a></li>
<li class="book-part">レポートとダッシュボード</li>
<li><a class="" href="rmarkdown.html"><span class="header-section-number">40</span> R Markdown で作るレポート</a></li>
<li><a class="" href="reportfactory.html"><span class="header-section-number">41</span> ルーチンで作成するレポートの整理</a></li>
<li><a class="" href="flexdashboard.html"><span class="header-section-number">42</span> R Markdownで作るダッシュボード</a></li>
<li><a class="" href="shiny-basics.html"><span class="header-section-number">43</span> Shiny で作るダッシュボード</a></li>
<li class="book-part">その他</li>
<li><a class="" href="writing-functions.html"><span class="header-section-number">44</span> 関数の作成</a></li>
<li><a class="" href="directories.html"><span class="header-section-number">45</span> ディレクトリの操作</a></li>
<li><a class="" href="collaboration.html"><span class="header-section-number">46</span> Git と Github を使ったバージョン管理と共同作業</a></li>
<li><a class="" href="errors.html"><span class="header-section-number">47</span> よくあるエラー</a></li>
<li><a class="" href="help.html"><span class="header-section-number">48</span> ヘルプ</a></li>
<li><a class="" href="network-drives.html"><span class="header-section-number">49</span> ネットワークドライブで R を使用する場合</a></li>
<li><a class="" href="data-table.html"><span class="header-section-number">50</span> data.table パッケージを使用したデータ処理</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="joining-matching" class="section level1" number="14">
<h1>
<span class="header-section-number">14</span> データの結合<a class="anchor" aria-label="anchor" href="#joining-matching"><i class="fas fa-link"></i></a>
</h1>
<div class="inline-figure"><img src="images/left-join.gif" width="50%"></div>
<p><u>上の図は、左結合（left join） のアニメーション例（</u><a href="https://github.com/gadenbuie/tidyexplain/tree/master/images">画像提供元</a><u>）</u></p>
<p>この章では、データフレームを “join”、“match”、“link”、“bind” する方法やその他の方法で結合する方法について説明します。</p>
<p>疫学分析またはワークフローには、複数のデータソースと複数のデータセットのリンクが含まれるのが一般的です。患者の検査結果と臨床所見や、Google モビリティデータと感染症トレンドを紐づけたり、またはある段階の分析に使用されたデータセットと変換後のデータセットをリンクさせることが必要な場合があります。</p>
<p>この章では、以下のコードを紹介します。</p>
<ul>
<li>識別子の列で共通の値に基づいて行が一致するように、2 つのデータフレームを<u>結合</u>する<br>
</li>
<li>値どうしの「<u>確率的</u>マッチング（“probabilistic matches”）」（可能性が高い一致）に基づいて 2 つのデータフレームを結合する<br>
</li>
<li>別のデータフレームから行または列を直接<u>結合</u>または “appending（追加）” し、データフレームを拡張する</li>
</ul>
<!-- ======================================================= --><div id="準備-5" class="section level2" number="14.1">
<h2>
<span class="header-section-number">14.1</span> 準備<a class="anchor" aria-label="anchor" href="#%E6%BA%96%E5%82%99-5"><i class="fas fa-link"></i></a>
</h2>
<div id="パッケージを読み込む" class="section level3 unnumbered">
<h3>パッケージを読み込む<a class="anchor" aria-label="anchor" href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80"><i class="fas fa-link"></i></a>
</h3>
<p>以下のコードを実行すると、分析に必要なパッケージが読み込まれます。このハンドブックでは、パッケージを読み込むために、<strong>pacman</strong> パッケージの <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load()</a></code> を主に使用しています。<code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load()</a></code> は、必要に応じてパッケージをインストールし、現在の R セッションで使用するためにパッケージを読み込む関数です。また、すでにインストールされたパッケージは、R の基本パッケージである <strong>base</strong> の <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> を使用して読み込むこともできます。R パッケージの詳細については、<a href="basics.html#basics">R の基礎</a> の章を参照してください。</p>
<div class="sourceCode" id="cb667"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">rio</span>,            <span class="co"># ファイルのインポートとエクスポート</span></span>
<span>  <span class="va">here</span>,           <span class="co"># ファイルを探す </span></span>
<span>  <span class="va">tidyverse</span>,      <span class="co"># データ管理と可視化</span></span>
<span>  <span class="va">RecordLinkage</span>,  <span class="co"># 確率的マッチング</span></span>
<span>  <span class="va">fastLink</span>        <span class="co"># 確率的マッチング</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div id="データのインポート-6" class="section level3 unnumbered">
<h3>データのインポート<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88-6"><i class="fas fa-link"></i></a>
</h3>
<p>エボラ出血熱の流行をシミュレートしたデータセットをインポートします。お手元の環境でこの章の内容を実行したい方は、<a href="https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/case_linelists/linelist_cleaned.rds" class="download-button">こちら</a> をクリックして「前処理された」ラインリスト（linelist）をダウンロードしてください（.rds 形式で取得できます）。 データは <strong>rio</strong> パッケージの <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> を利用してインポートしましょう（<code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> は、.xlsx、.csv、.rdsなど、様々な形式のファイルを扱うことができます）。インポートの詳細については、<a href="importing.html#importing">データのインポート・エクスポート</a> の章を参照してください。</p>
<div class="sourceCode" id="cb668"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 症例ラインリストをインポートする </span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"linelist_cleaned.rds"</span><span class="op">)</span></span></code></pre></div>
<p>ラインリストの最初の 50 行を以下に表示します。</p>
<div id="htmlwidget-5c65ae1ede222aa62480" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5c65ae1ede222aa62480">{"x":{"filter":"top","vertical":false,"filterHTML":"<tr>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"2\" data-max=\"13\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1399075200000\" data-max=\"1406419200000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1399939200000\" data-max=\"1407024000000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1400025600000\" data-max=\"1407110400000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1400371200000\" data-max=\"1410566400000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"67\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\" disabled=\"\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"67\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"factor\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"width: 100%; display: none;\">\n      <select multiple=\"multiple\" style=\"width: 100%;\" data-options=\"[&quot;0-4&quot;,&quot;5-9&quot;,&quot;10-14&quot;,&quot;15-19&quot;,&quot;20-29&quot;,&quot;30-49&quot;,&quot;50-69&quot;,&quot;70+&quot;]\"><\/select>\n    <\/div>\n  <\/td>\n  <td data-type=\"factor\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"width: 100%; display: none;\">\n      <select multiple=\"multiple\" style=\"width: 100%;\" data-options=\"[&quot;0-4&quot;,&quot;5-9&quot;,&quot;10-14&quot;,&quot;15-19&quot;,&quot;20-24&quot;,&quot;25-29&quot;,&quot;30-34&quot;,&quot;35-39&quot;,&quot;40-44&quot;,&quot;45-49&quot;,&quot;50-54&quot;,&quot;55-59&quot;,&quot;60-64&quot;,&quot;65-69&quot;,&quot;70-74&quot;,&quot;75-79&quot;,&quot;80-84&quot;,&quot;85+&quot;]\"><\/select>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"-13.2697246824573\" data-max=\"-13.209391925612\" data-scale=\"13\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"8.45171855856465\" data-max=\"8.48802917129884\" data-scale=\"14\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"100\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"11\" data-max=\"241\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"20\" data-max=\"24\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"35.9\" data-max=\"38\" data-scale=\"1\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"428.994082840237\" data-scale=\"14\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"2\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],[4,4,2,3,3,3,4,4,4,4,4,4,6,5,6,9,10,8,7,6,7,6,8,6,10,8,6,12,5,8,7,9,11,5,8,5,6,11,7,9,7,8,9,12,13,9,8,10,8,7],["2014-05-08",null,null,"2014-05-04","2014-05-18","2014-05-03","2014-05-22","2014-05-28",null,null,"2014-05-30","2014-05-28","2014-06-14","2014-06-07","2014-06-09",null,null,null,"2014-06-23","2014-06-18","2014-06-24",null,null,"2014-07-03",null,"2014-07-10","2014-06-14",null,"2014-06-18","2014-06-29","2014-07-02","2014-07-12","2014-07-12","2014-06-13","2014-07-15","2014-06-20",null,null,"2014-07-20",null,"2014-07-12","2014-07-19","2014-07-18","2014-07-18","2014-07-27",null,"2014-07-19","2014-07-26","2014-07-24",null],["2014-05-13","2014-05-13","2014-05-16","2014-05-18","2014-05-21","2014-05-22","2014-05-27","2014-06-02","2014-06-05","2014-06-05","2014-06-06","2014-06-13","2014-06-16","2014-06-17","2014-06-18","2014-06-19","2014-06-22","2014-06-23","2014-06-25","2014-06-26","2014-06-28","2014-07-02","2014-07-08","2014-07-09","2014-07-09","2014-07-10","2014-07-12","2014-07-12","2014-07-13","2014-07-13","2014-07-14","2014-07-15","2014-07-16","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-22","2014-07-22","2014-07-24","2014-07-24","2014-07-25","2014-07-25","2014-07-27","2014-07-29","2014-07-30",null,"2014-08-01","2014-08-02","2014-08-03"],["2014-05-15","2014-05-14","2014-05-18","2014-05-20","2014-05-22","2014-05-23","2014-05-29","2014-06-03","2014-06-06","2014-06-07","2014-06-08","2014-06-15","2014-06-17","2014-06-17","2014-06-20","2014-06-19","2014-06-23","2014-06-24","2014-06-27","2014-06-28","2014-06-29","2014-07-03","2014-07-09","2014-07-09","2014-07-11","2014-07-11","2014-07-13","2014-07-14","2014-07-14","2014-07-13","2014-07-14","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-20","2014-07-20","2014-07-22","2014-07-24","2014-07-26","2014-07-24","2014-07-27","2014-07-25","2014-07-27","2014-07-31","2014-08-01","2014-08-03","2014-08-02","2014-08-02","2014-08-04"],[null,"2014-05-18","2014-05-30",null,"2014-05-29","2014-05-24","2014-06-01","2014-06-07","2014-06-18","2014-06-09","2014-06-15",null,"2014-07-09",null,"2014-06-30","2014-07-11","2014-07-01","2014-06-25","2014-07-06","2014-07-02","2014-07-09","2014-07-07","2014-07-20",null,"2014-07-22","2014-07-16","2014-07-14","2014-07-20","2014-07-16","2014-07-19","2014-07-27","2014-07-19",null,"2014-07-26","2014-08-14","2014-08-01","2014-07-23","2014-08-28","2014-07-28","2014-07-19",null,"2014-08-03",null,null,null,"2014-08-06","2014-08-21","2014-09-13","2014-08-04",null],[null,"Recover","Recover",null,"Recover","Recover","Recover","Death","Recover","Death","Death","Death","Recover","Recover",null,"Recover",null,null,"Death","Death","Recover",null,null,null,"Death",null,"Death","Death",null,"Death","Recover","Death","Recover","Death","Recover",null,"Death","Recover","Recover","Death",null,null,"Death","Death","Death","Death","Recover",null,"Death","Death"],["m","f","m","f","m","f","f","f","m","f","m","m","m","f","f","m","f","f","f","f","m","m","f","m","f","m","m","f","m","f","f","f","m","m","f","m","f","f","f","m","f","m","f","m","m","f","m","f","m","m"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["0-4","0-4","50-69","15-19","0-4","15-19","15-19","0-4","50-69","20-29","10-14","30-49","15-19","5-9","5-9","10-14","30-49","15-19","10-14","10-14","15-19","50-69","10-14","20-29","5-9","0-4","30-49","5-9","50-69","10-14","10-14","20-29","20-29","30-49","0-4","10-14","0-4","15-19","20-29","30-49","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-29","20-29","10-14"],["0-4","0-4","55-59","15-19","0-4","15-19","15-19","0-4","60-64","25-29","10-14","40-44","15-19","5-9","5-9","10-14","35-39","15-19","10-14","10-14","15-19","50-54","10-14","25-29","5-9","0-4","30-34","5-9","65-69","10-14","10-14","20-24","20-24","45-49","0-4","10-14","0-4","15-19","20-24","35-39","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-24","25-29","10-14"],["Other","Missing","St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Port Hospital","Missing","Missing","Missing","Missing","Port Hospital","Military Hospital","Missing","Missing","Other","Port Hospital","Port Hospital","Port Hospital","Missing","Other","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)","Missing","Other","Missing","St. Mark's Maternity Hospital (SMMH)","Military Hospital","Port Hospital","Central Hospital","Military Hospital","Central Hospital","Missing","Military Hospital","Other","Missing","Missing","Port Hospital","Port Hospital","Port Hospital","Missing","Central Hospital","Military Hospital","Other","Other","Other","Missing","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","Missing"],[-13.2157351064963,-13.2152339775486,-13.212910703914,-13.2363711169728,-13.2228638912441,-13.222625321098,-13.2331547837254,-13.2320975453153,-13.2225511595637,-13.2572163655863,-13.2206286746001,-13.253989309478,-13.2385127873491,-13.209391925612,-13.2157278814899,-13.2243437095992,-13.2336087079551,-13.21422143145,-13.2339681355349,-13.2535640411465,-13.2250089377786,-13.2160657166043,-13.2680671272333,-13.2266742923612,-13.2160179088168,-13.2482584611565,-13.2156319199566,-13.2142410663192,-13.2614879104088,-13.2452992638476,-13.2630592726116,-13.2343341712241,-13.2199077448676,-13.2227293309912,-13.2343062806506,-13.218781651651,-13.2483677722899,-13.2097478342339,-13.2680867723786,-13.2587535457526,-13.262635786914,-13.2697246824573,-13.2209026809759,-13.2330734719715,-13.2680923666905,-13.2547212675054,-13.2573683214693,-13.2137356012883,-13.2175973322257,-13.2486407324245],[8.46897295100924,8.45171855856465,8.46481700596819,8.4754761613651,8.46082377490923,8.46183062600728,8.46272931462646,8.46144367534271,8.46191259217774,8.47292327643506,8.48401630165138,8.45837125340844,8.47761705512509,8.47570184950483,8.47779946878972,8.47145134147474,8.47804840685363,8.48528034195779,8.46957530395867,8.45957352078114,8.47404889511544,8.48802917129884,8.473437335922,8.48408263734462,8.46242233645879,8.47026822126572,8.46398447480533,8.4641347894342,8.45623094629607,8.48334624336805,8.47493999153642,8.47832062438022,8.4693933891765,8.48480589906514,8.47121232619015,8.48438437371817,8.48466158574339,8.47714159984428,8.46238127010609,8.45568597813113,8.4632880274758,8.47940722413856,8.46353857052336,8.46178968158864,8.47508713872833,8.45825808128071,8.4532568143863,8.4732571907655,8.47911586641933,8.48480340615605],["f547d6",null,null,"f90f5f","11f8ea","aec8ec","893f25","133ee7",null,null,"996f3a","133ee7","37a6f6","9f6884","4802b1",null,null,null,"a75c7f","8e104d","ab634e",null,null,"b799eb",null,"5d9e4d","a15e13",null,"ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277",null,null,"d6584f",null,"312ecf","52ea64","cfd79c","d145b7","174288",null,"53608c","3b096b","f5c142",null],["other",null,null,"other","other","other","other","other",null,null,"other","other","other","other","other",null,null,null,"other","other","other",null,null,"other",null,"other","other",null,"other","funeral","other","funeral","other","other","other","funeral",null,null,"other",null,"other","other","other","other","other",null,"funeral","other","other",null],[27,25,91,41,36,56,47,0,86,69,67,84,68,44,34,66,78,47,53,47,71,86,53,69,38,46,68,37,100,56,50,57,65,72,29,69,37,48,54,71,47,61,47,35,53,16,13,59,69,67],[48,59,238,135,71,116,87,11,226,174,112,186,174,90,91,152,214,137,117,131,150,241,131,161,80,69,188,66,233,142,110,182,164,214,26,157,39,154,133,168,100,125,123,67,134,31,36,125,183,169],[22,22,21,23,23,21,21,22,22,22,22,22,22,21,23,22,23,21,22,23,21,23,21,24,23,22,24,23,20,24,24,20,24,21,22,21,23,22,23,23,23,22,23,22,22,22,23,22,22,22],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","no","no","no","no","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","yes","no",null,"no","no","no","yes","no",null,"no","no","yes",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","yes","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","yes","yes","yes","yes","yes","yes","yes","yes","yes",null,"yes","yes","yes","yes","yes",null,"yes","yes","yes",null,null,"yes","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","yes","yes","yes","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","yes","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"yes","yes",null,"no","no",null,"no","no","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","no","yes","no","no","no","yes","no","no","no",null,"no","yes","no","no","no",null,"no","no","no",null,null,"no","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","no","yes","yes","yes",null],[36.8,36.9,36.9,36.8,36.9,37.6,37.3,37,36.4,35.9,36.5,36.9,36.5,37.1,36.5,37.3,37,38,38,36,37,36.7,36.9,36.5,37,36.5,37.6,36.6,36.6,36.2,36.4,37.1,37.5,37.5,37.4,36.9,36.4,37.3,37,37.8,36.5,37.5,36.7,37,37.3,36.6,36.5,36.6,37.6,36.8],[null,"09:36","16:48","11:22","12:60","14:13","14:33","09:25","11:16","10:55","16:03","11:14","12:42","11:06","09:10","08:45",null,"15:41","13:34","18:58","12:43","16:33","14:29","07:18","08:11","16:32","16:17","07:32","17:45",null,"13:24","14:43","02:33","11:36","17:28","16:27",null,"20:49",null,"11:38","14:25","13:42","21:22","13:33","19:06","17:14","20:09",null,"10:23","09:09"],[117.1875,71.8184429761563,16.0652496292635,22.4965706447188,71.4144019043841,41.6171224732461,62.0953890870657,0,16.8376536925366,22.7903289734443,53.4119897959184,24.2802636142907,22.4600343506408,54.320987654321,41.0578432556455,28.5664819944598,17.0320552013276,25.0412914912888,38.7172182043977,27.3876813705495,31.5555555555556,14.8069075945662,30.8839811199813,26.6193433895297,59.375,96.6183574879227,19.2394748755093,84.9403122130395,18.4199377406104,27.7722674072605,41.3223140495868,17.2080666586161,24.1671624033314,15.7218971089178,428.994082840237,27.9930220292912,243.261012491782,20.2395007589813,30.527446435638,25.15589569161,47,39.04,31.0661643201798,77.9683671196257,29.5165961238583,166.493236212279,100.308641975309,37.76,20.6037803457852,23.458562375267],[2,1,2,2,1,1,2,1,1,2,2,2,1,0,2,0,1,1,2,2,1,1,1,0,2,1,1,2,1,0,0,2,1,1,2,2,1,0,2,2,0,2,0,0,2,2,null,1,0,1]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>generation<\/th>\n      <th>date_infection<\/th>\n      <th>date_onset<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>date_outcome<\/th>\n      <th>outcome<\/th>\n      <th>gender<\/th>\n      <th>age<\/th>\n      <th>age_unit<\/th>\n      <th>age_years<\/th>\n      <th>age_cat<\/th>\n      <th>age_cat5<\/th>\n      <th>hospital<\/th>\n      <th>lon<\/th>\n      <th>lat<\/th>\n      <th>infector<\/th>\n      <th>source<\/th>\n      <th>wt_kg<\/th>\n      <th>ht_cm<\/th>\n      <th>ct_blood<\/th>\n      <th>fever<\/th>\n      <th>chills<\/th>\n      <th>cough<\/th>\n      <th>aches<\/th>\n      <th>vomit<\/th>\n      <th>temp<\/th>\n      <th>time_admission<\/th>\n      <th>bmi<\/th>\n      <th>days_onset_hosp<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,8,10,14,15,18,19,20,26,28,29]}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><!-- ======================================================= -->
</div>
<div id="サンプルデータセット" class="section level3 unnumbered">
<h3>サンプルデータセット<a class="anchor" aria-label="anchor" href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88"><i class="fas fa-link"></i></a>
</h3>
<p>以下の「データの結合」セクションでは、次のデータセットを使用します。</p>
<ol style="list-style-type: decimal">
<li>
<code>case_id</code>、<code>date_onset</code>、<code>hospital</code> の列で最初の 10 行のみを含む、<code>linelist</code> データセットの小型版。<br>
</li>
<li>各病院の詳細な情報を含む、 <code>hosp_info</code> という名前の別のデータフレーム。</li>
</ol>
<p>「確率的マッチング」のセクションでは、2 種類の小さなデータセットを使用しますが、データセットを作成するためのコードはセクション内に記載されています。</p>
<div id="joins_llmini" class="section level4 unnumbered">
<h4>小型版の症例ラインリスト<a class="anchor" aria-label="anchor" href="#joins_llmini"><i class="fas fa-link"></i></a>
</h4>
<p>以下は小型版の症例のラインリストで、<code>case_id</code>、<code>date_onset</code>、<code>hospital</code> の列の最初の10行のみが含まれています。</p>
<div class="sourceCode" id="cb669"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist_mini</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                 <span class="co"># 元のラインリストから始める</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">case_id</span>, <span class="va">date_onset</span>, <span class="va">hospital</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>   <span class="co"># 列を選択</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>                                    <span class="co"># 最初の10行のみを取得します</span></span></code></pre></div>
<div id="htmlwidget-6f5d01c266595eb8a40d" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6f5d01c266595eb8a40d">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca"],["2014-05-13","2014-05-13","2014-05-16","2014-05-18","2014-05-21","2014-05-22","2014-05-27","2014-06-02","2014-06-05","2014-06-05"],["Other","Missing","St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Port Hospital","Missing","Missing","Missing","Missing"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>date_onset<\/th>\n      <th>hospital<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="joins_hosp_info" class="section level4 unnumbered">
<h4>病院情報データフレーム<a class="anchor" aria-label="anchor" href="#joins_hosp_info"><i class="fas fa-link"></i></a>
</h4>
<p>以下は、7 つの病院に関する追加情報（患者数、利用可能な医療レベル）を含むまったく別のデータフレームを作成するためのコードです。 なお、“Military Hospital” という名前の病院は 2 つあり、住民10000人を収容する一次病院と、住民 50280人を収容する二次病院の 2 つです。</p>
<div class="sourceCode" id="cb670"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 病院情報データフレームを作成する</span></span>
<span><span class="va">hosp_info</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  hosp_name     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"central hospital"</span>, <span class="st">"military"</span>, <span class="st">"military"</span>, <span class="st">"port"</span>, <span class="st">"St. Mark's"</span>, <span class="st">"ignace"</span>, <span class="st">"sisters"</span><span class="op">)</span>,</span>
<span>  catchment_pop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1950280</span>, <span class="fl">40500</span>, <span class="fl">10000</span>, <span class="fl">50280</span>, <span class="fl">12000</span>, <span class="fl">5000</span>, <span class="fl">4200</span><span class="op">)</span>,</span>
<span>  level         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Tertiary"</span>, <span class="st">"Secondary"</span>, <span class="st">"Primary"</span>, <span class="st">"Secondary"</span>, <span class="st">"Secondary"</span>, <span class="st">"Primary"</span>, <span class="st">"Primary"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>このデータフレームに含まれる病院は、以下の通りです。</p>
<div id="htmlwidget-58629bef2232b69b1ed7" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-58629bef2232b69b1ed7">{"x":{"filter":"none","vertical":false,"data":[["central hospital","military","military","port","St. Mark's","ignace","sisters"],[1950280,40500,10000,50280,12000,5000,4200],["Tertiary","Secondary","Primary","Secondary","Secondary","Primary","Primary"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>hosp_name<\/th>\n      <th>catchment_pop<\/th>\n      <th>level<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":7,"columnDefs":[{"className":"dt-right","targets":1}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[7,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><!-- ======================================================= -->
</div>
</div>
<div id="データの前処理" class="section level3 unnumbered">
<h3>データの前処理<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%89%8D%E5%87%A6%E7%90%86"><i class="fas fa-link"></i></a>
</h3>
<p>従来の結合（非確率的マッチング）では大文字と小文字が区別され、2 つのデータフレームを結合する際は、対象の文字が完全に一致する必要があります。以下では、<code>linelist_mini</code> データセットと <code>hosp_info</code> データセットの前処理を行いながら、結合する前に行わなければならない前処理（クリーニング）手順のいくつかについて説明します。</p>
<p><strong>違いを特定する</strong></p>
<p>データフレームの <code>hosp_name</code> 列の値は、<code>linelist_mini</code> データフレームの <code>hospital</code> 列の値と一致する必要があります。</p>
<p>以下に、<code>linelist_mini</code> データフレームの値を、<strong>base</strong> R の <code><a href="https://rdrr.io/r/base/unique.html">unique()</a></code> で表示します。</p>
<div class="sourceCode" id="cb671"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">linelist_mini</span><span class="op">$</span><span class="va">hospital</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "Other"                               
## [2] "Missing"                             
## [3] "St. Mark's Maternity Hospital (SMMH)"
## [4] "Port Hospital"                       
## [5] "Military Hospital"</code></pre>
<p>次に、<code>hosp_info</code> データフレームの値は以下の通りです。</p>
<div class="sourceCode" id="cb673"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">hosp_info</span><span class="op">$</span><span class="va">hosp_name</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "central hospital" "military"         "port"             "St. Mark's"      
## [5] "ignace"           "sisters"</code></pre>
<p>いくつかの病院は両方のデータフレームに存在しますが、スペルが異なっていることがわかります。</p>
<p><strong>値を揃える</strong></p>
<p>まず、<code>hosp_info</code> データフレームの値をクリーニングして整えます。<a href="cleaning.html#cleaning">データクリーニングと主要関数</a> の章で説明したように、<strong>dplyr</strong> の <code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code> を使用し、論理的な基準で値を再コード化することができます。両方のデータフレームに存在する 4 つの病院については、<code>linelist_mini</code> の値と一致するように値を変更します。 他の病院は、値を変更せずそのままにします（<code>TRUE ~ hosp_name</code>）。</p>
<p><span style="color: orange;"><u><strong>注意:</strong></u> 通常、クリーニングを行う場合は新しい列を作成して行うべきですが（例: <code>hosp_name_clean</code>）、今回の例では簡単にするため、新しく列を作成せずに古い列を修正します。</span></p>
<div class="sourceCode" id="cb675"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hosp_info</span> <span class="op">&lt;-</span> <span class="va">hosp_info</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    hosp_name <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="co"># 基準                             # 新しい値</span></span>
<span>      <span class="va">hosp_name</span> <span class="op">==</span> <span class="st">"military"</span>          <span class="op">~</span> <span class="st">"Military Hospital"</span>,</span>
<span>      <span class="va">hosp_name</span> <span class="op">==</span> <span class="st">"port"</span>              <span class="op">~</span> <span class="st">"Port Hospital"</span>,</span>
<span>      <span class="va">hosp_name</span> <span class="op">==</span> <span class="st">"St. Mark's"</span>        <span class="op">~</span> <span class="st">"St. Mark's Maternity Hospital (SMMH)"</span>,</span>
<span>      <span class="va">hosp_name</span> <span class="op">==</span> <span class="st">"central hospital"</span>  <span class="op">~</span> <span class="st">"Central Hospital"</span>,</span>
<span>      <span class="cn">TRUE</span>                             <span class="op">~</span> <span class="va">hosp_name</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>両方のデータフレームに存在する病院名が揃えられました。<code>linelist_mini</code> にはないが <code>hosp_info</code> にはある病院が 2 つありますが、これらは後に結合するステップで扱います。</p>
<div class="sourceCode" id="cb676"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">hosp_info</span><span class="op">$</span><span class="va">hosp_name</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "Central Hospital"                    
## [2] "Military Hospital"                   
## [3] "Port Hospital"                       
## [4] "St. Mark's Maternity Hospital (SMMH)"
## [5] "ignace"                              
## [6] "sisters"</code></pre>
<p>データフレームを結合する前に、列名をすべて小文字または大文字に変換すると、結合作業がより簡単になります。列のすべての値を大文字または小文字に変換する必要がある場合は、<a href="characters-strings.html#characters-strings">文字型・文字列型データ</a> の章で言及したように、<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> を使用して、さらに <strong>stringr</strong> の以下のいずれかの関数に変換したい列を適用します。</p>
<p><code><a href="https://stringr.tidyverse.org/reference/case.html">str_to_upper()</a></code><br><code><a href="https://stringr.tidyverse.org/reference/case.html">str_to_upper()</a></code><br><code><a href="https://stringr.tidyverse.org/reference/case.html">str_to_title()</a></code></p>
<!-- ======================================================= -->
</div>
</div>
<div id="dplyr-による結合" class="section level2" number="14.2">
<h2>
<span class="header-section-number">14.2</span> <strong>dplyr による結合</strong><a class="anchor" aria-label="anchor" href="#dplyr-%E3%81%AB%E3%82%88%E3%82%8B%E7%B5%90%E5%90%88"><i class="fas fa-link"></i></a>
</h2>
<p><strong>dplyr</strong> パッケージには、データを結合する様々な関数があります。<strong>dplyr</strong> は <strong>tidyverse</strong> パッケージに含まれます。以下に、データを結合する関数について、簡単な使用例とともに説明します。</p>
<p>有益な GIF を提供してくれた <a href="https://github.com/gadenbuie%E3%81%AB%E6%84%9F%E8%AC%9D%E3%81%97%E3%81%BE%E3%81%99%E3%80%82">&lt;https://github.com/gadenbuie&gt;</a> に感謝申し上げます。</p>
<!-- ======================================================= -->
<div id="一般的な構文" class="section level3 unnumbered">
<h3>一般的な構文<a class="anchor" aria-label="anchor" href="#%E4%B8%80%E8%88%AC%E7%9A%84%E3%81%AA%E6%A7%8B%E6%96%87"><i class="fas fa-link"></i></a>
</h3>
<p>結合のコマンドは、単一のコマンドとして実行して 2 つのデータフレームを新しいオブジェクトに結合することも、あるいは、パイプチェーン（<code>%&gt;%</code>）内で使用して、データクリーニングまたは変換の際に1つのデータフレームを別のデータフレームにマージ（併合）することもできます。</p>
<p>以下の例では、<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code> を単一コマンドとして使用し、新たに <code>joined_data</code> と名付けるデータフレームを作成します。 結合に使用されるデータはデータフレーム 1 と 2（<code>df1</code> と <code>df2</code> ）です。 前者のデータフレームがベースラインデータフレーム（基礎となるデータフレーム）であり、後者のデータフレームは前者のデータフレーム<u>に</u>結合されています。</p>
<p>3 番目の引数 <code>y =</code> では、2 つのデータフレームの行を揃えるために使用される各データフレームの列を指定します。 これらの列の名前が異なる場合は、以下に示すよう に <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> ベクトル内に指定してください。以下の例では、<code>df1</code> データフレームの <code>ID</code> 列と <code>df2</code> データフレームの <code>identifier</code> 列で共通している値に基づいて行が照合されます。</p>
<div class="sourceCode" id="cb678"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 列 "ID"（最初のデータフレーム）と列 "identifier"（2番目のデータフレーム）の間の共通の値に基づいて結合する</span></span>
<span><span class="va">joined_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">df1</span>, <span class="va">df2</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ID"</span> <span class="op">=</span> <span class="st">"identifier"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><code>by</code> で指定する列名が両方のデータフレームでまったく同じ名前である場合、その名前を引用符で囲んで指定できます。</p>
<div class="sourceCode" id="cb679"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 両方のデータフレームの列 "ID" の共通値に基づく結合</span></span>
<span><span class="va">joined_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">df1</span>, <span class="va">df2</span>, by <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span></span></code></pre></div>
<p>複数の列にわたる共通の値に基づいてデータフレームを結合する場合は、これらのフィールドを <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> ベクトル内で指定します。 この例では、各データフレームの 3 つの列の値が正確に一致している場合に行が結合されます。</p>
<div class="sourceCode" id="cb680"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 同じ名、姓、年齢に基づいて結合する</span></span>
<span><span class="va">joined_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">df1</span>, <span class="va">df2</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"name"</span> <span class="op">=</span> <span class="st">"firstname"</span>, <span class="st">"surname"</span> <span class="op">=</span> <span class="st">"lastname"</span>, <span class="st">"Age"</span> <span class="op">=</span> <span class="st">"age"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>コマンドは、パイプライン内で実行することもでき、その場合はパイプされるデータフレームが変更されます。</p>
<p>以下の例では、<code>df1</code> がパイプを通過し、<code>df2</code> がパイプに結合されるため、<code>df1</code> が変更され、再定義されます。</p>
<div class="sourceCode" id="cb681"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df1</span> <span class="op">&lt;-</span> <span class="va">df1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">date_onset</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2020-03-05"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># その他のクリーニング </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">df2</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ID"</span> <span class="op">=</span> <span class="st">"identifier"</span><span class="op">)</span><span class="op">)</span>    <span class="co"># df2 を df1 に結合</span></span></code></pre></div>
<p><span style="color: orange;"><u><strong>注意:</strong></u> 結合では、大文字と小文字が区別されます。したがって、結合する前にすべての値を小文字または大文字に変換しておくと便利です。変換方法の詳細は、<a href="characters-strings.html#characters-strings">文字型・文字列型データ</a>の章を参照ください。</span></p>
<!-- ======================================================= -->
</div>
<div id="左結合left-joinと右結合right-join" class="section level3 unnumbered">
<h3>左結合（left join）と右結合（right join）<a class="anchor" aria-label="anchor" href="#%E5%B7%A6%E7%B5%90%E5%90%88left-join%E3%81%A8%E5%8F%B3%E7%B5%90%E5%90%88right-join"><i class="fas fa-link"></i></a>
</h3>
<p><strong>左結合または右結合は、データフレームに情報を追加するためによく使用されます。</strong>つまり、新しい情報は、ベースラインデータフレーム（基礎となるデータフレーム）にすでに存在する行にのみ追加されます。 これらは疫学的研究において、あるデータセットから別のデータセットに情報を追加するために使われる一般的な結合です。</p>
<p>左結合または右結合を行う際は、コマンド内におけるデータフレームの順序が重要となります*。</p>
<ul>
<li>
<u>左結合</u>では、<u>最初に</u>書かれているデータフレームがベースラインです。<br>
</li>
<li>
<u>右結合</u>では、<u>2 番目に</u>書かれているデータフレームがベースラインです。</li>
</ul>
<p><strong>ベースラインデータフレームでは、結合後もすべての行が保持されます。</strong>二次データフレーム（ベースラインではないデータフレーム）の行は、<u>識別子として指定された列の値がベースラインデータフレームの識別子供と一致する場合にのみ</u>、ベースラインデータフレームに結合されます。加えて、</p>
<ul>
<li><p>一致しない二次データフレームの行は削除されます</p></li>
<li><p>二次データフレームの 1 行がベースラインデータフレームの複数の行と一致する場合（多対一）、ベースラインデータフレームの<u>各行に</u>その一致した二次データフレームの行が追加されます</p></li>
<li><p>ベースラインフレームの 1 行が二次データフレームの複数の行と一致する場合（一対多）、一致したすべての組み合わせが返されます。<em>つまり、</em><u>返されたデータフレームに新しい行が追加される可能性があります</u></p></li>
</ul>
<p>左結合と右結合のアニメーション例（<a href="https://github.com/gadenbuie/tidyexplain/tree/master/images">画像提供元</a>）</p>
<p><img src="images/left-join.gif" width="50%"><img src="images/right-join.gif" width="50%"></p>
<p><strong>例</strong></p>
<p>以下は、 <code>hosp_info</code> （二次データフレーム、<a href="joining-matching.html#joins_hosp_info">ここを参照</a>）を <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code> で<code>linelist_mini</code> （ベースラインデータフレーム、<a href="joining-matching.html#joins_llmini">ここを参照</a>）<u>に</u>左結合し、結果を出力したものです。元の <code>linelist_mini</code> の行数は 10 でした。以下に表示された左結合後の <code>linelist_mini</code> を、次の点に注意して確認してください。</p>
<ul>
<li>
<code>linelist_mini</code> の右側に 2 つの新しい列、 <code>catchment_pop</code> と <code>level</code> が追加されました<br>
</li>
<li>ベースラインデータフレーム <code>linelist_mini</code> の元の行はすべて保持されています<br>
</li>
<li>
<code>linelist_mini</code> 内に元からあった “Military Hospital” の一行は、二次データフレーム内の <u>2 行</u>と一致したため複製され、両方の組み合わせが出力されました<br>
</li>
<li>二次データフレームの結合識別子列（<code>hosp_name</code>）は、ベースラインデータフレームの識別子列（<code>hospital</code>）と重複しているため、削除されました<br>
</li>
<li>ベースラインデータフレームの行が二次データフレームのどの行とも一致しなかった場合（ここでは、 <code>hospital</code> 列の値が “Other” または “Missing” の場合）、<code>NA</code>（空白）が二次データフレームから追加された列に入力されます（ここでは、<code>catchment_pop</code> 列と <code>level</code> 列）<br>
</li>
<li>元のデータフレーム（“sisters” および “ignace” 病院）と一致しない二次データフレームの行は結合されませんでした</li>
</ul>
<div class="sourceCode" id="cb682"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist_mini</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">hosp_info</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"hospital"</span> <span class="op">=</span> <span class="st">"hosp_name"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-9f0d0a8cc4bea13fa671" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-9f0d0a8cc4bea13fa671">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","11f8ea","b8812a","893f25","893f25","be99c8","07e3e8","369449","f393b4","1389ca"],["2014-05-13","2014-05-13","2014-05-16","2014-05-18","2014-05-21","2014-05-21","2014-05-22","2014-05-27","2014-06-02","2014-06-05","2014-06-05"],["Other","Missing","St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Military Hospital","Port Hospital","Missing","Missing","Missing","Missing"],[null,null,12000,50280,40500,10000,50280,null,null,null,null],[null,null,"Secondary","Secondary","Secondary","Primary","Secondary",null,null,null,null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>date_onset<\/th>\n      <th>hospital<\/th>\n      <th>catchment_pop<\/th>\n      <th>level<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":11,"columnDefs":[{"className":"dt-right","targets":3}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[10,11,25,50,100]}},"evals":[],"jsHooks":[]}</script><div id="右結合を使用するべきかまたは左結合を使用するべきか" class="section level4 unnumbered">
<h4>右結合を使用するべきか、または左結合を使用するべきか？<a class="anchor" aria-label="anchor" href="#%E5%8F%B3%E7%B5%90%E5%90%88%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%81%B9%E3%81%8D%E3%81%8B%E3%81%BE%E3%81%9F%E3%81%AF%E5%B7%A6%E7%B5%90%E5%90%88%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%81%B9%E3%81%8D%E3%81%8B"><i class="fas fa-link"></i></a>
</h4>
<p>上の質問に答えるために、「どちらのデータフレームの行がすべて保持されるべきか？」と自分自身に聞いてみてください。<u>左結合</u>では、コマンドで指定された最初のデータフレーム行がすべて保持されますが、<u>右結合</u>では、2 番目のデータフレームの行がすべて保持されます。</p>
<p>以下の 2 つのコマンドは、先述の例と同じく<code>linelist_mini</code> をベースラインデータフレームとし、<code>hosp_info</code> を <code>linelist_mini</code> <u><em>に</em></u>結合するコマンドです。コマンド実行後の出力結果は同じですが、結合方法が異なります（1 つ目は左結合、2 つ目は右結合がを使用している）。<code>hosp_info</code> を右から結合させるか（左結合）、左から結合するか（右結合）によって、列の順序が異なっています。それに伴い、行の順番もずれる可能性がありますが、<code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> による列の並べ替えや <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code> による行の並べ替えで対処することができます。</p>
<div class="sourceCode" id="cb683"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 以下の2つのコマンドの出力結果は同じだが、行と列の順序が異なる</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">linelist_mini</span>, <span class="va">hosp_info</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"hospital"</span> <span class="op">=</span> <span class="st">"hosp_name"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join</a></span><span class="op">(</span><span class="va">hosp_info</span>, <span class="va">linelist_mini</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"hosp_name"</span> <span class="op">=</span> <span class="st">"hospital"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>1 つ目は、左結合で <code>hosp_info</code> を <code>linelist_mini</code> に結合した結果です（新しい列は右側から結合されます）。</p>
<div id="htmlwidget-923f0c718b926d08895a" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-923f0c718b926d08895a">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","11f8ea","b8812a","893f25","893f25","be99c8","07e3e8","369449","f393b4","1389ca"],["2014-05-13","2014-05-13","2014-05-16","2014-05-18","2014-05-21","2014-05-21","2014-05-22","2014-05-27","2014-06-02","2014-06-05","2014-06-05"],["Other","Missing","St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Military Hospital","Port Hospital","Missing","Missing","Missing","Missing"],[null,null,12000,50280,40500,10000,50280,null,null,null,null],[null,null,"Secondary","Secondary","Secondary","Primary","Secondary",null,null,null,null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>date_onset<\/th>\n      <th>hospital<\/th>\n      <th>catchment_pop<\/th>\n      <th>level<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":11,"columnDefs":[{"className":"dt-right","targets":3}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[10,11,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>2 つ目は、右結合で <code>hosp_info</code> を <code>linelist_mini</code> に結合した結果です（新しい列は左側から結合されます）。</p>
<div id="htmlwidget-6fe681c59e28a4dec555" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6fe681c59e28a4dec555">{"x":{"filter":"none","vertical":false,"data":[["Military Hospital","Military Hospital","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)","Other","Missing","Missing","Missing","Missing","Missing"],[40500,10000,50280,50280,12000,null,null,null,null,null,null],["Secondary","Primary","Secondary","Secondary","Secondary",null,null,null,null,null,null],["893f25","893f25","b8812a","be99c8","11f8ea","5fe599","8689b7","07e3e8","369449","f393b4","1389ca"],["2014-05-21","2014-05-21","2014-05-18","2014-05-22","2014-05-16","2014-05-13","2014-05-13","2014-05-27","2014-06-02","2014-06-05","2014-06-05"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>hosp_name<\/th>\n      <th>catchment_pop<\/th>\n      <th>level<\/th>\n      <th>case_id<\/th>\n      <th>date_onset<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":11,"columnDefs":[{"className":"dt-right","targets":1}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[10,11,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>左結合か右結合のどちらを使用するのかを決める際は、結合に使用するデータが既存のパイプライン（<code>%&gt;%</code>）内にあるかも確認してください。 パイプライン内のデータセットがベースラインである場合は、左結合を使用してデータを追加するのがよいでしょう。</p>
<!-- ======================================================= -->
</div>
</div>
<div id="完全結合full-join" class="section level3 unnumbered">
<h3>完全結合（full join）<a class="anchor" aria-label="anchor" href="#%E5%AE%8C%E5%85%A8%E7%B5%90%E5%90%88full-join"><i class="fas fa-link"></i></a>
</h3>
<p>完全結合は、両方のデータフレーム内のすべての行が結合される結合であり、<strong>結合の中で最も<u>包括的な</u>ものです。</strong></p>
<p>一方のデータフレームにあるがもう一方のデータフレームにない行（一致が見つからなかった行）も出力結果のデータフレームに含まれるため、出力結果のデータフレームはその分長くなります。結合の際に生じたギャップは、欠損値（<code>NA</code>）で埋められます。 結合の際には、列や行の数に注意を払い、大文字小文字の区別や文字などを入念にチェックしてください。</p>
<p>ベースラインデータフレームは、コマンドで最初に指定されるデータフレームです。データフレームの順序を調整しても結合結果として返される行は変わりませんが、結果の列の順序、行の順序、および保持される識別子の列が変更されます。</p>
<div class="inline-figure"><img src="images/full-join.gif" width="50%"></div>
<p>完全結合のアニメーション例（<a href="https://github.com/gadenbuie/tidyexplain/tree/master/images">画像提供元</a>）</p>
<p><strong>例</strong></p>
<p>以下は、 <code>hosp_info</code> （7 行のデータフレーム、<a href="joining-matching.html#joins_hosp_info">ここに表示</a>）を <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join()</a></code> で <code>linelist_mini</code>（10 行のデータフレーム、<a href="joining-matching.html#joins_llmini">ここに表示</a>）に完全結合した出力結果です。 次の点に注意してください。</p>
<ul>
<li>ベースラインデータフレーム（<code>linelist_mini</code>）のすべての行が保持されます<br>
</li>
<li>ベースラインデータフレームと一致しない二次データフレームの行も保持され（“ignace” と “sisters” 病院）、対応するベースラインデータフレームの列 <code>case_id</code> と <code>onset</code> の値は欠損値（<code>NA</code>）で埋められています<br>
</li>
<li>同様に、ベースラインデータフレームの行のうち、二次データフレームと一致しない行も保持され（“Other” と “Missing”）、二次データフレームから結合された列である <code>catchment_pop</code> と <code>level</code> が欠損値（<code>NA</code>）で埋められます<br>
</li>
<li>一対多または多対一の場合（例えば “Military Hospital”の行）、すべての組み合わせが出力されます（最終的なデータフレームが長くなります）<br>
</li>
<li>結合に使用された識別子の列は、ベースラインデータフレームの識別子列（<code>hospital</code>）のみが保持されます</li>
</ul>
<div class="sourceCode" id="cb684"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist_mini</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">hosp_info</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"hospital"</span> <span class="op">=</span> <span class="st">"hosp_name"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-c317cd614b38fc345eb4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-c317cd614b38fc345eb4">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","11f8ea","b8812a","893f25","893f25","be99c8","07e3e8","369449","f393b4","1389ca",null,null,null],["2014-05-13","2014-05-13","2014-05-16","2014-05-18","2014-05-21","2014-05-21","2014-05-22","2014-05-27","2014-06-02","2014-06-05","2014-06-05",null,null,null],["Other","Missing","St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Military Hospital","Port Hospital","Missing","Missing","Missing","Missing","Central Hospital","ignace","sisters"],[null,null,12000,50280,40500,10000,50280,null,null,null,null,1950280,5000,4200],[null,null,"Secondary","Secondary","Secondary","Primary","Secondary",null,null,null,null,"Tertiary","Primary","Primary"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>date_onset<\/th>\n      <th>hospital<\/th>\n      <th>catchment_pop<\/th>\n      <th>level<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":15,"columnDefs":[{"className":"dt-right","targets":3}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[10,15,25,50,100]}},"evals":[],"jsHooks":[]}</script><!-- ======================================================= -->
</div>
<div id="内部結合inner-join" class="section level3 unnumbered">
<h3>内部結合（inner join）<a class="anchor" aria-label="anchor" href="#%E5%86%85%E9%83%A8%E7%B5%90%E5%90%88inner-join"><i class="fas fa-link"></i></a>
</h3>
<p>内部結合は、両方のデータフレームで一致する行のみが結合され、<strong>データ結合の中で最も制限の多い結合です。</strong>そのため、結合後のベースラインデータフレームの行数が<u>減少する</u>可能性があります。どのデータフレームを「ベースライン」とするか（関数内で最初に指定されるデータフレーム）を調整しても、結合結果として返される行は変わりませんが、列の順番、行の順番、どの識別子列が保持されるかには影響します。</p>
<div class="inline-figure"><img src="images/inner-join.gif" width="50%"></div>
<p>内部結合のアニメーション例（<a href="https://github.com/gadenbuie/tidyexplain/tree/master/images">画像提供元</a>）</p>
<p><strong>例</strong></p>
<p>以下は、<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join()</a></code> を使用して <code>linelist_mini</code>（ベースラインデータフレーム）と<code>hosp_info</code> （二次データフレーム）を完全結合した出力結果です。</p>
<ul>
<li>二次データフレームの行と一致しないベースラインデータフレームの行は結合されません（ <code>hospital</code> 列が”Missing” または “Other” である行）<br>
</li>
<li>同様に、ベースラインデータフレームの行と一致しなかった二次データフレームの行も結合されません（ <code>hosp_name</code> 列が “sisters”または “ignace” の行）<br>
</li>
<li>結合に使用された識別子の列は、ベースラインデータフレームの識別子列（<code>hospital</code>）のみが保持されます</li>
</ul>
<div class="sourceCode" id="cb685"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist_mini</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">hosp_info</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"hospital"</span> <span class="op">=</span> <span class="st">"hosp_name"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-4a1048c7d23257b87de1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4a1048c7d23257b87de1">{"x":{"filter":"none","vertical":false,"data":[["11f8ea","b8812a","893f25","893f25","be99c8"],["2014-05-16","2014-05-18","2014-05-21","2014-05-21","2014-05-22"],["St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Military Hospital","Port Hospital"],[12000,50280,40500,10000,50280],["Secondary","Secondary","Secondary","Primary","Secondary"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>date_onset<\/th>\n      <th>hospital<\/th>\n      <th>catchment_pop<\/th>\n      <th>level<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":12,"columnDefs":[{"className":"dt-right","targets":3}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[10,12,25,50,100]}},"evals":[],"jsHooks":[]}</script><!-- ======================================================= -->
</div>
<div id="準結合semi-join" class="section level3 unnumbered">
<h3>準結合（semi join）<a class="anchor" aria-label="anchor" href="#%E6%BA%96%E7%B5%90%E5%90%88semi-join"><i class="fas fa-link"></i></a>
</h3>
<p>準結合は、別のデータセットを使用して<u>行や列を追加するのではなく、フィルタリングを実行する</u>「フィルタリング結合」です。</p>
<p><strong>準結合では、二次データフレームの行と一致するベースラインデータフレームの行すべてが保持されます</strong> (ただし、二次データフレームから新しい列は追加されず、また、複数の一致があった行も複製されません）。「フィルタリング」結合について詳しく知りたい方は、<a href="https://towardsdatascience.com/level-up-with-semi-joins-in-r-a068426096e0">こちら</a> をご覧ください。</p>
<div class="inline-figure"><img src="images/semi-join.gif" width="50%"></div>
<p>準結合のアニメーション例 (<a href="https://github.com/gadenbuie/tidyexplain/tree/master/images">画像提供元</a>)</p>
<p>以下のコマンドでは、<code>hosp_info</code> をベースラインデータフレーム、<code>linelist_mini</code> を二次データフレームとしています。<code>linelist_mini</code> データフレームにある病院名（ <code>hospital</code> 列）に一致する <code>hosp_info</code> データフレームの病院（<code>hosp_name</code> 列）が出力結果として返されます。</p>
<div class="sourceCode" id="cb686"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hosp_info</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">linelist_mini</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"hosp_name"</span> <span class="op">=</span> <span class="st">"hospital"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##                              hosp_name catchment_pop     level
## 1                    Military Hospital         40500 Secondary
## 2                    Military Hospital         10000   Primary
## 3                        Port Hospital         50280 Secondary
## 4 St. Mark's Maternity Hospital (SMMH)         12000 Secondary</code></pre>
<!-- ======================================================= -->
</div>
<div id="アンチ結合anti-join" class="section level3 unnumbered">
<h3>アンチ結合（anti join）<a class="anchor" aria-label="anchor" href="#%E3%82%A2%E3%83%B3%E3%83%81%E7%B5%90%E5%90%88anti-join"><i class="fas fa-link"></i></a>
</h3>
<p><strong>アンチ結合では、ベースラインデータフレームのうち、二次データフレームと<u>一致しない行が出力される</u>、もう 1 つの「フィルタリング結合」です。</strong></p>
<p>フィルタリング結合について詳しく知りたい方は、<a href="https://towardsdatascience.com/level-up-with-semi-joins-in-r-a068426096e0">こちら</a> をご覧ください。</p>
<p>アンチ結合は一般的に、二つのデータフレームのうち一方のデータフレームに存在しないデータを見つけ出したり、結合したデータに一致するはずのデータが含まれているかを確認したり、または左結合など他の結合後に除外されたデータを詳しく見る際に用いられます。</p>
<p><strong><code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">right_join()</a></code> および <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code> と同様に、最初に指定される<u>ベースライン</u>データフレームが重要です。</strong>結合後は、二次データフレームの行と一致しないベースラインデータフレームの行のみが出力結果として返されます。下の GIF では、二次データフレームの紫の行 4 がベースラインデータフレームのどの行にも一致せず、出力されていないことに注意してください。</p>
<div class="inline-figure"><img src="images/anti-join.gif" width="50%"></div>
<p>アンチ結合のアニメーション例 (<a href="https://github.com/gadenbuie/tidyexplain/tree/master/images">画像提供元</a>)</p>
<div id="簡単な-anti_join-の例" class="section level4 unnumbered">
<h4>簡単な <code>anti_join()</code> の例<a class="anchor" aria-label="anchor" href="#%E7%B0%A1%E5%8D%98%E3%81%AA-anti_join-%E3%81%AE%E4%BE%8B"><i class="fas fa-link"></i></a>
</h4>
<p>簡単な例として、<code>hosp_info</code> データフレームにある病院のうち、<code>linelist_mini</code> データフレームには含まれていない病院を検索してみましょう。ベースラインデータフレームとして、<code>hosp_info</code> を最初に指定します。結合後は、<code>linelist_mini</code> データフレームにない病院が返されます。</p>
<div class="sourceCode" id="cb688"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hosp_info</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">linelist_mini</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"hosp_name"</span> <span class="op">=</span> <span class="st">"hospital"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-4ff352ed39fb5703384f" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4ff352ed39fb5703384f">{"x":{"filter":"none","vertical":false,"data":[["Central Hospital","ignace","sisters"],[1950280,5000,4200],["Tertiary","Primary","Primary"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>hosp_name<\/th>\n      <th>catchment_pop<\/th>\n      <th>level<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":12,"columnDefs":[{"className":"dt-right","targets":1}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[10,12,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="複雑な-anti_join-の例" class="section level4 unnumbered">
<h4>複雑な <code>anti_join()</code> の例<a class="anchor" aria-label="anchor" href="#%E8%A4%87%E9%9B%91%E3%81%AA-anti_join-%E3%81%AE%E4%BE%8B"><i class="fas fa-link"></i></a>
</h4>
<p>別の例として、<code>linelist_mini</code> データフレームと <code>hosp_info</code> データフレームで <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join()</a></code> を実行したとします。<code>linelist_mini</code> データフレームには、<code>hosp_info</code> データフレームにはない病院の症例があり、そのような症例は結合の際に除かれるため、結合後の <code>linelist_mini</code> データフレームは元のデータフレームよりも短くなります。</p>
<div class="sourceCode" id="cb689"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist_mini</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">hosp_info</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"hospital"</span> <span class="op">=</span> <span class="st">"hosp_name"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-c3d0bf914d4bdca4d908" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-c3d0bf914d4bdca4d908">{"x":{"filter":"none","vertical":false,"data":[["11f8ea","b8812a","893f25","893f25","be99c8"],["2014-05-16","2014-05-18","2014-05-21","2014-05-21","2014-05-22"],["St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Military Hospital","Port Hospital"],[12000,50280,40500,10000,50280],["Secondary","Secondary","Secondary","Primary","Secondary"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>date_onset<\/th>\n      <th>hospital<\/th>\n      <th>catchment_pop<\/th>\n      <th>level<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":8,"columnDefs":[{"className":"dt-right","targets":3}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[8,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>内部結合で除外された <code>linelist_mini</code> データフレームの症例を確認するために、実行された内部結合と同じように <code>linelist_mini</code> をベースラインデータフレームとしてアンチ結合を実行します。</p>
<div class="sourceCode" id="cb690"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist_mini</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">hosp_info</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"hospital"</span> <span class="op">=</span> <span class="st">"hosp_name"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-6dd5976bf82c00440319" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6dd5976bf82c00440319">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","07e3e8","369449","f393b4","1389ca"],["2014-05-13","2014-05-13","2014-05-27","2014-06-02","2014-06-05","2014-06-05"],["Other","Missing","Missing","Missing","Missing","Missing"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>date_onset<\/th>\n      <th>hospital<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":8,"columnDefs":[],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[8,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>逆に、<code>hosp_info</code> をベースラインデータフレームとして使用してアンチ結合を実行すると、内部結合で除外された <code>hosp_info</code> データフレームの病院を確認することができます。</p>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="確率的マッチング" class="section level2" number="14.3">
<h2>
<span class="header-section-number">14.3</span> 確率的マッチング<a class="anchor" aria-label="anchor" href="#%E7%A2%BA%E7%8E%87%E7%9A%84%E3%83%9E%E3%83%83%E3%83%81%E3%83%B3%E3%82%B0"><i class="fas fa-link"></i></a>
</h2>
<p>データセット間で共通する識別子がない場合は、確率的なマッチングアルゴリズムを使用することを検討してください。これは、データ間の類似性（例えば、Jaro-Winkler 文字列距離や数値距離）に基づいて 2 つのデータセット間でマッチングを見つけるものです。以下は、<strong>fastLink</strong> パッケージを使用した簡単な例です。</p>
<p><strong>パッケージを読み込む</strong></p>
<div class="sourceCode" id="cb691"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">tidyverse</span>,      <span class="co"># データ整理と可視化</span></span>
<span>  <span class="va">fastLink</span>        <span class="co"># データ結合</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>確率的マッチングを解説するために使用する 2 つの小さなサンプルデータセット（<code>cases</code> と <code>test_results</code>）を次に示します。</p>
<p>以下は、サンプルデータセットを作成するためのコードです。</p>
<div class="sourceCode" id="cb692"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># データセットを作成する</span></span>
<span></span>
<span><span class="va">cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">gender</span>, <span class="op">~</span><span class="va">first</span>,      <span class="op">~</span><span class="va">middle</span>,     <span class="op">~</span><span class="va">last</span>,        <span class="op">~</span><span class="va">yr</span>,   <span class="op">~</span><span class="va">mon</span>, <span class="op">~</span><span class="va">day</span>, <span class="op">~</span><span class="va">district</span>,</span>
<span>  <span class="st">"M"</span>,     <span class="st">"Amir"</span>,      <span class="cn">NA</span>,          <span class="st">"Khan"</span>,       <span class="fl">1989</span>,  <span class="fl">11</span>,   <span class="fl">22</span>,   <span class="st">"River"</span>,</span>
<span>  <span class="st">"M"</span>,     <span class="st">"Anthony"</span>,   <span class="st">"B."</span>,        <span class="st">"Smith"</span>,      <span class="fl">1970</span>, <span class="fl">09</span>, <span class="fl">19</span>,      <span class="st">"River"</span>, </span>
<span>  <span class="st">"F"</span>,     <span class="st">"Marialisa"</span>, <span class="st">"Contreras"</span>, <span class="st">"Rodrigues"</span>,  <span class="fl">1972</span>, <span class="fl">04</span>, <span class="fl">15</span>,      <span class="st">"River"</span>,</span>
<span>  <span class="st">"F"</span>,     <span class="st">"Elizabeth"</span>, <span class="st">"Casteel"</span>,   <span class="st">"Chase"</span>,      <span class="fl">1954</span>, <span class="fl">03</span>, <span class="fl">03</span>,      <span class="st">"City"</span>,</span>
<span>  <span class="st">"M"</span>,     <span class="st">"Jose"</span>,      <span class="st">"Sanchez"</span>,   <span class="st">"Lopez"</span>,      <span class="fl">1996</span>, <span class="fl">01</span>, <span class="fl">06</span>,      <span class="st">"City"</span>,</span>
<span>  <span class="st">"F"</span>,     <span class="st">"Cassidy"</span>,   <span class="st">"Jones"</span>,      <span class="st">"Davis"</span>,     <span class="fl">1980</span>, <span class="fl">07</span>, <span class="fl">20</span>,      <span class="st">"City"</span>,</span>
<span>  <span class="st">"M"</span>,     <span class="st">"Michael"</span>,   <span class="st">"Murphy"</span>,     <span class="st">"O'Calaghan"</span>,<span class="fl">1969</span>, <span class="fl">04</span>, <span class="fl">12</span>,      <span class="st">"Rural"</span>, </span>
<span>  <span class="st">"M"</span>,     <span class="st">"Oliver"</span>,    <span class="st">"Laurent"</span>,    <span class="st">"De Bordow"</span> , <span class="fl">1971</span>, <span class="fl">02</span>, <span class="fl">04</span>,     <span class="st">"River"</span>,</span>
<span>  <span class="st">"F"</span>,      <span class="st">"Blessing"</span>,  <span class="cn">NA</span>,          <span class="st">"Adebayo"</span>,   <span class="fl">1955</span>,  <span class="fl">02</span>, <span class="fl">14</span>,     <span class="st">"Rural"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">gender</span>,  <span class="op">~</span><span class="va">first</span>,     <span class="op">~</span><span class="va">middle</span>,     <span class="op">~</span><span class="va">last</span>,          <span class="op">~</span><span class="va">yr</span>, <span class="op">~</span><span class="va">mon</span>, <span class="op">~</span><span class="va">day</span>, <span class="op">~</span><span class="va">district</span>, <span class="op">~</span><span class="va">result</span>,</span>
<span>  <span class="st">"M"</span>,      <span class="st">"Amir"</span>,     <span class="cn">NA</span>,          <span class="st">"Khan"</span>,         <span class="fl">1989</span>, <span class="fl">11</span>,   <span class="fl">22</span>,  <span class="st">"River"</span>, <span class="st">"positive"</span>,</span>
<span>  <span class="st">"M"</span>,      <span class="st">"Tony"</span>,   <span class="st">"B"</span>,         <span class="st">"Smith"</span>,          <span class="fl">1970</span>, <span class="fl">09</span>,   <span class="fl">19</span>,  <span class="st">"River"</span>, <span class="st">"positive"</span>,</span>
<span>  <span class="st">"F"</span>,      <span class="st">"Maria"</span>,    <span class="st">"Contreras"</span>, <span class="st">"Rodriguez"</span>,    <span class="fl">1972</span>, <span class="fl">04</span>,   <span class="fl">15</span>,  <span class="st">"Cty"</span>,   <span class="st">"negative"</span>,</span>
<span>  <span class="st">"F"</span>,      <span class="st">"Betty"</span>,    <span class="st">"Castel"</span>,   <span class="st">"Chase"</span>,        <span class="fl">1954</span>,  <span class="fl">03</span>,   <span class="fl">30</span>,  <span class="st">"City"</span>,  <span class="st">"positive"</span>,</span>
<span>  <span class="st">"F"</span>,      <span class="st">"Andrea"</span>,   <span class="cn">NA</span>,          <span class="st">"Kumaraswamy"</span>,  <span class="fl">2001</span>, <span class="fl">01</span>,   <span class="fl">05</span>,  <span class="st">"Rural"</span>, <span class="st">"positive"</span>,      </span>
<span>  <span class="st">"F"</span>,      <span class="st">"Caroline"</span>, <span class="cn">NA</span>,          <span class="st">"Wang"</span>,         <span class="fl">1988</span>, <span class="fl">12</span>,   <span class="fl">11</span>,  <span class="st">"Rural"</span>, <span class="st">"negative"</span>,</span>
<span>  <span class="st">"F"</span>,      <span class="st">"Trang"</span>,    <span class="cn">NA</span>,          <span class="st">"Nguyen"</span>,       <span class="fl">1981</span>, <span class="fl">06</span>,   <span class="fl">10</span>,  <span class="st">"Rural"</span>, <span class="st">"positive"</span>,</span>
<span>  <span class="st">"M"</span>,      <span class="st">"Olivier"</span> , <span class="st">"Laurent"</span>,   <span class="st">"De Bordeaux"</span>,  <span class="cn">NA</span>,   <span class="cn">NA</span>,   <span class="cn">NA</span>,  <span class="st">"River"</span>, <span class="st">"positive"</span>,</span>
<span>  <span class="st">"M"</span>,      <span class="st">"Mike"</span>,     <span class="st">"Murphy"</span>,    <span class="st">"O'Callaghan"</span>,  <span class="fl">1969</span>, <span class="fl">04</span>,   <span class="fl">12</span>,  <span class="st">"Rural"</span>, <span class="st">"negative"</span>,</span>
<span>  <span class="st">"F"</span>,      <span class="st">"Cassidy"</span>,  <span class="st">"Jones"</span>,     <span class="st">"Davis"</span>,        <span class="fl">1980</span>, <span class="fl">07</span>,   <span class="fl">02</span>,  <span class="st">"City"</span>,  <span class="st">"positive"</span>,</span>
<span>  <span class="st">"M"</span>,      <span class="st">"Mohammad"</span>, <span class="cn">NA</span>,          <span class="st">"Ali"</span>,          <span class="fl">1942</span>, <span class="fl">01</span>,   <span class="fl">17</span>,  <span class="st">"City"</span>,  <span class="st">"negative"</span>,</span>
<span>  <span class="cn">NA</span>,       <span class="st">"Jose"</span>,     <span class="st">"Sanchez"</span>,   <span class="st">"Lopez"</span>,        <span class="fl">1995</span>, <span class="fl">01</span>,   <span class="fl">06</span>,  <span class="st">"City"</span>,  <span class="st">"negative"</span>,</span>
<span>  <span class="st">"M"</span>,      <span class="st">"Abubakar"</span>, <span class="cn">NA</span>,          <span class="st">"Abullahi"</span>,     <span class="fl">1960</span>, <span class="fl">01</span>,   <span class="fl">01</span>,  <span class="st">"River"</span>, <span class="st">"positive"</span>,</span>
<span>  <span class="st">"F"</span>,      <span class="st">"Maria"</span>,    <span class="st">"Salinas"</span>,   <span class="st">"Contreras"</span>,    <span class="fl">1955</span>, <span class="fl">03</span>,   <span class="fl">03</span>,  <span class="st">"River"</span>, <span class="st">"positive"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><strong><code>cases</code> データセットには</strong>、検査結果を待っている患者の記録が <strong>9 件ある。</strong></p>
<div id="htmlwidget-6df0cc3798744beace0c" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6df0cc3798744beace0c">{"x":{"filter":"none","vertical":false,"data":[["M","M","F","F","M","F","M","M","F"],["Amir","Anthony","Marialisa","Elizabeth","Jose","Cassidy","Michael","Oliver","Blessing"],[null,"B.","Contreras","Casteel","Sanchez","Jones","Murphy","Laurent",null],["Khan","Smith","Rodrigues","Chase","Lopez","Davis","O'Calaghan","De Bordow","Adebayo"],[1989,1970,1972,1954,1996,1980,1969,1971,1955],[11,9,4,3,1,7,4,2,2],[22,19,15,3,6,20,12,4,14],["River","River","River","City","City","City","Rural","River","Rural"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>gender<\/th>\n      <th>first<\/th>\n      <th>middle<\/th>\n      <th>last<\/th>\n      <th>yr<\/th>\n      <th>mon<\/th>\n      <th>day<\/th>\n      <th>district<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":9,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[4,5,6]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[9,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p><strong><code>test_results</code> データセットには 14 件</strong>の記録があり、<code>result</code> という列があります。この列は、確率的マッチングを行う際に <code>cases</code> データセットに追加したい列です。</p>
<div id="htmlwidget-2b52e08971012d3566c0" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2b52e08971012d3566c0">{"x":{"filter":"none","vertical":false,"data":[["M","M","F","F","F","F","F","M","M","F","M",null,"M","F"],["Amir","Tony","Maria","Betty","Andrea","Caroline","Trang","Olivier","Mike","Cassidy","Mohammad","Jose","Abubakar","Maria"],[null,"B","Contreras","Castel",null,null,null,"Laurent","Murphy","Jones",null,"Sanchez",null,"Salinas"],["Khan","Smith","Rodriguez","Chase","Kumaraswamy","Wang","Nguyen","De Bordeaux","O'Callaghan","Davis","Ali","Lopez","Abullahi","Contreras"],[1989,1970,1972,1954,2001,1988,1981,null,1969,1980,1942,1995,1960,1955],[11,9,4,3,1,12,6,null,4,7,1,1,1,3],[22,19,15,30,5,11,10,null,12,2,17,6,1,3],["River","River","Cty","City","Rural","Rural","Rural","River","Rural","City","City","City","River","River"],["positive","positive","negative","positive","positive","negative","positive","positive","negative","positive","negative","negative","positive","positive"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>gender<\/th>\n      <th>first<\/th>\n      <th>middle<\/th>\n      <th>last<\/th>\n      <th>yr<\/th>\n      <th>mon<\/th>\n      <th>day<\/th>\n      <th>district<\/th>\n      <th>result<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":14,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[4,5,6]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[10,14,25,50,100]}},"evals":[],"jsHooks":[]}</script><div id="確率的マッチング-1" class="section level3 unnumbered">
<h3>確率的マッチング<a class="anchor" aria-label="anchor" href="#%E7%A2%BA%E7%8E%87%E7%9A%84%E3%83%9E%E3%83%83%E3%83%81%E3%83%B3%E3%82%B0-1"><i class="fas fa-link"></i></a>
</h3>
<p><strong>fastLink</strong> パッケージの <code>fastLink()</code> を使用して、マッチングアルゴリズムを適用します。以下に、<code>fastLink()</code> の基本的な情報を記載します。 コンソールに <code>?fastLink</code> と入力すると、さらに詳細を読むことができます。</p>
<ul>
<li>引数 <code>dfA =</code> および <code>dfB =</code> に比較する 2 つのデータフレームを指定します<br>
</li>
<li>引数 <code>varnames =</code> で、マッチングに使用するすべての列名を指定します。ここで指定されるすべての列は <code>dfA</code> と <code>dfB</code> の両方に含まれている必要があります。<br>
</li>
<li>引数 <code>stringdist.match =</code> で、<code>varnames</code> にある列のうち、文字列の「距離（“distance”）」を評価する列を指定する。<br>
</li>
<li>引数 <code>numeric.match =</code> で、<code>varnames</code> にある列の中から、数値の距離「距離（“distance”）」を評価する列を指定する。<br>
</li>
<li>欠損値は無視されます<br>
</li>
<li>デフォルトでは、Winkler の線形割り当て（Winkler’s linear assignment solution）による重複排除が行われ、一方のデータフレームの各行が、最大でもう一方のデータフレームの 1 行しかマッチングされません。評価済みのマッチをすべて表示したい場合は、 <code>dedupe.matches = FALSE</code> と設定してください。</li>
</ul>
<p><u>ヒント: <strong>lubridate</strong> パッケージの <code>day()</code>、 <code>month()</code>、 <code>year()</code> を用いて、ひとつの日付列を 3 つの別々の数値列に分割することができます。</u></p>
<p>マッチングの閾値のデフォルトは 0.94（<code>threshold.match =</code> ）ですが、この値は調整可能です。閾値を高くすると偽陰性（マッチするはずの行がマッチしない）が増える可能性があり、同様に閾値を低くすると偽陽性が増えうることを考慮して、閾値を設定してください。</p>
<p>以下では、名前と地区の列については文字列の距離で、年、月、誕生日については数値の距離でマッチングを行います。マッチングの閾値は 95% に設定されています。</p>
<div class="sourceCode" id="cb693"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fl_output</span> <span class="op">&lt;-</span> <span class="fu">fastLink</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fastLink/man/fastLink.html">fastLink</a></span><span class="op">(</span></span>
<span>  dfA <span class="op">=</span> <span class="va">cases</span>,</span>
<span>  dfB <span class="op">=</span> <span class="va">results</span>,</span>
<span>  varnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gender"</span>, <span class="st">"first"</span>, <span class="st">"middle"</span>, <span class="st">"last"</span>, <span class="st">"yr"</span>, <span class="st">"mon"</span>, <span class="st">"day"</span>, <span class="st">"district"</span><span class="op">)</span>,</span>
<span>  stringdist.match <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"first"</span>, <span class="st">"middle"</span>, <span class="st">"last"</span>, <span class="st">"district"</span><span class="op">)</span>,</span>
<span>  numeric.match <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"yr"</span>, <span class="st">"mon"</span>, <span class="st">"day"</span><span class="op">)</span>,</span>
<span>  threshold.match <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## ==================== 
## fastLink(): Fast Probabilistic Record Linkage
## ==================== 
## 
## If you set return.all to FALSE, you will not be able to calculate a confusion table as a summary statistic.
## Calculating matches for each variable.
## Getting counts for parameter estimation.
##     Parallelizing calculation using OpenMP. 1 threads out of 8 are used.
## Running the EM algorithm.
## Getting the indices of estimated matches.
##     Parallelizing calculation using OpenMP. 1 threads out of 8 are used.
## Deduping the estimated matches.
## Getting the match patterns for each estimated match.</code></pre>
<p><strong>マッチを確認する</strong></p>
<p><code>fastLink()</code> で確率的マッチングを行った結果を <code>fl_output</code> として定義しました。 このオブジェクトは <code>list</code> であり、内部にはマッチングの結果の詳細を含むデータフレームが複数含まれています。中でも、<code>matches</code> と名付けられたデータフレームには、<code>cases</code> と <code>results</code> データセット間のマッチング結果が含まれており、<code>fl_output$matches</code> というコマンドでアクセスすることができます。以下では、後でアクセスしやすいように <code>my_matches</code> という名前で <code>matches</code> データフレームを保存します。</p>
<p><code>my_matches</code> を表示すると、2 つの列ベクトルが含まれていることがわかります。<code>cases</code>（ “inds.a”）と <code>results</code>（ “inds.b”）の行番号・インデックスのペア（「行名（“rownames”）」とも呼ばれています）がベストマッチを表します。データフレームの行番号が欠落している場合、指定されたマッチングの閾値で対応する値がもう一方のデータフレームになかったことを意味します。</p>
<div class="sourceCode" id="cb695"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># マッチングを表示</span></span>
<span><span class="va">my_matches</span> <span class="op">&lt;-</span> <span class="va">fl_output</span><span class="op">$</span><span class="va">matches</span></span>
<span><span class="va">my_matches</span></span></code></pre></div>
<pre><code>##   inds.a inds.b
## 1      1      1
## 2      2      2
## 3      3      3
## 4      4      4
## 5      8      8
## 6      7      9
## 7      6     10
## 8      5     12</code></pre>
<p>以下の点に注意してください。</p>
<ul>
<li>
<p>名前のスペルや生年月日が若干異なるにもかかわらず、マッチングが成立した。</p>
<ul>
<li>“Tony B. Smith” が “Anthony B Smith” とマッチした<br>
</li>
<li>“Maria Rodriguez” が “Marialisa Rodrigues” とマッチした<br>
</li>
<li>“Betty Chase” が “Elizabeth Chase” とマッチした<br>
</li>
<li>“Olivier Laurent De Bordeaux” が “Oliver Laurent De Bordow” とマッチした（生年月日の欠落は無視する）<br>
</li>
</ul>
</li>
<li><p><code>cases</code> データセット 9 行目（“Blessing Adebayo” の行）は、<code>results</code> データセットにマッチする行がなかったため、 <code>my_matches</code> には存在していません。</p></li>
</ul>
<p><strong>確率的マッチングに基づく結合</strong></p>
<p>これらのマッチング結果を使用して <code>results</code> データセットを <code>cases</code> データセットに結合するための戦略は、次のとおりです。</p>
<ol style="list-style-type: decimal">
<li>
<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code> を使用して、<code>my_matches</code> を <code>cases</code> に結合します（<code>cases</code> の行名を <code>my_matches</code> の “inds.a” に一致させます）<br>
</li>
<li>次に、もう一度 <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code> を使用し、今度は <code>results</code> を <code>cases</code> に結合します（ 前のステップで <code>cases</code> に新しく結合された “inds.b” を <code>results</code> の行名に一致させます）</li>
</ol>
<p>結合を行う前に、まず 3 つのデータフレームをクリーニングする必要があります。</p>
<ul>
<li>
<code>dfA</code> と <code>dfB</code> の行番号（「行名（“rowname”）」）を列に変換する必要があります。<br>
</li>
<li>
<code>my_matches</code> に含まれる 2 列は文字型データに変換し、文字型の行名に結合できるようにします。</li>
</ul>
<div class="sourceCode" id="cb697"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 結合前のデータのクリーニング</span></span>
<span><span class="co">#############################</span></span>
<span></span>
<span><span class="co"># casesの行番号（rowname）を列に変換する </span></span>
<span><span class="va">cases_clean</span> <span class="op">&lt;-</span> <span class="va">cases</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># test_results の 行番号（rownames） を列に変換する</span></span>
<span><span class="va">results_clean</span> <span class="op">&lt;-</span> <span class="va">results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="op">)</span>  </span>
<span></span>
<span><span class="co">#  データセットの全ての列を文字列に変換し、行番号で結合できるようにする</span></span>
<span><span class="va">matches_clean</span> <span class="op">&lt;-</span> <span class="va">my_matches</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">as.character</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># matches_clean を dfA に結合、その後 dfB も結合</span></span>
<span><span class="co">###################################</span></span>
<span><span class="co"># 列 "inds.b" を dfA に追加する</span></span>
<span><span class="va">complete</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">cases_clean</span>, <span class="va">matches_clean</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rowname"</span> <span class="op">=</span> <span class="st">"inds.a"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># dfB 由来の列を追加する </span></span>
<span><span class="va">complete</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">complete</span>, <span class="va">results_clean</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"inds.b"</span> <span class="op">=</span> <span class="st">"rowname"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>上のコードを実行すると、結果として出力されるデータフレーム <code>complete</code> には、<code>cases</code> と <code>results</code> の両方のデータセットに含まれるすべての列が含まれます。多くの場合、列名が重複してしまうため、“.x” や “.y” といった添え字が出力結果のデータフレームの列名に付加されます。</p>
<div id="htmlwidget-cea7794d8816d58ed84e" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-cea7794d8816d58ed84e">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9"],["M","M","F","F","M","F","M","M","F"],["Amir","Anthony","Marialisa","Elizabeth","Jose","Cassidy","Michael","Oliver","Blessing"],[null,"B.","Contreras","Casteel","Sanchez","Jones","Murphy","Laurent",null],["Khan","Smith","Rodrigues","Chase","Lopez","Davis","O'Calaghan","De Bordow","Adebayo"],[1989,1970,1972,1954,1996,1980,1969,1971,1955],[11,9,4,3,1,7,4,2,2],[22,19,15,3,6,20,12,4,14],["River","River","River","City","City","City","Rural","River","Rural"],["1","2","3","4","12","10","9","8",null],["M","M","F","F",null,"F","M","M",null],["Amir","Tony","Maria","Betty","Jose","Cassidy","Mike","Olivier",null],[null,"B","Contreras","Castel","Sanchez","Jones","Murphy","Laurent",null],["Khan","Smith","Rodriguez","Chase","Lopez","Davis","O'Callaghan","De Bordeaux",null],[1989,1970,1972,1954,1995,1980,1969,null,null],[11,9,4,3,1,7,4,null,null],[22,19,15,30,6,2,12,null,null],["River","River","Cty","City","City","City","Rural","River",null],["positive","positive","negative","positive","negative","positive","negative","positive",null]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>rowname<\/th>\n      <th>gender.x<\/th>\n      <th>first.x<\/th>\n      <th>middle.x<\/th>\n      <th>last.x<\/th>\n      <th>yr.x<\/th>\n      <th>mon.x<\/th>\n      <th>day.x<\/th>\n      <th>district.x<\/th>\n      <th>inds.b<\/th>\n      <th>gender.y<\/th>\n      <th>first.y<\/th>\n      <th>middle.y<\/th>\n      <th>last.y<\/th>\n      <th>yr.y<\/th>\n      <th>mon.y<\/th>\n      <th>day.y<\/th>\n      <th>district.y<\/th>\n      <th>result<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":9,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[5,6,7,14,15,16]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[9,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>あるいは、 <code>cases</code> データセットに <code>results</code> データセットの特定の列のみを追加したい場合は、結合を行う前に <code>results</code> データセットの列を選別しましょう。<code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> を使用して <code>results</code> データセットで結合後も残したい列のみを選択し（この例では、<code>rowname</code> 列と <code>results</code> 列）、選択された列のみを <code>cases</code> データセットに結合することができます。</p>
<div class="sourceCode" id="cb698"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cases_clean</span> <span class="op">&lt;-</span> <span class="va">cases</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results_clean</span> <span class="op">&lt;-</span> <span class="va">results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">rowname</span>, <span class="va">result</span><span class="op">)</span>    <span class="co"># 特定の列のみを選択する</span></span>
<span></span>
<span><span class="va">matches_clean</span> <span class="op">&lt;-</span> <span class="va">my_matches</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">as.character</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 結合</span></span>
<span><span class="va">complete</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">cases_clean</span>, <span class="va">matches_clean</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rowname"</span> <span class="op">=</span> <span class="st">"inds.a"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">complete</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">complete</span>, <span class="va">results_clean</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"inds.b"</span> <span class="op">=</span> <span class="st">"rowname"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-6a8f46c1a036c67f644a" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6a8f46c1a036c67f644a">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9"],["M","M","F","F","M","F","M","M","F"],["Amir","Anthony","Marialisa","Elizabeth","Jose","Cassidy","Michael","Oliver","Blessing"],[null,"B.","Contreras","Casteel","Sanchez","Jones","Murphy","Laurent",null],["Khan","Smith","Rodrigues","Chase","Lopez","Davis","O'Calaghan","De Bordow","Adebayo"],[1989,1970,1972,1954,1996,1980,1969,1971,1955],[11,9,4,3,1,7,4,2,2],[22,19,15,3,6,20,12,4,14],["River","River","River","City","City","City","Rural","River","Rural"],["1","2","3","4","12","10","9","8",null],["positive","positive","negative","positive","negative","positive","negative","positive",null]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>rowname<\/th>\n      <th>gender<\/th>\n      <th>first<\/th>\n      <th>middle<\/th>\n      <th>last<\/th>\n      <th>yr<\/th>\n      <th>mon<\/th>\n      <th>day<\/th>\n      <th>district<\/th>\n      <th>inds.b<\/th>\n      <th>result<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":9,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[5,6,7]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[9,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>どちらかのデータセットをマッチした行だけにサブセットしたい場合は、以下のコードを使用してください。</p>
<div class="sourceCode" id="cb699"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cases_matched</span> <span class="op">&lt;-</span> <span class="va">cases</span><span class="op">[</span><span class="va">my_matches</span><span class="op">$</span><span class="va">inds.a</span>,<span class="op">]</span>  <span class="co"># results の行と一致した cases の行</span></span>
<span><span class="va">results_matched</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">[</span><span class="va">my_matches</span><span class="op">$</span><span class="va">inds.b</span>,<span class="op">]</span>  <span class="co"># cases の行と一致した results の行</span></span></code></pre></div>
<p>または、一致しなかった行<strong>のみ</strong>を表示することもできます。</p>
<div class="sourceCode" id="cb700"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cases_not_matched</span> <span class="op">&lt;-</span> <span class="va">cases</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">cases</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">my_matches</span><span class="op">$</span><span class="va">inds.a</span>,<span class="op">]</span>  <span class="co"># results の行と一致しなかった cases の行</span></span>
<span><span class="va">results_not_matched</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">my_matches</span><span class="op">$</span><span class="va">inds.b</span>,<span class="op">]</span>  <span class="co"># cases の行と一致しなかった results の行</span></span></code></pre></div>
</div>
<div id="確率的な重複排除" class="section level3 unnumbered">
<h3>確率的な重複排除<a class="anchor" aria-label="anchor" href="#%E7%A2%BA%E7%8E%87%E7%9A%84%E3%81%AA%E9%87%8D%E8%A4%87%E6%8E%92%E9%99%A4"><i class="fas fa-link"></i></a>
</h3>
<p>確率的マッチングは、データの重複排除にも使用できます。その他の重複排除の方法については、重複排除の章を参照してください。</p>
<p>ここでは、 <code>cases</code> データセットに重複した行を 2 行追加した新しいデータセットである <code>cases_dup</code> データセットを例として使用します。“Tony Smith” と重複する行として “Anthony Smith” の行が追加され、“Marialisa Rodrigues” と重複する行として “Maria Rodriguez” の行が追加されました。</p>
<div id="htmlwidget-b5c562a3adeb96973272" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-b5c562a3adeb96973272">{"x":{"filter":"none","vertical":false,"data":[["M","M","F","F","M","F","M","M","F","M","F"],["Amir","Anthony","Marialisa","Elizabeth","Jose","Cassidy","Michael","Oliver","Blessing","Tony","Maria"],[null,"B.","Contreras","Casteel","Sanchez","Jones","Murphy","Laurent",null,"B.","Contreras"],["Khan","Smith","Rodrigues","Chase","Lopez","Davis","O'Calaghan","De Bordow","Adebayo","Smith","Rodriguez"],[1989,1970,1972,1954,1996,1980,1969,1971,1955,1970,1972],[11,9,4,3,1,7,4,2,2,9,4],[22,19,15,3,6,20,12,4,14,19,15],["River","River","River","City","City","City","Rural","River","Rural","River","River"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>gender<\/th>\n      <th>first<\/th>\n      <th>middle<\/th>\n      <th>last<\/th>\n      <th>yr<\/th>\n      <th>mon<\/th>\n      <th>day<\/th>\n      <th>district<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":11,"columnDefs":[{"className":"dt-right","targets":[4,5,6]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[10,11,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>先述のセクションと同じように <code>fastLink()</code> を実行し、出力結果を <code>cases_dup</code> データフレームと比較します。<code>dfA =</code> 引数と <code>dfB =</code> 引数に指定されたデータフレームが同一である場合、この関数は重複を解消することを目的として動作します。先述のセクションと違って、<code>stringdist.match =</code> や <code>numeric.match =</code> は設定しないことに注意してください。</p>
<div class="sourceCode" id="cb701"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 同じデータセットにfastLinkを実行する</span></span>
<span><span class="va">dedupe_output</span> <span class="op">&lt;-</span> <span class="fu">fastLink</span><span class="op">(</span></span>
<span>  dfA <span class="op">=</span> <span class="va">cases_dup</span>,</span>
<span>  dfB <span class="op">=</span> <span class="va">cases_dup</span>,</span>
<span>  varnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gender"</span>, <span class="st">"first"</span>, <span class="st">"middle"</span>, <span class="st">"last"</span>, <span class="st">"yr"</span>, <span class="st">"mon"</span>, <span class="st">"day"</span>, <span class="st">"district"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## ==================== 
## fastLink(): Fast Probabilistic Record Linkage
## ==================== 
## 
## If you set return.all to FALSE, you will not be able to calculate a confusion table as a summary statistic.
## dfA and dfB are identical, assuming deduplication of a single data set.
## Setting return.all to FALSE.
## 
## Calculating matches for each variable.
## Getting counts for parameter estimation.
##     Parallelizing calculation using OpenMP. 1 threads out of 8 are used.
## Running the EM algorithm.
## Getting the indices of estimated matches.
##     Parallelizing calculation using OpenMP. 1 threads out of 8 are used.
## Calculating the posterior for each pair of matched observations.
## Getting the match patterns for each estimated match.</code></pre>
<p><code>getMatches()</code> で重複の可能性がある行を確認することができます。重複確認を行いたいデータフレームを <code>dfA =</code> と <code>dfB =</code> の両方に指定し、前述の <code>fastLink()</code> の出力結果を <code>fl.out =</code> に指定します。<code>fl.out</code> に指定されるオブジェクトは <code>fastLink.dedupe</code> 型、すなわち <code>fastLink()</code> の出力結果でなければなりません。</p>
<div class="sourceCode" id="cb703"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## getMatches() を実行</span></span>
<span><span class="va">cases_dedupe</span> <span class="op">&lt;-</span> <span class="fu">getMatches</span><span class="op">(</span></span>
<span>  dfA <span class="op">=</span> <span class="va">cases_dup</span>,</span>
<span>  dfB <span class="op">=</span> <span class="va">cases_dup</span>,</span>
<span>  fl.out <span class="op">=</span> <span class="va">dedupe_output</span><span class="op">)</span></span></code></pre></div>
<p>一番右の列は重複する ID （duplicate ID）を表しており、最後の 2 行は上から 2 行目と 3 行目と重複している可能性が高いことが分かります。</p>
<div id="htmlwidget-f2cdd3c0abd38259caf0" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-f2cdd3c0abd38259caf0">{"x":{"filter":"none","vertical":false,"data":[["M","M","F","F","M","F","M","M","F","M","F"],["Amir","Anthony","Marialisa","Elizabeth","Jose","Cassidy","Michael","Oliver","Blessing","Tony","Maria"],[null,"B.","Contreras","Casteel","Sanchez","Jones","Murphy","Laurent",null,"B.","Contreras"],["Khan","Smith","Rodrigues","Chase","Lopez","Davis","O'Calaghan","De Bordow","Adebayo","Smith","Rodriguez"],[1989,1970,1972,1954,1996,1980,1969,1971,1955,1970,1972],[11,9,4,3,1,7,4,2,2,9,4],[22,19,15,3,6,20,12,4,14,19,15],["River","River","River","City","City","City","Rural","River","Rural","River","River"],[1,2,3,4,5,6,7,8,9,2,3]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>gender<\/th>\n      <th>first<\/th>\n      <th>middle<\/th>\n      <th>last<\/th>\n      <th>yr<\/th>\n      <th>mon<\/th>\n      <th>day<\/th>\n      <th>district<\/th>\n      <th>dedupe.ids<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":11,"columnDefs":[{"className":"dt-right","targets":[4,5,6,8]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[10,11,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>重複していると思われる行の行番号を確認したい場合は、 <code>dedupe.ids</code> 列の ID ごとの行数をカウントし、複数の行がある ID だけを残すようにフィルタリングします。この場合、2 行目と 3 行目が残ります。</p>
<div class="sourceCode" id="cb704"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cases_dedupe</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">dedupe.ids</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code>##   dedupe.ids n
## 1          2 2
## 2          3 2</code></pre>
<p>重複している可能性がある行全体を確認したい場合は、以下のコマンドに行番号を入れます。</p>
<div class="sourceCode" id="cb706"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 2行目とその重複候補をすべて表示する</span></span>
<span><span class="va">cases_dedupe</span><span class="op">[</span><span class="va">cases_dedupe</span><span class="op">$</span><span class="va">dedupe.ids</span> <span class="op">==</span> <span class="fl">2</span>,<span class="op">]</span>   </span></code></pre></div>
<pre><code>##    gender   first middle  last   yr mon day district dedupe.ids
## 2       M Anthony     B. Smith 1970   9  19    River          2
## 10      M    Tony     B. Smith 1970   9  19    River          2</code></pre>
</div>
</div>
<div id="データの結合と整列" class="section level2" number="14.4">
<h2>
<span class="header-section-number">14.4</span> データの結合と整列<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E7%B5%90%E5%90%88%E3%81%A8%E6%95%B4%E5%88%97"><i class="fas fa-link"></i></a>
</h2>
<p>2 つのデータフレームを結合するもう一つの方法は、それらを 「バインドする（“bind”）」ことです。これは、行や列を「追加する（“append” や “add”）」ことだと捉えることもできます。</p>
<p>他にも、このセクションでは、データフレームの行の順番を別のデータフレームの順番に「揃える（“align”）」方法についても説明します。このトピックについては、以下の「列をバインドする」のセクションで後述します。</p>
<div id="行をバインドする" class="section level3 unnumbered">
<h3>行をバインドする<a class="anchor" aria-label="anchor" href="#%E8%A1%8C%E3%82%92%E3%83%90%E3%82%A4%E3%83%B3%E3%83%89%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p>データフレームの行を別のデータフレームの下部にバインドするには、<strong>dplyr</strong> の <code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows()</a></code> を使用します。非常に包括的な方法であり、いずれかのデータフレームに存在するすべての列が結合されます。 以下のことに注意してください。</p>
<ul>
<li>
<strong>base</strong> R の <code>row.bind()</code> とは異なり、<strong>dplyr</strong> の <code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows()</a></code> では、バインドするデータフレームの列の順序が同じである必要はありません。列名が同じである限り、データは正しくバインドされます。<br>
</li>
<li>
<code>.id =</code> 引数に文字型の列を指定すると、各行がどのデータフレームからのものであるかを識別するのに役立つ新しい列が生成されます。<br>
</li>
<li>同じような構造を持つデータフレームを複数含む <code>list</code> で <code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows()</a></code> を使用すると、それら複数のデータフレームを 1 つのデータフレームに結合できます。<a href="iteration.html#iteration">ループと反復処理・リストの操作</a> の章で紹介している <strong>purrr</strong> を使用して複数のラインリストをインポートする例を参照してください。</li>
</ul>
<p>行によるバインドの一般的な例として、<strong>dplyr</strong> の <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> で作成された要約統計表に「合計（“totals”）」を表す行を結合する例が挙げられます。以下では、「合計」行を含む病院ごとの症例数と CT 値の中央値の表を作成します。</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> は、病院ごとにグループ化されたデータに対して使用され、病院ごとの要約データフレームが出力されますが、「合計」行は自動的に生成されません。そのため、データを再度要約して「合計」行を作成します。その際に使用されるデータは、病院ごとにグループ化されていないため、1 行だけのデータフレームが新たに生成されます。これらのデータフレームを結合し、最終的な表を作成していきます。<a href="tables-descriptive.html#tables-descriptive">記述統計表の作り方</a> の章および <a href="tables-presentation.html#tables-presentation">見やすい表の作り方</a> の章では他の例を紹介していますので、詳しく知りたい方はご参照ください。</p>
<div class="sourceCode" id="cb708"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># コアテーブルの作成</span></span>
<span><span class="co">###################</span></span>
<span><span class="va">hosp_summary</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">hospital</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                        <span class="co"># 病院別のグループデータ</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>                                    <span class="co"># 目的の指標の新しい要約列を作成する</span></span>
<span>    cases <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,                                  <span class="co"># 病院ごとの行数-結果グループ</span></span>
<span>    ct_value_med <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">ct_blood</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span>     <span class="co"># グループあたりのCT値の中央値</span></span></code></pre></div>
<p>作成された <code>hosp_summary</code> データフレームは次のとおりです。</p>
<div id="htmlwidget-5725e41026e32a31b3f1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5725e41026e32a31b3f1">{"x":{"filter":"none","vertical":false,"data":[["Central Hospital","Military Hospital","Missing","Other","Port Hospital","St. Mark's Maternity Hospital (SMMH)"],[454,896,1469,885,1762,422],[22,21,21,22,22,22]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>hospital<\/th>\n      <th>cases<\/th>\n      <th>ct_value_med<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p>「合計」行を含む（<u>病院ごとにグループ化されていない</u>）データフレームを作成します。このデータフレームに含まれる行は 1 行のみです。</p>
<div class="sourceCode" id="cb709"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># totals を作成</span></span>
<span><span class="co">###############</span></span>
<span><span class="va">totals</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    cases <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,                               <span class="co"># データセット全体の行数    </span></span>
<span>    ct_value_med <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">ct_blood</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span>  <span class="co"># データセット全体のCT中央値</span></span></code></pre></div>
<p>以下に作成した <code>totals</code> データフレームを表示します。列が 2 つしかないことに注意してください。これらの列は <code>hosp_summary</code> にもありますが、 <code>hosp_summary</code> には <code>totals</code> にない列が 1 つあることに注意してください（<code>hospital</code> 列）。</p>
<div id="htmlwidget-15f6f8e94a4352610a22" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-15f6f8e94a4352610a22">{"x":{"filter":"none","vertical":false,"data":[[5888],[22]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>cases<\/th>\n      <th>ct_value_med<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[0,1]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p>これで、<code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows()</a></code> を使用して行をバインドできます。</p>
<div class="sourceCode" id="cb710"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># データフレームをバインドする</span></span>
<span><span class="va">combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">hosp_summary</span>, <span class="va">totals</span><span class="op">)</span></span></code></pre></div>
<p>以下に、出力結果を表示します。 最後の行を確認し、<code>hosp_summary</code> になかった列（<code>hospital</code> 列）の欠損値（<code>NA</code>）がどのように埋められているかを確認してください。<a href="tables-presentation.html#tables-presentation">見やすい表の作り方</a> の章で説明するように、 <code><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na()</a></code> を使用すると、空欄のセル（<code>hospital</code> 列の最後のセル）に「合計」と入力することができます。</p>
<div id="htmlwidget-51b486313a48af9c0454" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-51b486313a48af9c0454">{"x":{"filter":"none","vertical":false,"data":[["Central Hospital","Military Hospital","Missing","Other","Port Hospital","St. Mark's Maternity Hospital (SMMH)",null],[454,896,1469,885,1762,422,5888],[22,21,21,22,22,22,22]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>hospital<\/th>\n      <th>cases<\/th>\n      <th>ct_value_med<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="列をバインドする" class="section level3 unnumbered">
<h3>列をバインドする<a class="anchor" aria-label="anchor" href="#%E5%88%97%E3%82%92%E3%83%90%E3%82%A4%E3%83%B3%E3%83%89%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p>先述のセクションで使用した <code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows()</a></code> と同様の <strong>dplyr</strong> 系関数である <code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols()</a></code> を使用すると、2 つのデータフレームを縦向きに組み合わせる（列をバインドする）ことができます。列をバインドする際は、先述の各種結合（join）と異なり、各行が<u>位置をもとに</u>マッチングされることに注意してください。例えば、各データフレームの 12 行目が整列される、といった具合です。</p>
<p>ここでは、例としていくつかの要約統計表をバインドします。また、<code><a href="https://rdrr.io/r/base/match.html">match()</a></code> を使用して、データフレームの行の順序を別のデータフレームの順序と一致するように並び替える方法も説明します。</p>
<p>この例では、 linelist データフレームを基に、症例数と死亡数を病院ごとに含む要約統計表を作成し、 <code>case_info</code> データフレームとして定義します。</p>
<div class="sourceCode" id="cb711"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 要約統計表を作成する</span></span>
<span><span class="va">case_info</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">hospital</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    cases <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    deaths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">==</span> <span class="st">"Death"</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-11aacbf7a12cd81f5817" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-11aacbf7a12cd81f5817">{"x":{"filter":"none","vertical":false,"data":[["Central Hospital","Military Hospital","Missing","Other","Port Hospital","St. Mark's Maternity Hospital (SMMH)"],[454,896,1469,885,1762,422],[193,399,611,395,785,199]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>hospital<\/th>\n      <th>cases<\/th>\n      <th>deaths<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p>次に、別の情報を含むデータフレームを新たに作成します。ここでは、疫学調査された接触者（exposed contacts）の割合と「フォローアップ」された接触者の割合を病院ごとに含むデータフレーム <code>contact_fu</code> を作成します。</p>
<div class="sourceCode" id="cb712"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">contact_fu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  hospital <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"St. Mark's Maternity Hospital (SMMH)"</span>, <span class="st">"Military Hospital"</span>, <span class="st">"Missing"</span>, <span class="st">"Central Hospital"</span>, <span class="st">"Port Hospital"</span>, <span class="st">"Other"</span><span class="op">)</span>,</span>
<span>  investigated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"80%"</span>, <span class="st">"82%"</span>, <span class="cn">NA</span>, <span class="st">"78%"</span>, <span class="st">"64%"</span>, <span class="st">"55%"</span><span class="op">)</span>,</span>
<span>  per_fu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"60%"</span>, <span class="st">"25%"</span>, <span class="cn">NA</span>, <span class="st">"20%"</span>, <span class="st">"75%"</span>, <span class="st">"80%"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-89b9cc369add44ac5736" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-89b9cc369add44ac5736">{"x":{"filter":"none","vertical":false,"data":[["St. Mark's Maternity Hospital (SMMH)","Military Hospital","Missing","Central Hospital","Port Hospital","Other"],["80%","82%",null,"78%","64%","55%"],["60%","25%",null,"20%","75%","80%"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>hospital<\/th>\n      <th>investigated<\/th>\n      <th>per_fu<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p>どちらのデータフレームにも同じ病院が含まれていますが、データフレームごとに病院の順序が異なることに注意してください。病院名の順序をそろえる最も簡単な方法は、病院の列で <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code> を使用することですが、もう一つステップを追加することにより <code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols()</a></code> を使用することもできます。</p>
<div id="match-を使用して順序を揃える" class="section level4 unnumbered">
<h4>
<code>match()</code> を使用して順序を揃える<a class="anchor" aria-label="anchor" href="#match-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6%E9%A0%86%E5%BA%8F%E3%82%92%E6%8F%83%E3%81%88%E3%82%8B"><i class="fas fa-link"></i></a>
</h4>
<p>今回の例では、それぞれのデータフレームにおいて行の順序が異なるため、このまま <code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols()</a></code> コマンドを実行すると、データの不一致が生じます。正しく列をバインドするためには、<strong>base</strong> R の <code><a href="https://rdrr.io/r/base/match.html">match()</a></code> を使用し、データフレームの行の順序をもう一つのデータフレームの行の順序で並び替えます。 この方法では、どちらのデータフレームにも重複する値がないことを前提としています。</p>
<p><code><a href="https://rdrr.io/r/base/match.html">match()</a></code> を使用する場合の構文は、<code>match(TARGET ORDER VECTOR, DATA FRAME COLUMN TO CHANGE)</code> です。この構文では、最初の引数には目的の順序（単一のベクトル、またはこの例ではデータフレームの列）を指定し、2 番目の引数には並べ替えたいデータフレームの列を指定します。<code><a href="https://rdrr.io/r/base/match.html">match()</a></code> を実行すると、正しい位置の順序を表す数値のベクトルが出力されます。<code><a href="https://rdrr.io/r/base/match.html">match()</a></code> に関する詳細は、<code><a href="https://rdrr.io/r/base/match.html">?match</a></code> をコンソールで実行して確認してください。</p>
<div class="sourceCode" id="cb713"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">case_info</span><span class="op">$</span><span class="va">hospital</span>, <span class="va">contact_fu</span><span class="op">$</span><span class="va">hospital</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 4 2 3 6 5 1</code></pre>
<p>出力される数値ベクトルをサブセットブラケット <code>[ ]</code> 内の<u>コンマの前に</u>指定して、データフレームを並べ替えることができま。<strong>base</strong> R のサブセットブラケット <code>[ ]</code> の使い方は、<a href="basics.html#basics">R の基礎</a> の章で詳しく説明されていますので、必要な方はご参照ください。以下のコマンドでは、<code><a href="https://rdrr.io/r/base/match.html">match()</a></code> によって出力される数値ベクトルで並び替えられた行のデータフレームを新しく作成し、新しいデータフレームとして定義しします。</p>
<div class="sourceCode" id="cb715"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">contact_fu_aligned</span> <span class="op">&lt;-</span> <span class="va">contact_fu</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">case_info</span><span class="op">$</span><span class="va">hospital</span>, <span class="va">contact_fu</span><span class="op">$</span><span class="va">hospital</span><span class="op">)</span>,<span class="op">]</span></span></code></pre></div>
<div id="htmlwidget-bc0039efc82ee32cfec5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-bc0039efc82ee32cfec5">{"x":{"filter":"none","vertical":false,"data":[["Central Hospital","Military Hospital","Missing","Other","Port Hospital","St. Mark's Maternity Hospital (SMMH)"],["78%","82%",null,"55%","64%","80%"],["20%","25%",null,"80%","75%","60%"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>hospital<\/th>\n      <th>investigated<\/th>\n      <th>per_fu<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p>これで、正しい行の順序（互いに一致する行の順序）でデータフレームの列を結合できます。 一部の列が重複しているため、結合前に <code><a href="https://dplyr.tidyverse.org/reference/rename.html">rename()</a></code> でクリーニングする必要があることに注意してください。<code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows()</a></code> や <code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols()</a></code> についての詳細は、<a href="https://dplyr.tidyverse.org/reference/bind.html">こちら</a> をご覧ください。</p>
<div class="sourceCode" id="cb716"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span><span class="va">case_info</span>, <span class="va">contact_fu</span><span class="op">)</span></span></code></pre></div>
<pre><code>## New names:
## • `hospital` -&gt; `hospital...1`
## • `hospital` -&gt; `hospital...4`</code></pre>
<pre><code>## # A tibble: 6 × 6
##   hospital...1                         cases deaths hospital...4  inves…¹ per_fu
##   &lt;chr&gt;                                &lt;int&gt;  &lt;int&gt; &lt;chr&gt;         &lt;chr&gt;   &lt;chr&gt; 
## 1 Central Hospital                       454    193 St. Mark's M… 80%     60%   
## 2 Military Hospital                      896    399 Military Hos… 82%     25%   
## 3 Missing                               1469    611 Missing       &lt;NA&gt;    &lt;NA&gt;  
## 4 Other                                  885    395 Central Hosp… 78%     20%   
## 5 Port Hospital                         1762    785 Port Hospital 64%     75%   
## 6 St. Mark's Maternity Hospital (SMMH)   422    199 Other         55%     80%   
## # … with abbreviated variable name ¹​investigated</code></pre>
<p><strong>base</strong> R にも <code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols()</a></code> と同様の働きをする <code><a href="https://rdrr.io/r/base/cbind.html">cbind()</a></code> という関数があります。</p>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="参考資料-7" class="section level2" number="14.5">
<h2>
<span class="header-section-number">14.5</span> 参考資料<a class="anchor" aria-label="anchor" href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99-7"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://dplyr.tidyverse.org/reference/join.html">Join に関する Tidyverse のページ</a></p>
<p><a href="https://r4ds.had.co.nz/relational-data.html">相関性データに関する R for Data Science のページ</a></p>
<p><a href="https://dplyr.tidyverse.org/reference/bind.html">dplyr bind に関する Tidyverse のページ</a></p>
<p><a href="https://github.com/kosukeimai/fastLink">fastLink パッケージの コード例（Github）</a></p>
<p><a href="https://imai.fas.harvard.edu/research/files/linkage.pdf">fastLink についての論文</a></p>
<p><a href="https://journal.r-project.org/archive/2010/RJ-2010-017/RJ-2010-017.pdf">RecordLinkage package についての論文</a></p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="grouping.html"><span class="header-section-number">13</span> データのグループ化</a></div>
<div class="next"><a href="deduplication.html"><span class="header-section-number">15</span> 重複データの排除</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#joining-matching"><span class="header-section-number">14</span> データの結合</a></li>
<li>
<a class="nav-link" href="#%E6%BA%96%E5%82%99-5"><span class="header-section-number">14.1</span> 準備</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80">パッケージを読み込む</a></li>
<li><a class="nav-link" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88-6">データのインポート</a></li>
<li><a class="nav-link" href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88">サンプルデータセット</a></li>
<li><a class="nav-link" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%89%8D%E5%87%A6%E7%90%86">データの前処理</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#dplyr-%E3%81%AB%E3%82%88%E3%82%8B%E7%B5%90%E5%90%88"><span class="header-section-number">14.2</span> dplyr による結合</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E4%B8%80%E8%88%AC%E7%9A%84%E3%81%AA%E6%A7%8B%E6%96%87">一般的な構文</a></li>
<li><a class="nav-link" href="#%E5%B7%A6%E7%B5%90%E5%90%88left-join%E3%81%A8%E5%8F%B3%E7%B5%90%E5%90%88right-join">左結合（left join）と右結合（right join）</a></li>
<li><a class="nav-link" href="#%E5%AE%8C%E5%85%A8%E7%B5%90%E5%90%88full-join">完全結合（full join）</a></li>
<li><a class="nav-link" href="#%E5%86%85%E9%83%A8%E7%B5%90%E5%90%88inner-join">内部結合（inner join）</a></li>
<li><a class="nav-link" href="#%E6%BA%96%E7%B5%90%E5%90%88semi-join">準結合（semi join）</a></li>
<li><a class="nav-link" href="#%E3%82%A2%E3%83%B3%E3%83%81%E7%B5%90%E5%90%88anti-join">アンチ結合（anti join）</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E7%A2%BA%E7%8E%87%E7%9A%84%E3%83%9E%E3%83%83%E3%83%81%E3%83%B3%E3%82%B0"><span class="header-section-number">14.3</span> 確率的マッチング</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E7%A2%BA%E7%8E%87%E7%9A%84%E3%83%9E%E3%83%83%E3%83%81%E3%83%B3%E3%82%B0-1">確率的マッチング</a></li>
<li><a class="nav-link" href="#%E7%A2%BA%E7%8E%87%E7%9A%84%E3%81%AA%E9%87%8D%E8%A4%87%E6%8E%92%E9%99%A4">確率的な重複排除</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E7%B5%90%E5%90%88%E3%81%A8%E6%95%B4%E5%88%97"><span class="header-section-number">14.4</span> データの結合と整列</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E8%A1%8C%E3%82%92%E3%83%90%E3%82%A4%E3%83%B3%E3%83%89%E3%81%99%E3%82%8B">行をバインドする</a></li>
<li><a class="nav-link" href="#%E5%88%97%E3%82%92%E3%83%90%E3%82%A4%E3%83%B3%E3%83%89%E3%81%99%E3%82%8B">列をバインドする</a></li>
</ul>
</li>
<li><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99-7"><span class="header-section-number">14.5</span> 参考資料</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>疫学のための R ハンドブック</strong>" was written by the handbook team. It was last built on 2022-10-10.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
