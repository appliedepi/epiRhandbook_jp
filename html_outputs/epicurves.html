<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>32 流行曲線（エピカーブ） | 疫学のための R ハンドブック</title>
<meta name="author" content="the handbook team">
<meta name="description" content="流行曲線（「エピカーブ」とも呼ばれる）は、流行集団（クラスター）における疾病の発症の時間的パターンを可視化するための基本的な疫学グラフです。...">
<meta name="generator" content="bookdown 0.31 with bs4_book()">
<meta property="og:title" content="32 流行曲線（エピカーブ） | 疫学のための R ハンドブック">
<meta property="og:type" content="book">
<meta property="og:description" content="流行曲線（「エピカーブ」とも呼ばれる）は、流行集団（クラスター）における疾病の発症の時間的パターンを可視化するための基本的な疫学グラフです。...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="32 流行曲線（エピカーブ） | 疫学のための R ハンドブック">
<meta name="twitter:description" content="流行曲線（「エピカーブ」とも呼ばれる）は、流行集団（クラスター）における疾病の発症の時間的パターンを可視化するための基本的な疫学グラフです。...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.2/transition.js"></script><script src="libs/bs3compat-0.4.2/tabs.js"></script><script src="libs/bs3compat-0.4.2/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.6.1/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.26/datatables.js"></script><link href="libs/dt-core-1.12.1/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.12.1/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.12.1/js/jquery.dataTables.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/tabwid-1.1.2/tabwid.css" rel="stylesheet">
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.9/grViz.js"></script><script src="libs/d3-4.5.0/d3.min.js"></script><script src="libs/sankey-1/sankey.js"></script><script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script><script src="libs/plotly-binding-4.10.1/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-2.11.1/plotly-latest.min.js"></script><link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="libs/vis-9.1.0/vis-network.min.js"></script><script src="libs/visNetwork-binding-2.1.2/visNetwork.js"></script><link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="libs/plotly-basic-2.11.1/plotly-basic-2.11.1.min.js"></script><script src="libs/plotly-cartesian-2.11.1/plotly-cartesian-2.11.1.min.js"></script><script src="libs/proj4js-2.3.15/proj4.js"></script><link href="libs/highcharts-9.3.1/css/motion.css" rel="stylesheet">
<script src="libs/highcharts-9.3.1/highcharts.js"></script><script src="libs/highcharts-9.3.1/highcharts-3d.js"></script><script src="libs/highcharts-9.3.1/highcharts-more.js"></script><script src="libs/highcharts-9.3.1/modules/stock.js"></script><script src="libs/highcharts-9.3.1/modules/map.js"></script><script src="libs/highcharts-9.3.1/modules/data.js"></script><script src="libs/highcharts-9.3.1/modules/exporting.js"></script><script src="libs/highcharts-9.3.1/modules/offline-exporting.js"></script><script src="libs/highcharts-9.3.1/modules/drilldown.js"></script><script src="libs/highcharts-9.3.1/modules/item-series.js"></script><script src="libs/highcharts-9.3.1/modules/overlapping-datalabels.js"></script><script src="libs/highcharts-9.3.1/modules/annotations.js"></script><script src="libs/highcharts-9.3.1/modules/export-data.js"></script><script src="libs/highcharts-9.3.1/modules/funnel.js"></script><script src="libs/highcharts-9.3.1/modules/heatmap.js"></script><script src="libs/highcharts-9.3.1/modules/treemap.js"></script><script src="libs/highcharts-9.3.1/modules/sankey.js"></script><script src="libs/highcharts-9.3.1/modules/dependency-wheel.js"></script><script src="libs/highcharts-9.3.1/modules/organization.js"></script><script src="libs/highcharts-9.3.1/modules/solid-gauge.js"></script><script src="libs/highcharts-9.3.1/modules/streamgraph.js"></script><script src="libs/highcharts-9.3.1/modules/sunburst.js"></script><script src="libs/highcharts-9.3.1/modules/vector.js"></script><script src="libs/highcharts-9.3.1/modules/wordcloud.js"></script><script src="libs/highcharts-9.3.1/modules/xrange.js"></script><script src="libs/highcharts-9.3.1/modules/tilemap.js"></script><script src="libs/highcharts-9.3.1/modules/venn.js"></script><script src="libs/highcharts-9.3.1/modules/gantt.js"></script><script src="libs/highcharts-9.3.1/modules/timeline.js"></script><script src="libs/highcharts-9.3.1/modules/parallel-coordinates.js"></script><script src="libs/highcharts-9.3.1/modules/bullet.js"></script><script src="libs/highcharts-9.3.1/modules/coloraxis.js"></script><script src="libs/highcharts-9.3.1/modules/dumbbell.js"></script><script src="libs/highcharts-9.3.1/modules/lollipop.js"></script><script src="libs/highcharts-9.3.1/modules/series-label.js"></script><script src="libs/highcharts-9.3.1/plugins/motion.js"></script><script src="libs/highcharts-9.3.1/custom/reset.js"></script><script src="libs/highcharts-9.3.1/modules/boost.js"></script><script src="libs/highchart-binding-0.9.4/highchart.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QXDW878QLX');
    </script><script type="text/javascript">
        // window.addEventListener("load", function() {
        //     document.getElementById('toc').firstChild.innerHTML = "章目次"; 
        // });
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementsByClassName("d-flex align-items-start justify-content-between")[0].children[0].children[0].innerHTML = "疫学のための R</br>ハンドブック";
            document.getElementById('toc').firstChild.innerHTML = "章目次"; 
            document.getElementById('main-nav').children[1].firstChild.innerHTML = "総目次";
            document.getElementById('search').setAttribute("placeholder", "検索");
        });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style_bs4.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">疫学のための R ハンドブック</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"></a></li>
<li class="book-part">本書について</li>
<li><a class="" href="editorial-style.html"><span class="header-section-number">1</span> 編集前記・技術注記</a></li>
<li><a class="" href="data-used.html"><span class="header-section-number">2</span> ハンドブックとデータのダウンロード</a></li>
<li class="book-part">基本編</li>
<li><a class="" href="basics.html"><span class="header-section-number">3</span> R の基礎</a></li>
<li><a class="" href="transition-to-R.html"><span class="header-section-number">4</span> Excel・Stata・SASとの比較</a></li>
<li><a class="" href="packages-suggested.html"><span class="header-section-number">5</span> 推奨パッケージ</a></li>
<li><a class="" href="r-projects.html"><span class="header-section-number">6</span> R プロジェクト</a></li>
<li><a class="" href="importing.html"><span class="header-section-number">7</span> データのインポート・エクスポート</a></li>
<li class="book-part">データマネジメント</li>
<li><a class="" href="cleaning.html"><span class="header-section-number">8</span> データクリーニングと主要関数</a></li>
<li><a class="" href="dates.html"><span class="header-section-number">9</span> 日付型データ</a></li>
<li><a class="" href="characters-strings.html"><span class="header-section-number">10</span> 文字型・文字列型データ</a></li>
<li><a class="" href="factors.html"><span class="header-section-number">11</span> 因子（ファクタ）型データ</a></li>
<li><a class="" href="pivoting.html"><span class="header-section-number">12</span> データの縦横変換</a></li>
<li><a class="" href="grouping.html"><span class="header-section-number">13</span> データのグループ化</a></li>
<li><a class="" href="joining-matching.html"><span class="header-section-number">14</span> データの結合</a></li>
<li><a class="" href="deduplication.html"><span class="header-section-number">15</span> 重複データの排除</a></li>
<li><a class="" href="iteration.html"><span class="header-section-number">16</span> ループと反復処理・リストの操作</a></li>
<li class="book-part">データ分析</li>
<li><a class="" href="tables-descriptive.html"><span class="header-section-number">17</span> 記述統計表の作り方</a></li>
<li><a class="" href="stat-tests.html"><span class="header-section-number">18</span> 基本的な統計的検定</a></li>
<li><a class="" href="regression.html"><span class="header-section-number">19</span> 単変量と多変量回帰</a></li>
<li><a class="" href="missing-data.html"><span class="header-section-number">20</span> データの欠損</a></li>
<li><a class="" href="standardization.html"><span class="header-section-number">21</span> 標準化率</a></li>
<li><a class="" href="moving-average.html"><span class="header-section-number">22</span> 移動平均</a></li>
<li><a class="" href="time-series.html"><span class="header-section-number">23</span> 時系列分析とアウトブレイクの検出</a></li>
<li><a class="" href="epidemic-models.html"><span class="header-section-number">24</span> エピデミックモデリング</a></li>
<li><a class="" href="contact-tracing.html"><span class="header-section-number">25</span> 接触者の追跡</a></li>
<li><a class="" href="survey-analysis.html"><span class="header-section-number">26</span> 標本調査データ分析</a></li>
<li><a class="" href="survival-analysis.html"><span class="header-section-number">27</span> 生存時間解析</a></li>
<li><a class="" href="gis.html"><span class="header-section-number">28</span> GIS の基本</a></li>
<li class="book-part">データの可視化</li>
<li><a class="" href="tables-presentation.html"><span class="header-section-number">29</span> 見やすい表の作り方</a></li>
<li><a class="" href="ggplot-basics.html"><span class="header-section-number">30</span> ggplot の基本</a></li>
<li><a class="" href="ggplot-tips.html"><span class="header-section-number">31</span> ggplotのヒント</a></li>
<li><a class="active" href="epicurves.html"><span class="header-section-number">32</span> 流行曲線（エピカーブ）</a></li>
<li><a class="" href="age-pyramid.html"><span class="header-section-number">33</span> 人口ピラミッドとリッカート尺度</a></li>
<li><a class="" href="heatmaps.html"><span class="header-section-number">34</span> ヒートマップ</a></li>
<li><a class="" href="diagrams.html"><span class="header-section-number">35</span> フローチャート・サンキー図・タイムライン</a></li>
<li><a class="" href="combination-analysis.html"><span class="header-section-number">36</span> 複数回答データの分析</a></li>
<li><a class="" href="transmission-chains.html"><span class="header-section-number">37</span> 感染連鎖</a></li>
<li><a class="" href="phylogenetic-trees.html"><span class="header-section-number">38</span> 系統樹</a></li>
<li><a class="" href="interactive-plots.html"><span class="header-section-number">39</span> 動的な図の作成</a></li>
<li class="book-part">レポートとダッシュボード</li>
<li><a class="" href="rmarkdown.html"><span class="header-section-number">40</span> R Markdown で作るレポート</a></li>
<li><a class="" href="reportfactory.html"><span class="header-section-number">41</span> ルーチンで作成するレポートの整理</a></li>
<li><a class="" href="flexdashboard.html"><span class="header-section-number">42</span> R Markdownで作るダッシュボード</a></li>
<li><a class="" href="shiny-basics.html"><span class="header-section-number">43</span> Shiny で作るダッシュボード</a></li>
<li class="book-part">その他</li>
<li><a class="" href="writing-functions.html"><span class="header-section-number">44</span> 関数の作成</a></li>
<li><a class="" href="directories.html"><span class="header-section-number">45</span> ディレクトリの操作</a></li>
<li><a class="" href="collaboration.html"><span class="header-section-number">46</span> Git と Github を使ったバージョン管理と共同作業</a></li>
<li><a class="" href="errors.html"><span class="header-section-number">47</span> よくあるエラー</a></li>
<li><a class="" href="help.html"><span class="header-section-number">48</span> ヘルプ</a></li>
<li><a class="" href="network-drives.html"><span class="header-section-number">49</span> ネットワークドライブで R を使用する場合</a></li>
<li><a class="" href="data-table.html"><span class="header-section-number">50</span> data.table パッケージを使用したデータ処理</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="epicurves" class="section level1" number="32">
<h1>
<span class="header-section-number">32</span> 流行曲線（エピカーブ）<a class="anchor" aria-label="anchor" href="#epicurves"><i class="fas fa-link"></i></a>
</h1>
<div class="inline-figure"><img src="images/epicurve_top.png" width="75%"></div>
<p>流行曲線（「エピカーブ」とも呼ばれる）は、流行集団（クラスター）における疾病の発症の時間的パターンを可視化するための基本的な疫学グラフです。</p>
<p>流行曲線を分析することで、時間的な傾向、異常値、アウトブレイクの規模、曝露の可能性が最も高い時期、症例の世代間の時間間隔などが明らかになり、さらには未知の新しい疾患の伝播様式（点源、継続的な共通感染源、人から人への伝播など）を特定するのにも役立ちます。流行曲線の解釈に関するオンライン上の資料の 1 つとして、米国疾病予防管理センター（Centers for Disease Control and Prevention; CDC）の <a href="https://www.cdc.gov/training/quicklearns/epimode/index.html">公式ウェブサイト</a> があります。</p>
<p>本章では、R で流行曲線を作成する 2 つの方法を紹介します。</p>
<ul>
<li>
<strong>incidence2</strong> パッケージを使用し、簡単なコマンドのみで流行曲線を作成することができる方法<br>
</li>
<li>
<strong>ggplot2</strong> パッケージを使用し、より複雑なコマンドで高度なカスタマイズができる方法</li>
</ul>
<p>また、以下のような具体的な使用例も紹介します。</p>
<ul>
<li><p>集計データのプロット</p></li>
<li><p>ファセット化（小さなグラフを複数作成する）</p></li>
<li><p>移動平均の適用</p></li>
<li><p>報告が遅れている「暫定」データの表示</p></li>
<li><p>累積症例数を第 2 軸で重ね合わせたプロット</p></li>
</ul>
<!-- ======================================================= --><div id="準備-23" class="section level2" number="32.1">
<h2>
<span class="header-section-number">32.1</span> 準備<a class="anchor" aria-label="anchor" href="#%E6%BA%96%E5%82%99-23"><i class="fas fa-link"></i></a>
</h2>
<div id="パッケージの読み込み-16" class="section level3 unnumbered">
<h3>パッケージの読み込み<a class="anchor" aria-label="anchor" href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF-16"><i class="fas fa-link"></i></a>
</h3>
<p>解析に必要な標準パッケージを読み込みます。 このハンドブックでは、パッケージを読み込むために、<strong>pacman</strong> パッケージの <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load()</a></code> を主に使用しています。<code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load()</a></code> は、必要に応じてパッケージをインストールし、現在の R セッションで使用するためにパッケージを読み込む関数です。また、すでにインストールされたパッケージは、R の基本パッケージである <strong>base</strong> の <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> を使用して読み込むこともできます。R パッケージについての詳細は、<a href="basics.html#basics">R の基礎</a> の章を参照してください。</p>
<div class="sourceCode" id="cb1514"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">rio</span>,          <span class="co"># file import/export</span></span>
<span>  <span class="va">here</span>,         <span class="co"># relative filepaths </span></span>
<span>  <span class="va">lubridate</span>,    <span class="co"># working with dates/epiweeks</span></span>
<span>  <span class="va">aweek</span>,        <span class="co"># alternative package for working with dates/epiweeks</span></span>
<span>  <span class="va">incidence2</span>,   <span class="co"># epicurves of linelist data</span></span>
<span>  <span class="va">i2extras</span>,     <span class="co"># supplement to incidence2</span></span>
<span>  <span class="va">stringr</span>,      <span class="co"># search and manipulate character strings</span></span>
<span>  <span class="va">forcats</span>,      <span class="co"># working with factors</span></span>
<span>  <span class="va">RColorBrewer</span>, <span class="co"># Color palettes from colorbrewer2.org</span></span>
<span>  <span class="va">tidyverse</span>     <span class="co"># data management + ggplot2 graphics</span></span>
<span><span class="op">)</span> </span></code></pre></div>
</div>
<div id="データのインポート-13" class="section level3" number="32.1.1">
<h3>
<span class="header-section-number">32.1.1</span> <strong>データのインポート</strong><a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88-13"><i class="fas fa-link"></i></a>
</h3>
<p>この章では2つのデータセットを使用します。</p>
<ul>
<li>流行のシミュレーションデータから作成された症例ごとのデータ（ラインリスト）<br>
</li>
<li>同じ流行のシミュレーションデータから作成された病院ごとの症例数の集計値</li>
</ul>
<p>データセットは、<strong>rio</strong> パッケージの <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> を使ってインポートします。データをインポートする様々な方法については、<a href="importing.html#importing">データのインポート・エクスポート</a> の章を参照してください。</p>
<p><strong>ラインリスト（linelist）</strong></p>
<p>エボラ出血熱の流行をシミュレートしたデータセットをインポートします。この章の内容をお手元の環境で実行したい方は、<a href="data-used.html#data-used">ハンドブックとデータのダウンロード</a> の章をご覧ください。ファイルが作業ディレクトリにある場合、ファイルパスにはファイル名のみ指定します。</p>
<div class="sourceCode" id="cb1515"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"linelist_cleaned.rds"</span><span class="op">)</span> </span></code></pre></div>
<p>以下に、最初の 50 行を表示します。</p>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-5abc3fcc9641f3412ebf" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-5abc3fcc9641f3412ebf">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],[4,4,2,3,3,3,4,4,4,4,4,4,6,5,6,9,10,8,7,6,7,6,8,6,10,8,6,12,5,8,7,9,11,5,8,5,6,11,7,9,7,8,9,12,13,9,8,10,8,7],["2014-05-08",null,null,"2014-05-04","2014-05-18","2014-05-03","2014-05-22","2014-05-28",null,null,"2014-05-30","2014-05-28","2014-06-14","2014-06-07","2014-06-09",null,null,null,"2014-06-23","2014-06-18","2014-06-24",null,null,"2014-07-03",null,"2014-07-10","2014-06-14",null,"2014-06-18","2014-06-29","2014-07-02","2014-07-12","2014-07-12","2014-06-13","2014-07-15","2014-06-20",null,null,"2014-07-20",null,"2014-07-12","2014-07-19","2014-07-18","2014-07-18","2014-07-27",null,"2014-07-19","2014-07-26","2014-07-24",null],["2014-05-13","2014-05-13","2014-05-16","2014-05-18","2014-05-21","2014-05-22","2014-05-27","2014-06-02","2014-06-05","2014-06-05","2014-06-06","2014-06-13","2014-06-16","2014-06-17","2014-06-18","2014-06-19","2014-06-22","2014-06-23","2014-06-25","2014-06-26","2014-06-28","2014-07-02","2014-07-08","2014-07-09","2014-07-09","2014-07-10","2014-07-12","2014-07-12","2014-07-13","2014-07-13","2014-07-14","2014-07-15","2014-07-16","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-22","2014-07-22","2014-07-24","2014-07-24","2014-07-25","2014-07-25","2014-07-27","2014-07-29","2014-07-30",null,"2014-08-01","2014-08-02","2014-08-03"],["2014-05-15","2014-05-14","2014-05-18","2014-05-20","2014-05-22","2014-05-23","2014-05-29","2014-06-03","2014-06-06","2014-06-07","2014-06-08","2014-06-15","2014-06-17","2014-06-17","2014-06-20","2014-06-19","2014-06-23","2014-06-24","2014-06-27","2014-06-28","2014-06-29","2014-07-03","2014-07-09","2014-07-09","2014-07-11","2014-07-11","2014-07-13","2014-07-14","2014-07-14","2014-07-13","2014-07-14","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-20","2014-07-20","2014-07-22","2014-07-24","2014-07-26","2014-07-24","2014-07-27","2014-07-25","2014-07-27","2014-07-31","2014-08-01","2014-08-03","2014-08-02","2014-08-02","2014-08-04"],[null,"2014-05-18","2014-05-30",null,"2014-05-29","2014-05-24","2014-06-01","2014-06-07","2014-06-18","2014-06-09","2014-06-15",null,"2014-07-09",null,"2014-06-30","2014-07-11","2014-07-01","2014-06-25","2014-07-06","2014-07-02","2014-07-09","2014-07-07","2014-07-20",null,"2014-07-22","2014-07-16","2014-07-14","2014-07-20","2014-07-16","2014-07-19","2014-07-27","2014-07-19",null,"2014-07-26","2014-08-14","2014-08-01","2014-07-23","2014-08-28","2014-07-28","2014-07-19",null,"2014-08-03",null,null,null,"2014-08-06","2014-08-21","2014-09-13","2014-08-04",null],[null,"Recover","Recover",null,"Recover","Recover","Recover","Death","Recover","Death","Death","Death","Recover","Recover",null,"Recover",null,null,"Death","Death","Recover",null,null,null,"Death",null,"Death","Death",null,"Death","Recover","Death","Recover","Death","Recover",null,"Death","Recover","Recover","Death",null,null,"Death","Death","Death","Death","Recover",null,"Death","Death"],["m","f","m","f","m","f","f","f","m","f","m","m","m","f","f","m","f","f","f","f","m","m","f","m","f","m","m","f","m","f","f","f","m","m","f","m","f","f","f","m","f","m","f","m","m","f","m","f","m","m"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["0-4","0-4","50-69","15-19","0-4","15-19","15-19","0-4","50-69","20-29","10-14","30-49","15-19","5-9","5-9","10-14","30-49","15-19","10-14","10-14","15-19","50-69","10-14","20-29","5-9","0-4","30-49","5-9","50-69","10-14","10-14","20-29","20-29","30-49","0-4","10-14","0-4","15-19","20-29","30-49","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-29","20-29","10-14"],["0-4","0-4","55-59","15-19","0-4","15-19","15-19","0-4","60-64","25-29","10-14","40-44","15-19","5-9","5-9","10-14","35-39","15-19","10-14","10-14","15-19","50-54","10-14","25-29","5-9","0-4","30-34","5-9","65-69","10-14","10-14","20-24","20-24","45-49","0-4","10-14","0-4","15-19","20-24","35-39","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-24","25-29","10-14"],["Other","Missing","St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Port Hospital","Missing","Missing","Missing","Missing","Port Hospital","Military Hospital","Missing","Missing","Other","Port Hospital","Port Hospital","Port Hospital","Missing","Other","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)","Missing","Other","Missing","St. Mark's Maternity Hospital (SMMH)","Military Hospital","Port Hospital","Central Hospital","Military Hospital","Central Hospital","Missing","Military Hospital","Other","Missing","Missing","Port Hospital","Port Hospital","Port Hospital","Missing","Central Hospital","Military Hospital","Other","Other","Other","Missing","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","Missing"],[-13.2157351064963,-13.2152339775486,-13.212910703914,-13.2363711169728,-13.2228638912441,-13.222625321098,-13.2331547837254,-13.2320975453153,-13.2225511595637,-13.2572163655863,-13.2206286746001,-13.253989309478,-13.2385127873491,-13.209391925612,-13.2157278814899,-13.2243437095992,-13.2336087079551,-13.21422143145,-13.2339681355349,-13.2535640411465,-13.2250089377786,-13.2160657166043,-13.2680671272333,-13.2266742923612,-13.2160179088168,-13.2482584611565,-13.2156319199566,-13.2142410663192,-13.2614879104088,-13.2452992638476,-13.2630592726116,-13.2343341712241,-13.2199077448676,-13.2227293309912,-13.2343062806506,-13.218781651651,-13.2483677722899,-13.2097478342339,-13.2680867723786,-13.2587535457526,-13.262635786914,-13.2697246824573,-13.2209026809759,-13.2330734719715,-13.2680923666905,-13.2547212675054,-13.2573683214693,-13.2137356012883,-13.2175973322257,-13.2486407324245],[8.46897295100924,8.45171855856465,8.46481700596819,8.4754761613651,8.46082377490923,8.46183062600728,8.46272931462646,8.46144367534271,8.46191259217774,8.47292327643506,8.48401630165138,8.45837125340844,8.47761705512509,8.47570184950483,8.47779946878972,8.47145134147474,8.47804840685363,8.48528034195779,8.46957530395867,8.45957352078114,8.47404889511544,8.48802917129884,8.473437335922,8.48408263734462,8.46242233645879,8.47026822126572,8.46398447480533,8.4641347894342,8.45623094629607,8.48334624336805,8.47493999153642,8.47832062438022,8.4693933891765,8.48480589906514,8.47121232619015,8.48438437371817,8.48466158574339,8.47714159984428,8.46238127010609,8.45568597813113,8.4632880274758,8.47940722413856,8.46353857052336,8.46178968158864,8.47508713872833,8.45825808128071,8.4532568143863,8.4732571907655,8.47911586641933,8.48480340615605],["f547d6",null,null,"f90f5f","11f8ea","aec8ec","893f25","133ee7",null,null,"996f3a","133ee7","37a6f6","9f6884","4802b1",null,null,null,"a75c7f","8e104d","ab634e",null,null,"b799eb",null,"5d9e4d","a15e13",null,"ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277",null,null,"d6584f",null,"312ecf","52ea64","cfd79c","d145b7","174288",null,"53608c","3b096b","f5c142",null],["other",null,null,"other","other","other","other","other",null,null,"other","other","other","other","other",null,null,null,"other","other","other",null,null,"other",null,"other","other",null,"other","funeral","other","funeral","other","other","other","funeral",null,null,"other",null,"other","other","other","other","other",null,"funeral","other","other",null],[27,25,91,41,36,56,47,0,86,69,67,84,68,44,34,66,78,47,53,47,71,86,53,69,38,46,68,37,100,56,50,57,65,72,29,69,37,48,54,71,47,61,47,35,53,16,13,59,69,67],[48,59,238,135,71,116,87,11,226,174,112,186,174,90,91,152,214,137,117,131,150,241,131,161,80,69,188,66,233,142,110,182,164,214,26,157,39,154,133,168,100,125,123,67,134,31,36,125,183,169],[22,22,21,23,23,21,21,22,22,22,22,22,22,21,23,22,23,21,22,23,21,23,21,24,23,22,24,23,20,24,24,20,24,21,22,21,23,22,23,23,23,22,23,22,22,22,23,22,22,22],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","no","no","no","no","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","yes","no",null,"no","no","no","yes","no",null,"no","no","yes",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","yes","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","yes","yes","yes","yes","yes","yes","yes","yes","yes",null,"yes","yes","yes","yes","yes",null,"yes","yes","yes",null,null,"yes","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","yes","yes","yes","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","yes","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"yes","yes",null,"no","no",null,"no","no","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","no","yes","no","no","no","yes","no","no","no",null,"no","yes","no","no","no",null,"no","no","no",null,null,"no","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","no","yes","yes","yes",null],[36.8,36.9,36.9,36.8,36.9,37.6,37.3,37,36.4,35.9,36.5,36.9,36.5,37.1,36.5,37.3,37,38,38,36,37,36.7,36.9,36.5,37,36.5,37.6,36.6,36.6,36.2,36.4,37.1,37.5,37.5,37.4,36.9,36.4,37.3,37,37.8,36.5,37.5,36.7,37,37.3,36.6,36.5,36.6,37.6,36.8],[null,"09:36","16:48","11:22","12:60","14:13","14:33","09:25","11:16","10:55","16:03","11:14","12:42","11:06","09:10","08:45",null,"15:41","13:34","18:58","12:43","16:33","14:29","07:18","08:11","16:32","16:17","07:32","17:45",null,"13:24","14:43","02:33","11:36","17:28","16:27",null,"20:49",null,"11:38","14:25","13:42","21:22","13:33","19:06","17:14","20:09",null,"10:23","09:09"],[117.1875,71.8184429761563,16.0652496292635,22.4965706447188,71.4144019043841,41.6171224732461,62.0953890870657,0,16.8376536925366,22.7903289734443,53.4119897959184,24.2802636142907,22.4600343506408,54.320987654321,41.0578432556455,28.5664819944598,17.0320552013276,25.0412914912888,38.7172182043977,27.3876813705495,31.5555555555556,14.8069075945662,30.8839811199813,26.6193433895297,59.375,96.6183574879227,19.2394748755093,84.9403122130395,18.4199377406104,27.7722674072605,41.3223140495868,17.2080666586161,24.1671624033314,15.7218971089178,428.994082840237,27.9930220292912,243.261012491782,20.2395007589813,30.527446435638,25.15589569161,47,39.04,31.0661643201798,77.9683671196257,29.5165961238583,166.493236212279,100.308641975309,37.76,20.6037803457852,23.458562375267],[2,1,2,2,1,1,2,1,1,2,2,2,1,0,2,0,1,1,2,2,1,1,1,0,2,1,1,2,1,0,0,2,1,1,2,2,1,0,2,2,0,2,0,0,2,2,null,1,0,1]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>generation<\/th>\n      <th>date_infection<\/th>\n      <th>date_onset<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>date_outcome<\/th>\n      <th>outcome<\/th>\n      <th>gender<\/th>\n      <th>age<\/th>\n      <th>age_unit<\/th>\n      <th>age_years<\/th>\n      <th>age_cat<\/th>\n      <th>age_cat5<\/th>\n      <th>hospital<\/th>\n      <th>lon<\/th>\n      <th>lat<\/th>\n      <th>infector<\/th>\n      <th>source<\/th>\n      <th>wt_kg<\/th>\n      <th>ht_cm<\/th>\n      <th>ct_blood<\/th>\n      <th>fever<\/th>\n      <th>chills<\/th>\n      <th>cough<\/th>\n      <th>aches<\/th>\n      <th>vomit<\/th>\n      <th>temp<\/th>\n      <th>time_admission<\/th>\n      <th>bmi<\/th>\n      <th>days_onset_hosp<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,8,10,14,15,18,19,20,26,28,29]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p><strong>病院ごとの症例数</strong></p>
<p>以下のコードで、病院ごとの週別の集計数を含んだデータセットを <code>linelist</code> から作成します。</p>
<div class="sourceCode" id="cb1516"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 集計データをRにインポート</span></span>
<span><span class="va">count_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">hospital</span>, <span class="va">date_hospitalisation</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>n_cases <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">date_hospitalisation</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2013-06-01"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>以下に、最初の 50 行を表示します。</p>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-05453368469b305cfff6" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-05453368469b305cfff6">{"x":{"filter":"none","vertical":false,"data":[["Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital"],["2014-05-06","2014-05-10","2014-05-13","2014-05-28","2014-06-06","2014-06-09","2014-06-14","2014-06-19","2014-07-09","2014-07-10","2014-07-11","2014-07-13","2014-07-14","2014-07-15","2014-07-17","2014-07-19","2014-07-27","2014-07-30","2014-08-01","2014-08-02","2014-08-04","2014-08-05","2014-08-07","2014-08-09","2014-08-12","2014-08-14","2014-08-15","2014-08-16","2014-08-17","2014-08-18","2014-08-19","2014-08-20","2014-08-21","2014-08-22","2014-08-23","2014-08-24","2014-08-26","2014-08-28","2014-08-29","2014-08-30","2014-08-31","2014-09-01","2014-09-02","2014-09-03","2014-09-04","2014-09-05","2014-09-06","2014-09-07","2014-09-09","2014-09-10"],[1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,2,1,1,2,1,2,1,1,2,1,3,1,1,1,2,3,2,2,2,1,2,2,2,1,2,3,3,2,1,1,2,3,2,2,1]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>hospital<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>n_cases<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="パラメータの設定" class="section level3 unnumbered">
<h3>パラメータの設定<a class="anchor" aria-label="anchor" href="#%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%81%AE%E8%A8%AD%E5%AE%9A"><i class="fas fa-link"></i></a>
</h3>
<p>レポートを作成する際に、データの現在の日付（「データ日」）を設定することができます。<code>data_date</code> オブジェクトにデータ日を定義することで、データセットをフィルタリングする際や脚注を書く際に用いることができます。</p>
<div class="sourceCode" id="cb1517"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## レポート用に日付を設定</span></span>
<span><span class="co">## メモ：Sys.Date()でも最新の日付を設定することができます</span></span>
<span><span class="co">## note: can be set to Sys.Date() for the current date</span></span>
<span><span class="va">data_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2015-05-15"</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="日付の確認" class="section level3 unnumbered">
<h3>日付の確認<a class="anchor" aria-label="anchor" href="#%E6%97%A5%E4%BB%98%E3%81%AE%E7%A2%BA%E8%AA%8D"><i class="fas fa-link"></i></a>
</h3>
<p>各日付列のデータ型が日付型であることを確信し、また、適切な範囲であるかを確認します。欠損値を除外（ <code>na.rm=TRUE</code> ）した上で <code><a href="https://rdrr.io/r/base/range.html">range()</a></code> を用いて範囲を確認することができますし、 ヒストグラムで確認する場合は <code><a href="https://rdrr.io/r/graphics/hist.html">hist()</a></code> あるいは以下のように <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> を使って簡単に行うこともできます。</p>
<div class="sourceCode" id="cb1518"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 発症日の範囲を確認</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1117-1.png" width="50%"></div>
<!-- ======================================================= -->
</div>
</div>
<div id="incidence2-パッケージ-による流行曲線" class="section level2" number="32.2">
<h2>
<span class="header-section-number">32.2</span> <strong>incidence2</strong> パッケージ による流行曲線<a class="anchor" aria-label="anchor" href="#incidence2-%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8-%E3%81%AB%E3%82%88%E3%82%8B%E6%B5%81%E8%A1%8C%E6%9B%B2%E7%B7%9A"><i class="fas fa-link"></i></a>
</h2>
<p>以下では、<strong>incidence2</strong> パッケージを使用して流行曲線を作成する方法を解説します。<strong>incidence2</strong> パッケージの開発者は、ユーザーが <strong>ggplot2</strong> の構文を知らなくても流行曲線を作成できるようにしました。この章で触れる内容の多くは、<strong>incidence2</strong> の <a href="https://github.com/reconhub/incidence2">github page</a> を元に作成されました。</p>
<!-- ======================================================= -->
<div id="簡単な例" class="section level3 unnumbered">
<h3>簡単な例<a class="anchor" aria-label="anchor" href="#%E7%B0%A1%E5%8D%98%E3%81%AA%E4%BE%8B"><i class="fas fa-link"></i></a>
</h3>
<p><strong><em>incidence2</em></strong> パッケージを使用して流行曲線を作る方法は、以下の 2 つのステップからなります。</p>
<ol style="list-style-type: decimal">
<li>
<p><em>incidence</em> オブジェクトの作成 （ <code>incidence()</code> の使用）</p>
<ul>
<li>データを準備<br>
</li>
<li>
<code>date_index =</code> に日付列を指定<br>
</li>
<li>
<code>interval =</code> で症例の集計単位を指定 （日、週、月など）<br>
</li>
<li>グループ化する列の指定 （例：性別、病院、転帰）<br>
</li>
</ul>
</li>
<li>
<p><em>incidence</em> オブジェクトの可視化</p>
<ul>
<li>ラベル、色、タイトルなどの指定</li>
</ul>
</li>
</ol>
<p>以下では、<strong>incidence2</strong> パッケージを読み込み、<code>linelist</code> の <code>date_onset</code> 列（発症日の列） から incidence オブジェクトを作成し、発症日ごとの症例数を集計しています。そして、 incidence オブジェクトのサマリーを表示します。</p>
<div class="sourceCode" id="cb1519"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># incidence2 パッケージの読み込み</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">incidence2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># incidence オブジェクトを発症日別に集計して作成</span></span>
<span><span class="va">epi_day</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span>       <span class="co"># incidence オブジェクトの作成</span></span>
<span>  x <span class="op">=</span> <span class="va">linelist</span>,             <span class="co"># データセットの指定</span></span>
<span>  date_index <span class="op">=</span> <span class="va">date_onset</span>,  <span class="co"># 日付列の指定</span></span>
<span>  interval <span class="op">=</span> <span class="st">"day"</span>          <span class="co"># 集計単位の指定</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><strong>incidence2</strong> オブジェクト自体は、（データフレームのような）tibble のようになっていて、データフレームのように表示したり、さらに操作したりすることができます。</p>
<div class="sourceCode" id="cb1520"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">epi_day</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "incidence2"   "incidence_df" "tbl_df"       "tbl"          "data.frame"</code></pre>
<p>以下に、作成した incidence オブジェクトを表示します。 <code>date_index</code> と <code>count</code> 列があることがわかります。</p>
<div class="sourceCode" id="cb1522"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">epi_day</span></span></code></pre></div>
<pre><code>## An incidence object: 367 x 2
## date range: [2014-04-07] to [2015-04-30]
## cases: 5632
## interval: 1 day
## cumulative: FALSE
## 
##    date_index count
##    &lt;date&gt;     &lt;int&gt;
##  1 2014-04-07     1
##  2 2014-04-15     1
##  3 2014-04-21     2
##  4 2014-04-25     1
##  5 2014-04-26     1
##  6 2014-04-27     1
##  7 2014-05-01     2
##  8 2014-05-03     1
##  9 2014-05-04     1
## 10 2014-05-05     1
## # … with 357 more rows</code></pre>
<p>オブジェクトのサマリーも表示できます。</p>
<div class="sourceCode" id="cb1524"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># incidence オブジェクトのサマリーを表示</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">epi_day</span><span class="op">)</span></span></code></pre></div>
<pre><code>## date range: [2014-04-07] to [2015-04-30]
## cases: 5632
## interval: 1 day
## cumulative: FALSE
## timespan: 389 days</code></pre>
<p>incidence オブジェクトを可視化するためには incidence オブジェクトに対して <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> を使用します。 <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> を使用すると、バックグラウンドでは <code>plot.incidence2()</code> が呼び出されます。<strong>incidence2</strong> パッケージ固有のドキュメントを読みたい場合は、<code>?plot.incidence2</code> を実行してください。</p>
<div class="sourceCode" id="cb1526"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># incidence オブジェクトの可視化</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">epi_day</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1122-1.png" width="672"></div>
<p>白い縦線が多く表示される場合は、画像のサイズを調整しましょう。例えば、 <code><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave()</a></code> を使って図を出力した場合、 <code>width =</code> と <code>height =</code> に数字を入れることでサイズを調整できます。 プロットの幅を広げれば、このような線は消えるはずです。</p>
</div>
<div id="症例集計の時間単位の変更" class="section level3 unnumbered">
<h3>症例集計の時間単位の変更<a class="anchor" aria-label="anchor" href="#%E7%97%87%E4%BE%8B%E9%9B%86%E8%A8%88%E3%81%AE%E6%99%82%E9%96%93%E5%8D%98%E4%BD%8D%E3%81%AE%E5%A4%89%E6%9B%B4"><i class="fas fa-link"></i></a>
</h3>
<p><code>incidence()</code> の <code>interval =</code> という引数は、観察した症例をどのような時間単位で集計するかを定義します。</p>
<p><strong>時間単位の指定</strong></p>
<p>症例数を流行曲線に集約する方法を指定する方法について、<strong>incidence2</strong> パッケージの関数は、柔軟で分かりやすい構文をとります。<code>interval =</code> 引数には、以下のような値が指定できます。以下の例のいずれも複数形で書くことができ（例：“weeks”）、また、前に数字を付けることもできます（例：“3 months”）。</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th>引数オプション</th>
<th>補足説明</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>数字 (1, 7, 13, 14, 等)</td>
<td>集計単位となる日数</td>
</tr>
<tr class="even">
<td>“week”</td>
<td>メモ：月曜から始まるのがデフォルト</td>
</tr>
<tr class="odd">
<td>“2 weeks”</td>
<td>または3、４、５等</td>
</tr>
<tr class="even">
<td>“Sunday week”</td>
<td>日曜から始まる週 ( Thursday 等も可能）</td>
</tr>
<tr class="odd">
<td>“2 Sunday weeks”</td>
<td>または3、４、５等</td>
</tr>
<tr class="even">
<td>“MMWRweek”</td>
<td>日曜から始まる週（米国CDC参照）</td>
</tr>
<tr class="odd">
<td>“month”</td>
<td>月の最初の日</td>
</tr>
<tr class="even">
<td>“quarter”</td>
<td>四半期の最初の日</td>
</tr>
<tr class="odd">
<td>“2 months”</td>
<td>または3、４、５等</td>
</tr>
<tr class="even">
<td>“year”</td>
<td>カレンダー年の最初の日</td>
</tr>
</tbody>
</table></div>
<p>以下は、異なる間隔を <code>linelist</code> に適用した場合の表示例です。時間間隔の変更に伴って、X 軸上の日付ラベルのデフォルトフォーマットと頻度がどのように変化するかに注目してください。</p>
<div class="sourceCode" id="cb1527"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># incidence オブジェクトの作成 (異なる時間間隔)</span></span>
<span><span class="co">##############################</span></span>
<span><span class="co"># 週 (月曜から始まるのがデフォルト)</span></span>
<span><span class="va">epi_wk</span>      <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">linelist</span>, <span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"Monday week"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 日曜から始まる週</span></span>
<span><span class="va">epi_Sun_wk</span>  <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">linelist</span>, <span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"Sunday week"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3週 (月曜から始まるのがデフォルト)</span></span>
<span><span class="va">epi_2wk</span>     <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">linelist</span>, <span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"2 weeks"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 月</span></span>
<span><span class="va">epi_month</span>   <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">linelist</span>, <span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"month"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 四半期</span></span>
<span><span class="va">epi_quarter</span>   <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">linelist</span>, <span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"quarter"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 年</span></span>
<span><span class="va">epi_year</span>   <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">linelist</span>, <span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># incidence オブジェクトの可視化 (わかりやすいようにタイトルを変更)</span></span>
<span><span class="co">############################</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">epi_wk</span><span class="op">)</span><span class="op">+</span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Monday weeks"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">epi_Sun_wk</span><span class="op">)</span><span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Sunday weeks"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">epi_2wk</span><span class="op">)</span><span class="op">+</span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"2 (Monday) weeks"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">epi_month</span><span class="op">)</span><span class="op">+</span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Months"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">epi_quarter</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Quarters"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">epi_year</span><span class="op">)</span><span class="op">+</span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Years"</span><span class="op">)</span></span></code></pre></div>
<p><img src="_main_files/figure-html/incidence-1.png" width="50%"><img src="_main_files/figure-html/incidence-2.png" width="50%"><img src="_main_files/figure-html/incidence-3.png" width="50%"><img src="_main_files/figure-html/incidence-4.png" width="50%"><img src="_main_files/figure-html/incidence-5.png" width="50%"><img src="_main_files/figure-html/incidence-6.png" width="50%"></p>
<!-- **Begin at first case**   -->
<!-- If you want the intervals to begin at the first case, you can add the argument `standard = TRUE` to the `incidence()` command. This only works if the interval is either "week", "month", "quarter" or "year".   -->
<p><strong>最初の日付</strong></p>
<p><code>incidence()</code> コマンドでは、日付型（例： <code>as.Date("2016-05-01")</code>）の値を <code>firstdate =</code> として指定することもできます。その場合、データはこの範囲で切り取られ、指定した日が集計単位の最初となります。</p>
</div>
<div id="グループ化-1" class="section level3 unnumbered">
<h3>グループ化<a class="anchor" aria-label="anchor" href="#%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E5%8C%96-1"><i class="fas fa-link"></i></a>
</h3>
<p>グループは、 <code>incidence()</code> コマンドで指定され、棒グラフの色付けやデータのファセット（複数の小さなグラフの集合）に使用できます。データにグループを指定するには、 <code>incidence()</code> コマンドの <code>groups =</code> 引数に列名を指定します（列名は引用符で囲みません）。複数の列を指定する場合は、全ての列名を <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> 内で指定します。</p>
<p><code>na_as_group = TRUE</code> を設定すると、グループ化された列で値が欠損している症例を、個別の <code>NA</code> グループとして集計するように指定できます。<code>FALSE</code> と設定した場合は、欠損値のある行は図から除外されます。</p>
<ul>
<li><p>グループ化された列で棒グラフを色分けするためには、 <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> コマンドの <code>fill =</code> に列名を指定します。</p></li>
<li><p>グループ化された列でファセットを行うためには、後述の「<strong>incidence2</strong> によるファセット」のセクションを参照してください。</p></li>
</ul>
<p>以下の例では、ラインリストの症例が年齢群によってグループ化されています。欠損値はグループとして含まれています。流行曲線の時間単位は週です。</p>
<div class="sourceCode" id="cb1528"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># incidence オブジェクトを年齢群でグループ化して作成</span></span>
<span><span class="va">age_outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span></span>
<span>  <span class="va">linelist</span>,                <span class="co"># データセットの指定</span></span>
<span>  date_index <span class="op">=</span> <span class="va">date_onset</span>, <span class="co"># 日付列の指定</span></span>
<span>  interval <span class="op">=</span> <span class="st">"week"</span>,       <span class="co"># 症例を月曜始まりの週単位で集計</span></span>
<span>  groups <span class="op">=</span> <span class="va">age_cat</span>,        <span class="co"># age_cat をグループとして指定</span></span>
<span>  na_as_group <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>      <span class="co"># 欠損値を1つのグループとして扱うように指定</span></span>
<span></span>
<span><span class="co"># グループ化された incidence オブジェクトの可視化</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">age_outbreak</span>,             <span class="co"># 年齢群でグループ化したincidence オブジェクト</span></span>
<span>  fill <span class="op">=</span> <span class="va">age_cat</span><span class="op">)</span><span class="op">+</span>          <span class="co"># age_cat で棒グラフの色分け (必ず上で age_cat がグループ化されている必要がある)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Age Category"</span><span class="op">)</span> <span class="co"># 凡例のタイトルをデフォルトの「age_cat」から変更する （ggplot2 の設定の変更）</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1123-1.png" width="672"></div>
<p><span style="color: darkgreen;"><u><strong>ヒント</strong></u><strong>：ggplot2</strong> のコマンドである <code>+ labs(fill = "your title")</code> で凡例のタイトルを変更できます。</span></p>
<p>また、以下のように <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> 内で <code>stack = FALSE</code> と指定することで、グループ化された棒グラフを並べて表示することができます。</p>
<div class="sourceCode" id="cb1529"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># incidence オブジェクトを月単位で作成</span></span>
<span><span class="va">monthly_gender</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span></span>
<span> <span class="va">linelist</span>,</span>
<span> date_index <span class="op">=</span> <span class="va">date_onset</span>,</span>
<span> interval <span class="op">=</span> <span class="st">"month"</span>,</span>
<span> groups <span class="op">=</span> <span class="va">gender</span>            <span class="co"># gender をグループとして指定</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">monthly_gender</span>,   <span class="co"># incidence オブジェクト</span></span>
<span>  fill <span class="op">=</span> <span class="va">gender</span>,    <span class="co"># gender で棒グラフの色分け</span></span>
<span>  stack <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>    <span class="co"># 棒グラフをグループ毎に横に並べる (積み上げではなく)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1124-1.png" width="672"></div>
<p><code>incidence()</code> コマンドの <code>na_as_group =</code> 引数を <code>FALSE</code> と指定することで、欠損値のある行を図から除外することができます。</p>
</div>
<div id="フィルタリングされたデータ" class="section level3 unnumbered">
<h3>フィルタリングされたデータ<a class="anchor" aria-label="anchor" href="#%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%95%E3%82%8C%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF"><i class="fas fa-link"></i></a>
</h3>
<p>データの一部を使って流行曲線を作成するためには、以下のステップに従ってください。</p>
<ol style="list-style-type: decimal">
<li>linelist データに対してフィルタリングを行う<br>
</li>
<li>
<code>incidence()</code> コマンドにフィルタリングされたデータを指定する<br>
</li>
<li>incidence オブジェクトを可視化する</li>
</ol>
<p>以下の例では、Central Hospital という特定の病院の症例のみを表示するようにフィルタリングされたデータを使用しています。</p>
<div class="sourceCode" id="cb1530"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># linelist をフィルタリング</span></span>
<span><span class="va">central_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="st">"Central Hospital"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># フィルタリングされたデータを使用して incidence オブジェクトの作成</span></span>
<span><span class="va">central_outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span><span class="va">central_data</span>, date_index <span class="op">=</span> <span class="va">date_onset</span>, interval <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># incidence オブジェクトの可視化</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">central_outbreak</span>, title <span class="op">=</span> <span class="st">"Weekly case incidence at Central Hospital"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1125-1.png" width="672"></div>
</div>
<div id="集計値" class="section level3 unnumbered">
<h3>集計値<a class="anchor" aria-label="anchor" href="#%E9%9B%86%E8%A8%88%E5%80%A4"><i class="fas fa-link"></i></a>
</h3>
<p>元のデータが集計（カウント）されている場合は、<code>incidence()</code> で incidence オブジェクトを作成する際に、<code>count =</code> 引数に症例カウントを含む列名を指定します。</p>
<p>例えば、 <code>count_data</code> というデータフレームでは、病院別の症例数が一日毎にカウントされています。最初の 50 行は以下のようになっています。</p>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-20788e761bc9a76598a4" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-20788e761bc9a76598a4">{"x":{"filter":"none","vertical":false,"data":[["Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital"],["2014-05-06","2014-05-10","2014-05-13","2014-05-28","2014-06-06","2014-06-09","2014-06-14","2014-06-19","2014-07-09","2014-07-10","2014-07-11","2014-07-13","2014-07-14","2014-07-15","2014-07-17","2014-07-19","2014-07-27","2014-07-30","2014-08-01","2014-08-02","2014-08-04","2014-08-05","2014-08-07","2014-08-09","2014-08-12","2014-08-14","2014-08-15","2014-08-16","2014-08-17","2014-08-18","2014-08-19","2014-08-20","2014-08-21","2014-08-22","2014-08-23","2014-08-24","2014-08-26","2014-08-28","2014-08-29","2014-08-30","2014-08-31","2014-09-01","2014-09-02","2014-09-03","2014-09-04","2014-09-05","2014-09-06","2014-09-07","2014-09-09","2014-09-10"],[1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,2,1,1,2,1,2,1,1,2,1,3,1,1,1,2,3,2,2,2,1,2,2,2,1,2,3,3,2,1,1,2,3,2,2,1]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>hospital<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>n_cases<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>上のデータセットのように日単位のカウントデータで分析を行う場合、これを病院別の週単位のエピカーブに変換する <code>incidence()</code> コマンドは次のようになります。</p>
<div class="sourceCode" id="cb1531"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">epi_counts</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span>              <span class="co"># incidence オブジェクトを週単位で作成</span></span>
<span>  <span class="va">count_data</span>,                         <span class="co"># 日単位で集計されたデータセットを指定</span></span>
<span>  date_index <span class="op">=</span> <span class="va">date_hospitalisation</span>,  <span class="co"># 日付の列を指定</span></span>
<span>  count <span class="op">=</span> <span class="va">n_cases</span>,                    <span class="co"># カウント数の列を指定</span></span>
<span>  interval <span class="op">=</span> <span class="st">"week"</span>,                  <span class="co"># 日単位のカウント数を週単位に変更するように指定</span></span>
<span>  groups <span class="op">=</span> <span class="va">hospital</span>                   <span class="co"># hospital をグループとして指定</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># 病院別でグループ化された積み上げ棒グラフの流行曲線を週単位で作成</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">epi_counts</span>,                      <span class="co"># incidence オブジェクト</span></span>
<span>     fill <span class="op">=</span> <span class="va">hospital</span><span class="op">)</span>                 <span class="co"># hospital で棒グラフの色分け</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1127-1.png" width="672"></div>
</div>
<div id="ファセット分割" class="section level3 unnumbered">
<h3>ファセット・分割<a class="anchor" aria-label="anchor" href="#%E3%83%95%E3%82%A1%E3%82%BB%E3%83%83%E3%83%88%E5%88%86%E5%89%B2"><i class="fas fa-link"></i></a>
</h3>
<p>グループ別にデータをファセットする（つまりデータを「小分割」する）には、以下のステップに従ってください。</p>
<ol style="list-style-type: decimal">
<li>incidence オブジェクトの作成時に、ファセットしたい列を <code>groups =</code> に指定する。<br>
</li>
<li>
<code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> の代わりに <code>facet_plot()</code> コマンドを使用する。<br>
</li>
<li>
<code>fill =</code> としてグループ化する列と <code>facets =</code> として使用するグループ化する列を指定する。</li>
</ol>
<p>以下では、 <code>incidence()</code> コマンドで、 <code>hospital</code> と <code>outcome</code> の両方の列をグループ化列として指定します。そして <code>facet_plot()</code> によって病院ごとに異なる流行曲線を作成し、各流行曲線の中で <code>outcome</code> 別に色分けされた棒グラフを重ねるように指定します。</p>
<div class="sourceCode" id="cb1532"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">epi_wks_hosp_out</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span></span>
<span>  <span class="va">linelist</span>,                      <span class="co"># データセットを指定</span></span>
<span>  date_index <span class="op">=</span> <span class="va">date_onset</span>,       <span class="co"># 日付列を指定</span></span>
<span>  interval <span class="op">=</span> <span class="st">"month"</span>,            <span class="co"># 月単位に指定  </span></span>
<span>  groups <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">outcome</span>, <span class="va">hospital</span><span class="op">)</span>  <span class="co"># outcome と hospital の2つをグループ化する列と指定指定</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># 可視化</span></span>
<span><span class="fu">incidence2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/incidence2/man/plot.incidence2.html">facet_plot</a></span><span class="op">(</span></span>
<span>  <span class="va">epi_wks_hosp_out</span>,      <span class="co"># incidence オブジェクト</span></span>
<span>  facets <span class="op">=</span> <span class="va">hospital</span>,     <span class="co"># ファセット化する列名</span></span>
<span>  fill <span class="op">=</span> <span class="va">outcome</span><span class="op">)</span>        <span class="co"># 色分けする列名 </span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1128-1.png" width="672"></div>
<p>系統樹の可視化に使用される <strong>ggtree</strong> パッケージにも <code>facet_plot()</code> という関数があるため注意が必要です。そのため、上のコードでは <code><a href="https://rdrr.io/pkg/incidence2/man/plot.incidence2.html">incidence2::facet_plot()</a></code> というように関数名を明示的に指定しています。</p>
</div>
<div id="plot-による調整" class="section level3 unnumbered">
<h3>
<code>plot()</code> による調整<a class="anchor" aria-label="anchor" href="#plot-%E3%81%AB%E3%82%88%E3%82%8B%E8%AA%BF%E6%95%B4"><i class="fas fa-link"></i></a>
</h3>
<p><strong>incidence2</strong> によって生成された流行曲線は、<u><code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> 内の</u>以下の引数によって変更・修正することができます。</p>
<p><strong>以下の表は、棒グラフの見た目を変更する <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> の引数一覧です。</strong></p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="9%">
<col width="58%">
<col width="31%">
</colgroup>
<thead><tr class="header">
<th>引数</th>
<th>説明</th>
<th>例</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>fill =</code></td>
<td>棒グラフの色を指定する。 <code>incidence()</code> コマンドで <code>groups =</code> に指定された色名または列名のいずれか。</td>
<td>
<code>fill = "red"</code>、または <code>fill = gender</code>
</td>
</tr>
<tr class="even">
<td><code>color =</code></td>
<td>棒グラフの枠線、または棒グラフの中の各グループの枠線に色をつける。</td>
<td><code>border = "white"</code></td>
</tr>
<tr class="odd">
<td><code>legend =</code></td>
<td>凡例の場所を指定する。</td>
<td>“bottom”、“top”、“left”, “right”、 “none”のいずれか</td>
</tr>
<tr class="even">
<td><code>alpha =</code></td>
<td>棒グラフの色の透明度を指定する</td>
<td>1が最も濃く、0が最も透明</td>
</tr>
<tr class="odd">
<td><code>width =</code></td>
<td>時間間隔に対する棒グラフの相対的な大きさを示す0～1の値</td>
<td><code>width = .7</code></td>
</tr>
<tr class="even">
<td><code>show_cases =</code></td>
<td>ロジカル値。もし TRUE の場合は各症例が枠で表示される。アウトブレイクが小さい場合に適している。</td>
<td>|</td>
</tr>
</tbody>
</table></div>
<p><strong>次は、時間軸を変更する <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> の引数一覧です。</strong></p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="15%">
<col width="84%">
</colgroup>
<thead><tr class="header">
<th>引数</th>
<th>説明</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>centre_dates =</code></td>
<td>日付表示を棒グラフの中央に表示するか、先頭に表示するかについての TRUE/FALSE</td>
</tr>
<tr class="even">
<td><code>date_format =</code></td>
<td>strptime (“%”) 構文を使用して日付表示形式を調整。center_dates = FALSEの場合のみ動作（詳細は後述）</td>
</tr>
<tr class="odd">
<td><code>n.breaks =</code></td>
<td>X軸の日付ラベルの分割数の目安</td>
</tr>
<tr class="even">
<td><code>angle =</code></td>
<td>X軸の日付ラベルの角度</td>
</tr>
<tr class="odd">
<td><code>size =</code></td>
<td>文字サイズ</td>
</tr>
</tbody>
</table></div>
<p><code>date_breaks =</code> 引数は、 <code>centre_dates = FALSE</code> の場合にのみ機能することに注意してください。<a href="dates.html#dates">日付型データ</a> の章で説明されているように、以下の strptime 構文を使用して、引数に引用符で囲まれた文字値を指定します。「改行」には <code>\n</code> を使うことができます。</p>
<p>%d = 日付 (5, 17, 28, etc.)<br>
%j = 年における日付 (ユリウス通日 001-366)<br>
%a = 省略された曜日名 (Mon, Tue, Wed など)<br>
%A = 省略されたいない曜日名 (Monday, Tuesday など)<br>
%w = 曜日番号 (0-6, 日曜日が0)<br>
%u = 曜日番号 (1-7, 月曜日が1)<br>
%W = 週番号 (00-53, 月曜日が週の始め)<br>
%U = 週番号(01-53, 日曜日が週の始め)<br>
%m = 月 (01, 02, 03, 04 など)<br>
%b = 省略された月名 (Jan, Feb など)<br>
%B = 省略されていない月名 (January, February など)<br>
%y = 2桁年 (例：89)<br>
%Y = 4桁年 (例：1989)<br>
%h = 時間 (24時間単位)<br>
%m = 分<br>
%s = 秒<br>
%z = グリニッジ標準時間からの時間差<br>
%Z = タイムゾーン （文字列型）</p>
<!-- <span style="color: darkgreen;">**_TIP:_** For breaks every "nth" interval (e.g. every 4th), use `n.breaks = nrow(i)/n` (where “i” is your incidence object name and “n” is a number). If your data are grouped, you will need to multiply "n" by the number of unique groups.</span>   -->
<p><strong>以下は、ラベルを変更する <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> の引数一覧です。</strong></p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="11%">
<col width="88%">
</colgroup>
<thead><tr class="header">
<th>引数</th>
<th>説明</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>title =</code></td>
<td>グラフのタイトル</td>
</tr>
<tr class="even">
<td><code>xlab =</code></td>
<td>x軸のタイトル</td>
</tr>
<tr class="odd">
<td><code>ylab =</code></td>
<td>y軸のタイトル</td>
</tr>
<tr class="even">
<td><code>size =</code></td>
<td>x軸の文字のサイズ（単位：pt）（他のサイズを調整するには ggplot の theme() を使用してください。</td>
</tr>
</tbody>
</table></div>
<p>上の引数を複数使用した例を以下に紹介します。</p>
<div class="sourceCode" id="cb1533"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># linelistのフィルタリング</span></span>
<span><span class="va">central_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="st">"Central Hospital"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># フィルタリングデータを使った incidence オブジェクトの作成 </span></span>
<span><span class="va">central_outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span></span>
<span>  <span class="va">central_data</span>,</span>
<span>  date_index <span class="op">=</span> <span class="va">date_onset</span>,</span>
<span>  interval <span class="op">=</span> <span class="st">"week"</span>,</span>
<span>  groups <span class="op">=</span> <span class="va">outcome</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># incidence オブジェクトの可視化</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">central_outbreak</span>,</span>
<span>  fill <span class="op">=</span> <span class="va">outcome</span>,                       <span class="co"># グラフの色分け</span></span>
<span>  legend <span class="op">=</span> <span class="st">"top"</span>,                       <span class="co"># 凡例を一番上に置く</span></span>
<span>  title <span class="op">=</span> <span class="st">"Cases at Central Hospital"</span>,  <span class="co"># タイトル</span></span>
<span>  xlab <span class="op">=</span> <span class="st">"Week of onset"</span>,               <span class="co"># x軸のタイトル</span></span>
<span>  ylab <span class="op">=</span> <span class="st">"Week of onset"</span>,               <span class="co"># y軸のタイトル</span></span>
<span>  show_cases <span class="op">=</span> <span class="cn">TRUE</span>,                    <span class="co"># それぞれの症例を枠線で示す</span></span>
<span>  alpha <span class="op">=</span> <span class="fl">0.7</span>,                          <span class="co"># 透明度 </span></span>
<span>  border <span class="op">=</span> <span class="st">"grey"</span>,                      <span class="co"># 症例ごとの枠線</span></span>
<span>  angle <span class="op">=</span> <span class="fl">30</span>,                           <span class="co"># 日付ラベルの角度</span></span>
<span>  centre_dates <span class="op">=</span> <span class="cn">FALSE</span>,                 <span class="co"># 日付ラベルを各グラフの先頭に配置</span></span>
<span>  date_format <span class="op">=</span> <span class="st">"%a %d %b %Y\n(Week %W)"</span> <span class="co"># 日付の記載方法の変更</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1129-1.png" width="672"></div>
<p>さらにグラフの見た目を調整したい場合は、次の「 <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> による調整」のセクションを参照してください。</p>
</div>
<div id="ggplot2-による調整" class="section level3 unnumbered">
<h3>ggplot2 による調整<a class="anchor" aria-label="anchor" href="#ggplot2-%E3%81%AB%E3%82%88%E3%82%8B%E8%AA%BF%E6%95%B4"><i class="fas fa-link"></i></a>
</h3>
<p>以下に示すように、 <strong>incidence2</strong> の <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> の後に <code>+</code> で <strong>ggplot2</strong> による調整を加えることができます。</p>
<p>下の例では、<strong>incidence2</strong> のプロットを作成するコードの後、<strong>ggplot2</strong> コマンドを使って、軸の修正、脚注の追加、太字フォントと文字サイズの調整を行っています。</p>
<p><code><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date()</a></code> を追加すると、<code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> の日付フォーマットのほとんどが上書きされてしまうことに注意してください。さらに詳しく知りたい方は、<code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> の流行曲線のセクションと、このハンドブックの <a href="ggplot-tips.html#ggplot-tips">ggplot のヒント</a> の章を参照してください。</p>
<div class="sourceCode" id="cb1534"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># linelist のフィルタリング</span></span>
<span><span class="va">central_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="st">"Central Hospital"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># フィルタリングデータを使った incidence オブジェクトの作成</span></span>
<span><span class="va">central_outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span></span>
<span>  <span class="va">central_data</span>,</span>
<span>  date_index <span class="op">=</span> <span class="va">date_onset</span>,</span>
<span>  interval <span class="op">=</span> <span class="st">"week"</span>,</span>
<span>  groups <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># incidence オブジェクトの可視化</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">central_outbreak</span>,</span>
<span>  fill <span class="op">=</span> <span class="va">outcome</span>,                       <span class="co"># グラフの色分け</span></span>
<span>  legend <span class="op">=</span> <span class="st">"top"</span>,                       <span class="co"># 凡例を一番上に置く</span></span>
<span>  title <span class="op">=</span> <span class="st">"Cases at Central Hospital"</span>,  <span class="co"># タイトル</span></span>
<span>  xlab <span class="op">=</span> <span class="st">"Week of onset"</span>,               <span class="co"># x軸のタイトル</span></span>
<span>  ylab <span class="op">=</span> <span class="st">"Week of onset"</span>,               <span class="co"># y軸のタイトル</span></span>
<span>  show_cases <span class="op">=</span> <span class="cn">TRUE</span>,                    <span class="co"># それぞれの症例を枠線で示す</span></span>
<span>  alpha <span class="op">=</span> <span class="fl">0.7</span>,                          <span class="co"># 透明度 </span></span>
<span>  border <span class="op">=</span> <span class="st">"grey"</span>,                      <span class="co"># 症例ごとの枠線</span></span>
<span>  centre_dates <span class="op">=</span> <span class="cn">FALSE</span>,                   </span>
<span>  date_format <span class="op">=</span> <span class="st">"%a %d %b\n%Y (Week %W)"</span>, </span>
<span>  angle <span class="op">=</span> <span class="fl">30</span>                           <span class="co"># 日付ラベルの角度</span></span>
<span>  <span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="fl">30</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,  <span class="co"># y軸を5ずつで区分</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                         <span class="co"># y軸の0以下の余分なスペースを削除</span></span>
<span>  </span>
<span>  <span class="co"># 脚注の追加</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    fill <span class="op">=</span> <span class="st">"Patient outcome"</span>,                               <span class="co"># 凡例タイトル</span></span>
<span>    caption <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span>                            <span class="co"># 脚注（詳細は文字型・文字列型データの章を参照）</span></span>
<span>      <span class="st">"n = {central_cases} from Central Hospital</span></span>
<span><span class="st">      Case onsets range from {earliest_date} to {latest_date}. {missing_onset} cases are missing date of onset and not shown"</span>,</span>
<span>      central_cases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">)</span>,</span>
<span>      earliest_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, format <span class="op">=</span> <span class="st">'%a %d %b %Y'</span><span class="op">)</span>,</span>
<span>      latest_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, format <span class="op">=</span> <span class="st">'%a %d %b %Y'</span><span class="op">)</span>,      </span>
<span>      missing_onset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">central_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># 太字フォントの追加と脚注の位置の指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,    <span class="co"># 軸タイトルを大きく、太字にする</span></span>
<span>    axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,     <span class="co"># 軸の文字を大きく、太字にする</span></span>
<span>    plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0</span>, face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span> <span class="co"># 脚注を左に寄せる</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1130-1.png" width="672"></div>
</div>
<div id="色の変更" class="section level3 unnumbered">
<h3>色の変更<a class="anchor" aria-label="anchor" href="#%E8%89%B2%E3%81%AE%E5%A4%89%E6%9B%B4"><i class="fas fa-link"></i></a>
</h3>
<div id="色パレットの指定" class="section level4 unnumbered">
<h4>色パレットの指定<a class="anchor" aria-label="anchor" href="#%E8%89%B2%E3%83%91%E3%83%AC%E3%83%83%E3%83%88%E3%81%AE%E6%8C%87%E5%AE%9A"><i class="fas fa-link"></i></a>
</h4>
<p><code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> の <code>col_pal =</code> 引数に、すでに定義されている色パレットの名前を指定します。<strong>incidence2</strong> パッケージには、「vibrant 」と 「muted 」という2つの色パレットが付属しています。「vibrant 」では最初の6色が、「muted 」では最初の9色がそれぞれ異なる色となっています。それ以降の色は、他の色の補間となります。このような定義されたパレットは、<a href="https://personal.sron.nl/~pault/#sec:qualitative">こちらのウェブサイト</a> で確認することができます。灰色は欠損値があった場合に用いられるため、パレットには含まれていません（<code>na_color =</code> を指定することでこのデフォルトを変更できます）。</p>
<div class="sourceCode" id="cb1535"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># age でグループ化された incidence オブジェクトの作成</span></span>
<span><span class="va">age_outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span></span>
<span>  <span class="va">linelist</span>,</span>
<span>  date_index <span class="op">=</span> <span class="va">date_onset</span>,   <span class="co"># x軸を発症日に指定</span></span>
<span>  interval <span class="op">=</span> <span class="st">"week"</span>,         <span class="co"># 症例を週単位で集計</span></span>
<span>  groups <span class="op">=</span> <span class="va">age_cat</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># デフォルトの色パレットを用いて流行曲線を作成</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">age_outbreak</span>, fill <span class="op">=</span> <span class="va">age_cat</span>, title <span class="op">=</span> <span class="st">"'vibrant' default incidence2 palette"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 異なる色パレットを用いる場合は以下</span></span>
<span><span class="co">#plot(age_outbreak, fill = age_cat, col_pal = muted, title = "'muted' incidence2 palette")</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1131-1.png" width="50%"></div>
<p>また、R の <strong>base</strong> パッケージに含まれている色パレットを使用することもできます（パレットの名前を<u>引用符なしで</u>指定してください）。</p>
<div class="sourceCode" id="cb1536"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Rのベースの色パレットを使用して可視化</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">age_outbreak</span>, fill <span class="op">=</span> <span class="va">age_cat</span>, col_pal <span class="op">=</span> <span class="va">heat.colors</span>, title <span class="op">=</span> <span class="st">"base R heat.colors palette"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rのベースの色パレットを使用して可視化</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">age_outbreak</span>, fill <span class="op">=</span> <span class="va">age_cat</span>, col_pal <span class="op">=</span> <span class="va">rainbow</span>, title <span class="op">=</span> <span class="st">"base R rainbow palette"</span><span class="op">)</span></span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-1132-1.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-1132-2.png" width="50%"></p>
<p>さらに、<strong>viridis</strong> パッケージや <strong>RColorBrewer</strong> パッケージから色パレットを追加することもできます。これらのパッケージを読み込み後、それぞれのパッケージに含まれている色を調整する関数 <code>scale_fill_*()</code> を、以下のように <code>+</code> で追加する必要があります。</p>
<div class="sourceCode" id="cb1537"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">RColorBrewer</span>, <span class="va">viridis</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 色パレットを使用して可視化</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">age_outbreak</span>, fill <span class="op">=</span> <span class="va">age_cat</span>, title <span class="op">=</span> <span class="st">"Viridis palette"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_d</a></span><span class="op">(</span></span>
<span>    option <span class="op">=</span> <span class="st">"inferno"</span>,     <span class="co"># color scheme, try also "plasma" or the default</span></span>
<span>    name <span class="op">=</span> <span class="st">"Age Category"</span>,  <span class="co"># legend name</span></span>
<span>    na.value <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>      <span class="co"># for missing values</span></span>
<span></span>
<span><span class="co"># 色パレットを使用して可視化</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">age_outbreak</span>, fill <span class="op">=</span> <span class="va">age_cat</span>, title <span class="op">=</span> <span class="st">"RColorBrewer palette"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_brewer</a></span><span class="op">(</span></span>
<span>    palette <span class="op">=</span> <span class="st">"Dark2"</span>,      <span class="co"># color palette, try also Accent, Dark2, Paired, Pastel1, Pastel2, Set1, Set2, Set3</span></span>
<span>    name <span class="op">=</span> <span class="st">"Age Category"</span>,  <span class="co"># legend name</span></span>
<span>    na.value <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>      <span class="co"># for missing values</span></span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-1133-1.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-1133-2.png" width="50%"></p>
</div>
<div id="マニュアルで色を指定" class="section level4 unnumbered">
<h4>マニュアルで色を指定<a class="anchor" aria-label="anchor" href="#%E3%83%9E%E3%83%8B%E3%83%A5%E3%82%A2%E3%83%AB%E3%81%A7%E8%89%B2%E3%82%92%E6%8C%87%E5%AE%9A"><i class="fas fa-link"></i></a>
</h4>
<p>マニュアルで色を指定するには、 <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> 内に <strong>ggplot2</strong> の関数 <code><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual()</a></code> を <code>+</code> で追加し、色の名前または HEX コードのベクトルを <code>values =</code> 引数に与えます。 指定された色の数は、グループの数と等しくなければなりません。欠損値がグループであるかどうかに注意してください。欠損値は、<a href="factors.html#factors">因子（ファクタ）型データ</a> の章で説明したように、データの前処理工程内で <code><a href="https://forcats.tidyverse.org/reference/fct_explicit_na.html">fct_explicit_na()</a></code> という関数で “Missing” のような文字型に変換することができます。</p>
<div class="sourceCode" id="cb1538"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 色のマニュアル指定</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">age_outbreak</span>, fill <span class="op">=</span> <span class="va">age_cat</span>, title <span class="op">=</span> <span class="st">"Manually-specified colors"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkgreen"</span>, <span class="st">"darkblue"</span>, <span class="st">"purple"</span>, <span class="st">"grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>, <span class="st">"lightblue"</span><span class="op">)</span>,  <span class="co"># 色</span></span>
<span>    name <span class="op">=</span> <span class="st">"Age Category"</span><span class="op">)</span>      <span class="co"># 凡例のタイトル</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1134-1.png" width="50%"></div>
<p>また、<a href="ggplot-tips.html#ggplot-tips">ggplot のヒント</a> の章で説明されているように、<code><a href="https://rdrr.io/r/grDevices/colorRamp.html">colorRampPalette()</a></code> を使用し、定義した色のベクトルと使いたい色の数を指定することで、独自の色パレットを作ることができます。いくつかの色を指定するだけで、多くの色を取得できる良い方法です。</p>
<div class="sourceCode" id="cb1539"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkgreen"</span>, <span class="st">"darkblue"</span>, <span class="st">"purple"</span>, <span class="st">"grey"</span>, <span class="st">"yellow"</span>, <span class="st">"orange"</span><span class="op">)</span></span>
<span><span class="va">my_palette</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html">colorRampPalette</a></span><span class="op">(</span><span class="va">my_cols</span><span class="op">)</span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>  <span class="co"># 6つの色を12色に拡張</span></span>
<span><span class="va">my_palette</span></span></code></pre></div>
<pre><code>##  [1] "#006400" "#00363F" "#00097E" "#3A0BAF" "#821ADD" "#A84BE2" "#B592CB"
##  [8] "#C9C99B" "#E7E745" "#FFF600" "#FFCD00" "#FFA500"</code></pre>
</div>
</div>
<div id="レベル順序の調整" class="section level3 unnumbered">
<h3>レベル順序の調整<a class="anchor" aria-label="anchor" href="#%E3%83%AC%E3%83%99%E3%83%AB%E9%A0%86%E5%BA%8F%E3%81%AE%E8%AA%BF%E6%95%B4"><i class="fas fa-link"></i></a>
</h3>
<p>グラフや凡例でのグループの表示順を調整するには、グループ化した列が因子型である必要があります。詳細は、<a href="factors.html#factors">因子（ファクタ）型データ</a> の章を参照してください。</p>
<p>まず、デフォルトの順序で作成された病院別の週単位での流行曲線を見てみましょう。</p>
<div class="sourceCode" id="cb1541"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># オリジナル（hospital が因子型ではない場合）</span></span>
<span><span class="co">###################################</span></span>
<span></span>
<span><span class="co"># hospitalでグループ化された週単位の incidence オブジェクトの作成</span></span>
<span><span class="va">hospital_outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span></span>
<span>  <span class="va">linelist</span>,</span>
<span>  date_index <span class="op">=</span> <span class="va">date_onset</span>, </span>
<span>  interval <span class="op">=</span> <span class="st">"week"</span>, </span>
<span>  groups <span class="op">=</span> <span class="va">hospital</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># incidence オブジェクトの可視化</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hospital_outbreak</span>, fill <span class="op">=</span> <span class="va">hospital</span>, title <span class="op">=</span> <span class="st">"オリジナル - hospital が因子型ではない場合"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1136-1.png" width="672"></div>
<p>次に “Missing” と “Other” が流行曲線の一番上に来るように順番を調整します。調整するために、以下のことを行います。</p>
<ul>
<li><p>因子型を扱うために <strong>forcats</strong> パッケージを読み込む</p></li>
<li>
<p>データセットの調整 - ここでは、新しいデータセット（<code>plot_data</code>）を定義する</p>
<ul>
<li>
<code>hospital</code> 列を因子型として定義した後に <code><a href="https://forcats.tidyverse.org/reference/fct_relevel.html">fct_relevel()</a></code> でレベルの順序を設定し、“Other”と “Missing”が最初に来るようにすることで、棒グラフの一番上に表示されるようにする</li>
</ul>
</li>
<li><p>incidence オブジェクトを作成し、可視化する</p></li>
<li>
<p><strong>ggplot2</strong> で修正を加える</p>
<ul>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual()</a></code> を使って、“Missing”が灰色、“Other”がベージュになるように、マニュアルで色を割り当てる</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb1542"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># hospital 列を因子型に変更する</span></span>
<span><span class="co">###############################</span></span>
<span></span>
<span><span class="co"># 因子型データを扱うために forcats パッケージを読み込む</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">forcats</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># hospital 列を因子型に変換しレベルを変更する</span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_relevel.html">fct_relevel</a></span><span class="op">(</span><span class="va">hospital</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Missing"</span>, <span class="st">"Other"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># "Missing" と "Other" が最初になるようにレベルを指定</span></span>
<span></span>
<span></span>
<span><span class="co"># hospital と week でグループ化された週ごとの incidence オブジェクトの作成</span></span>
<span><span class="va">hospital_outbreak_mod</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span></span>
<span>  <span class="va">plot_data</span>,</span>
<span>  date_index <span class="op">=</span> <span class="va">date_onset</span>, </span>
<span>  interval <span class="op">=</span> <span class="st">"week"</span>, </span>
<span>  groups <span class="op">=</span> <span class="va">hospital</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># incidence オブジェクトの可視化</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hospital_outbreak_mod</span>, fill <span class="op">=</span> <span class="va">hospital</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># マニュアルで色を指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey"</span>, <span class="st">"beige"</span>, <span class="st">"darkgreen"</span>, <span class="st">"green2"</span>, <span class="st">"orange"</span>, <span class="st">"red"</span>, <span class="st">"pink"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                      </span>
<span></span>
<span>  <span class="co"># ggplot でラベルを追加</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>      title <span class="op">=</span> <span class="st">"MODIFIED - hospital as factor"</span>,   <span class="co"># グラフのタイトル</span></span>
<span>      subtitle <span class="op">=</span> <span class="st">"Other &amp; Missing at top of epicurve"</span>,</span>
<span>      y <span class="op">=</span> <span class="st">"Weekly case incidence"</span>,               <span class="co"># y軸のタイトル</span></span>
<span>      x <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,               <span class="co"># x軸のタイトル</span></span>
<span>      fill <span class="op">=</span> <span class="st">"Hospital"</span><span class="op">)</span>                         <span class="co"># 凡例のタイトル</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1137-1.png" width="672"></div>
<p><span style="color: darkgreen;"><u><strong>ヒント</strong></u><strong>：</strong>凡例の順番のみを逆にしたい場合は <strong>ggplot2</strong> コマンドの</span><code>guides(fill = guide_legend(reverse = TRUE))</code><span style="color: darkgreen;">を追加する</span></p>
</div>
<div id="縦罫線" class="section level3 unnumbered">
<h3>縦罫線<a class="anchor" aria-label="anchor" href="#%E7%B8%A6%E7%BD%AB%E7%B7%9A"><i class="fas fa-link"></i></a>
</h3>
<p>デフォルトの <strong>incidence2</strong> の設定でグラフを作成した場合、縦罫線が各日付ラベルと各日付ラベルの間に 1 回ずつ表示されることに気づくかもしれません。このため、罫線が一部の棒グラフの上部と交差してしまうことがあります。</p>
<!-- [TO DO Note this paragraph is not applicable with version 1.0.0 of incidence2). You can specify the interval for the gridlines by adding **ggplot2**'s `scale_x_date()` command to your **incidence2** plot. Within it, specify the intervals for `date_breaks = ` and `date_minor_breaks = ` (e.g. "weeks" or "3 weeks" or "months"). Note that use of `scale_x_date()` will over-ride any formatting of the date labels in `plot()`, so you will need to specify any string format to `date_labels = ` as below.   -->
<p><strong>ggplot2</strong> のコマンド <code><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic()</a></code> を追加することで、すべての罫線を削除することができます。</p>
<div class="sourceCode" id="cb1543"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># incidence オブジェクトの作成</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span></span>
<span>  <span class="va">central_data</span>,</span>
<span>  date_index <span class="op">=</span> <span class="va">date_onset</span>,</span>
<span>  interval <span class="op">=</span> <span class="st">"Monday weeks"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># デフォルトの罫線</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">a</span>, title <span class="op">=</span> <span class="st">"Default lines"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 罫線幅の指定</span></span>
<span><span class="co"># INCIDENCE2 1.0.0 では動作しません</span></span>
<span><span class="co"># plot(a, title = "Weekly lines")+</span></span>
<span><span class="co">#   scale_x_date(</span></span>
<span><span class="co">#     date_breaks = "4 weeks",      # major vertical lines align on weeks</span></span>
<span><span class="co">#     date_minor_breaks = "weeks",  # minor vertical lines every week</span></span>
<span><span class="co">#     date_labels = "%a\n%d\n%b")   # format of date labels</span></span>
<span></span>
<span><span class="co"># 罫線の削除</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">a</span>, title <span class="op">=</span> <span class="st">"No lines"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span>                 <span class="co"># 罫線の削除</span></span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-1138-1.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-1138-2.png" width="50%"></p>
<p>ただし、週ごとに集計する場合、<code>date_breaks</code> と <code>date_minor_breaks</code> 引数は月曜日始まりの週にしか機能しないことに注意してください。週の始まりが他の曜日の場合は、代わりに <code>breaks =</code> と <code>minor_breaks =</code> 引数に日付を指定する必要があります。<code><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date()</a></code> を使った例は <strong>ggplot2</strong> のセクションを参照してください。</p>
</div>
<div id="累積罹患率" class="section level3 unnumbered">
<h3>累積罹患率<a class="anchor" aria-label="anchor" href="#%E7%B4%AF%E7%A9%8D%E7%BD%B9%E6%82%A3%E7%8E%87"><i class="fas fa-link"></i></a>
</h3>
<p>incidence オブジェクトを <strong>incidence2</strong> コマンドの <code>cumulate()</code> に渡し、次に <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> に渡すことで、累積罹患率のグラフを簡単に作成することができます。これは <code>facet_plot()</code> を一緒に使用した場合でも動作します。</p>
<div class="sourceCode" id="cb1544"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 週ごとの incidence オブジェクトの作成</span></span>
<span><span class="va">wkly_inci</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span></span>
<span>  <span class="va">linelist</span>,</span>
<span>  date_index <span class="op">=</span> <span class="va">date_onset</span>,</span>
<span>  interval <span class="op">=</span> <span class="st">"week"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 累積罹患率グラフの作成</span></span>
<span><span class="va">wkly_inci</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">cumulate</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1139-1.png" width="672"></div>
<p><strong>ggplot2</strong> を使って累積罹患率のグラフを作成する別の方法については、本章の後述のセクションを参照して下さい。例えば、流行曲線の上に累積罹患率の線グラフを重ねることも可能です。</p>
</div>
<div id="移動平均" class="section level3 unnumbered">
<h3>移動平均<a class="anchor" aria-label="anchor" href="#%E7%A7%BB%E5%8B%95%E5%B9%B3%E5%9D%87"><i class="fas fa-link"></i></a>
</h3>
<p><strong>i2extras</strong> パッケージの <code>add_rolling_average()</code> を使用すると、<strong>Incidence2</strong> プロットに簡単に移動平均を追加することができます。<strong>incidence2</strong> オブジェクトを <code>add_rolling_average()</code> に渡し、次に <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> に渡します。<code>add_rolling_average()</code> 内で <code>before =</code> を移動平均に含めたい過去の日数として設定します（デフォルトは 2）。データがグループ化されている場合は、グループごとに移動平均が計算されます。</p>
<div class="sourceCode" id="cb1545"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rolling_avg</span> <span class="op">&lt;-</span> <span class="fu">incidence</span><span class="op">(</span>                    <span class="co"># incidence オブジェクトの作成</span></span>
<span>  <span class="va">linelist</span>,</span>
<span>  date_index <span class="op">=</span> <span class="va">date_onset</span>,</span>
<span>  interval <span class="op">=</span> <span class="st">"week"</span>,</span>
<span>  groups <span class="op">=</span> <span class="va">gender</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>  <span class="fu">i2extras</span><span class="fu">::</span><span class="fu"><a href="https://www.reconverse.org/i2extras/reference/add_rolling_average.html">add_rolling_average</a></span><span class="op">(</span>before <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>  <span class="co"># 移動平均を追加 (ここではgenderごと)</span></span>
<span></span>
<span><span class="co"># plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">rolling_avg</span><span class="op">)</span> <span class="co"># グループごとに移動平均が作成されているので自動でファセット化される</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1140-1.png" width="672"></div>
<p>より一般的なデータに対して移動平均を算出する場合は本章後述の <a href="epicurves.html#%E7%A7%BB%E5%8B%95%E5%B9%B3%E5%9D%87-1">移動平均</a> のセクションを参照して下さい。</p>
<!-- ======================================================= -->
</div>
</div>
<div id="ggplot2-を用いた流行曲線" class="section level2" number="32.3">
<h2>
<span class="header-section-number">32.3</span> ggplot2 を用いた流行曲線<a class="anchor" aria-label="anchor" href="#ggplot2-%E3%82%92%E7%94%A8%E3%81%84%E3%81%9F%E6%B5%81%E8%A1%8C%E6%9B%B2%E7%B7%9A"><i class="fas fa-link"></i></a>
</h2>
<p><code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> を使用して流行曲線を作成すると、より柔軟にカスタマイズできますが、より多くの手順と <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> の動作の理解が必要です。</p>
<p><strong>incidence2</strong> パッケージを使用する場合とは異なり、症例の集計単位（週、月など）や、日付軸のラベルの間隔をマニュアルで、注意して制御する必要があります。</p>
<p>以下の例では、<code>linelist</code> データセットの一部（Central Hospital の症例のみ）を使用しています。</p>
<div class="sourceCode" id="cb1546"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">central_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="st">"Central Hospital"</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> を使用した流行曲線の作成は、以下の 3 つの要素に分かれます。</p>
<ul>
<li>ラインリストの症例を、特定の「分割」ポイントで区別される「ビン」に集約したヒストグラム<br>
</li>
<li>軸のスケールとそのラベル<br>
</li>
<li>タイトル、ラベル、キャプションなど、グラフの見た目に関するテーマ</li>
</ul>
<div id="症例のビンの指定" class="section level3 unnumbered">
<h3>症例のビンの指定<a class="anchor" aria-label="anchor" href="#%E7%97%87%E4%BE%8B%E3%81%AE%E3%83%93%E3%83%B3%E3%81%AE%E6%8C%87%E5%AE%9A"><i class="fas fa-link"></i></a>
</h3>
<p>ここでは、症例をヒストグラムのビン（「バー」とも呼ばれる）に集約する方法を説明します。ここで重要なのは、ヒストグラムのビンへの症例の集約は、必ずしも x 軸に表示される日付と同じ間隔ではないということです。</p>
<p>以下は、日次と週次の流行曲線を作成するための最も簡単なコードです。</p>
<p><code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> コマンドでは、データセットを <code>data =</code> で指定します。 この土台の上に、ヒストグラムの形状を <code>+</code> で追加します。<code><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram()</a></code> では、<code>date_onset</code> 列が x 軸にマッピングされるように指定します。また、<code><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram()</a></code> 内では、<code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code> 内ではなく、ヒストグラムの <code>binwidth =</code> を日単位で設定します。この <strong>ggplot2</strong> の構文が分かりにくい場合は、<a href="ggplot-basics.html#ggplot-basics">ggplot の基礎</a> の章を参照して下さい。</p>
<p><span style="color: orange;"><u><strong>注意</strong></u><strong>：</strong><code>binwidth = 7</code> <strong>を使って週別の症例数をプロットすると、7日間の最初のビンは、最初の症例で開始されます。特定の週を作成するには、以下のセクションを参照してください。</strong></span></p>
<div class="sourceCode" id="cb1547"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># daily </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">central_data</span><span class="op">)</span> <span class="op">+</span>          <span class="co"># データセットの指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>                      <span class="co"># ヒストグラムの追加</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span>,     <span class="co"># 日付列をx軸に指定</span></span>
<span>    binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">+</span>                     <span class="co"># 1日ごとのビンを指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Central Hospital - Daily"</span><span class="op">)</span>                <span class="co"># タイトル</span></span>
<span></span>
<span><span class="co"># weekly</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">central_data</span><span class="op">)</span> <span class="op">+</span>          <span class="co"># データセットの指定 </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>                      <span class="co"># ヒストグラムの追加</span></span>
<span>      mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span>,   <span class="co"># 日付列をx軸に指定</span></span>
<span>      binwidth <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">+</span>                   <span class="co"># 7日ごとのビンを指定、最初の症例から始まる（！）</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Central Hospital - 7-day bins, starting at first case"</span><span class="op">)</span> <span class="co"># タイトル</span></span></code></pre></div>
<p><img src="_main_files/figure-html/ggplot_simple-1.png" width="50%"><img src="_main_files/figure-html/ggplot_simple-2.png" width="50%"></p>
<p>この Central Hospital のデータセットの最初の症例は、症状が出たのが 1 日目だったことに注目しましょう。</p>
<div class="sourceCode" id="cb1548"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"%A %d %b, %Y"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "Thursday 01 May, 2014"</code></pre>
<p><strong>ヒストグラムのビンの区切りをマニュアルで指定するには、<code>binwidth =</code> を使用せず、代わりに <code>breaks =</code> に日付のベクトルを指定します。</strong></p>
<p>日付のベクトルは、R <strong>base</strong> の <code><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date()</a></code> で作成します。この関数は、開始日 <code>from =</code> 、終了日 <code>to =</code> と日単位 <code>by =</code> を引数に取ります。例えば、以下のコマンドは、1 月 15 日から 6 月 28 日までの月ごとの日付を返します。</p>
<div class="sourceCode" id="cb1550"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">monthly_breaks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2014-02-01"</span><span class="op">)</span>,</span>
<span>                           to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2015-07-15"</span><span class="op">)</span>,</span>
<span>                           by <span class="op">=</span> <span class="st">"months"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">monthly_breaks</span>   <span class="co"># 表示</span></span></code></pre></div>
<pre><code>##  [1] "2014-02-01" "2014-03-01" "2014-04-01" "2014-05-01" "2014-06-01"
##  [6] "2014-07-01" "2014-08-01" "2014-09-01" "2014-10-01" "2014-11-01"
## [11] "2014-12-01" "2015-01-01" "2015-02-01" "2015-03-01" "2015-04-01"
## [16] "2015-05-01" "2015-06-01" "2015-07-01"</code></pre>
<p>このベクトルは、<code><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram()</a></code> に <code>breaks =</code> として与えることができます。</p>
<div class="sourceCode" id="cb1552"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 月ごと </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">central_data</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span>,</span>
<span>    breaks <span class="op">=</span> <span class="va">monthly_breaks</span><span class="op">)</span><span class="op">+</span>         <span class="co"># 上で定義した日付ベクトルを指定 vector of breaks                    </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Monthly case bins"</span><span class="op">)</span>   <span class="co"># タイトル</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1146-1.png" width="672"></div>
<p><code>by = "week"</code> を設定すると、単純な週単位の日付列を返すことができます。以下はその一例です。</p>
<div class="sourceCode" id="cb1553"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weekly_breaks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2014-02-01"</span><span class="op">)</span>,</span>
<span>                          to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2015-07-15"</span><span class="op">)</span>,</span>
<span>                          by <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span></span></code></pre></div>
<p>また、開始日と終了日を指定する代わりに、週単位のビンが最初の症例の前の月曜日から始まるようにコードを書くこともできます。<strong>以下の例では、これらの日付ベクトルを使用します。</strong></p>
<div class="sourceCode" id="cb1554"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CENTRAL HOSPITAL データにおける月曜日だけを含んだ日付ベクトル</span></span>
<span><span class="va">weekly_breaks_central</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span></span>
<span>  from <span class="op">=</span> <span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="co"># 最初の症例以前の月曜日の日付</span></span>
<span>  to   <span class="op">=</span> <span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="co"># 最後の症例以後の月曜日の日付</span></span>
<span>  by   <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span></span></code></pre></div>
<p>上に書かれている少し複雑なコードを紐解いてみましょう。</p>
<ul>
<li>
<p>「from」の数値（日付ベクトルの最初の日付）は以下のようにして設定されます。</p>
<ul>
<li>
<strong>lubridate</strong> パッケージの <code>floor_date()</code> に <code>date_onset</code> 列の最少の値（<code>na.rm=TRUE</code> で欠損値を除外した <code><a href="https://rdrr.io/r/base/Extremes.html">min()</a></code> で得られる値）を渡します。この時に <code>floor_date()</code> に「week」を指定すると、各週の開始日が月曜日 (<code>week_start = 1</code>) であるとした場合に、その症例の 「week」 の開始日が返されます。</li>
</ul>
</li>
<li><p>同様に、「to 」の数値（日付ベクトルの最後の日付）は、逆の関数である <code>ceiling_date()</code> を用いて、最後の症例の翌月曜日を返すように作成されます。<br></p></li>
<li><p><code><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date()</a></code> の引数 by には、日、週、月の任意の数を指定することができます。<br></p></li>
<li><p><code>week_start = 7</code> を使用することで日曜から開始される週にすることができます。</p></li>
</ul>
<p>これらの日付ベクトルは本章全体で使用するため、全体のデータに対するものも以下で定義しておきます（上記は Central Hospital のみ）。</p>
<div class="sourceCode" id="cb1555"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#  全体のデータにおける日付ベクトルの作成</span></span>
<span><span class="va">weekly_breaks_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span></span>
<span>  from <span class="op">=</span> <span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="co"># 最初の症例以前の月曜日の日付</span></span>
<span>  to   <span class="op">=</span> <span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="co"># 最後の症例以後の月曜日の日付</span></span>
<span>  by   <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span></span></code></pre></div>
<p>これらの <code><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date()</a></code> の出力は、ヒストグラムのビンの区切りだけでなく、ビンから独立した日付ラベルの区切りを作成するためにも使用できます。日付ラベルについては、後のセクションで詳しく説明します。</p>
<p><span style="color: darkgreen;"><u><strong>ヒント</strong></u><strong>：</strong>bin breaks と date label breaks をあらかじめ名前付きのベクトルとして保存しておき、<code>breaks =</code> にそのベクトルを指定することで、よりシンプルな <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> コマンドにすることができます。</span></p>
</div>
<div id="週別流行曲線の例" class="section level3 unnumbered">
<h3>週別流行曲線の例<a class="anchor" aria-label="anchor" href="#%E9%80%B1%E5%88%A5%E6%B5%81%E8%A1%8C%E6%9B%B2%E7%B7%9A%E3%81%AE%E4%BE%8B"><i class="fas fa-link"></i></a>
</h3>
<p><strong>以下は日付ラベル、縦罫線を含んだ、月曜始まりの週別流行曲線を作成するための詳細なサンプルコードです。</strong>このセクションは、すぐにコードを必要とするユーザーのためのものです。それぞれの側面（テーマ、日付ラベルなど）を深く理解するためには、以降のセクションを参照して下さい。注目すべき点として以下があります。</p>
<ul>
<li>ヒストグラムのビンの区切りは、上で説明したように <code><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date()</a></code> で定義され、最も早い症例の前の月曜日から始まり、最後の症例の後の月曜日で終わります。<br>
</li>
<li>日付ラベルの間隔は <code><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date()</a></code> の中の <code>date_breaks =</code> で指定します。<br>
</li>
<li>日付ラベルの間の縦罫線の間隔は <code>date_minor_breaks =</code> で指定します。<br>
</li>
<li>日付ラベルが正しいビンにカウントされているか確認するため <code><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram()</a></code> の <code>closed = "left"</code> オプションを指定します。</li>
<li>x軸とy軸のスケールで <code>expand = c(0,0)</code> を使用すると、軸の両側の余分なスペースがなくなり、日付ラベルが最初のバーから始まるようにできます。</li>
</ul>
<div class="sourceCode" id="cb1556"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 月曜日ごとの集計</span></span>
<span><span class="co">#############################</span></span>
<span><span class="co"># 週ごとの日付ベクトルの作成</span></span>
<span><span class="va">weekly_breaks_central</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span></span>
<span>      from <span class="op">=</span> <span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="co"># 最初の症例以前の月曜日の日付</span></span>
<span>      to   <span class="op">=</span> <span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="co"># 最後の症例以後の月曜日の日付</span></span>
<span>      by   <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span>    <span class="co"># 7日間隔に指定</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">central_data</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  </span>
<span>  <span class="co"># ヒストグラムの作成：ビンの分割数の指定：最初の症例の前の月曜日から始まり、最後の症例の後の月曜日を終了する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    </span>
<span>    <span class="co"># マッピング</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span>,  <span class="co"># 日付列をx軸にマッピング</span></span>
<span>    </span>
<span>    <span class="co"># ビンの分割指定</span></span>
<span>    breaks <span class="op">=</span> <span class="va">weekly_breaks_central</span>, <span class="co"># 上で定義したビンの分割</span></span>
<span>      </span>
<span>    closed <span class="op">=</span> <span class="st">"left"</span>,  <span class="co"># 分割の開始から症例数をカウントする</span></span>
<span>    </span>
<span>    <span class="co"># bars</span></span>
<span>    color <span class="op">=</span> <span class="st">"darkblue"</span>,     <span class="co"># 枠線の色指定</span></span>
<span>    fill <span class="op">=</span> <span class="st">"lightblue"</span>      <span class="co"># 棒グラフの色の指定</span></span>
<span>  <span class="op">)</span><span class="op">+</span> </span>
<span>    </span>
<span>  <span class="co"># x軸ラベル</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    expand            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,           <span class="co"># X軸の前後の余分なスペースを削除</span></span>
<span>    date_breaks       <span class="op">=</span> <span class="st">"4 weeks"</span>,        <span class="co"># 日付ラベルと主要な縦罫線を4週ごとに表示。</span></span>
<span>    date_minor_breaks <span class="op">=</span> <span class="st">"week"</span>,           <span class="co"># 小縦罫線を1週ごとに表示</span></span>
<span>    date_labels       <span class="op">=</span> <span class="st">"%a\n%d %b\n%Y"</span><span class="op">)</span><span class="op">+</span> <span class="co"># 日付ラベルのフォーマット</span></span>
<span>  </span>
<span>  <span class="co"># y-axis</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>             <span class="co"># y軸の前後の余分なスペースを削除</span></span>
<span>  </span>
<span>  <span class="co"># テーマの指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                <span class="co"># 背景を簡潔なものに指定</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0</span>,        <span class="co"># 脚注を左寄せに配置</span></span>
<span>                                face <span class="op">=</span> <span class="st">"italic"</span><span class="op">)</span>, <span class="co"># キャプションをイタリック体に指定</span></span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>    <span class="co"># 軸タイトルを太字に指定</span></span>
<span>  </span>
<span>  <span class="co"># 脚注を含んだラベル</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title    <span class="op">=</span> <span class="st">"Weekly incidence of cases (Monday weeks)"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Note alignment of bars, vertical gridlines, and axis labels on Monday weeks"</span>,</span>
<span>    x        <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,</span>
<span>    y        <span class="op">=</span> <span class="st">"Weekly incident cases reported"</span>,</span>
<span>    caption  <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"n = {nrow(central_data)} from Central Hospital; Case onsets range from {format(min(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')} to {format(max(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')}\n{nrow(central_data %&gt;% filter(is.na(date_onset)))} cases missing date of onset and not shown"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1150-1.png" width="672"></div>
<div id="日曜始まりの週" class="section level4 unnumbered">
<h4>日曜始まりの週<a class="anchor" aria-label="anchor" href="#%E6%97%A5%E6%9B%9C%E5%A7%8B%E3%81%BE%E3%82%8A%E3%81%AE%E9%80%B1"><i class="fas fa-link"></i></a>
</h4>
<p><code>date_breaks = "weeks"</code> は月曜始まりの週に対してのみ機能するため、日曜始まりの週に対して上記の可視化を行うには、いくつかの修正が必要です。</p>
<ul>
<li>ヒストグラムビンの分割点を日曜日に設定する必要があります （<code>week_start = 7</code>）。<br>
</li>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date()</a></code> 内で、日付ラベルと縦罫線が日曜日に揃うように、<code>breaks =</code> と <code>minor_breaks =</code> に同様の日付の分割点を設定する必要があります。</li>
</ul>
<p>例えば、日曜始まりの週に対する <code><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date()</a></code> コマンドは、以下のようになります。</p>
<div class="sourceCode" id="cb1557"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1557-1"><a href="epicurves.html#cb1557-1" aria-hidden="true" tabindex="-1"></a><span class="fu">scale_x_date</span>(</span>
<span id="cb1557-2"><a href="epicurves.html#cb1557-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),</span>
<span id="cb1557-3"><a href="epicurves.html#cb1557-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1557-4"><a href="epicurves.html#cb1557-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 日付ラベルと縦罫線の間隔を指定</span></span>
<span id="cb1557-5"><a href="epicurves.html#cb1557-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq.Date</span>(</span>
<span id="cb1557-6"><a href="epicurves.html#cb1557-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">from =</span> <span class="fu">floor_date</span>(<span class="fu">min</span>(central_data<span class="sc">$</span>date_onset, <span class="at">na.rm=</span>T),   <span class="st">"week"</span>, <span class="at">week_start =</span> <span class="dv">7</span>), <span class="co"># 最初の症例以前の月曜日の日付</span></span>
<span id="cb1557-7"><a href="epicurves.html#cb1557-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">to   =</span> <span class="fu">ceiling_date</span>(<span class="fu">max</span>(central_data<span class="sc">$</span>date_onset, <span class="at">na.rm=</span>T), <span class="st">"week"</span>, <span class="at">week_start =</span> <span class="dv">7</span>), <span class="co"># 最後の症例以後の月曜日の日付</span></span>
<span id="cb1557-8"><a href="epicurves.html#cb1557-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">by   =</span> <span class="st">"4 weeks"</span>),</span>
<span id="cb1557-9"><a href="epicurves.html#cb1557-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1557-10"><a href="epicurves.html#cb1557-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 小縦罫線の間隔を指定 </span></span>
<span id="cb1557-11"><a href="epicurves.html#cb1557-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">minor_breaks =</span> <span class="fu">seq.Date</span>(</span>
<span id="cb1557-12"><a href="epicurves.html#cb1557-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">from =</span> <span class="fu">floor_date</span>(<span class="fu">min</span>(central_data<span class="sc">$</span>date_onset, <span class="at">na.rm=</span>T),   <span class="st">"week"</span>, <span class="at">week_start =</span> <span class="dv">7</span>), <span class="co"># 最初の症例以前の月曜日の日付</span></span>
<span id="cb1557-13"><a href="epicurves.html#cb1557-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">to   =</span> <span class="fu">ceiling_date</span>(<span class="fu">max</span>(central_data<span class="sc">$</span>date_onset, <span class="at">na.rm=</span>T), <span class="st">"week"</span>, <span class="at">week_start =</span> <span class="dv">7</span>), <span class="co"># 最後の症例以後の月曜日の日付</span></span>
<span id="cb1557-14"><a href="epicurves.html#cb1557-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">by   =</span> <span class="st">"week"</span>),</span>
<span id="cb1557-15"><a href="epicurves.html#cb1557-15" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb1557-16"><a href="epicurves.html#cb1557-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 日付ラベルのフォーマット</span></span>
<span id="cb1557-17"><a href="epicurves.html#cb1557-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_labels =</span> <span class="st">"%a</span><span class="sc">\n</span><span class="st">%d %b</span><span class="sc">\n</span><span class="st">%Y"</span>)<span class="sc">+</span>         <span class="co"># 曜日＋日付と省略月名と年</span></span></code></pre></div>
</div>
</div>
<div id="グループ化値による色分け" class="section level3 unnumbered">
<h3>グループ化・値による色分け<a class="anchor" aria-label="anchor" href="#%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E5%8C%96%E5%80%A4%E3%81%AB%E3%82%88%E3%82%8B%E8%89%B2%E5%88%86%E3%81%91"><i class="fas fa-link"></i></a>
</h3>
<p>ヒストグラムのビンは、グループごとに色分けして積み重ねることができます。グループ化する列を指定するには、以下の変更を行います。詳しくは、<a href="ggplot-basics.html#ggplot-basics">ggplot の基礎</a> の章を参照してください。</p>
<ul>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code> 内で、列名を <code>group =</code> と <code>fill =</code> の引数に指定します。<br>
</li>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code> の外側にある <code>fill =</code> の引数は、内側の引数を上書きするので削除してください。<br>
</li>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code> の内側の引数はグループごとに適用されますが、外側の引数はすべてのビンに適用されます （例えば、外側の <code>color =</code> で色を指定して、各ビンの枠線を同じ色で表示することができます）。</li>
</ul>
<p>以下は、<code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code> コマンドでヒストグラムのビンを性別でグループ化、色分けする場合のコード例です。</p>
<div class="sourceCode" id="cb1558"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span>, group <span class="op">=</span> <span class="va">gender</span>, fill <span class="op">=</span> <span class="va">gender</span><span class="op">)</span></span></code></pre></div>
<p>以下で適用してみます。</p>
<div class="sourceCode" id="cb1559"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span><span class="op">)</span> <span class="op">+</span>     <span class="co"># データセットの指定（全病院データ）</span></span>
<span>  </span>
<span>  <span class="co"># ヒストグラムの作成: ビンの分割点の指定、 最初の症例の前の月曜日から始まり、最後の症例の次の月曜日で終わるように設定する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">date_onset</span>,</span>
<span>      group <span class="op">=</span> <span class="va">hospital</span>,       <span class="co"># hospital でグループ化する</span></span>
<span>      fill <span class="op">=</span> <span class="va">hospital</span><span class="op">)</span>,       <span class="co"># hospital 毎に棒グラフを色分けする</span></span>
<span>    </span>
<span>    <span class="co"># ビン分割を月曜始まりの週ごとにする</span></span>
<span>    breaks <span class="op">=</span> <span class="va">weekly_breaks_all</span>,   <span class="co"># 上のコードで定義済みの全症例に対する月曜始まりの週毎に分割する    </span></span>
<span>    </span>
<span>    closed <span class="op">=</span> <span class="st">"left"</span>,          <span class="co"># 分割の開始から症例数をカウントする</span></span>
<span></span>
<span>    <span class="co"># 枠線の色の指定</span></span>
<span>    color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1153-1.png" width="672"></div>
</div>
<div id="色の調整" class="section level3 unnumbered">
<h3>色の調整<a class="anchor" aria-label="anchor" href="#%E8%89%B2%E3%81%AE%E8%AA%BF%E6%95%B4"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>
<p>各グループの色分けをマニュアルで設定するには、 <code><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual()</a></code> を使用します（<code><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual()</a></code> とは別の関数であることに注意してください！）。</p>
<ul>
<li><p>色のベクトルを適用するには、<code>values =</code> 引数を使用します。<br></p></li>
<li><p>欠損値の色を指定するには、<code>na.value =</code> を使用します。<br></p></li>
<li><p><code>labels =</code> 引数を使用して、凡例の項目名を変更します。念の為に、<code>c("old" = "new", "old" = "new")</code> のような名前付きベクトルとして指定するか、データ自体の値を調節してください。</p></li>
<li><p>凡例のタイトルを指定するためには、<code>name =</code> を使用します。</p></li>
</ul>
</li>
<li><p>色やパレットに関する詳しい情報は、<a href="ggplot-basics.html#ggplot-basics">ggplot の基礎</a> の章を参照してください。</p></li>
</ul>
<div class="sourceCode" id="cb1560"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span><span class="op">)</span><span class="op">+</span>           <span class="co"># データセットの指定（全病院データ）</span></span>
<span>  </span>
<span>  <span class="co"># ヒストグラムの作成</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span>,</span>
<span>        group <span class="op">=</span> <span class="va">hospital</span>,          <span class="co"># hospital でグループ化する</span></span>
<span>        fill <span class="op">=</span> <span class="va">hospital</span><span class="op">)</span>,          <span class="co"># hospital 毎に棒グラフを色分けする</span></span>
<span>    </span>
<span>    <span class="co"># ビン分割</span></span>
<span>    breaks <span class="op">=</span> <span class="va">weekly_breaks_all</span>,    <span class="co"># 上のコードで定義済みの全症例に対する月曜始まりの週毎に分割する  </span></span>
<span>    </span>
<span>    closed <span class="op">=</span> <span class="st">"left"</span>,               <span class="co"># 分割の開始から症例数をカウントする</span></span>
<span></span>
<span>    <span class="co"># 枠線の色の指定</span></span>
<span>    color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">+</span>              <span class="co"># 枠線の色の指定</span></span>
<span>  </span>
<span>  <span class="co"># マニュアルでの色の指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"orange"</span>, <span class="st">"grey"</span>, <span class="st">"beige"</span>, <span class="st">"blue"</span>, <span class="st">"brown"</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"St. Mark's Maternity Hospital (SMMH)"</span> <span class="op">=</span> <span class="st">"St. Mark's"</span><span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Hospital"</span><span class="op">)</span> <span class="co"># 色の指定 - 順番に注意!</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1154-1.png" width="672"></div>
</div>
<div id="レベル順の調整" class="section level3 unnumbered">
<h3>レベル順の調整<a class="anchor" aria-label="anchor" href="#%E3%83%AC%E3%83%99%E3%83%AB%E9%A0%86%E3%81%AE%E8%AA%BF%E6%95%B4"><i class="fas fa-link"></i></a>
</h3>
<p>グループ化されたヒストグラムの積み重ねの順番は、グループ化された列を因子型にし、各因子のレベルの順番（とその表示ラベル）を指定することで調整します。詳しくは、<a href="factors.html#factors">因子（ファクタ）型データ</a> の章、または、<a href="ggplot-basics.html#ggplot-basics">ggplot の基礎</a> の章をご覧ください。</p>
<p><a href="factors.html#factors">因子（ファクタ）型データ</a> の章で説明されているように、グラフを作成する前に <strong>forcats</strong> パッケージの <code><a href="https://forcats.tidyverse.org/reference/fct_relevel.html">fct_relevel()</a></code> 関数を使用し、グループ化したい列を因子型に変換してレベル順をマニュアルで調整してください。</p>
<div class="sourceCode" id="cb1561"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># forcats パッケージの読み込み</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">forcats</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># hospital をfactor 型としてデータセットを定義する</span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_relevel.html">fct_relevel</a></span><span class="op">(</span><span class="va">hospital</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Missing"</span>, <span class="st">"Other"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># factor 型に変換した後に"Missing"と"Other" 列が棒グラフの上に来るようにレベル順を調整する</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">plot_data</span><span class="op">$</span><span class="va">hospital</span><span class="op">)</span> <span class="co"># レベル順を表示する</span></span></code></pre></div>
<pre><code>## [1] "Missing"                             
## [2] "Other"                               
## [3] "Central Hospital"                    
## [4] "Military Hospital"                   
## [5] "Port Hospital"                       
## [6] "St. Mark's Maternity Hospital (SMMH)"</code></pre>
<p>以下の例では、<code>hospital</code> 列を上記のように統合した上で凡例の順番を <code><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides()</a></code> 関数を用いて逆にして、“<strong>Missing</strong>” が凡例の一番下に来るように変更しています。</p>
<div class="sourceCode" id="cb1563"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">plot_data</span><span class="op">)</span> <span class="op">+</span>                     <span class="co"># レベル順を変更した新しい hospital を使用する</span></span>
<span>  </span>
<span>  <span class="co"># ヒストグラムの作成</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span>,</span>
<span>        group <span class="op">=</span> <span class="va">hospital</span>,               <span class="co"># hospital でグループ化する</span></span>
<span>        fill <span class="op">=</span> <span class="va">hospital</span><span class="op">)</span>,               <span class="co"># hospital 毎に棒グラフを色分けする</span></span>
<span>    </span>
<span>    breaks <span class="op">=</span> <span class="va">weekly_breaks_all</span>,         <span class="co"># 以前のコードで定義済みの全症例に対する月曜始まりの週毎に分割する  </span></span>
<span>    </span>
<span>    closed <span class="op">=</span> <span class="st">"left"</span>,                    <span class="co"># 分割の開始から症例数をカウントする</span></span>
<span></span>
<span>    color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">+</span>                   <span class="co"># 枠線の色の指定</span></span>
<span>    </span>
<span>  <span class="co"># x軸のラベル</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    expand            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,         <span class="co"># X軸の前後の余分なスペースを削除</span></span>
<span>    date_breaks       <span class="op">=</span> <span class="st">"3 weeks"</span>,      <span class="co"># データを3週ごとに表示</span></span>
<span>    date_minor_breaks <span class="op">=</span> <span class="st">"week"</span>,         <span class="co"># 縦縦罫線を1週ごとに表示</span></span>
<span>    date_labels       <span class="op">=</span> <span class="st">"%d\n%b\n'%y"</span><span class="op">)</span><span class="op">+</span> <span class="co"># 日付ラベルのフォーマット</span></span>
<span>  </span>
<span>  <span class="co"># y軸のラベル</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                   <span class="co"># y軸の前後の余分なスペースを削除</span></span>
<span>  </span>
<span>  <span class="co"># 手動での色の指定、順番に注意！</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"grey"</span>, <span class="st">"beige"</span>, <span class="st">"black"</span>, <span class="st">"orange"</span>, <span class="st">"blue"</span>, <span class="st">"brown"</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"St. Mark's Maternity Hospital (SMMH)"</span> <span class="op">=</span> <span class="st">"St. Mark's"</span><span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Hospital"</span><span class="op">)</span><span class="op">+</span> </span>
<span>  </span>
<span>  <span class="co"># 外観の変更</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                      <span class="co"># 背景を簡潔なものに指定</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"italic"</span>, <span class="co"># 脚注をイタリック体にして左に幅寄せ</span></span>
<span>                                hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, </span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>   <span class="co"># 軸タイトルを太字に</span></span>
<span>  </span>
<span>  <span class="co"># ラベルの指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title    <span class="op">=</span> <span class="st">"Weekly incidence of cases by hospital"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Hospital as re-ordered factor"</span>,</span>
<span>    x        <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,</span>
<span>    y        <span class="op">=</span> <span class="st">"Weekly cases"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1156-1.png" width="672"></div>
<p><span style="color: darkgreen;"><strong>ヒント：</strong>凡例の順番を逆にするには、次の <strong>ggplot2</strong> コマンドを使用します: <code>guides(fill = guide_legend(reverse = TRUE))</code>.</span></p>
</div>
<div id="凡例の調整" class="section level3 unnumbered">
<h3>凡例の調整<a class="anchor" aria-label="anchor" href="#%E5%87%A1%E4%BE%8B%E3%81%AE%E8%AA%BF%E6%95%B4"><i class="fas fa-link"></i></a>
</h3>
<p>凡例やスケールについては、<a href="ggplot-tips.html#ggplot-tips">ggplot のヒント</a> の章で詳しく説明していますが、以下にその要約を記載します。</p>
<ul>
<li>凡例のタイトルを編集するには、scale 関数か、<code>labs(fill = "Legend title")</code> を使用する（<code>color =</code> aesthetic を使用している場合は <code>labs(color = "")</code> を使用する）</li>
<li>
<code>theme(legend.title = element_blank())</code> で凡例のタイトルを削除</li>
<li>
<code>theme(legend.position = "top")</code> （“bottom”, “left”, “right” で凡例をそれぞれ下、左、右に配置。または”none” で凡例が削除される）</li>
<li>
<code>theme(legend.direction = "horizontal")</code> で凡例を水平に配置</li>
<li>
<code>guides(fill = guide_legend(reverse = TRUE))</code> で凡例の順序を逆にする</li>
</ul>
</div>
<div id="棒グラフの横並び表示" class="section level3 unnumbered">
<h3>棒グラフの横並び表示<a class="anchor" aria-label="anchor" href="#%E6%A3%92%E3%82%B0%E3%83%A9%E3%83%95%E3%81%AE%E6%A8%AA%E4%B8%A6%E3%81%B3%E8%A1%A8%E7%A4%BA"><i class="fas fa-link"></i></a>
</h3>
<p>グループ化されたヒストグラムのビンを積み重ねではなく横並びに表示するには、<code><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram()</a></code> 内で <code>position = "dodge"</code> と指定します（<code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code> の外で指定する）。</p>
<p>2 つ以上のグループがある場合、読みにくくなることがあるため、代わりにファセット化された可視化（グループごとにヒストグラムを表示する）を行った方が良いかも知れません。以下の例では、見やすくするために性別の欠測値を削除しています。</p>
<div class="sourceCode" id="cb1564"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">central_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">gender</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>   <span class="co"># 性別の欠損値を除外する</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>        mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>          x <span class="op">=</span> <span class="va">date_onset</span>,</span>
<span>          group <span class="op">=</span> <span class="va">gender</span>,         <span class="co"># gender でグループ化する</span></span>
<span>          fill <span class="op">=</span> <span class="va">gender</span><span class="op">)</span>,         <span class="co"># gender 毎に棒グラフを色分けする</span></span>
<span>        </span>
<span>        <span class="co"># ヒストグラムのビン分割の指定</span></span>
<span>        breaks <span class="op">=</span> <span class="va">weekly_breaks_central</span>,   <span class="co"># 上で定義したビンの分割</span></span>
<span>        </span>
<span>        closed <span class="op">=</span> <span class="st">"left"</span>,          <span class="co"># 分割の開始から症例数をカウントする</span></span>
<span>        </span>
<span>        color <span class="op">=</span> <span class="st">"black"</span>,          <span class="co"># 枠線の色の指定</span></span>
<span>        </span>
<span>        position <span class="op">=</span> <span class="st">"dodge"</span><span class="op">)</span><span class="op">+</span>      <span class="co"># 棒グラフを横並びに指定</span></span>
<span>                      </span>
<span>  </span>
<span>  <span class="co"># x軸のラベル</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span>expand            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,         <span class="co"># X軸の前後の余分なスペースを削除</span></span>
<span>               date_breaks       <span class="op">=</span> <span class="st">"3 weeks"</span>,      <span class="co"># データを3週ごとに表示</span></span>
<span>               date_minor_breaks <span class="op">=</span> <span class="st">"week"</span>,         <span class="co"># 縦縦罫線を1週ごとに表示</span></span>
<span>               date_labels       <span class="op">=</span> <span class="st">"%d\n%b\n'%y"</span><span class="op">)</span><span class="op">+</span> <span class="co"># 日付ラベルのフォーマット</span></span>
<span>  </span>
<span>  <span class="co"># y軸のラベル</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>             <span class="co"># y軸の前後の余分なスペースを削除</span></span>
<span>  </span>
<span>  <span class="co">#手動での色の指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"brown"</span>, <span class="st">"orange"</span><span class="op">)</span>,  <span class="co"># 手動での色の指定、順番に注意！</span></span>
<span>                    na.value <span class="op">=</span> <span class="st">"grey"</span> <span class="op">)</span><span class="op">+</span>     </span>
<span></span>
<span>  <span class="co"># 外観の変更</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                                               <span class="co"># 背景を簡潔なものに指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"italic"</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, <span class="co"># 脚注をイタリック体にして左に幅寄せ</span></span>
<span>        axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>               <span class="co"># 軸タイトルを太字に</span></span>
<span>  </span>
<span>  <span class="co"># ラベルの指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title    <span class="op">=</span> <span class="st">"Weekly incidence of cases, by gender"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Subtitle"</span>,</span>
<span>       fill     <span class="op">=</span> <span class="st">"Gender"</span>,                                      <span class="co"># 凡例のタイトルを指定</span></span>
<span>       x        <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,</span>
<span>       y        <span class="op">=</span> <span class="st">"Weekly incident cases reported"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1157-1.png" width="672"></div>
</div>
<div id="軸の範囲" class="section level3 unnumbered">
<h3>軸の範囲<a class="anchor" aria-label="anchor" href="#%E8%BB%B8%E3%81%AE%E7%AF%84%E5%9B%B2"><i class="fas fa-link"></i></a>
</h3>
<p>軸の値の範囲を決める方法は 2 つあります。</p>
<p>一般的な方法は、<code>xlim = c(min, max)</code> と <code>ylim = c(min, max)</code> を包含する <code><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian()</a></code> コマンドを使用することです（それぞれで min と max の値を指定します）。これは、実際にデータを削除するのではなく「ズーム」として機能し、統計量や要約尺度において重要です。</p>
<p>もう一つの方法として、<code><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date()</a></code> 内で <code>limits = c()</code> を使用して、最初の日付と最後の日付を設定することもできます。</p>
<p>以下はその一例です。</p>
<div class="sourceCode" id="cb1565"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2014-04-01"</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="co"># 最初の日付を指定し、最後の日付は指定しない</span></span></code></pre></div>
<p>同様に、新しい症例が報告されていない場合でも、x 軸を特定の日付（例えば現在の日付）まで伸ばしたい場合は、次のように指定します。</p>
<div class="sourceCode" id="cb1566"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1566-1"><a href="epicurves.html#cb1566-1" aria-hidden="true" tabindex="-1"></a><span class="fu">scale_x_date</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">Sys.Date</span>()) <span class="co"># 最後の日付を現在の日付に指定</span></span></code></pre></div>
<p><span style="color: red;"><u>警告</u>：y軸の区切りや範囲の設定には注意が必要です（例：0 から 30 までを 5 ごとに分割: <code>seq(0, 30, 5)</code>)。このようなやり方では、データが設定範囲外の値だった場合にグラフが極端に短くなる場合があります！</span></p>
</div>
<div id="日付軸のラベルと罫線" class="section level3 unnumbered">
<h3>日付軸のラベルと罫線<a class="anchor" aria-label="anchor" href="#%E6%97%A5%E4%BB%98%E8%BB%B8%E3%81%AE%E3%83%A9%E3%83%99%E3%83%AB%E3%81%A8%E7%BD%AB%E7%B7%9A"><i class="fas fa-link"></i></a>
</h3>
<p><span style="color: darkgreen;"><u><strong>ヒント</strong></u><strong>：<u>日付</u></strong>軸のラベルはデータの集約とは関係ありませんが、ビン分割、日付ラベル、垂直罫線を視覚的に美しいように揃えるために重要です</span></p>
<p>日付ラベルと罫線を変更するには、以下のいずれかの方法で <code><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date()</a></code> を使用します。</p>
<ul>
<li>
<p><strong>ヒストグラムのビン分割が日、月、月曜始まりの週、月、年である場合：</strong></p>
<ul>
<li><p><code>date_breaks =</code> を使用して、ラベルと大きい罫線の間隔を指定します（例：“day”、 “week”、 “3 weeks”、“month”、“year”）</p></li>
<li><p><code>date_minor_breaks =</code> を使用して（日付ラベルの間の）小さい縦罫線の間隔を指定します</p></li>
<li><p>最初の棒グラフからラベルを開始するために <code>expand = c(0,0)</code> を追加します</p></li>
<li><p>日付のラベルの書式を指定するには <code>date_labels =</code> を使用します。<a href="dates.html#dates">日付型データ</a> の章では、役立つヒントを紹介しています（改行には <code>\n</code> を使用など）</p></li>
</ul>
</li>
<li>
<p><strong>ヒストグラムのビン分割が日曜始まりの週：</strong></p>
<ul>
<li>
<code>breaks =</code> と <code>minor_breaks =</code> を使用してそれぞれ一連の日付の区切りを指定します</li>
<li>上記のように <code>date_labels =</code> と <code>expand =</code> を使用して調節することも可能です</li>
</ul>
</li>
</ul>
<p>注意点：</p>
<ul>
<li><p><code><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date()</a></code> を使用して日付のベクトルを作成する方法については、<a href="ggplot-basics.html#ggplot-basics">ggplot の基礎</a> の章を参照して下さい。</p></li>
<li><p>日付ラベルを作成するためのヒントについては、<a href="https://rdrr.io/r/base/strptime.html">こちら</a> のウェブサイト、または、本ハンドブックの <a href="dates.html#dates">日付型データ</a> の章を参照してください。</p></li>
</ul>
<div id="つの例の比較" class="section level4 unnumbered">
<h4>2つの例の比較<a class="anchor" aria-label="anchor" href="#%E3%81%A4%E3%81%AE%E4%BE%8B%E3%81%AE%E6%AF%94%E8%BC%83"><i class="fas fa-link"></i></a>
</h4>
<p>以下は、ビン分割とラベル、罫線が整列しているグラフと整列していないグラフの比較です。</p>
<div class="sourceCode" id="cb1567"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 7日ごとのビン分割＋月曜ラベル</span></span>
<span><span class="co">#############################</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span>,</span>
<span>    binwidth <span class="op">=</span> <span class="fl">7</span>,                 <span class="co"># 最初の症例から7日ごとのビン分割</span></span>
<span>    color <span class="op">=</span> <span class="st">"darkblue"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,               <span class="co"># X軸の前後の余分なスペースを削除</span></span>
<span>    date_breaks <span class="op">=</span> <span class="st">"3 weeks"</span>,       <span class="co"># データを3週ごとに表示</span></span>
<span>    date_minor_breaks <span class="op">=</span> <span class="st">"week"</span>,    <span class="co"># 縦罫線を1週ごとに表示</span></span>
<span>    date_labels <span class="op">=</span> <span class="st">"%a\n%d\n%b\n'%y"</span><span class="op">)</span><span class="op">+</span>  <span class="co"># 日付ラベルのフォーマット</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>              <span class="co"># y軸の前後の余分なスペースを削除</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"MISALIGNED"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"! CAUTION: 7-day bars start Thursdays at first case\nDate labels and gridlines on Mondays\nNote how ticks don't align with bars"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># 7日ごとのビン分割＋月</span></span>
<span><span class="co">#####################</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span>,</span>
<span>    binwidth <span class="op">=</span> <span class="fl">7</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"darkblue"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,                  <span class="co"># X軸の前後の余分なスペースを削除</span></span>
<span>    date_breaks <span class="op">=</span> <span class="st">"months"</span>,           <span class="co"># 月の一番はじめの日</span></span>
<span>    date_minor_breaks <span class="op">=</span> <span class="st">"week"</span>,       <span class="co"># 縦罫線を1週ごとに表示</span></span>
<span>    date_labels <span class="op">=</span> <span class="st">"%a\n%d %b\n%Y"</span><span class="op">)</span><span class="op">+</span>   <span class="co"># 日付ラベルのフォーマット</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                 <span class="co"># y軸の前後の余分なスペースを削除</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"MISALIGNED"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"! CAUTION: 7-day bars start Thursdays with first case\nMajor gridlines and date labels at 1st of each month\nMinor gridlines weekly on Mondays\nNote uneven spacing of some gridlines and ticks unaligned with bars"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># マニュアルでビン分割を月曜日に指定</span></span>
<span><span class="co">#################################################################</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="co"># 最初の症例の前の月曜日から始まる7日ごとのビン分割を指定</span></span>
<span>    breaks <span class="op">=</span> <span class="va">weekly_breaks_central</span>,    <span class="co"># 本章で定義済み</span></span>
<span>    </span>
<span>    closed <span class="op">=</span> <span class="st">"left"</span>,                   <span class="co"># 分割の開始から症例数をカウントする</span></span>
<span>    </span>
<span>    color <span class="op">=</span> <span class="st">"darkblue"</span>,</span>
<span>    </span>
<span>    fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,                   <span class="co"># X軸の前後の余分なスペースを削除</span></span>
<span>    date_breaks <span class="op">=</span> <span class="st">"4 weeks"</span>,           <span class="co"># 4週ごとの月曜日</span></span>
<span>    date_minor_breaks <span class="op">=</span> <span class="st">"week"</span>,        <span class="co"># 月曜始まりの週</span></span>
<span>    date_labels <span class="op">=</span> <span class="st">"%a\n%d %b\n%Y"</span><span class="op">)</span><span class="op">+</span>    <span class="co"># 日付ラベルのフォーマット</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                  <span class="co"># y軸の前後の余分なスペースを削除</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"ALIGNED Mondays"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"7-day bins manually set to begin Monday before first case (28 Apr)\nDate labels and gridlines on Mondays as well"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># ラベルを月にして整列</span></span>
<span><span class="co">############################################</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="co"># 最初の症例の前の月曜日から始まる7日ごとのビン分割を指定</span></span>
<span>    breaks <span class="op">=</span> <span class="va">weekly_breaks_central</span>,    <span class="co"># 本章で定義済み</span></span>
<span>    </span>
<span>    closed <span class="op">=</span> <span class="st">"left"</span>,                   <span class="co"># 分割の開始から症例数をカウントする</span></span>
<span>    </span>
<span>    color <span class="op">=</span> <span class="st">"darkblue"</span>,</span>
<span>    </span>
<span>    fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,                   <span class="co"># X軸の前後の余分なスペースを削除</span></span>
<span>    date_breaks <span class="op">=</span> <span class="st">"months"</span>,            <span class="co"># 4週ごとの月曜日</span></span>
<span>    date_minor_breaks <span class="op">=</span> <span class="st">"week"</span>,        <span class="co"># 月曜始まりの週</span></span>
<span>    date_labels <span class="op">=</span> <span class="st">"%b\n%Y"</span><span class="op">)</span><span class="op">+</span>           <span class="co"># 日付ラベルのフォーマット</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                  <span class="co"># y軸の前後の余分なスペースを削除</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>  <span class="co"># 大きい縦罫線の削除</span></span>
<span>          </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"ALIGNED Mondays with MONTHLY labels"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"7-day bins manually set to begin Monday before first case (28 Apr)\nDate labels on 1st of Month\nMonthly major gridlines removed"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># マニュアルでビン分割とラベルを日曜日に指定</span></span>
<span><span class="co">############################################################################</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="co"># 最初の症例の前の日曜日から始まる7日ごとのビン分割を指定</span></span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>                      to   <span class="op">=</span> <span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>                      by   <span class="op">=</span> <span class="st">"7 days"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    closed <span class="op">=</span> <span class="st">"left"</span>,                    <span class="co"># 分割の開始から症例数をカウントする</span></span>
<span></span>
<span>    color <span class="op">=</span> <span class="st">"darkblue"</span>,</span>
<span>    </span>
<span>    fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,</span>
<span>    <span class="co"># 最初の症例の前の日曜日から始まる3週間ごとのラベルと大きい罫線を指定</span></span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>                      to   <span class="op">=</span> <span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>                      by   <span class="op">=</span> <span class="st">"3 weeks"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="co"># 最初の症例の前の日曜日から始まる7日ごとの小さい罫線を指定</span></span>
<span>    minor_breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu">floor_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,   <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>                            to   <span class="op">=</span> <span class="fu">ceiling_date</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>                            by   <span class="op">=</span> <span class="st">"7 days"</span><span class="op">)</span>,</span>
<span>    </span>
<span>    date_labels <span class="op">=</span> <span class="st">"%a\n%d\n%b\n'%y"</span><span class="op">)</span><span class="op">+</span>  <span class="co"># 日付ラベルのフォーマット</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                <span class="co"># y軸の前後の余分なスペースを削除</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"ALIGNED Sundays"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"7-day bins manually set to begin Sunday before first case (27 Apr)\nDate labels and gridlines manually set to Sundays as well"</span><span class="op">)</span></span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-1160-1.png" width="672"><img src="_main_files/figure-html/unnamed-chunk-1160-2.png" width="672"><img src="_main_files/figure-html/unnamed-chunk-1160-3.png" width="672"><img src="_main_files/figure-html/unnamed-chunk-1160-4.png" width="672"><img src="_main_files/figure-html/unnamed-chunk-1160-5.png" width="672"></p>
</div>
</div>
<div id="集計データ" class="section level3 unnumbered">
<h3>集計データ<a class="anchor" aria-label="anchor" href="#%E9%9B%86%E8%A8%88%E3%83%87%E3%83%BC%E3%82%BF"><i class="fas fa-link"></i></a>
</h3>
<p>ラインリストではなく、施設や地域などの集計データのみがあることが多くあります。集計データのみでも <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> で流行曲線を作成することができますが、コードが少し異なります。このセクションでは、先述のデータ準備のセクションでインポートした <code>count_data</code> データセットを使用します。このデータセットは、<code>linelist</code> に含まれている症例数を日別にカウントしたデータです。最初の 50 行を以下に表示します。</p>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-4e85efc72ebc1be9bbb3" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-4e85efc72ebc1be9bbb3">{"x":{"filter":"top","vertical":false,"filterHTML":"<tr>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\" disabled=\"\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1399334400000\" data-max=\"1410307200000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"integer\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1\" data-max=\"3\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital"],["2014-05-06","2014-05-10","2014-05-13","2014-05-28","2014-06-06","2014-06-09","2014-06-14","2014-06-19","2014-07-09","2014-07-10","2014-07-11","2014-07-13","2014-07-14","2014-07-15","2014-07-17","2014-07-19","2014-07-27","2014-07-30","2014-08-01","2014-08-02","2014-08-04","2014-08-05","2014-08-07","2014-08-09","2014-08-12","2014-08-14","2014-08-15","2014-08-16","2014-08-17","2014-08-18","2014-08-19","2014-08-20","2014-08-21","2014-08-22","2014-08-23","2014-08-24","2014-08-26","2014-08-28","2014-08-29","2014-08-30","2014-08-31","2014-09-01","2014-09-02","2014-09-03","2014-09-04","2014-09-05","2014-09-06","2014-09-07","2014-09-09","2014-09-10"],[1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,2,1,1,2,1,2,1,1,2,1,3,1,1,1,2,3,2,2,2,1,2,2,2,1,2,3,3,2,1,1,2,3,2,2,1]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>hospital<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>n_cases<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><div id="日別カウントデータの可視化" class="section level4 unnumbered">
<h4>日別カウントデータの可視化<a class="anchor" aria-label="anchor" href="#%E6%97%A5%E5%88%A5%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%8F%AF%E8%A6%96%E5%8C%96"><i class="fas fa-link"></i></a>
</h4>
<p>日別カウントデータから流行曲線を作成することができます。以下は以前のコードとの相違点です。</p>
<ul>
<li><p><code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code> 内で、日別カウントデータを <code>y =</code> に指定します（この場合、列名は <code>n_cases</code> です）。</p></li>
<li><p><code><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram()</a></code> に引数 <code>stat = "identity"</code> を追加し、ヒストグラムのビンの高さをデフォルトの行数ではなく、<code>y =</code> として指定します。</p></li>
<li><p>棒グラフの間に縦の白線が入らないように、<code>width =</code> の引数を追加します。日別データの場合、1 に設定します。週別カウントデータの場合は 7 に設定します。月別のカウントデータでは、（各月で日数が異なるため）白線が問題となりますので、x 軸を因子型（月）に変換して <code><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col()</a></code> を使用することを検討して下さい。</p></li>
</ul>
<div class="sourceCode" id="cb1568"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">count_data</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>   mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_hospitalisation</span>, y <span class="op">=</span> <span class="va">n_cases</span><span class="op">)</span>,</span>
<span>   stat <span class="op">=</span> <span class="st">"identity"</span>,</span>
<span>   width <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">+</span>                <span class="co"># 日別カウントデータ の場合は set width = 1 で棒グラフの間のスペースを適切にする</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Date of report"</span>, </span>
<span>    y <span class="op">=</span> <span class="st">"Number of cases"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Daily case incidence, from daily count data"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1162-1.png" width="672"></div>
</div>
<div id="週別カウントデータの可視化" class="section level4 unnumbered">
<h4>週別カウントデータの可視化<a class="anchor" aria-label="anchor" href="#%E9%80%B1%E5%88%A5%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%8F%AF%E8%A6%96%E5%8C%96"><i class="fas fa-link"></i></a>
</h4>
<p>もしデータが週ごとの症例数であれば、以下と同じようになっているはずです（count_data_weekly というデータセット名にしています）。</p>
<p>以下に表示した <code>count_data_weekly</code> の最初の 50 行を見ると、週単位で症例が集計されていることがわかります。各週は、週の最初の日（デフォルトでは月曜日）で表示されています。</p>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-3d573f8dc5df58616a37" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-3d573f8dc5df58616a37">{"x":{"filter":"none","vertical":false,"data":[["Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Central Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Military Hospital","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Missing","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Other","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)"],["2014-05-04","2014-05-11","2014-05-25","2014-06-01","2014-06-08","2014-06-15","2014-07-06","2014-07-13","2014-07-27","2014-08-03","2014-08-10","2014-08-17","2014-08-24","2014-08-31","2014-09-07","2014-09-14","2014-09-21","2014-09-28","2014-10-05","2014-10-12","2014-10-19","2014-10-26","2014-11-02","2014-11-09","2014-11-16","2014-11-23","2014-11-30","2014-12-07","2014-12-14","2014-12-21","2014-12-28","2015-01-04","2015-01-11","2015-01-18","2015-01-25","2015-02-01","2015-02-08","2015-02-15","2015-02-22","2015-03-01","2015-03-08","2015-03-15","2015-03-22","2015-03-29","2015-04-05","2015-04-12","2015-04-19","2015-04-26","2014-04-13","2014-05-11","2014-05-18","2014-05-25","2014-06-01","2014-06-08","2014-06-15","2014-06-22","2014-06-29","2014-07-06","2014-07-13","2014-07-20","2014-07-27","2014-08-03","2014-08-10","2014-08-17","2014-08-24","2014-08-31","2014-09-07","2014-09-14","2014-09-21","2014-09-28","2014-10-05","2014-10-12","2014-10-19","2014-10-26","2014-11-02","2014-11-09","2014-11-16","2014-11-23","2014-11-30","2014-12-07","2014-12-14","2014-12-21","2014-12-28","2015-01-04","2015-01-11","2015-01-18","2015-01-25","2015-02-01","2015-02-08","2015-02-15","2015-02-22","2015-03-01","2015-03-08","2015-03-15","2015-03-22","2015-03-29","2015-04-05","2015-04-12","2015-04-19","2015-04-26","2014-04-27","2014-05-04","2014-05-11","2014-05-18","2014-05-25","2014-06-01","2014-06-08","2014-06-15","2014-06-22","2014-06-29","2014-07-06","2014-07-13","2014-07-20","2014-07-27","2014-08-03","2014-08-10","2014-08-17","2014-08-24","2014-08-31","2014-09-07","2014-09-14","2014-09-21","2014-09-28","2014-10-05","2014-10-12","2014-10-19","2014-10-26","2014-11-02","2014-11-09","2014-11-16","2014-11-23","2014-11-30","2014-12-07","2014-12-14","2014-12-21","2014-12-28","2015-01-04","2015-01-11","2015-01-18","2015-01-25","2015-02-01","2015-02-08","2015-02-15","2015-02-22","2015-03-01","2015-03-08","2015-03-15","2015-03-22","2015-03-29","2015-04-05","2015-04-12","2015-04-19","2015-04-26","2014-04-20","2014-04-27","2014-05-04","2014-05-11","2014-05-18","2014-05-25","2014-06-01","2014-06-08","2014-06-15","2014-06-22","2014-06-29","2014-07-06","2014-07-13","2014-07-20","2014-07-27","2014-08-03","2014-08-10","2014-08-17","2014-08-24","2014-08-31","2014-09-07","2014-09-14","2014-09-21","2014-09-28","2014-10-05","2014-10-12","2014-10-19","2014-10-26","2014-11-02","2014-11-09","2014-11-16","2014-11-23","2014-11-30","2014-12-07","2014-12-14","2014-12-21","2014-12-28","2015-01-04","2015-01-11","2015-01-18","2015-01-25","2015-02-01","2015-02-08","2015-02-15","2015-02-22","2015-03-01","2015-03-08","2015-03-15","2015-03-22","2015-03-29","2015-04-05","2015-04-12","2015-04-19","2015-04-26","2014-04-20","2014-05-04","2014-05-18","2014-05-25","2014-06-01","2014-06-08","2014-06-15","2014-06-22","2014-06-29","2014-07-06","2014-07-13","2014-07-20","2014-07-27","2014-08-03","2014-08-10","2014-08-17","2014-08-24","2014-08-31","2014-09-07","2014-09-14","2014-09-21","2014-09-28","2014-10-05","2014-10-12","2014-10-19","2014-10-26","2014-11-02","2014-11-09","2014-11-16","2014-11-23","2014-11-30","2014-12-07","2014-12-14","2014-12-21","2014-12-28","2015-01-04","2015-01-11","2015-01-18","2015-01-25","2015-02-01","2015-02-08","2015-02-15","2015-02-22","2015-03-01","2015-03-08","2015-03-15","2015-03-22","2015-03-29","2015-04-05","2015-04-12","2015-04-19","2015-04-26","2014-05-04","2014-05-18","2014-05-25","2014-06-01","2014-06-15","2014-06-22","2014-07-06","2014-07-13","2014-07-20","2014-07-27","2014-08-03","2014-08-10","2014-08-17","2014-08-24","2014-08-31","2014-09-07","2014-09-14","2014-09-21","2014-09-28","2014-10-05","2014-10-12","2014-10-19","2014-10-26","2014-11-02","2014-11-09","2014-11-16","2014-11-23","2014-11-30","2014-12-07","2014-12-14","2014-12-21","2014-12-28","2015-01-04","2015-01-11","2015-01-18","2015-01-25","2015-02-01","2015-02-08","2015-02-15","2015-02-22","2015-03-01","2015-03-08","2015-03-15","2015-03-22","2015-03-29","2015-04-05","2015-04-12","2015-04-19","2015-04-26"],[2,1,2,1,2,1,3,7,5,6,6,13,9,15,12,23,24,23,25,26,23,19,25,19,14,9,10,9,8,12,5,10,5,6,6,4,8,9,8,2,5,3,4,5,6,3,6,5,1,6,3,4,2,3,3,2,3,4,6,13,11,17,18,16,18,31,33,46,44,43,42,39,36,39,51,22,15,31,27,23,24,12,15,22,22,20,17,16,8,13,9,15,13,6,10,4,5,4,5,4,2,1,4,2,5,8,5,9,11,7,12,8,10,12,27,21,34,40,48,53,75,79,85,84,80,77,54,43,41,31,33,37,26,39,30,31,24,33,20,21,21,22,19,20,23,10,13,19,18,10,12,12,8,1,1,1,3,3,3,2,4,2,5,3,8,10,8,11,16,11,15,25,23,39,46,50,49,40,53,44,38,29,29,23,26,26,19,17,19,14,18,16,15,14,17,6,6,9,11,8,11,12,5,5,7,6,3,1,4,3,8,6,3,9,9,9,11,14,15,21,25,22,37,59,53,70,93,107,103,87,64,77,74,75,59,56,58,49,46,34,40,24,20,27,27,28,24,22,15,28,24,18,23,13,22,11,10,12,13,2,3,1,3,1,2,5,3,6,5,7,4,8,7,12,20,27,19,22,23,15,18,13,16,20,10,17,6,13,8,8,8,9,1,8,7,6,6,8,6,4,13,5,2,3,5,2,3,2]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>hospital<\/th>\n      <th>epiweek<\/th>\n      <th>n_cases_weekly<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p><code>x =</code> 引数に <code>epiweek</code> 列を指定して流行曲線をプロットします。<code>y =</code> 引数にカウント列（この例では、<code>n_cases_weekly</code> 列）を指定し、上で説明したように <code>stat = "identity"</code> を追加することを忘れないで下さい。</p>
<div class="sourceCode" id="cb1569"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">count_data_weekly</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">epiweek</span>,           <span class="co"># x軸に疫学週を指定（日付型として）</span></span>
<span>      y <span class="op">=</span> <span class="va">n_cases_weekly</span>,    <span class="co"># y軸に週別カウントデータを指定</span></span>
<span>      group <span class="op">=</span> <span class="va">hospital</span>,      <span class="co"># hospital でグループ化して色分け</span></span>
<span>      fill <span class="op">=</span> <span class="va">hospital</span><span class="op">)</span>,</span>
<span>    stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span><span class="op">+</span>      <span class="co"># カウントデータをプロットする場合に必要</span></span>
<span>     </span>
<span>  <span class="co"># x軸のラベル</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    date_breaks <span class="op">=</span> <span class="st">"2 months"</span>,      <span class="co"># データを2か月ごとに表示</span></span>
<span>    date_minor_breaks <span class="op">=</span> <span class="st">"1 month"</span>, <span class="co"># 縦罫線を1か月ごとに表示</span></span>
<span>    date_labels <span class="op">=</span> <span class="st">'%b\n%Y'</span><span class="op">)</span><span class="op">+</span>       <span class="co"># 日付ラベルのフォーマット（月の下に年を記載）</span></span>
<span>     </span>
<span>  <span class="co"># 色パレットを指定 （RColorBrewer パッケージを使用）</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Pastel2"</span><span class="op">)</span><span class="op">+</span> </span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Week of onset"</span>, </span>
<span>    y <span class="op">=</span> <span class="st">"Weekly case incidence"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Hospital"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Weekly case incidence, from aggregated count data by hospital"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1165-1.png" width="672"></div>
</div>
</div>
<div id="移動平均-1" class="section level3 unnumbered">
<h3>移動平均<a class="anchor" aria-label="anchor" href="#%E7%A7%BB%E5%8B%95%E5%B9%B3%E5%9D%87-1"><i class="fas fa-link"></i></a>
</h3>
<p>詳細な説明については、<a href="moving-average.html#moving-average">移動平均</a> の章を参照して下さい。以下は、<strong>slider</strong> パッケージで移動平均を計算する方法の 1 つです。この方法では、移動平均はプロットする前にデータセット上で計算されます。</p>
<ol style="list-style-type: decimal">
<li>データを日別、週別など必要に応じて集計します（<a href="grouping">データのグループ化</a> の章を参照）。<br>
</li>
<li>
<strong>slider</strong> パッケージの <code>slide_index()</code> で移動平均の列を新しく作成します。<br>
</li>
<li>移動平均を <code><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line()</a></code> で 流行曲線の上（後）にプロットします。</li>
</ol>
<p>詳細は <a href="https://cran.r-project.org/web/packages/slider/vignettes/slider.html"><strong>slider</strong> パッケージ</a>の説明を参照して下さい。</p>
<div class="sourceCode" id="cb1570"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># パッケージの読み込み</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">slider</span><span class="op">)</span>  <span class="co"># 移動平均の計算に slider を使用</span></span>
<span></span>
<span><span class="co"># 週別カウントと7日間移動平均のデータセットを作成</span></span>
<span><span class="co">#######################################################</span></span>
<span><span class="va">ll_counts_7day</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>    <span class="co"># ラインリスト</span></span>
<span>  </span>
<span>  <span class="co">## 日別にカウント</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date_onset</span>, name <span class="op">=</span> <span class="st">"new_cases"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>   <span class="co"># "new cases"という名前の列を作成</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                     <span class="co"># 発症日欠損症例を除外</span></span>
<span>  </span>
<span>  <span class="co">## 7日間移動平均数を計算</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    avg_7day <span class="op">=</span> <span class="fu">slider</span><span class="fu">::</span><span class="fu"><a href="https://slider.r-lib.org/reference/slide_index.html">slide_index</a></span><span class="op">(</span>    <span class="co"># 新しい列を作成</span></span>
<span>      <span class="va">new_cases</span>,                       <span class="co"># new_cases 列の値を用いる</span></span>
<span>      .i <span class="op">=</span> <span class="va">date_onset</span>,                 <span class="co"># date_onset 列の含まれていない日付も移動平均に含める</span></span>
<span>      .f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,    <span class="co"># 欠損値を除外した上で平均をとる</span></span>
<span>      .before <span class="op">=</span> <span class="fl">6</span>,                     <span class="co"># 日別に6日前までのデータを移動平均に含める</span></span>
<span>      .complete <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,              <span class="co"># 次のステップのために FALSE に設定する</span></span>
<span>    avg_7day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">avg_7day</span><span class="op">)</span><span class="op">)</span>       <span class="co"># list型から数字型に変換</span></span>
<span></span>
<span></span>
<span><span class="co"># プロット</span></span>
<span><span class="co">######</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ll_counts_7day</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># 以前のコードで定義済みのデータセット</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>              <span class="co"># ヒストグラムの作成</span></span>
<span>      mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="va">date_onset</span>,          <span class="co"># x軸の日付列を指定</span></span>
<span>        y <span class="op">=</span> <span class="va">new_cases</span><span class="op">)</span>,          <span class="co"># y軸に日別のカウント数を指定</span></span>
<span>        stat <span class="op">=</span> <span class="st">"identity"</span>,       <span class="co"># カウントデータように指定</span></span>
<span>        fill<span class="op">=</span><span class="st">"#92a8d1"</span>,          <span class="co"># かっこいい色を指定</span></span>
<span>        colour <span class="op">=</span> <span class="st">"#92a8d1"</span>,      <span class="co"># 枠線も同じ色に指定</span></span>
<span>        <span class="op">)</span><span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>                   <span class="co"># 移動平均の線グラフを作成</span></span>
<span>      mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="va">date_onset</span>,          <span class="co"># x軸の日付列を指定</span></span>
<span>        y <span class="op">=</span> <span class="va">avg_7day</span>,            <span class="co"># y軸に日別の移動平均を指定</span></span>
<span>        lty <span class="op">=</span> <span class="st">"7-day \nrolling avg"</span><span class="op">)</span>, <span class="co"># 線グラフの凡例を記載</span></span>
<span>      color<span class="op">=</span><span class="st">"red"</span>,               <span class="co"># 線グラフの色の指定</span></span>
<span>      size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>                <span class="co"># 線グラフの太さの指定</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span>                <span class="co"># 日付軸のスケール</span></span>
<span>      date_breaks <span class="op">=</span> <span class="st">"1 month"</span>,</span>
<span>      date_labels <span class="op">=</span> <span class="st">'%d/%m'</span>,</span>
<span>      expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>          <span class="co"># y軸のスケール</span></span>
<span>      expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,</span>
<span>      limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>       </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>      x<span class="op">=</span><span class="st">""</span>,</span>
<span>      y <span class="op">=</span><span class="st">"Number of confirmed cases"</span>,</span>
<span>      fill <span class="op">=</span> <span class="st">"Legend"</span><span class="op">)</span><span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="co"># 凡例のタイトルを削除</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1166-1.png" width="672"></div>
</div>
<div id="ファセット化プロットの小分割" class="section level3 unnumbered">
<h3>ファセット化・プロットの小分割<a class="anchor" aria-label="anchor" href="#%E3%83%95%E3%82%A1%E3%82%BB%E3%83%83%E3%83%88%E5%8C%96%E3%83%97%E3%83%AD%E3%83%83%E3%83%88%E3%81%AE%E5%B0%8F%E5%88%86%E5%89%B2"><i class="fas fa-link"></i></a>
</h3>
<p>他の ggplot と同様に、ファセット化されたグラフ（「複数の小さなグラフを並べたグラフ」）を作成することができます。<a href="ggplot-basics.html#ggplot-basics">ggplot の基礎</a> の章で説明されているように、 <code><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap()</a></code> と <code><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid()</a></code> のどちらかを使用することができますが、ここでは <code><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap()</a></code> を使って説明します。流行曲線の作成においては、1 つの列に対してのみファセットするだけでよいので、一般的に <code><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap()</a></code> の方が簡単です。</p>
<p>一般的な構文は <code>facet_wrap(rows ~ cols)</code> で、チルダ (~) の左側はファセット化プロットの「行」に対する列の名前、チルダの右側はファセット化プロットの「列」に対する列の名前です。最も簡単な例では、チルダの右側に 1 つの列を指定します: <code>facet_wrap(~age_cat)</code></p>
<p><strong>フリースケール</strong><br>
各ファセットの軸のスケールを同じ値に「固定」（デフォルト）するか、「自由」（ファセット内のデータに基づいて変更する）にするかを指定します。これは、<code><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap()</a></code> 内の <code>scales =</code> 引数で、“free_x” か “free_y” か “free” を指定することでできます。</p>
<p><strong>ファセットの列数と行数</strong><br><code><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap()</a></code> 内で <code>ncol =</code> または <code>nrow =</code> で指定することができます。</p>
<p><strong>パネルの順番</strong><br>
順序を変更するには、ファセットを作成するために使用される因子型列のレベルの順序を変更します。</p>
<p><strong>外観</strong><br>
フォントサイズ、ヘッダ、色などは、以下のような引数を持つ <code><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme()</a></code> で変更することができます。</p>
<ul>
<li>
<code>strip.text = element_text()</code> (サイズ、ヘッダ、色、角度など)</li>
<li>
<code>strip.background = element_rect()</code> (例：element_rect(fill=“grey”))</li>
<li>
<code>strip.position =</code> (ファセットのタイトルが記載されるボックスの場所を指定：“bottom”, “top”, “left”, or “right”)</li>
</ul>
<p><strong>ファセットラベル</strong><br>
ファセットプロットのラベルは、列の「ラベル」を用いるか「ラベラー（labeller）」の使用によって変更することができます。</p>
<p><strong>ggplot2</strong> の関数 <code><a href="https://ggplot2.tidyverse.org/reference/as_labeller.html">as_labeller()</a></code> を用いて、ラベラーを作成した後に、以下のように <code><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap()</a></code> の <code>labeller =</code> 引数に作成したラベラーを指定します。</p>
<div class="sourceCode" id="cb1571"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/as_labeller.html">as_labeller</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>     <span class="st">"0-4"</span>   <span class="op">=</span> <span class="st">"Ages 0-4"</span>,</span>
<span>     <span class="st">"5-9"</span>   <span class="op">=</span> <span class="st">"Ages 5-9"</span>,</span>
<span>     <span class="st">"10-14"</span> <span class="op">=</span> <span class="st">"Ages 10-14"</span>,</span>
<span>     <span class="st">"15-19"</span> <span class="op">=</span> <span class="st">"Ages 15-19"</span>,</span>
<span>     <span class="st">"20-29"</span> <span class="op">=</span> <span class="st">"Ages 20-29"</span>,</span>
<span>     <span class="st">"30-49"</span> <span class="op">=</span> <span class="st">"Ages 30-49"</span>,</span>
<span>     <span class="st">"50-69"</span> <span class="op">=</span> <span class="st">"Ages 50-69"</span>,</span>
<span>     <span class="st">"70+"</span>   <span class="op">=</span> <span class="st">"Over age 70"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>以下は、<code>age_cat</code> 列でファセットしたグラフの作成例です。</p>
<div class="sourceCode" id="cb1572"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># プロットの作成</span></span>
<span><span class="co">###########</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">date_onset</span>,</span>
<span>      group <span class="op">=</span> <span class="va">age_cat</span>,</span>
<span>      fill <span class="op">=</span> <span class="va">age_cat</span><span class="op">)</span>,    <span class="co"># aes() 内の引数はグループされる</span></span>
<span>      </span>
<span>    color <span class="op">=</span> <span class="st">"black"</span>,      <span class="co"># aes() 外の引数は全データに適用される</span></span>
<span>        </span>
<span>    <span class="co"># ビン分割</span></span>
<span>    breaks <span class="op">=</span> <span class="va">weekly_breaks_central</span>, <span class="co"># 以前のコードで定義済み （ggplot セクション参照）</span></span>
<span>    closed <span class="op">=</span> <span class="st">"left"</span> <span class="co"># count cases from start of breakpoint</span></span>
<span>    <span class="op">)</span><span class="op">+</span>  </span>
<span>                      </span>
<span>  <span class="co"># x軸のラベル</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    expand            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,         <span class="co"># X軸の前後の余分なスペースを削除</span></span>
<span>    date_breaks       <span class="op">=</span> <span class="st">"2 months"</span>,     <span class="co"># データを2月ごとに表示</span></span>
<span>    date_minor_breaks <span class="op">=</span> <span class="st">"1 month"</span>,      <span class="co"># 縦罫線を1月ごとに表示</span></span>
<span>    date_labels       <span class="op">=</span> <span class="st">"%b\n'%y"</span><span class="op">)</span><span class="op">+</span>     <span class="co"># 日付ラベルのフォーマット</span></span>
<span>  </span>
<span>  <span class="co"># y軸のラベル</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                       <span class="co"># y軸の前後の余分なスペースを削除</span></span>
<span>  </span>
<span>  <span class="co"># テーマの指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                                           <span class="co"># 背景を簡潔なものに指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"italic"</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, <span class="co"># 脚注をイタリック体にして左に幅寄せ</span></span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>         <span class="co"># 軸タイトルを太字に</span></span>
<span>  </span>
<span>  <span class="co"># ファセットの作成</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="va">age_cat</span>,</span>
<span>    ncol <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    strip.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    labeller <span class="op">=</span> <span class="va">my_labels</span><span class="op">)</span><span class="op">+</span>             </span>
<span>  </span>
<span>  <span class="co"># ラベル</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title    <span class="op">=</span> <span class="st">"Weekly incidence of cases, by age category"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Subtitle"</span>,</span>
<span>    fill     <span class="op">=</span> <span class="st">"Age category"</span>,                                      <span class="co"># 凡例のタイトル</span></span>
<span>    x        <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,</span>
<span>    y        <span class="op">=</span> <span class="st">"Weekly incident cases reported"</span>,</span>
<span>    caption  <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"n = {nrow(central_data)} from Central Hospital; Case onsets range from {format(min(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')} to {format(max(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')}\n{nrow(central_data %&gt;% filter(is.na(date_onset)))} cases missing date of onset and not shown"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1168-1.png" width="672"></div>
<p>ラベラーの詳細については、<a href="https://ggplot2.tidyverse.org/reference/labellers.html">こちら</a> のウェブサイトを参照してください。</p>
<div id="ファセットの背景に全体の流行曲線を表示" class="section level4 unnumbered">
<h4>ファセットの背景に全体の流行曲線を表示<a class="anchor" aria-label="anchor" href="#%E3%83%95%E3%82%A1%E3%82%BB%E3%83%83%E3%83%88%E3%81%AE%E8%83%8C%E6%99%AF%E3%81%AB%E5%85%A8%E4%BD%93%E3%81%AE%E6%B5%81%E8%A1%8C%E6%9B%B2%E7%B7%9A%E3%82%92%E8%A1%A8%E7%A4%BA"><i class="fas fa-link"></i></a>
</h4>
<p>各ファセットの背景に全体の流行曲線を表示するには、<strong>ggplot</strong> で作成した図に <strong>gghighlight</strong> パッケージの <code><a href="https://yutannihilation.github.io/gghighlight/reference/gghighlight.html">gghighlight()</a></code> を追加します。すべてのファセットにおける y 軸の最大値が、全体の流行曲線の頂点になっていることに注意して下さい。<strong>gghighlight</strong> パッケージの例は、<a href="ggplot-basics.html#ggplot-basics">ggplot の基礎</a> の章で多く紹介されています。</p>
<div class="sourceCode" id="cb1573"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  </span>
<span>  <span class="co"># グループ化された流行曲線</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">date_onset</span>,</span>
<span>      group <span class="op">=</span> <span class="va">age_cat</span>,</span>
<span>      fill <span class="op">=</span> <span class="va">age_cat</span><span class="op">)</span>,  <span class="co"># aes() 内の引数はグループされる</span></span>
<span>    </span>
<span>    color <span class="op">=</span> <span class="st">"black"</span>,    <span class="co"># aes() 外の引数は全データに適用される</span></span>
<span>    </span>
<span>    <span class="co"># ビン分割</span></span>
<span>    breaks <span class="op">=</span> <span class="va">weekly_breaks_central</span>, <span class="co"># 以前のコードで定義済み （ggplot セクション参照）</span></span>
<span>    </span>
<span>    closed <span class="op">=</span> <span class="st">"left"</span> <span class="co"># 分割の開始から症例数をカウントする</span></span>
<span>    <span class="op">)</span><span class="op">+</span>     <span class="co"># 以前のコードで定義済み （ggplot セクション参照）                </span></span>
<span>  </span>
<span>  <span class="co"># ファセットの背景に全体の流行曲線を灰色で示す</span></span>
<span>  <span class="fu">gghighlight</span><span class="fu">::</span><span class="fu"><a href="https://yutannihilation.github.io/gghighlight/reference/gghighlight.html">gghighlight</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># x軸のラベル</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    expand            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,         <span class="co"># X軸の前後の余分なスペースを削除</span></span>
<span>    date_breaks       <span class="op">=</span> <span class="st">"2 months"</span>,     <span class="co"># データを2月ごとに表示</span></span>
<span>    date_minor_breaks <span class="op">=</span> <span class="st">"1 month"</span>,      <span class="co"># 縦罫線を1月ごとに表示 </span></span>
<span>    date_labels       <span class="op">=</span> <span class="st">"%b\n'%y"</span><span class="op">)</span><span class="op">+</span>     <span class="co"># 日付ラベルのフォーマット</span></span>
<span>  </span>
<span>  <span class="co"># y軸のラベル</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>  <span class="co"># y軸の前後の余分なスペースを削除</span></span>
<span>  </span>
<span>  <span class="co"># テーマの指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                                           <span class="co"># 背景を簡潔なものに指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"italic"</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, <span class="co"># 脚注をイタリック体にして左に幅寄せ</span></span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>        <span class="co"># 軸タイトルを太字に</span></span>
<span>  </span>
<span>  <span class="co"># ファセットの作成</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="va">age_cat</span>,                          <span class="co"># それぞれのプロットに age_cat のグループを表示</span></span>
<span>    ncol <span class="op">=</span> <span class="fl">4</span>,                          <span class="co"># 列数を指定</span></span>
<span>    strip.position <span class="op">=</span> <span class="st">"top"</span>,            <span class="co"># ファセットタイトルの位置を指定</span></span>
<span>    labeller <span class="op">=</span> <span class="va">my_labels</span><span class="op">)</span><span class="op">+</span>             <span class="co"># 上で定義した labeller の指定</span></span>
<span>  </span>
<span>  <span class="co"># ラベル</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title    <span class="op">=</span> <span class="st">"Weekly incidence of cases, by age category"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Subtitle"</span>,</span>
<span>    fill     <span class="op">=</span> <span class="st">"Age category"</span>,                                      <span class="co"># 凡例のタイトル</span></span>
<span>    x        <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,</span>
<span>    y        <span class="op">=</span> <span class="st">"Weekly incident cases reported"</span>,</span>
<span>    caption  <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"n = {nrow(central_data)} from Central Hospital; Case onsets range from {format(min(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')} to {format(max(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')}\n{nrow(central_data %&gt;% filter(is.na(date_onset)))} cases missing date of onset and not shown"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1169-1.png" width="672"></div>
</div>
<div id="全データを含んだファセットの作成" class="section level4 unnumbered">
<h4>全データを含んだファセットの作成<a class="anchor" aria-label="anchor" href="#%E5%85%A8%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%90%AB%E3%82%93%E3%81%A0%E3%83%95%E3%82%A1%E3%82%BB%E3%83%83%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fas fa-link"></i></a>
</h4>
<p>全データを含むファセットボックスを表示したい場合は、データセット全体を複製し、複製したものを 1 つのファセットとして扱います。以下で自作する関数（ヘルパー関数）である <code>CreateAllFacet()</code> を使用すると可能です（このヘルパー関数は、<a href="https://stackoverflow.com/questions/18933575/easily-add-an-all-facet-to-facet-wrap-in-ggplot2">こちら</a> のページで紹介されているものです）。この関数を実行すると、行の数が 2 倍になり、<code>facet</code> という新しい列が作られます。その中で新たに複製された行は「all」という値を、元の行は <code>facet</code> 列の元の値を持つようになります。その後にこの <code>facet</code> 列に対してファセットを行います。</p>
<p>まず、ヘルパー関数を作成して実行し、利用できるようにします。</p>
<div class="sourceCode" id="cb1574"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># helper 関数を定義する</span></span>
<span><span class="va">CreateAllFacet</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">col</span><span class="op">)</span><span class="op">{</span></span>
<span>     <span class="va">df</span><span class="op">$</span><span class="va">facet</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span></span>
<span>     <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">df</span></span>
<span>     <span class="va">temp</span><span class="op">$</span><span class="va">facet</span> <span class="op">&lt;-</span> <span class="st">"all"</span></span>
<span>     <span class="va">merged</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">df</span><span class="op">)</span></span>
<span>     </span>
<span>     <span class="co"># ファセット値を因子型に指定</span></span>
<span>     <span class="va">merged</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">merged</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>     </span>
<span>     <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">merged</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>次にこのヘルパー関数をデータセットの <code>age_cat</code> 列に適用します。</p>
<div class="sourceCode" id="cb1575"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 複製されたデータセットに新たに「facet」列を追加し、別のファセットレベルとして「all」年齢区分を表示する。</span></span>
<span><span class="va">central_data2</span> <span class="op">&lt;-</span> <span class="fu">CreateAllFacet</span><span class="op">(</span><span class="va">central_data</span>, col <span class="op">=</span> <span class="st">"age_cat"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># 因子のレベルを指定</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>facet <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_relevel.html">fct_relevel</a></span><span class="op">(</span><span class="va">facet</span>, <span class="st">"all"</span>, <span class="st">"0-4"</span>, <span class="st">"5-9"</span>,</span>
<span>                             <span class="st">"10-14"</span>, <span class="st">"15-19"</span>, <span class="st">"20-29"</span>,</span>
<span>                             <span class="st">"30-49"</span>, <span class="st">"50-69"</span>, <span class="st">"70+"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: 1 unknown level in `f`: 70+</code></pre>
<div class="sourceCode" id="cb1577"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># レベルのチェック</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">central_data2</span><span class="op">$</span><span class="va">facet</span>, useNA <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##   all   0-4   5-9 10-14 15-19 20-29 30-49 50-69  &lt;NA&gt; 
##   454    84    84    82    58    73    57     7     9</code></pre>
<p><code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> コマンドにおける注意点は、以下の通りです。</p>
<ul>
<li><p>使用するデータセットは central_data2（行数が 2 倍になり、新しい列 “facet” が追加）</p></li>
<li><p>ラベラーを使用する場合は、更新する必要があります。</p></li>
<li><p>必要であれば：縦に積み重ねたファセットを実現するために、ファセット列を式の行側に移動し、右側を “.” (<code>facet_wrap(facet~.)</code>) に置き換え、<code>ncol = 1</code>とします。保存される png ファイルの幅と高さの調整が必要になります（<a href="ggplot-basics.html#ggplot-basics">ggplot の基礎</a> の章で紹介している <code><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave()</a></code> を参照してください）。</p></li>
</ul>
<div class="sourceCode" id="cb1579"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">central_data2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  </span>
<span>  <span class="co"># グループ化された流行曲線</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>        mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>          x <span class="op">=</span> <span class="va">date_onset</span>,</span>
<span>          group <span class="op">=</span> <span class="va">age_cat</span>,</span>
<span>          fill <span class="op">=</span> <span class="va">age_cat</span><span class="op">)</span>,  <span class="co"># aes() 内の引数はグループされる</span></span>
<span>        color <span class="op">=</span> <span class="st">"black"</span>,    <span class="co"># aes() 外の引数は全データに適用される</span></span>
<span>        </span>
<span>        <span class="co"># ビン分割</span></span>
<span>        breaks <span class="op">=</span> <span class="va">weekly_breaks_central</span>, <span class="co"># 以前のコードで定義済み （ggplot セクション参照）</span></span>
<span>        </span>
<span>        closed <span class="op">=</span> <span class="st">"left"</span>, <span class="co"># 分割の開始から症例数をカウントする</span></span>
<span>        <span class="op">)</span><span class="op">+</span>    <span class="co"># 以前のコードで定義済み （ggplot セクション参照）</span></span>
<span>                     </span>
<span>  <span class="co"># x軸のラベル</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    expand            <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,         <span class="co"># X軸の前後の余分なスペースを削除</span></span>
<span>    date_breaks       <span class="op">=</span> <span class="st">"2 months"</span>,     <span class="co"># データを2月ごとに表示</span></span>
<span>    date_minor_breaks <span class="op">=</span> <span class="st">"1 month"</span>,      <span class="co"># 縦罫線を1月ごとに表示</span></span>
<span>    date_labels       <span class="op">=</span> <span class="st">"%b\n'%y"</span><span class="op">)</span><span class="op">+</span>     <span class="co"># 日付ラベルのフォーマット</span></span>
<span>  </span>
<span>  <span class="co"># y軸のラベル</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>  <span class="co"># y軸の前後の余分なスペースを削除</span></span>
<span>  </span>
<span>  <span class="co"># テーマの指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>                                           <span class="co"># 背景を簡潔なものに指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"italic"</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, <span class="co"># 脚注をイタリック体にして左に幅寄せ</span></span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">+</span>               </span>
<span>  </span>
<span>  <span class="co"># ファセットの作成</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="va">facet</span><span class="op">~</span><span class="va">.</span> ,                            <span class="co"># それぞれのプロットに一つのファセットを指定</span></span>
<span>             ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">+</span>            </span>
<span></span>
<span>  <span class="co"># labels</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title    <span class="op">=</span> <span class="st">"Weekly incidence of cases, by age category"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Subtitle"</span>,</span>
<span>       fill     <span class="op">=</span> <span class="st">"Age category"</span>,                                      <span class="co"># 凡例のタイトル</span></span>
<span>       x        <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,</span>
<span>       y        <span class="op">=</span> <span class="st">"Weekly incident cases reported"</span>,</span>
<span>       caption  <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"n = {nrow(central_data)} from Central Hospital; Case onsets range from {format(min(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')} to {format(max(central_data$date_onset, na.rm=T), format = '%a %d %b %Y')}\n{nrow(central_data %&gt;% filter(is.na(date_onset)))} cases missing date of onset and not shown"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1172-1.png" width="480"></div>
</div>
</div>
</div>
<div id="暫定データ" class="section level2" number="32.4">
<h2>
<span class="header-section-number">32.4</span> 暫定データ<a class="anchor" aria-label="anchor" href="#%E6%9A%AB%E5%AE%9A%E3%83%87%E3%83%BC%E3%82%BF"><i class="fas fa-link"></i></a>
</h2>
<p>流行曲線で示される最新のデータは、多くの場合、暫定的な値であり、報告遅れのために後から症例数が追加される可能性があることを明示した方が良いでしょう。これは、直近の日数分を垂直線や長方形で囲むことで行うことができます。ここでは、2 つの方法を紹介します。</p>
<ol style="list-style-type: decimal">
<li>
<p><code><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate()</a></code> の使用：</p>
<ul>
<li>線の場合は <code>annotate(geom = "segment")</code> を使用します。 <code>x</code>、 <code>xend</code>、 <code>y</code>、 <code>yend</code> を指定し、サイズ、線の種類(<code>lty</code>）、色を調整します。<br>
</li>
<li>長方形の場合は <code>annotate(geom = "rect")</code> を使用します。 xmin/xmax/ymin/ymax を指定し、色とアルファ値を調整します。</li>
</ul>
</li>
<li><p>データを暫定的なステータスでグループ化し、それらのビンを異なる色で表示します。</p></li>
</ol>
<p><span style="color: orange;"><u><strong>注意</strong></u><strong>：</strong>長方形を作成するために <code><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_rect()</a></code> を試すかも知れませんが、ラインリストの場合は上手くいきません。この関数は、各観測点・行に対して 1 つの長方形を重ねる関数です！非常に低いアルファ値（例えば 0.01）を使用するか、他の方法を用いてください。</span></p>
<div id="annotate-の使用" class="section level3 unnumbered">
<h3>
<code>annotate()</code> の使用<a class="anchor" aria-label="anchor" href="#annotate-%E3%81%AE%E4%BD%BF%E7%94%A8"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p><code>annotate(geom = "rect")</code> 内で、 <code>xmin</code> と <code>xmax</code> に日付型の引数を指定する必要があります。</p></li>
<li><p>これらのデータは週単位のビンに集約されており、最後のビンは最後のデータポイントの次の月曜日まで伸びているので、影がかったエリアは4週間をカバーしているように見えるかもしれないことに注意してください。</p></li>
<li><p><code><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate()</a></code> の例は <a href="https://ggplot2.tidyverse.org/reference/annotate.html">こちら</a> を参考にしてください。</p></li>
</ul>
<div class="sourceCode" id="cb1580"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  </span>
<span>  <span class="co"># ヒストグラム</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span>,</span>
<span>    </span>
<span>    breaks <span class="op">=</span> <span class="va">weekly_breaks_central</span>,   <span class="co"># 以前のコードで定義済み</span></span>
<span>    </span>
<span>    closed <span class="op">=</span> <span class="st">"left"</span>, <span class="co"># 分割の開始から症例数をカウントする</span></span>
<span>    </span>
<span>    color <span class="op">=</span> <span class="st">"darkblue"</span>,</span>
<span>    </span>
<span>    fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="co"># scales</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,                   <span class="co"># X軸の前後の余分なスペースを削除</span></span>
<span>    date_breaks <span class="op">=</span> <span class="st">"1 month"</span>,           <span class="co"># 月の最初の日</span></span>
<span>    date_minor_breaks <span class="op">=</span> <span class="st">"1 month"</span>,     <span class="co"># 月の最初の日</span></span>
<span>    date_labels <span class="op">=</span> <span class="st">"%b\n'%y"</span><span class="op">)</span><span class="op">+</span>          <span class="co"># 日付ラベルのフォーマット</span></span>
<span>  </span>
<span>  <span class="co"># ラベルとテーマの指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Using annotate()\nRectangle and line showing that data from last 21-days are tentative"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Weekly case indicence"</span><span class="op">)</span><span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># 暫定データに対して半透明の影をかける</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span></span>
<span>    <span class="st">"rect"</span>,</span>
<span>    xmin  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">-</span> <span class="fl">21</span><span class="op">)</span>, <span class="co"># 日付型である必要があることに注意</span></span>
<span>    xmax  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="cn">Inf</span><span class="op">)</span>,                                          <span class="co"># 日付型である必要があることに注意</span></span>
<span>    ymin  <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    ymax  <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.2</span>,          <span class="co"># annotate()では alpha 値で直感的に簡単に透明度を変えられる</span></span>
<span>    fill  <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># 黑の縦線を追加する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span></span>
<span>    <span class="st">"segment"</span>,</span>
<span>    x     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">-</span> <span class="fl">21</span>, <span class="co"># 最終日の21日前</span></span>
<span>    xend  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">-</span> <span class="fl">21</span>, </span>
<span>    y     <span class="op">=</span> <span class="fl">0</span>,         <span class="co"># 線がy = 0 の場所から始まるように指定</span></span>
<span>    yend  <span class="op">=</span> <span class="cn">Inf</span>,       <span class="co"># 線が一番上まで続くように指定</span></span>
<span>    size  <span class="op">=</span> <span class="fl">2</span>,         <span class="co"># 線の太さを指定</span></span>
<span>    color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>    lty   <span class="op">=</span> <span class="st">"solid"</span><span class="op">)</span><span class="op">+</span>   <span class="co"># 線の種類 （例； "solid", "dashed"）</span></span>
<span></span>
<span>  <span class="co"># 長方形の中に文字を追加</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span></span>
<span>    <span class="st">"text"</span>,</span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">-</span> <span class="fl">15</span>,</span>
<span>    y <span class="op">=</span> <span class="fl">15</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"Subject to reporting delays"</span>,</span>
<span>    angle <span class="op">=</span> <span class="fl">90</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1173-1.png" width="672"></div>
<p>黒い縦線の追加は以下のコードでも可能ですが、以下のように <code><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline()</a></code> を使うと、高さは調整できなくなります。</p>
<div class="sourceCode" id="cb1581"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">$</span><span class="va">date_onset</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">-</span> <span class="fl">21</span>,</span>
<span>           size <span class="op">=</span> <span class="fl">2</span>,</span>
<span>           color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="ビンの色を変える" class="section level3 unnumbered">
<h3>ビンの色を変える<a class="anchor" aria-label="anchor" href="#%E3%83%93%E3%83%B3%E3%81%AE%E8%89%B2%E3%82%92%E5%A4%89%E3%81%88%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p>別の方法として、暫定データが反映されたビン自体の色や表示を調整することもできます。データ前処理の段階で新しい列を作り、作成した新しい列を使ってデータをグループ化し、暫定データの <code>aes(fill = )</code> を他の棒グラフと異なる色やアルファ値にすることができます。</p>
<div class="sourceCode" id="cb1582"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 列の追加</span></span>
<span><span class="co">############</span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">central_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>tentative <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">date_onset</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">date_onset</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="op">-</span> <span class="fl">7</span> <span class="op">~</span> <span class="st">"Tentative"</span>, <span class="co"># 直近7日分の データは暫定である</span></span>
<span>    <span class="cn">TRUE</span>                                       <span class="op">~</span> <span class="st">"Reliable"</span><span class="op">)</span><span class="op">)</span> <span class="co"># それ以外は 暫定ではない</span></span>
<span></span>
<span><span class="co"># プロット</span></span>
<span><span class="co">######</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">plot_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span>, fill <span class="op">=</span> <span class="va">tentative</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  </span>
<span>  <span class="co"># ヒストグラム</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="va">weekly_breaks_central</span>,   <span class="co"># 以前のコードで定義済み</span></span>
<span>    closed <span class="op">=</span> <span class="st">"left"</span>, <span class="co"># 分割の開始から症例数をカウントする</span></span>
<span>    color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="co"># scales</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lightblue"</span>, <span class="st">"grey"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,                   <span class="co"># X軸の前後の余分なスペースを削除</span></span>
<span>    date_breaks <span class="op">=</span> <span class="st">"3 weeks"</span>,           <span class="co"># データを3週ごとに表示</span></span>
<span>    date_minor_breaks <span class="op">=</span> <span class="st">"week"</span>,        <span class="co"># 縦罫線を1週ごとに表示</span></span>
<span>    date_labels <span class="op">=</span> <span class="st">"%d\n%b\n'%y"</span><span class="op">)</span><span class="op">+</span>      <span class="co"># 日付ラベルのフォーマット</span></span>
<span>  </span>
<span>  <span class="co"># ラベルとテーマの指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Show days that are tentative reporting"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>                 <span class="co"># 凡例のタイトルを削除</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1175-1.png" width="672"></div>
</div>
</div>
<div id="複数の日付ラベル" class="section level2" number="32.5">
<h2>
<span class="header-section-number">32.5</span> 複数の日付ラベル<a class="anchor" aria-label="anchor" href="#%E8%A4%87%E6%95%B0%E3%81%AE%E6%97%A5%E4%BB%98%E3%83%A9%E3%83%99%E3%83%AB"><i class="fas fa-link"></i></a>
</h2>
<p>月や年など複数レベルの日付ラベルを、下位のラベルと重複することなく表示したい場合は、以下の方法のいずれかを試してみて下さい。</p>
<p><code>date_labels</code> や <code>labels</code> の引数で、各ラベルの一部を下の行に配置するために <code>\n</code> 使うことができることも可能です。しかし、以下のコードを使うと、年や月を下の行に、かつ一度のみ表示することが可能です。</p>
<p>まず、最も簡単な方法は、<strong>scales</strong> パッケージの関数 <code>label_date_short()</code> を、<code><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date()</a></code> 内の <code>labels =</code> 引数に使用することです（注意：以下の例ように空の括弧 () を含めることを忘れないようにしてください）。 <code>label_date_short()</code> は、効率的な日付ラベルを自動的に作成します（詳しくは <a href="https://scales.r-lib.org/reference/label_date.html">こちら</a> のウェブサイトをご覧ください）。この関数のもう一つの特長は、データが日、週、月、年と時間と共に拡大していくのに応じて、ラベルが自動的に調整されることです。</p>
<div class="sourceCode" id="cb1583"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">central_data</span><span class="op">)</span> <span class="op">+</span> </span>
<span></span>
<span>  <span class="co"># histogram</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span>,</span>
<span>    breaks <span class="op">=</span> <span class="va">weekly_breaks_central</span>,   <span class="co"># 以前のコードで定義済み （ggplot セクション参照）</span></span>
<span>    closed <span class="op">=</span> <span class="st">"left"</span>,                  <span class="co"># 分割の開始から症例数をカウントする</span></span>
<span>    color <span class="op">=</span> <span class="st">"darkblue"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="co"># y-axis scale as before </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span></span>
<span>  <span class="co"># x-axis scale sets efficient date labels</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,                      <span class="co"># X軸の前後の余分なスペースを削除</span></span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_date.html">label_date_short</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="co"># 自動的に日付ラベルを生成</span></span>
<span></span>
<span>  <span class="co"># labels and theme</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Using label_date_short()\nTo make automatic and efficient date labels"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Week of symptom onset"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Weekly case indicence"</span><span class="op">)</span><span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1176-1.png" width="672"></div>
<p>もう一つの方法は、以下のようにファセット化を行うことです。</p>
<ul>
<li><p>症例数は、外観上の理由から週単位で集計されています。詳細は、本章の「集計データ」のセクションを参照して下さい。</p></li>
<li><p>ヒストグラムの代わりに <code><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_area()</a></code> が使われていますが、これは、以下のファセット化のアプローチがヒストグラムではうまく機能しないためです。</p></li>
</ul>
<p><strong>週別にデータをカウント</strong></p>
<div class="sourceCode" id="cb1584"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 週別にデータをカウントしたデータセットを作成</span></span>
<span><span class="co">#######################################</span></span>
<span><span class="va">central_weekly</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="st">"Central Hospital"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>   <span class="co"># フィルター</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>week <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">date_onset</span>, unit <span class="op">=</span> <span class="st">"weeks"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                              <span class="co"># 週別にカウント</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                            <span class="co"># 発症日不明症例を除外</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/complete.html">complete</a></span><span class="op">(</span>                                    <span class="co"># 症例が一例もなかった週を0で埋める</span></span>
<span>    week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html">seq.Date</a></span><span class="op">(</span></span>
<span>      from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span>,   </span>
<span>      to   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span>,</span>
<span>      by   <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span>,</span>
<span>    fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>                        <span class="co"># NAを0に変換</span></span></code></pre></div>
<p><strong>グラフの作成</strong></p>
<div class="sourceCode" id="cb1585"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 軸タイトルの年に対して枠線なしのグラフの作成</span></span>
<span><span class="co">#################################</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">central_weekly</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>              <span class="co"># xとyを全プロットに対して指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span>,              <span class="co"># カウントデータを用いて線グラフを作成</span></span>
<span>            color <span class="op">=</span> <span class="st">"#69b3a2"</span><span class="op">)</span> <span class="op">+</span>            <span class="co"># 線グラフの色</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">1</span>, color<span class="op">=</span><span class="st">"#69b3a2"</span><span class="op">)</span> <span class="op">+</span>     <span class="co"># 週ごとに点を作成</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_area</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#69b3a2"</span>,               <span class="co"># 線グラフの下のエリアを塗りつぶす</span></span>
<span>            alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span><span class="op">+</span>                   <span class="co"># 塗りつぶしの透明度の指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span>date_labels<span class="op">=</span><span class="st">"%b"</span>,            <span class="co"># 日付ラベルのフォーマット（月名を示す）</span></span>
<span>               date_breaks<span class="op">=</span><span class="st">"month"</span>,         <span class="co"># 日付ラベルを月ごとで分割</span></span>
<span>               expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>             <span class="co"># X軸の前後の余分なスペースを削除</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    expand  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                      <span class="co"># y軸の前後の余分なスペースを削除</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="op">~</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span>,        <span class="co"># （日付列の）年でファセット</span></span>
<span>             space<span class="op">=</span><span class="st">"free_x"</span>,                </span>
<span>             scales<span class="op">=</span><span class="st">"free_x"</span>,               <span class="co"># x軸をデータの範囲で調整（ファセット間で固定しない）</span></span>
<span>             switch<span class="op">=</span><span class="st">"x"</span><span class="op">)</span> <span class="op">+</span>                  <span class="co"># ファセットのラベルを下に持ってくる</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>strip.placement <span class="op">=</span> <span class="st">"outside"</span>,                  <span class="co"># ファセットのラベルの場所</span></span>
<span>          strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,         <span class="co"># ファセットの背景の塗りつぶしをなくす</span></span>
<span>          panel.grid.minor.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,          </span>
<span>          panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,             <span class="co"># ファセットの境界線をなくす</span></span>
<span>          panel.spacing<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">0</span>,<span class="st">"cm"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>                <span class="co"># ファセット間のスペースをなくす</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Nested year labels - points, shaded, no label border"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1178-1.png" width="672"></div>
<p>上記のファセット化の方法は、stackoverflow.com の <a href="https://stackoverflow.com/questions/44616530/axis-labels-on-two-lines-with-nested-x-variables-year-below-months">こちら</a> と <a href="https://stackoverflow.com/questions/44616530/axis-labels-on-two-lines-with-nested-x-variables-year-below-months">こちら</a> の投稿を参考に作成されました。</p>
<!-- ======================================================= -->
</div>
<div id="軸グラフ" class="section level2" number="32.6">
<h2>
<span class="header-section-number">32.6</span> 2軸グラフ<a class="anchor" aria-label="anchor" href="#%E8%BB%B8%E3%82%B0%E3%83%A9%E3%83%95"><i class="fas fa-link"></i></a>
</h2>
<p>データ可視化のコミュニティー内では、2 軸グラフの有効性について激しい議論が交わされていますが、流行曲線やそれに類するグラフで、2 軸目に割合を重ねたものを見たいと思う疫学専門家は依然として多くいます。これについては <a href="ggplot-tips.html#ggplot-tips">ggplot のヒント</a> の章で詳しく説明していますが、<strong>cowplot</strong> メソッドを使った一例を以下に示します。</p>
<ul>
<li>2 つの異なるプロットを作成し、<strong>cowplot</strong> パッケージで結合します。<br>
</li>
<li>2 つのプロットはまったく同じ x 軸（範囲を設定する）を持つ必要があり、そうでないとデータとラベルがずれてしまいます。<br>
</li>
<li>それぞれ <code>theme_cowplot()</code> を使用し、一方は y 軸をプロットの右側に移動します。</li>
</ul>
<div class="sourceCode" id="cb1586"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># パッケージの読み込み</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">cowplot</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 最初の流行曲線を作成</span></span>
<span><span class="co">#######################################</span></span>
<span><span class="va">plot_cases</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>  <span class="co"># 週別の症例をプロット</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># ヒストグラムの作成 </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    </span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="co"># 最初の症例の前の月曜から、最後の症例の次の月曜までが含まれる週ごとのビン分割を指定</span></span>
<span>    breaks <span class="op">=</span> <span class="va">weekly_breaks_all</span><span class="op">)</span><span class="op">+</span>  <span class="co"># 以前に定義した週ごとの日付のベクトル</span></span>
<span>        </span>
<span>  <span class="co"># もう一つのグラフとの整合性を保つための最初と最後の日付の指定</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">weekly_breaks_all</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">weekly_breaks_all</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>  <span class="co"># 最初と最後の日付の指定</span></span>
<span>  </span>
<span>  <span class="co"># ラベル</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>      y <span class="op">=</span> <span class="st">"Daily cases"</span>,</span>
<span>      x <span class="op">=</span> <span class="st">"Date of symptom onset"</span></span>
<span>    <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_cowplot</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># 2つ目のグラフ（週ごとの死亡割合）の作成</span></span>
<span><span class="co">###########################################</span></span>
<span><span class="va">plot_deaths</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                        <span class="co"># ラインリスト</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span>week <span class="op">=</span> <span class="fu">floor_date</span><span class="op">(</span><span class="va">date_onset</span>, <span class="st">"week"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="co"># week 列を作成</span></span>
<span>  </span>
<span>  <span class="co"># 週ごとの死亡割合を集計</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>n_cases <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            died <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">==</span> <span class="st">"Death"</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,</span>
<span>            pct_died <span class="op">=</span> <span class="fl">100</span><span class="op">*</span><span class="va">died</span><span class="op">/</span><span class="va">n_cases</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>  <span class="co"># プロット</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># 週ごとの死亡割合の線グラフ</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>                                <span class="co"># 週ごとの死亡割合の線グラフの作成</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">pct_died</span><span class="op">)</span>,  <span class="co"># y軸に pct_died 列を指定</span></span>
<span>    stat <span class="op">=</span> <span class="st">"identity"</span>,                      <span class="co"># 行番号（デフォルト）ではなく、pct_death 列をy軸に指定</span></span>
<span>    size <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co"># 最初のグラフと同じx軸の範囲にする</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span></span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">weekly_breaks_all</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">weekly_breaks_all</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>  <span class="co"># 最初と最後の日付の指定</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># y軸の調整</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>                <span class="co"># y軸の調整</span></span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span>, <span class="fl">10</span><span class="op">)</span>,         <span class="co"># 軸の分割をパーセント用に設定する</span></span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span>,              <span class="co"># 軸の範囲をパーセント用に設定する</span></span>
<span>    position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span><span class="op">+</span>             <span class="co"># 軸を右に持ってくる</span></span>
<span>  </span>
<span>  <span class="co"># x軸のラベルを削除し、y軸のラベルを指定する</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">""</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Percent deceased"</span><span class="op">)</span><span class="op">+</span>      <span class="co"># %軸のラベル</span></span>
<span>  </span>
<span>  <span class="fu">theme_cowplot</span><span class="op">(</span><span class="op">)</span>                   <span class="co"># 2つのプロットを良い感じに重ねる</span></span></code></pre></div>
<p>次に <strong>cowplot</strong> を使って 2 つのプロットを重ね合わせます。x 軸を合わせること、y 軸のサイド、<code>theme_cowplot()</code> の使い方に注目してください。</p>
<div class="sourceCode" id="cb1587"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aligned_plots</span> <span class="op">&lt;-</span> <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/align_plots.html">align_plots</a></span><span class="op">(</span><span class="va">plot_cases</span>, <span class="va">plot_deaths</span>, align<span class="op">=</span><span class="st">"hv"</span>, axis<span class="op">=</span><span class="st">"tblr"</span><span class="op">)</span></span>
<span><span class="fu">ggdraw</span><span class="op">(</span><span class="va">aligned_plots</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu">draw_plot</span><span class="op">(</span><span class="va">aligned_plots</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1180-1.png" width="672"></div>
</div>
<div id="累積症例数" class="section level2" number="32.7">
<h2>
<span class="header-section-number">32.7</span> 累積症例数<a class="anchor" aria-label="anchor" href="#%E7%B4%AF%E7%A9%8D%E7%97%87%E4%BE%8B%E6%95%B0"><i class="fas fa-link"></i></a>
</h2>
<p>注意： <strong>incidence2</strong> を使用する場合、簡単な関数で累積症例数を生成する方法のセクションを参照してください。このセクションでは、累積症例数を計算し、<code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> でプロットする方法について説明します。</p>
<p>症例のラインリストから始める場合、R <strong>base</strong> の <code><a href="https://rdrr.io/r/base/cumsum.html">cumsum()</a></code> を使用して\、アウトブレイクにおける日ごとの累積症例数の列を新たに作成します。</p>
<div class="sourceCode" id="cb1588"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cumulative_case_counts</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                <span class="co"># 日ごとの症例数（"n"列）</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>                         </span>
<span>    cumulative_cases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>       <span class="co"># 日ごとの累積症例数列</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>最初の 10 行は以下のようになります。</p>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-9d72e1a664cbd5780c2f" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-9d72e1a664cbd5780c2f">{"x":{"filter":"none","vertical":false,"data":[["2014-04-07","2014-04-15","2014-04-21","2014-04-25","2014-04-26","2014-04-27","2014-05-01","2014-05-03","2014-05-04","2014-05-05"],[1,1,2,1,1,1,2,1,1,1],[1,2,4,5,6,7,9,10,11,12]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>date_onset<\/th>\n      <th>n<\/th>\n      <th>cumulative_cases<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,2]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p>この累積症例数の列は、<code><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line()</a></code> を使用して、<code>date_onset</code> 列に対してプロットすることができます。</p>
<div class="sourceCode" id="cb1589"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_cumulative</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">cumulative_case_counts</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span>, y <span class="op">=</span> <span class="va">cumulative_cases</span><span class="op">)</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_cumulative</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1183-1.png" width="672"></div>
<p>また、上記や <a href="ggplot-basics.html#ggplot-basics">ggplot の基礎</a> の章で説明されている <strong>cowplot</strong> を使って、2 軸で流行曲線に重ねることもできます。</p>
<div class="sourceCode" id="cb1590"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#パッケージの読み込み</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">cowplot</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 最初のグラフである流行曲線を作成</span></span>
<span><span class="va">plot_cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>          </span>
<span>    data <span class="op">=</span> <span class="va">linelist</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span>,</span>
<span>    binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="st">"Daily cases"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Date of symptom onset"</span></span>
<span>  <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_cowplot</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2つ目のグラフである累積症例数の線グラフを作成</span></span>
<span><span class="va">plot_cumulative</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">cumulative_case_counts</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span>, y <span class="op">=</span> <span class="va">cumulative_cases</span><span class="op">)</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">""</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Cumulative cases"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_cowplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    axis.line.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>次に <strong>cowplot</strong> を使って 2 つのプロットを重ね合わせます。x 軸を合わせること、y 軸のサイド、<code>theme_cowplot()</code> の使い方に注意してください。</p>
<div class="sourceCode" id="cb1591"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aligned_plots</span> <span class="op">&lt;-</span> <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/align_plots.html">align_plots</a></span><span class="op">(</span><span class="va">plot_cases</span>, <span class="va">plot_cumulative</span>, align<span class="op">=</span><span class="st">"hv"</span>, axis<span class="op">=</span><span class="st">"tblr"</span><span class="op">)</span></span>
<span><span class="fu">ggdraw</span><span class="op">(</span><span class="va">aligned_plots</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu">draw_plot</span><span class="op">(</span><span class="va">aligned_plots</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-1185-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="参考資料-23" class="section level2" number="32.8">
<h2>
<span class="header-section-number">32.8</span> 参考資料<a class="anchor" aria-label="anchor" href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99-23"><i class="fas fa-link"></i></a>
</h2>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="ggplot-tips.html"><span class="header-section-number">31</span> ggplotのヒント</a></div>
<div class="next"><a href="age-pyramid.html"><span class="header-section-number">33</span> 人口ピラミッドとリッカート尺度</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#epicurves"><span class="header-section-number">32</span> 流行曲線（エピカーブ）</a></li>
<li>
<a class="nav-link" href="#%E6%BA%96%E5%82%99-23"><span class="header-section-number">32.1</span> 準備</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF-16">パッケージの読み込み</a></li>
<li><a class="nav-link" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88-13"><span class="header-section-number">32.1.1</span> データのインポート</a></li>
<li><a class="nav-link" href="#%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF%E3%81%AE%E8%A8%AD%E5%AE%9A">パラメータの設定</a></li>
<li><a class="nav-link" href="#%E6%97%A5%E4%BB%98%E3%81%AE%E7%A2%BA%E8%AA%8D">日付の確認</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#incidence2-%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8-%E3%81%AB%E3%82%88%E3%82%8B%E6%B5%81%E8%A1%8C%E6%9B%B2%E7%B7%9A"><span class="header-section-number">32.2</span> incidence2 パッケージ による流行曲線</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E7%B0%A1%E5%8D%98%E3%81%AA%E4%BE%8B">簡単な例</a></li>
<li><a class="nav-link" href="#%E7%97%87%E4%BE%8B%E9%9B%86%E8%A8%88%E3%81%AE%E6%99%82%E9%96%93%E5%8D%98%E4%BD%8D%E3%81%AE%E5%A4%89%E6%9B%B4">症例集計の時間単位の変更</a></li>
<li><a class="nav-link" href="#%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E5%8C%96-1">グループ化</a></li>
<li><a class="nav-link" href="#%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%95%E3%82%8C%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF">フィルタリングされたデータ</a></li>
<li><a class="nav-link" href="#%E9%9B%86%E8%A8%88%E5%80%A4">集計値</a></li>
<li><a class="nav-link" href="#%E3%83%95%E3%82%A1%E3%82%BB%E3%83%83%E3%83%88%E5%88%86%E5%89%B2">ファセット・分割</a></li>
<li><a class="nav-link" href="#plot-%E3%81%AB%E3%82%88%E3%82%8B%E8%AA%BF%E6%95%B4">plot() による調整</a></li>
<li><a class="nav-link" href="#ggplot2-%E3%81%AB%E3%82%88%E3%82%8B%E8%AA%BF%E6%95%B4">ggplot2 による調整</a></li>
<li><a class="nav-link" href="#%E8%89%B2%E3%81%AE%E5%A4%89%E6%9B%B4">色の変更</a></li>
<li><a class="nav-link" href="#%E3%83%AC%E3%83%99%E3%83%AB%E9%A0%86%E5%BA%8F%E3%81%AE%E8%AA%BF%E6%95%B4">レベル順序の調整</a></li>
<li><a class="nav-link" href="#%E7%B8%A6%E7%BD%AB%E7%B7%9A">縦罫線</a></li>
<li><a class="nav-link" href="#%E7%B4%AF%E7%A9%8D%E7%BD%B9%E6%82%A3%E7%8E%87">累積罹患率</a></li>
<li><a class="nav-link" href="#%E7%A7%BB%E5%8B%95%E5%B9%B3%E5%9D%87">移動平均</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#ggplot2-%E3%82%92%E7%94%A8%E3%81%84%E3%81%9F%E6%B5%81%E8%A1%8C%E6%9B%B2%E7%B7%9A"><span class="header-section-number">32.3</span> ggplot2 を用いた流行曲線</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E7%97%87%E4%BE%8B%E3%81%AE%E3%83%93%E3%83%B3%E3%81%AE%E6%8C%87%E5%AE%9A">症例のビンの指定</a></li>
<li><a class="nav-link" href="#%E9%80%B1%E5%88%A5%E6%B5%81%E8%A1%8C%E6%9B%B2%E7%B7%9A%E3%81%AE%E4%BE%8B">週別流行曲線の例</a></li>
<li><a class="nav-link" href="#%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E5%8C%96%E5%80%A4%E3%81%AB%E3%82%88%E3%82%8B%E8%89%B2%E5%88%86%E3%81%91">グループ化・値による色分け</a></li>
<li><a class="nav-link" href="#%E8%89%B2%E3%81%AE%E8%AA%BF%E6%95%B4">色の調整</a></li>
<li><a class="nav-link" href="#%E3%83%AC%E3%83%99%E3%83%AB%E9%A0%86%E3%81%AE%E8%AA%BF%E6%95%B4">レベル順の調整</a></li>
<li><a class="nav-link" href="#%E5%87%A1%E4%BE%8B%E3%81%AE%E8%AA%BF%E6%95%B4">凡例の調整</a></li>
<li><a class="nav-link" href="#%E6%A3%92%E3%82%B0%E3%83%A9%E3%83%95%E3%81%AE%E6%A8%AA%E4%B8%A6%E3%81%B3%E8%A1%A8%E7%A4%BA">棒グラフの横並び表示</a></li>
<li><a class="nav-link" href="#%E8%BB%B8%E3%81%AE%E7%AF%84%E5%9B%B2">軸の範囲</a></li>
<li><a class="nav-link" href="#%E6%97%A5%E4%BB%98%E8%BB%B8%E3%81%AE%E3%83%A9%E3%83%99%E3%83%AB%E3%81%A8%E7%BD%AB%E7%B7%9A">日付軸のラベルと罫線</a></li>
<li><a class="nav-link" href="#%E9%9B%86%E8%A8%88%E3%83%87%E3%83%BC%E3%82%BF">集計データ</a></li>
<li><a class="nav-link" href="#%E7%A7%BB%E5%8B%95%E5%B9%B3%E5%9D%87-1">移動平均</a></li>
<li><a class="nav-link" href="#%E3%83%95%E3%82%A1%E3%82%BB%E3%83%83%E3%83%88%E5%8C%96%E3%83%97%E3%83%AD%E3%83%83%E3%83%88%E3%81%AE%E5%B0%8F%E5%88%86%E5%89%B2">ファセット化・プロットの小分割</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E6%9A%AB%E5%AE%9A%E3%83%87%E3%83%BC%E3%82%BF"><span class="header-section-number">32.4</span> 暫定データ</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#annotate-%E3%81%AE%E4%BD%BF%E7%94%A8">annotate() の使用</a></li>
<li><a class="nav-link" href="#%E3%83%93%E3%83%B3%E3%81%AE%E8%89%B2%E3%82%92%E5%A4%89%E3%81%88%E3%82%8B">ビンの色を変える</a></li>
</ul>
</li>
<li><a class="nav-link" href="#%E8%A4%87%E6%95%B0%E3%81%AE%E6%97%A5%E4%BB%98%E3%83%A9%E3%83%99%E3%83%AB"><span class="header-section-number">32.5</span> 複数の日付ラベル</a></li>
<li><a class="nav-link" href="#%E8%BB%B8%E3%82%B0%E3%83%A9%E3%83%95"><span class="header-section-number">32.6</span> 2軸グラフ</a></li>
<li><a class="nav-link" href="#%E7%B4%AF%E7%A9%8D%E7%97%87%E4%BE%8B%E6%95%B0"><span class="header-section-number">32.7</span> 累積症例数</a></li>
<li><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99-23"><span class="header-section-number">32.8</span> 参考資料</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>疫学のための R ハンドブック</strong>" was written by the handbook team. It was last built on 2023-01-12.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
