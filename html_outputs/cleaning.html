<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>8 データクリーニングと主要関数 | 疫学のための R ハンドブック</title>
<meta name="author" content="the handbook team">
<meta name="description" content="この章では、データクリーニング（データの前処理）の一般的な手順を示し、R を使ったデータ管理に不可欠な機能について説明します。 例として、未加工のラインリスト（症例データ）を使用し、ラインリストのインポートを始め、データクリーニングの手順を段階的に解説していきます。上の図のような処理は、R コードでは「パイプ（“pipe”）」チェーンとして行われ、「パイプ」演算子...">
<meta name="generator" content="bookdown 0.29 with bs4_book()">
<meta property="og:title" content="8 データクリーニングと主要関数 | 疫学のための R ハンドブック">
<meta property="og:type" content="book">
<meta property="og:description" content="この章では、データクリーニング（データの前処理）の一般的な手順を示し、R を使ったデータ管理に不可欠な機能について説明します。 例として、未加工のラインリスト（症例データ）を使用し、ラインリストのインポートを始め、データクリーニングの手順を段階的に解説していきます。上の図のような処理は、R コードでは「パイプ（“pipe”）」チェーンとして行われ、「パイプ」演算子...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="8 データクリーニングと主要関数 | 疫学のための R ハンドブック">
<meta name="twitter:description" content="この章では、データクリーニング（データの前処理）の一般的な手順を示し、R を使ったデータ管理に不可欠な機能について説明します。 例として、未加工のラインリスト（症例データ）を使用し、ラインリストのインポートを始め、データクリーニングの手順を段階的に解説していきます。上の図のような処理は、R コードでは「パイプ（“pipe”）」チェーンとして行われ、「パイプ」演算子...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.0/transition.js"></script><script src="libs/bs3compat-0.4.0/tabs.js"></script><script src="libs/bs3compat-0.4.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.25/datatables.js"></script><link href="libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/tabwid-1.1.0/tabwid.css" rel="stylesheet">
<link href="libs/tabwid-1.1.0/scrool.css" rel="stylesheet">
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.9/grViz.js"></script><script src="libs/d3-4.5.0/d3.min.js"></script><script src="libs/sankey-1/sankey.js"></script><script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script><script src="libs/plotly-binding-4.10.0/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-2.5.1/plotly-latest.min.js"></script><link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="libs/vis-9.1.0/vis-network.min.js"></script><script src="libs/visNetwork-binding-2.1.0/visNetwork.js"></script><link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="libs/plotly-basic-2.5.1/plotly-basic-2.5.1.min.js"></script><script src="libs/plotly-cartesian-2.5.1/plotly-cartesian-2.5.1.min.js"></script><script src="libs/proj4js-2.3.15/proj4.js"></script><link href="libs/highcharts-9.3.1/css/motion.css" rel="stylesheet">
<script src="libs/highcharts-9.3.1/highcharts.js"></script><script src="libs/highcharts-9.3.1/highcharts-3d.js"></script><script src="libs/highcharts-9.3.1/highcharts-more.js"></script><script src="libs/highcharts-9.3.1/modules/stock.js"></script><script src="libs/highcharts-9.3.1/modules/map.js"></script><script src="libs/highcharts-9.3.1/modules/data.js"></script><script src="libs/highcharts-9.3.1/modules/exporting.js"></script><script src="libs/highcharts-9.3.1/modules/offline-exporting.js"></script><script src="libs/highcharts-9.3.1/modules/drilldown.js"></script><script src="libs/highcharts-9.3.1/modules/item-series.js"></script><script src="libs/highcharts-9.3.1/modules/overlapping-datalabels.js"></script><script src="libs/highcharts-9.3.1/modules/annotations.js"></script><script src="libs/highcharts-9.3.1/modules/export-data.js"></script><script src="libs/highcharts-9.3.1/modules/funnel.js"></script><script src="libs/highcharts-9.3.1/modules/heatmap.js"></script><script src="libs/highcharts-9.3.1/modules/treemap.js"></script><script src="libs/highcharts-9.3.1/modules/sankey.js"></script><script src="libs/highcharts-9.3.1/modules/dependency-wheel.js"></script><script src="libs/highcharts-9.3.1/modules/organization.js"></script><script src="libs/highcharts-9.3.1/modules/solid-gauge.js"></script><script src="libs/highcharts-9.3.1/modules/streamgraph.js"></script><script src="libs/highcharts-9.3.1/modules/sunburst.js"></script><script src="libs/highcharts-9.3.1/modules/vector.js"></script><script src="libs/highcharts-9.3.1/modules/wordcloud.js"></script><script src="libs/highcharts-9.3.1/modules/xrange.js"></script><script src="libs/highcharts-9.3.1/modules/tilemap.js"></script><script src="libs/highcharts-9.3.1/modules/venn.js"></script><script src="libs/highcharts-9.3.1/modules/gantt.js"></script><script src="libs/highcharts-9.3.1/modules/timeline.js"></script><script src="libs/highcharts-9.3.1/modules/parallel-coordinates.js"></script><script src="libs/highcharts-9.3.1/modules/bullet.js"></script><script src="libs/highcharts-9.3.1/modules/coloraxis.js"></script><script src="libs/highcharts-9.3.1/modules/dumbbell.js"></script><script src="libs/highcharts-9.3.1/modules/lollipop.js"></script><script src="libs/highcharts-9.3.1/modules/series-label.js"></script><script src="libs/highcharts-9.3.1/plugins/motion.js"></script><script src="libs/highcharts-9.3.1/custom/reset.js"></script><script src="libs/highcharts-9.3.1/modules/boost.js"></script><script src="libs/highchart-binding-0.9.4/highchart.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QXDW878QLX');
    </script><script type="text/javascript">
        // window.addEventListener("load", function() {
        //     document.getElementById('toc').firstChild.innerHTML = "章目次"; 
        // });
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementsByClassName("d-flex align-items-start justify-content-between")[0].children[0].children[0].innerHTML = "疫学のための R</br>ハンドブック";
            document.getElementById('toc').firstChild.innerHTML = "章目次"; 
            document.getElementById('main-nav').children[1].firstChild.innerHTML = "総目次";
            document.getElementById('search').setAttribute("placeholder", "検索");
        });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style_bs4.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">疫学のための R ハンドブック</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"></a></li>
<li class="book-part">本書について</li>
<li><a class="" href="editorial-style.html"><span class="header-section-number">1</span> 編集前記・技術注記</a></li>
<li><a class="" href="data-used.html"><span class="header-section-number">2</span> ハンドブックとデータのダウンロード</a></li>
<li class="book-part">基本編</li>
<li><a class="" href="basics.html"><span class="header-section-number">3</span> R の基礎</a></li>
<li><a class="" href="transition-to-R.html"><span class="header-section-number">4</span> Excel・Stata・SASとの比較</a></li>
<li><a class="" href="packages-suggested.html"><span class="header-section-number">5</span> 推奨パッケージ</a></li>
<li><a class="" href="r-projects.html"><span class="header-section-number">6</span> R プロジェクト</a></li>
<li><a class="" href="importing.html"><span class="header-section-number">7</span> データのインポート・エクスポート</a></li>
<li class="book-part">データマネジメント</li>
<li><a class="active" href="cleaning.html"><span class="header-section-number">8</span> データクリーニングと主要関数</a></li>
<li><a class="" href="dates.html"><span class="header-section-number">9</span> 日付型データ</a></li>
<li><a class="" href="characters-strings.html"><span class="header-section-number">10</span> 文字型・文字列型データ</a></li>
<li><a class="" href="factors.html"><span class="header-section-number">11</span> 因子（ファクタ）型データ</a></li>
<li><a class="" href="pivoting.html"><span class="header-section-number">12</span> データの縦横変換</a></li>
<li><a class="" href="grouping.html"><span class="header-section-number">13</span> データのグループ化</a></li>
<li><a class="" href="joining-matching.html"><span class="header-section-number">14</span> データの結合</a></li>
<li><a class="" href="deduplication.html"><span class="header-section-number">15</span> 重複データの排除</a></li>
<li><a class="" href="iteration.html"><span class="header-section-number">16</span> ループと反復処理・リストの操作</a></li>
<li class="book-part">データ分析</li>
<li><a class="" href="tables-descriptive.html"><span class="header-section-number">17</span> 記述統計表の作り方</a></li>
<li><a class="" href="stat-tests.html"><span class="header-section-number">18</span> 基本的な統計的検定</a></li>
<li><a class="" href="regression.html"><span class="header-section-number">19</span> 単変量と多変量回帰</a></li>
<li><a class="" href="missing-data.html"><span class="header-section-number">20</span> データの欠損</a></li>
<li><a class="" href="standardization.html"><span class="header-section-number">21</span> 標準化率</a></li>
<li><a class="" href="moving-average.html"><span class="header-section-number">22</span> 移動平均</a></li>
<li><a class="" href="time-series.html"><span class="header-section-number">23</span> 時系列分析とアウトブレイクの検出</a></li>
<li><a class="" href="epidemic-models.html"><span class="header-section-number">24</span> エピデミックモデリング</a></li>
<li><a class="" href="contact-tracing.html"><span class="header-section-number">25</span> 接触者の追跡</a></li>
<li><a class="" href="survey-analysis.html"><span class="header-section-number">26</span> 標本調査データ分析</a></li>
<li><a class="" href="survival-analysis.html"><span class="header-section-number">27</span> 生存時間解析</a></li>
<li><a class="" href="gis.html"><span class="header-section-number">28</span> GIS の基本</a></li>
<li class="book-part">データの可視化</li>
<li><a class="" href="tables-presentation.html"><span class="header-section-number">29</span> 見やすい表の作り方</a></li>
<li><a class="" href="ggplot-basics.html"><span class="header-section-number">30</span> ggplot の基本</a></li>
<li><a class="" href="ggplot-tips.html"><span class="header-section-number">31</span> ggplotのヒント</a></li>
<li><a class="" href="epicurves.html"><span class="header-section-number">32</span> 流行曲線（エピカーブ）</a></li>
<li><a class="" href="age-pyramid.html"><span class="header-section-number">33</span> 人口ピラミッドとリッカート尺度</a></li>
<li><a class="" href="heatmaps.html"><span class="header-section-number">34</span> ヒートマップ</a></li>
<li><a class="" href="diagrams.html"><span class="header-section-number">35</span> フローチャート・サンキー図・タイムライン</a></li>
<li><a class="" href="combination-analysis.html"><span class="header-section-number">36</span> 複数回答データの分析</a></li>
<li><a class="" href="transmission-chains.html"><span class="header-section-number">37</span> 感染連鎖</a></li>
<li><a class="" href="phylogenetic-trees.html"><span class="header-section-number">38</span> 系統樹</a></li>
<li><a class="" href="interactive-plots.html"><span class="header-section-number">39</span> 動的な図の作成</a></li>
<li class="book-part">レポートとダッシュボード</li>
<li><a class="" href="rmarkdown.html"><span class="header-section-number">40</span> R Markdown で作るレポート</a></li>
<li><a class="" href="reportfactory.html"><span class="header-section-number">41</span> ルーチンで作成するレポートの整理</a></li>
<li><a class="" href="flexdashboard.html"><span class="header-section-number">42</span> R Markdownで作るダッシュボード</a></li>
<li><a class="" href="shiny-basics.html"><span class="header-section-number">43</span> Shiny で作るダッシュボード</a></li>
<li class="book-part">その他</li>
<li><a class="" href="writing-functions.html"><span class="header-section-number">44</span> 関数の作成</a></li>
<li><a class="" href="directories.html"><span class="header-section-number">45</span> ディレクトリの操作</a></li>
<li><a class="" href="collaboration.html"><span class="header-section-number">46</span> Git と Github を使ったバージョン管理と共同作業</a></li>
<li><a class="" href="errors.html"><span class="header-section-number">47</span> よくあるエラー</a></li>
<li><a class="" href="help.html"><span class="header-section-number">48</span> ヘルプ</a></li>
<li><a class="" href="network-drives.html"><span class="header-section-number">49</span> ネットワークドライブで R を使用する場合</a></li>
<li><a class="" href="data-table.html"><span class="header-section-number">50</span> data.table パッケージを使用したデータ処理</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="cleaning" class="section level1" number="8">
<h1>
<span class="header-section-number">8</span> データクリーニングと主要関数<a class="anchor" aria-label="anchor" href="#cleaning"><i class="fas fa-link"></i></a>
</h1>
<div class="inline-figure"><img src="images/cleaning.png" width="265" height="10%" style="display: block; margin: auto;"></div>
<p>この章では、データクリーニング（データの前処理）の一般的な手順を示し、R を使ったデータ管理に不可欠な機能について説明します。</p>
<p>例として、未加工のラインリスト（症例データ）を使用し、ラインリストのインポートを始め、データクリーニングの手順を段階的に解説していきます。上の図のような処理は、R コードでは「パイプ（“pipe”）」チェーンとして行われ、「パイプ」演算子 <code>%&gt;%</code>によって、対象のデータセットをある操作から次の操作に渡すことができます。</p>
<div id="主要関数" class="section level3 unnumbered">
<h3>主要関数<a class="anchor" aria-label="anchor" href="#%E4%B8%BB%E8%A6%81%E9%96%A2%E6%95%B0"><i class="fas fa-link"></i></a>
</h3>
<p>このハンドブックでは、R パッケージの一つである <a href="https://www.tidyverse.org/"><strong>tidyverse</strong></a> 系関数を主に使用します。以下の表は、本章で使用する基本の R パッケージおよびパッケージに含まれる関数の一覧です。</p>
<p>関数の多くは、データ操作に関する課題を解決するための「動詞」関数を提供する R パッケージ <a href="https://dplyr.tidyverse.org/"><strong>dplyr</strong></a> に属しています（<strong>dplyr</strong> という名前は”data frame-<a href="https://www.thefreedictionary.com/plier#:~:text=also%20ply%C2%B7er%20(pl%C4%AB%E2%80%B2,holding%2C%20bending%2C%20or%20cutting.)%22">plier</a>” にちなんでいます）。<strong>dplyr</strong> パッケージは、<strong>ggplot2</strong>、<strong>tidyr</strong>、<strong>stringr</strong>、<strong>tibble</strong>、<strong>purrr</strong>、<strong>magrittr</strong>、<strong>forcats</strong> などのパッケージを含む R パッケージである <strong>tidyverse</strong> ファミリーの一部です。</p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="40%">
<col width="39%">
<col width="19%">
</colgroup>
<thead><tr class="header">
<th><strong>関数</strong></th>
<th>機能</th>
<th><strong>パッケージ</strong></th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>%&gt;%</code></td>
<td>ある関数から次の関数へデータを「パイプで渡す」</td>
<td><strong>magrittr</strong></td>
</tr>
<tr class="even">
<td><code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code></td>
<td>列の作成、変換、再定義</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="odd">
<td><code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code></td>
<td>列の保持、削除、選択、列名の変更</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="even">
<td><code><a href="https://dplyr.tidyverse.org/reference/rename.html">rename()</a></code></td>
<td>列名の変更</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="odd">
<td><code>clean_names()</code></td>
<td>列名の構文を標準化</td>
<td><strong>janitor</strong></td>
</tr>
<tr class="even">
<td>
<code><a href="https://rdrr.io/r/base/character.html">as.character()</a></code>, <code><a href="https://rdrr.io/r/base/numeric.html">as.numeric()</a></code>, <code><a href="https://rdrr.io/r/base/as.Date.html">as.Date()</a></code> 等</td>
<td>列のデータ型を変換</td>
<td>
<strong>base</strong> R</td>
</tr>
<tr class="odd">
<td><code><a href="https://dplyr.tidyverse.org/reference/across.html">across()</a></code></td>
<td>複数の列を一度に変換</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="even">
<td>
<strong>tidyselect</strong> 系関数</td>
<td>論理条件を使った列の選択</td>
<td><strong>tidyselect</strong></td>
</tr>
<tr class="odd">
<td><code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code></td>
<td>特定の行を選択</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="even">
<td><code><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct()</a></code></td>
<td>重複した行の削除</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="odd">
<td><code><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise()</a></code></td>
<td>各行の中の操作、または各行による操作</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="even">
<td><code><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row()</a></code></td>
<td>手動で行を追加</td>
<td><strong>tibble</strong></td>
</tr>
<tr class="odd">
<td><code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code></td>
<td>行の並べ替え</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="even">
<td><code><a href="https://dplyr.tidyverse.org/reference/recode.html">recode()</a></code></td>
<td>列の値を再定義</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="odd">
<td><code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code></td>
<td>複数の論理基準を使用し列値を再コーディング</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="even">
<td>
<code><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/na_if.html">na_if()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/coalesce.html">coalesce()</a></code>
</td>
<td>再コーティングのための専用関数</td>
<td><strong>tidyr</strong></td>
</tr>
<tr class="odd">
<td>
<code>age_categories()</code>, <code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code>
</td>
<td>数値列からカテゴリグループを作成</td>
<td>
<strong>epikit</strong>, <strong>base</strong> R</td>
</tr>
<tr class="even">
<td><code>clean_variable_spelling()</code></td>
<td>データ辞書を使用した値の再定義・処理</td>
<td><strong>linelist</strong></td>
</tr>
<tr class="odd">
<td><code><a href="https://rdrr.io/r/base/which.html">which()</a></code></td>
<td>論理的基準を適用し、インデックスを抽出</td>
<td>
<strong>base</strong> R</td>
</tr>
</tbody>
</table></div>
<p>これらの関数を Stata や SAS のコマンドと比較したい場合は、<a href="transition-to-R.html#transition-to-R">Excel・Stata・SASとの比較</a> の章を参照にしてください。</p>
<p>また、R パッケージの <strong>data.table</strong> では、<code>:=</code> のような演算子や角括弧 <code>[ ]</code> が頻繁に使用されており、別の形式のデータ管理フレームワークを目にすることがあるかもしれません。この手法と構文については、<a href="data-table.html#data-table">データテーブル</a> の章で簡単に説明しています。</p>
</div>
<div id="用語体系" class="section level3 unnumbered">
<h3>用語体系<a class="anchor" aria-label="anchor" href="#%E7%94%A8%E8%AA%9E%E4%BD%93%E7%B3%BB"><i class="fas fa-link"></i></a>
</h3>
<p>このハンドブックでは、一般的に「変数」や「観測値」の代わりに「列」や「行」を使用します。<a href="https://tidyr.tidyverse.org/articles/tidy-data.html">“tidy data”</a> の入門書で説明されているように、疫学統計データセットのほとんどは、行、列、値の構造で構成されています。</p>
<p>「変数」は、同じ基本属性について測定された値（年齢層、アウトカム、発症日など）を示しています。「観測値」は、同じ単位（人、場所、ラボのサンプルなど）で測定されたすべての値を示します。そのため、これらの値を明確に定義することは困難です。</p>
<p>“tidy” データセット（綺麗に整理されたデータセット）では、各列が変数、各行が観測値、そして各セルが 1 つの値となっています。しかし、この型に当てはまらないデータセットもあります。“wide” 型（横型）のデータセットでは、1 つの変数が複数の列に分かれて記録されていることがあります（詳細は、<a href="pivoting.html#pivoting">データの縦横変換</a> の章で紹介する例をご参照ください）。同様に、観測値が複数の行に分かれていることもあります。</p>
<p>このハンドブックでは、主にデータの管理と変換について取り扱うため、抽象的な観測値や変数よりも、行や列といった具体的なデータ構造を示す呼び方を使用していきます。例外として、データ分析の章では、変数や観測値と呼ぶことがあります。</p>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</div>
<div id="パイプラインによるデータクリーニング" class="section level2" number="8.1">
<h2>
<span class="header-section-number">8.1</span> パイプラインによるデータクリーニング<a class="anchor" aria-label="anchor" href="#%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%AB%E3%82%88%E3%82%8B%E3%83%87%E3%83%BC%E3%82%BF%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0"><i class="fas fa-link"></i></a>
</h2>
<p><strong>この章では、代表的なデータクリーニングの手順を実行し、パイプに処理を順次追加しながら進めていきます。</strong></p>
<p>疫学的な分析やデータ処理では、クリーニングを行う際、複数の手順が連続して実行されることが多く、手順どうしが互いに関連していることがよくあります。Rでは多くの場合、このように連続した手順はクリーニングを行う一貫したパイプラインとして作成され、データが処理されます。作成されたパイプラインでは、未加工のデータセットが 1 つのデータ処理のステップから別のデータ処理のステップに渡されます。</p>
<p>このような連続処理には、<strong>dplyr</strong> パッケージの「動詞」関数と <strong>magrittr</strong> パッケージのパイプ演算子 <code>%&gt;%</code> が使用されます。パイプ処理は、始めに未加工データ（“linelist_raw.xlsx”）を扱い、最終的に、使用や保存、エクスポートなどが行えるクリーニングされた R データフレーム（<code>linelist</code>）を作成することを目標としています。</p>
<p>パイプラインのデータ処理は、各手順の順番が重要です。クリーニングの手順には以下のようなものがあります。</p>
<ul>
<li><p>データをインポートする<br></p></li>
<li><p>列名を修正、または変更する<br></p></li>
<li><p>重複したデータを排除する<br></p></li>
<li><p>列を作成し、変換する（例：値の再定義または標準化）<br></p></li>
<li><p>行を抽出、または追加する<br></p></li>
</ul>
<!-- ======================================================= --><!-- ======================================================= --><!-- ======================================================= -->
</div>
<div id="パッケージの読み込み" class="section level2" number="8.2">
<h2>
<span class="header-section-number">8.2</span> パッケージの読み込み<a class="anchor" aria-label="anchor" href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF"><i class="fas fa-link"></i></a>
</h2>
<p>以下のコードを実行すると、分析に必要なパッケージが読み込まれます。このハンドブックでは、パッケージを読み込むために、<strong>pacman</strong> パッケージの <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load()</a></code> を主に使用しています。<code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load()</a></code> は、必要に応じてパッケージをインストールし、現在の R セッションで使用するためにパッケージを読み込む関数です。また、すでにインストールされたパッケージは、R の基本パッケージである <strong>base</strong> の <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> を使用して読み込むこともできます。R パッケージに関する詳細は、<a href="basics.html#basics">R の基礎</a> の章をご覧ください。</p>
<div class="sourceCode" id="cb179"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">rio</span>,        <span class="co"># データを読み込むためのパッケージ  </span></span>
<span>  <span class="va">here</span>,       <span class="co"># 相対ファイルパスを設定するためのパッケージ  </span></span>
<span>  <span class="va">janitor</span>,    <span class="co"># データ前処理と表の作成のためのパッケージ  </span></span>
<span>  <span class="va">lubridate</span>,  <span class="co"># 日付操作のためのパッケージ  </span></span>
<span>  <span class="va">epikit</span>,     <span class="co"># age_categories()を含むパッケージ  </span></span>
<span>  <span class="va">tidyverse</span>   <span class="co"># データ管理と可視化のためのパッケージ  </span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</div>
<div id="データのインポート-1" class="section level2" number="8.3">
<h2>
<span class="header-section-number">8.3</span> データのインポート<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88-1"><i class="fas fa-link"></i></a>
</h2>
<div id="データをインポートする" class="section level3 unnumbered">
<h3>データをインポートする<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p>ここでは、<strong>rio</strong> パッケージの <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> を使って、未加工の症例リスト（Excel ファイル）をインポートします。<strong>rio</strong> パッケージは、様々な形式のファイル（.xlsx、.csv、.tsv、.rds など）に対応できます。<strong>rio</strong> パッケージの詳細や、通常とは異なる状況（行のスキップ、欠損値の設定、Googleシートのインポートなど）での対処法を知りたい方は、<a href="importing.html#importing">インポートとエクスポート</a> の章をご覧ください。</p>
<p>お手元の環境でこの章の内容を実行したい方は、<a href="https://github.com/appliedepi/epirhandbook_eng/raw/master/data/case_linelists/linelist_raw.xlsx">こちら</a> から「未加工の」ラインリストをダウンロードしてください（.xlsx ファイルとしてダウンロードされます）。</p>
<p>データサイズが大きいためにインポートに時間がかかる場合は、インポートするためのコードを、インポート後のデータ前処理を行うパイプラインとは別の場所に書き、未加工データを元データとしてオブジェクトに保存しておくと便利です。コードを分けて書くことで、未加工のデータと前処理済みのデータの比較が容易になります。</p>
<div class="sourceCode" id="cb180"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"linelist_raw.xlsx"</span><span class="op">)</span></span></code></pre></div>
<p>データフレームの最初の 50 行を確認してみましょう。</p>
<p>注釈：<strong>base</strong> R に含まれている関数 <code>head(n)</code> を使うと、R コンソールに最初の <code>n</code> 行が表示されます。</p>
<div id="htmlwidget-a7a826a3e2e91f43d7d9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a7a826a3e2e91f43d7d9">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],[4,4,2,3,3,3,4,4,4,4,4,4,6,5,6,9,10,8,7,6,7,6,8,6,10,8,6,12,5,8,7,9,11,5,8,5,6,11,7,9,7,8,9,12,13,9,8,10,8,7],["2014-05-08T00:00:00Z",null,null,"2014-05-04T00:00:00Z","2014-05-18T00:00:00Z","2014-05-03T00:00:00Z","2014-05-22T00:00:00Z","2014-05-28T00:00:00Z",null,null,"2014-05-30T00:00:00Z","2014-05-28T00:00:00Z","2014-06-14T00:00:00Z","2014-06-07T00:00:00Z","2014-06-09T00:00:00Z",null,null,null,"2014-06-23T00:00:00Z","2014-06-18T00:00:00Z","2014-06-24T00:00:00Z",null,null,"2014-07-03T00:00:00Z",null,"2014-07-10T00:00:00Z","2014-06-14T00:00:00Z",null,"2014-06-18T00:00:00Z","2014-06-29T00:00:00Z","2014-07-02T00:00:00Z","2014-07-12T00:00:00Z","2014-07-12T00:00:00Z","2014-06-13T00:00:00Z","2014-07-15T00:00:00Z","2014-06-20T00:00:00Z",null,null,"2014-07-20T00:00:00Z",null,"2014-07-12T00:00:00Z","2014-07-19T00:00:00Z","2014-07-18T00:00:00Z","2014-07-18T00:00:00Z","2014-07-27T00:00:00Z",null,"2014-07-19T00:00:00Z","2014-07-26T00:00:00Z","2014-07-24T00:00:00Z",null],["2014-05-13","2014-05-13","2014-05-16","2014-05-18","2014-05-21","2014-05-22","2014-05-27","2014-06-02","2014-06-05","2014-06-05","2014-06-06","2014-06-13","2014-06-16","2014-06-17","2014-06-18","2014-06-19","2014-06-22","2014-06-23","2014-06-25","2014-06-26","2014-06-28","2014-07-02","2014-07-08","2014-07-09","2014-07-09","2014-07-10","2014-07-12","2014-07-12","2014-07-13","2014-07-13","2014-07-14","2014-07-15","2014-07-16","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-22","2014-07-22","2014-07-24","2014-07-24","2014-07-25","2014-07-25","2014-07-27","2014-07-29","2014-07-30",null,"2014-08-01","2014-08-02","2014-08-03"],["2014-05-15T00:00:00Z","2014-05-14T00:00:00Z","2014-05-18T00:00:00Z","2014-05-20T00:00:00Z","2014-05-22T00:00:00Z","2014-05-23T00:00:00Z","2014-05-29T00:00:00Z","2014-06-03T00:00:00Z","2014-06-06T00:00:00Z","2014-06-07T00:00:00Z","2014-06-08T00:00:00Z","2014-06-15T00:00:00Z","2014-06-17T00:00:00Z","2014-06-17T00:00:00Z","2014-06-20T00:00:00Z","2014-06-19T00:00:00Z","2014-06-23T00:00:00Z","2014-06-24T00:00:00Z","2014-06-27T00:00:00Z","2014-06-28T00:00:00Z","2014-06-29T00:00:00Z","2014-07-03T00:00:00Z","2014-07-09T00:00:00Z","2014-07-09T00:00:00Z","2014-07-11T00:00:00Z","2014-07-11T00:00:00Z","2014-07-13T00:00:00Z","2014-07-14T00:00:00Z","2014-07-14T00:00:00Z","2014-07-13T00:00:00Z","2014-07-14T00:00:00Z","2014-07-17T00:00:00Z","2014-07-17T00:00:00Z","2014-07-18T00:00:00Z","2014-07-19T00:00:00Z","2014-07-20T00:00:00Z","2014-07-20T00:00:00Z","2014-07-22T00:00:00Z","2014-07-24T00:00:00Z","2014-07-26T00:00:00Z","2014-07-24T00:00:00Z","2014-07-27T00:00:00Z","2014-07-25T00:00:00Z","2014-07-27T00:00:00Z","2014-07-31T00:00:00Z","2014-08-01T00:00:00Z","2014-08-03T00:00:00Z","2014-08-02T00:00:00Z","2014-08-02T00:00:00Z","2014-08-04T00:00:00Z"],[null,"2014-05-18T00:00:00Z","2014-05-30T00:00:00Z",null,"2014-05-29T00:00:00Z","2014-05-24T00:00:00Z","2014-06-01T00:00:00Z","2014-06-07T00:00:00Z","2014-06-18T00:00:00Z","2014-06-09T00:00:00Z","2014-06-15T00:00:00Z",null,"2014-07-09T00:00:00Z",null,"2014-06-30T00:00:00Z","2014-07-11T00:00:00Z","2014-07-01T00:00:00Z","2014-06-25T00:00:00Z","2014-07-06T00:00:00Z","2014-07-02T00:00:00Z","2014-07-09T00:00:00Z","2014-07-07T00:00:00Z","2014-07-20T00:00:00Z",null,"2014-07-22T00:00:00Z","2014-07-16T00:00:00Z","2014-07-14T00:00:00Z","2014-07-20T00:00:00Z","2014-07-16T00:00:00Z","2014-07-19T00:00:00Z","2014-07-27T00:00:00Z","2014-07-19T00:00:00Z",null,"2014-07-26T00:00:00Z","2014-08-14T00:00:00Z","2014-08-01T00:00:00Z","2014-07-23T00:00:00Z","2014-08-28T00:00:00Z","2014-07-28T00:00:00Z","2014-07-19T00:00:00Z",null,"2014-08-03T00:00:00Z",null,null,null,"2014-08-06T00:00:00Z","2014-08-21T00:00:00Z","2014-09-13T00:00:00Z","2014-08-04T00:00:00Z",null],[null,"Recover","Recover",null,"Recover","Recover","Recover","Death","Recover","Death","Death","Death","Recover","Recover",null,"Recover",null,null,"Death","Death","Recover",null,null,null,"Death",null,"Death","Death",null,"Death","Recover","Death","Recover","Death","Recover",null,"Death","Recover","Recover","Death",null,null,"Death","Death","Death","Death","Recover",null,"Death","Death"],["m","f","m","f","m","f","f","f","m","f","m","m","m","f","f","m","f","f","f","f","m","m","f","m","f","m","m","f","m","f","f","f","m","m","f","m","f","f","f","m","f","m","f","m","m","f","m","f","m","m"],["Other",null,"St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Port Hospital",null,null,null,null,"Port Hospital","Military Hospital",null,null,"Other","Port Hospital","Port Hospital","Port Hospital",null,"Other","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)",null,"Other",null,"St. Marks Maternity Hopital (SMMH)","Military Hospital","Port Hospital","Central Hospital","Military Hospital","Central Hospital",null,"Military Hospital","Other",null,null,"Port Hospital","Port Hospital","Port Hospital",null,"Central Hospital","Military Hospital","Other","Other","Other",null,"St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)",null],[-13.2157351064963,-13.2152339775486,-13.212910703914,-13.2363711169728,-13.2228638912441,-13.222625321098,-13.2331547837254,-13.2320975453153,-13.2225511595637,-13.2572163655863,-13.2206286746001,-13.253989309478,-13.2385127873491,-13.209391925612,-13.2157278814899,-13.2243437095992,-13.2336087079551,-13.21422143145,-13.2339681355349,-13.2535640411465,-13.2250089377786,-13.2160657166043,-13.2680671272333,-13.2266742923612,-13.2160179088168,-13.2482584611565,-13.2156319199566,-13.2142410663192,-13.2614879104088,-13.2452992638476,-13.2630592726116,-13.2343341712241,-13.2199077448676,-13.2227293309912,-13.2343062806506,-13.218781651651,-13.2483677722899,-13.2097478342339,-13.2680867723786,-13.2587535457526,-13.262635786914,-13.2697246824573,-13.2209026809759,-13.2330734719715,-13.2680923666905,-13.2547212675054,-13.2573683214693,-13.2137356012883,-13.2175973322257,-13.2486407324245],[8.46897295100924,8.45171855856465,8.46481700596819,8.4754761613651,8.46082377490923,8.46183062600728,8.46272931462646,8.46144367534271,8.46191259217774,8.47292327643506,8.48401630165138,8.45837125340844,8.47761705512509,8.47570184950483,8.47779946878972,8.47145134147474,8.47804840685363,8.48528034195779,8.46957530395867,8.45957352078114,8.47404889511544,8.48802917129884,8.473437335922,8.48408263734462,8.46242233645879,8.47026822126572,8.46398447480533,8.4641347894342,8.45623094629607,8.48334624336805,8.47493999153642,8.47832062438022,8.4693933891765,8.48480589906514,8.47121232619015,8.48438437371817,8.48466158574339,8.47714159984428,8.46238127010609,8.45568597813113,8.4632880274758,8.47940722413856,8.46353857052336,8.46178968158864,8.47508713872833,8.45825808128071,8.4532568143863,8.4732571907655,8.47911586641933,8.48480340615605],["f547d6",null,null,"f90f5f","11f8ea","aec8ec","893f25","133ee7",null,null,"996f3a","133ee7","37a6f6","9f6884","4802b1",null,null,null,"a75c7f","8e104d","ab634e",null,null,"b799eb",null,"5d9e4d","a15e13",null,"ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277",null,null,"d6584f",null,"312ecf","52ea64","cfd79c","d145b7","174288",null,"53608c","3b096b","f5c142",null],["other",null,null,"other","other","other","other","other",null,null,"other","other","other","other","other",null,null,null,"other","other","other",null,null,"other",null,"other","other",null,"other","funeral","other","funeral","other","other","other","funeral",null,null,"other",null,"other","other","other","other","other",null,"funeral","other","other",null],["2","3","56","18","3","16","16","0","61","27","12","42","19","7","7","13","35","17","11","11","19","54","14","28","6","3","31","6","67","14","10","21","20","45","1","12","3","15","20","36","7","13","14","3","10","1","0","20","26","14"],["years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50],[27,25,91,41,36,56,47,0,86,69,67,84,68,44,34,66,78,47,53,47,71,86,53,69,38,46,68,37,100,56,50,57,65,72,29,69,37,48,54,71,47,61,47,35,53,16,13,59,69,67],[48,59,238,135,71,116,87,11,226,174,112,186,174,90,91,152,214,137,117,131,150,241,131,161,80,69,188,66,233,142,110,182,164,214,26,157,39,154,133,168,100,125,123,67,134,31,36,125,183,169],[22,22,21,23,23,21,21,22,22,22,22,22,22,21,23,22,23,21,22,23,21,23,21,24,23,22,24,23,20,24,24,20,24,21,22,21,23,22,23,23,23,22,23,22,22,22,23,22,22,22],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","no","no","no","no","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","yes","no",null,"no","no","no","yes","no",null,"no","no","yes",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","yes","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","yes","yes","yes","yes","yes","yes","yes","yes","yes",null,"yes","yes","yes","yes","yes",null,"yes","yes","yes",null,null,"yes","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","yes","yes","yes","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","yes","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"yes","yes",null,"no","no",null,"no","no","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","no","yes","no","no","no","yes","no","no","no",null,"no","yes","no","no","no",null,"no","no","no",null,null,"no","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","no","yes","yes","yes",null],[36.8,36.9,36.9,36.8,36.9,37.6,37.3,37,36.4,35.9,36.5,36.9,36.5,37.1,36.5,37.3,37,38,38,36,37,36.7,36.9,36.5,37,36.5,37.6,36.6,36.6,36.2,36.4,37.1,37.5,37.5,37.4,36.9,36.4,37.3,37,37.8,36.5,37.5,36.7,37,37.3,36.6,36.5,36.6,37.6,36.8],[null,"09:36","16:48","11:22","12:60","14:13","14:33","09:25","11:16","10:55","16:03","11:14","12:42","11:06","09:10","08:45",null,"15:41","13:34","18:58","12:43","16:33","14:29","07:18","08:11","16:32","16:17","07:32","17:45",null,"13:24","14:43","02:33","11:36","17:28","16:27",null,"20:49",null,"11:38","14:25","13:42","21:22","13:33","19:06","17:14","20:09",null,"10:23","09:09"],["a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a"],["b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>generation<\/th>\n      <th>infection date<\/th>\n      <th>date onset<\/th>\n      <th>hosp date<\/th>\n      <th>date_of_outcome<\/th>\n      <th>outcome<\/th>\n      <th>gender<\/th>\n      <th>hospital<\/th>\n      <th>lon<\/th>\n      <th>lat<\/th>\n      <th>infector<\/th>\n      <th>source<\/th>\n      <th>age<\/th>\n      <th>age_unit<\/th>\n      <th>row_num<\/th>\n      <th>wt_kg<\/th>\n      <th>ht_cm<\/th>\n      <th>ct_blood<\/th>\n      <th>fever<\/th>\n      <th>chills<\/th>\n      <th>cough<\/th>\n      <th>aches<\/th>\n      <th>vomit<\/th>\n      <th>temp<\/th>\n      <th>time_admission<\/th>\n      <th>merged_header<\/th>\n      <th>...28<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,9,10,15,16,17,18,24]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="インポートしたデータを確認する" class="section level3 unnumbered">
<h3>インポートしたデータを確認する<a class="anchor" aria-label="anchor" href="#%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p><strong>skimr</strong> パッケージの <code>skim()</code> を使うと、データフレーム全体の概要を把握することができます（詳しくは、<a href="tables-descriptive.html#tables-descriptive">記述統計表の作り方</a> を参照ください）。列は、文字値や数値などのデータ型別にまとめられています。</p>
<p>注釈：“POSIXct” は未加工の日付データ型の一つです（詳細は、<a href="dates.html#dates">日付型データ</a> の章をご覧ください）。</p>
<div class="sourceCode" id="cb181"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">skimr</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/skimr/reference/skim.html">skim</a></span><span class="op">(</span><span class="va">linelist_raw</span><span class="op">)</span></span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<caption>
<span id="tab:unnamed-chunk-153">Table 8.1: </span>Data summary</caption>
<tbody>
<tr class="odd">
<td align="left">Name</td>
<td align="left">linelist_raw</td>
</tr>
<tr class="even">
<td align="left">Number of rows</td>
<td align="left">6611</td>
</tr>
<tr class="odd">
<td align="left">Number of columns</td>
<td align="left">28</td>
</tr>
<tr class="even">
<td align="left">_______________________</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Column type frequency:</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">character</td>
<td align="left">17</td>
</tr>
<tr class="odd">
<td align="left">numeric</td>
<td align="left">8</td>
</tr>
<tr class="even">
<td align="left">POSIXct</td>
<td align="left">3</td>
</tr>
<tr class="odd">
<td align="left">________________________</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">Group variables</td>
<td align="left">None</td>
</tr>
</tbody>
</table></div>
<p><strong>Variable type: character</strong></p>
<div class="inline-table"><table style="width:100%;" class="table table-sm">
<colgroup>
<col width="20%">
<col width="13%">
<col width="19%">
<col width="5%">
<col width="5%">
<col width="8%">
<col width="12%">
<col width="15%">
</colgroup>
<thead><tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">min</th>
<th align="right">max</th>
<th align="right">empty</th>
<th align="right">n_unique</th>
<th align="right">whitespace</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">case_id</td>
<td align="right">137</td>
<td align="right">0.98</td>
<td align="right">6</td>
<td align="right">6</td>
<td align="right">0</td>
<td align="right">5888</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">date onset</td>
<td align="right">293</td>
<td align="right">0.96</td>
<td align="right">10</td>
<td align="right">10</td>
<td align="right">0</td>
<td align="right">580</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">outcome</td>
<td align="right">1500</td>
<td align="right">0.77</td>
<td align="right">5</td>
<td align="right">7</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">gender</td>
<td align="right">324</td>
<td align="right">0.95</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">hospital</td>
<td align="right">1512</td>
<td align="right">0.77</td>
<td align="right">5</td>
<td align="right">36</td>
<td align="right">0</td>
<td align="right">13</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">infector</td>
<td align="right">2323</td>
<td align="right">0.65</td>
<td align="right">6</td>
<td align="right">6</td>
<td align="right">0</td>
<td align="right">2697</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">source</td>
<td align="right">2323</td>
<td align="right">0.65</td>
<td align="right">5</td>
<td align="right">7</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">age</td>
<td align="right">107</td>
<td align="right">0.98</td>
<td align="right">1</td>
<td align="right">2</td>
<td align="right">0</td>
<td align="right">75</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">age_unit</td>
<td align="right">7</td>
<td align="right">1.00</td>
<td align="right">5</td>
<td align="right">6</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">fever</td>
<td align="right">258</td>
<td align="right">0.96</td>
<td align="right">2</td>
<td align="right">3</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">chills</td>
<td align="right">258</td>
<td align="right">0.96</td>
<td align="right">2</td>
<td align="right">3</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">cough</td>
<td align="right">258</td>
<td align="right">0.96</td>
<td align="right">2</td>
<td align="right">3</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">aches</td>
<td align="right">258</td>
<td align="right">0.96</td>
<td align="right">2</td>
<td align="right">3</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">vomit</td>
<td align="right">258</td>
<td align="right">0.96</td>
<td align="right">2</td>
<td align="right">3</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">time_admission</td>
<td align="right">844</td>
<td align="right">0.87</td>
<td align="right">5</td>
<td align="right">5</td>
<td align="right">0</td>
<td align="right">1091</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">merged_header</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">…28</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
</tbody>
</table></div>
<p><strong>Variable type: numeric</strong></p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="15%">
<col width="10%">
<col width="15%">
<col width="8%">
<col width="8%">
<col width="7%">
<col width="8%">
<col width="8%">
<col width="8%">
<col width="8%">
</colgroup>
<thead><tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">mean</th>
<th align="right">sd</th>
<th align="right">p0</th>
<th align="right">p25</th>
<th align="right">p50</th>
<th align="right">p75</th>
<th align="right">p100</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">generation</td>
<td align="right">7</td>
<td align="right">1.00</td>
<td align="right">16.60</td>
<td align="right">5.71</td>
<td align="right">0.00</td>
<td align="right">13.00</td>
<td align="right">16.00</td>
<td align="right">20.00</td>
<td align="right">37.00</td>
</tr>
<tr class="even">
<td align="left">lon</td>
<td align="right">7</td>
<td align="right">1.00</td>
<td align="right">-13.23</td>
<td align="right">0.02</td>
<td align="right">-13.27</td>
<td align="right">-13.25</td>
<td align="right">-13.23</td>
<td align="right">-13.22</td>
<td align="right">-13.21</td>
</tr>
<tr class="odd">
<td align="left">lat</td>
<td align="right">7</td>
<td align="right">1.00</td>
<td align="right">8.47</td>
<td align="right">0.01</td>
<td align="right">8.45</td>
<td align="right">8.46</td>
<td align="right">8.47</td>
<td align="right">8.48</td>
<td align="right">8.49</td>
</tr>
<tr class="even">
<td align="left">row_num</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">3240.91</td>
<td align="right">1857.83</td>
<td align="right">1.00</td>
<td align="right">1647.50</td>
<td align="right">3241.00</td>
<td align="right">4836.50</td>
<td align="right">6481.00</td>
</tr>
<tr class="odd">
<td align="left">wt_kg</td>
<td align="right">7</td>
<td align="right">1.00</td>
<td align="right">52.69</td>
<td align="right">18.59</td>
<td align="right">-11.00</td>
<td align="right">41.00</td>
<td align="right">54.00</td>
<td align="right">66.00</td>
<td align="right">111.00</td>
</tr>
<tr class="even">
<td align="left">ht_cm</td>
<td align="right">7</td>
<td align="right">1.00</td>
<td align="right">125.25</td>
<td align="right">49.57</td>
<td align="right">4.00</td>
<td align="right">91.00</td>
<td align="right">130.00</td>
<td align="right">159.00</td>
<td align="right">295.00</td>
</tr>
<tr class="odd">
<td align="left">ct_blood</td>
<td align="right">7</td>
<td align="right">1.00</td>
<td align="right">21.26</td>
<td align="right">1.67</td>
<td align="right">16.00</td>
<td align="right">20.00</td>
<td align="right">22.00</td>
<td align="right">22.00</td>
<td align="right">26.00</td>
</tr>
<tr class="even">
<td align="left">temp</td>
<td align="right">158</td>
<td align="right">0.98</td>
<td align="right">38.60</td>
<td align="right">0.95</td>
<td align="right">35.20</td>
<td align="right">38.30</td>
<td align="right">38.80</td>
<td align="right">39.20</td>
<td align="right">40.80</td>
</tr>
</tbody>
</table></div>
<p><strong>Variable type: POSIXct</strong></p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="19%">
<col width="12%">
<col width="17%">
<col width="13%">
<col width="13%">
<col width="13%">
<col width="10%">
</colgroup>
<thead><tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="left">min</th>
<th align="left">max</th>
<th align="left">median</th>
<th align="right">n_unique</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">infection date</td>
<td align="right">2322</td>
<td align="right">0.65</td>
<td align="left">2012-04-09</td>
<td align="left">2015-04-27</td>
<td align="left">2014-10-04</td>
<td align="right">538</td>
</tr>
<tr class="even">
<td align="left">hosp date</td>
<td align="right">7</td>
<td align="right">1.00</td>
<td align="left">2012-04-20</td>
<td align="left">2015-04-30</td>
<td align="left">2014-10-15</td>
<td align="right">570</td>
</tr>
<tr class="odd">
<td align="left">date_of_outcome</td>
<td align="right">1068</td>
<td align="right">0.84</td>
<td align="left">2012-05-14</td>
<td align="left">2015-06-04</td>
<td align="left">2014-10-26</td>
<td align="right">575</td>
</tr>
</tbody>
</table></div>
<!-- ======================================================= --><!-- ======================================================= --><!-- ======================================================= -->
</div>
</div>
<div id="列名" class="section level2" number="8.4">
<h2>
<span class="header-section-number">8.4</span> 列名<a class="anchor" aria-label="anchor" href="#%E5%88%97%E5%90%8D"><i class="fas fa-link"></i></a>
</h2>
<p>Rでは、データセットの「ヘッダー」または各列の「一番上」の値が列名になります。列名は、コード内で列を参照するために使用されるほか、図を作成する際はデフォルトのラベルとして使用されます。</p>
<p>SAS や STATA など他の統計ソフトでは、短い列名を具体的に説明する「ラベル」が列名と共に使用されることが多いですが、R ではほとんど使用されません（R でもデータに列ラベルを追加することは可能です）。列名を図の表示に合わせて変更したい場合は、通常、図をプロットするコードの中で調整します（例えば、図の軸や凡例のタイトル、表示される表のヘッダーなどを調整したい場合です。詳細は、<a href="ggplot-tips.html#ggplot_tips_scales">ggplot のヒントの章の 31.2 スケール</a>と<a href="tables-presentation.html#tables-presentation">見やすい表の作り方</a> の章を参照してください）。データに列ラベルを付けたい場合は、<a href="https://cran.r-project.org/web/packages/expss/vignettes/labels-support.html">こちら</a> と <a href="https://cran.r-project.org/web/packages/labelled/vignettes/intro_labelled.html">こちら</a> のページをご覧ください。</p>
<p>R の列名はデータ分析やデータ管理において非常に頻繁に使用されるため、「きれいに」整えられている必要があります。列名を設定する際の一般的なルールとして、以下のように提案します。</p>
<ul>
<li><p>短い名前にする</p></li>
<li><p>スペースを使わない（スペースが必要な場合は、アンダースコア _ に置き換えてください）</p></li>
<li><p>&amp;、#、&lt; &gt; などの特殊な文字を使用しない</p></li>
<li><p>各列似たようなスタイルの用語を使用する（例：異なる種類の日付データを含む列が複数ある場合に、date_onset、date_report、date_death とするなど）</p></li>
</ul>
<p>以下に、<strong>base</strong> R の <code><a href="https://rdrr.io/r/base/names.html">names()</a></code> を使用して <code>linelist_raw</code> の列名を表示しました。表示された列名には、次のような特徴がみられます。</p>
<ul>
<li><p>スペースを含む名前がある（例：<code>infection date</code>）</p></li>
<li><p>日付データを含む列が複数あるが、各列異なるルールで名付けられている (例：<code>date onset</code> と <code>infection date</code>）</p></li>
<li><p>最後の 2 列の名前（“merged_header” と “…28”）を見ると、ダウンロードされた元の .xlsx ファイルの最後の 2 列には、マージされたヘッダーがあったことがわかります。2 つの列がマージされてできた列が R によって分割され、マージされてできた列の名前（“merged_header”）は元々の最初の列に割り当てられ、元々の 2 番目の列にはセルを保持するために一時的に “…28” が割り当てられています（マージされる前は空欄の列であり、28番目の列であるため）。</p></li>
</ul>
<div class="sourceCode" id="cb182"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist_raw</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] "case_id"         "generation"      "infection date"  "date onset"     
##  [5] "hosp date"       "date_of_outcome" "outcome"         "gender"         
##  [9] "hospital"        "lon"             "lat"             "infector"       
## [13] "source"          "age"             "age_unit"        "row_num"        
## [17] "wt_kg"           "ht_cm"           "ct_blood"        "fever"          
## [21] "chills"          "cough"           "aches"           "vomit"          
## [25] "temp"            "time_admission"  "merged_header"   "...28"</code></pre>
<p><span style="color: black;"><strong>注釈</strong>：スペースを含む列名を参照するには、その名前をバックティック（`）で囲みます。例えば、linelist$<code>` '\x60infection date\x60'`</code> というように使用します。キーボードでは、バックティック（`）とシングルクォーテーションマーク（’）が異なることに注意してください。</span></p>
<div id="ラベル" class="section level3 unnumbered">
<h3>ラベル<a class="anchor" aria-label="anchor" href="#%E3%83%A9%E3%83%99%E3%83%AB"><i class="fas fa-link"></i></a>
</h3>
<p>SAS などの他の統計ソフトでは、変数のラベルが付いていることに注意してください。</p>
</div>
<div id="自動クリーニング" class="section level3 unnumbered">
<h3>自動クリーニング<a class="anchor" aria-label="anchor" href="#%E8%87%AA%E5%8B%95%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0"><i class="fas fa-link"></i></a>
</h3>
<p><strong>janitor</strong> パッケージの <code>clean_names()</code> は、以下のように列名を標準化し、ユニークにします。</p>
<ul>
<li><p>すべての列名をアンダースコア（_）、数字、文字のみで構成されるように変換します。<br></p></li>
<li><p>アクセント記号付きの文字は ASCII に音訳されます（例：ドイツ語のウムラウト記号付きの o は単に “o” に変換され、スペイン語の “enye”は “n”に変換されます）。<br></p></li>
<li><p>変換後の列名の大文字と小文字の区別は、<code>case =</code> 引数を使って指定できます（デフォルトは “snake” になっていますが、他に “sentence”、“title”、“small_camel” などがあります）。<br></p></li>
<li><p><code>replace =</code> 引数にベクトルを与えることで、特定の名前の置き換えを指定することができます（例：<code>replace = c(onset = "date_of_onset")</code>)</p></li>
<li><p><code>clean_names()</code> に関する公式ドキュメントは、<a href="https://cran.r-project.org/web/packages/janitor/vignettes/janitor.html#cleaning">こちら</a>をご覧ください。</p></li>
</ul>
<p>では、前処理のパイプラインを作成していきます。まず初めに、以下では、未加工のラインリストに対して <code>clean_names()</code> を使用し、列名を整えていきます。</p>
<div class="sourceCode" id="cb184"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 未加工のデータセットをclean_names()にパイプし、出力結果をlinelistとして保存する</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 新しく作成された linelist の列名を確認する</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] "case_id"         "generation"      "infection_date"  "date_onset"     
##  [5] "hosp_date"       "date_of_outcome" "outcome"         "gender"         
##  [9] "hospital"        "lon"             "lat"             "infector"       
## [13] "source"          "age"             "age_unit"        "row_num"        
## [17] "wt_kg"           "ht_cm"           "ct_blood"        "fever"          
## [21] "chills"          "cough"           "aches"           "vomit"          
## [25] "temp"            "time_admission"  "merged_header"   "x28"</code></pre>
<p><u><strong>注釈</strong></u><strong>：最終列の列名</strong> “…28” が “x28” に変化したことに注目してください。</p>
</div>
<div id="手動による列名のクリーニング" class="section level3 unnumbered">
<h3>手動による列名のクリーニング<a class="anchor" aria-label="anchor" href="#%E6%89%8B%E5%8B%95%E3%81%AB%E3%82%88%E3%82%8B%E5%88%97%E5%90%8D%E3%81%AE%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0"><i class="fas fa-link"></i></a>
</h3>
<p>上で行った自動クリーニングによる列名の標準化の後に、列名を個別に、一つずつ変更することが必要な場合があります。 <code><a href="https://dplyr.tidyverse.org/reference/rename.html">rename()</a></code> は <code>NEW = OLD</code> というスタイルを採用しており、新しい列名を既存の列名の前に書く必要があります。</p>
<p>以下では、上で作成した自動クリーニングのパイプラインに名前を個別に変更するコマンドを追加しています。コードを読みやすくするため、戦略的にスペースを追加しています。</p>
<div class="sourceCode" id="cb186"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># パイプチェーン処理 (未加工データから始まり、クリーニングステップを経由してパイプで処理される)</span></span>
<span><span class="co">##################################################################################</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    </span>
<span>    <span class="co"># 列名の標準化</span></span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>    <span class="co"># 列名を個別に変更</span></span>
<span>           <span class="co"># 新しい列名            # 既存の列名</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>date_infection       <span class="op">=</span> <span class="va">infection_date</span>,</span>
<span>           date_hospitalisation <span class="op">=</span> <span class="va">hosp_date</span>,</span>
<span>           date_outcome         <span class="op">=</span> <span class="va">date_of_outcome</span><span class="op">)</span></span></code></pre></div>
<p>これで、列名が変更されていることがわかります。</p>
<pre><code>##  [1] "case_id"              "generation"           "date_infection"      
##  [4] "date_onset"           "date_hospitalisation" "date_outcome"        
##  [7] "outcome"              "gender"               "hospital"            
## [10] "lon"                  "lat"                  "infector"            
## [13] "source"               "age"                  "age_unit"            
## [16] "row_num"              "wt_kg"                "ht_cm"               
## [19] "ct_blood"             "fever"                "chills"              
## [22] "cough"                "aches"                "vomit"               
## [25] "temp"                 "time_admission"       "merged_header"       
## [28] "x28"</code></pre>
</div>
<div id="列の位置による名前の変更" class="section level3 unnumbered">
<h3>列の位置による名前の変更<a class="anchor" aria-label="anchor" href="#%E5%88%97%E3%81%AE%E4%BD%8D%E7%BD%AE%E3%81%AB%E3%82%88%E3%82%8B%E5%90%8D%E5%89%8D%E3%81%AE%E5%A4%89%E6%9B%B4"><i class="fas fa-link"></i></a>
</h3>
<p>列名ではなく、列の位置によって列の名前を変更することもできます。</p>
<div class="sourceCode" id="cb188"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>newNameForFirstColumn  <span class="op">=</span> <span class="fl">1</span>,</span>
<span>       newNameForSecondColumn <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div id="select-および-summarise-による列名の変更" class="section level4 unnumbered">
<h4>
<code>select()</code> および <code>summarise()</code> による列名の変更<a class="anchor" aria-label="anchor" href="#select-%E3%81%8A%E3%82%88%E3%81%B3-summarise-%E3%81%AB%E3%82%88%E3%82%8B%E5%88%97%E5%90%8D%E3%81%AE%E5%A4%89%E6%9B%B4"><i class="fas fa-link"></i></a>
</h4>
<p>ショートカットとして、<strong>dplyr</strong> パッケージの <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> や <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> でも列の名前を変更することができます。<code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> は特定の列だけを残すために使用します（本章で後述します）。<code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> については、<a href="grouping.html#grouping">データのグループ化</a> の章や、<a href="tables-descriptive.html#tables-descriptive">記述統計表の作り方</a> の章で説明します。これらの関数も <code><a href="https://dplyr.tidyverse.org/reference/rename.html">rename()</a></code> と同様に、<code>new_name = old_name</code> というフォーマットを使用します。以下はその例です。</p>
<div class="sourceCode" id="cb189"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="co">#新しい列名             # 既存の列名</span></span>
<span>         date_infection       <span class="op">=</span> <span class="va">`infection date`</span>,</span>
<span>         date_hospitalisation <span class="op">=</span> <span class="va">`hosp date`</span><span class="op">)</span> <span class="co">#列名を変更し、変更した列だけを残す</span></span></code></pre></div>
</div>
</div>
<div id="その他の課題" class="section level3 unnumbered">
<h3>その他の課題<a class="anchor" aria-label="anchor" href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E8%AA%B2%E9%A1%8C"><i class="fas fa-link"></i></a>
</h3>
<div id="空白の-excel-列名" class="section level4 unnumbered">
<h4>空白の Excel 列名<a class="anchor" aria-label="anchor" href="#%E7%A9%BA%E7%99%BD%E3%81%AE-excel-%E5%88%97%E5%90%8D"><i class="fas fa-link"></i></a>
</h4>
<p>R は、列名（ヘッダー）のないデータセット列を処理することはできません。したがって、データはあるがヘッダーがない Excel データセットをインポートした場合、R は “…1” や “…2” といった名前でヘッダーを埋めます。数字は列番号を表します（例：データセットの 4 列目にヘッダーがない場合、R はその列を “…4” と命名します）。</p>
<p>R によって付与された名前は、ポジション番号（上記の例を参照）または割り当てられた名前（<code>linelist_raw$...1</code>）を参照することで、手動でクリーニングすることができます。</p>
</div>
<div id="excel-の列名とセルの結合" class="section level4 unnumbered">
<h4>Excel の列名とセルの結合<a class="anchor" aria-label="anchor" href="#excel-%E3%81%AE%E5%88%97%E5%90%8D%E3%81%A8%E3%82%BB%E3%83%AB%E3%81%AE%E7%B5%90%E5%90%88"><i class="fas fa-link"></i></a>
</h4>
<p>Excel ファイル内のマージされたセルは、データを受け取る際によく問題になります。<a href="transition-to-R.html#transition-to-R">Excel・Stata・SASとの比較</a> の章で説明したように、マージされたセルは、人間がデータを読むときには便利ですが、 コンピュータにとっては「整頓されたデータ」ではないため、 データを読み込む際に多くの問題が発生します。R はマージされたセルに対応できないからです。</p>
<p><strong>人間が読めるデータとコンピュータが読めるデータは別物である</strong>ことを、データ入力をする担当者に伝えてください。また、<a href="https://r4ds.had.co.nz/tidy-data.html">整頓されたデータの原則</a> をユーザーに教えるよう努めてください。可能であれば、セルが結合されていない整頓されたフォーマットでデータが手元に届くように、データ入力や収集の手順を変更しましょう。</p>
<ul>
<li>各変数はそれぞれ個別の列でなければなりません。<br>
</li>
<li>各観測値は、それぞれ個別の行である必要があります。<br>
</li>
<li>それぞれの値は、それぞれ別のセルに入力されていなければなりません。</li>
</ul>
<p><strong>rio</strong> パッケージの <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> を使用した場合、マージされたセルの値は最初のセルに割り当てられ、それ以降のセルは空になります。</p>
<p>結合されたセルを処理するための一つの解決策は、<strong>openxlsx</strong> パッケージの <code>readWorkbook()</code> を使用してデータをインポートすることです。引数 <code>fillMergedCells = TRUE</code> を設定すると、マージされたセルの値を、マージ範囲内のすべてのセルに入れることができます。</p>
<div class="sourceCode" id="cb190"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist_raw</span> <span class="op">&lt;-</span> <span class="fu">openxlsx</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/openxlsx/man/readWorkbook.html">readWorkbook</a></span><span class="op">(</span><span class="st">"linelist_raw.xlsx"</span>, fillMergedCells <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><span style="color: red;">警告：<code>readWorkbook()</code> で列名をマージすると、列名が重複してしまうので、手動で修正する必要があります。R は列名が重複するとうまく動作しません！重複した列名がある場合は、手動による列名のクリーニングのセクションで説明したように、列の位置（例えば 5 列目）を参照し、列名を再設定することができます。</span></p>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="列の選択と並び替え" class="section level2" number="8.5">
<h2>
<span class="header-section-number">8.5</span> 列の選択と並び替え<a class="anchor" aria-label="anchor" href="#%E5%88%97%E3%81%AE%E9%81%B8%E6%8A%9E%E3%81%A8%E4%B8%A6%E3%81%B3%E6%9B%BF%E3%81%88"><i class="fas fa-link"></i></a>
</h2>
<p><strong>dplyr</strong> パッケージの <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> を使って、残したい列を選択し、データフレーム内における列の順番を指定します。</p>
<p><u><strong>注意</strong></u><strong>：</strong>以下の例では、<code>linelist</code> データフレームを <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> で変更して表示していますが、これは例としてデータを示すためであり、変更されたデータは保存はされていないことに注意してください。変更された列名は、データフレームを <code><a href="https://rdrr.io/r/base/names.html">names()</a></code> にパイプすることで表示されます。</p>
<p>まず、現時点での <code>linelist</code> データフレームのすべての列名を以下に表示します。</p>
<div class="sourceCode" id="cb191"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] "case_id"              "generation"           "date_infection"      
##  [4] "date_onset"           "date_hospitalisation" "date_outcome"        
##  [7] "outcome"              "gender"               "hospital"            
## [10] "lon"                  "lat"                  "infector"            
## [13] "source"               "age"                  "age_unit"            
## [16] "row_num"              "wt_kg"                "ht_cm"               
## [19] "ct_blood"             "fever"                "chills"              
## [22] "cough"                "aches"                "vomit"               
## [25] "temp"                 "time_admission"       "merged_header"       
## [28] "x28"</code></pre>
<div id="列の保持" class="section level3 unnumbered">
<h3>列の保持<a class="anchor" aria-label="anchor" href="#%E5%88%97%E3%81%AE%E4%BF%9D%E6%8C%81"><i class="fas fa-link"></i></a>
</h3>
<p><strong>残しておきたい列のみを選択する</strong></p>
<p><code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> の中で、列の名前を引用符（” “）を使わずに指定します。指定された列は、指定された順序でデータフレームに表示されます。存在しない列を指定した場合、R がエラーを返すことに注意してください（このような場合にエラーを出さないようにするには、後述の <code><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of()</a></code> の使い方を参照してください）。</p>
<div class="sourceCode" id="cb193"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ラインリストのデータセットはselect()に渡され、name()で列名を表示する</span></span>
<span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">case_id</span>, <span class="va">date_onset</span>, <span class="va">date_hospitalisation</span>, <span class="va">fever</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="op">)</span>  <span class="co"># 列名を表示する</span></span></code></pre></div>
<pre><code>## [1] "case_id"              "date_onset"           "date_hospitalisation"
## [4] "fever"</code></pre>
</div>
<div id="clean_tidyselect" class="section level3 unnumbered">
<h3>“tidyselect” ヘルパー関数<a class="anchor" aria-label="anchor" href="#clean_tidyselect"><i class="fas fa-link"></i></a>
</h3>
<p><strong>tidyverse</strong> パッケージに含まれる <strong>tidyselect</strong> パッケージのヘルパー関数は、列の保持や除外、または変換する列を簡単に指定するための関数であり、<strong>dplyr</strong> 系関数で列を選択する方法の基礎となっています。</p>
<p>例えば、列の順番を変更したい場合、<code><a href="https://tidyselect.r-lib.org/reference/everything.html">everything()</a></code> は「記載されていない他のすべての列」を意味する便利な関数です。以下のコードは、<code>date_onset</code> と <code>date_hospitalisation</code> の列をデータセットの最初（左）に移動させますが、それ以外の列はすべてそのままにします。<code><a href="https://tidyselect.r-lib.org/reference/everything.html">everything()</a></code> の括弧内は空であることに注意してください。</p>
<div class="sourceCode" id="cb195"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># date_onset と date_hospitalisation を先頭に移動させる</span></span>
<span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date_onset</span>, <span class="va">date_hospitalisation</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] "date_onset"           "date_hospitalisation" "case_id"             
##  [4] "generation"           "date_infection"       "date_outcome"        
##  [7] "outcome"              "gender"               "hospital"            
## [10] "lon"                  "lat"                  "infector"            
## [13] "source"               "age"                  "age_unit"            
## [16] "row_num"              "wt_kg"                "ht_cm"               
## [19] "ct_blood"             "fever"                "chills"              
## [22] "cough"                "aches"                "vomit"               
## [25] "temp"                 "time_admission"       "merged_header"       
## [28] "x28"</code></pre>
<p>以下に、<code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/across.html">across()</a></code>、<code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> などの <strong>dplyr</strong> 系関数内で使える他の “tidyselect” ヘルパー関数を紹介します。</p>
<ul>
<li><p><code><a href="https://tidyselect.r-lib.org/reference/everything.html">everything()</a></code>：指定されていない他のすべての列を指定します。<br></p></li>
<li><p><code><a href="https://tidyselect.r-lib.org/reference/everything.html">last_col()</a></code>：最後の列を指定します。<br></p></li>
<li><p><code>where()</code>：すべての列に関数を適用し、TRUEとなるものを選択します。<br></p></li>
<li>
<p><code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains()</a></code>：ある文字列を含む列を指定します。<br></p>
<ul>
<li>例）<code>select(contains("time"))</code><br>
</li>
</ul>
</li>
<li>
<p>starts_with()：指定された接頭語を指定します。</p>
<ul>
<li>例）<code>select(starts_with("date_"))</code><br>
</li>
</ul>
</li>
<li>
<p><code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with()</a></code>：指定された接尾語を指定します。<br></p>
<ul>
<li>例）<code>select(ends_with("_post"))</code><br>
</li>
</ul>
</li>
<li>
<p><code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches()</a></code>：正規表現（regex）を適用し、列を指定します。<br></p>
<ul>
<li>例）<code>select(matches("[pt]al"))</code><br>
</li>
</ul>
</li>
<li><p><code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">num_range()</a></code>：x01、x02、x03 のような数値の範囲を指定します。<br></p></li>
<li>
<p><code><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of()</a></code>：関数内で使用した場合、指定する列が存在する場合は、その関数が適用され、存在しない場合は適用されず、エラーを表示しません。<br></p>
<ul>
<li>例）<code>select(any_of(date_onset, date_death, cardiac_arrest))</code><br>
</li>
</ul>
</li>
</ul>
<p>さらに、複数の列を列挙する場合には <code><a href="https://rdrr.io/r/base/c.html">c()</a></code>、連続した列には <code>:</code>、反対の列には <code>!</code>、<code>AND</code> には <code>&amp;</code>、<code>OR</code> には <code>|</code> などの通常の演算子が使用できます。</p>
<p>列の論理的な条件を指定したい場合は、<code>where()</code> を使用します。<code>where()</code> の中に関数を入れる場合は、関数の後に空の括弧をつけないでください。以下のコードは、 数字型データの列をすべて選択します。</p>
<div class="sourceCode" id="cb197"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 数字型データの列を選択する</span></span>
<span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu">where</span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "generation" "lon"        "lat"        "row_num"    "wt_kg"     
## [6] "ht_cm"      "ct_blood"   "temp"</code></pre>
<p>ある特定の文字列が含まれている列のみを選択したい場合は、<code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains()</a></code> を使用します。 また、<code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with()</a></code> や <code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with()</a></code> を使用すると、より詳細に列を指定することができます。</p>
<div class="sourceCode" id="cb199"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 特定の文字を含む列を選択する</span></span>
<span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "date_infection"       "date_onset"           "date_hospitalisation"
## [4] "date_outcome"</code></pre>
<p>さらに、<code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains()</a></code> と同様の動作をする <code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches()</a></code> は、 OR バー（|）で区切られた複数の文字列などの正規表現を括弧内で指定することができます（正規表現の詳細については、<a href="characters-strings.html#characters-strings">文字型・文字列型データ</a> の章を参照ください）。</p>
<div class="sourceCode" id="cb201"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 複数の文字列に当てはまる列を検索する</span></span>
<span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches</a></span><span class="op">(</span><span class="st">"onset|hosp|fev"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>   <span class="co"># "|" は OR を意味する</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "date_onset"           "date_hospitalisation" "hospital"            
## [4] "fever"</code></pre>
<p><span style="color: orange;">注意：指定した列名がデータセットに存在しない場合、エラーが返されてコードの処理が停止することがあります。存在するかどうかわからない列を指定したい場合は、<code><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of()</a></code> を使用することをおすすめします。<code><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of()</a></code> は、列の除外など、否定的な列の選択をする場合においてと特に有用です。</span></p>
<p>以下のコードでは、指定されている列のうち 1 つだけがデータセットに存在しますが、エラーは発生せず、コードは処理を停止することなく実行されます。</p>
<div class="sourceCode" id="cb203"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"date_onset"</span>, <span class="st">"village_origin"</span>, <span class="st">"village_detection"</span>, <span class="st">"village_residence"</span>, <span class="st">"village_travel"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "date_onset"</code></pre>
</div>
<div id="列の除外" class="section level3 unnumbered">
<h3>列の除外<a class="anchor" aria-label="anchor" href="#%E5%88%97%E3%81%AE%E9%99%A4%E5%A4%96"><i class="fas fa-link"></i></a>
</h3>
<p>データセットから除外したい列がある場合は、列名の前にマイナス記号（-）を付ける（例：<code>select(-outcome)</code>）、または以下のように列名のベクトルの前にマイナス記号（-）を付けて指定すると、除外できます。指定された以外の列はすべて残ります。</p>
<div class="sourceCode" id="cb205"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">date_onset</span>, <span class="va">fever</span><span class="op">:</span><span class="va">vomit</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>     <span class="co"># date_onsetと、feverからvomitまでのすべての列を削除する</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] "case_id"              "generation"           "date_infection"      
##  [4] "date_hospitalisation" "date_outcome"         "outcome"             
##  [7] "gender"               "hospital"             "lon"                 
## [10] "lat"                  "infector"             "source"              
## [13] "age"                  "age_unit"             "row_num"             
## [16] "wt_kg"                "ht_cm"                "ct_blood"            
## [19] "temp"                 "time_admission"       "merged_header"       
## [22] "x28"</code></pre>
<p>R の基本的な構文を使用し、除外したい列を NULL と定義して削除することもできます。例えば、以下のようになります。</p>
<div class="sourceCode" id="cb207"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span><span class="op">$</span><span class="va">date_onset</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>   <span class="co"># Rの基本的な構文で列を削除する</span></span></code></pre></div>
</div>
<div id="独立型" class="section level3 unnumbered">
<h3>独立型<a class="anchor" aria-label="anchor" href="#%E7%8B%AC%E7%AB%8B%E5%9E%8B"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> は、パイプ内で使用するだけでなく、独立したコマンドとして使用することもできます。この場合、最初の引数には前処理したい元のデータフレームを指定します。</p>
<div class="sourceCode" id="cb208"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># IDと年齢に関連した列を持つ新しいラインリストを作成する</span></span>
<span><span class="va">linelist_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">linelist</span>, <span class="va">case_id</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"age"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 列名を表示する</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist_age</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "case_id"  "age"      "age_unit"</code></pre>
<div id="パイプラインに追加" class="section level4 unnumbered">
<h4>パイプラインに追加<a class="anchor" aria-label="anchor" href="#%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%AB%E8%BF%BD%E5%8A%A0"><i class="fas fa-link"></i></a>
</h4>
<p><code>linelist_raw</code> データセットには、<code>row_num</code>、<code>merged_header</code>、<code>x28</code> という必要のない列があります。以下に、前処理パイプラインの <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> コマンドで削除する例を示します。</p>
<div class="sourceCode" id="cb210"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># パイプライン処理 (未加工データから始まり、クリーニングステップを経由してパイプで処理される)</span></span>
<span><span class="co">##################################################################################</span></span>
<span></span>
<span></span>
<span><span class="co"># パイプラインを開始する</span></span>
<span><span class="co">###########################</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    </span>
<span></span>
<span>     <span class="co"># 列名の標準化</span></span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span></span>
<span>     <span class="co"># 列名を個別に変更</span></span>
<span>           <span class="co">#新しい列名            #既存の列名</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>date_infection       <span class="op">=</span> <span class="va">infection_date</span>,</span>
<span>           date_hospitalisation <span class="op">=</span> <span class="va">hosp_date</span>,</span>
<span>           date_outcome         <span class="op">=</span> <span class="va">date_of_outcome</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>    <span class="co"># ここまでは、すでに説明したクリーニング手順</span></span>
<span>    <span class="co">#####################################################</span></span>
<span></span>
<span>   <span class="co"># 列の除外</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">row_num</span>, <span class="va">merged_header</span>, <span class="va">x28</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="重複行の削除" class="section level2" number="8.6">
<h2>
<span class="header-section-number">8.6</span> 重複行の削除<a class="anchor" aria-label="anchor" href="#%E9%87%8D%E8%A4%87%E8%A1%8C%E3%81%AE%E5%89%8A%E9%99%A4"><i class="fas fa-link"></i></a>
</h2>
<p>重複したデータを削除する方法の詳細については、このハンドブックの <a href="deduplication.html#deduplication">重複データの排除</a> の章を参照してください。本章では、重複した行の削除について、非常に簡単な例のみを紹介します。</p>
<p><strong>dplyr</strong> パッケージの <code><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct()</a></code> は、データフレーム内のすべての行をチェックし、重複していない行のみを残します。つまり、完全に重複している行をデータフレームから削除します。</p>
<p>重複する行をチェックする際には、列の範囲を指定できますが、デフォルトではデータフレーム内のすべての列が対象となります。<a href="deduplication.html#deduplication">重複データの排除</a> の章にあるように、対象となる列の範囲を調整して特定の列に関してのみ、重複した行があるかをチェックすることもできます。</p>
<p>以下は、空のコマンド <code><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct()</a></code> をパイプチェーンに追加するだけのシンプルな例です。これにより、他の行と完全に同一である行がない（重複している行がない）ことが保証されます（データフレーム内のすべての列がチェックされます）。</p>
<p>現時点の <code>linelist</code> データフレームには、全部で <code>nrow(linelist)</code> 行が含まれています。</p>
<div class="sourceCode" id="cb211"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>上のコードを実行して重複削除すると、データフレームの行数は <code>nrow(linelist)</code> になります。他の行と完全に同一である行が削除されました。</p>
<p>以下では、パイプラインに <code><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct()</a></code> コマンドを追加しています。</p>
<div class="sourceCode" id="cb212"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># パイプチェーン処理 (未加工データから始まり、クリーニングステップを経由してパイプで処理される)</span></span>
<span><span class="co">##################################################################################</span></span>
<span></span>
<span><span class="co"># パイプラインを開始する</span></span>
<span><span class="co">###########################</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    </span>
<span></span>
<span>     <span class="co"># 列名の標準化</span></span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>     <span class="co"># 列名を個別に変更</span></span>
<span>           <span class="co"># 新しい列名            # 既存の列名</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>date_infection       <span class="op">=</span> <span class="va">infection_date</span>,</span>
<span>           date_hospitalisation <span class="op">=</span> <span class="va">hosp_date</span>,</span>
<span>           date_outcome         <span class="op">=</span> <span class="va">date_of_outcome</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>    <span class="co"># 列の除去</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">row_num</span>, <span class="va">merged_header</span>, <span class="va">x28</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>    <span class="co"># ここまでは、すでに説明したクリーニング手順</span></span>
<span>    <span class="co">#####################################################</span></span>
<span>    </span>
<span>    <span class="co"># 重複の除去</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</div>
<div id="列の作成と変換" class="section level2" number="8.7">
<h2>
<span class="header-section-number">8.7</span> 列の作成と変換<a class="anchor" aria-label="anchor" href="#%E5%88%97%E3%81%AE%E4%BD%9C%E6%88%90%E3%81%A8%E5%A4%89%E6%8F%9B"><i class="fas fa-link"></i></a>
</h2>
<p>新しい列の追加や、既存の列の修正が必要な場合には、<strong>dplyr</strong> 系関数の <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> を使用することをおすすめします。</p>
<p>以下に、<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> を使用して新しい列を作成する例を紹介します。次のような構文を使用します：<code>mutate(new_column_name = value or transformation)</code></p>
<p>Stata の <code>generate</code> コマンドに似ていますが、R の <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> は既存の列を修正する場合にも使用できます。</p>
<div id="新しい列の作成" class="section level3 unnumbered">
<h3>新しい列の作成<a class="anchor" aria-label="anchor" href="#%E6%96%B0%E3%81%97%E3%81%84%E5%88%97%E3%81%AE%E4%BD%9C%E6%88%90"><i class="fas fa-link"></i></a>
</h3>
<p>以下は、<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> を使用して新しい列を作成する最も基本的なコマンドです。ここでは、すべての行の値が 10 である新しい列 <code>new_col</code> を作成します。</p>
<div class="sourceCode" id="cb213"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>new_col <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>また、他の列の値を参照して、計算を行うこともできます。以下では、<code>bmi</code> という新しい列が作成され、各症例（各行）の Body Mass Index（BMI）を格納しています。これは、既存の列である <code>ht_cm</code> と <code>wt_kg</code> を使用して、BMI = kg/m^2 の式で計算されたものです。</p>
<div class="sourceCode" id="cb214"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>bmi <span class="op">=</span> <span class="va">wt_kg</span> <span class="op">/</span> <span class="op">(</span><span class="va">ht_cm</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>新しい列を複数作成する場合は、それぞれをコンマで区切って改行します。以下は、<strong>stringr</strong> パッケージの <code><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue()</a></code> を使って他列の値を組み合わせた列を作成するなど、複数の新しい列を作成する場合の例です（<code><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue()</a></code> についての詳細は、<a href="characters-strings.html#characters-strings">文字型・文字列型データ</a> の章を参照ください）。</p>
<div class="sourceCode" id="cb215"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_col_demo</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                       </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    new_var_dup    <span class="op">=</span> <span class="va">case_id</span>,             <span class="co"># 新しい列＝既存の列のコピーを作成する</span></span>
<span>    new_var_static <span class="op">=</span> <span class="fl">7</span>,                   <span class="co"># 新しい列＝全ての値が同じ</span></span>
<span>    new_var_static <span class="op">=</span> <span class="va">new_var_static</span> <span class="op">+</span> <span class="fl">5</span>,  <span class="co"># 列を上書きしたり、他の変数を使って計算したりすることができる</span></span>
<span>    new_var_paste  <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"{hospital} on ({date_hospitalisation})"</span><span class="op">)</span> </span>
<span>    <span class="co"># 新しい列 = 他の列の値を貼り付ける</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">case_id</span>, <span class="va">hospital</span>, <span class="va">date_hospitalisation</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"new"</span><span class="op">)</span><span class="op">)</span>        </span>
<span><span class="co"># デモ用に新しい列のみを表示</span></span></code></pre></div>
<p>以下では、新しい列を確認するために、新しい列とそれを作成するために使用された列のみが表示されています。</p>
<div id="htmlwidget-fe9238480b107e7fc8f2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-fe9238480b107e7fc8f2">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],["Other",null,"St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Port Hospital",null,null,null,null,"Port Hospital","Military Hospital",null,null,"Other","Port Hospital","Port Hospital","Port Hospital",null,"Other","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)",null,"Other",null,"St. Marks Maternity Hopital (SMMH)","Military Hospital","Port Hospital","Central Hospital","Military Hospital","Central Hospital",null,"Military Hospital","Other",null,null,"Port Hospital","Port Hospital","Port Hospital",null,"Central Hospital","Military Hospital","Other","Other","Other",null,"St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)",null],["2014-05-15T00:00:00Z","2014-05-14T00:00:00Z","2014-05-18T00:00:00Z","2014-05-20T00:00:00Z","2014-05-22T00:00:00Z","2014-05-23T00:00:00Z","2014-05-29T00:00:00Z","2014-06-03T00:00:00Z","2014-06-06T00:00:00Z","2014-06-07T00:00:00Z","2014-06-08T00:00:00Z","2014-06-15T00:00:00Z","2014-06-17T00:00:00Z","2014-06-17T00:00:00Z","2014-06-20T00:00:00Z","2014-06-19T00:00:00Z","2014-06-23T00:00:00Z","2014-06-24T00:00:00Z","2014-06-27T00:00:00Z","2014-06-28T00:00:00Z","2014-06-29T00:00:00Z","2014-07-03T00:00:00Z","2014-07-09T00:00:00Z","2014-07-09T00:00:00Z","2014-07-11T00:00:00Z","2014-07-11T00:00:00Z","2014-07-13T00:00:00Z","2014-07-14T00:00:00Z","2014-07-14T00:00:00Z","2014-07-13T00:00:00Z","2014-07-14T00:00:00Z","2014-07-17T00:00:00Z","2014-07-17T00:00:00Z","2014-07-18T00:00:00Z","2014-07-19T00:00:00Z","2014-07-20T00:00:00Z","2014-07-20T00:00:00Z","2014-07-22T00:00:00Z","2014-07-24T00:00:00Z","2014-07-26T00:00:00Z","2014-07-24T00:00:00Z","2014-07-27T00:00:00Z","2014-07-25T00:00:00Z","2014-07-27T00:00:00Z","2014-07-31T00:00:00Z","2014-08-01T00:00:00Z","2014-08-03T00:00:00Z","2014-08-02T00:00:00Z","2014-08-02T00:00:00Z","2014-08-04T00:00:00Z"],["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],[12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12],["Other on (2014-05-15)","NA on (2014-05-14)","St. Mark's Maternity Hospital (SMMH) on (2014-05-18)","Port Hospital on (2014-05-20)","Military Hospital on (2014-05-22)","Port Hospital on (2014-05-23)","NA on (2014-05-29)","NA on (2014-06-03)","NA on (2014-06-06)","NA on (2014-06-07)","Port Hospital on (2014-06-08)","Military Hospital on (2014-06-15)","NA on (2014-06-17)","NA on (2014-06-17)","Other on (2014-06-20)","Port Hospital on (2014-06-19)","Port Hospital on (2014-06-23)","Port Hospital on (2014-06-24)","NA on (2014-06-27)","Other on (2014-06-28)","Port Hospital on (2014-06-29)","Port Hospital on (2014-07-03)","St. Mark's Maternity Hospital (SMMH) on (2014-07-09)","NA on (2014-07-09)","Other on (2014-07-11)","NA on (2014-07-11)","St. Marks Maternity Hopital (SMMH) on (2014-07-13)","Military Hospital on (2014-07-14)","Port Hospital on (2014-07-14)","Central Hospital on (2014-07-13)","Military Hospital on (2014-07-14)","Central Hospital on (2014-07-17)","NA on (2014-07-17)","Military Hospital on (2014-07-18)","Other on (2014-07-19)","NA on (2014-07-20)","NA on (2014-07-20)","Port Hospital on (2014-07-22)","Port Hospital on (2014-07-24)","Port Hospital on (2014-07-26)","NA on (2014-07-24)","Central Hospital on (2014-07-27)","Military Hospital on (2014-07-25)","Other on (2014-07-27)","Other on (2014-07-31)","Other on (2014-08-01)","NA on (2014-08-03)","St. Mark's Maternity Hospital (SMMH) on (2014-08-02)","St. Mark's Maternity Hospital (SMMH) on (2014-08-02)","NA on (2014-08-04)"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>hospital<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>new_var_dup<\/th>\n      <th>new_var_static<\/th>\n      <th>new_var_paste<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":4}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p><u><strong>ヒント</strong></u><strong>：</strong><code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> の変化形として、<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute()</a></code> という関数があります。この関数は、<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> と同じように新しい列を追加しますが、括弧の中に書かれていないすべての列を削除または除外します。</p>
<div class="sourceCode" id="cb216"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># HIDDEN FROM READER（ウェブ版には表示されない）</span></span>
<span><span class="co"># 上で新しく作成されたデモ用の列を除外する</span></span>
<span></span>
<span><span class="co"># linelist &lt;- linelist %&gt;% </span></span>
<span><span class="co">#   select(-contains("new_var"))</span></span></code></pre></div>
</div>
<div id="列のデータ型の変換" class="section level3 unnumbered">
<h3>列のデータ型の変換<a class="anchor" aria-label="anchor" href="#%E5%88%97%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E5%9E%8B%E3%81%AE%E5%A4%89%E6%8F%9B"><i class="fas fa-link"></i></a>
</h3>
<p>日付、数字、理論値（TRUE/FALSE）を含む列は、正しく分類された場合のみ期待通りの動きをします。例えば、文字型の “2” と数字型の 2 は異なることに注意してください。</p>
<p>データをインポートするコードの中に列のデータ型を指定する方法もありますが、扱いにくい場合が多いです。オブジェクトや列のデータ型を変換する方法については、<a href="basics.html#basics">R の基礎</a> の章の 3.10 オブジェクトのデータ型のセクションを参照してください。</p>
<p>本章では、まず、重要な列について、正しいデータ型であるかどうかのチェックを行ってみましょう。これは本章の最初に <code>skim()</code> を実行したときに確認しました。</p>
<p>では、具体的に見ていきましょう。現在、<code>age</code> 列のデータ型は 文字列型（character）ですが、定量的な分析を行うためには、<code>age</code> 列の数字が数値として認識される必要があります。</p>
<div class="sourceCode" id="cb217"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">age</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "character"</code></pre>
<p>以下で、<code>date_onset</code> 列のデータ型も確認してみると、文字列型であることがわかります。分析を行うためは、<code>date_onset</code> 列の日付が日付として認識される必要があります。</p>
<div class="sourceCode" id="cb219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">date_onset</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "character"</code></pre>
<p>このようなデータ型の相違を解決するために、<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> の機能を使用し、変換で列を再定義していきます。列の定義は変更しませんが、データ型を変更します。以下では、基本的な例として、<code>age</code> 列を数字型（numeric）に変換します。</p>
<div class="sourceCode" id="cb221"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>同様に、<code><a href="https://rdrr.io/r/base/character.html">as.character()</a></code> や <code><a href="https://rdrr.io/r/base/logical.html">as.logical()</a></code> を使用することもできます。因子型（factor）に変換したい場合は、<strong>base</strong> R の <code><a href="https://rdrr.io/r/base/factor.html">factor()</a></code> や <strong>forcats</strong> パッケージの <code><a href="https://forcats.tidyverse.org/reference/as_factor.html">as_factor()</a></code> を使いましょう。詳しくは、<a href="factors.html#factors">因子（ファクタ）型データ</a> の章をご覧ください。</p>
<p>日付型（date）への変換には注意が必要です。<a href="dates.html#dates">日付型データ</a> の章でいくつか方法を紹介しますが、通常、日付型への変換を正しく行うためには、日付データがすべて同じ形式である必要があります（例：“MM/DD/YYYY”、または “DD MM YYYY”）。データを日付型に変換した後にチェックして、各値が正しく変換されたことを確認してください。</p>
</div>
<div id="グループ化されたデータ" class="section level3 unnumbered">
<h3>グループ化されたデータ<a class="anchor" aria-label="anchor" href="#%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E5%8C%96%E3%81%95%E3%82%8C%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF"><i class="fas fa-link"></i></a>
</h3>
<p>データフレームがすでにグループ化されている場合（グループ化の詳細は、<a href="grouping.html#grouping">データのグループ化</a> の章を参照ください）は、<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> の動作がグループ化されていない場合と異なるかもしれません。データフレームがすでにグループ化されている場合、<code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code>、<code><a href="https://rdrr.io/r/stats/median.html">median()</a></code>、<code><a href="https://rdrr.io/r/base/Extremes.html">max()</a></code> などの要約関数は、すべての行ではなくグループごとに計算されます。</p>
<div class="sourceCode" id="cb222"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 全行の平均値で正規化された年齢</span></span>
<span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age_norm <span class="op">=</span> <span class="va">age</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">age</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 年齢を病院グループの平均値で正規化</span></span>
<span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">hospital</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age_norm <span class="op">=</span> <span class="va">age</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">age</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>グループ化されたデータフレームでの <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate ()</a></code> の使用については、こちらの <a href="https://dplyr.tidyverse.org/reference/mutate.html">tidyverse mutate に関するドキュメント</a> で詳しく説明されています。必要な方はご覧ください。</p>
</div>
<div id="clean_across" class="section level3 unnumbered">
<h3>複数列の一斉変換<a class="anchor" aria-label="anchor" href="#clean_across"><i class="fas fa-link"></i></a>
</h3>
<p>コードを簡潔にするために、同じ変換を行うコマンドを複数の列に適用したい場合があります。<strong>dplyr</strong> パッケージ（ <strong>tidyverse</strong> パッケージにも含まれています）の <code><a href="https://dplyr.tidyverse.org/reference/across.html">across()</a></code> を使用すると、データの変換を行うコマンドを一度に複数の列に適用することができます。 <code><a href="https://dplyr.tidyverse.org/reference/across.html">across()</a></code> はすべての <strong>dplyr</strong> 系関数で使用することができますが、一般的には <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> 内でよく使用されます。<code><a href="https://dplyr.tidyverse.org/reference/across.html">across()</a></code> を <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> 内でどのように使用するかについて知りたい方は、<a href="tables-descriptive.html#tables-descriptive">記述統計表の作り方</a> の章をご覧ください。</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/across.html">across()</a></code> では、<code>.cols =</code> 引数には列を指定し、<code>.fns =</code> 引数には適用する関数を指定します。<code>.fns</code> に与える追加の引数は、コンマの後に含めることができます。</p>
<div id="across-を使用して列を選択する" class="section level4 unnumbered">
<h4>
<code>across()</code> を使用して列を選択する<a class="anchor" aria-label="anchor" href="#across-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6%E5%88%97%E3%82%92%E9%81%B8%E6%8A%9E%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h4>
<p><code>.cols =</code> 引数に列を指定します。 個別に列名を指定することもできますし、“tidyselect” ヘルパー関数を使用することもできます。関数を <code>.fns =</code> 引数に指定します。以下に示すように、関数機能を使用すると、関数はその括弧（ ）なしで記述することに注意してください。</p>
<p>以下の例では、<code><a href="https://rdrr.io/r/base/character.html">as.character()</a></code> を使用した文字型への変換が、 <code><a href="https://dplyr.tidyverse.org/reference/across.html">across()</a></code> で指定された特定の列に適用されます。</p>
<div class="sourceCode" id="cb223"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span>.cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">ht_cm</span>, <span class="va">wt_kg</span><span class="op">)</span>, .fns <span class="op">=</span> <span class="va">as.character</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>列を指定する際には、“tidyselect” ヘルパー関数を使用すると便利です。“tidyselect” ヘルパー関数には、<code><a href="https://tidyselect.r-lib.org/reference/everything.html">everything()</a></code>、<code><a href="https://tidyselect.r-lib.org/reference/everything.html">last_col()</a></code>、<code>where()</code>、<code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with()</a></code>、<code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with()</a></code>、<code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains()</a></code>、<code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches()</a></code>、<code><a href="https://tidyselect.r-lib.org/reference/starts_with.html">num_range()</a></code>、<code><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of()</a></code> などがあり、本章上部の列の選択と並び替えのセクションで詳述されています。</p>
<p>まず、データフレーム内のすべての列を文字列型（character）に変換する例を以下に示します。</p>
<div class="sourceCode" id="cb224"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># すべての列を文字列型に変換する</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span>.cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, .fns <span class="op">=</span> <span class="va">as.character</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>他の例として、例えば列名に “date”という文字列が含まれている列を文字列型に変換したい場合のコマンドを以下に紹介します（コンマと括弧の配置に注意してください）。</p>
<div class="sourceCode" id="cb225"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># date という文字が列名に含まれている列を文字列型に変換する</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span>.cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span>, .fns <span class="op">=</span> <span class="va">as.character</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>また、別の例として、現在 POSIXct 型（未加工の日付時分秒を示すデータ型）の列を日付型（date）に変換する例を示します。まず、<code>is.POSIXct()</code> の評価値が <code>TRUE</code> である列を <code>where()</code> で検索し、次に、これらの列に <code><a href="https://rdrr.io/r/base/as.Date.html">as.Date()</a></code> を適用して、通常の 日付型（date）に変換します。</p>
<div class="sourceCode" id="cb226"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span>.cols <span class="op">=</span> <span class="fu">where</span><span class="op">(</span><span class="va">is.POSIXct</span><span class="op">)</span>, .fns <span class="op">=</span> <span class="va">as.Date</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<ul>
<li><p><code><a href="https://dplyr.tidyverse.org/reference/across.html">across()</a></code> 内で <code>where()</code> を使用し、<code>is.POSIXct()</code> で各列が TRUE または FALSE か評価できるようにしていることに注意してください。</p></li>
<li><p><code>is.POSIXct()</code>は <strong>lubridate</strong> パッケージの関数であることに注意してください。<code><a href="https://rdrr.io/r/base/character.html">is.character()</a></code>、<code><a href="https://rdrr.io/r/base/numeric.html">is.numeric()</a></code>、<code><a href="https://rdrr.io/r/base/logical.html">is.logical()</a></code> などの他の類似した “is” 系関数は <strong>base</strong> R の関数です。</p></li>
</ul>
</div>
<div id="across" class="section level4 unnumbered">
<h4>
<code>across()</code><a class="anchor" aria-label="anchor" href="#across"><i class="fas fa-link"></i></a>
</h4>
<p><code><a href="https://dplyr.tidyverse.org/reference/across.html">across()</a></code> に関数を与える方法の詳細については、<code><a href="https://dplyr.tidyverse.org/reference/across.html">?across</a></code> をコンソールで実行して表示されるドキュメントをお読みください。要約すると、対象の列に対して実行する関数を指定する方法はいくつかあり、独自の関数を指定することもできます。</p>
<ul>
<li><p>関数名のみを指定することができます（例：<code>mean</code> または <code>as.character</code>）。</p></li>
<li><p>関数を <strong>purrr</strong> スタイルで使用することができます（例：<code>~ mean(.x, na.rm = TRUE))</code> （詳細は、<a href="iteration.html#iteration">ループと反復処理・リストの操作</a> の章を参照してください）。</p></li>
<li>
<p>リストを使用することで、複数の関数を指定することができます（例：<code>list(mean = mean, n_miss = ~ sum(is.na(.x)))</code>）。</p>
<ul>
<li>複数の関数を指定した場合は、入力された列ごとに複数の変換後の列が返され、<code>col_fn</code> という形式で一意の名前が付けられます。返された列の名前を調整したい場合は、<code>.names =</code> 引数で <strong>glue</strong> パッケージの構文を使用してください（<strong>glue</strong> パッケージに関する詳細は、<a href="characters-strings.html#characters-strings">文字型・文字列型データ</a> の章を参照ください）。<code>{.col}</code> と <code>{.fn}</code> は入力された列と関数の省略形です。</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="coalesce" class="section level3 unnumbered">
<h3>
<code>coalesce()</code><a class="anchor" aria-label="anchor" href="#coalesce"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://dplyr.tidyverse.org/reference/coalesce.html">coalesce()</a></code> は、<strong>dplyr</strong> パッケージに含まれており、指定された値のうち、欠損値ではない最初の値を見つける関数です。この関数は、指定された順序で、取得された欠損値ではない最初の値で欠損値を埋めます。</p>
<p>ここでは、データフレーム以外の例を示します。2 つのベクトルがあるとします。1 つは患者の発見された村、もう 1 つは患者の居住地の村です。<code><a href="https://dplyr.tidyverse.org/reference/coalesce.html">coalesce()</a></code> を使用し、各ベクトルの欠損値ではない最初の値を見つけることができます。</p>
<div class="sourceCode" id="cb227"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">village_detection</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="cn">NA</span>,  <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="va">village_residence</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"c"</span>, <span class="st">"a"</span>, <span class="st">"d"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">village</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/coalesce.html">coalesce</a></span><span class="op">(</span><span class="va">village_detection</span>, <span class="va">village_residence</span><span class="op">)</span></span>
<span><span class="va">village</span>    <span class="co"># 結果を表示する</span></span></code></pre></div>
<pre><code>## [1] "a" "b" "a" "d"</code></pre>
<p><code><a href="https://dplyr.tidyverse.org/reference/coalesce.html">coalesce()</a></code> は、データフレームの列を対象とした場合にも同じように動作します。この関数は、指定した列の中で欠損地ではない最初の値を、新しい列の値として各行ごとに割り当てます。</p>
<div class="sourceCode" id="cb229"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>village <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/coalesce.html">coalesce</a></span><span class="op">(</span><span class="va">village_detection</span>, <span class="va">village_residence</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>これは、データフレームの行ごとに処理をしていく「行処理（row-wise 演算）」の一例です。より複雑な行処理については、本章下部の 8.12 行単位の計算 のセクションをご覧ください。</p>
</div>
<div id="累積計算" class="section level3 unnumbered">
<h3>累積計算<a class="anchor" aria-label="anchor" href="#%E7%B4%AF%E7%A9%8D%E8%A8%88%E7%AE%97"><i class="fas fa-link"></i></a>
</h3>
<p>データフレームの行を計算し、その時点までの累積和、平均、最小、最大などを列に反映させたい場合は、以下の関数を使用します。</p>
<p><code><a href="https://rdrr.io/r/base/cumsum.html">cumsum()</a></code> は、以下のように、累積和を返します。</p>
<div class="sourceCode" id="cb230"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span>,<span class="fl">15</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span>     <span class="co"># 1つの数字のみを返す</span></span></code></pre></div>
<pre><code>## [1] 31</code></pre>
<div class="sourceCode" id="cb232"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span>,<span class="fl">15</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span>  <span class="co"># 各ステップでの累積和を返す</span></span></code></pre></div>
<pre><code>## [1]  2  6 21 31</code></pre>
<p>これは、データフレームで新しい列を作るときに使用できます。例えば、アウトブレイクにおける一日あたりの累積症例数を知りたい場合は、次のようなコードを使って計算できます。</p>
<div class="sourceCode" id="cb234"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cumulative_case_counts</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="co"># 症例ラインリスト </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                 <span class="co"># 一日当たりの行数をカウント   </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cumulative_cases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span>  <span class="co"># 累積和の新しい列</span></span></code></pre></div>
<p>以下に、最初の 10 行を表示します。</p>
<div class="sourceCode" id="cb235"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">cumulative_case_counts</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    date_onset n cumulative_cases
## 1  2012-04-15 1                1
## 2  2012-05-05 1                2
## 3  2012-05-08 1                3
## 4  2012-05-31 1                4
## 5  2012-06-02 1                5
## 6  2012-06-07 1                6
## 7  2012-06-14 1                7
## 8  2012-06-21 1                8
## 9  2012-06-24 1                9
## 10 2012-06-25 1               10</code></pre>
<p>流行曲線（エピカーブ）で累積罹患率をプロットする方法については、<a href="epicurves.html#epicurves">流行曲線（エピカーブ）</a> の章をご覧ください。</p>
<p>関連項目：<a href="https://rdrr.io/r/base/cumsum.html"><code>cumsum()</code></a>、<code><a href="https://dplyr.tidyverse.org/reference/cumall.html">cummean()</a></code>、<a href="https://rdrr.io/r/base/cumsum.html"><code>cummin()</code></a>、<a href="https://rdrr.io/r/base/cumsum.html"><code>cummax()</code></a>、<code><a href="https://dplyr.tidyverse.org/reference/cumall.html">cumany()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/cumall.html">cumall()</a></code></p>
</div>
<div id="r-の基本パッケージ-base-を使用する" class="section level3 unnumbered">
<h3>R の基本パッケージ <strong>base</strong> を使用する<a class="anchor" aria-label="anchor" href="#r-%E3%81%AE%E5%9F%BA%E6%9C%AC%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8-base-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p><strong>base</strong> R を使って新しい列を定義する（または列を再定義する）こともできます。その場合は、新しい列（または修正する列）にデータフレームの名前を <code>$</code> でつないで書き、代入演算子 <code>&lt;-</code> を使って新しい値を定義します。<strong>base</strong> R を使用する際には、毎回、列名の前にデータフレーム名を指定しなければならないことを覚えておいてください（例：dataframe$column）。ここでは、<strong>base</strong> R を使用して 新しく <code>bmi</code> という列を作成する例を示します。</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="cleaning.html#cb237-1" aria-hidden="true" tabindex="-1"></a>linelist<span class="sc">$</span>bmi <span class="ot">=</span> linelist<span class="sc">$</span>wt_kg <span class="sc">/</span> (linelist<span class="sc">$</span>ht_cm <span class="sc">/</span> <span class="dv">100</span>) <span class="sc">^</span> <span class="dv">2</span><span class="er">)</span></span></code></pre></div>
</div>
<div id="パイプラインへの追加" class="section level3 unnumbered">
<h3>パイプラインへの追加<a class="anchor" aria-label="anchor" href="#%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%B8%E3%81%AE%E8%BF%BD%E5%8A%A0"><i class="fas fa-link"></i></a>
</h3>
<p><strong>以下では、パイプラインに新しい列を追加し、いくつかの列のデータ型を変換しています。</strong></p>
<div class="sourceCode" id="cb238"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># パイプライン処理 (未加工データから始まり、クリーニングステップを経由してパイプで処理される)</span></span>
<span><span class="co">##################################################################################</span></span>
<span></span>
<span></span>
<span><span class="co"># パイプラインの開始</span></span>
<span><span class="co">###########################</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    </span>
<span>  <span class="co"># 列名の標準化</span></span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>     <span class="co"># 列名を個別に変更</span></span>
<span>           <span class="co"># 新しい列名           #既存の列名</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>date_infection       <span class="op">=</span> <span class="va">infection_date</span>,</span>
<span>           date_hospitalisation <span class="op">=</span> <span class="va">hosp_date</span>,</span>
<span>           date_outcome         <span class="op">=</span> <span class="va">date_of_outcome</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span></span>
<span>    <span class="co"># 列の除去</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">row_num</span>, <span class="va">merged_header</span>, <span class="va">x28</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>    <span class="co"># 重複行の削除</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>    <span class="co"># ここまでは、すでに説明したクリーニング手順</span></span>
<span>    <span class="co">###################################################</span></span>
<span>    <span class="co"># 新しい列の追加</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>bmi <span class="op">=</span> <span class="va">wt_kg</span> <span class="op">/</span> <span class="op">(</span><span class="va">ht_cm</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>    <span class="co"># 列のデータ型を変換</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span>, <span class="va">as.Date</span><span class="op">)</span>, </span>
<span>           generation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">generation</span><span class="op">)</span>,</span>
<span>           age        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
</div>
</div>
<div id="値の再定義" class="section level2" number="8.8">
<h2>
<span class="header-section-number">8.8</span> 値の再定義<a class="anchor" aria-label="anchor" href="#%E5%80%A4%E3%81%AE%E5%86%8D%E5%AE%9A%E7%BE%A9"><i class="fas fa-link"></i></a>
</h2>
<p>以下のような場合には、値を再定義（変更）する必要があります。</p>
<ul>
<li><p>特定の値を編集する場合（例：日付の年号や書式が間違っている場合など）。</p></li>
<li><p>同じ綴りでない値を調整する場合。</p></li>
<li><p>カテゴリ値の新しい列を作成する場合。</p></li>
<li><p>数値カテゴリの新しい列を作成する（例：年齢カテゴリ）。</p></li>
</ul>
<div id="特定の値" class="section level3 unnumbered">
<h3>特定の値<a class="anchor" aria-label="anchor" href="#%E7%89%B9%E5%AE%9A%E3%81%AE%E5%80%A4"><i class="fas fa-link"></i></a>
</h3>
<p>値を手動で変更するためには、<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> 内で <code><a href="https://dplyr.tidyverse.org/reference/recode.html">recode()</a></code> を使用します。</p>
<p>例えば、データの中に意味のない日付（例：“2014-14-15”）があるとします。未加工の元データ上でマニュアルで日付を修正することもできますし、<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> と <code><a href="https://dplyr.tidyverse.org/reference/recode.html">recode()</a></code> を使用して前処理パイプラインに日付を修正するコマンドを書き込むこともできます。後者の方がより透明性と再現性が高く、行われた分析を理解しようとする第三者や同じように分析しようとする人にとって、分析を再現しやすくなります。</p>
<div class="sourceCode" id="cb239"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 間違っている値の修正                    # 既存の値     # 新しい値</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>date_onset <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op">(</span><span class="va">date_onset</span>, <span class="st">"2014-14-15"</span> <span class="op">=</span> <span class="st">"2014-04-15"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>上の例の <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> の行は、「<code>date_onset</code> 列内の間違っている値を新しい値に変換し、<code>date_onset</code> 列に再定義する」と読むことができます。<code><a href="https://dplyr.tidyverse.org/reference/recode.html">recode()</a></code> のパターン（既存の値 = 新しい値）は、ほとんどの R の関数のパターン（新しい値 = 既存の値）とは逆であることに注意してください。R の開発コミュニティでは、この相違の統一化に取り組んでいます。</p>
<p><strong>以下に、別の例として、1 つの列において複数の値を再定義する例を紹介します。</strong></p>
<p><code>linelist</code> の <code>hospital</code> 列には、いくつか綴り（つづり）が間違った値があることに加え、多くの欠損値があるため、<code>hospital</code> 列の値をクリーニングする必要があります。</p>
<div class="sourceCode" id="cb240"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">hospital</span>, useNA <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span>  </span></code></pre></div>
<pre><code>## 
##                      Central Hopital                     Central Hospital 
##                                   11                                  457 
##                           Hospital A                           Hospital B 
##                                  290                                  289 
##                     Military Hopital                    Military Hospital 
##                                   32                                  798 
##                     Mitylira Hopital                    Mitylira Hospital 
##                                    1                                   79 
##                                Other                         Port Hopital 
##                                  907                                   48 
##                        Port Hospital St. Mark's Maternity Hospital (SMMH) 
##                                 1756                                  417 
##   St. Marks Maternity Hopital (SMMH)                                 &lt;NA&gt; 
##                                   11                                 1512</code></pre>
<div class="sourceCode" id="cb242"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="co"># 欠損値を含むすべての一意の値のテーブルを表示する</span></span></code></pre></div>
<p>以下の <code><a href="https://dplyr.tidyverse.org/reference/recode.html">recode()</a></code> コマンドでは、指定した複数の値を書き換え、<code>hospital</code> 列を再定義しています。既存の値から新しい値に書き換えるそれぞれのコードの後にコンマを忘れないようにしてください。</p>
<div class="sourceCode" id="cb243"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op">(</span><span class="va">hospital</span>,</span>
<span>                     <span class="co"># 参照:     既存の値 = 新しい値</span></span>
<span>                      <span class="st">"Mitylira Hopital"</span>  <span class="op">=</span> <span class="st">"Military Hospital"</span>,</span>
<span>                      <span class="st">"Mitylira Hospital"</span> <span class="op">=</span> <span class="st">"Military Hospital"</span>,</span>
<span>                      <span class="st">"Military Hopital"</span>  <span class="op">=</span> <span class="st">"Military Hospital"</span>,</span>
<span>                      <span class="st">"Port Hopital"</span>      <span class="op">=</span> <span class="st">"Port Hospital"</span>,</span>
<span>                      <span class="st">"Central Hopital"</span>   <span class="op">=</span> <span class="st">"Central Hospital"</span>,</span>
<span>                      <span class="st">"other"</span>             <span class="op">=</span> <span class="st">"Other"</span>,</span>
<span>                      <span class="st">"St. Marks Maternity Hopital (SMMH)"</span> <span class="op">=</span> <span class="st">"St. Mark's Maternity Hospital (SMMH)"</span></span>
<span>                      <span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>上のコードを実行すると、 <code>hospital</code> 列内で間違った綴りの値が修正され、正しい綴りの値のグループに統合されていることがわかります。</p>
<div class="sourceCode" id="cb244"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">hospital</span>, useNA <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##                     Central Hospital                           Hospital A 
##                                  468                                  290 
##                           Hospital B                    Military Hospital 
##                                  289                                  910 
##                                Other                        Port Hospital 
##                                  907                                 1804 
## St. Mark's Maternity Hospital (SMMH)                                 &lt;NA&gt; 
##                                  428                                 1512</code></pre>
<p><u><strong>ヒント</strong></u>：等号（=）の前後には、スペースをいくつか入れても問題ありません。コードを読みやすくするために、すべての行またはほとんどの行で等号（=）の場所を揃えることをおすすめします。また、ハッシュタグでコメント行を追加し、どちらが古い値でどちらが新しい値なのかを、第三者に明確にわかるようにすることも大事なポイントです。</p>
<p><u><strong>ヒント</strong></u>：データセットの中には、空白文字の値が存在することがあります（これは、R の欠損値である NA として認識されません）。このような値を参照するためには、2 つの引用符をスペースを空けずに（““）使用します。</p>
</div>
<div id="論理条件" class="section level3 unnumbered">
<h3>論理条件<a class="anchor" aria-label="anchor" href="#%E8%AB%96%E7%90%86%E6%9D%A1%E4%BB%B6"><i class="fas fa-link"></i></a>
</h3>
<p>以下では、論理条件を使用して列の値を再定義する方法を説明します。</p>
<ul>
<li><p>単純な論理条件：<code><a href="https://rdrr.io/r/base/replace.html">replace()</a></code>、<code><a href="https://rdrr.io/r/base/ifelse.html">ifelse()</a></code>、<code><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else()</a></code> を使う</p></li>
<li><p>複雑な論理条件：<code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code> を使う</p></li>
</ul>
</div>
<div id="単純な論理条件" class="section level3 unnumbered">
<h3>単純な論理条件<a class="anchor" aria-label="anchor" href="#%E5%8D%98%E7%B4%94%E3%81%AA%E8%AB%96%E7%90%86%E6%9D%A1%E4%BB%B6"><i class="fas fa-link"></i></a>
</h3>
<div id="replace" class="section level4 unnumbered">
<h4>
<code>replace()</code><a class="anchor" aria-label="anchor" href="#replace"><i class="fas fa-link"></i></a>
</h4>
<p><code><a href="https://rdrr.io/r/base/replace.html">replace()</a></code> は <strong>base</strong> R の関数で、論理条件を使って変更する行を指定します。一般的な構文は以下の通りです。</p>
<p><code>mutate(col_to_change = replace(col_to_change, criteria for rows, new value))</code></p>
<p><code><a href="https://rdrr.io/r/base/replace.html">replace()</a></code> を使用する一般的な状況としては、一意の行識別子（症例ごとの ID 番号など）を使用して、1 つの行の 1 つの値だけを変更する場合です。下の例では、<code>case_id</code> が「2195」である行の性別を “Female”に変更しています。</p>
<div class="sourceCode" id="cb246"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 例：ある特定の観測データの性別を "Female" に変更する</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>gender <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span><span class="op">(</span><span class="va">gender</span>, <span class="va">case_id</span> <span class="op">==</span> <span class="st">"2195"</span>, <span class="st">"Female"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>R の基本的な構文と角括弧 [ ] を使った同等のコマンドは、以下の通りです。<code>linelist</code> データフレームの <code>gender</code> 列の値を（<code>linelist</code> の <code>case_id</code> 列の値が「2195」である行について）“Female” に変更する、と読めます。</p>
<div class="sourceCode" id="cb247"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span><span class="op">$</span><span class="va">gender</span><span class="op">[</span><span class="va">linelist</span><span class="op">$</span><span class="va">case_id</span> <span class="op">==</span> <span class="st">"2195"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Female"</span></span></code></pre></div>
</div>
<div id="ifelse-と-if_else" class="section level4 unnumbered">
<h4>
<code>ifelse()</code> と <code>if_else()</code><a class="anchor" aria-label="anchor" href="#ifelse-%E3%81%A8-if_else"><i class="fas fa-link"></i></a>
</h4>
<p>簡潔な論理条件のためのツールとして、<code><a href="https://rdrr.io/r/base/ifelse.html">ifelse()</a></code> とそのパートナーである <code><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else()</a></code> があります。しかし、ほとんどの場合、再定義のためには<code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code>（以下に詳述）を使ったほうがわかりやすいでしょう。これらの “if else” コマンドは、<code>if</code> と<code>else</code> のプログラミング文を簡略化したものです。一般的な構文は以下の通りです。</p>
<p><code>ifelse(condition, value to return if condition evaluates to TRUE, value to return if condition evaluates to FALSE)</code></p>
<p>下の例では、<code>source_known</code> という列が新しく定義されています。既存の列 <code>source</code> の値が欠損していなければ、<code>source_known</code> 列の値は “known” に設定され、<code>source</code> 列の値が欠落している場合は、 “unknown” に設定されます。</p>
<div class="sourceCode" id="cb248"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>source_known <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">source</span><span class="op">)</span>, <span class="st">"known"</span>, <span class="st">"unknown"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else()</a></code> は、日付を扱う <strong>dplyr</strong> の特別バージョンです。真（TRUE）の値が日付の場合、「偽（FALSE）」の値も日付でなければならないことに注意してください。そのため、単に NA ではなく NA_real_ という特別な値を使用しています。</p>
<div class="sourceCode" id="cb249"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#  患者が死亡していない場合はNAとなる死亡日の列を作成する</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>date_death <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">==</span> <span class="st">"Death"</span>, <span class="va">date_outcome</span>, <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>ifelseコマンドをたくさん並べるのは避けましょう…</strong>代わりに<code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code>を使ってください！<code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code> の方がずっと読みやすく、エラーも少なくなります。</p>
<div class="inline-figure"><img src="images/ifelse%20bad.png" width="100%" style="display: block; margin: auto;"></div>
<p>データフレーム以外で、コード内で使用するオブジェクトの値を切り替えたい場合は、<strong>base</strong> R の<code><a href="https://rdrr.io/r/base/switch.html">switch()</a></code> の使用を検討してください。</p>
</div>
</div>
<div id="clean_case_when" class="section level3 unnumbered">
<h3>複雑な論理条件<a class="anchor" aria-label="anchor" href="#clean_case_when"><i class="fas fa-link"></i></a>
</h3>
<p>ある変数を複数のグループに分ける場合や、複雑な論理条件文を使って値を再定義する必要がある場合は、<strong>dplyr</strong> の <code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code> を使用します。この関数は、データフレーム内のすべての行を計算し、その行が指定された基準を満たしているかどうかを評価して、正しい値を新しく割り当てます。</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code> コマンドは、右側（Right-Hand Side: RHS）左側（Left-Hand Side: LHS）をチルダ <code>~</code> で区切ったコードで構成されています。各コードの左側には論理条件が、右側には準拠値が記述されて、コンマで区切られています。</p>
<p>例えば、ここでは <code>age</code> と <code>age_unit</code> の列を利用して <code>age_years</code> の列を作成しています。</p>
<div class="sourceCode" id="cb250"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age_years <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>            <span class="va">age_unit</span> <span class="op">==</span> <span class="st">"years"</span>  <span class="op">~</span> <span class="va">age</span>,       <span class="co"># 年齢が年単位の場合</span></span>
<span>            <span class="va">age_unit</span> <span class="op">==</span> <span class="st">"months"</span> <span class="op">~</span> <span class="va">age</span><span class="op">/</span><span class="fl">12</span>,    <span class="co"># 年齢が月単位の場合</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">age_unit</span><span class="op">)</span>      <span class="op">~</span> <span class="va">age</span>,       </span>
<span>            <span class="co"># 年齢の単位が見つからない場合は、年を仮定</span></span>
<span>            <span class="cn">TRUE</span>                 <span class="op">~</span> <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span> <span class="co">#その他の状況では、欠損値とする</span></span></code></pre></div>
<p>データの各行が評価されるとき、<code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code> 内に書かれたコードの順に、上から下へと適用・評価されます。ある行で一番上の基準が <code>TRUE</code>と評価された場合、右側（RHS）の値が割り当てられ、残りの基準はその行では確認されません。したがって、最も明確な基準を最初に書き、最も一般的な基準を最後に書くのがよいでしょう。</p>
<p>このようにして、最後の文では、左側（LHS）に <code>TRUE</code> を置くことで、前の基準のどれにも当てはまらない行を評価することができます。この文の右側（RHS）は、 “check me!” のような値や欠損値を割り当てることができます。</p>
<p><span style="color: red;">警告：右側の値はすべて同じデータ型でなければなりません。欠損値（NA）を割り当てるには、NA_character_、<code>NA_real_</code>（数値や POSIX の場合）、<code>as.Date(NA)</code>など、データ型によって異なる NA を使用する必要があるかもしれません。詳しくは、日付型データの章の<a href="https://epirhandbook.com/en/working-with-dates.html#working-with-dates-1">日付の操作</a> のセクションをご覧ください。</span></p>
</div>
<div id="欠損値-1" class="section level3 unnumbered">
<h3>欠損値<a class="anchor" aria-label="anchor" href="#%E6%AC%A0%E6%90%8D%E5%80%A4-1"><i class="fas fa-link"></i></a>
</h3>
<p>以下は、データクリーニングの観点から欠損値を処理するための特別な関数です。</p>
<p>論理的に欠損値をテストする <code><a href="https://rdrr.io/r/base/NA.html">is.na()</a></code> などの関数について知りたい場合など、欠損値の識別と処理に関して詳しく学びたい方は、<a href="missing-data">欠損データの処理</a> の章を参照してください。</p>
<p><strong><code><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na()</a></code></strong></p>
<p>欠損値（NA）を “Missing” などの特定の値に変更する場合は、<strong>dplyr</strong> パッケージに含まれる <code><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na()</a></code> を<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> 内で使用します。これは、上記の <code>recode</code> と同じように使用されることに注意してください 。対象となる変数の名前は、<code><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na()</a></code> 内で再度明記される必要があります。</p>
<div class="sourceCode" id="cb251"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span><span class="op">(</span><span class="va">hospital</span>, <span class="st">"Missing"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>fct_explicit_na()</strong></p>
<p><code><a href="https://forcats.tidyverse.org/reference/fct_explicit_na.html">fct_explicit_na()</a></code> は、<strong>forcats</strong> パッケージに含まれている関数です。<strong>forcats</strong> パッケージは、因子（ファクタ）型の列を扱います。因子型は、<code>c("First", "Second", "Third")</code> のような順序付きの値を扱うための R の方法であり、表やプロットに表示される値（病院など）の順序を設定します。詳細は、<a href="factors.html#factors">因子（ファクタ）型データ</a> の章を参照してください。</p>
<p>データが因子型で、<code><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na()</a></code> を使って <code>NA</code> を “Missing” に変換しようとすると、以下のようなエラーが表示されます。</p>
<p><code>invalid factor level, NA generated.</code></p>
<p>“Missing” を因子型がとれるレベルとして定義せずに追加しようとしたため、エラーとなります。</p>
<p>この問題を解決する最も簡単な方法は、<strong>forcats</strong> パッケージの <code><a href="https://forcats.tidyverse.org/reference/fct_explicit_na.html">fct_explicit_na()</a></code> を使用することです。この関数は、列を因子型に変換し、<code>NA</code> 値を文字型の “(Missing)” に変換します。</p>
<div class="sourceCode" id="cb252"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_explicit_na.html">fct_explicit_na</a></span><span class="op">(</span><span class="va">hospital</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>もう一つ、さらに手間がかかる方法ですが、<code><a href="https://forcats.tidyverse.org/reference/fct_expand.html">fct_expand()</a></code> を用いて因子型を追加し、その後、欠損値を変換しても同じ結果を得ることができます。</p>
<p><strong><code><a href="https://dplyr.tidyverse.org/reference/na_if.html">na_if()</a></code></strong></p>
<p>特定の値を <code>NA</code> に変換するには、<strong>dplyr</strong> の <code><a href="https://dplyr.tidyverse.org/reference/na_if.html">na_if()</a></code> を使います。以下のコマンドは <code><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na()</a></code> とは逆の操作を行います。以下の例では、列 <code>hospital</code> の “Missing” の値はすべて <code>NA</code> に変換されます。</p>
<div class="sourceCode" id="cb253"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/na_if.html">na_if</a></span><span class="op">(</span><span class="va">hospital</span>, <span class="st">"Missing"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>注意： <code><a href="https://dplyr.tidyverse.org/reference/na_if.html">na_if()</a></code> は論理的条件（例：“all values &gt; 99”）には使用できません。このような論理的条件には、<code><a href="https://rdrr.io/r/base/replace.html">replace()</a></code> または <code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code> を使用してください。</p>
<div class="sourceCode" id="cb254"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 40度以上の温度をNAに変換する </span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">temp</span> <span class="op">&gt;</span> <span class="fl">40</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2000年1月1日以前の発症日を欠損に変換する</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>date_onset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span><span class="op">(</span><span class="va">date_onset</span>, <span class="va">date_onset</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2000-01-01"</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="クリーニングディクショナリcleaning-dictionary" class="section level3 unnumbered">
<h3>クリーニングディクショナリ（Cleaning dictionary）<a class="anchor" aria-label="anchor" href="#%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0%E3%83%87%E3%82%A3%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%8A%E3%83%AAcleaning-dictionary"><i class="fas fa-link"></i></a>
</h3>
<p>R の <strong>linelist</strong> パッケージに含まれる関数 <code>clean_variable_spelling()</code> を使用し、データフレームをクリーニングディクショナリを用いて前処理します。 <strong>linelist</strong> は <a href="https://github.com/reconhub/linelist">RECON</a>（R Epidemics Consortium）によって開発されたパッケージです。</p>
<ol style="list-style-type: decimal">
<li>まず、クリーニングディクショナリを作成します。クリーニングディクショナリは、以下の 3 つの列で構成される必要があります。</li>
</ol>
<ul>
<li><p>from 列（不正な値）</p></li>
<li><p>to 列（正しい値）</p></li>
<li><p>変更を適用する列を指定する列（すべての列に変更を適用する場合は、“.global” と記入する）</p></li>
</ul>
<p>注意：.globalのディクショナリ項目は、列固有のディクショナリ項目によって上書きされます。</p>
<div class="inline-figure"><img src="images/cleaning_dict.png" width="100%" style="display: block; margin: auto;"></div>
<ol start="2" style="list-style-type: decimal">
<li>本章では、<a href="data-used.html#data-used">ハンドブックとデータのダウンロード</a> の章にあるクリーニングディクショナリを例として使用しますので、上のリンクからダウンロードし、インポートしてください。</li>
</ol>
<div class="sourceCode" id="cb255"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cleaning_dict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"cleaning_dict.csv"</span><span class="op">)</span></span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>
<u>未加工の</u>ラインリストを <code>clean_variable_spelling()</code> に渡し、<code>wordlists =</code> 引数にインポートしたクリーニングディクショナリを指定します。<code>spelling_vars =</code> 引数は、ディクショナリのどの列を参照するかを指定するために使用できます（デフォルトでは3番目）。また、ディクショナリを文字列型の列と因子型の列すべてに適用するために、<code>spelling_vars =</code> 引数を <code>NULL</code> に設定することもできます。この関数の実行には時間がかかることに注意してください。</li>
</ol>
<div class="sourceCode" id="cb256"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">linelist</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/linelist/man/clean_variable_spelling.html">clean_variable_spelling</a></span><span class="op">(</span></span>
<span>    wordlists <span class="op">=</span> <span class="va">cleaning_dict</span>,</span>
<span>    spelling_vars <span class="op">=</span> <span class="st">"col"</span>,        </span>
<span>     <span class="co"># 参照する列名を含む列を指定する</span></span>
<span>     <span class="co">#（デフォルトではディクショナリの3番目の列になる）</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>以下の表を右側にスクロールすると、上のコマンドを実行後に値がどのように変化したかがわかります。特に、性別の変化（小文字から大文字に変換された）や、すべての症状の列が yes/no の 2 択から 1/0 の 2 択に変化したことに注目してください。</p>
<div id="htmlwidget-c649cdaa12f37144aa1c" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-c649cdaa12f37144aa1c">{"x":{"filter":"top","vertical":false,"filterHTML":"<tr>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"2\" data-max=\"13\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1399075200000\" data-max=\"1406419200000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1399939200000\" data-max=\"1407024000000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1400025600000\" data-max=\"1407110400000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1400371200000\" data-max=\"1410566400000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"-13.2697246824573\" data-max=\"-13.209391925612\" data-scale=\"13\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"8.45171855856465\" data-max=\"8.48802917129884\" data-scale=\"14\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"67\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\" disabled=\"\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"100\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"11\" data-max=\"241\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"20\" data-max=\"24\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"35.9\" data-max=\"38\" data-scale=\"1\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"428.994082840237\" data-scale=\"14\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"67\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],[4,4,2,3,3,3,4,4,4,4,4,4,6,5,6,9,10,8,7,6,7,6,8,6,10,8,6,12,5,8,7,9,11,5,8,5,6,11,7,9,7,8,9,12,13,9,8,10,8,7],["2014-05-08",null,null,"2014-05-04","2014-05-18","2014-05-03","2014-05-22","2014-05-28",null,null,"2014-05-30","2014-05-28","2014-06-14","2014-06-07","2014-06-09",null,null,null,"2014-06-23","2014-06-18","2014-06-24",null,null,"2014-07-03",null,"2014-07-10","2014-06-14",null,"2014-06-18","2014-06-29","2014-07-02","2014-07-12","2014-07-12","2014-06-13","2014-07-15","2014-06-20",null,null,"2014-07-20",null,"2014-07-12","2014-07-19","2014-07-18","2014-07-18","2014-07-27",null,"2014-07-19","2014-07-26","2014-07-24",null],["2014-05-13","2014-05-13","2014-05-16","2014-05-18","2014-05-21","2014-05-22","2014-05-27","2014-06-02","2014-06-05","2014-06-05","2014-06-06","2014-06-13","2014-06-16","2014-06-17","2014-06-18","2014-06-19","2014-06-22","2014-06-23","2014-06-25","2014-06-26","2014-06-28","2014-07-02","2014-07-08","2014-07-09","2014-07-09","2014-07-10","2014-07-12","2014-07-12","2014-07-13","2014-07-13","2014-07-14","2014-07-15","2014-07-16","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-22","2014-07-22","2014-07-24","2014-07-24","2014-07-25","2014-07-25","2014-07-27","2014-07-29","2014-07-30",null,"2014-08-01","2014-08-02","2014-08-03"],["2014-05-15","2014-05-14","2014-05-18","2014-05-20","2014-05-22","2014-05-23","2014-05-29","2014-06-03","2014-06-06","2014-06-07","2014-06-08","2014-06-15","2014-06-17","2014-06-17","2014-06-20","2014-06-19","2014-06-23","2014-06-24","2014-06-27","2014-06-28","2014-06-29","2014-07-03","2014-07-09","2014-07-09","2014-07-11","2014-07-11","2014-07-13","2014-07-14","2014-07-14","2014-07-13","2014-07-14","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-20","2014-07-20","2014-07-22","2014-07-24","2014-07-26","2014-07-24","2014-07-27","2014-07-25","2014-07-27","2014-07-31","2014-08-01","2014-08-03","2014-08-02","2014-08-02","2014-08-04"],[null,"2014-05-18","2014-05-30",null,"2014-05-29","2014-05-24","2014-06-01","2014-06-07","2014-06-18","2014-06-09","2014-06-15",null,"2014-07-09",null,"2014-06-30","2014-07-11","2014-07-01","2014-06-25","2014-07-06","2014-07-02","2014-07-09","2014-07-07","2014-07-20",null,"2014-07-22","2014-07-16","2014-07-14","2014-07-20","2014-07-16","2014-07-19","2014-07-27","2014-07-19",null,"2014-07-26","2014-08-14","2014-08-01","2014-07-23","2014-08-28","2014-07-28","2014-07-19",null,"2014-08-03",null,null,null,"2014-08-06","2014-08-21","2014-09-13","2014-08-04",null],[null,"Recover","Recover",null,"Recover","Recover","Recover","Death","Recover","Death","Death","Death","Recover","Recover",null,"Recover",null,null,"Death","Death","Recover",null,null,null,"Death",null,"Death","Death",null,"Death","Recover","Death","Recover","Death","Recover",null,"Death","Recover","Recover","Death",null,null,"Death","Death","Death","Death","Recover",null,"Death","Death"],["M","F","M","F","M","F","F","F","M","F","M","M","M","F","F","M","F","F","F","F","M","M","F","M","F","M","M","F","M","F","F","F","M","M","F","M","F","F","F","M","F","M","F","M","M","F","M","F","M","M"],["Other",null,"St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Port Hospital",null,null,null,null,"Port Hospital","Military Hospital",null,null,"Other","Port Hospital","Port Hospital","Port Hospital",null,"Other","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)",null,"Other",null,"St. Mark's Maternity Hospital (SMMH)","Military Hospital","Port Hospital","Central Hospital","Military Hospital","Central Hospital",null,"Military Hospital","Other",null,null,"Port Hospital","Port Hospital","Port Hospital",null,"Central Hospital","Military Hospital","Other","Other","Other",null,"St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)",null],[-13.2157351064963,-13.2152339775486,-13.212910703914,-13.2363711169728,-13.2228638912441,-13.222625321098,-13.2331547837254,-13.2320975453153,-13.2225511595637,-13.2572163655863,-13.2206286746001,-13.253989309478,-13.2385127873491,-13.209391925612,-13.2157278814899,-13.2243437095992,-13.2336087079551,-13.21422143145,-13.2339681355349,-13.2535640411465,-13.2250089377786,-13.2160657166043,-13.2680671272333,-13.2266742923612,-13.2160179088168,-13.2482584611565,-13.2156319199566,-13.2142410663192,-13.2614879104088,-13.2452992638476,-13.2630592726116,-13.2343341712241,-13.2199077448676,-13.2227293309912,-13.2343062806506,-13.218781651651,-13.2483677722899,-13.2097478342339,-13.2680867723786,-13.2587535457526,-13.262635786914,-13.2697246824573,-13.2209026809759,-13.2330734719715,-13.2680923666905,-13.2547212675054,-13.2573683214693,-13.2137356012883,-13.2175973322257,-13.2486407324245],[8.46897295100924,8.45171855856465,8.46481700596819,8.4754761613651,8.46082377490923,8.46183062600728,8.46272931462646,8.46144367534271,8.46191259217774,8.47292327643506,8.48401630165138,8.45837125340844,8.47761705512509,8.47570184950483,8.47779946878972,8.47145134147474,8.47804840685363,8.48528034195779,8.46957530395867,8.45957352078114,8.47404889511544,8.48802917129884,8.473437335922,8.48408263734462,8.46242233645879,8.47026822126572,8.46398447480533,8.4641347894342,8.45623094629607,8.48334624336805,8.47493999153642,8.47832062438022,8.4693933891765,8.48480589906514,8.47121232619015,8.48438437371817,8.48466158574339,8.47714159984428,8.46238127010609,8.45568597813113,8.4632880274758,8.47940722413856,8.46353857052336,8.46178968158864,8.47508713872833,8.45825808128071,8.4532568143863,8.4732571907655,8.47911586641933,8.48480340615605],["f547d6",null,null,"f90f5f","11f8ea","aec8ec","893f25","133ee7",null,null,"996f3a","133ee7","37a6f6","9f6884","4802b1",null,null,null,"a75c7f","8e104d","ab634e",null,null,"b799eb",null,"5d9e4d","a15e13",null,"ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277",null,null,"d6584f",null,"312ecf","52ea64","cfd79c","d145b7","174288",null,"53608c","3b096b","f5c142",null],["other",null,null,"other","other","other","other","other",null,null,"other","other","other","other","other",null,null,null,"other","other","other",null,null,"other",null,"other","other",null,"other","funeral","other","funeral","other","other","other","funeral",null,null,"other",null,"other","other","other","other","other",null,"funeral","other","other",null],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years"],[27,25,91,41,36,56,47,0,86,69,67,84,68,44,34,66,78,47,53,47,71,86,53,69,38,46,68,37,100,56,50,57,65,72,29,69,37,48,54,71,47,61,47,35,53,16,13,59,69,67],[48,59,238,135,71,116,87,11,226,174,112,186,174,90,91,152,214,137,117,131,150,241,131,161,80,69,188,66,233,142,110,182,164,214,26,157,39,154,133,168,100,125,123,67,134,31,36,125,183,169],[22,22,21,23,23,21,21,22,22,22,22,22,22,21,23,22,23,21,22,23,21,23,21,24,23,22,24,23,20,24,24,20,24,21,22,21,23,22,23,23,23,22,23,22,22,22,23,22,22,22],["0",null,null,"0","0","0",null,"0","0","0","0","0","0","0","0","0","0","0",null,"0","0","0","0","0",null,"0","0","0",null,null,"0","0",null,"0","0",null,null,"0","0",null,"0","0",null,"0","0","0","0","0","0",null],["0",null,null,"0","0","0",null,"0","0","0","0","0","0","0","0","0","1","0",null,"0","0","0","1","0",null,"0","0","1",null,null,"0","0",null,"0","0",null,null,"0","0",null,"0","0",null,"0","1","0","0","0","0",null],["1",null,null,"0","1","1",null,"1","1","1","1","1","1","1","1","1","1","1",null,"1","1","1","1","1",null,"1","1","1",null,null,"1","1",null,"1","1",null,null,"1","1",null,"1","1",null,"1","1","1","1","1","0",null],["0",null,null,"0","0","0",null,"0","0","0","0","0","0","0","0","1","0","0",null,"0","0","0","0","0",null,"0","0","0",null,null,"0","0",null,"0","0",null,null,"1","1",null,"0","0",null,"0","0","0","0","0","0",null],["1",null,null,"0","1","1",null,"1","1","0","1","0","0","0","1","0","0","0",null,"0","1","0","0","0",null,"0","0","0",null,null,"0","1",null,"1","1",null,null,"1","1",null,"1","1",null,"1","1","0","1","1","1",null],[36.8,36.9,36.9,36.8,36.9,37.6,37.3,37,36.4,35.9,36.5,36.9,36.5,37.1,36.5,37.3,37,38,38,36,37,36.7,36.9,36.5,37,36.5,37.6,36.6,36.6,36.2,36.4,37.1,37.5,37.5,37.4,36.9,36.4,37.3,37,37.8,36.5,37.5,36.7,37,37.3,36.6,36.5,36.6,37.6,36.8],[null,"09:36","16:48","11:22","12:60","14:13","14:33","09:25","11:16","10:55","16:03","11:14","12:42","11:06","09:10","08:45",null,"15:41","13:34","18:58","12:43","16:33","14:29","07:18","08:11","16:32","16:17","07:32","17:45",null,"13:24","14:43","02:33","11:36","17:28","16:27",null,"20:49",null,"11:38","14:25","13:42","21:22","13:33","19:06","17:14","20:09",null,"10:23","09:09"],[117.1875,71.8184429761563,16.0652496292635,22.4965706447188,71.4144019043841,41.6171224732461,62.0953890870657,0,16.8376536925366,22.7903289734443,53.4119897959184,24.2802636142907,22.4600343506408,54.320987654321,41.0578432556455,28.5664819944598,17.0320552013276,25.0412914912888,38.7172182043977,27.3876813705495,31.5555555555556,14.8069075945662,30.8839811199813,26.6193433895297,59.375,96.6183574879227,19.2394748755093,84.9403122130395,18.4199377406104,27.7722674072605,41.3223140495868,17.2080666586161,24.1671624033314,15.7218971089178,428.994082840237,27.9930220292912,243.261012491782,20.2395007589813,30.527446435638,25.15589569161,47,39.04,31.0661643201798,77.9683671196257,29.5165961238583,166.493236212279,100.308641975309,37.76,20.6037803457852,23.458562375267],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>generation<\/th>\n      <th>date_infection<\/th>\n      <th>date_onset<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>date_outcome<\/th>\n      <th>outcome<\/th>\n      <th>gender<\/th>\n      <th>hospital<\/th>\n      <th>lon<\/th>\n      <th>lat<\/th>\n      <th>infector<\/th>\n      <th>source<\/th>\n      <th>age<\/th>\n      <th>age_unit<\/th>\n      <th>wt_kg<\/th>\n      <th>ht_cm<\/th>\n      <th>ct_blood<\/th>\n      <th>fever<\/th>\n      <th>chills<\/th>\n      <th>cough<\/th>\n      <th>aches<\/th>\n      <th>vomit<\/th>\n      <th>temp<\/th>\n      <th>time_admission<\/th>\n      <th>bmi<\/th>\n      <th>age_years<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,9,10,13,15,16,17,23,25,26]}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>クリーニングディクショナリの <code>col</code> 列に記入される列名は、クリーニングする時点での列名と同一でなければならないことに注意してください。詳細については、<a href="https://www.repidemicsconsortium.org/linelist/reference/clean_data.html">こちら</a> の <strong>linelist</strong> パッケージのドキュメントを参照してください。</p>
<div id="パイプチェーンへの追加" class="section level4 unnumbered">
<h4>パイプチェーンへの追加<a class="anchor" aria-label="anchor" href="#%E3%83%91%E3%82%A4%E3%83%97%E3%83%81%E3%82%A7%E3%83%BC%E3%83%B3%E3%81%B8%E3%81%AE%E8%BF%BD%E5%8A%A0"><i class="fas fa-link"></i></a>
</h4>
<p>以下では、いくつかの新しい列と列変換がパイプチェーンに追加されています。</p>
<div class="sourceCode" id="cb257"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#クリーニングパイプチェーン (未加工データから始まり、クリーニングステップ経由してパイプで処理される)</span></span>
<span><span class="co">##################################################################################</span></span>
<span></span>
<span><span class="co"># パイプチェーンの処理開始</span></span>
<span><span class="co">###########################</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    </span>
<span> </span>
<span>     <span class="co"># 列名の構文の標準化</span></span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span></span>
<span>     <span class="co"># 手動で列名を変更</span></span>
<span>           <span class="co"># 新しい列名             # 既存の列名</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>date_infection       <span class="op">=</span> <span class="va">infection_date</span>,</span>
<span>           date_hospitalisation <span class="op">=</span> <span class="va">hosp_date</span>,</span>
<span>           date_outcome         <span class="op">=</span> <span class="va">date_of_outcome</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>    <span class="co"># 列の除去</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">row_num</span>, <span class="va">merged_header</span>, <span class="va">x28</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>    <span class="co"># 重複除去</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>    <span class="co"># 列を追加</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>bmi <span class="op">=</span> <span class="va">wt_kg</span> <span class="op">/</span> <span class="op">(</span><span class="va">ht_cm</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>     </span>
<span></span>
<span>    <span class="co"># 列のデータ型を変換</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span>, <span class="va">as.Date</span><span class="op">)</span>, </span>
<span>           generation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">generation</span><span class="op">)</span>,</span>
<span>           age        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>    <span class="co"># 列の追加: 入院の遅れ</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>days_onset_hosp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">date_hospitalisation</span> <span class="op">-</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>    <span class="co"># ここまでは、すでに説明したクリーニング手順</span></span>
<span>   <span class="co">###################################################</span></span>
<span></span>
<span>    <span class="co"># 病院の列の値をクリーニングする</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op">(</span><span class="va">hospital</span>,</span>
<span>                      <span class="co"># OLD = NEW</span></span>
<span>                      <span class="st">"Mitylira Hopital"</span>  <span class="op">=</span> <span class="st">"Military Hospital"</span>,</span>
<span>                      <span class="st">"Mitylira Hospital"</span> <span class="op">=</span> <span class="st">"Military Hospital"</span>,</span>
<span>                      <span class="st">"Military Hopital"</span>  <span class="op">=</span> <span class="st">"Military Hospital"</span>,</span>
<span>                      <span class="st">"Port Hopital"</span>      <span class="op">=</span> <span class="st">"Port Hospital"</span>,</span>
<span>                      <span class="st">"Central Hopital"</span>   <span class="op">=</span> <span class="st">"Central Hospital"</span>,</span>
<span>                      <span class="st">"other"</span>             <span class="op">=</span> <span class="st">"Other"</span>,</span>
<span>                      <span class="st">"St. Marks Maternity Hopital (SMMH)"</span> <span class="op">=</span> <span class="st">"St. Mark's Maternity Hospital (SMMH)"</span></span>
<span>                      <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span><span class="op">(</span><span class="va">hospital</span>, <span class="st">"Missing"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span></span>
<span>    <span class="co"># age_years 列を新しく作成する (age 列と age_unit 列を使用する)</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age_years <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>          <span class="va">age_unit</span> <span class="op">==</span> <span class="st">"years"</span> <span class="op">~</span> <span class="va">age</span>,</span>
<span>          <span class="va">age_unit</span> <span class="op">==</span> <span class="st">"months"</span> <span class="op">~</span> <span class="va">age</span><span class="op">/</span><span class="fl">12</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">age_unit</span><span class="op">)</span> <span class="op">~</span> <span class="va">age</span>,</span>
<span>          <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="num_cats" class="section level2" number="8.9">
<h2>
<span class="header-section-number">8.9</span> 数値カテゴリ<a class="anchor" aria-label="anchor" href="#num_cats"><i class="fas fa-link"></i></a>
</h2>
<p>ここでは、数値データをカテゴリ化する方法を説明します。一般的な例としては、年齢のカテゴリー化や、検査結果のグループ化などがあります。ここでは、以下について説明します。</p>
<ul>
<li><p><code>age_categories()</code> ( <strong>epikit</strong> パッケージより)</p></li>
<li><p><code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code>（<strong>base</strong> Rより）</p></li>
<li><p><code>case_when(</code>)</p></li>
<li><p><code><a href="https://rdrr.io/r/stats/quantile.html">quantile()</a></code> と <code><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile()</a></code> を使った分位数による分割</p></li>
</ul>
<div id="分布を確認する" class="section level3 unnumbered">
<h3>分布を確認する<a class="anchor" aria-label="anchor" href="#%E5%88%86%E5%B8%83%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p>例として、<code>age_years</code> 列を使用して新たに <code>age_cat</code> 列を作成していきます。</p>
<div class="sourceCode" id="cb258"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># linelistのage列のデータ型をチェックする</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">age_years</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "numeric"</code></pre>
<p>まずデータの分布を確認し、適切な分割点（カットポイント）を作ります。詳しくは <a href="ggplot-basics.html#ggplot-basics">ggplot の基礎</a> の章をご覧ください。</p>
<div class="sourceCode" id="cb260"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 分布を確認する</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">age_years</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-214-1.png" width="672" height="50%"></div>
<div class="sourceCode" id="cb261"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">age_years</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
##    0.00    6.00   13.00   16.04   23.00   84.00     107</code></pre>
<p><span style="color: orange;"><strong>注意</strong>：数字型のデータが文字列型としてインポートされることがあります。これは、値の一部に数字以外の文字が含まれている場合に発生します。例えば、年齢を「2ヶ月」と入力した場合や、（R のロケール設定にもよりますが）小数点の代わりにコンマが使用されている場合などです（例：“4,5” が 4 年半の意味で使われている場合）。</span></p>
<!-- ======================================================= -->
</div>
<div id="age_categories" class="section level3 unnumbered">
<h3>
<code>age_categories()</code><a class="anchor" aria-label="anchor" href="#age_categories"><i class="fas fa-link"></i></a>
</h3>
<p><strong>epikit</strong> パッケージの <code>age_categories()</code> を使用すると、数値列の分類やラベル付けを簡単に行うことができます（注：この関数は、年齢以外の数値変数にも適用できます）。結果として出力される列は、自動的に順序付けられたカテゴリーとなります。</p>
<p>入力する必要がある項目は、以下の通りです。</p>
<ul>
<li><p>数値のベクトル（列）</p></li>
<li><p><code>breakers =</code> 引数：新しいグループの分割点の数値ベクトルを指定する。</p></li>
</ul>
<p>まず、簡単な例を示します。</p>
<div class="sourceCode" id="cb263"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 簡単な例</span></span>
<span><span class="co">################</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">epikit</span><span class="op">)</span>                     <span class="co">#パッケージの読み込み</span></span>
<span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    age_cat <span class="op">=</span> <span class="fu">age_categories</span><span class="op">(</span>             <span class="co"># 新しい列の作成</span></span>
<span>      <span class="va">age_years</span>,                           <span class="co"># 分割点によってグループ化する数値列</span></span>
<span>      breakers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">20</span>,       <span class="co"># 分割点</span></span>
<span>                   <span class="fl">30</span>, <span class="fl">40</span>, <span class="fl">50</span>, <span class="fl">60</span>, <span class="fl">70</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># テーブルを表示</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">age_cat</span>, useNA <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##   0-4   5-9 10-14 15-19 20-29 30-39 40-49 50-59 60-69   70+  &lt;NA&gt; 
##  1227  1223  1048   827  1216   597   251    78    27     7   107</code></pre>
<p>指定した分割点によるグループ分けは、デフォルトでは下限の値から始まります。つまり、下限の値は「上位」のグループに含まれ、グループが下または左に「開いている」状態になります。下図のように、各分割点に1を加えることで、上または右で開いたグループにすることができます。</p>
<div class="sourceCode" id="cb265"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 同じカテゴリーの上端を含める</span></span>
<span><span class="co">############################################</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    age_cat <span class="op">=</span> <span class="fu">age_categories</span><span class="op">(</span></span>
<span>      <span class="va">age_years</span>, </span>
<span>      breakers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">6</span>, <span class="fl">11</span>, <span class="fl">16</span>, <span class="fl">21</span>, <span class="fl">31</span>, <span class="fl">41</span>, <span class="fl">51</span>, <span class="fl">61</span>, <span class="fl">71</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># テーブルを表示</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">age_cat</span>, useNA <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##   0-5  6-10 11-15 16-20 21-30 31-40 41-50 51-60 61-70   71+  &lt;NA&gt; 
##  1469  1195  1040   770  1149   547   231    70    24     6   107</code></pre>
<p><code>separator =</code> を使用すると、ラベルの表示方法を調整できます。 デフォルトは “-” です。</p>
<p>また、<code>ceiling =</code> を使用し、分割点として指定された数値のうち最大の値の扱い方を調整できます。<code>ceiling = TRUE</code> と設定すると、指定された分割点の最大値が「上限（ceiling）」となり、最大値を超えるカテゴリ “XX+” は作成されません。分割点の最大値（または <code>upper =</code> 引数が使用されている場合は、その値）を超える値は、<code>NA</code> に分類されます。以下は、<code>ceiling = TRUE</code> の例で、XX+ のカテゴリは作成されず、70（分割点の最大値）を超える値は <code>NA</code> として割り当てられます。</p>
<div class="sourceCode" id="cb267"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 上限をTRUEに設定した場合</span></span>
<span><span class="co">##########################</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    age_cat <span class="op">=</span> <span class="fu">age_categories</span><span class="op">(</span></span>
<span>      <span class="va">age_years</span>, </span>
<span>      breakers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">40</span>, <span class="fl">50</span>, <span class="fl">60</span>, <span class="fl">70</span><span class="op">)</span>,</span>
<span>      ceiling <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="co"># 70 が上限となり、70 以上の値は NA となる</span></span>
<span></span>
<span><span class="co"># テーブルを表示</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">age_cat</span>, useNA <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##   0-4   5-9 10-14 15-19 20-29 30-39 40-49 50-59 60-70  &lt;NA&gt; 
##  1227  1223  1048   827  1216   597   251    78    28   113</code></pre>
<p>また、<code>breakers =</code> の代わりに、<code>lower＝</code>、<code>upper＝</code>、<code>by＝</code> のすべてを指定することもできます。</p>
<ul>
<li><p><code>lower =</code> 下限となる値（デフォルトは 0）</p></li>
<li><p><code>upper =</code> 上限となる値</p></li>
<li><p><code>by =</code> グループ内の年の数</p></li>
</ul>
<div class="sourceCode" id="cb269"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    age_cat <span class="op">=</span> <span class="fu">age_categories</span><span class="op">(</span></span>
<span>      <span class="va">age_years</span>, </span>
<span>      lower <span class="op">=</span> <span class="fl">0</span>,</span>
<span>      upper <span class="op">=</span> <span class="fl">100</span>,</span>
<span>      by <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># テーブルの表示</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">age_cat</span>, useNA <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##   0-9 10-19 20-29 30-39 40-49 50-59 60-69 70-79 80-89 90-99  100+  &lt;NA&gt; 
##  2450  1875  1216   597   251    78    27     6     1     0     0   107</code></pre>
<p>詳細は、age_categories() のヘルプページをご覧ください（R コンソールで <code>?age_categories</code> と入力してください）。</p>
<!-- ======================================================= -->
</div>
<div id="cut" class="section level3 unnumbered">
<h3>
<code>cut()</code><a class="anchor" aria-label="anchor" href="#cut"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code> は <code>age_categories()</code> に代わる <strong>base</strong> R の関数ですが、<code>age_categories()</code> と比較すると複雑です。以下の説明を読むと、この処理を簡単にするために <code>age_categories()</code> が開発されたことがわかると思います。<code>age_categories()</code> との注目すべき違いは、以下のとおりです。</p>
<ul>
<li><p>別のパッケージをインストール・ロードする必要がない。</p></li>
<li><p>グループが右か左に開いているか閉じているかを指定できる。</p></li>
<li><p>正確なラベルを自分で用意する必要がある。</p></li>
<li><p>一番下のグループに “0” を入れたい場合は、その旨を明記する必要がある。</p></li>
</ul>
<p><code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code> の基本的な構文は、まず分割したい数値列（<code>age_years</code>）を指定し、次に <u>breaks</u> 引数に分割点の数値ベクトル <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> を指定します。<code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code> を使用すると、結果として出力される列は順序付けられたカテゴリとなります。</p>
<p>デフォルトでは、右または上側が「オープン」で包括的（左または下側が「クローズ」で排他的）になるように分類されます。これは、<code>age_categories()</code> 関数とは逆の動作です。デフォルトのラベルでは “(A, B]” という表記が使われており、これは「Aは含まれないがBは含まれる」という意味です。<code>right = TRUE</code> <strong>に設定することで、この動作を逆にすることができます。</strong></p>
<p>デフォルトでは、“0” の値は一番下のグループから除外され、<code>NA</code> に分類されることに注意してください。乳幼児が 0 歳としてコードされているデータもあるので、注意が必要です。これを変更するには、引数 <code>include.latest = TRUE</code> を追加して、“0” の値が一番下のグループに含まれるようにします。この場合、自動的に作成される一番下のカテゴリのラベルは “[A],B]” となります。なお、<code>include.latest = TRUE</code> を指定し、かつ <code>right = TRUE</code> を指定した場合、含まれるのは最小値ではなく最大値の分割点とカテゴリーに適用されることに注意してください。</p>
<p><code>labels =</code> 引数を使って、カスタマイズされたラベルのベクトルを指定することができます。手作業で指定する必要があるため、間違えのないように十分注意してください。後述するように、クロス集計を用いて作業を確認してください。</p>
<p><code>age_years</code> に <code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code> を使用して、新しい変数 <code>age_cat</code> を作成した例を以下に示します。</p>
<div class="sourceCode" id="cb271"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 年齢変数を分割してカテゴリ化した変数を新しく作る</span></span>
<span><span class="co"># 下限の分割点は除外されるが、上限の分割点は各カテゴリに含まれる</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    age_cat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span></span>
<span>      <span class="va">age_years</span>,</span>
<span>      breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">20</span>,</span>
<span>                 <span class="fl">30</span>, <span class="fl">50</span>, <span class="fl">70</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>      include.lowest <span class="op">=</span> <span class="cn">TRUE</span>         </span>
<span>      <span class="op">)</span><span class="op">)</span>              <span class="co"># 一番下のグループに0を入れる</span></span>
<span></span>
<span><span class="co"># グループごとの観測値の数を集計する</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">age_cat</span>, useNA <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##    [0,5]   (5,10]  (10,15]  (15,20]  (20,30]  (30,50]  (50,70] (70,100] 
##     1469     1195     1040      770     1149      778       94        6 
##     &lt;NA&gt; 
##      107</code></pre>
<p><strong>分割した結果を確認してください！！！</strong>数値列とカテゴリ列をクロス集計して、各年齢値が正しいカテゴリに割り当てられていることを検証します。特に、境界値の割り当てを確認してください（例：隣接するカテゴリが 10-15 と 16-20 の場合、15 の値がどこに割り当てられているか）。</p>
<div class="sourceCode" id="cb273"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 数値列とカテゴリ列のクロス集計</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="st">"Numeric Values"</span> <span class="op">=</span> <span class="va">linelist</span><span class="op">$</span><span class="va">age_years</span>,   <span class="co"># 分かりやすくするために、表の中に名前を入れる</span></span>
<span>      <span class="st">"Categories"</span>     <span class="op">=</span> <span class="va">linelist</span><span class="op">$</span><span class="va">age_cat</span>,</span>
<span>      useNA <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span>                        <span class="co"># NA値の検証を忘れずに</span></span></code></pre></div>
<pre><code>##                     Categories
## Numeric Values       [0,5] (5,10] (10,15] (15,20] (20,30] (30,50] (50,70]
##   0                    136      0       0       0       0       0       0
##   0.0833333333333333     1      0       0       0       0       0       0
##   0.25                   2      0       0       0       0       0       0
##   0.333333333333333      6      0       0       0       0       0       0
##   0.416666666666667      1      0       0       0       0       0       0
##   0.5                    6      0       0       0       0       0       0
##   0.583333333333333      3      0       0       0       0       0       0
##   0.666666666666667      3      0       0       0       0       0       0
##   0.75                   3      0       0       0       0       0       0
##   0.833333333333333      1      0       0       0       0       0       0
##   0.916666666666667      1      0       0       0       0       0       0
##   1                    275      0       0       0       0       0       0
##   1.5                    2      0       0       0       0       0       0
##   2                    308      0       0       0       0       0       0
##   3                    246      0       0       0       0       0       0
##   4                    233      0       0       0       0       0       0
##   5                    242      0       0       0       0       0       0
##   6                      0    241       0       0       0       0       0
##   7                      0    256       0       0       0       0       0
##   8                      0    239       0       0       0       0       0
##   9                      0    245       0       0       0       0       0
##   10                     0    214       0       0       0       0       0
##   11                     0      0     220       0       0       0       0
##   12                     0      0     224       0       0       0       0
##   13                     0      0     191       0       0       0       0
##   14                     0      0     199       0       0       0       0
##   15                     0      0     206       0       0       0       0
##   16                     0      0       0     186       0       0       0
##   17                     0      0       0     164       0       0       0
##   18                     0      0       0     141       0       0       0
##   19                     0      0       0     130       0       0       0
##   20                     0      0       0     149       0       0       0
##   21                     0      0       0       0     158       0       0
##   22                     0      0       0       0     149       0       0
##   23                     0      0       0       0     125       0       0
##   24                     0      0       0       0     144       0       0
##   25                     0      0       0       0     107       0       0
##   26                     0      0       0       0     100       0       0
##   27                     0      0       0       0     117       0       0
##   28                     0      0       0       0      85       0       0
##   29                     0      0       0       0      82       0       0
##   30                     0      0       0       0      82       0       0
##   31                     0      0       0       0       0      68       0
##   32                     0      0       0       0       0      84       0
##   33                     0      0       0       0       0      78       0
##   34                     0      0       0       0       0      58       0
##   35                     0      0       0       0       0      58       0
##   36                     0      0       0       0       0      33       0
##   37                     0      0       0       0       0      46       0
##   38                     0      0       0       0       0      45       0
##   39                     0      0       0       0       0      45       0
##   40                     0      0       0       0       0      32       0
##   41                     0      0       0       0       0      34       0
##   42                     0      0       0       0       0      26       0
##   43                     0      0       0       0       0      31       0
##   44                     0      0       0       0       0      24       0
##   45                     0      0       0       0       0      27       0
##   46                     0      0       0       0       0      25       0
##   47                     0      0       0       0       0      16       0
##   48                     0      0       0       0       0      21       0
##   49                     0      0       0       0       0      15       0
##   50                     0      0       0       0       0      12       0
##   51                     0      0       0       0       0       0      13
##   52                     0      0       0       0       0       0       7
##   53                     0      0       0       0       0       0       4
##   54                     0      0       0       0       0       0       6
##   55                     0      0       0       0       0       0       9
##   56                     0      0       0       0       0       0       7
##   57                     0      0       0       0       0       0       9
##   58                     0      0       0       0       0       0       6
##   59                     0      0       0       0       0       0       5
##   60                     0      0       0       0       0       0       4
##   61                     0      0       0       0       0       0       2
##   62                     0      0       0       0       0       0       1
##   63                     0      0       0       0       0       0       5
##   64                     0      0       0       0       0       0       1
##   65                     0      0       0       0       0       0       5
##   66                     0      0       0       0       0       0       3
##   67                     0      0       0       0       0       0       2
##   68                     0      0       0       0       0       0       1
##   69                     0      0       0       0       0       0       3
##   70                     0      0       0       0       0       0       1
##   72                     0      0       0       0       0       0       0
##   73                     0      0       0       0       0       0       0
##   76                     0      0       0       0       0       0       0
##   84                     0      0       0       0       0       0       0
##   &lt;NA&gt;                   0      0       0       0       0       0       0
##                     Categories
## Numeric Values       (70,100] &lt;NA&gt;
##   0                         0    0
##   0.0833333333333333        0    0
##   0.25                      0    0
##   0.333333333333333         0    0
##   0.416666666666667         0    0
##   0.5                       0    0
##   0.583333333333333         0    0
##   0.666666666666667         0    0
##   0.75                      0    0
##   0.833333333333333         0    0
##   0.916666666666667         0    0
##   1                         0    0
##   1.5                       0    0
##   2                         0    0
##   3                         0    0
##   4                         0    0
##   5                         0    0
##   6                         0    0
##   7                         0    0
##   8                         0    0
##   9                         0    0
##   10                        0    0
##   11                        0    0
##   12                        0    0
##   13                        0    0
##   14                        0    0
##   15                        0    0
##   16                        0    0
##   17                        0    0
##   18                        0    0
##   19                        0    0
##   20                        0    0
##   21                        0    0
##   22                        0    0
##   23                        0    0
##   24                        0    0
##   25                        0    0
##   26                        0    0
##   27                        0    0
##   28                        0    0
##   29                        0    0
##   30                        0    0
##   31                        0    0
##   32                        0    0
##   33                        0    0
##   34                        0    0
##   35                        0    0
##   36                        0    0
##   37                        0    0
##   38                        0    0
##   39                        0    0
##   40                        0    0
##   41                        0    0
##   42                        0    0
##   43                        0    0
##   44                        0    0
##   45                        0    0
##   46                        0    0
##   47                        0    0
##   48                        0    0
##   49                        0    0
##   50                        0    0
##   51                        0    0
##   52                        0    0
##   53                        0    0
##   54                        0    0
##   55                        0    0
##   56                        0    0
##   57                        0    0
##   58                        0    0
##   59                        0    0
##   60                        0    0
##   61                        0    0
##   62                        0    0
##   63                        0    0
##   64                        0    0
##   65                        0    0
##   66                        0    0
##   67                        0    0
##   68                        0    0
##   69                        0    0
##   70                        0    0
##   72                        1    0
##   73                        3    0
##   76                        1    0
##   84                        1    0
##   &lt;NA&gt;                      0  107</code></pre>
<p><strong><code>NA</code>値の再ラベル付け</strong></p>
<p><code>NA</code> 値に “Missing” などのラベルを付けたい場合があります。新しく作成した列は因子型（制限付き型）であるため、この値は拒否されるので、単純に <code><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na()</a></code> で変換させることはできません。代わりに、<a href="factors.html#factors">因子（ファクタ）型データ</a> の章で説明されているように、<strong>forcats</strong> パッケージの <code><a href="https://forcats.tidyverse.org/reference/fct_explicit_na.html">fct_explicit_na()</a></code> を使用してください。</p>
<div class="sourceCode" id="cb275"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>   <span class="co"># cut()すると、因子型のage_catが自動的に作成される </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age_cat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span></span>
<span>    <span class="va">age_years</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">50</span>, <span class="fl">70</span>, <span class="fl">100</span><span class="op">)</span>,          </span>
<span>    right <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    include.lowest <span class="op">=</span> <span class="cn">TRUE</span>,        </span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"0-4"</span>, <span class="st">"5-9"</span>, <span class="st">"10-14"</span>, <span class="st">"15-19"</span>, <span class="st">"20-29"</span>, <span class="st">"30-49"</span>, <span class="st">"50-69"</span>, <span class="st">"70-100"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         </span>
<span>    <span class="co"># 欠損値を明示する</span></span>
<span>    age_cat <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_explicit_na.html">fct_explicit_na</a></span><span class="op">(</span></span>
<span>      <span class="va">age_cat</span>,</span>
<span>      na_level <span class="op">=</span> <span class="st">"Missing age"</span><span class="op">)</span>  </span>
<span>  <span class="op">)</span>    <span class="co"># ラベルを指定することができる</span></span>
<span></span>
<span><span class="co"># 各カテゴリに含まれる数値の数を表で表示する</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">age_cat</span>, useNA <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##         0-4         5-9       10-14       15-19       20-29       30-49 
##        1227        1223        1048         827        1216         848 
##       50-69      70-100 Missing age        &lt;NA&gt; 
##         105           7         107           0</code></pre>
<p><strong>切れ目やラベルを素早く作る</strong></p>
<p>ベクトルの改行やラベルを素早く作成するには、以下のような方法があります。<code><a href="https://rdrr.io/r/base/seq.html">seq()</a></code> や <code><a href="https://rdrr.io/r/base/rep.html">rep()</a></code> については、<a href="basics.html#basics">R の基礎</a> の章を参照してください。</p>
<div class="sourceCode" id="cb277"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 0から90までのブレークポイントを5で割る</span></span>
<span><span class="va">age_seq</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="fl">90</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">age_seq</span></span>
<span></span>
<span><span class="co"># デフォルトのcut()の設定を前提に、上記のカテゴリのラベルを作成する</span></span>
<span><span class="va">age_labels</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">age_seq</span> <span class="op">+</span> <span class="fl">1</span>, <span class="st">"-"</span>, <span class="va">age_seq</span> <span class="op">+</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">age_labels</span></span>
<span></span>
<span><span class="co"># 両方のベクトルが同じ長さであることを確認する</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">age_seq</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">age_labels</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code> の詳細については、Rコンソールで <code><a href="https://rdrr.io/r/base/cut.html">?cut</a></code> と入力し、表示されるヘルプページを参照してください。</p>
</div>
<div id="四分位数による分割" class="section level3 unnumbered">
<h3>四分位数による分割<a class="anchor" aria-label="anchor" href="#%E5%9B%9B%E5%88%86%E4%BD%8D%E6%95%B0%E3%81%AB%E3%82%88%E3%82%8B%E5%88%86%E5%89%B2"><i class="fas fa-link"></i></a>
</h3>
<p>一般的な理解では、「クォンタイル（quantile）」または「パーセンタイル（percentile）」は、通常、下になる値の割合を指します。例えば、<code>linelist</code> の年齢の 95 パーセンタイルは、年齢の 95 %が該当する年齢になります。</p>
<p>しかし、一般的には、「四分位数」や「十分位数」は、データのグループを 4 つまたは 10 のグループに均等に分けたものを指すことがあります（グループよりも分割点が 1 つ多いことに注意してください）。</p>
<p>四分位数を取得するには、<strong>base</strong> R に含まれている <strong>stats</strong> の <code><a href="https://rdrr.io/r/stats/quantile.html">quantile()</a></code> を使用します。データセットの列などの数値ベクトルと、0 から 1.0 までの確率の数値ベクトルを指定します。分割点は、数値ベクトルとして返されます。<code><a href="https://rdrr.io/r/stats/quantile.html">?quantile</a></code> を入力すると、統計的手法の詳細を調べることができます。</p>
<p>入力された数値ベクトルに欠損値がある場合は、<code>na.rm = TRUE</code> を設定することをお勧めします。</p>
<p><code>names = FALSE</code> を設定すると、名前のない数値ベクトルが得られます。</p>
<div class="sourceCode" id="cb278"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">age_years</span>,             <span class="co"># 演算する数値ベクトルを指定</span></span>
<span>  probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.25</span>, <span class="fl">.50</span>, <span class="fl">.75</span>, <span class="fl">.90</span>, <span class="fl">.95</span><span class="op">)</span>,  <span class="co"># 欲しいパーセンタイルを指定</span></span>
<span>  na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>                          <span class="co"># 欠損値を無視する</span></span></code></pre></div>
<pre><code>##  0% 25% 50% 75% 90% 95% 
##   0   6  13  23  33  41</code></pre>
<p><code><a href="https://rdrr.io/r/stats/quantile.html">quantile()</a></code> の結果は、<code>age_categories()</code> や <code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code> の分割点として使用できます。以下では、<code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code> を使って新しい列 <code>deciles</code> を作成し、<code>age_years</code> に対して <code>quantiles()</code> を使って区切りを定義しています。<strong>janitor</strong> の <code>tabyl()</code> を使って結果を表示し、各グループのパーセンテージを見ることができます（詳細は、<a href="tables-descriptive.html#tables-descriptive">記述統計表の作り方</a> の章を参照ください）。各グループ、正確に 10 %ではないことに注意してください。</p>
<div class="sourceCode" id="cb280"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                              <span class="co">#linelistから開始。</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>deciles <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">age_years</span>,        <span class="co"># 新しい列を作る。 age_years列をcut()でdecileに格納。</span></span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span>                   <span class="co"># quantile()を使ってカットオフを定義する。</span></span>
<span>      <span class="va">age_years</span>,                         <span class="co"># age_yearsの操作。</span></span>
<span>      probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,       <span class="co"># 0.0から1.0へ0.1倍。</span></span>
<span>      na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,                    <span class="co"># 欠損値を無視する</span></span>
<span>    include.lowest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>          <span class="co"># cut()でage 0を含む。</span></span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/tabyl.html">tabyl</a></span><span class="op">(</span><span class="va">deciles</span><span class="op">)</span>                <span class="co"># 表示するテーブルへのパイプ。</span></span></code></pre></div>
<pre><code>##  deciles   n    percent valid_percent
##    [0,2] 748 0.11319613    0.11505922
##    (2,5] 721 0.10911017    0.11090601
##    (5,7] 497 0.07521186    0.07644978
##   (7,10] 698 0.10562954    0.10736810
##  (10,13] 635 0.09609564    0.09767728
##  (13,17] 755 0.11425545    0.11613598
##  (17,21] 578 0.08746973    0.08890940
##  (21,26] 625 0.09458232    0.09613906
##  (26,33] 596 0.09019370    0.09167820
##  (33,84] 648 0.09806295    0.09967697
##     &lt;NA&gt; 107 0.01619249            NA</code></pre>
</div>
<div id="均等な大きさのグループ" class="section level3 unnumbered">
<h3>均等な大きさのグループ<a class="anchor" aria-label="anchor" href="#%E5%9D%87%E7%AD%89%E3%81%AA%E5%A4%A7%E3%81%8D%E3%81%95%E3%81%AE%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97"><i class="fas fa-link"></i></a>
</h3>
<p>数値グループを作成するもう 1 つの方法として、<strong>dplyr</strong> の関数 <code><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile()</a></code> で、データを n 個の均等な大きさのグループに分割する方法があります。<code><a href="https://rdrr.io/r/stats/quantile.html">quantile()</a></code> と異なり、同じ値が複数のグループに入ることがあることに注意してください。この方法では、数値ベクトルを指定し、そして分割するグループの数を指定することが必要ですが、作成される新しい列の値は、グループの「番号」（例：1 から 10）だけで、<code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code> を使ったときのように値の範囲そのものではありません。</p>
<div class="sourceCode" id="cb282"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ntile()でグループを作る</span></span>
<span><span class="va">ntile_data</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>even_groups <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile</a></span><span class="op">(</span><span class="va">age_years</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># グループ別の数と割合の表を作る</span></span>
<span><span class="va">ntile_table</span> <span class="op">&lt;-</span> <span class="va">ntile_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/tabyl.html">tabyl</a></span><span class="op">(</span><span class="va">even_groups</span><span class="op">)</span></span>
<span>  </span>
<span><span class="co"># 範囲を示すために最小値と最大値を添付する</span></span>
<span><span class="va">ntile_ranges</span> <span class="op">&lt;-</span> <span class="va">ntile_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">even_groups</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">age_years</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,</span>
<span>    max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">age_years</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code>## Warning in min(age_years, na.rm = T): no non-missing arguments to min; returning
## Inf</code></pre>
<pre><code>## Warning in max(age_years, na.rm = T): no non-missing arguments to max; returning
## -Inf</code></pre>
<div class="sourceCode" id="cb285"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 結合して表示する（値が複数のグループに存在することに注意）</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">ntile_table</span>, <span class="va">ntile_ranges</span>, by <span class="op">=</span> <span class="st">"even_groups"</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  even_groups   n    percent valid_percent min  max
##            1 651 0.09851695    0.10013844   0    2
##            2 650 0.09836562    0.09998462   2    5
##            3 650 0.09836562    0.09998462   5    7
##            4 650 0.09836562    0.09998462   7   10
##            5 650 0.09836562    0.09998462  10   13
##            6 650 0.09836562    0.09998462  13   17
##            7 650 0.09836562    0.09998462  17   21
##            8 650 0.09836562    0.09998462  21   26
##            9 650 0.09836562    0.09998462  26   33
##           10 650 0.09836562    0.09998462  33   84
##           NA 107 0.01619249            NA Inf -Inf</code></pre>
<!-- ======================================================= -->
</div>
<div id="case_when" class="section level3 unnumbered">
<h3>
<code>case_when()</code><a class="anchor" aria-label="anchor" href="#case_when"><i class="fas fa-link"></i></a>
</h3>
<p><strong>dplyr</strong> の関数 <code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code> を使って数値列からカテゴリを作成することは可能ですが、<strong>epikit</strong> の<code>age_categories()</code> や <code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code> を使った方が、自動的に順序付けられた要素を作成してくれるので、より簡単です。</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code> を使用する場合は、この章の「値の再定義」のセクションで説明した方法を確認してください。また、右辺にくるすべての値は同じデータ型でなければならないことに注意してください。したがって、右辺の値を <code>NA</code> にしたい場合は、“Missing”と書くか、特別な <code>NA</code> 値である <code>NA_character_</code> を使用する必要があります。</p>
</div>
<div id="パイプチェーンへの追加-1" class="section level3 unnumbered">
<h3>パイプチェーンへの追加<a class="anchor" aria-label="anchor" href="#%E3%83%91%E3%82%A4%E3%83%97%E3%83%81%E3%82%A7%E3%83%BC%E3%83%B3%E3%81%B8%E3%81%AE%E8%BF%BD%E5%8A%A0-1"><i class="fas fa-link"></i></a>
</h3>
<p>以下では、カテゴリ化された 2 つの年齢列を作成するコードを、前処理パイプラインに追加しています。</p>
<div class="sourceCode" id="cb287"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># パイプチェーン処理 (未加工データから始まり、クリーニングステップを経由してパイプで処理される)</span></span>
<span><span class="co">##################################################################################</span></span>
<span></span>
<span></span>
<span><span class="co"># パイプチェーンのクリーニング開始</span></span>
<span><span class="co">###########################</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    </span>
<span>    <span class="co">#列名の構文の標準化</span></span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span></span>
<span>     </span>
<span>     <span class="co"># 手動で列名を変更</span></span>
<span>           <span class="co"># 新しい列名             # 既存の列名</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>date_infection       <span class="op">=</span> <span class="va">infection_date</span>,</span>
<span>           date_hospitalisation <span class="op">=</span> <span class="va">hosp_date</span>,</span>
<span>           date_outcome         <span class="op">=</span> <span class="va">date_of_outcome</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>    <span class="co"># remove column</span></span>
<span>     <span class="co"># 列を削除</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">row_num</span>, <span class="va">merged_header</span>, <span class="va">x28</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>     <span class="co"># 重複除去</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span></span>
<span>     <span class="co"># 列の追加</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>bmi <span class="op">=</span> <span class="va">wt_kg</span> <span class="op">/</span> <span class="op">(</span><span class="va">ht_cm</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>     </span>
<span></span>
<span>    <span class="co"># convert class of columns</span></span>
<span>     <span class="co"># 列のデータ型を変換</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span>, <span class="va">as.Date</span><span class="op">)</span>, </span>
<span>           generation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">generation</span><span class="op">)</span>,</span>
<span>           age        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>     <span class="co"># 列の追加:入院の遅延</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>days_onset_hosp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">date_hospitalisation</span> <span class="op">-</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>     <span class="co"># 病院の列の値をクリーニングする</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op">(</span><span class="va">hospital</span>,</span>
<span>                         　　　<span class="co"># 既存の値 = 新しい値</span></span>
<span>                      <span class="st">"Mitylira Hopital"</span>  <span class="op">=</span> <span class="st">"Military Hospital"</span>,</span>
<span>                      <span class="st">"Mitylira Hospital"</span> <span class="op">=</span> <span class="st">"Military Hospital"</span>,</span>
<span>                      <span class="st">"Military Hopital"</span>  <span class="op">=</span> <span class="st">"Military Hospital"</span>,</span>
<span>                      <span class="st">"Port Hopital"</span>      <span class="op">=</span> <span class="st">"Port Hospital"</span>,</span>
<span>                      <span class="st">"Central Hopital"</span>   <span class="op">=</span> <span class="st">"Central Hospital"</span>,</span>
<span>                      <span class="st">"other"</span>             <span class="op">=</span> <span class="st">"Other"</span>,</span>
<span>                      <span class="st">"St. Marks Maternity Hopital (SMMH)"</span> <span class="op">=</span> <span class="st">"St. Mark's Maternity Hospital (SMMH)"</span></span>
<span>                      <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span><span class="op">(</span><span class="va">hospital</span>, <span class="st">"Missing"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span></span>
<span>     <span class="co"># age_years列の作成（age 列と age_unit 列を使用する）</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age_years <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>          <span class="va">age_unit</span> <span class="op">==</span> <span class="st">"years"</span> <span class="op">~</span> <span class="va">age</span>,</span>
<span>          <span class="va">age_unit</span> <span class="op">==</span> <span class="st">"months"</span> <span class="op">~</span> <span class="va">age</span><span class="op">/</span><span class="fl">12</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">age_unit</span><span class="op">)</span> <span class="op">~</span> <span class="va">age</span>,</span>
<span>          <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span></span>
<span>     <span class="co"># ここまでは、すでに説明したクリーニング手順</span></span>
<span>    <span class="co">###################################################   </span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>         <span class="co"># 年齢別カテゴリ：カスタマイズする</span></span>
<span>          age_cat <span class="op">=</span> <span class="fu">epikit</span><span class="fu">::</span><span class="fu"><a href="https://r4epi.github.io/epikit/reference/age_categories.html">age_categories</a></span><span class="op">(</span><span class="va">age_years</span>, breakers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">50</span>, <span class="fl">70</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        </span>
<span>          <span class="co"># 年齢カテゴリ：0～85歳までの5段階</span></span>
<span>          age_cat5 <span class="op">=</span> <span class="fu">epikit</span><span class="fu">::</span><span class="fu"><a href="https://r4epi.github.io/epikit/reference/age_categories.html">age_categories</a></span><span class="op">(</span><span class="va">age_years</span>, breakers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">85</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
</div>
<div id="行の追加" class="section level2" number="8.10">
<h2>
<span class="header-section-number">8.10</span> 行の追加<a class="anchor" aria-label="anchor" href="#%E8%A1%8C%E3%81%AE%E8%BF%BD%E5%8A%A0"><i class="fas fa-link"></i></a>
</h2>
<div id="一行ずつ追加する" class="section level3 unnumbered">
<h3>一行ずつ追加する<a class="anchor" aria-label="anchor" href="#%E4%B8%80%E8%A1%8C%E3%81%9A%E3%81%A4%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p>手作業で一行ずつ追加するのは面倒ですが、<strong>dplyr</strong> の <code><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row()</a></code> を使えば可能です。各列は 1 つのデータ型（因子型、数字型、ロジカル型など）の値のみを含む必要があることを覚えておいてください。そのため、行の追加にはこれを維持するための微妙な調整が必要です。</p>
<div class="sourceCode" id="cb288"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row</a></span><span class="op">(</span>row_num <span class="op">=</span> <span class="fl">666</span>,</span>
<span>          case_id <span class="op">=</span> <span class="st">"abc"</span>,</span>
<span>          generation <span class="op">=</span> <span class="fl">4</span>,</span>
<span>          `infection date` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2020-10-10"</span><span class="op">)</span>,</span>
<span>          .before <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><code>.before</code> と <code>.after.</code> を使って、追加したい行の位置を指定します。<code>.before = 3</code> は、新しい行を現在の 3 行目の前に配置します。デフォルトでは、新しい行は最後に追加されます。指定されていない列は空欄（<code>NA</code>）になります。</p>
<p>新しい<u>行番号</u>は奇妙に見えるかもしれません（“…23”）。既存の行の行番号は変更されているため、このコマンドを 2 回使用する場合は、慎重に検討・テストしてください。</p>
<p>指定したデータ型が実際のデータ型と異なる場合は、以下のようなエラーが表示されます。</p>
<pre><code>Error: Can't combine ..1$infection date &lt;date&gt; and ..2$infection date &lt;character&gt;.</code></pre>
<p>（日付の値を持つ行を挿入する際には、<code>as.Date("2020-10-10")</code> のように <code><a href="https://rdrr.io/r/base/as.Date.html">as.Date()</a></code> という関数で日付を囲うことを忘れないでください）。</p>
</div>
<div id="複数行を結合する" class="section level3 unnumbered">
<h3>複数行を結合する<a class="anchor" aria-label="anchor" href="#%E8%A4%87%E6%95%B0%E8%A1%8C%E3%82%92%E7%B5%90%E5%90%88%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p>あるデータフレームの行を別のデータフレームの下部に結合してデータセットを結合するには、<strong>dplyr</strong> の <code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows()</a></code> を使用します。これについては、<a href="joining-matching.html#joining-matching">データの結合</a> の章で詳しく説明しています。</p>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</div>
</div>
<div id="行の抽出フィルタリング" class="section level2" number="8.11">
<h2>
<span class="header-section-number">8.11</span> 行の抽出（フィルタリング）<a class="anchor" aria-label="anchor" href="#%E8%A1%8C%E3%81%AE%E6%8A%BD%E5%87%BA%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0"><i class="fas fa-link"></i></a>
</h2>
<p>列を整理し、値を再定義した後の典型的なクリーニングステップは、<strong>dplyr</strong> の <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> を使ってデータフレームの特定の行を抽出（フィルタリング）することです。</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> では、データセット内の特定の行を抜き出すために、<code>TRUE</code> でなければならない論理を指定します。以下では、単純な論理条件と複雑な論理条件に基づいて行を抽出する方法を示します。</p>
<!-- ======================================================= -->
<div id="単純なフィルタリング" class="section level3 unnumbered">
<h3>単純なフィルタリング<a class="anchor" aria-label="anchor" href="#%E5%8D%98%E7%B4%94%E3%81%AA%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0"><i class="fas fa-link"></i></a>
</h3>
<p>以下の単純な例では、論理的な条件を満たすように行を抽出した上で、<code>linelist</code> データフレームを再定義します。括弧内の論理条件が評価され、 <code>TRUE</code> となる行のみが残ります。</p>
<p>この例では、論理条件は <code>gender == "f"</code> で、列 <code>gender</code> の値が <code>"f"</code> に等しいかどうかを問いています（大文字と小文字は区別されます）。</p>
<p>フィルタを適用する前の <code>linelist</code> の行数は <code>nrow(linelist)</code> です。</p>
<div class="sourceCode" id="cb290"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">gender</span> <span class="op">==</span> <span class="st">"f"</span><span class="op">)</span>   <span class="co"># 性別が "f" である行だけを残す</span></span></code></pre></div>
<p>フィルタを適用した後の <code>linelist</code> の行数は <code>linelist %&gt;% filter(gender == "f") %&gt;% nrow()</code> となります。</p>
</div>
<div id="欠損値のフィルタリング" class="section level3 unnumbered">
<h3>欠損値のフィルタリング<a class="anchor" aria-label="anchor" href="#%E6%AC%A0%E6%90%8D%E5%80%A4%E3%81%AE%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0"><i class="fas fa-link"></i></a>
</h3>
<p>欠損値のある行をフィルタリングしたいことはよくあります。<code>filter(!is.na(column) &amp; !is.na(column))</code> と書きたい気持ちを抑えて、代わりにこのためにカスタマイズされた <strong>tidyr</strong> の関数である <code><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na()</a></code> を使いましょう。空の括弧をつけて実行すると、欠損値のある行を削除します。あるいは、欠落があるか評価したい特定の列の名前を指定したり、<a href="https://epirhandbook.com/en/cleaning-data-and-core-functions.html#clean_tidyselect">上述の</a> “tidyselect”ヘルパー関数を使用することもできます。</p>
<div class="sourceCode" id="cb291"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">case_id</span>, <span class="va">age_years</span><span class="op">)</span>  </span>
<span><span class="co"># case_idやage_yearsの値が欠損している行を削除する。</span></span></code></pre></div>
<p>データの欠落の分析や管理の詳細ついては、<a href="missing-data.html#missing-data">欠損データの処理</a> の章をご覧ください。</p>
</div>
<div id="行番号によるフィルタリング" class="section level3 unnumbered">
<h3>行番号によるフィルタリング<a class="anchor" aria-label="anchor" href="#%E8%A1%8C%E7%95%AA%E5%8F%B7%E3%81%AB%E3%82%88%E3%82%8B%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0"><i class="fas fa-link"></i></a>
</h3>
<p>データフレームや Tibble では、各行には通常「行番号（row number）」があり、R Viewer で見ると最初の列の左側に表示されます。これは、それ自体はデータの列ではありませんが、<code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> を使用する際に参照することができます。</p>
<p>「行番号」に基づいてフィルタリングしたい場合は、フィルタリングの論理条件のとして、<strong>dplyr</strong> の関数 <code><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number()</a></code> を空括弧付きで使用します。多くの場合、以下のように、論理条件文の一部として、<code>%in%</code> 演算子を使用して数値の範囲を指定します。<u>最初の</u> N 行を表示するには、特別な <strong>dplyr</strong> 関数 <code><a href="https://rdrr.io/r/utils/head.html">head()</a></code> を使用することもできます。</p>
<div class="sourceCode" id="cb292"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 最初の100行を表示する</span></span>
<span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>     </span>
<span><span class="co"># またはtail()を使って最後のn行を見る</span></span>
<span></span>
<span><span class="co"># 5列目のみ表示する</span></span>
<span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2行目から20行目までと、3つの特定の列を見る</span></span>
<span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fl">2</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date_onset</span>, <span class="va">outcome</span>, <span class="va">age</span><span class="op">)</span></span></code></pre></div>
<p>また、データフレームを <strong>tibble</strong> 関数 <code><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column()</a></code> にパイプすることで、行番号を列として変換することができます（括弧の中には何も入れないでください）。</p>
<!-- ======================================================= -->
</div>
<div id="複雑なフィルタリング" class="section level3 unnumbered">
<h3>複雑なフィルタリング<a class="anchor" aria-label="anchor" href="#%E8%A4%87%E9%9B%91%E3%81%AA%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0"><i class="fas fa-link"></i></a>
</h3>
<p>括弧 <code>（）</code>、OR <code>｜</code>、ネゲート <code>！</code>、<code>％in％</code>、AND <code>＆</code> の各演算子を使って、より複雑な論理条件を作ることができます。その例を以下に示します。</p>
<p>注： 論理的条件の前に <code>!</code> 演算子を使うと、その後の論理的条件が否定されます。例えば、<code>！is.na(column)</code> は、列の値が欠損していない場合に真（TRUE）と評価されます。同様に、<code>！column %in% c("a", "b", "c")</code> は、列の値がベクトルに含まれていない場合に真（TRUE）と評価されます。</p>
<div id="データを調べる" class="section level4 unnumbered">
<h4>データを調べる<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E8%AA%BF%E3%81%B9%E3%82%8B"><i class="fas fa-link"></i></a>
</h4>
<p>以下は、発症日のヒストグラムを作成するためのシンプルなコマンドです。この未加工データセットには、二つのアウトブレイクが含まれていることはわかります（2012～2013 年に発生した小規模なアウトブレイクと 2014～2015 年に発生した大規模なアウトブレイク）。今回の分析では、最初の小規模なアウトブレイクをラインリストから削除していきます。</p>
<div class="sourceCode" id="cb293"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">date_onset</span>, breaks <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-232-1.png" width="50%"></div>
</div>
<div id="数値や日付の欠損をフィルターで処理する方法" class="section level4 unnumbered">
<h4>数値や日付の欠損をフィルターで処理する方法<a class="anchor" aria-label="anchor" href="#%E6%95%B0%E5%80%A4%E3%82%84%E6%97%A5%E4%BB%98%E3%81%AE%E6%AC%A0%E6%90%8D%E3%82%92%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%BC%E3%81%A7%E5%87%A6%E7%90%86%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95"><i class="fas fa-link"></i></a>
</h4>
<p><code>date_onset</code> 列で 2013 年 6 月以降の行を抽出することはできるでしょうか。これには、注意が必要です。<code>filter(date_onset &gt; as.Date("2013-06-01")))</code> というコードを適用すると、発症日が欠落している後期流行の行がすべて削除されてしまいます！</p>
<p><span style="color: red;">警告：日付や数値の「大（&gt;）」または「小（&lt;）」にフィルタリングすると、欠損値（<code>NA</code>）のある行が削除されてしまいます。これは、<code>NA</code> が無限に大きい、または小さいものとして扱われるためです。</span></p>
<p><u>(日付データと <strong>lubridat</strong>e パッケージを使用した処理については、日付データの章の <a href="https://epirhandbook.com/en/working-with-dates.html#working-with-dates-1">日付の操作</a>のセクションを参照してください。）</u></p>
</div>
<div id="フィルターを作成する" class="section level4 unnumbered">
<h4>フィルターを作成する<a class="anchor" aria-label="anchor" href="#%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%BC%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h4>
<p>クロス集計を行い、正しい行だけを除外していることを確認して下さい。</p>
<div class="sourceCode" id="cb294"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>Hospital  <span class="op">=</span> <span class="va">linelist</span><span class="op">$</span><span class="va">hospital</span>,                     <span class="co">#病院名</span></span>
<span>      YearOnset <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">date_onset</span><span class="op">)</span>,  <span class="co">#発症した年</span></span>
<span>      useNA     <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span>                              <span class="co">#欠損値の表示</span></span></code></pre></div>
<pre><code>##                                       YearOnset
## Hospital                               2012 2013 2014 2015 &lt;NA&gt;
##   Central Hospital                        0    0  351   99   18
##   Hospital A                            229   46    0    0   15
##   Hospital B                            227   47    0    0   15
##   Military Hospital                       0    0  676  200   34
##   Missing                                 0    0 1117  318   77
##   Other                                   0    0  684  177   46
##   Port Hospital                           9    1 1372  347   75
##   St. Mark's Maternity Hospital (SMMH)    0    0  322   93   13
##   &lt;NA&gt;                                    0    0    0    0    0</code></pre>
<p>データセットから最初のアウトブレイク（2012～2013 年に発生したアウトブレイク）を除外するために、他にどのような基準でフィルタリングできるでしょうか。次のことがわかりました。</p>
<ul>
<li><p>2012 年と 2013 年に発生した最初のアウトブレイクは、A 病院（Hospital A）と B 病院（Hospital B）で発生し、ポート病院（Port Hospital）でも10件の症例が確認されました。</p></li>
<li><p>2 回目のアウトブレイク（2014～2015 年に発生したアウトブレイク）では、A 病院（Hospital A）と B 病院（Hospital B）には症例は確認されませんでしたが、ポート病院（Port Hospital）には症例が確認されました。</p></li>
</ul>
<p>除外したい項目：</p>
<ul>
<li>
<p>A 病院（Hospital A）、 B 病院（Hospital B）、ポート病院（Port Hospital）のいずれかで 2012 年と 2013 年に発症した <code>nrow(linelist %&gt;% filter(hospital %in% c("Hospital A", "Hospital B") | date_onset &lt; as.Date("2013-06-01")))</code> の行。</p>
<ul>
<li><p>2012 年および 2013 年に発症した <code>nrow(linelist %&gt;% filter(date_onset &lt; as.Date("2013-06-01"))</code> の行を除外する。</p></li>
<li><p><code>nrow(linelist %&gt;% filter(hospital %in% c('Hospital A', 'Hospital B') &amp; is.na(date_onset)))</code> 発症日が欠落している A 病院および B 病院の行を除外する。</p></li>
<li><p><code>nrow(linelist %&gt;% filter(!hospital %in% c('Hospital A', 'Hospital B') &amp; is.na(date_onset))</code> 発症日が見つからない他の行は除外<strong>しない</strong>。</p></li>
</ul>
</li>
</ul>
<p><code>6608</code> のラインリストから始めます。以下がフィルタリングのコードです。</p>
<div class="sourceCode" id="cb296"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span> <span class="co"># 発症日が2013年6月1日以降の行、または発症日が不明でA病院またはB病院以外の病院であった行を残す</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">date_onset</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2013-06-01"</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">hospital</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Hospital A"</span>, <span class="st">"Hospital B"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 6019</code></pre>
<p>再度クロス集計を行うと、A 病院と B 病院が完全に取り除かれ、2012 年と 2013 年のポート病院で発生した 10 件が取り除かれ、その他の値はすべて同じになっていることがわかります。</p>
<div class="sourceCode" id="cb298"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span>Hospital  <span class="op">=</span> <span class="va">linelist</span><span class="op">$</span><span class="va">hospital</span>,                     <span class="co"># 病院名</span></span>
<span>      YearOnset <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">date_onset</span><span class="op">)</span>,  <span class="co"># 発症した年</span></span>
<span>      useNA     <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span>                              <span class="co"># 欠損値の表示</span></span></code></pre></div>
<pre><code>##                                       YearOnset
## Hospital                               2014 2015 &lt;NA&gt;
##   Central Hospital                      351   99   18
##   Military Hospital                     676  200   34
##   Missing                              1117  318   77
##   Other                                 684  177   46
##   Port Hospital                        1372  347   75
##   St. Mark's Maternity Hospital (SMMH)  322   93   13
##   &lt;NA&gt;                                    0    0    0</code></pre>
<p>複数のステートメントを 1 つの <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> コマンドの中に含めることができます（カンマで区切ってください）。または、分かりやすくするために、常に別の <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> コマンドにパイプすることもできます。</p>
<p>注：<code>date_hospitalisation</code> には欠損値がないことから、読者の中には <code>date_hospitalisation</code> でフィルタリングする方が簡単だと思われる方もいるかもしれません。これは事実です。ここでは、複雑なフィルタを理解するために <code>date_onset</code> を使用しました。</p>
</div>
</div>
<div id="独立型-1" class="section level3 unnumbered">
<h3>独立型<a class="anchor" aria-label="anchor" href="#%E7%8B%AC%E7%AB%8B%E5%9E%8B-1"><i class="fas fa-link"></i></a>
</h3>
<p>フィルタリングは、（パイプチェーンの一部ではなく）独立したコマンドとしても実行できます。他の <strong>dplyr</strong> 系の関数と同様に、この場合、一番最初の引数はデータセットそのものでなければなりません。</p>
<div class="sourceCode" id="cb300"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># dataframe &lt;- filter(dataframe, condition(s) for rows to keep)</span></span>
<span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">linelist</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">case_id</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>base</strong> Rを使う場合、保持したい [行、列] を、角括弧 [] を使ってサブセット（フィルタリング）することもできます。</p>
<div class="sourceCode" id="cb301"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># dataframe &lt;- dataframe[row conditions, column conditions] (blank means keep all)</span></span>
<span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">case_id</span><span class="op">)</span>, <span class="op">]</span></span></code></pre></div>
</div>
<div id="データを素早く確認" class="section level3 unnumbered">
<h3>データを素早く確認<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E7%B4%A0%E6%97%A9%E3%81%8F%E7%A2%BA%E8%AA%8D"><i class="fas fa-link"></i></a>
</h3>
<p>数少ない行や列のデータを素早く確認したいことがよくあります。<strong>base</strong> R の <code><a href="https://rdrr.io/r/utils/View.html">View()</a></code> を使用すると、RStudio データフレームが表示されます。</p>
<p>以下のコマンドを実行すると、RStudio でラインリストが表示されます。</p>
<div class="sourceCode" id="cb302"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/View.html">View</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span></span></code></pre></div>
<p>特定のセル（特定の行、特定の列）を表示する 2 つの例を紹介します。</p>
<p><strong>dplyrの関数 <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> と <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> を使用する</strong></p>
<p><code><a href="https://rdrr.io/r/utils/View.html">View()</a></code> の中で、データセットを <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> にパイプして特定の行を残し、<code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> にパイプして特定の列を残します。例えば、特定の 3 つの症例の発症日と入院日を確認する場合です。</p>
<div class="sourceCode" id="cb303"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/View.html">View</a></span><span class="op">(</span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">case_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"11f8ea"</span>, <span class="st">"76b97a"</span>, <span class="st">"47a5f5"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date_onset</span>, <span class="va">date_hospitalisation</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>base</strong> R でも [ ] を使用してサブセットすると、同じことができます。</p>
<div class="sourceCode" id="cb304"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/View.html">View</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">[</span><span class="va">linelist</span><span class="op">$</span><span class="va">case_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"11f8ea"</span>, <span class="st">"76b97a"</span>, <span class="st">"47a5f5"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"date_onset"</span>, <span class="st">"date_hospitalisation"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div id="パイプチェーンに追加" class="section level4 unnumbered">
<h4>パイプチェーンに追加<a class="anchor" aria-label="anchor" href="#%E3%83%91%E3%82%A4%E3%83%97%E3%83%81%E3%82%A7%E3%83%BC%E3%83%B3%E3%81%AB%E8%BF%BD%E5%8A%A0"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb305"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># パイプチェーン処理 (未加工データから始まり、クリーニングステップを経由してパイプで処理される)</span></span>
<span><span class="co">##################################################################################</span></span>
<span></span>
<span></span>
<span><span class="co"># パイプチェーンのクリーニング開始</span></span>
<span><span class="co">###########################</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist_raw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    </span>
<span>    <span class="co">#列名構文の標準化</span></span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>    <span class="co"># 手動で列名を変更</span></span>
<span>           <span class="co">#新しい列名            # 既存の列名</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>date_infection       <span class="op">=</span> <span class="va">infection_date</span>,</span>
<span>           date_hospitalisation <span class="op">=</span> <span class="va">hosp_date</span>,</span>
<span>           date_outcome         <span class="op">=</span> <span class="va">date_of_outcome</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>    <span class="co"># 列の除去</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">row_num</span>, <span class="va">merged_header</span>, <span class="va">x28</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>    <span class="co"># 重複除去</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span></span>
<span>    <span class="co"># 列を追加する</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>bmi <span class="op">=</span> <span class="va">wt_kg</span> <span class="op">/</span> <span class="op">(</span><span class="va">ht_cm</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>     </span>
<span></span>
<span>    <span class="co"># 列のデータ型を変換</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span>, <span class="va">as.Date</span><span class="op">)</span>, </span>
<span>           generation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">generation</span><span class="op">)</span>,</span>
<span>           age        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>    <span class="co"># 列の追加: 入院までの時間</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>days_onset_hosp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">date_hospitalisation</span> <span class="op">-</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>    <span class="co"># 病院列の値を整える</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op">(</span><span class="va">hospital</span>,</span>
<span>                      <span class="co"># OLD = NEW</span></span>
<span>                      <span class="st">"Mitylira Hopital"</span>  <span class="op">=</span> <span class="st">"Military Hospital"</span>,</span>
<span>                      <span class="st">"Mitylira Hospital"</span> <span class="op">=</span> <span class="st">"Military Hospital"</span>,</span>
<span>                      <span class="st">"Military Hopital"</span>  <span class="op">=</span> <span class="st">"Military Hospital"</span>,</span>
<span>                      <span class="st">"Port Hopital"</span>      <span class="op">=</span> <span class="st">"Port Hospital"</span>,</span>
<span>                      <span class="st">"Central Hopital"</span>   <span class="op">=</span> <span class="st">"Central Hospital"</span>,</span>
<span>                      <span class="st">"other"</span>             <span class="op">=</span> <span class="st">"Other"</span>,</span>
<span>                      <span class="st">"St. Marks Maternity Hopital (SMMH)"</span> <span class="op">=</span> <span class="st">"St. Mark's Maternity Hospital (SMMH)"</span></span>
<span>                      <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hospital <span class="op">=</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span><span class="op">(</span><span class="va">hospital</span>, <span class="st">"Missing"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span></span>
<span>    <span class="co"># age_years 列を作成する (age列とage_unit列から)</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age_years <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>          <span class="va">age_unit</span> <span class="op">==</span> <span class="st">"years"</span> <span class="op">~</span> <span class="va">age</span>,</span>
<span>          <span class="va">age_unit</span> <span class="op">==</span> <span class="st">"months"</span> <span class="op">~</span> <span class="va">age</span><span class="op">/</span><span class="fl">12</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">age_unit</span><span class="op">)</span> <span class="op">~</span> <span class="va">age</span>,</span>
<span>          <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>          <span class="co"># 年齢別カテゴリ：カスタマイズする</span></span>
<span>          age_cat <span class="op">=</span> <span class="fu">epikit</span><span class="fu">::</span><span class="fu"><a href="https://r4epi.github.io/epikit/reference/age_categories.html">age_categories</a></span><span class="op">(</span><span class="va">age_years</span>, breakers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">50</span>, <span class="fl">70</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        </span>
<span>          <span class="co"># 年齢カテゴリ：0～85歳までの5段階</span></span>
<span>          age_cat5 <span class="op">=</span> <span class="fu">epikit</span><span class="fu">::</span><span class="fu"><a href="https://r4epi.github.io/epikit/reference/age_categories.html">age_categories</a></span><span class="op">(</span><span class="va">age_years</span>, breakers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">85</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    </span>
<span>      <span class="co"># ここまでは、すでに説明したクリーニング手順</span></span>
<span>    <span class="co">###################################################</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>         <span class="co"># case_idが欠落していない行のみを残す</span></span>
<span>          <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">case_id</span><span class="op">)</span>,  </span>
<span>          </span>
<span>           <span class="co"># 2回目のアウトブレイクだけを残すようにフィルタリングする</span></span>
<span>          <span class="va">date_onset</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2013-06-01"</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">hospital</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Hospital A"</span>, <span class="st">"Hospital B"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="行単位の計算" class="section level2" number="8.12">
<h2>
<span class="header-section-number">8.12</span> 行単位の計算<a class="anchor" aria-label="anchor" href="#%E8%A1%8C%E5%8D%98%E4%BD%8D%E3%81%AE%E8%A8%88%E7%AE%97"><i class="fas fa-link"></i></a>
</h2>
<p>行内で計算を行いたい場合は、<strong>dplyr</strong> の <code><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise()</a></code> を利用することができます。例えば、以下のコードでは <code><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise()</a></code> を使用し、ラインリストの各行について、値が “yes” である指定された症状の列の数を合計する新しい列を作成しています。<code><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise()</a></code> は本質的には特殊な <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> であるため、終わったら <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup()</a></code> を使うのがベストです（詳細は、<a href="grouping.html#grouping">データのグループ化</a> の章を参照ください）。</p>
<div class="sourceCode" id="cb306"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>num_symptoms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">fever</span>, <span class="va">chills</span>, <span class="va">cough</span>, <span class="va">aches</span>, <span class="va">vomit</span><span class="op">)</span> <span class="op">==</span> <span class="st">"yes"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">fever</span>, <span class="va">chills</span>, <span class="va">cough</span>, <span class="va">aches</span>, <span class="va">vomit</span>, <span class="va">num_symptoms</span><span class="op">)</span> <span class="co"># 表示のため</span></span></code></pre></div>
<pre><code>## # A tibble: 5,888 × 6
##    fever chills cough aches vomit num_symptoms
##    &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;        &lt;int&gt;
##  1 no    no     yes   no    yes              2
##  2 &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;            NA
##  3 &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;            NA
##  4 no    no     no    no    no               0
##  5 no    no     yes   no    yes              2
##  6 no    no     yes   no    yes              2
##  7 &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;            NA
##  8 no    no     yes   no    yes              2
##  9 no    no     yes   no    yes              2
## 10 no    no     yes   no    no               1
## # … with 5,878 more rows</code></pre>
<p>評価する列を指定する際に、この章の <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> セクションで説明されている “tidyselect” ヘルパー関数を使用したいと思うかもしれません。その場合は、1 つだけ調整が必要です（ <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> や <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> のような <strong>dplyr</strong> 関数内で使用していないため）。</p>
<p>列指定の基準を <strong>dplyr</strong> の <code><a href="https://dplyr.tidyverse.org/reference/c_across.html">c_across()</a></code> の中に入れます。これは、<code>c_across</code>（<a href="https://dplyr.tidyverse.org/reference/c_across.html">ドキュメントはこちら</a>）が、特に <code><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise()</a></code> と連動するように設計されているからです。例えば、次のようなコードです。</p>
<ul>
<li><p><code><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise()</a></code> を適用して、各行の中で以下の演算（<code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code>）が適用されます（列全体の合計ではありません）。</p></li>
<li><p>新しい列 <code>num_NA_dates</code> を作成します。これは、各行について、<code><a href="https://rdrr.io/r/base/NA.html">is.na()</a></code> が TRUE と評価された列 （列名に “date” を含むもの） の数として定義されます（これらはデータが欠損しています）。</p></li>
<li><p><code><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup()</a></code> により、後続のステップで <code><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise()</a></code> の影響を取り除きます。</p></li>
</ul>
<div class="sourceCode" id="cb308"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>num_NA_dates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/c_across.html">c_across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">num_NA_dates</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span><span class="op">)</span> <span class="co"># for display</span></span></code></pre></div>
<pre><code>## # A tibble: 5,888 × 5
##    num_NA_dates date_infection date_onset date_hospitalisation date_outcome
##           &lt;int&gt; &lt;date&gt;         &lt;date&gt;     &lt;date&gt;               &lt;date&gt;      
##  1            1 2014-05-08     2014-05-13 2014-05-15           NA          
##  2            1 NA             2014-05-13 2014-05-14           2014-05-18  
##  3            1 NA             2014-05-16 2014-05-18           2014-05-30  
##  4            1 2014-05-04     2014-05-18 2014-05-20           NA          
##  5            0 2014-05-18     2014-05-21 2014-05-22           2014-05-29  
##  6            0 2014-05-03     2014-05-22 2014-05-23           2014-05-24  
##  7            0 2014-05-22     2014-05-27 2014-05-29           2014-06-01  
##  8            0 2014-05-28     2014-06-02 2014-06-03           2014-06-07  
##  9            1 NA             2014-06-05 2014-06-06           2014-06-18  
## 10            1 NA             2014-06-05 2014-06-07           2014-06-09  
## # … with 5,878 more rows</code></pre>
<p>また、<code><a href="https://rdrr.io/r/base/Extremes.html">max()</a></code> のような他の関数を使用し、各行の最新または直近の日付を取得することもできます。</p>
<div class="sourceCode" id="cb310"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>latest_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/c_across.html">c_across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span><span class="op">)</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">latest_date</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span><span class="op">)</span>  <span class="co"># for display</span></span></code></pre></div>
<pre><code>## # A tibble: 5,888 × 5
##    latest_date date_infection date_onset date_hospitalisation date_outcome
##    &lt;date&gt;      &lt;date&gt;         &lt;date&gt;     &lt;date&gt;               &lt;date&gt;      
##  1 2014-05-15  2014-05-08     2014-05-13 2014-05-15           NA          
##  2 2014-05-18  NA             2014-05-13 2014-05-14           2014-05-18  
##  3 2014-05-30  NA             2014-05-16 2014-05-18           2014-05-30  
##  4 2014-05-20  2014-05-04     2014-05-18 2014-05-20           NA          
##  5 2014-05-29  2014-05-18     2014-05-21 2014-05-22           2014-05-29  
##  6 2014-05-24  2014-05-03     2014-05-22 2014-05-23           2014-05-24  
##  7 2014-06-01  2014-05-22     2014-05-27 2014-05-29           2014-06-01  
##  8 2014-06-07  2014-05-28     2014-06-02 2014-06-03           2014-06-07  
##  9 2014-06-18  NA             2014-06-05 2014-06-06           2014-06-18  
## 10 2014-06-09  NA             2014-06-05 2014-06-07           2014-06-09  
## # … with 5,878 more rows</code></pre>
</div>
<div id="並び替えアレンジとソート" class="section level2" number="8.13">
<h2>
<span class="header-section-number">8.13</span> 並び替え（アレンジとソート）<a class="anchor" aria-label="anchor" href="#%E4%B8%A6%E3%81%B3%E6%9B%BF%E3%81%88%E3%82%A2%E3%83%AC%E3%83%B3%E3%82%B8%E3%81%A8%E3%82%BD%E3%83%BC%E3%83%88"><i class="fas fa-link"></i></a>
</h2>
<p><strong>dplyr</strong> の <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code>を使用し、列の値で行を並べ替えたり、順番に並べたりします。</p>
<p>単純に、並び替えたい順に列を列挙します。データに適用されたグループ化を最初並べ替えたい場合は、<code>.by_group = TRUE</code> と指定します（<a href="grouping.html#grouping">データのグループ化</a> の章を参照）。</p>
<p>デフォルトでは、列は「昇順」で並び替えされます（これは、数字や文字の列にも適用されます）。変数を <code><a href="https://dplyr.tidyverse.org/reference/desc.html">desc()</a></code> で囲むと、「降順」で並び替えできます。</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code> によるデータの並び替えは、<a href="tables-presentation.html#tables-presentation">プレゼンテーション用のテーブルを作成するとき</a> や、<code><a href="https://dplyr.tidyverse.org/reference/slice.html">slice()</a></code> を使ってグループごとに「上位」の行を抽出するとき、あるいは因子レベルの順序を出現順に設定するときなどに特に便利です。</p>
<p>例えば、<code>linelist</code> デーフレームの行を病院別（<code>hospital</code> 列）に並び替え、次に出現日（<code>date_onset</code> 列）の降順で並び替える場合は、次のようになります。</p>
<div class="sourceCode" id="cb312"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">hospital</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="importing.html"><span class="header-section-number">7</span> データのインポート・エクスポート</a></div>
<div class="next"><a href="dates.html"><span class="header-section-number">9</span> 日付型データ</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li>
<a class="nav-link" href="#cleaning"><span class="header-section-number">8</span> データクリーニングと主要関数</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E9%96%A2%E6%95%B0">主要関数</a></li>
<li><a class="nav-link" href="#%E7%94%A8%E8%AA%9E%E4%BD%93%E7%B3%BB">用語体系</a></li>
</ul>
</li>
<li><a class="nav-link" href="#%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%AB%E3%82%88%E3%82%8B%E3%83%87%E3%83%BC%E3%82%BF%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0"><span class="header-section-number">8.1</span> パイプラインによるデータクリーニング</a></li>
<li><a class="nav-link" href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF"><span class="header-section-number">8.2</span> パッケージの読み込み</a></li>
<li>
<a class="nav-link" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88-1"><span class="header-section-number">8.3</span> データのインポート</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B">データをインポートする</a></li>
<li><a class="nav-link" href="#%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">インポートしたデータを確認する</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E5%88%97%E5%90%8D"><span class="header-section-number">8.4</span> 列名</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E3%83%A9%E3%83%99%E3%83%AB">ラベル</a></li>
<li><a class="nav-link" href="#%E8%87%AA%E5%8B%95%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0">自動クリーニング</a></li>
<li><a class="nav-link" href="#%E6%89%8B%E5%8B%95%E3%81%AB%E3%82%88%E3%82%8B%E5%88%97%E5%90%8D%E3%81%AE%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0">手動による列名のクリーニング</a></li>
<li><a class="nav-link" href="#%E5%88%97%E3%81%AE%E4%BD%8D%E7%BD%AE%E3%81%AB%E3%82%88%E3%82%8B%E5%90%8D%E5%89%8D%E3%81%AE%E5%A4%89%E6%9B%B4">列の位置による名前の変更</a></li>
<li><a class="nav-link" href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E8%AA%B2%E9%A1%8C">その他の課題</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E5%88%97%E3%81%AE%E9%81%B8%E6%8A%9E%E3%81%A8%E4%B8%A6%E3%81%B3%E6%9B%BF%E3%81%88"><span class="header-section-number">8.5</span> 列の選択と並び替え</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E5%88%97%E3%81%AE%E4%BF%9D%E6%8C%81">列の保持</a></li>
<li><a class="nav-link" href="#clean_tidyselect">“tidyselect” ヘルパー関数</a></li>
<li><a class="nav-link" href="#%E5%88%97%E3%81%AE%E9%99%A4%E5%A4%96">列の除外</a></li>
<li><a class="nav-link" href="#%E7%8B%AC%E7%AB%8B%E5%9E%8B">独立型</a></li>
</ul>
</li>
<li><a class="nav-link" href="#%E9%87%8D%E8%A4%87%E8%A1%8C%E3%81%AE%E5%89%8A%E9%99%A4"><span class="header-section-number">8.6</span> 重複行の削除</a></li>
<li>
<a class="nav-link" href="#%E5%88%97%E3%81%AE%E4%BD%9C%E6%88%90%E3%81%A8%E5%A4%89%E6%8F%9B"><span class="header-section-number">8.7</span> 列の作成と変換</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E6%96%B0%E3%81%97%E3%81%84%E5%88%97%E3%81%AE%E4%BD%9C%E6%88%90">新しい列の作成</a></li>
<li><a class="nav-link" href="#%E5%88%97%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E5%9E%8B%E3%81%AE%E5%A4%89%E6%8F%9B">列のデータ型の変換</a></li>
<li><a class="nav-link" href="#%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E5%8C%96%E3%81%95%E3%82%8C%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF">グループ化されたデータ</a></li>
<li><a class="nav-link" href="#clean_across">複数列の一斉変換</a></li>
<li><a class="nav-link" href="#coalesce">coalesce()</a></li>
<li><a class="nav-link" href="#%E7%B4%AF%E7%A9%8D%E8%A8%88%E7%AE%97">累積計算</a></li>
<li><a class="nav-link" href="#r-%E3%81%AE%E5%9F%BA%E6%9C%AC%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8-base-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B">R の基本パッケージ base を使用する</a></li>
<li><a class="nav-link" href="#%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%B8%E3%81%AE%E8%BF%BD%E5%8A%A0">パイプラインへの追加</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E5%80%A4%E3%81%AE%E5%86%8D%E5%AE%9A%E7%BE%A9"><span class="header-section-number">8.8</span> 値の再定義</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E7%89%B9%E5%AE%9A%E3%81%AE%E5%80%A4">特定の値</a></li>
<li><a class="nav-link" href="#%E8%AB%96%E7%90%86%E6%9D%A1%E4%BB%B6">論理条件</a></li>
<li><a class="nav-link" href="#%E5%8D%98%E7%B4%94%E3%81%AA%E8%AB%96%E7%90%86%E6%9D%A1%E4%BB%B6">単純な論理条件</a></li>
<li><a class="nav-link" href="#clean_case_when">複雑な論理条件</a></li>
<li><a class="nav-link" href="#%E6%AC%A0%E6%90%8D%E5%80%A4-1">欠損値</a></li>
<li><a class="nav-link" href="#%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0%E3%83%87%E3%82%A3%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%8A%E3%83%AAcleaning-dictionary">クリーニングディクショナリ（Cleaning dictionary）</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#num_cats"><span class="header-section-number">8.9</span> 数値カテゴリ</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E5%88%86%E5%B8%83%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">分布を確認する</a></li>
<li><a class="nav-link" href="#age_categories">age_categories()</a></li>
<li><a class="nav-link" href="#cut">cut()</a></li>
<li><a class="nav-link" href="#%E5%9B%9B%E5%88%86%E4%BD%8D%E6%95%B0%E3%81%AB%E3%82%88%E3%82%8B%E5%88%86%E5%89%B2">四分位数による分割</a></li>
<li><a class="nav-link" href="#%E5%9D%87%E7%AD%89%E3%81%AA%E5%A4%A7%E3%81%8D%E3%81%95%E3%81%AE%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97">均等な大きさのグループ</a></li>
<li><a class="nav-link" href="#case_when">case_when()</a></li>
<li><a class="nav-link" href="#%E3%83%91%E3%82%A4%E3%83%97%E3%83%81%E3%82%A7%E3%83%BC%E3%83%B3%E3%81%B8%E3%81%AE%E8%BF%BD%E5%8A%A0-1">パイプチェーンへの追加</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E8%A1%8C%E3%81%AE%E8%BF%BD%E5%8A%A0"><span class="header-section-number">8.10</span> 行の追加</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E4%B8%80%E8%A1%8C%E3%81%9A%E3%81%A4%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B">一行ずつ追加する</a></li>
<li><a class="nav-link" href="#%E8%A4%87%E6%95%B0%E8%A1%8C%E3%82%92%E7%B5%90%E5%90%88%E3%81%99%E3%82%8B">複数行を結合する</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E8%A1%8C%E3%81%AE%E6%8A%BD%E5%87%BA%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0"><span class="header-section-number">8.11</span> 行の抽出（フィルタリング）</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E5%8D%98%E7%B4%94%E3%81%AA%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0">単純なフィルタリング</a></li>
<li><a class="nav-link" href="#%E6%AC%A0%E6%90%8D%E5%80%A4%E3%81%AE%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0">欠損値のフィルタリング</a></li>
<li><a class="nav-link" href="#%E8%A1%8C%E7%95%AA%E5%8F%B7%E3%81%AB%E3%82%88%E3%82%8B%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0">行番号によるフィルタリング</a></li>
<li><a class="nav-link" href="#%E8%A4%87%E9%9B%91%E3%81%AA%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0">複雑なフィルタリング</a></li>
<li><a class="nav-link" href="#%E7%8B%AC%E7%AB%8B%E5%9E%8B-1">独立型</a></li>
<li><a class="nav-link" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E7%B4%A0%E6%97%A9%E3%81%8F%E7%A2%BA%E8%AA%8D">データを素早く確認</a></li>
</ul>
</li>
<li><a class="nav-link" href="#%E8%A1%8C%E5%8D%98%E4%BD%8D%E3%81%AE%E8%A8%88%E7%AE%97"><span class="header-section-number">8.12</span> 行単位の計算</a></li>
<li><a class="nav-link" href="#%E4%B8%A6%E3%81%B3%E6%9B%BF%E3%81%88%E3%82%A2%E3%83%AC%E3%83%B3%E3%82%B8%E3%81%A8%E3%82%BD%E3%83%BC%E3%83%88"><span class="header-section-number">8.13</span> 並び替え（アレンジとソート）</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>疫学のための R ハンドブック</strong>" was written by the handbook team. It was last built on 2022-10-10.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
