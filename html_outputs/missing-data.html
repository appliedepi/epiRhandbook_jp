<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>20 データの欠損 | 疫学のための R ハンドブック</title>
<meta name="author" content="the handbook team">
<meta name="description" content="この章では以下の内容について説明します： 欠損の評価 欠損による行のフィルタリング 時系列ごとの欠損のプロット プロットにおける NA の処理の仕方 欠損値の補完：MCAR, MAR, MNAR  20.1 準備  パッケージの読み込み 以下のコードを実行すると、分析に必要なパッケージが読み込まれます。このハンドブックでは、パッケージを読み込むために、pacman パッケージの...">
<meta name="generator" content="bookdown 0.31 with bs4_book()">
<meta property="og:title" content="20 データの欠損 | 疫学のための R ハンドブック">
<meta property="og:type" content="book">
<meta property="og:description" content="この章では以下の内容について説明します： 欠損の評価 欠損による行のフィルタリング 時系列ごとの欠損のプロット プロットにおける NA の処理の仕方 欠損値の補完：MCAR, MAR, MNAR  20.1 準備  パッケージの読み込み 以下のコードを実行すると、分析に必要なパッケージが読み込まれます。このハンドブックでは、パッケージを読み込むために、pacman パッケージの...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="20 データの欠損 | 疫学のための R ハンドブック">
<meta name="twitter:description" content="この章では以下の内容について説明します： 欠損の評価 欠損による行のフィルタリング 時系列ごとの欠損のプロット プロットにおける NA の処理の仕方 欠損値の補完：MCAR, MAR, MNAR  20.1 準備  パッケージの読み込み 以下のコードを実行すると、分析に必要なパッケージが読み込まれます。このハンドブックでは、パッケージを読み込むために、pacman パッケージの...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.2/transition.js"></script><script src="libs/bs3compat-0.4.2/tabs.js"></script><script src="libs/bs3compat-0.4.2/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.6.1/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.26/datatables.js"></script><link href="libs/dt-core-1.12.1/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.12.1/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.12.1/js/jquery.dataTables.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/tabwid-1.1.2/tabwid.css" rel="stylesheet">
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.9/grViz.js"></script><script src="libs/d3-4.5.0/d3.min.js"></script><script src="libs/sankey-1/sankey.js"></script><script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script><script src="libs/plotly-binding-4.10.1/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-2.11.1/plotly-latest.min.js"></script><link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="libs/vis-9.1.0/vis-network.min.js"></script><script src="libs/visNetwork-binding-2.1.2/visNetwork.js"></script><link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="libs/plotly-basic-2.11.1/plotly-basic-2.11.1.min.js"></script><script src="libs/plotly-cartesian-2.11.1/plotly-cartesian-2.11.1.min.js"></script><script src="libs/proj4js-2.3.15/proj4.js"></script><link href="libs/highcharts-9.3.1/css/motion.css" rel="stylesheet">
<script src="libs/highcharts-9.3.1/highcharts.js"></script><script src="libs/highcharts-9.3.1/highcharts-3d.js"></script><script src="libs/highcharts-9.3.1/highcharts-more.js"></script><script src="libs/highcharts-9.3.1/modules/stock.js"></script><script src="libs/highcharts-9.3.1/modules/map.js"></script><script src="libs/highcharts-9.3.1/modules/data.js"></script><script src="libs/highcharts-9.3.1/modules/exporting.js"></script><script src="libs/highcharts-9.3.1/modules/offline-exporting.js"></script><script src="libs/highcharts-9.3.1/modules/drilldown.js"></script><script src="libs/highcharts-9.3.1/modules/item-series.js"></script><script src="libs/highcharts-9.3.1/modules/overlapping-datalabels.js"></script><script src="libs/highcharts-9.3.1/modules/annotations.js"></script><script src="libs/highcharts-9.3.1/modules/export-data.js"></script><script src="libs/highcharts-9.3.1/modules/funnel.js"></script><script src="libs/highcharts-9.3.1/modules/heatmap.js"></script><script src="libs/highcharts-9.3.1/modules/treemap.js"></script><script src="libs/highcharts-9.3.1/modules/sankey.js"></script><script src="libs/highcharts-9.3.1/modules/dependency-wheel.js"></script><script src="libs/highcharts-9.3.1/modules/organization.js"></script><script src="libs/highcharts-9.3.1/modules/solid-gauge.js"></script><script src="libs/highcharts-9.3.1/modules/streamgraph.js"></script><script src="libs/highcharts-9.3.1/modules/sunburst.js"></script><script src="libs/highcharts-9.3.1/modules/vector.js"></script><script src="libs/highcharts-9.3.1/modules/wordcloud.js"></script><script src="libs/highcharts-9.3.1/modules/xrange.js"></script><script src="libs/highcharts-9.3.1/modules/tilemap.js"></script><script src="libs/highcharts-9.3.1/modules/venn.js"></script><script src="libs/highcharts-9.3.1/modules/gantt.js"></script><script src="libs/highcharts-9.3.1/modules/timeline.js"></script><script src="libs/highcharts-9.3.1/modules/parallel-coordinates.js"></script><script src="libs/highcharts-9.3.1/modules/bullet.js"></script><script src="libs/highcharts-9.3.1/modules/coloraxis.js"></script><script src="libs/highcharts-9.3.1/modules/dumbbell.js"></script><script src="libs/highcharts-9.3.1/modules/lollipop.js"></script><script src="libs/highcharts-9.3.1/modules/series-label.js"></script><script src="libs/highcharts-9.3.1/plugins/motion.js"></script><script src="libs/highcharts-9.3.1/custom/reset.js"></script><script src="libs/highcharts-9.3.1/modules/boost.js"></script><script src="libs/highchart-binding-0.9.4/highchart.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QXDW878QLX');
    </script><script type="text/javascript">
        // window.addEventListener("load", function() {
        //     document.getElementById('toc').firstChild.innerHTML = "章目次"; 
        // });
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementsByClassName("d-flex align-items-start justify-content-between")[0].children[0].children[0].innerHTML = "疫学のための R</br>ハンドブック";
            document.getElementById('toc').firstChild.innerHTML = "章目次"; 
            document.getElementById('main-nav').children[1].firstChild.innerHTML = "総目次";
            document.getElementById('search').setAttribute("placeholder", "検索");
        });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style_bs4.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">疫学のための R ハンドブック</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"></a></li>
<li class="book-part">本書について</li>
<li><a class="" href="editorial-style.html"><span class="header-section-number">1</span> 編集前記・技術注記</a></li>
<li><a class="" href="data-used.html"><span class="header-section-number">2</span> ハンドブックとデータのダウンロード</a></li>
<li class="book-part">基本編</li>
<li><a class="" href="basics.html"><span class="header-section-number">3</span> R の基礎</a></li>
<li><a class="" href="transition-to-R.html"><span class="header-section-number">4</span> Excel・Stata・SASとの比較</a></li>
<li><a class="" href="packages-suggested.html"><span class="header-section-number">5</span> 推奨パッケージ</a></li>
<li><a class="" href="r-projects.html"><span class="header-section-number">6</span> R プロジェクト</a></li>
<li><a class="" href="importing.html"><span class="header-section-number">7</span> データのインポート・エクスポート</a></li>
<li class="book-part">データマネジメント</li>
<li><a class="" href="cleaning.html"><span class="header-section-number">8</span> データクリーニングと主要関数</a></li>
<li><a class="" href="dates.html"><span class="header-section-number">9</span> 日付型データ</a></li>
<li><a class="" href="characters-strings.html"><span class="header-section-number">10</span> 文字型・文字列型データ</a></li>
<li><a class="" href="factors.html"><span class="header-section-number">11</span> 因子（ファクタ）型データ</a></li>
<li><a class="" href="pivoting.html"><span class="header-section-number">12</span> データの縦横変換</a></li>
<li><a class="" href="grouping.html"><span class="header-section-number">13</span> データのグループ化</a></li>
<li><a class="" href="joining-matching.html"><span class="header-section-number">14</span> データの結合</a></li>
<li><a class="" href="deduplication.html"><span class="header-section-number">15</span> 重複データの排除</a></li>
<li><a class="" href="iteration.html"><span class="header-section-number">16</span> ループと反復処理・リストの操作</a></li>
<li class="book-part">データ分析</li>
<li><a class="" href="tables-descriptive.html"><span class="header-section-number">17</span> 記述統計表の作り方</a></li>
<li><a class="" href="stat-tests.html"><span class="header-section-number">18</span> 基本的な統計的検定</a></li>
<li><a class="" href="regression.html"><span class="header-section-number">19</span> 単変量と多変量回帰</a></li>
<li><a class="active" href="missing-data.html"><span class="header-section-number">20</span> データの欠損</a></li>
<li><a class="" href="standardization.html"><span class="header-section-number">21</span> 標準化率</a></li>
<li><a class="" href="moving-average.html"><span class="header-section-number">22</span> 移動平均</a></li>
<li><a class="" href="time-series.html"><span class="header-section-number">23</span> 時系列分析とアウトブレイクの検出</a></li>
<li><a class="" href="epidemic-models.html"><span class="header-section-number">24</span> エピデミックモデリング</a></li>
<li><a class="" href="contact-tracing.html"><span class="header-section-number">25</span> 接触者の追跡</a></li>
<li><a class="" href="survey-analysis.html"><span class="header-section-number">26</span> 標本調査データ分析</a></li>
<li><a class="" href="survival-analysis.html"><span class="header-section-number">27</span> 生存時間解析</a></li>
<li><a class="" href="gis.html"><span class="header-section-number">28</span> GIS の基本</a></li>
<li class="book-part">データの可視化</li>
<li><a class="" href="tables-presentation.html"><span class="header-section-number">29</span> 見やすい表の作り方</a></li>
<li><a class="" href="ggplot-basics.html"><span class="header-section-number">30</span> ggplot の基本</a></li>
<li><a class="" href="ggplot-tips.html"><span class="header-section-number">31</span> ggplotのヒント</a></li>
<li><a class="" href="epicurves.html"><span class="header-section-number">32</span> 流行曲線（エピカーブ）</a></li>
<li><a class="" href="age-pyramid.html"><span class="header-section-number">33</span> 人口ピラミッドとリッカート尺度</a></li>
<li><a class="" href="heatmaps.html"><span class="header-section-number">34</span> ヒートマップ</a></li>
<li><a class="" href="diagrams.html"><span class="header-section-number">35</span> フローチャート・サンキー図・タイムライン</a></li>
<li><a class="" href="combination-analysis.html"><span class="header-section-number">36</span> 複数回答データの分析</a></li>
<li><a class="" href="transmission-chains.html"><span class="header-section-number">37</span> 感染連鎖</a></li>
<li><a class="" href="phylogenetic-trees.html"><span class="header-section-number">38</span> 系統樹</a></li>
<li><a class="" href="interactive-plots.html"><span class="header-section-number">39</span> 動的な図の作成</a></li>
<li class="book-part">レポートとダッシュボード</li>
<li><a class="" href="rmarkdown.html"><span class="header-section-number">40</span> R Markdown で作るレポート</a></li>
<li><a class="" href="reportfactory.html"><span class="header-section-number">41</span> ルーチンで作成するレポートの整理</a></li>
<li><a class="" href="flexdashboard.html"><span class="header-section-number">42</span> R Markdownで作るダッシュボード</a></li>
<li><a class="" href="shiny-basics.html"><span class="header-section-number">43</span> Shiny で作るダッシュボード</a></li>
<li class="book-part">その他</li>
<li><a class="" href="writing-functions.html"><span class="header-section-number">44</span> 関数の作成</a></li>
<li><a class="" href="directories.html"><span class="header-section-number">45</span> ディレクトリの操作</a></li>
<li><a class="" href="collaboration.html"><span class="header-section-number">46</span> Git と Github を使ったバージョン管理と共同作業</a></li>
<li><a class="" href="errors.html"><span class="header-section-number">47</span> よくあるエラー</a></li>
<li><a class="" href="help.html"><span class="header-section-number">48</span> ヘルプ</a></li>
<li><a class="" href="network-drives.html"><span class="header-section-number">49</span> ネットワークドライブで R を使用する場合</a></li>
<li><a class="" href="data-table.html"><span class="header-section-number">50</span> data.table パッケージを使用したデータ処理</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="missing-data" class="section level1" number="20">
<h1>
<span class="header-section-number">20</span> データの欠損<a class="anchor" aria-label="anchor" href="#missing-data"><i class="fas fa-link"></i></a>
</h1>
<p><img src="images/missingness.png" width="50%"><img src="images/missingness_overview.png" width="50%"></p>
<p>この章では以下の内容について説明します：</p>
<ol style="list-style-type: decimal">
<li>欠損の評価</li>
<li>欠損による行のフィルタリング</li>
<li>時系列ごとの欠損のプロット</li>
<li>プロットにおける <code>NA</code> の処理の仕方</li>
<li>欠損値の補完：MCAR, MAR, MNAR</li>
</ol>
<!-- ======================================================= --><div id="準備-11" class="section level2" number="20.1">
<h2>
<span class="header-section-number">20.1</span> 準備<a class="anchor" aria-label="anchor" href="#%E6%BA%96%E5%82%99-11"><i class="fas fa-link"></i></a>
</h2>
<div id="パッケージの読み込み-9" class="section level3 unnumbered">
<h3>パッケージの読み込み<a class="anchor" aria-label="anchor" href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF-9"><i class="fas fa-link"></i></a>
</h3>
<p>以下のコードを実行すると、分析に必要なパッケージが読み込まれます。このハンドブックでは、パッケージを読み込むために、pacman パッケージの p_load() を主に使用しています。p_load() は、必要に応じてパッケージをインストールし、現在の R セッションで使用するためにパッケージを読み込む関数です。また、すでにインストールされたパッケージは、R の基本パッケージである base （以下、base R）の library() を使用して読み込むこともできます。R のパッケージに関する詳細は <a href="basics.html#basics">R basics</a> の章をご覧ください。</p>
<div class="sourceCode" id="cb1001"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>  <span class="va">rio</span>,           <span class="co"># インポート／エクスポート</span></span>
<span>  <span class="va">tidyverse</span>,     <span class="co"># データの管理と視覚化</span></span>
<span>  <span class="va">naniar</span>,        <span class="co"># 欠損の評価と視覚化</span></span>
<span>  <span class="va">mice</span>           <span class="co"># 欠損値の補完</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div id="データのインポート-9" class="section level3 unnumbered">
<h3>データのインポート<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88-9"><i class="fas fa-link"></i></a>
</h3>
<p>エボラ出血熱の流行をシミュレートしたデータセットをインポートします。お手元の環境でこの章の内容を実行したい方は、 <a href="https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/case_linelists/linelist_cleaned.rds" class="download-button">クリック</a>して「前処理された」ラインリスト（linelist）データをダウンロードしてください&gt;（.rds 形式で取得できます）。データは <em>rio</em> パッケージの import() を利用してインポートしましょう（<em>rio</em> パッケージは、.xlsx、.csv、.rds など様々な種類のファイルを取り扱うことができます。詳細は、<a href="importing.html#importing">インポートとエクスポート</a> の章をご覧ください。）</p>
<div class="sourceCode" id="cb1002"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ラインリストをインポートする</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"linelist_cleaned.rds"</span><span class="op">)</span></span></code></pre></div>
<p>最初の 50 行を以下に示します。</p>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-feaacfb34394b221af1e" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-feaacfb34394b221af1e">{"x":{"filter":"top","vertical":false,"filterHTML":"<tr>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"2\" data-max=\"13\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1399075200000\" data-max=\"1406419200000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1399939200000\" data-max=\"1407024000000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1400025600000\" data-max=\"1407110400000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1400371200000\" data-max=\"1410566400000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"67\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\" disabled=\"\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"67\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"factor\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"width: 100%; display: none;\">\n      <select multiple=\"multiple\" style=\"width: 100%;\" data-options=\"[&quot;0-4&quot;,&quot;5-9&quot;,&quot;10-14&quot;,&quot;15-19&quot;,&quot;20-29&quot;,&quot;30-49&quot;,&quot;50-69&quot;,&quot;70+&quot;]\"><\/select>\n    <\/div>\n  <\/td>\n  <td data-type=\"factor\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"width: 100%; display: none;\">\n      <select multiple=\"multiple\" style=\"width: 100%;\" data-options=\"[&quot;0-4&quot;,&quot;5-9&quot;,&quot;10-14&quot;,&quot;15-19&quot;,&quot;20-24&quot;,&quot;25-29&quot;,&quot;30-34&quot;,&quot;35-39&quot;,&quot;40-44&quot;,&quot;45-49&quot;,&quot;50-54&quot;,&quot;55-59&quot;,&quot;60-64&quot;,&quot;65-69&quot;,&quot;70-74&quot;,&quot;75-79&quot;,&quot;80-84&quot;,&quot;85+&quot;]\"><\/select>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"-13.2697246824573\" data-max=\"-13.209391925612\" data-scale=\"13\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"8.45171855856465\" data-max=\"8.48802917129884\" data-scale=\"14\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"100\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"11\" data-max=\"241\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"20\" data-max=\"24\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"35.9\" data-max=\"38\" data-scale=\"1\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"428.994082840237\" data-scale=\"14\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"2\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],[4,4,2,3,3,3,4,4,4,4,4,4,6,5,6,9,10,8,7,6,7,6,8,6,10,8,6,12,5,8,7,9,11,5,8,5,6,11,7,9,7,8,9,12,13,9,8,10,8,7],["2014-05-08",null,null,"2014-05-04","2014-05-18","2014-05-03","2014-05-22","2014-05-28",null,null,"2014-05-30","2014-05-28","2014-06-14","2014-06-07","2014-06-09",null,null,null,"2014-06-23","2014-06-18","2014-06-24",null,null,"2014-07-03",null,"2014-07-10","2014-06-14",null,"2014-06-18","2014-06-29","2014-07-02","2014-07-12","2014-07-12","2014-06-13","2014-07-15","2014-06-20",null,null,"2014-07-20",null,"2014-07-12","2014-07-19","2014-07-18","2014-07-18","2014-07-27",null,"2014-07-19","2014-07-26","2014-07-24",null],["2014-05-13","2014-05-13","2014-05-16","2014-05-18","2014-05-21","2014-05-22","2014-05-27","2014-06-02","2014-06-05","2014-06-05","2014-06-06","2014-06-13","2014-06-16","2014-06-17","2014-06-18","2014-06-19","2014-06-22","2014-06-23","2014-06-25","2014-06-26","2014-06-28","2014-07-02","2014-07-08","2014-07-09","2014-07-09","2014-07-10","2014-07-12","2014-07-12","2014-07-13","2014-07-13","2014-07-14","2014-07-15","2014-07-16","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-22","2014-07-22","2014-07-24","2014-07-24","2014-07-25","2014-07-25","2014-07-27","2014-07-29","2014-07-30",null,"2014-08-01","2014-08-02","2014-08-03"],["2014-05-15","2014-05-14","2014-05-18","2014-05-20","2014-05-22","2014-05-23","2014-05-29","2014-06-03","2014-06-06","2014-06-07","2014-06-08","2014-06-15","2014-06-17","2014-06-17","2014-06-20","2014-06-19","2014-06-23","2014-06-24","2014-06-27","2014-06-28","2014-06-29","2014-07-03","2014-07-09","2014-07-09","2014-07-11","2014-07-11","2014-07-13","2014-07-14","2014-07-14","2014-07-13","2014-07-14","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-20","2014-07-20","2014-07-22","2014-07-24","2014-07-26","2014-07-24","2014-07-27","2014-07-25","2014-07-27","2014-07-31","2014-08-01","2014-08-03","2014-08-02","2014-08-02","2014-08-04"],[null,"2014-05-18","2014-05-30",null,"2014-05-29","2014-05-24","2014-06-01","2014-06-07","2014-06-18","2014-06-09","2014-06-15",null,"2014-07-09",null,"2014-06-30","2014-07-11","2014-07-01","2014-06-25","2014-07-06","2014-07-02","2014-07-09","2014-07-07","2014-07-20",null,"2014-07-22","2014-07-16","2014-07-14","2014-07-20","2014-07-16","2014-07-19","2014-07-27","2014-07-19",null,"2014-07-26","2014-08-14","2014-08-01","2014-07-23","2014-08-28","2014-07-28","2014-07-19",null,"2014-08-03",null,null,null,"2014-08-06","2014-08-21","2014-09-13","2014-08-04",null],[null,"Recover","Recover",null,"Recover","Recover","Recover","Death","Recover","Death","Death","Death","Recover","Recover",null,"Recover",null,null,"Death","Death","Recover",null,null,null,"Death",null,"Death","Death",null,"Death","Recover","Death","Recover","Death","Recover",null,"Death","Recover","Recover","Death",null,null,"Death","Death","Death","Death","Recover",null,"Death","Death"],["m","f","m","f","m","f","f","f","m","f","m","m","m","f","f","m","f","f","f","f","m","m","f","m","f","m","m","f","m","f","f","f","m","m","f","m","f","f","f","m","f","m","f","m","m","f","m","f","m","m"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["0-4","0-4","50-69","15-19","0-4","15-19","15-19","0-4","50-69","20-29","10-14","30-49","15-19","5-9","5-9","10-14","30-49","15-19","10-14","10-14","15-19","50-69","10-14","20-29","5-9","0-4","30-49","5-9","50-69","10-14","10-14","20-29","20-29","30-49","0-4","10-14","0-4","15-19","20-29","30-49","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-29","20-29","10-14"],["0-4","0-4","55-59","15-19","0-4","15-19","15-19","0-4","60-64","25-29","10-14","40-44","15-19","5-9","5-9","10-14","35-39","15-19","10-14","10-14","15-19","50-54","10-14","25-29","5-9","0-4","30-34","5-9","65-69","10-14","10-14","20-24","20-24","45-49","0-4","10-14","0-4","15-19","20-24","35-39","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-24","25-29","10-14"],["Other","Missing","St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Port Hospital","Missing","Missing","Missing","Missing","Port Hospital","Military Hospital","Missing","Missing","Other","Port Hospital","Port Hospital","Port Hospital","Missing","Other","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)","Missing","Other","Missing","St. Mark's Maternity Hospital (SMMH)","Military Hospital","Port Hospital","Central Hospital","Military Hospital","Central Hospital","Missing","Military Hospital","Other","Missing","Missing","Port Hospital","Port Hospital","Port Hospital","Missing","Central Hospital","Military Hospital","Other","Other","Other","Missing","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","Missing"],[-13.2157351064963,-13.2152339775486,-13.212910703914,-13.2363711169728,-13.2228638912441,-13.222625321098,-13.2331547837254,-13.2320975453153,-13.2225511595637,-13.2572163655863,-13.2206286746001,-13.253989309478,-13.2385127873491,-13.209391925612,-13.2157278814899,-13.2243437095992,-13.2336087079551,-13.21422143145,-13.2339681355349,-13.2535640411465,-13.2250089377786,-13.2160657166043,-13.2680671272333,-13.2266742923612,-13.2160179088168,-13.2482584611565,-13.2156319199566,-13.2142410663192,-13.2614879104088,-13.2452992638476,-13.2630592726116,-13.2343341712241,-13.2199077448676,-13.2227293309912,-13.2343062806506,-13.218781651651,-13.2483677722899,-13.2097478342339,-13.2680867723786,-13.2587535457526,-13.262635786914,-13.2697246824573,-13.2209026809759,-13.2330734719715,-13.2680923666905,-13.2547212675054,-13.2573683214693,-13.2137356012883,-13.2175973322257,-13.2486407324245],[8.46897295100924,8.45171855856465,8.46481700596819,8.4754761613651,8.46082377490923,8.46183062600728,8.46272931462646,8.46144367534271,8.46191259217774,8.47292327643506,8.48401630165138,8.45837125340844,8.47761705512509,8.47570184950483,8.47779946878972,8.47145134147474,8.47804840685363,8.48528034195779,8.46957530395867,8.45957352078114,8.47404889511544,8.48802917129884,8.473437335922,8.48408263734462,8.46242233645879,8.47026822126572,8.46398447480533,8.4641347894342,8.45623094629607,8.48334624336805,8.47493999153642,8.47832062438022,8.4693933891765,8.48480589906514,8.47121232619015,8.48438437371817,8.48466158574339,8.47714159984428,8.46238127010609,8.45568597813113,8.4632880274758,8.47940722413856,8.46353857052336,8.46178968158864,8.47508713872833,8.45825808128071,8.4532568143863,8.4732571907655,8.47911586641933,8.48480340615605],["f547d6",null,null,"f90f5f","11f8ea","aec8ec","893f25","133ee7",null,null,"996f3a","133ee7","37a6f6","9f6884","4802b1",null,null,null,"a75c7f","8e104d","ab634e",null,null,"b799eb",null,"5d9e4d","a15e13",null,"ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277",null,null,"d6584f",null,"312ecf","52ea64","cfd79c","d145b7","174288",null,"53608c","3b096b","f5c142",null],["other",null,null,"other","other","other","other","other",null,null,"other","other","other","other","other",null,null,null,"other","other","other",null,null,"other",null,"other","other",null,"other","funeral","other","funeral","other","other","other","funeral",null,null,"other",null,"other","other","other","other","other",null,"funeral","other","other",null],[27,25,91,41,36,56,47,0,86,69,67,84,68,44,34,66,78,47,53,47,71,86,53,69,38,46,68,37,100,56,50,57,65,72,29,69,37,48,54,71,47,61,47,35,53,16,13,59,69,67],[48,59,238,135,71,116,87,11,226,174,112,186,174,90,91,152,214,137,117,131,150,241,131,161,80,69,188,66,233,142,110,182,164,214,26,157,39,154,133,168,100,125,123,67,134,31,36,125,183,169],[22,22,21,23,23,21,21,22,22,22,22,22,22,21,23,22,23,21,22,23,21,23,21,24,23,22,24,23,20,24,24,20,24,21,22,21,23,22,23,23,23,22,23,22,22,22,23,22,22,22],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","no","no","no","no","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","yes","no",null,"no","no","no","yes","no",null,"no","no","yes",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","yes","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","yes","yes","yes","yes","yes","yes","yes","yes","yes",null,"yes","yes","yes","yes","yes",null,"yes","yes","yes",null,null,"yes","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","yes","yes","yes","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","yes","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"yes","yes",null,"no","no",null,"no","no","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","no","yes","no","no","no","yes","no","no","no",null,"no","yes","no","no","no",null,"no","no","no",null,null,"no","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","no","yes","yes","yes",null],[36.8,36.9,36.9,36.8,36.9,37.6,37.3,37,36.4,35.9,36.5,36.9,36.5,37.1,36.5,37.3,37,38,38,36,37,36.7,36.9,36.5,37,36.5,37.6,36.6,36.6,36.2,36.4,37.1,37.5,37.5,37.4,36.9,36.4,37.3,37,37.8,36.5,37.5,36.7,37,37.3,36.6,36.5,36.6,37.6,36.8],[null,"09:36","16:48","11:22","12:60","14:13","14:33","09:25","11:16","10:55","16:03","11:14","12:42","11:06","09:10","08:45",null,"15:41","13:34","18:58","12:43","16:33","14:29","07:18","08:11","16:32","16:17","07:32","17:45",null,"13:24","14:43","02:33","11:36","17:28","16:27",null,"20:49",null,"11:38","14:25","13:42","21:22","13:33","19:06","17:14","20:09",null,"10:23","09:09"],[117.1875,71.8184429761563,16.0652496292635,22.4965706447188,71.4144019043841,41.6171224732461,62.0953890870657,0,16.8376536925366,22.7903289734443,53.4119897959184,24.2802636142907,22.4600343506408,54.320987654321,41.0578432556455,28.5664819944598,17.0320552013276,25.0412914912888,38.7172182043977,27.3876813705495,31.5555555555556,14.8069075945662,30.8839811199813,26.6193433895297,59.375,96.6183574879227,19.2394748755093,84.9403122130395,18.4199377406104,27.7722674072605,41.3223140495868,17.2080666586161,24.1671624033314,15.7218971089178,428.994082840237,27.9930220292912,243.261012491782,20.2395007589813,30.527446435638,25.15589569161,47,39.04,31.0661643201798,77.9683671196257,29.5165961238583,166.493236212279,100.308641975309,37.76,20.6037803457852,23.458562375267],[2,1,2,2,1,1,2,1,1,2,2,2,1,0,2,0,1,1,2,2,1,1,1,0,2,1,1,2,1,0,0,2,1,1,2,2,1,0,2,2,0,2,0,0,2,2,null,1,0,1]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>generation<\/th>\n      <th>date_infection<\/th>\n      <th>date_onset<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>date_outcome<\/th>\n      <th>outcome<\/th>\n      <th>gender<\/th>\n      <th>age<\/th>\n      <th>age_unit<\/th>\n      <th>age_years<\/th>\n      <th>age_cat<\/th>\n      <th>age_cat5<\/th>\n      <th>hospital<\/th>\n      <th>lon<\/th>\n      <th>lat<\/th>\n      <th>infector<\/th>\n      <th>source<\/th>\n      <th>wt_kg<\/th>\n      <th>ht_cm<\/th>\n      <th>ct_blood<\/th>\n      <th>fever<\/th>\n      <th>chills<\/th>\n      <th>cough<\/th>\n      <th>aches<\/th>\n      <th>vomit<\/th>\n      <th>temp<\/th>\n      <th>time_admission<\/th>\n      <th>bmi<\/th>\n      <th>days_onset_hosp<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,8,10,14,15,18,19,20,26,28,29]}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="インポート時における欠損の変換" class="section level3 unnumbered">
<h3>インポート時における欠損の変換<a class="anchor" aria-label="anchor" href="#%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%E6%99%82%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E6%AC%A0%E6%90%8D%E3%81%AE%E5%A4%89%E6%8F%9B"><i class="fas fa-link"></i></a>
</h3>
<p>データをインポートする際に、欠損、と分類されるべき値については少し注意が必要です。例えば、99、999、“Missing”、空欄（““）、または 空のスペースを含むセル（” “） などです。インポートのコマンドと一緒にこれらの値を <code>NA</code> （R において欠損値を示す）に変換することが出来ます。
使用するコマンドがファイルのタイプによって異なるので、詳細については <a href="importing.html#import_missing">データの欠損</a> のインポートのセクションを参考にしてください。</p>
<!-- ======================================================= -->
</div>
</div>
<div id="r-における欠損値" class="section level2" number="20.2">
<h2>
<span class="header-section-number">20.2</span> R における欠損値<a class="anchor" aria-label="anchor" href="#r-%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E6%AC%A0%E6%90%8D%E5%80%A4"><i class="fas fa-link"></i></a>
</h2>
<p>以下では、R における欠損の表示や評価の仕方、また、それに関連するいくつかの値や関数について見ていきたいと思います。</p>
<div id="na" class="section level3 unnumbered">
<h3>
<code>NA</code><a class="anchor" aria-label="anchor" href="#na"><i class="fas fa-link"></i></a>
</h3>
<p>R においては、欠損値は予約語（特別な値）として指定された <code>NA</code> で表示されます。これは引用符<u>なし</u>で用いることに注意が必要です。“NA” とは異なり、これは通常の文字と同じ扱いとなります（ビートルズの Hey Jude の歌詞と同じです）。</p>
<p>データ内では “99”、“Missing”、または “Unknown” というように欠損が表されていることもあります。また、空の文字値 ““（空欄のように見える）や、スペース” ” で表されていることもあります。これらについては、<a href="importing.html#import_missing">インポート時に <code>NA</code> に変換する</a> もしくはデータを <code><a href="https://dplyr.tidyverse.org/reference/na_if.html">na_if()</a></code> を用いてクリーニングする必要があります。</p>
<p>データクリーニングにおいて、逆に全ての <code>NA</code> を “Missing” に変換したり、<code><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na()</a></code> を用いたり、因子型の場合には <code><a href="https://forcats.tidyverse.org/reference/fct_explicit_na.html">fct_explicit_na()</a></code> を用いたりして処理することもできます。</p>
</div>
<div id="いろいろな-na" class="section level3 unnumbered">
<h3>いろいろな <code>NA</code><a class="anchor" aria-label="anchor" href="#%E3%81%84%E3%82%8D%E3%81%84%E3%82%8D%E3%81%AA-na"><i class="fas fa-link"></i></a>
</h3>
<p>多くの場合は、<code>NA</code> が欠損値を示し、それで全てがうまくいきます。しかし、オブジェクトのデータ型（文字値、数値、など）によって<u>異なる</u> <code>NA</code> を用いる必要が出てくる場合があります。あまり頻繁に起こることではないですが、注意が必要です。<br>
多いのは、<strong>dplyr</strong> パッケージの <code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code> を用いて新しい列を作成する場合などです。 <a href="cleaning.html#cleaning">データクリーニングと主要関数</a> の章で述べたように、この関数はデータフレーム内の全ての行に対して、ある基準（コードの右辺に書かれている条件）に合致するかどうかを評価し、新しい値（コードの左辺に書かれている値）を作成します。<u>右辺に書かれている値は、全て同じデータ型でないといけません。</u></p>
<div class="sourceCode" id="cb1003"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  </span>
<span>  <span class="co"># "age" 列から新しく "age_years" 列を作成する</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age_years <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">age_unit</span> <span class="op">==</span> <span class="st">"years"</span>  <span class="op">~</span> <span class="va">age</span>,       <span class="co"># age が年であれば、そのままの値を返す</span></span>
<span>    <span class="va">age_unit</span> <span class="op">==</span> <span class="st">"months"</span> <span class="op">~</span> <span class="va">age</span><span class="op">/</span><span class="fl">12</span>,    <span class="co"># age が月であれば、12 で割る</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">age_unit</span><span class="op">)</span>      <span class="op">~</span> <span class="va">age</span>,       <span class="co"># age のユニットが欠損であれば、years とする</span></span>
<span>    <span class="cn">TRUE</span>                 <span class="op">~</span> <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span> <span class="co"># 他のすべての場合には欠損とする</span></span></code></pre></div>
<p>右辺に <code>NA</code> を持ってきたい場合は、以下に示している特殊な <code>NA</code> のうちのどれかを用いる必要があります。他の右辺の値が文字型の場合は “Missing” か、<code>NA_character_</code> を使用する必要があります。他の右辺が日付型や数字型の場合は <code>NA_real_</code> を用いります。条件式であった場合 <code>NA</code> を用いることが出来ます。</p>
<ul>
<li>
<code>NA</code> - 条件式 TRUE/FALSE において用いる</li>
<li>
<code>NA_character_</code> - 文字値に用いる</li>
<li>
<code>NA_real_</code> - 日付型、数字値に用いる</li>
</ul>
<p>繰り返しになりますが、新しい行を <code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code> を用いて作成しようと<u>しない限り</u>は、こうした例に出会うことはありません。より詳細について知りたい方は、<a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/NA.html">R documentation on NA</a> を参考にしてください。</p>
</div>
<div id="null" class="section level3 unnumbered">
<h3>
<code>NULL</code><a class="anchor" aria-label="anchor" href="#null"><i class="fas fa-link"></i></a>
</h3>
<p>他に R で用いられる値に、<code>NULL</code> があります。これは、条件が正でも誤でもないことを示しています。すなわち、値が定義されない関数などを適用した際に返されます。一般的には、関数を書いたり、ある特定の条件において <code>NULL</code> を返すことを指示する <a href="#shiny-basicss"><strong>shiny</strong> app</a> を書いたりする場合を除いて、<code>NULL</code> を値として指定することはありません。</p>
<p>Nullかどうかは is.null() を用いて評価することができ、as.null() を用いて変換することができます。</p>
<p><code>NULL</code> と <code>NA</code> の違いについては、<a href="https://www.r-bloggers.com/2010/04/r-na-vs-null/">ブログのポスト</a> を見てください。</p>
</div>
<div id="nan" class="section level3 unnumbered">
<h3>
<code>NaN</code><a class="anchor" aria-label="anchor" href="#nan"><i class="fas fa-link"></i></a>
</h3>
<p>NaN は値としてとることが不可能なものを表す特別な値です。例えば、0 を 0 で割れ、と R に指示したような場合です。<code><a href="https://rdrr.io/r/base/is.finite.html">is.nan()</a></code> を用いて評価することが出来、また、補足関数として<code><a href="https://rdrr.io/r/base/is.finite.html">is.infinite()</a></code> や <code><a href="https://rdrr.io/r/base/is.finite.html">is.finite()</a></code> が存在します。</p>
</div>
<div id="inf" class="section level3 unnumbered">
<h3>
<code>Inf</code><a class="anchor" aria-label="anchor" href="#inf"><i class="fas fa-link"></i></a>
</h3>
<p>Inf は無限大を表します。例えば、ある値を0で割った場合などです。</p>
<p>これらの欠損値がどのように影響するかを簡単な例で示しましょう。例えば、<code>z &lt;- c(1, 22, NA, Inf, NaN, 5)</code> で作成される <code>z</code> というベクターまたはコラムがあるとします。</p>
<p>一番大きな値を見つけるために <code><a href="https://rdrr.io/r/base/Extremes.html">max()</a></code> をこのコラムに適用することを考えます。<code>na.rm = TRUE</code> を用いることで、計算から <code>NA</code> を除くことが出来ます。しかし、<code>Inf</code> や <code>NaN</code> は残り、結果として <code>Inf</code> が返されます。これは、[ ] と is.finite() を用いて有限な値のみを含むサブセットを作成して計算することで解決することができます： max(z[is.finite(z)]) 。</p>
<div class="sourceCode" id="cb1004"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">22</span>, <span class="cn">NA</span>, <span class="cn">Inf</span>, <span class="cn">NaN</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span>                           <span class="co"># NA が返される</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">z</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>                  <span class="co"># Inf が返される</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html">is.finite</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>             <span class="co"># 22 が返される</span></span></code></pre></div>
</div>
<div id="例" class="section level3 unnumbered">
<h3>例<a class="anchor" aria-label="anchor" href="#%E4%BE%8B"><i class="fas fa-link"></i></a>
</h3>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="74%">
<col width="25%">
</colgroup>
<thead><tr class="header">
<th>R コマンド</th>
<th>出力</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>5 / 0</code></td>
<td><code>Inf</code></td>
</tr>
<tr class="even">
<td><code>0 / 0</code></td>
<td><code>NaN</code></td>
</tr>
<tr class="odd">
<td><code>5 / NA</code></td>
<td><code>NA</code></td>
</tr>
<tr class="even">
<td>
<code>5 / Inf |</code>0NA - 5<code>|</code>NAInf / 5<code>|</code>Infclass(NA)<code>| "logical"</code>class(NaN)<code>| "numeric"</code>class(Inf)<code>| "numeric"</code>class(NULL)`</td>
<td>“NULL”</td>
</tr>
</tbody>
</table></div>
<p>“NAs introduced by coercion” はよくある警告メッセージです。数値のベクターに文字値を挿入しようとするなどの不正な操作を行った場合に起こります。</p>
<div class="sourceCode" id="cb1005"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"10"</span>, <span class="st">"20"</span>, <span class="st">"thirty"</span>, <span class="st">"40"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: NAs introduced by coercion</code></pre>
<pre><code>## [1] 10 20 NA 40</code></pre>
<p><code>NULL</code> はベクターにおいては無視されます。</p>
<div class="sourceCode" id="cb1008"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_vector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="cn">NA</span>, <span class="fl">10</span>, <span class="cn">NULL</span><span class="op">)</span>  <span class="co"># define</span></span>
<span><span class="va">my_vector</span>                         <span class="co"># print</span></span></code></pre></div>
<pre><code>## [1] 25 NA 10</code></pre>
<p>ある一つの値の分散を求めようとすると <code>NA</code> が返されます。</p>
<div class="sourceCode" id="cb1010"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="fl">22</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] NA</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="便利な関数" class="section level2" number="20.3">
<h2>
<span class="header-section-number">20.3</span> 便利な関数<a class="anchor" aria-label="anchor" href="#%E4%BE%BF%E5%88%A9%E3%81%AA%E9%96%A2%E6%95%B0"><i class="fas fa-link"></i></a>
</h2>
<p>以下では、R の <strong>base R</strong> の関数で、欠損値を評価したり扱ったりする際に便利なものを示します。</p>
<div id="is.na-と-is.na" class="section level3 unnumbered">
<h3>
<code>is.na()</code> と <code>!is.na()</code><a class="anchor" aria-label="anchor" href="#is.na-%E3%81%A8-is.na"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://rdrr.io/r/base/NA.html">is.na()</a></code> は欠損値を特定する場合、または欠損でない値を特定する場合（<code>!</code> を一緒に用いります）に使います。どちらも理論値（<code>TRUE</code> or <code>FALSE</code>）が返されます。 返されたベクトルに <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code> を適用、例えば <code>sum(is.na(linelist$date_outcome))</code> とすることで、<code>TRUE</code> の数を計算することが出来ます。</p>
<div class="sourceCode" id="cb1012"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_vector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">56</span>, <span class="cn">NA</span>, <span class="fl">5</span>, <span class="cn">NA</span>, <span class="fl">22</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">my_vector</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE</code></pre>
<div class="sourceCode" id="cb1014"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">my_vector</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1]  TRUE  TRUE  TRUE FALSE  TRUE FALSE  TRUE</code></pre>
<div class="sourceCode" id="cb1016"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">my_vector</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 2</code></pre>
</div>
<div id="na.omit" class="section level3 unnumbered">
<h3>
<code>na.omit()</code><a class="anchor" aria-label="anchor" href="#na.omit"><i class="fas fa-link"></i></a>
</h3>
<p>この関数をデータフレームに対して適用することで、<u>一つでも</u>欠損値を含む行を除くことが出来ます。これもまた、<strong>base R</strong> に含まれます。
ベクトルに対して適用すると、<code>NA</code> を除くことが出来ます。例えば：</p>
<div class="sourceCode" id="cb1018"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="va">my_vector</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1]  1  4 56  5 22
## attr(,"na.action")
## [1] 4 6
## attr(,"class")
## [1] "omit"</code></pre>
</div>
<div id="drop_na" class="section level3 unnumbered">
<h3>
<code>drop_na()</code><a class="anchor" aria-label="anchor" href="#drop_na"><i class="fas fa-link"></i></a>
</h3>
<p><a href="cleaning.html#cleaning">データクリーニング</a> の際に便利な <strong>tidyr</strong> パッケージの関数です。括弧内を空にして走らせると、欠損値を<u>一つでも含む</u>行を除くことが出来ます。括弧内で列の名前を指定することで、その列内の値が欠損している行を除くことが出来ます。列の指定には “tidyselect” を用いることもできます。</p>
<div class="sourceCode" id="cb1020"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">case_id</span>, <span class="va">date_onset</span>, <span class="va">age</span><span class="op">)</span> <span class="co"># これらの列の値を欠損している行を除く</span></span></code></pre></div>
</div>
<div id="na.rm-true" class="section level3 unnumbered">
<h3>
<code>na.rm = TRUE</code><a class="anchor" aria-label="anchor" href="#na.rm-true"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://rdrr.io/r/base/Extremes.html">max()</a></code>、<code><a href="https://rdrr.io/r/base/Extremes.html">min()</a></code>、<code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code> または、<code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> などの計算を行う関数を用いるときに NA が一つでも存在すると、<code>NA</code> が返されます。このデフォルトの挙動は意図的なもので、データの中に欠損がある場合の注意喚起となります。</p>
<p>計算から欠損値を除くことで、この警告を回避することが出来ます。そのためには、<code>na.rm = TRUE</code> （“na.rm” 引数 は “remove <code>NA</code>” の意）を一緒に用いります。</p>
<div class="sourceCode" id="cb1021"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_vector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">56</span>, <span class="cn">NA</span>, <span class="fl">5</span>, <span class="cn">NA</span>, <span class="fl">22</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">my_vector</span><span class="op">)</span>     </span></code></pre></div>
<pre><code>## [1] NA</code></pre>
<div class="sourceCode" id="cb1023"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">my_vector</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 17.6</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="データフレーム内の欠損を評価する" class="section level2" number="20.4">
<h2>
<span class="header-section-number">20.4</span> データフレーム内の欠損を評価する<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E5%86%85%E3%81%AE%E6%AC%A0%E6%90%8D%E3%82%92%E8%A9%95%E4%BE%A1%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h2>
<p>データフレーム <code>linelist</code> 内の欠損を評価し、視覚化するのには <strong>naniar</strong> パッケージが便利です。</p>
<div class="sourceCode" id="cb1025"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># パッケージをインストールするもしくは読み込む</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">naniar</span><span class="op">)</span></span></code></pre></div>
<div id="欠損の数を定量化する" class="section level3 unnumbered">
<h3>欠損の数を定量化する<a class="anchor" aria-label="anchor" href="#%E6%AC%A0%E6%90%8D%E3%81%AE%E6%95%B0%E3%82%92%E5%AE%9A%E9%87%8F%E5%8C%96%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p>全ての欠損の値の割合を示すには <code>pct_miss()</code> を、数を示すには <code>n_miss()</code> を用いります。</p>
<div class="sourceCode" id="cb1026"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># すべてのデータフレーム内の欠損値の割合</span></span>
<span><span class="fu">pct_miss</span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 6.688745</code></pre>
<p>以下の 2 つの関数は、それぞれ、欠損値を含む行の割合、または欠損が一つもない行の割合を返してくれます。<code>NA</code> は欠損を意味しますが、<code>""</code> や <code>" "</code> は欠損としてはカウントされないことに注意してください。</p>
<div class="sourceCode" id="cb1028"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 欠損値を含む行の割合を示す</span></span>
<span><span class="fu">pct_miss_case</span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span>   <span class="co"># 数を示すには n_miss() を用いる</span></span></code></pre></div>
<pre><code>## [1] 69.12364</code></pre>
<div class="sourceCode" id="cb1030"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># コンプリートケース（欠損のない行）の割合を示す  </span></span>
<span><span class="fu">pct_complete_case</span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span> <span class="co"># 数を示すには n_complete() を用いる</span></span></code></pre></div>
<pre><code>## [1] 30.87636</code></pre>
</div>
<div id="欠損状況を視覚化する" class="section level3 unnumbered">
<h3>欠損状況を視覚化する<a class="anchor" aria-label="anchor" href="#%E6%AC%A0%E6%90%8D%E7%8A%B6%E6%B3%81%E3%82%92%E8%A6%96%E8%A6%9A%E5%8C%96%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p><code>gg_miss_var()</code> を用いることで、それぞれの列における欠損値の数（もしくは割合）を示すことが出来ます。</p>
<ul>
<li>プロットをグループごとに見たい場合は、<code>facet =</code> で列の名前（引用符にいれない）を指定することが出来ます</li>
<li>デフォルトでは、割合ではなく数が表示されます。割合にしたい場合は <code>show_pct = TRUE</code> で指定します</li>
<li>通常の <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> 通り、軸やタイトルのラベルを追加したい場合は <code>+ labs(...)</code> を用いて行うことが出来ます</li>
</ul>
<div class="sourceCode" id="cb1032"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">gg_miss_var</span><span class="op">(</span><span class="va">linelist</span>, show_pct <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: The `guide` argument in `scale_*()` cannot be `FALSE`. This was deprecated in
## ggplot2 3.3.4.
## ℹ Please use "none" instead.
## ℹ The deprecated feature was likely used in the naniar package.
##   Please report the issue at &lt;https://github.com/njtierney/naniar/issues&gt;.</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-778-1.png" width="672"></div>
<p>以下では、データが <code>%&gt;%</code> を用いて関数に渡されています。<code>facet =</code> を用いても、データを分けることが出来ます。</p>
<div class="sourceCode" id="cb1034"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">gg_miss_var</span><span class="op">(</span>show_pct <span class="op">=</span> <span class="cn">TRUE</span>, facet <span class="op">=</span> <span class="va">outcome</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-779-1.png" width="672"></div>
<p>どの値が欠損しているかを示すために、<code>vis_miss()</code> を用いてデータフレームをヒートマップで表すことが出来ます。また 特定の列をデータフレームから select() して関数にその列だけを渡すこともできます。</p>
<div class="sourceCode" id="cb1035"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># データフレーム全体に対して欠損のヒートプロットを示す  </span></span>
<span><span class="fu">vis_miss</span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: `gather_()` was deprecated in tidyr 1.2.0.
## ℹ Please use `gather()` instead.
## ℹ The deprecated feature was likely used in the visdat package.
##   Please report the issue at &lt;https://github.com/ropensci/visdat/issues&gt;.</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-780-1.png" width="672"></div>
</div>
<div id="欠損状況の関係性を探り可視化する" class="section level3 unnumbered">
<h3>欠損状況の関係性を探り、可視化する<a class="anchor" aria-label="anchor" href="#%E6%AC%A0%E6%90%8D%E7%8A%B6%E6%B3%81%E3%81%AE%E9%96%A2%E4%BF%82%E6%80%A7%E3%82%92%E6%8E%A2%E3%82%8A%E5%8F%AF%E8%A6%96%E5%8C%96%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p>存在しないものをどうやって視覚化すればよいのでしょうか？デフォルトでは、<code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> を使うと、欠損値を除いてプロットを作成してしまいます。</p>
<p><strong>naniar</strong> パッケージの <code>geom_miss_point()</code> を用いれば解決します。2 つの列から散布図を作成するときに、ある一方の変数は存在し、片方の変数は欠損である場合には、欠損値をその列の最小値よりもさらに 10% 小さな値に変換し、違う色で散布図上に示してくれます。</p>
<p>以下に示している散布図では、赤いドットはある一方の変数は存在しているが片方の変数が欠損している場合を示しています。これによって欠損していない値に対する欠損している値の分布を視覚的に確認することが出来ます。</p>
<div class="sourceCode" id="cb1037"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">linelist</span>,</span>
<span>  mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age_years</span>, y <span class="op">=</span> <span class="va">temp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>     </span>
<span>  <span class="fu">geom_miss_point</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-781-1.png" width="672"></div>
<p><u>別の列によって層別化した</u>あとに欠損を評価したい場合は、<code>gg_miss_fct()</code> を使います。これは、<u>因子型（または日付）の列の値ごとに</u>データフレームの欠損の割合をヒートマップで示してくれます。</p>
<div class="sourceCode" id="cb1038"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">gg_miss_fct</span><span class="op">(</span><span class="va">linelist</span>, <span class="va">age_cat5</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-782-1.png" width="672"></div>
<p>この関数を日付ごとにデータフレームを示すのに用いると、欠損が時系列を追うごとにどのように変化しているかを示すことも出来ます。</p>
<div class="sourceCode" id="cb1039"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">gg_miss_fct</span><span class="op">(</span><span class="va">linelist</span>, <span class="va">date_onset</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: Removed 29 rows containing missing values (`geom_tile()`).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-783-1.png" width="672"></div>
</div>
<div id="付随する列" class="section level3 unnumbered">
<h3>「付随する」列<a class="anchor" aria-label="anchor" href="#%E4%BB%98%E9%9A%8F%E3%81%99%E3%82%8B%E5%88%97"><i class="fas fa-link"></i></a>
</h3>
<p>ある一方の列の欠損を、もう片方の列の値ごとに示す別の方法として、<strong>naniar</strong> パッケージの作成する「付随する列」を用いるものがあります。<code>bind_shadow()</code> を用いると、全ての列に対して <code>NA</code> または not <code>NA</code> の 2 値変数を作成し、“_NA” を末尾に付けた新しい列として元のデータセットに結合してくれます。すなわち、データセットの列は 2 倍になります。</p>
<div class="sourceCode" id="cb1041"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">shadowed_linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">bind_shadow</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">shadowed_linelist</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] "case_id"                 "generation"             
##  [3] "date_infection"          "date_onset"             
##  [5] "date_hospitalisation"    "date_outcome"           
##  [7] "outcome"                 "gender"                 
##  [9] "age"                     "age_unit"               
## [11] "age_years"               "age_cat"                
## [13] "age_cat5"                "hospital"               
## [15] "lon"                     "lat"                    
## [17] "infector"                "source"                 
## [19] "wt_kg"                   "ht_cm"                  
## [21] "ct_blood"                "fever"                  
## [23] "chills"                  "cough"                  
## [25] "aches"                   "vomit"                  
## [27] "temp"                    "time_admission"         
## [29] "bmi"                     "days_onset_hosp"        
## [31] "case_id_NA"              "generation_NA"          
## [33] "date_infection_NA"       "date_onset_NA"          
## [35] "date_hospitalisation_NA" "date_outcome_NA"        
## [37] "outcome_NA"              "gender_NA"              
## [39] "age_NA"                  "age_unit_NA"            
## [41] "age_years_NA"            "age_cat_NA"             
## [43] "age_cat5_NA"             "hospital_NA"            
## [45] "lon_NA"                  "lat_NA"                 
## [47] "infector_NA"             "source_NA"              
## [49] "wt_kg_NA"                "ht_cm_NA"               
## [51] "ct_blood_NA"             "fever_NA"               
## [53] "chills_NA"               "cough_NA"               
## [55] "aches_NA"                "vomit_NA"               
## [57] "temp_NA"                 "time_admission_NA"      
## [59] "bmi_NA"                  "days_onset_hosp_NA"</code></pre>
<p>これらの「付随する列」は、他のどの列に対してでも、欠損している値の割合をプロットするのに使えます。</p>
<p>例えば、以下のプロットでは、<code>date_hospitalisation</code> 列の値ごとに、<code>days_onset_hosp</code> 列（発症してから入院までの日数）における欠損の割合を示しています。x 軸の列の密度をプロットしており、興味のある付随する列によって層別化（<code>color =</code>）していることに注意してください。x 軸が数値もしくは日付の列である場合、このプロットはうまく実行されます。</p>
<div class="sourceCode" id="cb1043"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">shadowed_linelist</span>,          <span class="co"># 付随する列を含むデータフレーム</span></span>
<span>  mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_hospitalisation</span>, <span class="co"># 数値もしくは日付の列</span></span>
<span>                colour <span class="op">=</span> <span class="va">age_years_NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># 興味のある付随する列</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span><span class="op">)</span>                          <span class="co"># 密度曲線をプロットする</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-785-1.png" width="672"></div>
<p>以下に示すように、統計量のサマリを層別化して示すのにも「付随する列」を使用することが出来ます。</p>
<div class="sourceCode" id="cb1044"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">bind_shadow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                <span class="co"># 「付随する列」を作成する</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">date_outcome_NA</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>    <span class="co"># 層別化に用いる「付随する列」を指定する</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span></span>
<span>    .cols <span class="op">=</span> <span class="va">age_years</span>,             <span class="co"># 統計量を示したい変数を指定する</span></span>
<span>    .fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"mean"</span> <span class="op">=</span> <span class="va">mean</span>,     <span class="co"># 興味のある統計量を指定する</span></span>
<span>                <span class="st">"sd"</span> <span class="op">=</span> <span class="va">sd</span>,</span>
<span>                <span class="st">"var"</span> <span class="op">=</span> <span class="va">var</span>,</span>
<span>                <span class="st">"min"</span> <span class="op">=</span> <span class="va">min</span>,</span>
<span>                <span class="st">"max"</span> <span class="op">=</span> <span class="va">max</span><span class="op">)</span>,  </span>
<span>    na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>                 <span class="co"># 統計量の計算に用いるその他のコマンド</span></span></code></pre></div>
<pre><code>## # A tibble: 2 × 6
##   date_outcome_NA age_years_mean age_years_sd age_years_var age_years_…¹ age_y…²
##   &lt;fct&gt;                    &lt;dbl&gt;        &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;   &lt;dbl&gt;
## 1 !NA                       16.0         12.6          158.            0      84
## 2 NA                        16.2         12.9          167.            0      69
## # … with abbreviated variable names ¹​age_years_min, ²​age_years_max</code></pre>
<p>以下に、列の欠損値の割合を時系列ごとに示す他の方法を示します。<strong>naniar</strong> パッケージは<u>使用しません</u>。週ごとの観測値の欠損の割合を示しています。</p>
<ol style="list-style-type: decimal">
<li>データを、興味のある単位時間（日、週、など）でまとめ、<code>NA</code>（そしてその他興味のある値）を含む観測値の割合を計算します</li>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> を用いて、欠損の割合を折れ線グラフとしてプロットします</li>
</ol>
<p>以下では、ラインリストを用いて、まず週ごとの値を新しい列として加え、値が欠損している週ごとの記録の割合を計算しています（7 日間での割合を計算したい場合は、以下のスクリプトとは少し異なります）。</p>
<div class="sourceCode" id="cb1046"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outcome_missing</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>week <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">date_onset</span>, <span class="st">"week"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>   <span class="co"># 新しく week の列を作成する</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                                             <span class="co"># 行を、week ごとにグルーピングする</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>                                                     <span class="co"># それぞれの値を week ごとにまとめる</span></span>
<span>    n_obs <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,                                                  <span class="co"># 観測数</span></span>
<span>    </span>
<span>    outcome_missing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span> <span class="op">|</span> <span class="va">outcome</span> <span class="op">==</span> <span class="st">""</span><span class="op">)</span>,        <span class="co"># 欠損を含む観測数</span></span>
<span>    outcome_p_miss  <span class="op">=</span> <span class="va">outcome_missing</span> <span class="op">/</span> <span class="va">n_obs</span>,                    <span class="co"># 欠損を含む観測の割合</span></span>
<span>  </span>
<span>    outcome_dead    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">==</span> <span class="st">"Death"</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,           <span class="co"># 死亡例の観測数</span></span>
<span>    outcome_p_dead  <span class="op">=</span> <span class="va">outcome_dead</span> <span class="op">/</span> <span class="va">n_obs</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                   <span class="co"># 死亡例の観測の割合</span></span>
<span>  </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">week</span>, names_to <span class="op">=</span> <span class="st">"statistic"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>         <span class="co"># ggplot のために week を除くすべての列をロング形式にピボットする</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">statistic</span>, <span class="st">"_p_"</span><span class="op">)</span><span class="op">)</span>                  <span class="co"># 割合を示す値だけを残す</span></span></code></pre></div>
<p>このデータを用いて、週ごとに欠損の割合を折れ線で示します。<strong>ggplot2</strong> パッケージについてあまり詳しくない場合は、<a href="ggplot-basics.html#ggplot-basics">ggplotの基礎</a> の章を参考にしてください。</p>
<div class="sourceCode" id="cb1047"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">outcome_missing</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span></span>
<span>      mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">value</span>, group <span class="op">=</span> <span class="va">statistic</span>, color <span class="op">=</span> <span class="va">statistic</span><span class="op">)</span>,</span>
<span>      size <span class="op">=</span> <span class="fl">2</span>,</span>
<span>      stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Weekly outcomes"</span>,</span>
<span>         x <span class="op">=</span> <span class="st">"Week"</span>,</span>
<span>         y <span class="op">=</span> <span class="st">"Proportion of weekly records"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html">scale_color_discrete</a></span><span class="op">(</span></span>
<span>       name <span class="op">=</span> <span class="st">""</span>,</span>
<span>       labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Died"</span>, <span class="st">"Missing outcome"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-788-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
<div id="欠損値を含むデータを使う" class="section level2" number="20.5">
<h2>
<span class="header-section-number">20.5</span> 欠損値を含むデータを使う<a class="anchor" aria-label="anchor" href="#%E6%AC%A0%E6%90%8D%E5%80%A4%E3%82%92%E5%90%AB%E3%82%80%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E4%BD%BF%E3%81%86"><i class="fas fa-link"></i></a>
</h2>
<div id="欠損値を含む行を取り除く" class="section level3 unnumbered">
<h3>欠損値を含む行を取り除く<a class="anchor" aria-label="anchor" href="#%E6%AC%A0%E6%90%8D%E5%80%A4%E3%82%92%E5%90%AB%E3%82%80%E8%A1%8C%E3%82%92%E5%8F%96%E3%82%8A%E9%99%A4%E3%81%8F"><i class="fas fa-link"></i></a>
</h3>
<p>欠損値を含む行を除く簡単な方法は、<strong>dplyr</strong> パッケージの <code><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na()</a></code> を用いる方法です。</p>
<p>元の <code>linelist</code> には <code>nrow(linelist)</code> 行含まれています。欠損値を含む行を除いた後の行数は以下になります。</p>
<div class="sourceCode" id="cb1048"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>     <span class="co"># あらゆる欠損値を含む列を除く</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 1818</code></pre>
<p>また、ある特定の列内の欠損値を含む行を除くこともできます。</p>
<div class="sourceCode" id="cb1050"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># date_onset 行に欠損を含む列を除く</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 5632</code></pre>
<p>順番に行を表示することも出来ますし、 <a href="cleaning.html#clean_tidyselect">“tidyselect” helper functions</a> を使うこともできます。</p>
<div class="sourceCode" id="cb1052"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># "date" を含む行に欠損を含む列を除く </span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 3029</code></pre>
<!-- ======================================================= -->
</div>
<div id="ggplot-での-na-の扱い方" class="section level3 unnumbered">
<h3>
<code>ggplot()</code> での <code>NA</code> の扱い方<a class="anchor" aria-label="anchor" href="#ggplot-%E3%81%A7%E3%81%AE-na-%E3%81%AE%E6%89%B1%E3%81%84%E6%96%B9"><i class="fas fa-link"></i></a>
</h3>
<p>たいていの場合、プロットから除かれた値の数はキャプションとして報告するのが賢明です。以下に例を示します。</p>
<p><code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> においては、<code><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs()</a></code> を追加し、その中で <code>caption =</code> としてキャプションを追加することが出来ます。キャプションの中で <strong>stringr</strong> パッケージの <code><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue()</a></code> を使うことで、文中に直接値を張り付けることが出来るので、データそれぞれの値を用いることが出来ます。</p>
<ul>
<li>
<code>\n</code> は、行替えに用いることが出来ます。</li>
<li>もし、複数の列がプロットに表示されない値を含む場合（例えば、年齢あるいは性別がプロットに反映されている場合）、表示されていない数を正確に計算するためにはそれらの列で絞り込みを行う必要があります。</li>
</ul>
<div class="sourceCode" id="cb1054"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>  title <span class="op">=</span> <span class="st">""</span>,</span>
<span>  y <span class="op">=</span> <span class="st">""</span>,</span>
<span>  x <span class="op">=</span> <span class="st">""</span>,</span>
<span>  caption  <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span></span>
<span>  <span class="st">"n = {nrow(central_data)} from Central Hospital;</span></span>
<span><span class="st">  {nrow(central_data %&gt;% filter(is.na(date_onset)))} cases missing date of onset and not shown."</span><span class="op">)</span><span class="op">)</span>  </span></code></pre></div>
<p><code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> コマンドを使用する前に、文字をオブジェクトとして保存し、<code><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue()</a></code> 内ではそのオブジェクト名を指定するだけの方が簡単な場合もあります。</p>
<!-- ======================================================= -->
</div>
<div id="因子型におけるna" class="section level3 unnumbered">
<h3>因子型における<code>NA</code><a class="anchor" aria-label="anchor" href="#%E5%9B%A0%E5%AD%90%E5%9E%8B%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8Bna"><i class="fas fa-link"></i></a>
</h3>
<p>興味のある列が因子型である場合、<code>NA</code> を文字値にするには <strong>forcats</strong> パッケージの <code><a href="https://forcats.tidyverse.org/reference/fct_explicit_na.html">fct_explicit_na()</a></code> を用いる必要があります。詳細については<a href="factors.html#factors">因子（ファクタ）型データ</a> (#factors)の章を参考にしてください。デフォルトでは、新しい値は “(Missing)” として扱われますが、<code>na_level =</code> のコマンドによって変更することが出来ます。</p>
<div class="sourceCode" id="cb1055"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">forcats</span><span class="op">)</span>   <span class="co"># パッケージの読み込み</span></span>
<span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>gender <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_explicit_na.html">fct_explicit_na</a></span><span class="op">(</span><span class="va">gender</span>, na_level <span class="op">=</span> <span class="st">"Missing"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">gender</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "f"       "m"       "Missing"</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="欠損値の補完" class="section level2" number="20.6">
<h2>
<span class="header-section-number">20.6</span> 欠損値の補完<a class="anchor" aria-label="anchor" href="#%E6%AC%A0%E6%90%8D%E5%80%A4%E3%81%AE%E8%A3%9C%E5%AE%8C"><i class="fas fa-link"></i></a>
</h2>
<p>単純に全ての欠損値を除いたデータセットを解析するのではなく、「ギャップを埋めて」、欠損値を補完してからデータを解析する方が良い場合もあります。単純にすべての欠損値を除くと、いろいろ問題があることがあります。例えば：</p>
<ol style="list-style-type: decimal">
<li><p>欠損値を含む観測値や大量の欠損値を含む変数を全て除くと、ある種の解析を行うパワーが減る可能性があります。例えば、先に示したように、linelist データにおいては、全ての変数のうち欠損値をまったく含まない観測は限られた割合しかありません。データセットの大部分を取り除いてしまうと、大量の情報を失ってしまうことになります！さらに、たいていの変数はそれなりの量の欠損値を含んでいます。そのため、ほとんどの分析において欠損値がたくさん含まれる変数を除去することはあまり適切ではありません。</p></li>
<li><p>欠損がなぜ生じているのかによっては、単に欠損を含まないデータのみで解析することは、解析結果にバイアスが生じたり、ミスリーディングな結果となることがあります。例えば、ある患者さんが熱や咳などの重要な症状の有無に関するデータを欠損しているとします。たとえば、明らかにそこまで重症でない患者さんについては熱や咳などの症状について記録をしていない可能性もあります。その場合は、単に欠損を含む観測値を除くと、データセット内の最も健康な人々を除くことになり、非常に結果にバイアスを生じることになります。</p></li>
</ol>
<p>どのくらい欠損しているか、ということに加えて、なぜ欠損が生じてるのかを考えることが重要です。そうすることで、欠損データを補完することがどのくらい重要なのか、そしてどの方法で補完することが一番良いのかについて判断を下しやすくなるでしょう。</p>
<div id="欠損データの種類" class="section level3 unnumbered">
<h3>欠損データの種類<a class="anchor" aria-label="anchor" href="#%E6%AC%A0%E6%90%8D%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E7%A8%AE%E9%A1%9E"><i class="fas fa-link"></i></a>
</h3>
<p>欠損データには一般的に、以下に挙げる 3 つの種類があります；</p>
<ol style="list-style-type: decimal">
<li><p><strong>Missing Completely at Random</strong> (MCAR) これは、データが欠損する確率と、他のデータ内との変数との間に関係性がないことを意味します。すべてのケースで、欠損する確率がおなじこととなります。これは珍しい状況です。しかし、もしデータが MCAR であると信じる確固とした理由があるのであれば、欠損していないデータだけを補間を行わずに分析することは、結果にバイアスを生じさせません（とはいえ、パワーはいくらか失われます）。[TODO: consider discussing statistical tests for MCAR]</p></li>
<li><p><strong>Missing at Random</strong> (MAR) この名前は少しミスリーディングで、というのも、MAR は、生じている欠損のパターンを他の変数の情報から規則的に予測できるタイプの欠損データのことだからです。例えば、全てのケースにおいて、熱のデータを欠損しているのは、実は寒気と痛みのある人は熱があると推測されたために熱を測らなかったためだとします。そうだとすると、寒気と痛みのあった観測値においては、発熱もまた生じていると容易に予測することが出来、欠損値を補完するためにこの情報を使用することが出来ます。実際には、これはもう少しスペクトラム的な話で、悪寒と痛みの両方を訴えており発熱のデータを欠損している患者は発熱もしている可能性が高いが、必ずしもそうというわけではない、ということです。しかし、完全に予測できるわけではなくとも、予測可能ではあります。欠損データの種類としては、最も多いタイプのものです。</p></li>
<li><p><strong>Missing not at Random</strong> (MNAR) <strong>Not Missing at Random</strong> (NMAR) と呼ばれることもあります。このタイプは、欠損データの割合が系統的でなく、他の情報を用いて予測可能でもなく、また、ランダムに欠損が生じているわけでもないタイプの欠損のデータのことです。すなわち、データは何らかの明らかになっていない原因により欠損しているか、あるいは情報を持っていない何らかの規則に基づいて欠損しているといえます。例えば、年齢のデータが欠損しているのは、非常に高齢の患者は自分の年齢を知らないか、自分の年齢を開示したくなかったからだとします。この場合、年齢の欠損は、年齢データ自身に関連しており（すなわちランダムに生じているわけではない）、従って他の情報に基づいて欠損を予測することはできません。MNAR は複雑で、対処法としては、欠損を補完しようとするよりも、もっとデータを集めること、そしてなぜ欠損が生じているのかについての情報を収集することが良いでしょう。</p></li>
</ol>
<p>まとめると、MCAR データを補完することは比較的容易ですが、一方、MNAR データを補完することは不可能ではないにしても非常にチャレンジングです。多くのデータの補完のメソッドは、MAR を仮定しています。</p>
</div>
<div id="便利なパッケージ" class="section level3 unnumbered">
<h3>便利なパッケージ<a class="anchor" aria-label="anchor" href="#%E4%BE%BF%E5%88%A9%E3%81%AA%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8"><i class="fas fa-link"></i></a>
</h3>
<p>Mmisc、missForest（ランダムフォレストによる欠損値の補完）、そして mice（連鎖方程式による多重代入法）などのパッケージは、欠損値の補完に便利です。このセクションでは、いろいろなテクニックを学ぶことの出来る mice パッケージについてのみ解説します。mice の開発者によるオンラインブックには、より詳細が示されています（<a href="https://stefvanbuuren.name/fimd/" class="uri">https://stefvanbuuren.name/fimd/</a>）。</p>
<p>mice パッケージを読み込みます；</p>
<div class="sourceCode" id="cb1057"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">mice</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="平均値代入法" class="section level3 unnumbered">
<h3>平均値代入法<a class="anchor" aria-label="anchor" href="#%E5%B9%B3%E5%9D%87%E5%80%A4%E4%BB%A3%E5%85%A5%E6%B3%95"><i class="fas fa-link"></i></a>
</h3>
<p>例えば、非常に単純な解析をしている、あるいは MCAR を仮定する強い理由がある時には、数値の欠損を単にその変数の平均値で代入することが出来る場合があります。例えば、我々のデータセット内の気温の欠損値は MCAR であるか単に平年値である、と仮定できる可能性があります。気温の欠損値をデータセットの値の平均値で補完した新しい変数を作成するコードを示します。しかし、多くの場合では単に平均値を補完するとバイアスを生じる可能性があるので、十分注意が必要です。</p>
<div class="sourceCode" id="cb1058"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>temp_replace_na_with_mean <span class="op">=</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span><span class="op">(</span><span class="va">temp</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">temp</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>同じような方法で、因子型の欠損値をある特定の値で補完することもできます。例えば、転帰について（“Death” または “Recover”）の情報が欠損している観測値はすべて死亡データであるとします（このデータセットについては、これは本当は正しくないのですが）。</p>
<div class="sourceCode" id="cb1059"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>outcome_replace_na_with_death <span class="op">=</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span><span class="op">(</span><span class="va">outcome</span>, <span class="st">"Death"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="回帰代入法" class="section level3 unnumbered">
<h3>回帰代入法<a class="anchor" aria-label="anchor" href="#%E5%9B%9E%E5%B8%B0%E4%BB%A3%E5%85%A5%E6%B3%95"><i class="fas fa-link"></i></a>
</h3>
<p>いくらかアドバンスな方法として、何らかの統計モデルを用いて欠損値がどんな値らしいのかを推測し、それで補完する方法があります。ここでは、体温についての情報は欠損しているけれど年齢と発熱についての情報は存在する観測値に対して、年齢（年）と発熱を予測因子とした簡単な線形回帰モデルを用いて値を予測する方法を示しています。実際には、このような単純なモデルではなく、より正確なモデルを使用した方が良いでしょう。</p>
<div class="sourceCode" id="cb1060"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simple_temperature_model_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">temp</span> <span class="op">~</span> <span class="va">fever</span> <span class="op">+</span> <span class="va">age_years</span>, data <span class="op">=</span> <span class="va">linelist</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#単純な体温モデルを用いて、体温の欠損値を予測する</span></span>
<span><span class="va">predictions_for_missing_temps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">simple_temperature_model_fit</span>,</span>
<span>                                        newdata <span class="op">=</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<p>もしくは、体温の欠損値に対して同様にモデルを作成する方法として mice パッケージを用いる方法もあります。</p>
<div class="sourceCode" id="cb1061"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_dataset</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">fever</span>, <span class="va">age_years</span><span class="op">)</span>  </span>
<span></span>
<span><span class="va">temp_imputed</span> <span class="op">&lt;-</span> <span class="fu">mice</span><span class="op">(</span><span class="va">model_dataset</span>,</span>
<span>                            method <span class="op">=</span> <span class="st">"norm.predict"</span>,</span>
<span>                            seed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                            m <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                            print <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: Number of logged events: 1</code></pre>
<div class="sourceCode" id="cb1063"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temp_imputed_values</span> <span class="op">&lt;-</span> <span class="va">temp_imputed</span><span class="op">$</span><span class="va">imp</span><span class="op">$</span><span class="va">temp</span></span></code></pre></div>
<p>これは、欠損値を予測値で補完する、という意味で missForest パッケージなどのよりアドバンスな方法と同じタイプの方法だと言えます。missForest の場合は、線形回帰ではなくランダムフォレストを用いて予測モデルを作成します。他のタイプのモデルを使用することもできます。この方法は、MCARの場合はうまくいきますが、MAR あるいは MNAR の方がデータをうまく説明する、と思っている場合には注意が必要です。補完の質は、予測モデルがどのくらい正確か、ということにも拠りますが、正確なモデルであっても補完されたデータのばらつきが少し過小となる場合もあります。</p>
</div>
<div id="locf-と-bocf" class="section level3 unnumbered">
<h3>LOCF と BOCF<a class="anchor" aria-label="anchor" href="#locf-%E3%81%A8-bocf"><i class="fas fa-link"></i></a>
</h3>
<p>Last observation carried forward (LOCF) と baseline observation carried forward (BOCF) は、時系列および縦断データの補完方法です。考え方としては、欠損の生じている観測値よりも前に観測されたデータで欠損値を補完しようというものです。連続で値が欠損している場合は、最後に観測された値で補完します。</p>
<p>LOCF および BOCF のどちらも <strong>tidyr</strong> パッケージの <code><a href="https://tidyr.tidyverse.org/reference/fill.html">fill()</a></code> を用いて実装することが出来ます（<strong>HMISC</strong>、<strong>zoo</strong>、そして <strong>data.table</strong> などのパッケージを用いても行うことが出来ます）。<code><a href="https://tidyr.tidyverse.org/reference/fill.html">fill()</a></code> をどのように使うのか示すために、2000 年と 2001 年において四半期ごとの罹患数を含む単純な時系列データを作成します。しかし、Q1 以降の半期に関するデータは欠損しているので、補完する必要があります。<a href="pivoting.html#pivoting">データの縦横変換</a> の章においても、<code><a href="https://tidyr.tidyverse.org/reference/fill.html">fill()</a></code> の使用方法が示されています。</p>
<div class="sourceCode" id="cb1064"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#単純なデータセットを作成する</span></span>
<span><span class="va">disease</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">quarter</span>, <span class="op">~</span><span class="va">year</span>, <span class="op">~</span><span class="va">cases</span>,</span>
<span>  <span class="st">"Q1"</span>,    <span class="fl">2000</span>,    <span class="fl">66013</span>,</span>
<span>  <span class="st">"Q2"</span>,      <span class="cn">NA</span>,    <span class="fl">69182</span>,</span>
<span>  <span class="st">"Q3"</span>,      <span class="cn">NA</span>,    <span class="fl">53175</span>,</span>
<span>  <span class="st">"Q4"</span>,      <span class="cn">NA</span>,    <span class="fl">21001</span>,</span>
<span>  <span class="st">"Q1"</span>,    <span class="fl">2001</span>,    <span class="fl">46036</span>,</span>
<span>  <span class="st">"Q2"</span>,      <span class="cn">NA</span>,    <span class="fl">58842</span>,</span>
<span>  <span class="st">"Q3"</span>,      <span class="cn">NA</span>,    <span class="fl">44568</span>,</span>
<span>  <span class="st">"Q4"</span>,      <span class="cn">NA</span>,    <span class="fl">50197</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#year の欠損値を補完する</span></span>
<span><span class="va">disease</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/fill.html">fill</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 8 × 3
##   quarter  year cases
##   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;
## 1 Q1       2000 66013
## 2 Q2       2000 69182
## 3 Q3       2000 53175
## 4 Q4       2000 21001
## 5 Q1       2001 46036
## 6 Q2       2001 58842
## 7 Q3       2001 44568
## 8 Q4       2001 50197</code></pre>
<p><code><a href="https://tidyr.tidyverse.org/reference/fill.html">fill()</a></code> を使用する前に、データが正しくソートされているかどうかを確認してください。<code><a href="https://tidyr.tidyverse.org/reference/fill.html">fill()</a></code> はデフォルトで「下向きに」補完しますが、 <code>.direction</code> パラメタを用いることで違う方向に補完することもできます。例えば、似たようなデータですが、今度は年の終わり（Q4）のみ記録があり、他は欠損しているデータセットがあるとします。</p>
<div class="sourceCode" id="cb1066"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#先ほどと少しだけ違うデータセットを作成する</span></span>
<span><span class="va">disease</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">quarter</span>, <span class="op">~</span><span class="va">year</span>, <span class="op">~</span><span class="va">cases</span>,</span>
<span>  <span class="st">"Q1"</span>,      <span class="cn">NA</span>,    <span class="fl">66013</span>,</span>
<span>  <span class="st">"Q2"</span>,      <span class="cn">NA</span>,    <span class="fl">69182</span>,</span>
<span>  <span class="st">"Q3"</span>,      <span class="cn">NA</span>,    <span class="fl">53175</span>,</span>
<span>  <span class="st">"Q4"</span>,    <span class="fl">2000</span>,    <span class="fl">21001</span>,</span>
<span>  <span class="st">"Q1"</span>,      <span class="cn">NA</span>,    <span class="fl">46036</span>,</span>
<span>  <span class="st">"Q2"</span>,      <span class="cn">NA</span>,    <span class="fl">58842</span>,</span>
<span>  <span class="st">"Q3"</span>,      <span class="cn">NA</span>,    <span class="fl">44568</span>,</span>
<span>  <span class="st">"Q4"</span>,    <span class="fl">2001</span>,    <span class="fl">50197</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#year の欠損値を、今度は「上向き」に補完する</span></span>
<span><span class="va">disease</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/fill.html">fill</a></span><span class="op">(</span><span class="va">year</span>, .direction <span class="op">=</span> <span class="st">"up"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 8 × 3
##   quarter  year cases
##   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;
## 1 Q1       2000 66013
## 2 Q2       2000 69182
## 3 Q3       2000 53175
## 4 Q4       2000 21001
## 5 Q1       2001 46036
## 6 Q2       2001 58842
## 7 Q3       2001 44568
## 8 Q4       2001 50197</code></pre>
<p>この例では、LOCF およびに BOCF は明らかに正しい方法でしたが、より複雑な状況ではこの方法が適切かどうかを判断するのが難しい場合もあります。例えば、初日から何日間か、患者の検査値が欠損しているとします。ある場合は、これは検査値に変動がないことを示していますが、患者が回復しており、値が初日とはまったく異なる可能性もあります！なので、少し注意してこれらのメソッドを使う必要があります。</p>
</div>
<div id="多重代入法" class="section level3 unnumbered">
<h3>多重代入法<a class="anchor" aria-label="anchor" href="#%E5%A4%9A%E9%87%8D%E4%BB%A3%E5%85%A5%E6%B3%95"><i class="fas fa-link"></i></a>
</h3>
<p>先ほど紹介した mice パッケージの開発者によるオンラインブック（<a href="https://stefvanbuuren.name/fimd/" class="uri">https://stefvanbuuren.name/fimd/</a>）には多重代入法の説明と、なぜそれを使いたいのかが詳細に記されています。ここでは、方法の基本的な部分を説明します。</p>
<p>多重代入法では、尤もらしい値で欠損値を代入したデータセットを複数作成します（データによってはより多くもしくは少なくデータセットを作成したい場合もあると思いますが、mice パッケージのデフォルトでは、5 つのデータセットが作成されます）。違いとしては、代入される値は、ある単一の値ではなく、予測された分布に基づき特定される値（したがっていくらかのランダムさを含んでいます）である、という点です。それぞれのデータセットに対してある種の予測モデルを用いる（mice には様々なオプションがあり、例えば<u>予測平均マッチング</u>、<u>ロジスティック回帰</u>、<u>ランダムフォレスト</u>などがあります）点では同じですが、mice パッケージでは様々なモデルの詳細についてまで考慮することが出来ます。</p>
<p>代入されたデータセット群を作成したら、これらの新しいデータセットそれぞれに対して、もともと計画していた統計解析を行い、それらの結果を一つにプールします。この方法は、MCAR において、また MAR の多くの場合においてバイアスを減少するのに非常に有用で、より正確な標準誤差を得ることが出来ます。</p>
<p>以下では、多重代入法を用いて、ラインリストのデータセット（より単純にした model_dataset を用いります）で、年齢と発熱のデータから体温を予測する方法を示します。</p>
<div class="sourceCode" id="cb1068"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># model_datasetにおける欠損をすべて代入し、新たに 10 つのデータセットを作成する</span></span>
<span><span class="va">multiple_imputation</span> <span class="op">=</span> <span class="fu">mice</span><span class="op">(</span></span>
<span>  <span class="va">model_dataset</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  print <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> </span></code></pre></div>
<pre><code>## Warning: Number of logged events: 1</code></pre>
<div class="sourceCode" id="cb1070"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">multiple_imputation</span>, <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">temp</span> <span class="op">~</span> <span class="va">age_years</span> <span class="op">+</span> <span class="va">fever</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu">mice</span><span class="fu">::</span><span class="fu"><a href="https://amices.org/mice/reference/pool.html">pool</a></span><span class="op">(</span><span class="va">model_fit</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>##          term     estimate    std.error     statistic        df       p.value
## 1 (Intercept) 3.703143e+01 0.0270863456 1367.16240465  26.83673  1.583113e-66
## 2   age_years 3.867829e-05 0.0006090202    0.06350905 171.44363  9.494351e-01
## 3    feveryes 1.978044e+00 0.0193587115  102.17849544 176.51325 5.666771e-159</code></pre>
<p>ここでは、mice のデフォルトの予測モデルである予測平均マッチングで欠損を補完しました。そして、それぞれの代入されたデータセットを値の推定に用いり、線形回帰によりそれぞれのデータセットにおいて得られた推定値をプールします。ここでは触れませんでしたが、mice パッケージを用いる際にはより詳細な方法や多重代入法に関する様々な設定を考慮する必要があります。例えば、常に数値データであるとは限らず、その場合は他の代入方法を用いる必要があります（mice パッケージでは、他の様々なデータの種類や補完が出来ます）。欠損データが非常に問題となる場合は、より頑健な解析結果を得るためには、単にコンプリートケースによる解析を行うよりも、多重代入法を用いる方が良いと言えるでしょう。</p>
<!-- ======================================================= -->
</div>
</div>
<div id="参考資料-13" class="section level2" number="20.7">
<h2>
<span class="header-section-number">20.7</span> 参考資料<a class="anchor" aria-label="anchor" href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99-13"><i class="fas fa-link"></i></a>
</h2>
<p>Vignette on the <a href="https://cran.r-project.org/web/packages/naniar/vignettes/getting-started-w-naniar.html">naniar package</a></p>
<p>Gallery of <a href="https://cran.r-project.org/web/packages/naniar/vignettes/naniar-visualisation.html">missing value visualizations</a></p>
<p><a href="https://stefvanbuuren.name/fimd/">Online book</a> about multiple imputation in R by the maintainer of the <strong>mice</strong> package</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="regression.html"><span class="header-section-number">19</span> 単変量と多変量回帰</a></div>
<div class="next"><a href="standardization.html"><span class="header-section-number">21</span> 標準化率</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#missing-data"><span class="header-section-number">20</span> データの欠損</a></li>
<li>
<a class="nav-link" href="#%E6%BA%96%E5%82%99-11"><span class="header-section-number">20.1</span> 準備</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF-9">パッケージの読み込み</a></li>
<li><a class="nav-link" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88-9">データのインポート</a></li>
<li><a class="nav-link" href="#%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%E6%99%82%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E6%AC%A0%E6%90%8D%E3%81%AE%E5%A4%89%E6%8F%9B">インポート時における欠損の変換</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#r-%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E6%AC%A0%E6%90%8D%E5%80%A4"><span class="header-section-number">20.2</span> R における欠損値</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#na">NA</a></li>
<li><a class="nav-link" href="#%E3%81%84%E3%82%8D%E3%81%84%E3%82%8D%E3%81%AA-na">いろいろな NA</a></li>
<li><a class="nav-link" href="#null">NULL</a></li>
<li><a class="nav-link" href="#nan">NaN</a></li>
<li><a class="nav-link" href="#inf">Inf</a></li>
<li><a class="nav-link" href="#%E4%BE%8B">例</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E4%BE%BF%E5%88%A9%E3%81%AA%E9%96%A2%E6%95%B0"><span class="header-section-number">20.3</span> 便利な関数</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#is.na-%E3%81%A8-is.na">is.na() と !is.na()</a></li>
<li><a class="nav-link" href="#na.omit">na.omit()</a></li>
<li><a class="nav-link" href="#drop_na">drop_na()</a></li>
<li><a class="nav-link" href="#na.rm-true">na.rm = TRUE</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E5%86%85%E3%81%AE%E6%AC%A0%E6%90%8D%E3%82%92%E8%A9%95%E4%BE%A1%E3%81%99%E3%82%8B"><span class="header-section-number">20.4</span> データフレーム内の欠損を評価する</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E6%AC%A0%E6%90%8D%E3%81%AE%E6%95%B0%E3%82%92%E5%AE%9A%E9%87%8F%E5%8C%96%E3%81%99%E3%82%8B">欠損の数を定量化する</a></li>
<li><a class="nav-link" href="#%E6%AC%A0%E6%90%8D%E7%8A%B6%E6%B3%81%E3%82%92%E8%A6%96%E8%A6%9A%E5%8C%96%E3%81%99%E3%82%8B">欠損状況を視覚化する</a></li>
<li><a class="nav-link" href="#%E6%AC%A0%E6%90%8D%E7%8A%B6%E6%B3%81%E3%81%AE%E9%96%A2%E4%BF%82%E6%80%A7%E3%82%92%E6%8E%A2%E3%82%8A%E5%8F%AF%E8%A6%96%E5%8C%96%E3%81%99%E3%82%8B">欠損状況の関係性を探り、可視化する</a></li>
<li><a class="nav-link" href="#%E4%BB%98%E9%9A%8F%E3%81%99%E3%82%8B%E5%88%97">「付随する」列</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E6%AC%A0%E6%90%8D%E5%80%A4%E3%82%92%E5%90%AB%E3%82%80%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E4%BD%BF%E3%81%86"><span class="header-section-number">20.5</span> 欠損値を含むデータを使う</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E6%AC%A0%E6%90%8D%E5%80%A4%E3%82%92%E5%90%AB%E3%82%80%E8%A1%8C%E3%82%92%E5%8F%96%E3%82%8A%E9%99%A4%E3%81%8F">欠損値を含む行を取り除く</a></li>
<li><a class="nav-link" href="#ggplot-%E3%81%A7%E3%81%AE-na-%E3%81%AE%E6%89%B1%E3%81%84%E6%96%B9">ggplot() での NA の扱い方</a></li>
<li><a class="nav-link" href="#%E5%9B%A0%E5%AD%90%E5%9E%8B%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8Bna">因子型におけるNA</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#%E6%AC%A0%E6%90%8D%E5%80%A4%E3%81%AE%E8%A3%9C%E5%AE%8C"><span class="header-section-number">20.6</span> 欠損値の補完</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E6%AC%A0%E6%90%8D%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E7%A8%AE%E9%A1%9E">欠損データの種類</a></li>
<li><a class="nav-link" href="#%E4%BE%BF%E5%88%A9%E3%81%AA%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8">便利なパッケージ</a></li>
<li><a class="nav-link" href="#%E5%B9%B3%E5%9D%87%E5%80%A4%E4%BB%A3%E5%85%A5%E6%B3%95">平均値代入法</a></li>
<li><a class="nav-link" href="#%E5%9B%9E%E5%B8%B0%E4%BB%A3%E5%85%A5%E6%B3%95">回帰代入法</a></li>
<li><a class="nav-link" href="#locf-%E3%81%A8-bocf">LOCF と BOCF</a></li>
<li><a class="nav-link" href="#%E5%A4%9A%E9%87%8D%E4%BB%A3%E5%85%A5%E6%B3%95">多重代入法</a></li>
</ul>
</li>
<li><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99-13"><span class="header-section-number">20.7</span> 参考資料</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>疫学のための R ハンドブック</strong>" was written by the handbook team. It was last built on 2023-01-12.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
