<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>16 ループと反復処理・リストの操作 | 疫学のための R ハンドブック</title>
<meta name="author" content="the handbook team">
<meta name="description" content="疫学業務担当者は、国、地域、年齢などによって層別化されたグループを対象に、同じ分析を繰り返し行う必要があります。他にも、非常に多くの場面で反復処理が必要となります。この章では、このような反復処理をより速く、より正確に、そしてより短いコードで行う方法を解説します。 本章では、反復処理を行うための2つの方法、すなわち、for ループを使用する方法と purrr...">
<meta name="generator" content="bookdown 0.29 with bs4_book()">
<meta property="og:title" content="16 ループと反復処理・リストの操作 | 疫学のための R ハンドブック">
<meta property="og:type" content="book">
<meta property="og:description" content="疫学業務担当者は、国、地域、年齢などによって層別化されたグループを対象に、同じ分析を繰り返し行う必要があります。他にも、非常に多くの場面で反復処理が必要となります。この章では、このような反復処理をより速く、より正確に、そしてより短いコードで行う方法を解説します。 本章では、反復処理を行うための2つの方法、すなわち、for ループを使用する方法と purrr...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="16 ループと反復処理・リストの操作 | 疫学のための R ハンドブック">
<meta name="twitter:description" content="疫学業務担当者は、国、地域、年齢などによって層別化されたグループを対象に、同じ分析を繰り返し行う必要があります。他にも、非常に多くの場面で反復処理が必要となります。この章では、このような反復処理をより速く、より正確に、そしてより短いコードで行う方法を解説します。 本章では、反復処理を行うための2つの方法、すなわち、for ループを使用する方法と purrr...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.0/transition.js"></script><script src="libs/bs3compat-0.4.0/tabs.js"></script><script src="libs/bs3compat-0.4.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.25/datatables.js"></script><link href="libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/tabwid-1.1.0/tabwid.css" rel="stylesheet">
<link href="libs/tabwid-1.1.0/scrool.css" rel="stylesheet">
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.9/grViz.js"></script><script src="libs/d3-4.5.0/d3.min.js"></script><script src="libs/sankey-1/sankey.js"></script><script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script><script src="libs/plotly-binding-4.10.0/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-2.5.1/plotly-latest.min.js"></script><link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="libs/vis-9.1.0/vis-network.min.js"></script><script src="libs/visNetwork-binding-2.1.0/visNetwork.js"></script><link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="libs/plotly-basic-2.5.1/plotly-basic-2.5.1.min.js"></script><script src="libs/plotly-cartesian-2.5.1/plotly-cartesian-2.5.1.min.js"></script><script src="libs/proj4js-2.3.15/proj4.js"></script><link href="libs/highcharts-9.3.1/css/motion.css" rel="stylesheet">
<script src="libs/highcharts-9.3.1/highcharts.js"></script><script src="libs/highcharts-9.3.1/highcharts-3d.js"></script><script src="libs/highcharts-9.3.1/highcharts-more.js"></script><script src="libs/highcharts-9.3.1/modules/stock.js"></script><script src="libs/highcharts-9.3.1/modules/map.js"></script><script src="libs/highcharts-9.3.1/modules/data.js"></script><script src="libs/highcharts-9.3.1/modules/exporting.js"></script><script src="libs/highcharts-9.3.1/modules/offline-exporting.js"></script><script src="libs/highcharts-9.3.1/modules/drilldown.js"></script><script src="libs/highcharts-9.3.1/modules/item-series.js"></script><script src="libs/highcharts-9.3.1/modules/overlapping-datalabels.js"></script><script src="libs/highcharts-9.3.1/modules/annotations.js"></script><script src="libs/highcharts-9.3.1/modules/export-data.js"></script><script src="libs/highcharts-9.3.1/modules/funnel.js"></script><script src="libs/highcharts-9.3.1/modules/heatmap.js"></script><script src="libs/highcharts-9.3.1/modules/treemap.js"></script><script src="libs/highcharts-9.3.1/modules/sankey.js"></script><script src="libs/highcharts-9.3.1/modules/dependency-wheel.js"></script><script src="libs/highcharts-9.3.1/modules/organization.js"></script><script src="libs/highcharts-9.3.1/modules/solid-gauge.js"></script><script src="libs/highcharts-9.3.1/modules/streamgraph.js"></script><script src="libs/highcharts-9.3.1/modules/sunburst.js"></script><script src="libs/highcharts-9.3.1/modules/vector.js"></script><script src="libs/highcharts-9.3.1/modules/wordcloud.js"></script><script src="libs/highcharts-9.3.1/modules/xrange.js"></script><script src="libs/highcharts-9.3.1/modules/tilemap.js"></script><script src="libs/highcharts-9.3.1/modules/venn.js"></script><script src="libs/highcharts-9.3.1/modules/gantt.js"></script><script src="libs/highcharts-9.3.1/modules/timeline.js"></script><script src="libs/highcharts-9.3.1/modules/parallel-coordinates.js"></script><script src="libs/highcharts-9.3.1/modules/bullet.js"></script><script src="libs/highcharts-9.3.1/modules/coloraxis.js"></script><script src="libs/highcharts-9.3.1/modules/dumbbell.js"></script><script src="libs/highcharts-9.3.1/modules/lollipop.js"></script><script src="libs/highcharts-9.3.1/modules/series-label.js"></script><script src="libs/highcharts-9.3.1/plugins/motion.js"></script><script src="libs/highcharts-9.3.1/custom/reset.js"></script><script src="libs/highcharts-9.3.1/modules/boost.js"></script><script src="libs/highchart-binding-0.9.4/highchart.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QXDW878QLX');
    </script><script type="text/javascript">
        // window.addEventListener("load", function() {
        //     document.getElementById('toc').firstChild.innerHTML = "章目次"; 
        // });
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementsByClassName("d-flex align-items-start justify-content-between")[0].children[0].children[0].innerHTML = "疫学のための R</br>ハンドブック";
            document.getElementById('toc').firstChild.innerHTML = "章目次"; 
            document.getElementById('main-nav').children[1].firstChild.innerHTML = "総目次";
            document.getElementById('search').setAttribute("placeholder", "検索");
        });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style_bs4.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">疫学のための R ハンドブック</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"></a></li>
<li class="book-part">本書について</li>
<li><a class="" href="editorial-style.html"><span class="header-section-number">1</span> 編集前記・技術注記</a></li>
<li><a class="" href="data-used.html"><span class="header-section-number">2</span> ハンドブックとデータのダウンロード</a></li>
<li class="book-part">基本編</li>
<li><a class="" href="basics.html"><span class="header-section-number">3</span> R の基礎</a></li>
<li><a class="" href="transition-to-R.html"><span class="header-section-number">4</span> Excel・Stata・SASとの比較</a></li>
<li><a class="" href="packages-suggested.html"><span class="header-section-number">5</span> 推奨パッケージ</a></li>
<li><a class="" href="r-projects.html"><span class="header-section-number">6</span> R プロジェクト</a></li>
<li><a class="" href="importing.html"><span class="header-section-number">7</span> データのインポート・エクスポート</a></li>
<li class="book-part">データマネジメント</li>
<li><a class="" href="cleaning.html"><span class="header-section-number">8</span> データクリーニングと主要関数</a></li>
<li><a class="" href="dates.html"><span class="header-section-number">9</span> 日付型データ</a></li>
<li><a class="" href="characters-strings.html"><span class="header-section-number">10</span> 文字型・文字列型データ</a></li>
<li><a class="" href="factors.html"><span class="header-section-number">11</span> 因子（ファクタ）型データ</a></li>
<li><a class="" href="pivoting.html"><span class="header-section-number">12</span> データの縦横変換</a></li>
<li><a class="" href="grouping.html"><span class="header-section-number">13</span> データのグループ化</a></li>
<li><a class="" href="joining-matching.html"><span class="header-section-number">14</span> データの結合</a></li>
<li><a class="" href="deduplication.html"><span class="header-section-number">15</span> 重複データの排除</a></li>
<li><a class="active" href="iteration.html"><span class="header-section-number">16</span> ループと反復処理・リストの操作</a></li>
<li class="book-part">データ分析</li>
<li><a class="" href="tables-descriptive.html"><span class="header-section-number">17</span> 記述統計表の作り方</a></li>
<li><a class="" href="stat-tests.html"><span class="header-section-number">18</span> 基本的な統計的検定</a></li>
<li><a class="" href="regression.html"><span class="header-section-number">19</span> 単変量と多変量回帰</a></li>
<li><a class="" href="missing-data.html"><span class="header-section-number">20</span> データの欠損</a></li>
<li><a class="" href="standardization.html"><span class="header-section-number">21</span> 標準化率</a></li>
<li><a class="" href="moving-average.html"><span class="header-section-number">22</span> 移動平均</a></li>
<li><a class="" href="time-series.html"><span class="header-section-number">23</span> 時系列分析とアウトブレイクの検出</a></li>
<li><a class="" href="epidemic-models.html"><span class="header-section-number">24</span> エピデミックモデリング</a></li>
<li><a class="" href="contact-tracing.html"><span class="header-section-number">25</span> 接触者の追跡</a></li>
<li><a class="" href="survey-analysis.html"><span class="header-section-number">26</span> 標本調査データ分析</a></li>
<li><a class="" href="survival-analysis.html"><span class="header-section-number">27</span> 生存時間解析</a></li>
<li><a class="" href="gis.html"><span class="header-section-number">28</span> GIS の基本</a></li>
<li class="book-part">データの可視化</li>
<li><a class="" href="tables-presentation.html"><span class="header-section-number">29</span> 見やすい表の作り方</a></li>
<li><a class="" href="ggplot-basics.html"><span class="header-section-number">30</span> ggplot の基本</a></li>
<li><a class="" href="ggplot-tips.html"><span class="header-section-number">31</span> ggplotのヒント</a></li>
<li><a class="" href="epicurves.html"><span class="header-section-number">32</span> 流行曲線（エピカーブ）</a></li>
<li><a class="" href="age-pyramid.html"><span class="header-section-number">33</span> 人口ピラミッドとリッカート尺度</a></li>
<li><a class="" href="heatmaps.html"><span class="header-section-number">34</span> ヒートマップ</a></li>
<li><a class="" href="diagrams.html"><span class="header-section-number">35</span> フローチャート・サンキー図・タイムライン</a></li>
<li><a class="" href="combination-analysis.html"><span class="header-section-number">36</span> 複数回答データの分析</a></li>
<li><a class="" href="transmission-chains.html"><span class="header-section-number">37</span> 感染連鎖</a></li>
<li><a class="" href="phylogenetic-trees.html"><span class="header-section-number">38</span> 系統樹</a></li>
<li><a class="" href="interactive-plots.html"><span class="header-section-number">39</span> 動的な図の作成</a></li>
<li class="book-part">レポートとダッシュボード</li>
<li><a class="" href="rmarkdown.html"><span class="header-section-number">40</span> R Markdown で作るレポート</a></li>
<li><a class="" href="reportfactory.html"><span class="header-section-number">41</span> ルーチンで作成するレポートの整理</a></li>
<li><a class="" href="flexdashboard.html"><span class="header-section-number">42</span> R Markdownで作るダッシュボード</a></li>
<li><a class="" href="shiny-basics.html"><span class="header-section-number">43</span> Shiny で作るダッシュボード</a></li>
<li class="book-part">その他</li>
<li><a class="" href="writing-functions.html"><span class="header-section-number">44</span> 関数の作成</a></li>
<li><a class="" href="directories.html"><span class="header-section-number">45</span> ディレクトリの操作</a></li>
<li><a class="" href="collaboration.html"><span class="header-section-number">46</span> Git と Github を使ったバージョン管理と共同作業</a></li>
<li><a class="" href="errors.html"><span class="header-section-number">47</span> よくあるエラー</a></li>
<li><a class="" href="help.html"><span class="header-section-number">48</span> ヘルプ</a></li>
<li><a class="" href="network-drives.html"><span class="header-section-number">49</span> ネットワークドライブで R を使用する場合</a></li>
<li><a class="" href="data-table.html"><span class="header-section-number">50</span> data.table パッケージを使用したデータ処理</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="iteration" class="section level1" number="16">
<h1>
<span class="header-section-number">16</span> ループと反復処理・リストの操作<a class="anchor" aria-label="anchor" href="#iteration"><i class="fas fa-link"></i></a>
</h1>
<p>疫学業務担当者は、国、地域、年齢などによって層別化されたグループを対象に、同じ分析を繰り返し行う必要があります。他にも、非常に多くの場面で<u>反復処理</u>が必要となります。この章では、このような反復処理をより速く、より正確に、そしてより短いコードで行う方法を解説します。</p>
<p>本章では、反復処理を行うための2つの方法、すなわち、<u>for ループ</u>を使用する方法と <strong>purrr</strong> パッケージを使用する方法を紹介します。</p>
<ol style="list-style-type: decimal">
<li><p>一連の入力されたデータ（本章では、インプット（input）と呼ぶ）に対してコードを反復する <u>for ループ</u>は、他のプログラミング言語に比べて R ではあまり一般的ではありませんが、ここでは学習の一貫として参考までに紹介します。</p></li>
<li><p><strong>purrr</strong> パッケージは、反復処理を行うためのパッケージであり、<strong>tidyverse</strong> パッケージに含まれています。値、列、データセットなどのインプットに対して関数を「マッピング（mapping）」し、反復処理を行います。</p></li>
</ol>
<p>本章では主に、以下の項目に関し、いくつか例を用いて説明します。</p>
<ul>
<li>複数のファイルのインポート・エクスポート</li>
<li>複数の管轄区ごとの流行曲線（エピカーブ）の作成</li>
<li>データフレーム内の複数の列に対する t 検定の実行</li>
</ul>
<p>また、<a href="iteration.html#iter_purrr">16.3 purrr とリスト</a> では、<code>リスト（list）</code> の作成と処理の例をいくつか紹介します。</p>
<div id="準備-7" class="section level2" number="16.1">
<h2>
<span class="header-section-number">16.1</span> 準備<a class="anchor" aria-label="anchor" href="#%E6%BA%96%E5%82%99-7"><i class="fas fa-link"></i></a>
</h2>
<div id="パッケージを読み込む-1" class="section level3 unnumbered">
<h3>パッケージを読み込む<a class="anchor" aria-label="anchor" href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80-1"><i class="fas fa-link"></i></a>
</h3>
<p>以下のコードを実行すると、分析に必要なパッケージが読み込まれます。このハンドブックでは、パッケージを読み込むために、pacman パッケージの p_load() を主に使用しています。p_load() は、必要に応じてパッケージをインストールし、現在の R セッションで使用するためにパッケージを読み込む関数です。また、すでにインストールされたパッケージは、R の基本パッケージである base （以下、base R）の library() を使用して読み込むこともできます。R のパッケージに関する詳細は <a href="basics.html#basics">R の基礎</a> の章をご覧ください。</p>
<div class="sourceCode" id="cb752"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>     <span class="va">rio</span>,         <span class="co"># インポート・エクスポートのためのパッケージ</span></span>
<span>     <span class="va">here</span>,        <span class="co"># ファイルの場所の指定のためのパッケージ</span></span>
<span>     <span class="va">purrr</span>,       <span class="co"># 反復処理のためのパッケージ</span></span>
<span>     <span class="va">tidyverse</span>    <span class="co"># データ管理と視覚化のためのパッケージ</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div id="データをインポートする-1" class="section level3 unnumbered">
<h3>データをインポートする<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B-1"><i class="fas fa-link"></i></a>
</h3>
<p>エボラ出血熱の流行をシミュレートしたデータセットをインポートします。お手元の環境でこの章の内容を実行したい方は、 <a href="https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/case_linelists/linelist_cleaned.rds" class="download-button">クリック</a>して「前処理された」ラインリスト（linelist）データをダウンロードしてください&gt;（.rds 形式で取得できます）。データは <em>rio</em> パッケージの import() を利用してインポートしましょう（<em>rio</em> パッケージは、.xlsx、.csv、.rds など様々な種類のファイルを取り扱うことができます。詳細は、<a href="importing.html#importing">インポートとエクスポート</a> の章をご覧ください。）</p>
<div class="sourceCode" id="cb753"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ラインリストをインポートする</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"linelist_cleaned.rds"</span><span class="op">)</span></span></code></pre></div>
<p>ラインリストの始めの 50 行は、以下の通りです。</p>
<div id="htmlwidget-6794baf985a2b8454d10" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6794baf985a2b8454d10">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],[4,4,2,3,3,3,4,4,4,4,4,4,6,5,6,9,10,8,7,6,7,6,8,6,10,8,6,12,5,8,7,9,11,5,8,5,6,11,7,9,7,8,9,12,13,9,8,10,8,7],["2014-05-08",null,null,"2014-05-04","2014-05-18","2014-05-03","2014-05-22","2014-05-28",null,null,"2014-05-30","2014-05-28","2014-06-14","2014-06-07","2014-06-09",null,null,null,"2014-06-23","2014-06-18","2014-06-24",null,null,"2014-07-03",null,"2014-07-10","2014-06-14",null,"2014-06-18","2014-06-29","2014-07-02","2014-07-12","2014-07-12","2014-06-13","2014-07-15","2014-06-20",null,null,"2014-07-20",null,"2014-07-12","2014-07-19","2014-07-18","2014-07-18","2014-07-27",null,"2014-07-19","2014-07-26","2014-07-24",null],["2014-05-13","2014-05-13","2014-05-16","2014-05-18","2014-05-21","2014-05-22","2014-05-27","2014-06-02","2014-06-05","2014-06-05","2014-06-06","2014-06-13","2014-06-16","2014-06-17","2014-06-18","2014-06-19","2014-06-22","2014-06-23","2014-06-25","2014-06-26","2014-06-28","2014-07-02","2014-07-08","2014-07-09","2014-07-09","2014-07-10","2014-07-12","2014-07-12","2014-07-13","2014-07-13","2014-07-14","2014-07-15","2014-07-16","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-22","2014-07-22","2014-07-24","2014-07-24","2014-07-25","2014-07-25","2014-07-27","2014-07-29","2014-07-30",null,"2014-08-01","2014-08-02","2014-08-03"],["2014-05-15","2014-05-14","2014-05-18","2014-05-20","2014-05-22","2014-05-23","2014-05-29","2014-06-03","2014-06-06","2014-06-07","2014-06-08","2014-06-15","2014-06-17","2014-06-17","2014-06-20","2014-06-19","2014-06-23","2014-06-24","2014-06-27","2014-06-28","2014-06-29","2014-07-03","2014-07-09","2014-07-09","2014-07-11","2014-07-11","2014-07-13","2014-07-14","2014-07-14","2014-07-13","2014-07-14","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-20","2014-07-20","2014-07-22","2014-07-24","2014-07-26","2014-07-24","2014-07-27","2014-07-25","2014-07-27","2014-07-31","2014-08-01","2014-08-03","2014-08-02","2014-08-02","2014-08-04"],[null,"2014-05-18","2014-05-30",null,"2014-05-29","2014-05-24","2014-06-01","2014-06-07","2014-06-18","2014-06-09","2014-06-15",null,"2014-07-09",null,"2014-06-30","2014-07-11","2014-07-01","2014-06-25","2014-07-06","2014-07-02","2014-07-09","2014-07-07","2014-07-20",null,"2014-07-22","2014-07-16","2014-07-14","2014-07-20","2014-07-16","2014-07-19","2014-07-27","2014-07-19",null,"2014-07-26","2014-08-14","2014-08-01","2014-07-23","2014-08-28","2014-07-28","2014-07-19",null,"2014-08-03",null,null,null,"2014-08-06","2014-08-21","2014-09-13","2014-08-04",null],[null,"Recover","Recover",null,"Recover","Recover","Recover","Death","Recover","Death","Death","Death","Recover","Recover",null,"Recover",null,null,"Death","Death","Recover",null,null,null,"Death",null,"Death","Death",null,"Death","Recover","Death","Recover","Death","Recover",null,"Death","Recover","Recover","Death",null,null,"Death","Death","Death","Death","Recover",null,"Death","Death"],["m","f","m","f","m","f","f","f","m","f","m","m","m","f","f","m","f","f","f","f","m","m","f","m","f","m","m","f","m","f","f","f","m","m","f","m","f","f","f","m","f","m","f","m","m","f","m","f","m","m"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["0-4","0-4","50-69","15-19","0-4","15-19","15-19","0-4","50-69","20-29","10-14","30-49","15-19","5-9","5-9","10-14","30-49","15-19","10-14","10-14","15-19","50-69","10-14","20-29","5-9","0-4","30-49","5-9","50-69","10-14","10-14","20-29","20-29","30-49","0-4","10-14","0-4","15-19","20-29","30-49","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-29","20-29","10-14"],["0-4","0-4","55-59","15-19","0-4","15-19","15-19","0-4","60-64","25-29","10-14","40-44","15-19","5-9","5-9","10-14","35-39","15-19","10-14","10-14","15-19","50-54","10-14","25-29","5-9","0-4","30-34","5-9","65-69","10-14","10-14","20-24","20-24","45-49","0-4","10-14","0-4","15-19","20-24","35-39","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-24","25-29","10-14"],["Other","Missing","St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Port Hospital","Missing","Missing","Missing","Missing","Port Hospital","Military Hospital","Missing","Missing","Other","Port Hospital","Port Hospital","Port Hospital","Missing","Other","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)","Missing","Other","Missing","St. Mark's Maternity Hospital (SMMH)","Military Hospital","Port Hospital","Central Hospital","Military Hospital","Central Hospital","Missing","Military Hospital","Other","Missing","Missing","Port Hospital","Port Hospital","Port Hospital","Missing","Central Hospital","Military Hospital","Other","Other","Other","Missing","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","Missing"],[-13.2157351064963,-13.2152339775486,-13.212910703914,-13.2363711169728,-13.2228638912441,-13.222625321098,-13.2331547837254,-13.2320975453153,-13.2225511595637,-13.2572163655863,-13.2206286746001,-13.253989309478,-13.2385127873491,-13.209391925612,-13.2157278814899,-13.2243437095992,-13.2336087079551,-13.21422143145,-13.2339681355349,-13.2535640411465,-13.2250089377786,-13.2160657166043,-13.2680671272333,-13.2266742923612,-13.2160179088168,-13.2482584611565,-13.2156319199566,-13.2142410663192,-13.2614879104088,-13.2452992638476,-13.2630592726116,-13.2343341712241,-13.2199077448676,-13.2227293309912,-13.2343062806506,-13.218781651651,-13.2483677722899,-13.2097478342339,-13.2680867723786,-13.2587535457526,-13.262635786914,-13.2697246824573,-13.2209026809759,-13.2330734719715,-13.2680923666905,-13.2547212675054,-13.2573683214693,-13.2137356012883,-13.2175973322257,-13.2486407324245],[8.46897295100924,8.45171855856465,8.46481700596819,8.4754761613651,8.46082377490923,8.46183062600728,8.46272931462646,8.46144367534271,8.46191259217774,8.47292327643506,8.48401630165138,8.45837125340844,8.47761705512509,8.47570184950483,8.47779946878972,8.47145134147474,8.47804840685363,8.48528034195779,8.46957530395867,8.45957352078114,8.47404889511544,8.48802917129884,8.473437335922,8.48408263734462,8.46242233645879,8.47026822126572,8.46398447480533,8.4641347894342,8.45623094629607,8.48334624336805,8.47493999153642,8.47832062438022,8.4693933891765,8.48480589906514,8.47121232619015,8.48438437371817,8.48466158574339,8.47714159984428,8.46238127010609,8.45568597813113,8.4632880274758,8.47940722413856,8.46353857052336,8.46178968158864,8.47508713872833,8.45825808128071,8.4532568143863,8.4732571907655,8.47911586641933,8.48480340615605],["f547d6",null,null,"f90f5f","11f8ea","aec8ec","893f25","133ee7",null,null,"996f3a","133ee7","37a6f6","9f6884","4802b1",null,null,null,"a75c7f","8e104d","ab634e",null,null,"b799eb",null,"5d9e4d","a15e13",null,"ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277",null,null,"d6584f",null,"312ecf","52ea64","cfd79c","d145b7","174288",null,"53608c","3b096b","f5c142",null],["other",null,null,"other","other","other","other","other",null,null,"other","other","other","other","other",null,null,null,"other","other","other",null,null,"other",null,"other","other",null,"other","funeral","other","funeral","other","other","other","funeral",null,null,"other",null,"other","other","other","other","other",null,"funeral","other","other",null],[27,25,91,41,36,56,47,0,86,69,67,84,68,44,34,66,78,47,53,47,71,86,53,69,38,46,68,37,100,56,50,57,65,72,29,69,37,48,54,71,47,61,47,35,53,16,13,59,69,67],[48,59,238,135,71,116,87,11,226,174,112,186,174,90,91,152,214,137,117,131,150,241,131,161,80,69,188,66,233,142,110,182,164,214,26,157,39,154,133,168,100,125,123,67,134,31,36,125,183,169],[22,22,21,23,23,21,21,22,22,22,22,22,22,21,23,22,23,21,22,23,21,23,21,24,23,22,24,23,20,24,24,20,24,21,22,21,23,22,23,23,23,22,23,22,22,22,23,22,22,22],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","no","no","no","no","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","yes","no",null,"no","no","no","yes","no",null,"no","no","yes",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","yes","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","yes","yes","yes","yes","yes","yes","yes","yes","yes",null,"yes","yes","yes","yes","yes",null,"yes","yes","yes",null,null,"yes","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","yes","yes","yes","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","yes","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"yes","yes",null,"no","no",null,"no","no","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","no","yes","no","no","no","yes","no","no","no",null,"no","yes","no","no","no",null,"no","no","no",null,null,"no","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","no","yes","yes","yes",null],[36.8,36.9,36.9,36.8,36.9,37.6,37.3,37,36.4,35.9,36.5,36.9,36.5,37.1,36.5,37.3,37,38,38,36,37,36.7,36.9,36.5,37,36.5,37.6,36.6,36.6,36.2,36.4,37.1,37.5,37.5,37.4,36.9,36.4,37.3,37,37.8,36.5,37.5,36.7,37,37.3,36.6,36.5,36.6,37.6,36.8],[null,"09:36","16:48","11:22","12:60","14:13","14:33","09:25","11:16","10:55","16:03","11:14","12:42","11:06","09:10","08:45",null,"15:41","13:34","18:58","12:43","16:33","14:29","07:18","08:11","16:32","16:17","07:32","17:45",null,"13:24","14:43","02:33","11:36","17:28","16:27",null,"20:49",null,"11:38","14:25","13:42","21:22","13:33","19:06","17:14","20:09",null,"10:23","09:09"],[117.1875,71.8184429761563,16.0652496292635,22.4965706447188,71.4144019043841,41.6171224732461,62.0953890870657,0,16.8376536925366,22.7903289734443,53.4119897959184,24.2802636142907,22.4600343506408,54.320987654321,41.0578432556455,28.5664819944598,17.0320552013276,25.0412914912888,38.7172182043977,27.3876813705495,31.5555555555556,14.8069075945662,30.8839811199813,26.6193433895297,59.375,96.6183574879227,19.2394748755093,84.9403122130395,18.4199377406104,27.7722674072605,41.3223140495868,17.2080666586161,24.1671624033314,15.7218971089178,428.994082840237,27.9930220292912,243.261012491782,20.2395007589813,30.527446435638,25.15589569161,47,39.04,31.0661643201798,77.9683671196257,29.5165961238583,166.493236212279,100.308641975309,37.76,20.6037803457852,23.458562375267],[2,1,2,2,1,1,2,1,1,2,2,2,1,0,2,0,1,1,2,2,1,1,1,0,2,1,1,2,1,0,0,2,1,1,2,2,1,0,2,2,0,2,0,0,2,2,null,1,0,1]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>generation<\/th>\n      <th>date_infection<\/th>\n      <th>date_onset<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>date_outcome<\/th>\n      <th>outcome<\/th>\n      <th>gender<\/th>\n      <th>age<\/th>\n      <th>age_unit<\/th>\n      <th>age_years<\/th>\n      <th>age_cat<\/th>\n      <th>age_cat5<\/th>\n      <th>hospital<\/th>\n      <th>lon<\/th>\n      <th>lat<\/th>\n      <th>infector<\/th>\n      <th>source<\/th>\n      <th>wt_kg<\/th>\n      <th>ht_cm<\/th>\n      <th>ct_blood<\/th>\n      <th>fever<\/th>\n      <th>chills<\/th>\n      <th>cough<\/th>\n      <th>aches<\/th>\n      <th>vomit<\/th>\n      <th>temp<\/th>\n      <th>time_admission<\/th>\n      <th>bmi<\/th>\n      <th>days_onset_hosp<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,8,10,14,15,18,19,20,26,28,29]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><!-- ======================================================= -->
</div>
</div>
<div id="for-ループ" class="section level2" number="16.2">
<h2>
<span class="header-section-number">16.2</span> <u>for ループ</u><a class="anchor" aria-label="anchor" href="#for-%E3%83%AB%E3%83%BC%E3%83%97"><i class="fas fa-link"></i></a>
</h2>
<div id="iter_loops" class="section level3 unnumbered">
<h3>R における <u>for ループ</u><a class="anchor" aria-label="anchor" href="#iter_loops"><i class="fas fa-link"></i></a>
</h3>
<p><u>for ループ</u>は R ではあまり一般的ではありませんが、他のプログラミング言語では頻繁に使用されています。初心者の方にとって、for ループは反復処理ごとに何が起こっているのかを正確に把握しやすく、コードの確認やデバッグがしやすいため、反復処理の学習や練習に役立ちます。</p>
<p><u>for ループ</u>を扱うこのセクションを飛ばして、<strong>purrr</strong> パッケージでマッピングした関数を使用し反復処理を行う方法を紹介する <a href="iteration.html#iter_purrr">16.3 purrr とリスト</a> に移動しても構いません。</p>
</div>
<div id="中心となる要素" class="section level3 unnumbered">
<h3>中心となる要素<a class="anchor" aria-label="anchor" href="#%E4%B8%AD%E5%BF%83%E3%81%A8%E3%81%AA%E3%82%8B%E8%A6%81%E7%B4%A0"><i class="fas fa-link"></i></a>
</h3>
<p><u>for ループ</u>は以下の 3 つの主要な部分から成り立っています。</p>
<ol style="list-style-type: decimal">
<li>繰り返し実行するアイテムの<strong>シーケンス</strong>
</li>
<li>シーケンス内の各アイテムに対して実行される<strong>オペレーション</strong>
</li>
<li>結果を格納する<strong>コンテナ</strong> （必須ではなく、必要な場合のみ作成する）</li>
</ol>
<p>以下に示しているように、基本的な構文は <code>for (アイテム in シーケンス) {アイテムを用いたオペレーションの指示}</code>です。括弧と波括弧の違いに注意してください。結果は、コンソールに出力したり、コンテナに格納したりすることができます。</p>
<p>簡単な <u>for ループ</u>の例を以下に示します。</p>
<div class="sourceCode" id="cb754"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">num</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>  <span class="co"># シーケンスの定義（1 から 5 の数）と "{" によるループの開始</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">num</span> <span class="op">+</span> <span class="fl">2</span><span class="op">)</span>             <span class="co"># オペレーション（それぞれのシーケンス内の数に 2 を足して表示してください）</span></span>
<span><span class="op">}</span>                            <span class="co"># "}" によるループの終了                            </span></span></code></pre></div>
<pre><code>## [1] 3
## [1] 4
## [1] 5
## [1] 6
## [1] 7</code></pre>
<div class="sourceCode" id="cb756"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>                             <span class="co"># この例では、結果をコンテナに格納していない</span></span></code></pre></div>
</div>
<div id="シーケンス" class="section level3 unnumbered">
<h3>シーケンス<a class="anchor" aria-label="anchor" href="#%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9"><i class="fas fa-link"></i></a>
</h3>
<p>これは、<u>for ループ</u>において “for” で示されている部分です。オペレーションはシーケンス内の各アイテムに対して（“for” each item）実行されます。シーケンスには、一連の値（管轄区名、疾患名、列名、リスト要素など）や、一連の連続した数値（1, 2, 3, 4, 5 など）を指定することができます。以下で説明するように、それぞれに実用性があります。</p>
<p>シーケンス文の基本構造は、<code>アイテム in ベクトル</code>です．</p>
<ul>
<li>「アイテム」の部分には任意の文字や単語を書くことができます（例：“i”, “num”, “hosp”, “district” など）。この「アイテム」の値は、ループを繰り返すたびにベクトル内の各値に、指定された順番で変化していきます。</li>
<li>
<u>ベクトル</u>には、文字列や列名、あるいは数字列などを用いることが出来ます。ループを繰り返すたびに変化していく値であり、これらの値は、「アイテム」を用いたオペレーションの指示により、「for ループ」 の中で使用されます。</li>
</ul>
<p><strong>例：文字列のシーケンス</strong></p>
<p>この例では、あらかじめ病院名の文字ベクトルを定義し、その各値に対してループを実行します。</p>
<div class="sourceCode" id="cb757"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 病院名のベクトルを作成する</span></span>
<span><span class="va">hospital_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">hospital</span><span class="op">)</span></span>
<span><span class="va">hospital_names</span> <span class="co"># 作成したベクトルを表示する</span></span></code></pre></div>
<pre><code>## [1] "Other"                               
## [2] "Missing"                             
## [3] "St. Mark's Maternity Hospital (SMMH)"
## [4] "Port Hospital"                       
## [5] "Military Hospital"                   
## [6] "Central Hospital"</code></pre>
<p>ここでは、<code>hospital_names</code> の値を、<code>hosp</code> という単語を使って示しています。一番最初に実行されるループでは、<code>hosp</code> の値は <code>hospital_names[[1]]</code> 、2 回目のループでは <code>hospital_names[[2]]</code> となります。</p>
<div class="sourceCode" id="cb759"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 文字列シーケンスに対する 'for ループ'</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">hosp</span> <span class="kw">in</span> <span class="va">hospital_names</span><span class="op">)</span><span class="op">{</span>       <span class="co"># シーケンス</span></span>
<span>  </span>
<span>       <span class="co"># オペレーションがここに来る</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<p><strong>例：列名のシーケンス</strong></p>
<p>これは、上記の文字列のシーケンスの変形で、既存の R オブジェクトの名前（例えば、データフレームの列名など）を抽出してベクトルとしたシーケンスです。便利なことに、<u>for ループ</u>のオペレーションコードでは、列名を用いて元のデータフレームを<u>指定する</u>（サブセットする）ことが出来ます。</p>
<p>下の例では、<code>linelist</code> データフレームの <code><a href="https://rdrr.io/r/base/names.html">names()</a></code>（列名）がシーケンスです。「アイテム」の名前は <code>col</code> で、ループが繰り返すに従い、その表す値が各列名に変化します。</p>
<p>例として、<u>for ループ</u>の中に、シーケンスの値ごとに実行されるオペレーションを加えます。この例では、シーケンスの値（列名）を使って、<code>linelist</code> の列名を一つずつ<u>指定して</u>（サブセットして）います。オペレーションコードでは、<a href="basics.html#basics">R の基礎</a> の章で説明したように、二重角括弧 <code>[[ ]]</code> を使用してサブセットします。そして、ループにより指定された列は <code><a href="https://rdrr.io/r/base/NA.html">is.na()</a></code>、次に <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code> に渡され、列内の欠損値の数を算出します。結果として、コンソールに欠損値の数が各列ごとに表示されます。</p>
<p>列名を用いてインデックスする場合の注意点：列自体を指定したいときには、 <u>単に “col” と書いてはいけません！</u> <code>col</code> は、単に列の名前を表しています。列内の値全体を指定するには、<code>linelist[[col]]</code> と書いて列名を <code>linelist</code> の<u>インデックス</u>として使用する必要があります。</p>
<div class="sourceCode" id="cb760"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">col</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>        <span class="co"># linelist内の各列に対するループ：列名は "col" で表されている</span></span>
<span>  </span>
<span>  <span class="co"># オペレーションコードの例：各列の欠損地の数を表示する </span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="co"># "col"の値は反復処理の繰り返しごとに変化し、linelist は "col" のその時々の値によってインデックスされる</span></span>
<span>     </span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code>## [1] 0
## [1] 0
## [1] 2087
## [1] 256
## [1] 0
## [1] 936
## [1] 1323
## [1] 278
## [1] 86
## [1] 0
## [1] 86
## [1] 86
## [1] 86
## [1] 0
## [1] 0
## [1] 0
## [1] 2088
## [1] 2088
## [1] 0
## [1] 0
## [1] 0
## [1] 249
## [1] 249
## [1] 249
## [1] 249
## [1] 249
## [1] 149
## [1] 765
## [1] 0
## [1] 256</code></pre>
<p><strong>例：数字のシーケンス</strong></p>
<p>次は、連続した数字の列をシーケンスとして用いる例を説明します。「アイテム」の値は文字値（“Central Hospital” や “date_onset” など）ではなく数字となり、データフレームをループする際に便利です。<u>for ループ</u>内で「アイテム」の番号を使うことで、データフレームを<u>行番号</u>でインデックスすることができます。</p>
<p>例えば、データフレーム内のすべての行をループして、ある情報を抽出したい場合、「アイテム」は行番号になります。この場合、「アイテム」は <code>i</code> と書かれることが多いです。</p>
<p><u>for ループ</u>の処理を言葉で説明すると、「1 からデータフレームの行の総数までの数からなるシーケンス内のすべてのアイテムに対して、X を行う」となります。一番最初に実行されるループでは、「アイテム」<code>i</code> の値は 1 です。2 回目のループでは、<code>i</code> は 2 になります。</p>
<p>このシーケンスをコードにすると、次のようになります：<code>for (i in 1:nrow(linelist)) {#オペレーションのコード}</code>。<code>i</code> は「アイテム」を表し、<code>1:nrow(linelist)</code> は、1 から <code>linelist</code> の総行数までの連続した数字からなるシーケンスを表しています。</p>
<div class="sourceCode" id="cb762"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>  <span class="co"># データフレームに対して使用</span></span>
<span>  <span class="co"># オペレーションのコードがここに来る</span></span>
<span><span class="op">}</span>  </span></code></pre></div>
<p>シーケンスを数字にしたいが、（データフレームではなく）ベクトルを用いる場合は、 <code><a href="https://rdrr.io/r/base/seq.html">seq_along()</a></code> を使うことで、ベクトルの各要素に対する添字のシーケンスを得ることが出来ます。例えば、<code>for (i in seq_along(hospital_names) {#オペレーションのコード}</code> とします。</p>
<p>以下のコードによって添字を得ることができ、その添字がループの <code>i</code> の値になります。</p>
<div class="sourceCode" id="cb763"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">hospital_names</span><span class="op">)</span>  <span class="co"># 名前のついているベクトルに対して使用</span></span></code></pre></div>
<pre><code>## [1] 1 2 3 4 5 6</code></pre>
<p>シーケンスに添字を使うと、ループの出力結果を格納する<u>コンテナ</u>のインデックスとして、<code>i</code> 番号を簡単に使用できるという利点があります。詳しくは、次のオペレーションのセクションで例を示して説明します。</p>
</div>
<div id="オペレーション" class="section level3 unnumbered">
<h3>オペレーション<a class="anchor" aria-label="anchor" href="#%E3%82%AA%E3%83%9A%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fas fa-link"></i></a>
</h3>
<p>オペレーションは、<u>for ループ</u>の中の波括弧 <code><a href="https://rdrr.io/r/base/Paren.html">{ }</a></code> の中に記述されているコードのことです。オペレーションコードは、<u>シーケンス</u>内の各「アイテム」ごとに実行される必要があります。したがって、「アイテム」によって変化するコードの各部分が、実際に変化するように正しくコードされているか注意する必要があります。例えば、インデックスには <code>[[ ]]</code> を使うことを忘れないでください。</p>
<p>以下の例では、<code>linelist</code> データフレームの各行に対して反復処理を実行します。各行の <code>gender</code> と <code>age</code> の値を結合し、文字ベクトルのコンテナである <code>cases_demographics</code> に格納する作業を行います。また、<code>[[i]]</code> を使ってインデックスすることで、ループの出力結果を「コンテナ」のベクトルの正しい位置に保存しているところもポイントです。</p>
<div class="sourceCode" id="cb765"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 結果を格納するコンテナを作成する：文字ベクトル</span></span>
<span><span class="va">cases_demographics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"character"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># for ループ</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># オペレーション</span></span>
<span>  <span class="co"># 角括弧をインデックスに用いることで、linelist の i 行の値を取り出す</span></span>
<span>  <span class="va">row_gender</span>  <span class="op">&lt;-</span> <span class="va">linelist</span><span class="op">$</span><span class="va">gender</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">row_age</span>     <span class="op">&lt;-</span> <span class="va">linelist</span><span class="op">$</span><span class="va">age_years</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>    <span class="co"># インデックスを忘れずに！</span></span>
<span>     </span>
<span>  <span class="co"># genderとageを結合し、コンテナのベクトル内のインデックスされた場所に格納する</span></span>
<span>  <span class="va">cases_demographics</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op">(</span><span class="va">row_gender</span>, <span class="va">row_age</span>, sep <span class="op">=</span> <span class="st">","</span><span class="op">)</span> </span>
<span></span>
<span><span class="op">}</span>  <span class="co"># ループの終了</span></span>
<span></span>
<span></span>
<span><span class="co"># 最初の 10 行を表示する</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">cases_demographics</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] "m,2"  "f,3"  "m,56" "f,18" "m,3"  "f,16" "f,16" "f,0"  "m,61" "f,27"</code></pre>
</div>
<div id="コンテナ" class="section level3 unnumbered">
<h3>コンテナ<a class="anchor" aria-label="anchor" href="#%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A"><i class="fas fa-link"></i></a>
</h3>
<p><u>for ループ</u>の結果はコンソールに表示したり、RStudio プロットペインに出力したりすることができます。また、後で使用するためにループの実行結果を「コンテナ」に保存しておきたい場合もあります。出力を保存するコンテナとして、ベクトル、データフレーム、あるいはリストなどを使用することが出来ます。</p>
<p>出力結果を保存するコンテナは、<u>for ループ</u>を開始する<u>前に</u>、データが何も入っていない空のベクトル、データフレーム、またはリストを作成するのが最も効率的です。空のコンテナは、ベクトルやリストの場合は <code><a href="https://rdrr.io/r/base/vector.html">vector()</a></code> で、データフレームの場合は <code><a href="https://rdrr.io/r/base/matrix.html">matrix()</a></code> や <code><a href="https://rdrr.io/r/base/data.frame.html">data.frame()</a></code> を使用して作成することができます。</p>
<p><strong>空のベクトルを作成する</strong></p>
<p><code><a href="https://rdrr.io/r/base/vector.html">vector()</a></code> を使用し、ループの出力結果を挿入するオブジェクトの想定されるデータ型を <code>mode =</code> で指定します（数値データを格納する “double”、“character”、または “logical”のいずれかを指定）。また、事前に <code>length =</code> を指定する必要があります。これは、<u>for ループ</u>のシーケンスの長さになります。</p>
<p>例えば、各病院の入院までの時間の中央値を格納したいとします。その場合、“double” を使用し、予想される出力数（ここではデータセット内の病院の数）を length として設定します。</p>
<div class="sourceCode" id="cb767"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span></span>
<span>  mode <span class="op">=</span> <span class="st">"double"</span>,                            <span class="co"># 数値データを格納する</span></span>
<span>  length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">hospital</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># データセット内の病院の数</span></span></code></pre></div>
<p><strong>空のデータフレームを作成する</strong></p>
<p>下のコードのように、行と列の数を指定することで、空のデータフレームを作ることができます。</p>
<div class="sourceCode" id="cb768"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>空のリストを作成する</strong></p>
<p><u>for ループ</u>で作成した図（プロット）をリストに格納したい場合は、空のリストを作成します。リストとベクトルは似ていますが、リストは複数の異なるデータ型の R オブジェクトを格納することが出来ます。リストの中のアイテムは、数値、データフレーム、ベクトル、を取ることができることのほか、別のリストを取ることもできます。</p>
<p>空のリストを作成する際には、ベクトルを作成した時と同じように <code><a href="https://rdrr.io/r/base/vector.html">vector()</a></code> を使用しますが、<code>mode = "list"</code> とする必要があります。長さは好きなように指定してください。</p>
<div class="sourceCode" id="cb769"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="コンテナを使用せず結果を表示する" class="section level3 unnumbered">
<h3>コンテナを使用せず結果を表示する<a class="anchor" aria-label="anchor" href="#%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%9B%E3%81%9A%E7%B5%90%E6%9E%9C%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p>なお、<u>for ループ</u>内で出力結果を表示する場合は、<code><a href="https://rdrr.io/r/base/print.html">print()</a></code> で指示する必要があります。</p>
<p>以下の例では、シーケンスは文字ベクトルであり、これを使用して病院ごとにラインリストをサブセットしています。結果はコンテナには保存されず、<code><a href="https://rdrr.io/r/base/print.html">print()</a></code> によってコンソールに出力されています。</p>
<div class="sourceCode" id="cb770"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">hosp</span> <span class="kw">in</span> <span class="va">hospital_names</span><span class="op">)</span><span class="op">{</span> </span>
<span>     <span class="va">hospital_cases</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="va">hosp</span><span class="op">)</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">hospital_cases</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code>## [1] 885
## [1] 1469
## [1] 422
## [1] 1762
## [1] 896
## [1] 454</code></pre>
</div>
<div id="for-ループの動作確認を行う" class="section level3 unnumbered">
<h3>for ループの動作確認を行う<a class="anchor" aria-label="anchor" href="#for-%E3%83%AB%E3%83%BC%E3%83%97%E3%81%AE%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D%E3%82%92%E8%A1%8C%E3%81%86"><i class="fas fa-link"></i></a>
</h3>
<p>意図したようにループが動作するか確認するために、<code>i &lt;- 10</code> や <code>hosp &lt;- "Central Hospital"</code> など、「アイテム」を一時的に代入するコマンドを実行します。これを<u>ループの外</u>で行い、その後、オペレーションコードのみ（波括弧内のコード）を実行し、期待通りの結果が得られるかを確認します。</p>
</div>
<div id="プロットをループする" class="section level3 unnumbered">
<h3>プロットをループする<a class="anchor" aria-label="anchor" href="#%E3%83%97%E3%83%AD%E3%83%83%E3%83%88%E3%82%92%E3%83%AB%E3%83%BC%E3%83%97%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p>前述した 3 つの要素（コンテナ、シーケンス、オペレーション）をすべて使用し、各病院の流行曲線（エピカーブ）を作成してみましょう（流行曲線についての詳細は、<a href="epicurves.html#epicurves">流行曲線（エピカーブ）</a> の章をご覧ください）。</p>
<p>まず、<strong>incidence2</strong> パッケージを使用し、<u>すべて</u>の症例を性別ごとに色分けした流行曲線を作成します。</p>
<div class="sourceCode" id="cb772"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 'incidence' のオブジェクトを作成する</span></span>
<span><span class="va">outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/incidence2/man/incidence.html">incidence</a></span><span class="op">(</span>   </span>
<span>     x <span class="op">=</span> <span class="va">linelist</span>,                   <span class="co"># データフレームを指定する（linelist全体）</span></span>
<span>     date_index <span class="op">=</span> <span class="va">date_onset</span>,        <span class="co"># 日付の列</span></span>
<span>     interval <span class="op">=</span> <span class="st">"week"</span>,              <span class="co"># 週ごとに集計</span></span>
<span>     groups <span class="op">=</span> <span class="va">gender</span>,                <span class="co"># 性別によるグルーピング</span></span>
<span>     na_as_group <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>             <span class="co"># 性別の欠損値は欠損のグループ（NA）として扱う</span></span>
<span></span>
<span><span class="co"># 流行曲線をプロットする</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">outbreak</span>,                       <span class="co"># incidence のオブジェクト名</span></span>
<span>     fill <span class="op">=</span> <span class="st">"gender"</span>,                <span class="co"># 性別ごとにバーの色を変更</span></span>
<span>     color <span class="op">=</span> <span class="st">"black"</span>,                <span class="co"># バーの外枠の色を指定</span></span>
<span>     title <span class="op">=</span> <span class="st">"Outbreak of ALL cases"</span> <span class="co"># タイトルを指定</span></span>
<span>     <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-598-1.png" width="672"></div>
<p>次に、各病院ごとに個別のプロットを作成するためには、この流行曲線のコードを <u>for ループ</u>の中に入れる必要があります。</p>
<p><u>for ループを作成する最初の</u>ステップとして、病院名の入ったベクトル <code>hospital_names</code> を保存します。作成する<u>for ループ</u>は、病院の名前ごとに、各病院一度だけ実行されます：<code>for (hosp in hospital_names)</code>。<code>hosp</code> の値は、<u>for ループ</u>が繰り返されるたびに、ベクトル内のそれぞれの病院名を表し、ループ内で使用されます。</p>
<p>ループ内では、通常通り R のコードを書くことができますが、「アイテム」（この場合は <code>hosp</code>）の値が変化することに注意してください。このループ内では、</p>
<ul>
<li>列 <code>hospital</code> が <code>hosp</code> の値と同じになるように、<code>linelist</code> に <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> を適用しています。</li>
<li>incidence オブジェクトは、フィルタリングされたラインリストに対して作成されています。</li>
<li>プロットには、各病院ごとに <code>hosp</code> を用いたタイトルが自動生成されます。</li>
<li>病院ごとに作成された各プロットは、一時的に保存され、そして表示されます。</li>
<li>ループは次の繰り返しを実行し、<code>hospital_names</code> 内の次の病院に対して同じオペレーションが繰り返されます。</li>
</ul>
<div class="sourceCode" id="cb773"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 病院名が格納されたベクトルを作成する</span></span>
<span><span class="va">hospital_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">hospital</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># hospital_names 内のそれぞれの病院名（"hosp"）ごとに、流行曲線を作成し表示する</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">hosp</span> <span class="kw">in</span> <span class="va">hospital_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>     </span>
<span>     <span class="co"># 反復処理ごとにその時々の病院に対して incidence オブジェクトを作成する</span></span>
<span>     <span class="va">outbreak_hosp</span> <span class="op">&lt;-</span> <span class="fu">incidence2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/incidence2/man/incidence.html">incidence</a></span><span class="op">(</span></span>
<span>          x <span class="op">=</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="va">hosp</span><span class="op">)</span>,   <span class="co"># 現在反復処理が行われている病院名によって linelist をフィルタリングする</span></span>
<span>          date_index <span class="op">=</span> <span class="va">date_onset</span>,</span>
<span>          interval <span class="op">=</span> <span class="st">"week"</span>, </span>
<span>          groups <span class="op">=</span> <span class="va">gender</span>,</span>
<span>          na_as_group <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>     <span class="op">)</span></span>
<span>     </span>
<span>     <span class="co"># プロットを作成し保存する</span></span>
<span>     <span class="co"># タイトルは現在反復処理が行われている病院名に合わせて自動生成される</span></span>
<span>     <span class="va">plot_hosp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>       <span class="va">outbreak_hosp</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"gender"</span>,</span>
<span>       color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>       title <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"Epidemic of cases admitted to {hosp}"</span><span class="op">)</span></span>
<span>     <span class="op">)</span></span>
<span>     </span>
<span>     <span class="co"># 現在反復処理が行われている病院のプロットを表示する</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">plot_hosp</span><span class="op">)</span></span>
<span>     </span>
<span><span class="op">}</span> <span class="co"># hospital_names 内の全ての病院名に対してオペレーションが行われた後、for ループを終了する </span></span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-599-1.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-599-2.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-599-3.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-599-4.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-599-5.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-599-6.png" width="50%"></p>
</div>
<div id="ループの進捗状況を確認する" class="section level3 unnumbered">
<h3>ループの進捗状況を確認する<a class="anchor" aria-label="anchor" href="#%E3%83%AB%E3%83%BC%E3%83%97%E3%81%AE%E9%80%B2%E6%8D%97%E7%8A%B6%E6%B3%81%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p>反復回数の多いループは、実行終了までに何分、何時間もかかることがあるため、進捗状況を R のコンソールに表示すると便利です。以下の <code>if</code> 文をループのオペレーションの<u>中に</u>配置することで、100 番目の数字ごとに結果を表示することができます。コード内で用いる際には、<code>i</code> が自分の作成したループ内の「アイテム」となるように適宜変更してください。</p>
<div class="sourceCode" id="cb774"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb774-1"><a href="iteration.html#cb774-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 進捗を 100 回の反復処理のたびに示すループ</span></span>
<span id="cb774-2"><a href="iteration.html#cb774-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(linelist))){</span>
<span id="cb774-3"><a href="iteration.html#cb774-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb774-4"><a href="iteration.html#cb774-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print progress</span></span>
<span id="cb774-5"><a href="iteration.html#cb774-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">%%</span> <span class="dv">100</span><span class="sc">==</span><span class="dv">0</span>){    <span class="co"># 演算子 %% は剰余を示す</span></span>
<span id="cb774-6"><a href="iteration.html#cb774-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(i)</span>
<span id="cb774-7"><a href="iteration.html#cb774-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb774-8"><a href="iteration.html#cb774-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<!-- ======================================================= -->
</div>
</div>
<div id="iter_purrr" class="section level2" number="16.3">
<h2>
<span class="header-section-number">16.3</span> <strong>purrr</strong> とリスト<a class="anchor" aria-label="anchor" href="#iter_purrr"><i class="fas fa-link"></i></a>
</h2>
<p>反復処理のもう一つの方法として、<strong>purrr</strong> パッケージを使用する方法があります。<strong>purrr</strong> パッケージは <strong>tidyverse</strong> パッケージに含まれている反復処理を行うパッケージです。</p>
<p>同じタスクを何度も実行する必要がある場合、汎用性の高い方法を習得していると非常に便利です。この方法は、複数の管轄区域のプロットを作成する際や、多くのファイルをインポートして結合する際などに多くの場面で用いることができます。</p>
<p><strong>purrr</strong> パッケージには他にもいくつか利点があり、パイプ <code>%&gt;%</code> と一緒に使用できること、通常の <u>for ループ</u>よりもエラー処理に優れていること、そして構文が非常にすっきりとしてシンプルであること、などが挙げられます。もし <u>for ループ</u>を使っているのであれば、<strong>purrr</strong> パッケージを使うことでより明確で簡潔にコードを書くことができるでしょう。</p>
<p>コードを書く際は、<strong>purrr</strong> パッケージが<u>関数型のプログラミングツール</u>であることを念頭に置いて進める必要があり、繰り返し適用されるオペレーションは、<u>関数</u>内に示す必要があります。関数を書く方法について詳細を知りたい方は、<a href="writing-functions.html#writing-functions">関数の作成</a> の章をご覧ください。</p>
<p>また、<strong>purrr</strong> パッケージに含まれる関数は、多くの場合<u>リスト</u>と<u>ベクトル</u>に対して働くので、リストやベクトルの各要素に関数を適用すると考えてください！</p>
<div id="パッケージを読み込む-2" class="section level3 unnumbered">
<h3>パッケージを読み込む<a class="anchor" aria-label="anchor" href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80-2"><i class="fas fa-link"></i></a>
</h3>
<p><strong>purrr</strong> パッケージは <strong>tidyverse</strong> パッケージの一部なので、別々にパッケージをインストールする・読み込む必要はありません。</p>
<div class="sourceCode" id="cb775"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>     <span class="va">rio</span>,            <span class="co"># インポート・エクスポート</span></span>
<span>     <span class="va">here</span>,           <span class="co"># ファイルパス</span></span>
<span>     <span class="va">tidyverse</span>,      <span class="co"># データの管理と視覚化</span></span>
<span>     <span class="va">writexl</span>,        <span class="co"># 複数のシートを含むExcelファイルを作成</span></span>
<span>     <span class="va">readxl</span>          <span class="co"># 複数のシートを含むExcelファイルをインポート</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div id="map" class="section level3 unnumbered">
<h3>
<code>map()</code><a class="anchor" aria-label="anchor" href="#map"><i class="fas fa-link"></i></a>
</h3>
<p><strong>purrr</strong> パッケージの中核となる関数の一つが <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> です。<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>は、与えられたリストやベクトルの各インプット要素に関数を「マッピング（mapping）」する（適用する）関数です。</p>
<p>基本的な構文は <code>map(.x = シーケンス, .f = 関数, その他の引数)</code> です。もう少し詳しく説明すると、</p>
<ul>
<li>
<code>.x =</code> は、<code>.f</code> 関数が繰り返し適用される<u>インプット</u>であり、例えば、管轄区名のベクトル、データフレームの列、またはデータフレームのリストです。</li>
<li>
<code>.f =</code> は、入力 <code>.x</code> の各要素に対して適用される<u>関数</u>です。これは、すでに存在する <code><a href="https://rdrr.io/r/base/print.html">print()</a></code> のような関数でも、自分で定義したカスタム関数でも構いません。関数は、チルダ（<code>~</code>）の後に書かれることが多いです（詳細は後述します）。</li>
</ul>
<p>構文を作成する際は、以下の点についてご注意ください。</p>
<ul>
<li>関数がそれ以上引数を指定する必要がない場合は、括弧やチルダを使わずに書くことができます（例：<code>.f = mean</code>）。全ての反復処理において同じ値になる引数がある場合、<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> の中、かつ <code>.f =</code> の外で指定します（例：<code>map(.x = my_list, .f = mean, na.rm = T)</code> の <code>na.rm = T</code>）。</li>
<li>
<code>.x</code>（または単に<code>.</code>）は、反復処理の <code>.x</code> 値の代用値として、<code>.f =</code> 関数<u>の中</u>で使用することができます。</li>
<li>関数をより細かく設定するには、チルダ構文（<code>~</code>）を使用してください。関数を、括弧を用いて通常通り書いてください（例: <code>map(.x = my_list, .f = ~mean(., na.rm = T))</code>）。特に、引数の値が反復処理ごとに変化する場合や、値が <code>.x</code> 自体である場合には、この構文を使用してください（以下の例を参照ください）。</li>
</ul>
<p><strong><code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> を用いた際の出力は<u>リスト</u>になります。</strong>リストはベクトルに似ていますが、構成要素が異なります。リストには、多くのデータフレーム、多くのベクトル、多くの単一の値、あるいは多くのリストが含まれる可能性があります。以下に説明するように、他のタイプの出力を生成する <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> の代替関数があります（例えば、データフレームを生成する <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code>、文字ベクトルを生成する <code><a href="https://purrr.tidyverse.org/reference/map.html">map_chr()</a></code>、数字ベクトルを生成する <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> など）。</p>
<div id="iter_combined" class="section level4 unnumbered">
<h4>例：エクセルシートをインポートし、結合する<a class="anchor" aria-label="anchor" href="#iter_combined"><i class="fas fa-link"></i></a>
</h4>
<p><strong>疫学業務担当者の一般的なタスクを用いて説明します。</strong>例えば、症例データの入った Excel ファイルをインポートしたいが、ファイルには異なる名前シートが複数含まれており、その複数のシートに分かれて症例データが保存されている場合です。どうすれば複数のシートを効率的にインポートして 1 つのデータフレームにまとめることができるでしょうか？</p>
<p>以下のような Excel ファイルが送られてきたとします。病院ごとにシートが分かれており、各シートにはそれぞれの病院の症例が含まれています。</p>
<div class="inline-figure"><img src="images/hospital_linelists_excel_sheets.png" width="615" style="display: block; margin: auto;"></div>
<p>ここでは、<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> を使った方法を紹介します。</p>
<ol style="list-style-type: decimal">
<li>
<code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> を、各エクセルシートごとに実行するように <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> する。</li>
<li>インポートされた複数のデータフレームを <code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows()</a></code> を使用して結合し、一つのデータフレームにまとめる。</li>
<li>一つにまとめる際、元の Excel シートの名前を新しい列に保存する。最終的なデータフレームで、各行の症例が、元々はどの Excel シートに保存されていたのか（どの病院で報告されたのか）をわかるようにする。</li>
</ol>
<p>まず、シート名を抽出してオブジェクトに格納する必要があります。<strong>readxl</strong> パッケージの <code>excel_sheets()</code> にエクセルファイルのパスを渡し、シート名を抽出します。抽出されたシート名は、<code>sheet_names</code> という文字ベクトルに格納されます。</p>
<div class="sourceCode" id="cb776"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sheet_names</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/excel_sheets.html">excel_sheets</a></span><span class="op">(</span><span class="st">"hospital_linelists.xlsx"</span><span class="op">)</span></span></code></pre></div>
<p>各シートの名前は、以下の通りです。</p>
<div class="sourceCode" id="cb777"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sheet_names</span></span></code></pre></div>
<pre><code>## [1] "Central Hospital"              "Military Hospital"            
## [3] "Missing"                       "Other"                        
## [5] "Port Hospital"                 "St. Mark's Maternity Hospital"</code></pre>
<p>これでシート名を格納したベクトルができたので、<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> を用いて <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> に 1 つずつ病院の名前を渡すことができます。この例では、<code>sheet_names</code> が <code>.x</code> であり、<code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> が <code>.f</code> となります。</p>
<p><a href="importing.html#importing">インポートとエクスポート</a> の章で説明したように、Excel ファイルで <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> を使用する場合、引数 <code>which =</code> を用いてインポートするシートを指定することができます。<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> の <code>.f</code> 関数に <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> を使用し、 <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> 内で <code>which = .x</code> と指定すると、反復処理を繰り返すたびに、ベクトル <code>sheet_names</code> の表す値が変化します。反復処理の最初の 1 回目では “Central Hospital” 、2 回目には “Military Hospital” となります。</p>
<p>注意点としては、<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> を使用しているので、各 Excel シートのデータは、別々のデータフレームとしてリスト内に保存されることです。各リスト要素（リスト内に保存される各データフレーム）に適切な<u>名前</u>を付けるために、<code>sheet_names</code> を <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> に渡す前に、<strong>purrr</strong> パッケージの <code><a href="https://rlang.r-lib.org/reference/set_names.html">set_names()</a></code> に渡しています。</p>
<p>反復処理で作成されるリストは <code>combined</code> という名前で保存されます。</p>
<div class="sourceCode" id="cb779"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined</span> <span class="op">&lt;-</span> <span class="va">sheet_names</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"hospital_linelists.xlsx"</span>, which <span class="op">=</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>反復処理後に出力されたリストを確認すると、各 Excel シートのデータが名前付きリストに保存されていることがわかります。ここまで順調ですが、まだ完成形ではありません。</p>
<div class="inline-figure"><img src="images/sheets_as_list.png" width="544" style="display: block; margin: auto;"></div>
<p>最後に、<strong>dplyr</strong> パッケージの <code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows()</a></code> を使用します。これは、互いに似たような構造をもつ複数のデータフレームが含まれたリストを受け取り、それらを 1 つのデータフレームに結合する関数です。リスト要素の<u>名前</u>（この例では、病院名）から新しい列を作成するために、引数 <code>.id =</code> を使用して新しい列に必要な名前を指定します。</p>
<p>以下が一連のコマンドの流れです。</p>
<div class="sourceCode" id="cb780"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sheet_names</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/excel_sheets.html">excel_sheets</a></span><span class="op">(</span><span class="st">"hospital_linelists.xlsx"</span><span class="op">)</span>  <span class="co"># シート名を抽出する</span></span>
<span> </span>
<span><span class="va">combined</span> <span class="op">&lt;-</span> <span class="va">sheet_names</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                                     <span class="co"># シート名から開始</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                                        <span class="co"># 名前を指定</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"hospital_linelists.xlsx"</span>, which <span class="op">=</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="co"># 反復処理を行い、インポートし、リストに保存する</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"origin_sheet"</span><span class="op">)</span> <span class="co"># データフレームのリストを結合し、新しい列に元データのシート名を保存する  </span></span></code></pre></div>
<p>これで元のシート名が保存された列を含むデータフレームができました！</p>
<div class="inline-figure"><img src="images/sheets_as_df.png" width="543" style="display: block; margin: auto;"></div>
<p><code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> には様々なバリエーションがあります。例えば、<code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code> はリストではなく、データフレームを返します。そのため、上記のタスクに使用する場合、<code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows()</a></code> を使用して行を結合する必要はありません。しかし、各症例がどのシート（病院）のものかは把握できません。</p>
<p><code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> には他にも、<code><a href="https://purrr.tidyverse.org/reference/map.html">map_chr()</a></code> や <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> があり、次の 2 つの理由から非常に便利な関数だと言えます。第一に、反復処理の出力を（リストではなく）ベクトルに自動的に変換してくれます。第二に、データがどのような形式で返ってくるかを指定することが出来ます。<code><a href="https://purrr.tidyverse.org/reference/map.html">map_chr()</a></code> では文字ベクトル、<code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> では数値ベクトルとしてデータが戻ってきます。詳細は、本章で後詳します！</p>
<p>また、 <code><a href="https://purrr.tidyverse.org/reference/map_if.html">map_at()</a></code> と <code><a href="https://purrr.tidyverse.org/reference/map_if.html">map_if()</a></code> も反復処理を行う際に非常に便利な関数です。<code><a href="https://purrr.tidyverse.org/reference/map_if.html">map_at()</a></code> を使用する場合はインデックス・名前のベクトルを、<code><a href="https://purrr.tidyverse.org/reference/map_if.html">map_if()</a></code> を使用する場合は論理条件（logical test）を適用するだけで、リストのどの要素を反復処理するかを指定することができます。</p>
<p>例えば、前述の各病院の症例データについて、1 枚目のシートをインポートしたくない場合を考えてみましょう。この場合、<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> の代わりに <code><a href="https://purrr.tidyverse.org/reference/map_if.html">map_at()</a></code> を使用し、<code>.at =</code> の引数に <code>c(-1)</code> を指定します。これは、インプット <code>.x</code> の最初の要素を使用<em>しない</em>ことを意味します。また、<code>.at =</code> に正の数のベクトルや名前を指定して、使用する要素を指定することもできます。</p>
<div class="sourceCode" id="cb781"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sheet_names</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/excel_sheets.html">excel_sheets</a></span><span class="op">(</span><span class="st">"hospital_linelists.xlsx"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined</span> <span class="op">&lt;-</span> <span class="va">sheet_names</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="co"># 1枚目のシートは除く</span></span>
<span>     <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_if.html">map_at</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span> <span class="st">"hospital_linelists.xlsx"</span>, which <span class="op">=</span> <span class="va">.x</span><span class="op">)</span>,</span>
<span>            .at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>1 枚目のシート名が出力リストの要素として表示されますが、これは単なる文字名（データフレームではない）になっています。行を結合する前には、この要素を削除する必要があります。リストの要素を削除したり変更したりする方法については、本章で後述します。</p>
</div>
</div>
<div id="データセットを分割しエクスポートする" class="section level3 unnumbered">
<h3>データセットを分割しエクスポートする<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88%E3%82%92%E5%88%86%E5%89%B2%E3%81%97%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p>以下では、一つのデータセットを複数のデータセットに分割し、分割されたデータセットを <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> の反復処理を使用してそれぞれ別々の Excel シートまたは CSV ファイルとしてエクスポートする方法を例示します。</p>
<div id="データを分割する" class="section level4 unnumbered">
<h4>データを分割する<a class="anchor" aria-label="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%88%86%E5%89%B2%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h4>
<p>例えば、複数の病院から報告された症例を含んだデータフレーム <code>linelist</code> があり、報告元の病院ごとに個別のラインリストを作成し、それぞれを個別の CSV ファイルとしてエクスポートしたい場合、次のような手順で行います。</p>
<p><strong>dplyr</strong> パッケージの <code><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split()</a></code> を使用して、データフレーム <code>linelist</code> を <code>hospital</code> 列内の値で分割します。これにより、病院別のデータフレームからなるリストが出力されます。</p>
<div class="sourceCode" id="cb782"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist_split</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split</a></span><span class="op">(</span><span class="va">hospital</span><span class="op">)</span></span></code></pre></div>
<p><code>View(linelist_split)</code> を実行すると、このリストは 6 つのデータフレーム（“tibbles”）からなり、それぞれのデータフレームが各病院で報告された症例を含んでいることがわかります。</p>
<div class="inline-figure"><img src="images/purrr_linelist_split.png" width="574" style="display: block; margin: auto;"></div>
<p>ただし、リスト内のデータフレームには、デフォルトでは名前が付いていないことに注意してください！次のステップでは、それぞれのデータフレームに名前を付け、CSV ファイルでエクスポートする際にはその名前を使うようにしていきます。</p>
<p>名前を抽出する方法として、<strong>dplyr</strong> パッケージの <code><a href="https://dplyr.tidyverse.org/reference/pull.html">pull()</a></code> を使用し、リストの各データフレームから <code>hospital</code> 列を抽出する方法があります。次に、エラーが起こらないように念のため、抽出された値を文字に変換し、<code><a href="https://rdrr.io/r/base/unique.html">unique()</a></code> を使用してデータフレームの名前（ここでは、病院名）を抽出します。そして、これらのすべてのステップを <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> によって各データフレームに適用します。</p>
<div class="sourceCode" id="cb783"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist_split</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">linelist_split</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>   <span class="co"># リスト化されたデータフレームの名前を指定する </span></span>
<span>     <span class="co"># それぞれのデータフレームに以下の関数を適用することで、名前を抽出する </span></span>
<span>     <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">.x</span>, <span class="va">hospital</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>        <span class="co"># hospital 列を取り出す</span></span>
<span>     <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>          <span class="co"># 取り出した値を、念のため、文字に変換する</span></span>
<span>     <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span>                    <span class="co"># 病院名を抽出する</span></span></code></pre></div>
<p>これで、リストの各要素に名前を付けることができました。付けられた名前は、 <code>names(linelist_split)</code> を実行すると確認できます。</p>
<div class="inline-figure"><img src="images/purrr_linelist_split_named.png" width="575" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb784"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist_split</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "Central Hospital"                    
## [2] "Military Hospital"                   
## [3] "Missing"                             
## [4] "Other"                               
## [5] "Port Hospital"                       
## [6] "St. Mark's Maternity Hospital (SMMH)"</code></pre>
<div id="つ以上の列を用いた-group_split" class="section level5 unnumbered">
<h5>2 つ以上の列を用いた <code>group_split()</code><a class="anchor" aria-label="anchor" href="#%E3%81%A4%E4%BB%A5%E4%B8%8A%E3%81%AE%E5%88%97%E3%82%92%E7%94%A8%E3%81%84%E3%81%9F-group_split"><i class="fas fa-link"></i></a>
</h5>
<p>例えば、病院と性別の組み合わせでラインリストを分割するなど、<u>複数の列（変数）によって</u>ラインリストを分割したい場合は、リストの要素に名前を付ける方法が異なります。この場合は、まず、<strong>dplyr</strong> パッケージの <code><a href="https://dplyr.tidyverse.org/reference/group_data.html">group_keys()</a></code> を使用し、病院と性別の組み合わせすべてに対して「グループキー」を作成します（グループキーは、データフレームとして作成されます）。そして、二列に渡って作成されたグループキーを、以下のように <code><a href="https://tidyr.tidyverse.org/reference/unite.html">unite()</a></code> を使用して一つの値に結合し、結合した組み合わせ名を <code>linelist_split</code> に割り当てます。</p>
<div class="sourceCode" id="cb786"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ラインリストを病院と性別のすべての組み合わせによって分割する</span></span>
<span><span class="va">linelist_split</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split</a></span><span class="op">(</span><span class="va">hospital</span>, <span class="va">gender</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># グループキーをデータフレームとして抽出する</span></span>
<span><span class="va">groupings</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">hospital</span>, <span class="va">gender</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>       </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_data.html">group_keys</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">groupings</span>      <span class="co"># グループキーを表示する </span></span></code></pre></div>
<pre><code>## # A tibble: 18 × 2
##    hospital                             gender
##    &lt;chr&gt;                                &lt;chr&gt; 
##  1 Central Hospital                     f     
##  2 Central Hospital                     m     
##  3 Central Hospital                     &lt;NA&gt;  
##  4 Military Hospital                    f     
##  5 Military Hospital                    m     
##  6 Military Hospital                    &lt;NA&gt;  
##  7 Missing                              f     
##  8 Missing                              m     
##  9 Missing                              &lt;NA&gt;  
## 10 Other                                f     
## 11 Other                                m     
## 12 Other                                &lt;NA&gt;  
## 13 Port Hospital                        f     
## 14 Port Hospital                        m     
## 15 Port Hospital                        &lt;NA&gt;  
## 16 St. Mark's Maternity Hospital (SMMH) f     
## 17 St. Mark's Maternity Hospital (SMMH) m     
## 18 St. Mark's Maternity Hospital (SMMH) &lt;NA&gt;</code></pre>
<p>以下のコードでは、それぞれの組み合わせをダッシュで結合し、それを <code>linelist_split</code> のリスト要素の名前に割り当てます。まず、<code>NA</code> を “Missing” に置き換え、次に、<strong>dplyr</strong> パッケージの <code><a href="https://tidyr.tidyverse.org/reference/unite.html">unite()</a></code> を使って列の値をダッシュで結合します。そして、無名のベクトルに変換し、<code>linelist_split</code> のリスト要素の名前として使えるようにします。</p>
<div class="sourceCode" id="cb788"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 一つの名前の値に結合する </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist_split</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">groupings</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">replace_na</span>, <span class="st">"Missing"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="co"># 全ての列において NA を "Missing" に置き換える</span></span>
<span>     <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unite.html">unite</a></span><span class="op">(</span><span class="st">"combined"</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                         <span class="co"># 全ての列の値を一つに結合する</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://purrr.tidyverse.org/reference/as_vector.html">as_vector</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="excel-シートとして出力する" class="section level4 unnumbered">
<h4>Excel シートとして出力する<a class="anchor" aria-label="anchor" href="#excel-%E3%82%B7%E3%83%BC%E3%83%88%E3%81%A8%E3%81%97%E3%81%A6%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h4>
<p><strong>writexl</strong> パッケージの <code>write_xlsx()</code> に各リスト要素に名前が付いた <code>linelist_split</code> を渡すことで、<u>シートごとに 1 つの病院の</u>ラインリストを含んだ Excel ファイルとして出力することができます。<code>write_xlsx()</code> は、複数のシートからなる Excel ファイルをエクスポートする機能があり、リスト要素の名前が各シートの名前として自動的に適用されます。</p>
<div class="sourceCode" id="cb789"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist_split</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu">writexl</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/writexl/reference/write_xlsx.html">write_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"hospital_linelists.xlsx"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Excel ファイルを開くと、症例がデータが病院ごとに複数のシートに分割されて保存されているのが確認できます。</p>
<div class="inline-figure"><img src="images/purrr_export_sheets.png" width="652" style="display: block; margin: auto;"></div>
</div>
<div id="csvファイルとして出力する" class="section level4 unnumbered">
<h4>CSVファイルとして出力する<a class="anchor" aria-label="anchor" href="#csv%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%A8%E3%81%97%E3%81%A6%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h4>
<p>少し複雑になりますが、それぞれの病院個別のラインリストを、CSV ファイルとして出力することもできます。ファイルの名前をそれぞれの病院の名前として出力します。</p>
<p>今回も <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> を使用します。前述したように、リスト要素の名前（病院名）が含まれたベクトルを <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> に渡し、<code>linelist_split</code> リスト内の要素（データフレーム）に <strong>rio</strong> パッケージの <code><a href="https://rdrr.io/pkg/rio/man/export.html">export()</a></code> を繰り返し適用します（<code><a href="https://rdrr.io/pkg/rio/man/export.html">export()</a></code> についての詳細は、<a href="importing.html#importing">インポートとエクスポート</a> の章をご覧ください）。また、リスト要素の名前は、エクスポートする各 CSV ファイルのファイル名として使用します。以下に、CSV ファイルとして出力する方法を示します。</p>
<ul>
<li><p>まず、病院の名前が含まれた文字値ベクターを <code>.x</code> として <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> に与えます</p></li>
<li><p><code>.f</code> 関数を <code><a href="https://rdrr.io/pkg/rio/man/export.html">export()</a></code> とし、エクスポートするデータフレームとエクスポート先となるファイルパスを指定します</p></li>
<li><p>入力された <code>.x</code>（病院名）は <code>.f</code> <u>の中において</u>、<code>linelist_split</code> リスト内のインデックスとなります。反復処理が繰り返すたびに一つのデータフレームが <code><a href="https://rdrr.io/pkg/rio/man/export.html">export()</a></code> に渡されます。</p></li>
<li><p>例えば、“Military Hospital” の症例データに対して <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> が適用されている時は、<code>linelist_split[[.x]]</code> は実際には <code>linelist_split[["Military Hospital"]]</code> となり、 <code>linelist_split</code> の 2 番目のリスト要素（“Military Hospital” の全章例を含むデータフレーム）が返されます。</p></li>
<li>
<p><code><a href="https://rdrr.io/pkg/rio/man/export.html">export()</a></code> で指定するファイルパスには、 <code><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue()</a></code> を使用して各病院名を適用します（<code><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue()</a></code> に関する詳細は、<a href="characters-strings.html#characters-strings">文字型・文字列型データ</a> の章を参照ください）。</p>
<ul>
<li>ファイルパスの起点、および “data” フォルダを特定するために <code><a href="https://here.r-lib.org//reference/here.html">here()</a></code> を用います（<code><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue()</a></code> 内で使用されている二重引用符に影響がないように、一重引用符を使用していることに注意してください）。</li>
</ul>
</li>
<li><p><code><a href="https://rdrr.io/pkg/rio/man/export.html">export()</a></code> で指定するファイルパス内には、<code><a href="https://here.r-lib.org//reference/here.html">here()</a></code> を使用した後に <code>/</code> と <code>.x</code> を記載し、各病院名がファイル名になるようにします</p></li>
<li><p>最後に、<code><a href="https://rdrr.io/pkg/rio/man/export.html">export()</a></code> によって CSV ファイルが作成されるように拡張子 “.csv” を記します</p></li>
</ul>
<div class="sourceCode" id="cb790"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist_split</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>     <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/export.html">export</a></span><span class="op">(</span><span class="va">linelist_split</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span>, file <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"{here('data')}/{.x}.csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>これで、それぞれのファイルが R プロジェクト “Epi_R_handbook” の “data” フォルダ内に保存されました！</p>
<div class="inline-figure"><img src="images/purrr_export_csv.png" width="632" style="display: block; margin: auto;"></div>
</div>
</div>
<div id="カスタム関数" class="section level3 unnumbered">
<h3>カスタム関数<a class="anchor" aria-label="anchor" href="#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E9%96%A2%E6%95%B0"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> に渡す関数を自分で作成したい場合はどうするのでしょうか。</p>
<p>例えば、それぞれの病院ごとに、その病院の全症例を含む流行曲線を作成したいとします。これを <strong>purrr</strong> パッケージを用いて行うには、<code>.f</code> 関数を <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> にし、<code>+</code> を使用して通常通り拡張することができます。<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> は常にリストを出力するため、作成されたプロットもリストとして保存されます。リストに保存されたプロットは、 <strong>ggpubr</strong> パッケージの <code>ggarrange()</code> を使用して抽出し、プロットすることができます（<strong>ggpubr</strong> パッケージの公式ドキュメントは、<a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html">こちら</a> をご覧ください）。</p>
<div class="sourceCode" id="cb791"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># リストから要素をプロットするためのパッケージを読み込む</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">ggpubr</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 6つの病院の 「名前」のベクトルに対してマッピングする（すでに作成済）</span></span>
<span><span class="co"># ggplot 関数を用いる</span></span>
<span><span class="co"># 出力は6つの ggplots を含むリストとなる</span></span>
<span></span>
<span><span class="va">hospital_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">hospital</span><span class="op">)</span></span>
<span></span>
<span><span class="va">my_plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>  .x <span class="op">=</span> <span class="va">hospital_names</span>,</span>
<span>  .f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="va">.x</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># リストとして保存されている ggplots を表示する</span></span>
<span><span class="fu">ggarrange</span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">my_plots</span>, ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-625-1.png" width="672"></div>
<p>上で紹介した <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> コードが複雑すぎる場合、<code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> を用いて作成したコードを自分で定義するカスタム関数として使用しても、同様の結果を得ることができます。例えば、その関数を <code>make_epicurve())</code> と名付け、<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> 内で使用することができます。その場合、<code>.x</code> は反復処理の繰り返しごとにそれぞれの病院名となり、<code>make_epicurve()</code> 内では <code>hosp_name</code> として使用されます。関数を作成する手順について詳しく知りたい方は、<a href="writing-functions.html#writing-functions">関数の作成</a> の章を参照してください。</p>
<div class="sourceCode" id="cb792"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 関数を作成する</span></span>
<span><span class="va">make_epicurve</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">hosp_name</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="va">hosp_name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="va">hosp_name</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb793"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 作成した関数をマッピングする</span></span>
<span><span class="va">my_plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">hospital_names</span>, <span class="op">~</span><span class="fu">make_epicurve</span><span class="op">(</span>hosp_name <span class="op">=</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># リストとして保存されている ggplots を表示する</span></span>
<span><span class="fu">ggarrange</span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">my_plots</span>, ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="複数列に対して関数をマッピングする" class="section level3 unnumbered">
<h3>複数列に対して関数をマッピングする<a class="anchor" aria-label="anchor" href="#%E8%A4%87%E6%95%B0%E5%88%97%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6%E9%96%A2%E6%95%B0%E3%82%92%E3%83%9E%E3%83%83%E3%83%94%E3%83%B3%E3%82%B0%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p>その他に頻繁に用いられる例としては、複数の列に対して同じ関数をマッピングする場合、が挙げられます。以下では、<code>linelist</code> データフレーム内の数値列に対して <code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code> を <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> し、性別で数値を比較していきます。</p>
<p><a href="stat-tests.html#stat-tests">簡単な統計的検定</a> の章で学んだことを思い出してください。<code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code> は、 <code>t.test(文字列 ~ バイナリ変数の列)</code> のような数式形式のインプットを扱うことができることを学びましたね。この例では、以下のことを行います。</p>
<ul>
<li><p>比較したい数値列を、<code>linelist</code> から選びます。これらは、<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> に対してのインプット <code>.x</code> になります</p></li>
<li><p><code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code> は、<code>.f</code> 関数として、選択されたそれぞれの数値列に対して適用されます</p></li>
<li>
<p><code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code> のカッコ内は、</p>
<ul>
<li>最初の チルダ（<code>~</code> ）は <code>.f</code> に先行し、<code>.x</code> に対して <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> が反復処理を行うことを意味します</li>
<li>
<code>.x</code> は反復処理の繰り返しの際に <code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code> に適用される列を表します</li>
<li>2つ目のチルダ（<code>~</code>）は、上で説明した通り、t 検定の数式の一部です</li>
<li>
<code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code> は、チルダ（<code>~</code>）の右側にバイナリ変数の列をあてます。ここでは <code>linelist$gender</code> というベクトルをあてています（<code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> に gender を含まないように注意してください）</li>
</ul>
</li>
<li><p><code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> はリストを返すので、反復処理の終了後、t 検定の結果を示すリストが出力され、一つのリスト要素がそれぞれの数値列の結果を表します。</p></li>
</ul>
<div class="sourceCode" id="cb794"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 結果はリストとして保存される</span></span>
<span><span class="va">t.test_results</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">wt_kg</span>, <span class="va">ht_cm</span>, <span class="va">ct_blood</span>, <span class="va">temp</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="co"># マッピングしたい数字列だけを選択する</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">~</span> <span class="va">linelist</span><span class="op">$</span><span class="va">gender</span><span class="op">)</span><span class="op">)</span>        <span class="co"># t.test() は、数字値 ~ カテゴリ値で表される数式と用いる</span></span></code></pre></div>
<p>RStudio では、<code>t.test_results</code> は以下のように表示されます。重要なポイントとして、</p>
<ul>
<li>一番上に全てのリストを束ねる <code>t.test_results</code> と名づけられたリストがあるのが確認できます。これは、5 つの要素からなり、それぞれの要素は <code>linelist</code> から選択され <code>gender</code> での t 検定に用いられた変数名と同じく <code>age</code>, <code>wt_km</code>, <code>ht_cm</code>, <code>ct_blood</code>, <code>temp</code> と名付けられています。<br>
</li>
<li>5 つの要素それぞれはリストであり、<code>p.value</code> や <code>conf.int</code> といった要素を含んでいます。これらの要素のうち、<code>p.value</code> などは単一の値である一方、<code>estimate</code> などは 2 つ以上の要素（<code>mean in group f</code> と <code>mean in group m</code>）を含んでいます。</li>
</ul>
<div class="inline-figure"><img src="images/purrr_ttest.png" width="286" height="150%"></div>
<p>注釈：データフレーム内の特定の列にのみ関数を適用したい場合、<a href="cleaning.html#cleaning">データクリーニングと主要関数</a> の章で説明したように、<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> と <code><a href="https://dplyr.tidyverse.org/reference/across.html">across()</a></code> を使用すると簡単にできます。以下に、“age” の列にだけ <code><a href="https://rdrr.io/r/base/character.html">as.character()</a></code> を適用させる例を示します。括弧とコンマの位置に注意してください。</p>
<div class="sourceCode" id="cb795"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 列名に "age" を含む列を文字変数に変換する</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span>.cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"age"</span><span class="op">)</span>, .fns <span class="op">=</span> <span class="va">as.character</span><span class="op">)</span><span class="op">)</span>  </span></code></pre></div>
</div>
<div id="リストから抽出する" class="section level3 unnumbered">
<h3>リストから抽出する<a class="anchor" aria-label="anchor" href="#%E3%83%AA%E3%82%B9%E3%83%88%E3%81%8B%E3%82%89%E6%8A%BD%E5%87%BA%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> はアウトプットをリストとして出力するので、<strong>purrr</strong> パッケージに含まれる関数を用いてリストからデータを抽出する方法について少し説明します。前のセクションで作成した <code>t.test_results</code> リストを例として使用します。<code>t.test_results</code> リストは、5 つのリストからなるリストです。5 つのリストには、<code>linelist</code> データフレームのいくつかの変数とバイナリ変数である <code>gender</code> との間の t 検定の結果がそれぞれ保存されています。リスト構造の図は前のセクションをご覧ください。</p>
<div id="要素の名前を抽出する" class="section level4 unnumbered">
<h4>要素の名前を抽出する<a class="anchor" aria-label="anchor" href="#%E8%A6%81%E7%B4%A0%E3%81%AE%E5%90%8D%E5%89%8D%E3%82%92%E6%8A%BD%E5%87%BA%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h4>
<p>リスト内の要素の名前を抽出するには、<strong>base R</strong> の <code><a href="https://rdrr.io/r/base/names.html">names()</a></code> を使うと簡単にできます。今回は、<code><a href="https://rdrr.io/r/base/names.html">names()</a></code> を <code>t.test_results</code> に適用することでそれぞれのサブリスト名（t 検定に用いられた変数の名前）を抽出します。</p>
<div class="sourceCode" id="cb796"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">t.test_results</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "age"      "wt_kg"    "ht_cm"    "ct_blood" "temp"</code></pre>
</div>
<div id="名前または位置によって要素を特定する" class="section level4 unnumbered">
<h4>名前または位置によって要素を特定する<a class="anchor" aria-label="anchor" href="#%E5%90%8D%E5%89%8D%E3%81%BE%E3%81%9F%E3%81%AF%E4%BD%8D%E7%BD%AE%E3%81%AB%E3%82%88%E3%81%A3%E3%81%A6%E8%A6%81%E7%B4%A0%E3%82%92%E7%89%B9%E5%AE%9A%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h4>
<p><a href="basics.html#basics">R の基礎</a> の章で説明したように、 <code>[[ ]]</code> を用いると、リストの要素を名前、または位置で抽出することができます。以下では、二重括弧を <code>t.tests_results</code> リストに用いてインデックスし、<code>age</code> に対する t 検定の結果（リストの最初の要素）を表示しています。</p>
<div class="sourceCode" id="cb798"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="co"># 位置で最初の要素を特定</span></span></code></pre></div>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  .x by linelist$gender
## t = -21.3, df = 4902.9, p-value &lt; 2.2e-16
## alternative hypothesis: true difference in means between group f and group m is not equal to 0
## 95 percent confidence interval:
##  -7.544409 -6.272675
## sample estimates:
## mean in group f mean in group m 
##        12.66085        19.56939</code></pre>
<div class="sourceCode" id="cb800"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"p.value"</span><span class="op">]</span> <span class="co"># 最初の要素内の "p.value" という名前の要素を返す  </span></span></code></pre></div>
<pre><code>## $p.value
## [1] 2.350374e-96</code></pre>
<p>さらに、より簡単で柔軟性の高い方法として、<strong>purrr</strong> パッケージの <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> と <code><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck()</a></code> を使用し、同様の結果を抽出する方法を以下で説明していきます。</p>
</div>
<div id="pluck" class="section level4 unnumbered">
<h4>
<code>pluck()</code><a class="anchor" aria-label="anchor" href="#pluck"><i class="fas fa-link"></i></a>
</h4>
<p><code><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck()</a></code> はリスト内の要素を名前もしくは位置で抽出することができます。例えば、年齢に対する t 検定の結果を抽出するには <code><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck()</a></code> を以下のように使用します。</p>
<div class="sourceCode" id="cb802"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"age"</span><span class="op">)</span>        <span class="co"># 代わりに pluck(1) とすることもできる</span></span></code></pre></div>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  .x by linelist$gender
## t = -21.3, df = 4902.9, p-value &lt; 2.2e-16
## alternative hypothesis: true difference in means between group f and group m is not equal to 0
## 95 percent confidence interval:
##  -7.544409 -6.272675
## sample estimates:
## mean in group f mean in group m 
##        12.66085        19.56939</code></pre>
<p>さらに下の階層を抽出するには、コンマを使います。以下の例では、<code>t.test_results</code> というリスト内の <code>age</code> というリストの要素である “p.value” を抽出しています。文字ではなく、数字を代わりに用いることもできます。</p>
<div class="sourceCode" id="cb804"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"p.value"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 2.350374e-96</code></pre>
<p>また、リスト内の<u>すべての</u>最上階層から、より下の階層にある要素を抽出するには、<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> を用いて <code><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck()</a></code> をそれぞれの最上階層の要素に適用させるとできます。例えば、以下のコードでは <code>t.test_results</code> リストに含まれるすべてのサブリストから “p.value” という要素を抽出しています。この場合、<code>t.test_results</code> は反復処理対象となる <code>.x</code> であり、<code><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck()</a></code> は反復される関数である <code>.f</code> であり、“p-value” はその関数に対して適用されています。</p>
<div class="sourceCode" id="cb806"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">pluck</span>, <span class="st">"p.value"</span><span class="op">)</span>   <span class="co"># リストに含まれるすべての p 値を返す</span></span></code></pre></div>
<pre><code>## $age
## [1] 2.350374e-96
## 
## $wt_kg
## [1] 2.664367e-182
## 
## $ht_cm
## [1] 3.515713e-144
## 
## $ct_blood
## [1] 0.4473498
## 
## $temp
## [1] 0.5735923</code></pre>
<p>他の方法として、<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> で要素の名前を引用符をつけて示し、それを抽出する方法があります。<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> を利用する場合はアウトプットがリストで出力されますが、<code><a href="https://purrr.tidyverse.org/reference/map.html">map_chr()</a></code> を用いる場合は名前付きの文字ベクトルとして出力され、<code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> を用いる場合は名前付きの数字ベクトルとして出力されます。</p>
<div class="sourceCode" id="cb808"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="st">"p.value"</span><span class="op">)</span>   <span class="co"># すべての p 値を名前付きの数値ベクトルとして返す</span></span></code></pre></div>
<pre><code>##           age         wt_kg         ht_cm      ct_blood          temp 
##  2.350374e-96 2.664367e-182 3.515713e-144  4.473498e-01  5.735923e-01</code></pre>
<p><code><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck()</a></code> の詳細は、<strong>purrr</strong> パッケージの <a href="https://purrr.tidyverse.org/reference/pluck.html">公式ドキュメント</a> をご覧ください。<code><a href="https://purrr.tidyverse.org/reference/pluck.html">chuck()</a></code> という関数もあり、<code><a href="https://purrr.tidyverse.org/reference/pluck.html">chuck()</a></code> は要素が存在しなければ NULL ではなくエラーを返します。</p>
</div>
</div>
<div id="リストをデータフレームに変換する" class="section level3 unnumbered">
<h3>リストをデータフレームに変換する<a class="anchor" aria-label="anchor" href="#%E3%83%AA%E3%82%B9%E3%83%88%E3%82%92%E3%83%87%E3%83%BC%E3%82%BF%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p>これは少し複雑な内容のため、より網羅的に学びたい方は、本章の最後に記載されている参考資料を参照してください。ここでは、前のセクションでリストとして出力された t 検定の結果（<code>t.test_results</code>）をデータフレームに変換する方法を説明します。p 値の列と 2 つのグループ（男性と女性）それぞれの平均値の列を含むデータフレームを作成していきます。</p>
<p>方法と使用する関数を示します：</p>
<ul>
<li>
<p>tibble （データフレームのようなもの）を作成するため、<code><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble()</a></code> を使います</p>
<ul>
<li>
<code>t.test_results</code> 全体が tibble の最初の列として保存されないように、<code><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble()</a></code> を波括弧でくくります</li>
</ul>
</li>
<li>
<p><code><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble()</a></code> 内では、それぞれの列が明示的に作成されるので、<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> で列を作成する方法に似ています。</p>
<ul>
<li>以下のコードでは、<code>.</code> は <code>t.test_results</code> を表しています</li>
<li>列名を t 検定で用いた変数名（それぞれのリスト要素の名前）にしたい場合は、前述したように <code><a href="https://rdrr.io/r/base/names.html">names()</a></code> を使用します</li>
<li>列名を p 値にしたい場合は、前述したように <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> を用いて <code>p.value</code> の要素を抽出し、数字ベクトルに変換します</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb810"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>,</span>
<span>    p         <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"p.value"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<pre><code>## # A tibble: 5 × 2
##   variables         p
##   &lt;chr&gt;         &lt;dbl&gt;
## 1 age       2.35e- 96
## 2 wt_kg     2.66e-182
## 3 ht_cm     3.52e-144
## 4 ct_blood  4.47e-  1
## 5 temp      5.74e-  1</code></pre>
<p>今回は、さらにそれぞれのグループ（男性と女性）の平均値の列を追加していきます。</p>
<p>この場合、<code>estimate</code> という要素を抽出したいのですが、問題はその中に <u>2 つの</u>要素 （<code>mean in group f</code> と <code>mean in group m</code>）が含まれていることです。そのため、<code><a href="https://purrr.tidyverse.org/reference/map.html">map_chr()</a></code> や <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> を用いてベクターに変換することはできません。その代わり、<code><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble()</a></code> 内で <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> を用いることで <u>tibble 内にリスト要素の列</u>を作成することができます！</p>
<div class="sourceCode" id="cb812"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="op">{</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>,</span>
<span>    p <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"p.value"</span><span class="op">)</span>,</span>
<span>    means <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"estimate"</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span></code></pre></div>
<pre><code>## # A tibble: 5 × 3
##   variables         p means       
##   &lt;chr&gt;         &lt;dbl&gt; &lt;named list&gt;
## 1 age       2.35e- 96 &lt;dbl [2]&gt;   
## 2 wt_kg     2.66e-182 &lt;dbl [2]&gt;   
## 3 ht_cm     3.52e-144 &lt;dbl [2]&gt;   
## 4 ct_blood  4.47e-  1 &lt;dbl [2]&gt;   
## 5 temp      5.74e-  1 &lt;dbl [2]&gt;</code></pre>
<p>リスト要素の列が一度できると、このような「入れ子構造内のリスト要素の列」を「外に取り出す（“rectangle” または “un-nest”）」のに役立つ <strong>tidyr</strong> パッケージの関数がいくつかあります（<strong>tidyr</strong> パッケージは <strong>tidyverse</strong> パッケージに含まれている）。詳しくは、<a href="https://www.epirhandbook.com/en/iteration-loops-and-lists.html">このページ</a> を参照するか、<code><a href="https://tidyr.tidyverse.org/articles/rectangle.html">vignette("rectangle")</a></code> を実行してください。簡単に述べると、</p>
<ul>
<li>
<code><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider()</a></code>：リスト要素の列のそれぞれの要素を、列として外に出します</li>
<li>
<code><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_longer()</a></code>：リスト要素の列のそれぞれの要素を、行として外に出します</li>
<li>
<code><a href="https://tidyr.tidyverse.org/reference/hoist.html">hoist()</a></code>：<code><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider()</a></code> と似ていますが、どの要素を入れ子構造の外に出すか指定する必要があります</li>
</ul>
<p>以下では、<code><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider()</a></code> に <code>t.test_results</code> という tibble を渡し、tibble 内の入れ子になっているリスト要素である <code>means</code> 列を指定しています。その結果、<code>means</code> はもともとそれぞれの <code>means</code> のセル内の値であった要素からなる 2 つの列に変換されました。</p>
<div class="sourceCode" id="cb814"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="op">{</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>,</span>
<span>    p <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"p.value"</span><span class="op">)</span>,</span>
<span>    means <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"estimate"</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 5 × 4
##   variables         p `mean in group f` `mean in group m`
##   &lt;chr&gt;         &lt;dbl&gt;             &lt;dbl&gt;             &lt;dbl&gt;
## 1 age       2.35e- 96              12.7              19.6
## 2 wt_kg     2.66e-182              45.8              59.6
## 3 ht_cm     3.52e-144             109.              142. 
## 4 ct_blood  4.47e-  1              21.2              21.2
## 5 temp      5.74e-  1              38.6              38.6</code></pre>
</div>
<div id="リストを捨てる保持するコンパクトにする" class="section level3 unnumbered">
<h3>リストを捨てる・保持する・コンパクトにする<a class="anchor" aria-label="anchor" href="#%E3%83%AA%E3%82%B9%E3%83%88%E3%82%92%E6%8D%A8%E3%81%A6%E3%82%8B%E4%BF%9D%E6%8C%81%E3%81%99%E3%82%8B%E3%82%B3%E3%83%B3%E3%83%91%E3%82%AF%E3%83%88%E3%81%AB%E3%81%99%E3%82%8B"><i class="fas fa-link"></i></a>
</h3>
<p><strong>purrr</strong> パッケージの関数はリストを扱うことが多いため、リストを変換するのに用いられる <strong>purrr</strong> パッケージの関数をいくつか簡単に説明します。<strong>purrr</strong> パッケージに含まれる関数について、より詳しい内容を知りたい方は、本章の最後に記載されている参考資料をご覧ください。</p>
<ul>
<li>
<code><a href="https://purrr.tidyverse.org/reference/list_modify.html">list_modify()</a></code> にはいくつか用途がありますが、例えばリストの要素を取り除く、といった場合に使用されます<br>
</li>
<li>
<code><a href="https://purrr.tidyverse.org/reference/keep.html">keep()</a></code> は、引数 <code>.p =</code> で指定された要素、もしくは <code>.p =</code> に与えられた関数が TRUE となる要素を保持（キープ）します<br>
</li>
<li>
<code><a href="https://purrr.tidyverse.org/reference/keep.html">discard()</a></code> は、引数 <code>.p =</code> で指定された要素、もしくは <code>.p =</code> に与えられた関数が TRUE となる要素を取り除きます<br>
</li>
<li>
<code><a href="https://purrr.tidyverse.org/reference/keep.html">compact()</a></code> は、全ての空の要素を取り除きます</li>
</ul>
<p>それでは、<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> を使用して複数のファイルをインポートし結合した <a href="iteration.html#iter_combined">例：エクセルシートをインポートし、結合する</a> で作成したリストである <code>combined</code>（6 つのデータフレームを含むリスト）を用いて例を示します。</p>
<p>リスト内の要素を要素名の名前で取り除きたい場合は、<code><a href="https://purrr.tidyverse.org/reference/list_modify.html">list_modify()</a></code> で取り除きたい要素名を <code>NULL</code> に指定することで取り除くことができます。</p>
<div class="sourceCode" id="cb816"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_modify.html">list_modify</a></span><span class="op">(</span><span class="st">"Central Hospital"</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>   <span class="co"># リスト要素を名前で取り除く</span></span></code></pre></div>
<p>また、何かの基準を指定して要素を取り除くこともできます。その場合は、「述語」方程式（TRUE か FALSE を判定する方程式）を <code>.p =</code> に渡します。チルダ（<code>~</code>）を関数の前に用い、リスト要素を表す <code>.x</code> を用います。<code><a href="https://purrr.tidyverse.org/reference/keep.html">keep()</a></code> を使用し、TRUE と判定されたリスト要素を保持します。逆に、TRUE と判定されたリスト要素を取り除きたい場合は、<code><a href="https://purrr.tidyverse.org/reference/keep.html">discard()</a></code> を使用してください。以下に例を示します。</p>
<div class="sourceCode" id="cb817"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 500行以上を含むリスト要素のみを保持する</span></span>
<span><span class="va">combined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html">keep</a></span><span class="op">(</span>.p <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">500</span><span class="op">)</span>  </span></code></pre></div>
<p>もう一つの例として、データフレームではない要素を取り除くコードを以下に紹介します。</p>
<div class="sourceCode" id="cb818"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># データフレームではないリスト要素を取り除く</span></span>
<span><span class="va">combined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html">discard</a></span><span class="op">(</span>.p <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"data.frame"</span><span class="op">)</span></span></code></pre></div>
<p>また、述語方程式にそれぞれのリスト内の要素や列を含めることもできます。以下の例では、<code>ct_blood</code> 列の平均値が 25 よりも大きいリスト要素を取り除いています。</p>
<div class="sourceCode" id="cb819"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ct_blood 列の平均値が 25 以上のリスト要素を取り除く</span></span>
<span><span class="va">combined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html">discard</a></span><span class="op">(</span>.p <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">ct_blood</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">25</span><span class="op">)</span>  </span></code></pre></div>
<p>すべての空の列を取り除きたい場合は、以下のコードを実行してください。</p>
<div class="sourceCode" id="cb820"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 全ての空の列を取り除く</span></span>
<span><span class="va">combined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html">compact</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="pmap" class="section level3 unnumbered">
<h3>
<code>pmap()</code><a class="anchor" aria-label="anchor" href="#pmap"><i class="fas fa-link"></i></a>
</h3>
<p>このセクションは、作成中です。</p>
</div>
</div>
<div id="apply-関数" class="section level2" number="16.4">
<h2>
<span class="header-section-number">16.4</span> Apply 関数<a class="anchor" aria-label="anchor" href="#apply-%E9%96%A2%E6%95%B0"><i class="fas fa-link"></i></a>
</h2>
<p><strong>purrr</strong> パッケージの代わりに、<strong>base R</strong> に含まれている種々の “apply” 系の関数を使用して反復処理を行うこともできます。詳しくは、<a href="https://www.datacamp.com/community/tutorials/r-tutorial-apply-family">こちら</a> をご覧ください。</p>
<!-- ======================================================= -->
</div>
<div id="参考資料-9" class="section level2" number="16.5">
<h2>
<span class="header-section-number">16.5</span> 参考資料<a class="anchor" aria-label="anchor" href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99-9"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://datacarpentry.org/semester-biology/materials/for-loops-R/">Data Carpentry の for loops に関するページ</a></p>
<p><a href="https://r4ds.had.co.nz/iteration.html#iteration">The R for Data Science の iteration に関するページ</a></p>
<p><a href="https://martinctc.github.io/blog/vignette-write-and-read-multiple-excel-files-with-purrr/">Excel ファイルのインポート・エクスポートについて</a></p>
<p>jennybc による purrr の <a href="https://jennybc.github.io/purrr-tutorial/index.html">チュートリアル</a></p>
<p>Rebecca Barter による purrr の <a href="http://www.rebeccabarter.com/blog/2019-08-19_purrr/">チュートリアル</a></p>
<p>map, pmap, and imap についての purrr の <a href="http://zevross.com/blog/2019/06/11/the-power-of-three-purrr-poseful-iteration-in-r-with-map-pmap-and-imap/">チュートリアル</a></p>
<p><a href="https://raw.githubusercontent.com/rstudio/cheatsheets/master/pngs/thumbnails/purrr-cheatsheet-thumbs.png">purrr のチートシート</a></p>
<p><a href="https://www.hvitfeldt.me/blog/purrr-tips-and-tricks/">purrr の役立つヒント</a></p>
<p><a href="https://hookedondata.org/going-off-the-map/#keep-and-discard">keep と discard 関数について</a></p>

</div>
</div>



<div class="chapter-nav">
<div class="prev"><a href="deduplication.html"><span class="header-section-number">15</span> 重複データの排除</a></div>
<div class="next"><a href="tables-descriptive.html"><span class="header-section-number">17</span> 記述統計表の作り方</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#iteration"><span class="header-section-number">16</span> ループと反復処理・リストの操作</a></li>
<li>
<a class="nav-link" href="#%E6%BA%96%E5%82%99-7"><span class="header-section-number">16.1</span> 準備</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80-1">パッケージを読み込む</a></li>
<li><a class="nav-link" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B-1">データをインポートする</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#for-%E3%83%AB%E3%83%BC%E3%83%97"><span class="header-section-number">16.2</span> for ループ</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#iter_loops">R における for ループ</a></li>
<li><a class="nav-link" href="#%E4%B8%AD%E5%BF%83%E3%81%A8%E3%81%AA%E3%82%8B%E8%A6%81%E7%B4%A0">中心となる要素</a></li>
<li><a class="nav-link" href="#%E3%82%B7%E3%83%BC%E3%82%B1%E3%83%B3%E3%82%B9">シーケンス</a></li>
<li><a class="nav-link" href="#%E3%82%AA%E3%83%9A%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3">オペレーション</a></li>
<li><a class="nav-link" href="#%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A">コンテナ</a></li>
<li><a class="nav-link" href="#%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%9B%E3%81%9A%E7%B5%90%E6%9E%9C%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%99%E3%82%8B">コンテナを使用せず結果を表示する</a></li>
<li><a class="nav-link" href="#for-%E3%83%AB%E3%83%BC%E3%83%97%E3%81%AE%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D%E3%82%92%E8%A1%8C%E3%81%86">for ループの動作確認を行う</a></li>
<li><a class="nav-link" href="#%E3%83%97%E3%83%AD%E3%83%83%E3%83%88%E3%82%92%E3%83%AB%E3%83%BC%E3%83%97%E3%81%99%E3%82%8B">プロットをループする</a></li>
<li><a class="nav-link" href="#%E3%83%AB%E3%83%BC%E3%83%97%E3%81%AE%E9%80%B2%E6%8D%97%E7%8A%B6%E6%B3%81%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B">ループの進捗状況を確認する</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#iter_purrr"><span class="header-section-number">16.3</span> purrr とリスト</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80-2">パッケージを読み込む</a></li>
<li><a class="nav-link" href="#map">map()</a></li>
<li><a class="nav-link" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88%E3%82%92%E5%88%86%E5%89%B2%E3%81%97%E3%82%A8%E3%82%AF%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B">データセットを分割しエクスポートする</a></li>
<li><a class="nav-link" href="#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E9%96%A2%E6%95%B0">カスタム関数</a></li>
<li><a class="nav-link" href="#%E8%A4%87%E6%95%B0%E5%88%97%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6%E9%96%A2%E6%95%B0%E3%82%92%E3%83%9E%E3%83%83%E3%83%94%E3%83%B3%E3%82%B0%E3%81%99%E3%82%8B">複数列に対して関数をマッピングする</a></li>
<li><a class="nav-link" href="#%E3%83%AA%E3%82%B9%E3%83%88%E3%81%8B%E3%82%89%E6%8A%BD%E5%87%BA%E3%81%99%E3%82%8B">リストから抽出する</a></li>
<li><a class="nav-link" href="#%E3%83%AA%E3%82%B9%E3%83%88%E3%82%92%E3%83%87%E3%83%BC%E3%82%BF%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%81%AB%E5%A4%89%E6%8F%9B%E3%81%99%E3%82%8B">リストをデータフレームに変換する</a></li>
<li><a class="nav-link" href="#%E3%83%AA%E3%82%B9%E3%83%88%E3%82%92%E6%8D%A8%E3%81%A6%E3%82%8B%E4%BF%9D%E6%8C%81%E3%81%99%E3%82%8B%E3%82%B3%E3%83%B3%E3%83%91%E3%82%AF%E3%83%88%E3%81%AB%E3%81%99%E3%82%8B">リストを捨てる・保持する・コンパクトにする</a></li>
<li><a class="nav-link" href="#pmap">pmap()</a></li>
</ul>
</li>
<li><a class="nav-link" href="#apply-%E9%96%A2%E6%95%B0"><span class="header-section-number">16.4</span> Apply 関数</a></li>
<li><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99-9"><span class="header-section-number">16.5</span> 参考資料</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>
</div>
  

  

</div>
 <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>疫学のための R ハンドブック</strong>" was written by the handbook team. It was last built on 2022-10-11.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
