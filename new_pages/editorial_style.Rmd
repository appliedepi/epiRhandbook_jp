# 編集前記・技術注記

このページでは、このハンドブックの制作におけるアプローチの哲学、スタイル、具体的な編集上の決定事項について説明します。

## アプローチとスタイル

本書の潜在的な読者層は広いと考えています。R を初めて使う人はもちろん、より良い処理方法やそのヒントを探している経験豊富な R ユーザーにもきっと役立ててもらえるはずです。そのため、本書は理解しやすく、簡潔である必要があります。したがって、私たちのアプローチは、R に慣れていない人でもコードを適用し、コードが何をしているのかをたどることができるよう、[十分な]{.ul}説明をおこなうことでした。

その他のポイント

-   本書は、比較的簡単な事例を用いたコードの参考書であり、[R やデータサイエンスの完全な教科書ではありません。]{.ul}

-   これは応用疫学で R を使用するための[ハンドブック]{.ul}であり、応用疫学の手法や科学に関するマニュアルではありません。

-   それぞれのタスクに最適な R のパッケージは頻繁に変わるため、このハンドブックでどのパッケージの使用を重視するかに関する議論を歓迎します。

### R パッケージ {.unnumbered}

**多くの選択肢**

R の学習で最も難しいことの 1 つは、特定のタスクに対してどの R パッケージを使うべきかを把握することです。あるタスクで悪戦苦闘しているうちに、「あれ、1 つのコマンドで全部やってくれる R パッケージがあるじゃないか！」と気づくことはよくあります。

このハンドブックでは、各タスクを完了するために少なくとも 2 つの方法を用いるようにしています。1 つは試行錯誤を重ねた方法（おそらく**base** R か **tidyverse**）、もう 1 つはその目的のためにカスタマイズされた特別な R パッケージです。パッケージがダウンロードできない、あるいはうまく動作しない場合に備えて、いくつかの選択肢を用意しておきたいと思います。

使用するパッケージの選択にあたっては、一般的な利用者によってテストされ吟味されたもの、典型的な作業内で使用するパッケージの数が最小であるもの、安定しているもの（あまり頻繁に変更されない）、そしてシンプルかつ簡単にタスクを達成するパッケージと手法を優先的に選びました。

このハンドブックでは、一般的に **tidyverse** の R パッケージや関数を優先的に紹介します。 tidyverse はデータサイエンスのために設計された R パッケージを集めたものであり、基礎となる文法やデータ構造を共有しています。すべての tidyverse パッケージは、**tidyverse** パッケージを介してインストールまたは読み込むことが可能です。詳しくは [tidyverse](https://www.tidyverse.org/) のウェブサイトをご覧ください。

また、必要に応じて、**base** R（R をインストールしたときに付属しているパッケージや関数）を用いた手法も紹介しています。これは、本書の読者の中には、追加のパッケージをダウンロードするための信頼できるネット環境を利用できない方がいることを認識したためです。

**関数とパッケージの明示的な関連付け**

R のチュートリアルで関数がコードで表示されても、それがどのパッケージのものかわからないとイライラすることがよくありますね！ 私たちはこのような状況を避けようとしています。

説明文において、パッケージ名は太字で書き（例：**dplyr**）、関数は次のように書いています： `mutate()` 。また、関数がどのパッケージから来たものかを明示するために、文章内でパッケージを参照するか、`dplyr::mutate()` のようにコードでパッケージを明示するようにしています。冗長に見えるかもしれませんが、わざとそうしています。

パッケージや関数について詳しく知りたい方は、[Rの基礎](#basics)のページをご覧ください。

### コードのスタイル {.unnumbered}

このハンドブックでは、頻繁に「改行」をいれて、コードを「縦長」に表示しています。これにはいくつかの理由があります。

-   コードの細かい点について、コードのすぐそばで `#` を使って説明コメントを書くことができる

-   一般的に、長い（縦長の）コードの方が読みやすい

-   狭い画面でも読みやすい（横スクロールが必要ない）

-   インデントにより、どの引数がどの関数に属しているかがわかりやすい

その結果、次のようなコードの書き方になりました。

```{r, eval=F}
linelist %>% 
  group_by(hospital) %>%  # 病院ごとのグループの列
  slice_max(date, n = 1, with_ties = F) # 日付が同じ場合は最初の行を採用する

```

日付が同じ場合は最初の行をとる

...はこのように書きます。

```{r, eval=F}
linelist %>% 
  group_by(hospital) %>% # 病院ごとのグループの列
  slice_max(
    date,                # グループごとに日付の最大値を持つ行を保持する 
    n = 1,               # 最も上段の 1 列を保持する 
    with_ties = F)       # 日付が同じ場合は最初の行を採用する
```

R コードは通常、改行やインデントの影響を受けません。コードを書くとき、カンマの後に改行を開始すると、自動的なインデントパターンが適用されます。

また、スペースをたくさん使っている（例えば、`n=1` ではなく `n = 1` ）理由は、その方が読みやすいからです。あなたが書いたコードを読む人に対して親切にしてあげてください！

### 用語解説 {.unnumbered}

このハンドブックでは、一般的に「変数」や「観測値」ではなく「列」や「行」に言及しています。この[「整然データ」](https://tidyr.tidyverse.org/articles/tidy-data.html)の入門書で説明したように、ほとんどの疫学統計データセットは、行、列、値の構造で構成されています。

[変数]{.ul}には、同じ基本属性（年齢層、転帰、発症日など）を測定した値が含まれます。[観測値]{.ul}には、同じ単位（人、部位、実験試料など）で測定されたすべての値が含まれます。したがって、これらを具体的に定義することは困難であるかもしれません。

「整理された」データセットでは、各列が変数、各行が観測値、各セルが 1 つの値です。しかし、あなたが遭遇するデータセットの中には、この型に当てはまらないものもあります。例えば、「横長」形式のデータセットでは、変数が複数の列にまたがっていることがあります（[データの縦横変換](#pivoting)のページで例をご覧ください）。同様に、観測値も複数の行にまたがって分割されているかもしれません。

このハンドブックのほとんどは、データの管理と変換に関するものなので、より抽象的な観測値や変数よりも、行や列といった具体的なデータ構造に言及する方がより適切です。例外は主にデータ解析のページで生じ、そこでは変数や観測値への言及が多くなります。

### 注釈

ここでは、ハンドブックで遭遇する可能性のある注釈を紹介します。

[[**注釈:**]{.ul} これは注釈です。]{style="color: black;"}\
[[**ヒン**]{.ul}**ト:** これはヒントです。]{style="color: darkgreen;"}\
[[**注意事項:**]{.ul} これは注意事項です。]{style="color: orange;"}\
[[**警告:**]{.ul} これは警告です。]{style="color: red;"}

## 編集上の決定事項

以下では、パッケージや関数の選択に関する編集上の重要な決定事項を記録しています。これらについて異なる意見がある場合や、新しいツールをご提供いただける場合は、こちらの [Github](https://github.com/epirhandbook/Epi_R_handbook) ページに参加しメッセージをお送りください。

**パッケージ、関数、その他の編集上の決定事項の表**

+----------------------------+----------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| 項目                       | 候補パッケージ・関数                                                             | 推奨パッケージ・関数                                                                                                   | 簡単な説明                                                                         |
+============================+==================================================================================+========================================================================================================================+====================================================================================+
| 一般的なコーディング方法   | **tidyverse**, **data.table**, **base**                                          | **tidyverse**、**data.table** のページと、インターネットを持たない読者のための代替方法としての **base** についての言及 | **tidyverse**                                                                      |
|                            |                                                                                  |                                                                                                                        |                                                                                    |
|                            |                                                                                  |                                                                                                                        | 読みやすさ、一般性、必須項目                                                       |
+----------------------------+----------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| パッケージの読み込み       | `library()`,`install.packages()`, `require()`, **pacman**                        | **pacman**                                                                                                             | ほとんどのパッケージのインストールと読み込みおいて、コードの短縮と簡素化を実現する |
+----------------------------+----------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| インポートとエクスポート   | **rio**, many other packages                                                     | **rio**                                                                                                                | 多くのファイルタイプに対応する手軽さ                                               |
+----------------------------+----------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| 要約統計のためのグループ化 | **dplyr** `group_by()`, **stats** `aggregate()`                                  | **dplyr** `group_by()`                                                                                                 | **tidyverse** と同様に重要                                                         |
+----------------------------+----------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| 縦横変換                   | **tidyr** (pivot functions), **reshape2** (melt/cast), **tidyr** (spread/gather) | **tidyr** (pivot 関数)                                                                                                 | **reshape2** は廃止され**、tidyr** は 1.0.0 版から pivot 関数を使用                |
+----------------------------+----------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| きれいな列名               | **linelist**, **janitor**                                                        | **janitor**                                                                                                            | パッケージの集約を重視                                                             |
+----------------------------+----------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| 時間データの取り扱い       | **lubridate**, **aweek**, **tsibble**, **zoo**                                   | **lubridate** 一般的なものと、特定のケースに対応するものとがある                                                       | **lubridate** の柔軟性、一貫性、パッケージ維持の見通し                             |
+----------------------------+----------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| ggplot ラベル              | `labs()`, `ggtitle()`/`ylab()`/`xlab()`                                          | `labs()`                                                                                                               | すべてのラベルを一箇所でシンプルに修正                                             |
+----------------------------+----------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| 因子型への変換             | `factor()`, **forcats**                                                          | **forcats**                                                                                                            | さまざまな関数も同じコマンドで因子に変換                                           |
+----------------------------+----------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| 流行曲線                   | **incidence**, **ggplot2**, **EpiCurve**                                         | **incidence2** を素早く、**ggplot2** を詳細に。                                                                        | 信頼性                                                                             |
+----------------------------+----------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| 結合処理                   | `paste()`, `paste0()`, `str_glue()`, `glue()`                                    | `str_glue()`                                                                                                           | **stringr** 内にありペースト関数よりもシンプルな構文                               |
+----------------------------+----------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+

## 主な修正履歴

| 日付          | 主な変更点    |
|---------------|---------------|
| 2021年5月10日 | 1.0.0版の公開 |

## バージョン情報 (R、RStudio、パッケージ)

このハンドブックで使用した R、RStudio、R パッケージのバージョンに関する情報を以下に示します。

```{r}
sessioninfo::session_info()
```
